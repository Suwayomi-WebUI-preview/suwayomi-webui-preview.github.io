import{o as ce,j as e,r as Oe,i as we,Z as T,T as ue,_ as Ae,B as k,aI as de,a0 as pe,S as q,c as x,b6 as E,av as De,u as ge,b as P,P as Re,f as Y,I as me,C as Ge,R as qe,U as Ne,aC as Be,aD as Ue,aE as He,h as he,b3 as ze,b2 as Ve,b7 as We,b8 as Qe,t as J,N as Ye,a1 as Je,e as Ke,ar as le,s as Ze,b9 as G,ba as Xe,a as O,bb as et,bc as tt,bd as st,be as at,m as nt}from"./index-lMCVQ9L9.js";import{d as rt,u as ot,A as it,S as lt}from"./AppbarSearch-BBKHdNgu.js";import{b as fe,a as xe,d as ct}from"./ExpandMore-BJrIKImX.js";import{d as Se}from"./FilterList-yFGWFTnN.js";import{G as ut}from"./GridLayouts-BcFceZO9.js";import{d as dt}from"./Delete-CHiSYjmX.js";import{S as pt,O as gt}from"./SortRadioInput-CH37YE8G.js";import{C as mt}from"./CheckboxInput-BhngQPDD.js";import{a as be,I as je,S as ht,b as ft,T as xt}from"./TextField-CxRf_Sst.js";import{C as ve}from"./Collapse-DEDLByZu.js";import{u as St}from"./useDebounce-DaZoKzm2.js";import{I as bt}from"./InputAdornment-Dm1Za2iv.js";import{T as jt}from"./ThreeStateCheckboxInput-BjlzpdWs.js";import{S as vt}from"./StyledFab-eFyMIcRv.js";import{o as Ct}from"./useManageMangaLibraryState-DYObCqFJ.js";import{C as yt}from"./Chip-Bac0XVLr.js";import{B as Tt}from"./BaseMangaGrid-JSpm7BPX.js";import{g as Ft}from"./MangaGrid-CAGpsp_6.js";import{L as Lt}from"./Link-CbsvXed9.js";import"./Checkbox-CwiZv_lI.js";import"./SwitchBase-D3WmpHnl.js";import"./ListPreference-BzwrhVrO.js";import"./Trackers-D4pSmk7a.js";import"./Card-B05Yk5W-.js";import"./CardContent-CeTwftS6.js";import"./Avatar-BwtVw6nO.js";import"./Info-Dk8WxbOa.js";import"./CheckCircle-CariqKTD.js";import"./SpinnerImage-OBJTi3Fi.js";import"./TypographyMaxLines-CPYBNV-B.js";import"./CardActionArea-BQPImZqt.js";import"./NumberSetting-JPZ_AFwO.js";import"./useMobilePicker-alskPrt7.js";import"./SelectSetting-BQ7oVxtS.js";import"./Select-BMAzkNZu.js";import"./Mangas-D4OyKiQf.js";import"./Chapters-CVHYugbV.js";import"./index-B1r9d62L.js";import"./Sync-CED_Sl0u.js";import"./PlayArrow-CCDk066v.js";function _t(){const{options:{SourcegridLayout:t},setOptions:a}=ce();function r(o){a(s=>({...s,SourcegridLayout:o}))}return e.jsx(ut,{gridLayout:t,onChange:r})}var K={},It=we;Object.defineProperty(K,"__esModule",{value:!0});var Ce=K.default=void 0,kt=It(Oe()),Et=e;Ce=K.default=(0,kt.default)((0,Et.jsx)("path",{d:"M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3m3-10H5V5h10z"}),"Save");const Mt=t=>{const{state:a,name:r,position:o,group:s,updateFilterValue:c,update:n}=t,[u,i]=T.useState(a),h=d=>{i(d.target.checked);const g=n.filter(S=>!(o===S.position&&s===S.group));c([...g,{type:"checkBoxState",position:o,state:d.target.checked,group:s}])};return a!==void 0?e.jsx(mt,{label:r,checked:u,onChange:h}):null},$t=({name:t})=>e.jsx(ue,{sx:{mt:2},variant:"subtitle2",children:t},t);function Pt(t,a,r,o,s,c,n){const[u,i]=T.useState(r);if(t){const h=g=>{const S=t.indexOf("".concat(g.target.value));i(S);const j=c.filter(m=>!(o===m.position&&n===m.group));s([...j,{type:"selectState",position:o,state:S,group:n}])},d=t.map(g=>e.jsx(Ae,{value:g,children:g},"".concat(a," ").concat(g)));return e.jsxs(be,{sx:{my:1},variant:"standard",children:[e.jsx(je,{children:a}),e.jsx(ht,{name:a,value:t[u],label:a,onChange:h,children:d})]})}return null}const Ot=({values:t,name:a,state:r,position:o,updateFilterValue:s,update:c,group:n})=>Pt(t,a,r,o,s,c,n),wt=t=>{const{values:a,name:r,state:o,position:s,group:c,updateFilterValue:n,update:u}=t,[i,h]=T.useState(o),[d,g]=T.useState(!1),S=()=>{g(!d)};if(a){const j=m=>{const l=i;l.index===m?l.ascending=!l.ascending:l.ascending=!0,l.index=m,h(l);const v=u.filter(f=>!(s===f.position&&c===f.group));n([...v,{type:"sortState",position:s,state:l,group:c}])};return e.jsxs(k,{sx:{mx:-2},children:[e.jsxs(de,{onClick:S,children:[e.jsx(pe,{primary:r}),d?e.jsx(fe,{}):e.jsx(xe,{})]}),e.jsx(ve,{in:d,children:e.jsx(q,{sx:{mx:4},children:a.map((m,l)=>e.jsx(pt,{label:m,checked:i.index===l,sortDescending:!i.ascending,onClick:()=>j(l)},"".concat(r," ").concat(m)))})})]})}return null},At=t=>{const{state:a,name:r,position:o,group:s,updateFilterValue:c,update:n}=t,[u,i]=T.useState(a||""),h=St(u,500);return x.useEffect(()=>{const d=n.filter(g=>!(o===g.position&&s===g.group));c([...d,{type:"textState",position:o,state:h,group:s}])},[h]),a!==void 0?e.jsxs(be,{sx:{my:1},variant:"standard",children:[e.jsx(je,{children:r}),e.jsx(ft,{name:r,value:u,onChange:({target:{value:d}})=>i(d),endAdornment:e.jsx(bt,{position:"end",children:e.jsx(rt,{})})})]}):null},Dt=t=>{switch(t){case E.Ignore:return 0;case E.Include:return 1;case E.Exclude:return 2;default:throw new Error("Unexpected TriState ".concat(t))}},Rt=t=>{switch(t){case 0:return E.Ignore;case 1:return E.Include;case 2:return E.Exclude;default:throw new Error("Unexpected state number ".concat(t))}},Gt=t=>{const{state:a,name:r,position:o,group:s,updateFilterValue:c,update:n}=t,[u,i]=T.useState(Dt(a)),h=d=>{const g=d===void 0?0:d?1:2;i(g);const S=n.filter(j=>!(o===j.position&&s===j.group));c([...S,{type:"triState",position:o,state:Rt(g),group:s}])};return a!==void 0?e.jsx(jt,{label:r,checked:[void 0,!0,!1][u],onChange:d=>h(d)}):null},qt=t=>{const{state:a,name:r,position:o,updateFilterValue:s,update:c}=t,[n,u]=T.useState(!1);return e.jsxs(k,{sx:{mx:-2},children:[e.jsxs(de,{onClick:()=>u(!n),children:[e.jsx(pe,{primary:r}),n?e.jsx(fe,{}):e.jsx(xe,{})]}),e.jsx(ve,{in:n,children:e.jsx(q,{sx:{mx:4},children:e.jsx(ye,{sourceFilter:a,group:o,updateFilterValue:s,update:c})})})]})},Nt=({name:t})=>e.jsx(De,{sx:{my:1},textAlign:"center",children:t},t);function ye({sourceFilter:t,group:a,updateFilterValue:r,update:o}){return e.jsx(q,{children:t.map((s,c)=>{var u,i;let n=o.find(h=>h.group===a&&h.position===c);switch(n=n&&n.state,s.type){case"CheckBoxFilter":return e.jsx(Mt,{name:s.name,state:n!=null?n:s.CheckBoxFilterDefault,position:c,group:a,updateFilterValue:r,update:o},"filters ".concat(s.name));case"GroupFilter":return e.jsx(qt,{name:s.name,state:s.filters,position:c,updateFilterValue:r,update:o},"filters ".concat(s.name));case"HeaderFilter":return e.jsx($t,{name:s.name},"filters ".concat(s.name));case"SelectFilter":return e.jsx(Ot,{name:s.name,values:s.values,state:n!=null?parseInt(n,10):s.SelectFilterDefault,position:c,group:a,updateFilterValue:r,update:o},"filters ".concat(s.name));case"SeparatorFilter":return e.jsx(Nt,{name:s.name},"filters ".concat(s.name));case"SortFilter":return e.jsx(wt,{name:s.name,values:s.values,state:n!=null?n:{ascending:(u=s.SortFilterDefault)==null?void 0:u.ascending,index:(i=s.SortFilterDefault)==null?void 0:i.index},position:c,group:a,updateFilterValue:r,update:o},"filters ".concat(s.name));case"TextFilter":return e.jsx(At,{name:s.name,state:n!=null?n:s.TextFilterDefault,position:c,group:a,updateFilterValue:r,update:o},"filters ".concat(s.name));case"TriStateFilter":return e.jsx(Gt,{name:s.name,state:n!=null?n:s.TriStateFilterDefault,position:c,group:a,updateFilterValue:r,update:o},"filters ".concat(s.name));default:throw new Error('Unknown source filter "'.concat(s,'"'))}})},"filters ".concat(a))}function Bt({savedSearches:t={},selectSavedSearch:a,updateSavedSearches:r,sourceFilter:o,updateFilterValue:s,resetFilterValue:c,setTriggerUpdate:n,update:u}){const{t:i}=ge(),[h,d]=x.useState(!1),[g,S]=x.useState(""),j=Object.keys(t),m=!!j.length;function l(){c(0),d(!1)}function v(){n(0),d(!1)}return e.jsxs(e.Fragment,{children:[e.jsxs(vt,{onClick:()=>d(!h),variant:"extended",color:"primary",children:[e.jsx(Se,{}),i("global.button.filter")]}),e.jsxs(gt,{open:h,onClose:()=>d(!1),children:[e.jsxs(k,{sx:{p:2,pb:m?void 0:0},children:[e.jsxs(k,{sx:{display:"flex",pb:1},children:[e.jsx(P,{onClick:l,children:i("global.button.reset")}),e.jsx(Re,{variant:"dialog",popupId:"source-browse-save-search",children:f=>e.jsxs(e.Fragment,{children:[e.jsx(Y,{title:i("source.filter.save_search.label.save"),children:e.jsx(me,{sx:{marginLeft:"auto"},...Ge(f),children:e.jsx(Ce,{})})}),e.jsxs(qe,{...Ne(f),maxWidth:"xs",fullWidth:!0,children:[e.jsx(Be,{children:i("source.filter.save_search.dialog.label.title")}),e.jsx(Ue,{children:e.jsx(xt,{sx:{width:"100%"},value:g,onChange:y=>S(y.target.value),slotProps:{htmlInput:{maxLength:50}}})}),e.jsxs(He,{children:[e.jsx(P,{onClick:()=>{S(""),f.close()},children:i("global.button.cancel")}),e.jsx(P,{onClick:()=>{r(g,"create"),S(""),f.close()},children:i("global.button.ok")})]})]})]})}),e.jsx(P,{variant:"contained",onClick:v,children:i("global.button.submit")})]}),m&&e.jsxs(e.Fragment,{children:[e.jsx(ue,{sx:{pb:1},children:"Saved searches"}),e.jsx(q,{sx:{flexDirection:"row"},children:j.map(f=>e.jsx(yt,{label:f,onClick:()=>{d(!1),a(f)},onDelete:()=>{Ct({title:i("global.label.are_you_sure"),message:i("source.filter.save_search.dialog.label.delete",{name:f}),actions:{confirm:{title:i("global.button.delete")}}}).then(()=>r(f,"delete")).catch(he())},deleteIcon:e.jsx(Y,{title:i("source.filter.save_search.label.delete"),children:e.jsx(dt,{})}),variant:"outlined"}))})]})]}),e.jsx(k,{sx:{pb:2,mx:2},children:e.jsx(ye,{sourceFilter:o,updateFilterValue:s,group:void 0,update:u})})]})]})}const Ut=t=>({...t,savedSearches:t.savedSearches?JSON.stringify(t.savedSearches):void 0}),Ht=t=>{var a;return{...t,savedSearches:(a=We(t.savedSearches))!=null?a:void 0}},zt=({meta:t}={},a)=>Ht(ze({meta:Ve(t)},{savedSearches:void 0},a)),Vt=async(t,a,r)=>Qe(t,[[a,Ut({[a]:r})[a]]]),Wt=(t,a=he())=>(r,o)=>Vt(t,r,o).catch(a),Qt=J("div")(({theme:t})=>({display:"flex",position:"sticky",width:"100%",zIndex:1,padding:t.spacing(1),gap:t.spacing(1),backgroundColor:t.palette.background.default})),Q=J(P)(()=>({})),Yt=J(k)(()=>({minHeight:"100%",position:"relative"}));var Jt=(t=>(t[t.POPULAR=0]="POPULAR",t[t.LATEST=1]="LATEST",t[t.SEARCH=2]="SEARCH",t))(Jt||{});const Kt={0:"manga.error.label.no_mangas_found",1:"manga.error.label.no_mangas_found",2:"manga.error.label.no_matches"},Zt=t=>{const a={},r=[];return t.forEach(o=>{!!a[o.id]||(a[o.id]=o,r.push(o))}),r},Xt=(t,a,r,o,s,c)=>{var j;let n;switch(a){case 0:n=O.useGetSourcePopularMangas(t,s);break;case 1:n=O.useGetSourceLatestMangas(t,s);break;case 2:n=O.useSourceSearch(t,r!=null?r:"",o.map(m=>{const{position:l,state:v,group:f}=m;return f!==void 0?{position:f,groupChange:{position:l,[m.type]:v}}:{position:l,[m.type]:v}}),s);break;default:throw new Error('Unknown ContentType "'.concat(a,'"'))}const u=n[1],i=u.findLastIndex(m=>{var l;return!!((l=m.data)!=null&&l.fetchSourceManga)}),h=u[i],d=u.slice(-1)[0].isLoading;let g=!d;const S=x.useMemo(()=>{let m=[];return u.forEach((l,v)=>{var F,w,M;const f=(M=(w=(F=l.data)==null?void 0:F.fetchSourceManga)==null?void 0:w.mangas)!=null?M:[],y=f.filter(C=>!c||!C.inLibrary),N=Zt([...m,...y]);g=!d&&u.length===v+1&&!y.length&&!!f.length,m=N}),m},[u,c]);return i===-1?[n[0],{...n[1][n[1].length-1],filteredOutAllItemsOfFetchedPage:g}]:[n[0],{...u[u.length-1],data:{...h.data,fetchSourceManga:{...h.data.fetchSourceManga,hasNextPage:u.length>i+1?!1:!!((j=h.data.fetchSourceManga)!=null&&j.hasNextPage),mangas:S}},filteredOutAllItemsOfFetchedPage:g}]};function Bs(){var se,ae,ne,re,oe;const{t}=ge(),{setTitle:a,setAction:r,appBarHeight:o}=x.useContext(Ye),{sourceId:s}=Je(),c=Ke(),n=le(),{key:u,state:i}=n,{contentType:h=0,clearCache:d=!1}=(se=le().state)!=null?se:{},[g,S]=x.useState(!0);x.useEffect(()=>{S(!1)},[]);const{settings:{hideLibraryEntries:j}}=Ze(),{options:m}=ce(),[l]=ot("query",lt),[v,f]=G("source-mangas-".concat(s,"-filters"),[]),[y,N]=G("source-mangas-location-".concat(u,"-").concat(s,"-filters"),v!=null?v:[]),[B,F]=x.useState(y),[w,M]=G("source-mangas-".concat(s,"-content-type"),h),[C,Te]=G("source-mangas-location-".concat(u,"-").concat(s,"-content-type"),l?2:w);x.useEffect(()=>()=>{f(void 0),M(void 0)},[s]);const A=x.useCallback(()=>{Xe.session.setItem(Ft(n),void 0,!1),window.scrollTo(0,0)},[u]),U=b=>{f(b),N(b),A()},Z=b=>{M(b),Te(b)},[X,{data:L,isLoading:H,size:z,abortRequest:Fe,filteredOutAllItemsOfFetchedPage:V}]=Xt(s,C,l,y,1,j),ee=H||V,Le=(ne=(ae=L==null?void 0:L.fetchSourceManga)==null?void 0:ae.mangas)!=null?ne:[],D=!!((re=L==null?void 0:L.fetchSourceManga)!=null&&re.hasNextPage),{data:W}=O.useGetSource(et,s),p=W==null?void 0:W.source,_e=(oe=p==null?void 0:p.filters)!=null?oe:[],{savedSearches:_={}}=x.useMemo(()=>zt(p),[p,p==null?void 0:p.meta]),te=Wt(p!=null?p:{id:s},()=>nt(t("global.error.label.failed_to_save_changes"),"error")),Ie=x.useCallback(b=>{const{query:I,filters:$}=_[b];$&&(F($),U($)),c({pathname:"",search:I?"query=".concat(I):void 0},{state:{...i,contentType:2}})},[_,i]),ke=x.useCallback((b,I)=>{if(I==="delete"){const ie={..._};delete ie[b],te("savedSearches",ie);return}const $={..._,[b]:{query:l!=null?l:void 0,filters:y}};te("savedSearches",$)},[_,l,y]),Ee=ee?void 0:t(Kt[C]),Me=s==="0"?e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:[t("source.local_source.label.checkout")," "]}),e.jsx(Lt,{href:"https://github.com/Suwayomi/Suwayomi-Server/wiki/Local-Source",target:"_blank",rel:"noreferrer",children:t("source.local_source.label.guide")})]}):void 0,R=x.useCallback((b,I)=>{Z(b),A(),l&&!I&&c({pathname:""},{state:{...i,contentType:b}})},[Z,l,A]);!!l&&C!==2&&R(2,l);const $e=x.useCallback(()=>{D&&X(z+1)},[z,D,C]),Pe=()=>{F([]),U([])};return x.useEffect(()=>{V&&D&&!H&&X(z+1)},[V,H]),x.useEffect(()=>{!d||!at.REVALIDATION.includes(s)||O.clearBrowseCacheFor(s)},[d]),x.useEffect(()=>()=>{C!==2||g||(Fe(new Error("SourceMangas(".concat(s,"): search string changed"))),A())},[l]),x.useEffect(()=>{var b;return a((b=p==null?void 0:p.displayName)!=null?b:t("source.title_one")),r(e.jsxs(e.Fragment,{children:[e.jsx(it,{}),e.jsx(_t,{}),(p==null?void 0:p.isConfigurable)&&e.jsx(Y,{title:t("settings.title"),children:e.jsx(me,{onClick:()=>c("/sources/".concat(s,"/configure/")),"aria-label":"display more actions",edge:"end",color:"inherit",size:"large",children:e.jsx(tt,{})})})]})),()=>{a(""),r(null)}},[t,p]),e.jsxs(Yt,{children:[e.jsxs(Qt,{sx:{top:"".concat(o,"px")},children:[e.jsx(Q,{variant:C===0?"contained":"outlined",startIcon:e.jsx(ct,{}),onClick:()=>R(0),children:t("global.button.popular")}),(p==null?void 0:p.supportsLatest)===void 0||p.supportsLatest?e.jsx(Q,{disabled:!(p!=null&&p.supportsLatest),variant:C===1?"contained":"outlined",startIcon:e.jsx(st,{}),onClick:()=>R(1),children:t("global.button.latest")}):null,e.jsx(Q,{variant:C===2?"contained":"outlined",startIcon:e.jsx(Se,{}),onClick:()=>R(2,l),children:t("global.button.filter")})]}),e.jsx(Tt,{gridWrapperProps:{sx:{px:1,pb:1}},mangas:Le,hasNextPage:D,loadMore:$e,message:Ee,messageExtra:Me,isLoading:ee,gridLayout:m.SourcegridLayout,mode:"source",inLibraryIndicator:!0},C),C===2&&e.jsx(Bt,{savedSearches:_,selectSavedSearch:Ie,updateSavedSearches:ke,sourceFilter:_e,updateFilterValue:F,setTriggerUpdate:()=>{U(B)},resetFilterValue:Pe,update:B})]})}export{Jt as SourceContentType,Bs as SourceMangas};
