import{V as _e,f as g,W as ke,X as Me,k as O,u as v,r as D,Y as Ae,e as G,j as t,Z as B,_ as Fe,$ as w,a0 as A,F as Be,m as ne,g as ie,C as ge,I as Le,y as P,z as me,E as z,a1 as ve,a2 as Ie,a3 as we,a4 as Re,G as Ee,B as Oe,A as De,L as Ge,a5 as Ne,i as Ue,a6 as Pe}from"./index-BjiAJMwJ.js";import{E as ce}from"./EmptyViewAbsoluteCentered-BG01vTz6.js";import{T as ze,a as Ye}from"./Tabs-B_Hz3Afm.js";import{F as We}from"./FilterList-DFoEpdXX.js";import{C as R}from"./CheckboxInput-Bdl-RUwV.js";import{S as Ve,R as U}from"./SortRadioInput-BZgpIrn4.js";import{T as k}from"./ThreeStateCheckboxInput-DP229WS5.js";import{O as Ke,S as Je,a as Qe}from"./SelectionFAB-B3dr5sTq.js";import{T as $e}from"./Trackers-Bgo8y--2.js";import{M as He,a as Xe}from"./Mangas-DcVqStt3.js";import{R as Ze}from"./ListPreference-1-zE-RdL.js";import{M as qe,a as et}from"./MangaGrid-DbjZuwFj.js";import{A as tt}from"./AppbarSearch-jUaFo0y9.js";import{C as at,U as rt}from"./UpdateChecker-ArRHlmjX.js";import{u as st}from"./useManageMangaLibraryState-DR1E7jN2.js";import{C as ot}from"./Checkbox-C0m2Z0XZ.js";import{e as Y}from"./Strings-CAV0u705.js";import{T as lt}from"./TabsMenu-C5OE6pgS.js";import{T as nt}from"./TabsWrapper-DAv3nDz9.js";import{u as it}from"./useAppTitle-DVJH46DH.js";import{u as ct}from"./useAppAction-Cj8ntgsC.js";import{C as dt}from"./Chip-DqnWRy4R.js";import"./StyledFab-B0KFgfZ-.js";import"./Chapters-CzOeaE_Y.js";import"./DateHelper-IYwIdS4R.js";import"./Asserts-B9U4WVql.js";import"./FormGroup-uRRNHFk5.js";import"./SwitchBase-vvWnSNDS.js";import"./Delete-B3ola86g.js";import"./Download-Cz925toA.js";import"./ContinueReadingTooltip-HSUI8FXB.js";import"./AvatarSpinner-CXKM0y7G.js";import"./SpinnerImage-BMIy5vTx.js";import"./Refresh-DBvQFCkR.js";import"./Image-DuK5Z77O.js";import"./Card-BYTjY99T.js";import"./ListCardContent-Cze7oEyu.js";import"./CheckCircle-nRDG04gg.js";import"./Metadata-0kw-gdJ2.js";import"./MUI.util-CEodEA2f.js";import"./CardActionArea-BvyAdQFj.js";import"./Link-DvHWmf56.js";import"./NumberSetting-ClyP4aHy.js";import"./Slider-DQ4DAes0.js";import"./useMobilePicker-cT_c4EbO.js";import"./SelectSetting-UfRneOcH.js";import"./Select-bkGu6hbQ.js";import"./Sync-hI6SnBBQ.js";import"./use-merged-ref-DUOZhKlj.js";import"./ListCardAvatar-CVC1ul2y.js";import"./PlayArrow-D8O_JsdS.js";import"./index-CPnX4x-s.js";import"./Virtuoso.util-CNugru3h.js";import"./Progress-DC_1n8VS.js";const ht={sortDesc:void 0,sortBy:void 0,hasDownloadedChapters:void 0,hasBookmarkedChapters:void 0,hasUnreadChapters:void 0,hasReadChapters:void 0,hasDuplicateChapters:void 0,hasTrackerBinding:{},hasStatus:{}},pt=e=>({...e,hasTrackerBinding:e.hasTrackerBinding?JSON.stringify(e.hasTrackerBinding):void 0,hasStatus:e.hasStatus?JSON.stringify(e.hasStatus):void 0}),ut=(e,a=ht,o)=>_e("category",e,a,void 0,o),be=(e,a,o)=>ut({...e,meta:ke(e.meta)},a,o),gt=(e,a)=>be(e,a),Ce=(e,a)=>{const o=be(e,a,g.useEffect);return g.useMemo(()=>o,[e,a])},mt=async(e,a,o)=>Me(e,[[a,pt({[a]:o})[a]]]),bt=(e,a=O())=>(o,r)=>mt(e,o,r).catch(a),Ct={filter:"global.label.filter",sort:"global.label.sort",display:"global.label.display"},ft=[["unreadChapters","library.option.sort.label.by_unread_chapters"],["totalChapters","library.option.sort.label.by_total_chapters"],["alphabetically","library.option.sort.label.alphabetically"],["dateAdded","library.option.sort.label.by_date_added"],["lastRead","library.option.sort.label.by_last_read"],["latestFetchedChapter","library.option.sort.label.by_latest_fetched_chapter"],["latestUploadedChapter","library.option.sort.label.by_latest_uploaded_chapter"]],xt=({category:e,open:a,onClose:o})=>{var u,S;const{t:r}=v(),n=D.useGetTrackerList(Ae),l=$e.getLoggedIn((S=(u=n.data)==null?void 0:u.trackers.nodes)!=null?S:[]),s=Ce(e),i=bt(e,h=>ne(r("global.error.label.failed_to_save_changes"),"error",ie(h))),{settings:{showTabSize:p,showContinueReadingButton:b,showDownloadBadge:T,showUnreadBadge:x,gridLayout:C}}=G(),y=Be(h=>ne(r("search.error.label.failed_to_save_settings"),"error",ie(h)));return t.jsx(Ke,{open:a,onClose:o,tabs:["filter","sort","display"],tabTitle:h=>r(Ct[h]),tabContent:h=>h==="filter"?t.jsxs(t.Fragment,{children:[t.jsx(k,{label:r("global.filter.label.unread"),checked:s.hasUnreadChapters,onChange:d=>i("hasUnreadChapters",d)}),t.jsx(k,{label:r("global.filter.label.started"),checked:s.hasReadChapters,onChange:d=>i("hasReadChapters",d)}),t.jsx(k,{label:r("global.filter.label.downloaded"),checked:s.hasDownloadedChapters,onChange:d=>i("hasDownloadedChapters",d)}),t.jsx(k,{label:r("global.filter.label.bookmarked"),checked:s.hasBookmarkedChapters,onChange:d=>i("hasBookmarkedChapters",d)}),t.jsx(k,{label:r("global.filter.label.duplicate_chapters"),checked:s.hasDuplicateChapters,onChange:d=>i("hasDuplicateChapters",d)}),t.jsx(B,{sx:{mt:2},children:r("manga.label.status")}),Object.values(Fe).map(d=>t.jsx(k,{label:r(He[d]),checked:s.hasStatus[d],onChange:j=>i("hasStatus",{...s.hasStatus,[d]:j})},d)),t.jsx(B,{sx:{mt:2},children:r("global.filter.label.tracked")}),l.map(d=>t.jsx(k,{label:d.name,checked:s.hasTrackerBinding[d.id],onChange:j=>i("hasTrackerBinding",{...s.hasTrackerBinding,[d.id]:j})},d.id))]}):h==="sort"?ft.map(([d,j])=>t.jsx(Ve,{label:r(j),checked:s.sortBy===d,sortDescending:s.sortDesc,onClick:()=>d!==s.sortBy?i("sortBy",d):i("sortDesc",!s.sortDesc)},d)):h==="display"?t.jsxs(t.Fragment,{children:[t.jsx(B,{children:r("global.grid_layout.title")}),t.jsxs(Ze,{onChange:d=>w("gridLayout",Number(d.target.value)),value:C,children:[t.jsx(U,{label:r("global.grid_layout.label.compact_grid"),value:A.Compact,checked:C==null||C===A.Compact}),t.jsx(U,{label:r("global.grid_layout.label.comfortable_grid"),value:A.Comfortable,checked:C===A.Comfortable}),t.jsx(U,{label:r("global.grid_layout.label.list"),value:A.List,checked:C===A.List})]}),t.jsx(B,{sx:{mt:2},children:r("library.option.display.badge.title")}),t.jsx(R,{label:r("library.option.display.badge.label.unread_badges"),checked:x,onChange:()=>w("showUnreadBadge",!x)}),t.jsx(R,{label:r("library.option.display.badge.label.download_badges"),checked:T,onChange:()=>w("showDownloadBadge",!T)}),t.jsx(B,{sx:{mt:2},children:r("library.option.display.tab.title")}),t.jsx(R,{label:r("library.option.display.tab.label.show_number_of_items"),checked:p,onChange:()=>y("showTabSize",!p)}),t.jsx(B,{sx:{mt:2},children:r("global.label.other")}),t.jsx(R,{label:r("library.option.display.other.label.show_continue_reading_button"),checked:b,onChange:()=>w("showContinueReadingButton",!b)})]}):null})},yt=({category:e})=>{const{t:a}=v(),[o,r]=g.useState(!1),n=gt(e),l=n.hasDownloadedChapters!=null||n.hasUnreadChapters!=null||n.hasReadChapters!=null||n.hasBookmarkedChapters!=null||n.hasDuplicateChapters!=null||Object.values(n.hasStatus).some(s=>s!=null)||Object.values(n.hasTrackerBinding).some(s=>s!=null);return t.jsxs(t.Fragment,{children:[t.jsx(ge,{title:a("settings.title"),children:t.jsx(Le,{onClick:()=>r(!o),color:l?"warning":"inherit",children:t.jsx(We,{})})}),t.jsx(xt,{category:e,open:o,onClose:()=>r(!1)})]})},St=()=>{},de=({showFilteredOutMessage:e,message:a,messageExtra:o,...r})=>{const{t:n}=v(),{settings:{gridLayout:l}}=G();return g.useLayoutEffect(()=>(document.body.style.overflowY=l===A.List?"auto":"scroll",()=>{document.body.style.overflowY="auto"}),[]),t.jsx(qe,{gridWrapperProps:{sx:{p:1}},...r,hasNextPage:!1,loadMore:St,message:e?n("library.error.label.no_matches"):a,messageExtra:e?void 0:o,gridLayout:l})},jt=({isActive:e,areAllItemsSelected:a,areNoItemsSelected:o,onSelectAll:r,onModeChange:n})=>{const{t:l}=v();return t.jsxs(t.Fragment,{children:[e&&t.jsx(Je,{areAllItemsSelected:a,areNoItemsSelected:o,onChange:r}),t.jsx(ge,{title:l(e?"global.button.cancel":"global.button.select_all"),children:t.jsx(ot,{checkedIcon:t.jsx(at,{}),sx:{padding:"8px",color:"inherit","&.Mui-checked":{color:"inherit"}},checked:e,onChange:(s,i)=>n(i)})})]})},W=(e,a,o)=>{switch(e){case!0:return a();case!1:return o();default:return!0}},E=(e,a)=>W(e,()=>!!a&&a>=1,()=>a===0),fe=(e,a)=>W(e,()=>!!a,()=>!a),M=(e,a)=>{const o=e==null?void 0:e.filter(s=>s!=null),r=a==null?void 0:a.filter(s=>s!=null);if(!(o!=null&&o.length))return!0;const n=o.map(Y),l=r.map(Y).join(", ");return n.every(s=>l.includes(s))},Tt=(e,{title:a,genre:o,description:r,artist:n,author:l,source:s,sourceId:i})=>M([e],[a])||M(e==null?void 0:e.split(","),o.map(p=>Y(p)))||M([e],[r])||M([e],[n])||M([e],[l])||M([e],[s==null?void 0:s.displayName])||M([e],[i]),_t=(e,a)=>Object.entries(e).map(([o,r])=>{const n=a.trackRecords.nodes.some(l=>l.trackerId===Number(o));return W(r,()=>n,()=>!n)}).every(Boolean),kt=(e,a)=>Object.entries(e).map(([o,r])=>fe(r,o===a.status)).every(Boolean),Mt=(e,{hasDownloadedChapters:a,hasUnreadChapters:o,hasReadChapters:r,hasBookmarkedChapters:n,hasDuplicateChapters:l,hasTrackerBinding:s,hasStatus:i})=>E(a,e.downloadCount)&&E(o,e.unreadCount)&&E(r,e.chapters.totalCount-e.unreadCount)&&E(n,e.bookmarkCount)&&fe(l,e.hasDuplicateChapters)&&_t(s,e)&&kt(i,e),At=(e,a,o)=>{const r=o.ignoreFilters&&(a==null?void 0:a.length);return e.filter(n=>{const l=Tt(a,n),s=r||Mt(n,o);return l&&s})},L=(e=0,a=0)=>Number(e)-Number(a),he=(e,a)=>e.localeCompare(a,void 0,{sensitivity:"base"}),Ft=(e,a,o)=>{const r=[...e],n=(()=>{switch(a){case"alphabetically":return(l,s)=>he(l.title,s.title);case"dateAdded":return(l,s)=>L(l.inLibraryAt,s.inLibraryAt);case"unreadChapters":return(l,s)=>L(l.unreadCount,s.unreadCount);case"lastRead":return(l,s)=>{var i,p;return L((i=l.lastReadChapter)==null?void 0:i.lastReadAt,(p=s.lastReadChapter)==null?void 0:p.lastReadAt)};case"latestUploadedChapter":return(l,s)=>{var i,p;return L((i=l.latestUploadedChapter)==null?void 0:i.uploadDate,(p=s.latestUploadedChapter)==null?void 0:p.uploadDate)};case"latestFetchedChapter":return(l,s)=>{var i,p;return L((i=l.latestFetchedChapter)==null?void 0:i.fetchedAt,(p=s.latestFetchedChapter)==null?void 0:p.fetchedAt)};case"totalChapters":return(l,s)=>L(l.chapters.totalCount,s.chapters.totalCount);default:return()=>0}})();return r.sort((l,s)=>{const i=n(l,s);return i!==0?o?-i:i:he(l.title,s.title)}),r},Bt={id:-1},Lt=(e,a)=>{const[o]=P(z.QUERY,me),r=Ce(a!=null?a:Bt),{hasUnreadChapters:n,hasReadChapters:l,hasDownloadedChapters:s,hasBookmarkedChapters:i,hasTrackerBinding:p,hasDuplicateChapters:b,hasStatus:T}=r,{settings:x}=G(),C=g.useMemo(()=>At(e,o,{...r,ignoreFilters:x.ignoreFilters}),[e,o,n,l,s,i,p,b,T,x.ignoreFilters]),y=g.useMemo(()=>Ft(C,r.sortBy,r.sortDesc),[C,r.sortBy,r.sortDesc]),u=Object.values(r.hasTrackerBinding).some(h=>h!=null),S=(n!=null||l!=null||s!=null||i!=null||!!o||u)&&C.length===0&&e.length>0;return{visibleMangas:y,showFilteredOutMessage:S,filterKey:"".concat(JSON.stringify(r)).concat(x.ignoreFilters)}},pe=Ne("span")({display:"flex",alignItems:"center"}),ue=({sx:e,...a})=>t.jsx(dt,{...a,size:"small",sx:{...e,marginLeft:"5px"}});function va(){var te,ae,re,se,oe,le;const{t:e}=v(),a=ve(),{settings:{showTabSize:o}}=G(),{data:r,error:n,loading:l,refetch:s}=D.useGetCategories(Ie,{notifyOnNetworkStatusChange:!0}),i=r==null?void 0:r.categories.nodes.filter(c=>c.id!==0||c.id===0&&c.mangas.totalCount),p=i!=null?i:[],b=D.useGetMangas(we,{}),T=(ae=(te=b.data)==null?void 0:te.mangas.totalCount)!=null?ae:0,[x,C]=P(z.TAB,Pe),[y]=P(z.QUERY,me),u=(re=p.find(c=>c.id===x))!=null?re:p[0],{data:S,error:h,loading:d,refetch:j}=D.useGetCategoryMangas(u==null?void 0:u.id,{skip:!u,notifyOnNetworkStatusChange:!0}),xe=(se=S==null?void 0:S.mangas.nodes)!=null?se:[],{visibleMangas:f,showFilteredOutMessage:V,filterKey:K}=Lt(xe,u),J=g.useCallback(()=>j().catch(O()),[j,u]),ye=g.useMemo(()=>f.map(c=>c.id),[f]),[_,I]=g.useState(!1),{areNoItemsForKeySelected:Q,areAllItemsForKeySelected:$,selectedItemIds:F,handleSelectAll:N,handleSelection:H,clearSelection:Se}=st(f.length,{itemIds:ye,currentKey:u==null?void 0:u.id.toString()}),X=g.useCallback((c,m,Te)=>{I(!!(F.length+(m?1:-1))),H(c,m,Te)},[I,H]),Z=g.useMemo(()=>F.map(c=>Xe.getFromCache(c,Re,"MANGA_CHAPTER_STAT_FIELDS")).filter(c=>!!c),[F.length,f]),q=g.useMemo(()=>_?t.jsx(Qe,{selectedItemsCount:F.length,title:"manga.title",children:(c,m)=>t.jsx(et,{selectedMangas:Z,onClose:()=>{c(),I(!1),Se()},setHideMenu:m})}):null,[_,Z]),ee=g.useMemo(()=>!!y&&t.jsx(Ee,{sx:{p:2},children:t.jsx(Oe,{size:"large",component:Ge,to:De.sources.childRoutes.searchAll.path(y),sx:{textTransform:"none",width:"100%"},children:e("library.action.label.search_globally",{query:y})})}),[y]);it(t.jsxs(pe,{children:[e("library.title"),o&&t.jsx(ue,{sx:{...a.applyStyles("light",{backgroundColor:"background.paper"})},label:T})]}),e("library.title"),[e,o,T]),ct(t.jsxs(t.Fragment,{children:[!_&&u&&t.jsxs(t.Fragment,{children:[t.jsx(tt,{}),t.jsx(yt,{category:u}),t.jsx(rt,{categoryId:u==null?void 0:u.id})]}),!!f.length&&t.jsx(jt,{isActive:_,areAllItemsSelected:$,areNoItemsSelected:Q,onSelectAll:c=>N(c,[...new Set(f.map(m=>m.id))]),onModeChange:c=>{I(c),c?N(!0,[...new Set(f.map(m=>m.id))]):p.forEach(m=>N(!1,[],m.id.toString()))}})]}),[_,Q,$,u,f.length]);const je=c=>{C(c)};return n!=null||b.error?t.jsx(ce,{message:e("global.error.label.failed_to_load_data"),messageExtra:(le=n==null?void 0:n.message)!=null?le:(oe=b.error)==null?void 0:oe.message,retry:()=>{n&&s().catch(O()),b.error&&b.refetch().catch(O())}}):l||b.loading?t.jsx(Ue,{}):p.length===0?t.jsx(ce,{message:e("library.error.label.empty")}):p.length===1?t.jsxs(t.Fragment,{children:[ee,t.jsx(de,{mangas:f,message:e(h?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:h==null?void 0:h.message,isLoading:d,selectedMangaIds:F,isSelectModeActive:_,handleSelection:X,showFilteredOutMessage:!h&&V,retry:h&&J},K),q]}):t.jsxs(nt,{children:[t.jsx(lt,{value:u.id,onChange:(c,m)=>je(m),children:p.map(c=>t.jsx(ze,{sx:{flexGrow:1,maxWidth:"unset"},label:t.jsxs(pe,{children:[c.name,o?t.jsx(ue,{label:c.mangas.totalCount}):null]}),value:c.id},c.id))}),ee,p.map(c=>t.jsx(Ye,{index:c.order,currentIndex:u.order,children:c===u&&t.jsx(de,{mangas:f,message:e(h?"manga.error.label.request_failure":"category.error.label.empty"),messageExtra:h==null?void 0:h.message,isLoading:d,selectedMangaIds:F,isSelectModeActive:_,handleSelection:X,showFilteredOutMessage:!h&&V,retry:h&&J},K)},c.order)),q]})}export{va as Library};
