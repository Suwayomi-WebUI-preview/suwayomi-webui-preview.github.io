var J=Object.freeze,se=Object.defineProperty;var Q=(e,t)=>J(se(e,"raw",{value:J(t||e.slice())}));import{e as s,c as O,j as c,ar as le,as as ce,at as ie,al as ue,a6 as de,u as ee,r as z,dZ as te,l as ge,n as fe,o as he,a1 as me,S as U,B as H,A as oe,L as be,d_ as pe,Q as ve,m as A,g as D,X as G,i as B,f as ye,ba as N,d$ as Ce,e0 as Se}from"./index-YZjYIyFe.js";import{T as xe}from"./ThreeStateCheckboxInput-B1MBybCs.js";import{C as Me}from"./CheckboxInput-B6G4yK_I.js";import{F as Te}from"./FormGroup-DKFzyqKA.js";var R=(e=>(e.Mouse="mouse",e.Touch="touch",e.Pointer="pointer",e))(R||{}),F=(e=>(e.CancelledByMovement="cancelled-by-movement",e.CancelledByRelease="cancelled-by-release",e.CancelledOutsideElement="cancelled-outside-element",e))(F||{});const Ie=["mousedown","mousemove","mouseup","mouseleave","mouseout"],we=["touchstart","touchmove","touchend","touchcancel"],Le=["pointerdown","pointermove","pointerup","pointerleave","pointerout"];function Ee(e){return typeof e=="object"&&e!==null&&"pageX"in e&&typeof e.pageX=="number"&&"pageY"in e&&typeof e.pageY=="number"}function _e(e){var t;return Ie.includes((t=e==null?void 0:e.nativeEvent)==null?void 0:t.type)}function ae(e){var t;return we.includes((t=e==null?void 0:e.nativeEvent)==null?void 0:t.type)||"touches"in e}function ke(e){const{nativeEvent:t}=e;return t?Le.includes(t==null?void 0:t.type)||"pointerId"in t:!1}function q(e){return _e(e)||ae(e)||ke(e)}function W(e){var t;const o=ae(e)?(t=e==null?void 0:e.touches)==null?void 0:t[0]:e;return Ee(o)?{x:o.pageX,y:o.pageY}:null}function je(e){return{target:e.target,currentTarget:e.currentTarget,nativeEvent:e,persist:()=>{}}}function Ne(e,{threshold:t=400,captureEvent:o=!1,detect:i=R.Pointer,cancelOnMovement:l=!1,cancelOutsideElement:f=!0,filterEvents:u,onStart:v,onMove:T,onFinish:I,onCancel:w}={}){const m=s.useRef(!1),y=s.useRef(!1),C=s.useRef(),d=s.useRef(),S=s.useRef(e),b=s.useRef(null),p=s.useCallback(a=>r=>{y.current||q(r)&&(u!==void 0&&!u(r)||(o&&r.persist(),v==null||v(r,{context:a}),b.current=W(r),y.current=!0,C.current=r.currentTarget,d.current=setTimeout(()=>{S.current&&(S.current(r,{context:a}),m.current=!0)},t)))},[o,u,v,t]),h=s.useCallback(a=>(r,n)=>{q(r)&&y.current&&(b.current=null,o&&r.persist(),m.current?I==null||I(r,{context:a}):y.current&&(w==null||w(r,{context:a,reason:n!=null?n:F.CancelledByRelease})),m.current=!1,y.current=!1,d.current!==void 0&&clearTimeout(d.current))},[o,I,w]),M=s.useCallback(a=>r=>{if(q(r)&&(T==null||T(r,{context:a}),l!==!1&&b.current)){const n=W(r);if(n){const g=l===!0?25:l,_={x:Math.abs(n.x-b.current.x),y:Math.abs(n.y-b.current.y)};(_.x>g||_.y>g)&&h(a)(r,F.CancelledByMovement)}}},[h,l,T]),x=s.useCallback(a=>{if(e===null)return{};switch(i){case R.Mouse:{const r={onMouseDown:p(a),onMouseMove:M(a),onMouseUp:h(a)};return f&&(r.onMouseLeave=n=>{h(a)(n,F.CancelledOutsideElement)}),r}case R.Touch:return{onTouchStart:p(a),onTouchMove:M(a),onTouchEnd:h(a)};case R.Pointer:{const r={onPointerDown:p(a),onPointerMove:M(a),onPointerUp:h(a)};return f&&(r.onPointerLeave=n=>h(a)(n,F.CancelledOutsideElement)),r}}},[e,h,f,i,M,p]);return s.useEffect(()=>{function a(r){const n=je(r);h()(n)}return window.addEventListener("mouseup",a),window.addEventListener("touchend",a),window.addEventListener("pointerup",a),()=>{window.removeEventListener("mouseup",a),window.removeEventListener("touchend",a),window.removeEventListener("pointerup",a)}},[h]),s.useEffect(()=>()=>{d.current!==void 0&&clearTimeout(d.current)},[]),s.useEffect(()=>{S.current=e},[e]),x}const qe=O(c.jsx("path",{d:"M19 5v14H5V5zm0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2"})),Ke=O(c.jsx("path",{d:"m1.79 12 5.58 5.59L5.96 19 .37 13.41zm.45-7.78L12.9 14.89l-1.28 1.28L7.44 12l-1.41 1.41L11.62 19l2.69-2.69 4.89 4.89 1.41-1.41L3.65 2.81zm14.9 9.27L23.62 7 22.2 5.59l-6.48 6.48zM17.96 7l-1.41-1.41-3.65 3.66 1.41 1.41z"})),$e=O(c.jsx("path",{d:"M9 16.2 4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4z"})),Xe=O(c.jsx("path",{d:"M16.5 3c-1.74 0-3.41.81-4.5 2.09C10.91 3.81 9.24 3 7.5 3 4.42 3 2 5.42 2 8.5c0 3.78 3.4 6.86 8.55 11.54L12 21.35l1.45-1.32C18.6 15.36 22 12.28 22 8.5 22 5.42 19.58 3 16.5 3m-4.4 15.55-.1.1-.1-.1C7.14 14.24 4 11.39 4 8.5 4 6.5 5.5 5 7.5 5c1.54 0 3.04.99 3.57 2.36h1.87C13.46 5.99 14.96 5 16.5 5c2 0 3.5 1.5 3.5 3.5 0 2.89-3.14 5.74-7.9 10.05"})),Ye=({title:e,Icon:t,...o})=>c.jsxs(le,{...o,children:[c.jsx(ce,{children:c.jsx(t,{fontSize:"small"})}),c.jsx(ie,{children:e})]}),Ve=(e,t)=>(o,i)=>{const l=i>0?" (".concat(i,")"):"";return"".concat(ue(t[o].action[e?"single":"selected"])).concat(l)},Je=e=>(t=!1)=>e?t:!0,Qe=e=>t=>e?!1:t,We=O(c.jsx("path",{d:"M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2m0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2m0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2"})),Ze=({children:e,onClose:t,...o})=>{const[i,l]=s.useState(!1);return c.jsx(de,{...o,open:o.open,onClose:t,sx:{visibility:!o.open||i?"hidden":"visible"},children:e(()=>{t({},"backdropClick"),l(!1)},l)})},Ae=(e,{itemIds:t=[],keyCount:o=e,currentKey:i,initialState:l={}})=>{var x;const[f,u]=s.useState(l),v=s.useRef(void 0),T=[...new Set(Object.values(f).flat())],I=T.length===e,w=!T.length,m=(x=f[i])!=null?x:[],y=m.length===o,C=m.length===0;C&&(v.current=void 0);const d=s.useCallback((a,r,{selectRange:n=!1,key:g=i}={})=>{var Y;const _=!r,{id:L,key:ne}=(Y=v.current)!=null?Y:{};v.current={id:a,key:g};const P=n&&g===ne&&L!==void 0,K=P?t.indexOf(L):-1,$=P?t.indexOf(a):-1,X=P?t.slice(Math.min(K,$),Math.max(K,$)+1):[a];if(_){u(k=>{var j,V;return{...k,[g]:(V=(j=k[g])==null?void 0:j.filter(re=>!X.includes(re)))!=null?V:[]}});return}u(k=>{var j;return{...k,[g]:[...new Set([...(j=k[g])!=null?j:[],...X])]}})},[i,t]),S=s.useCallback((a,r,n=i)=>{switch(a){case!0:u(g=>({...g,[n]:[...r]}));break;case!1:u(g=>({...g,[n]:[]}));break}},[i]),b=s.useCallback((a,r)=>{u(n=>({...n,[a]:[...r]}))},[]),p=s.useCallback(a=>f[a],[f]),h=s.useCallback(()=>{u({})},[]),M=s.useCallback(()=>{h(),u(l)},[h,l]);return{selectedItemIds:T,keySelectedItemIds:m,handleSelection:d,handleSelectAll:S,areAllItemsSelected:I,areNoItemsSelected:w,areAllItemsForKeySelected:y,areNoItemsForKeySelected:C,setSelectionForKey:b,getSelectionForKey:p,clearSelection:h,reset:M}},De=0;class E{static getIds(t){return t.map(o=>o.id)}static getUserCreated(t){return t.filter(o=>o.id!==De)}static getDefaults(t){return t.filter(o=>o.default)}}const Re=e=>{const{data:t}=z.useGetManga(pe,e!=null?e:-1,{skip:e===void 0});return s.useMemo(()=>e===void 0||!t?[]:E.getIds(t.manga.categories.nodes),[t==null?void 0:t.manga.categories.nodes,e])},Fe=(e,t,o,i)=>{if(t.includes(e))return!0;if(!i&&o.includes(e))return!1};function Oe(e){const{t}=ee(),{open:o,onClose:i,mangaId:l,mangaIds:f,addToLibrary:u=!1}=e,v=l!==void 0,T=f!=null?f:[l],[I,w]=s.useState(!1),m=Re(l),{data:y}=z.useGetCategories(te),C=y==null?void 0:y.categories.nodes,d=s.useMemo(()=>E.getUserCreated(C!=null?C:[]),[C]),S=s.useMemo(()=>u?E.getIds(E.getDefaults(d)):[],[d]),{handleSelection:b,setSelectionForKey:p,getSelectionForKey:h}=Ae(d.length,{currentKey:"categoriesToAdd",initialState:{categoriesToAdd:[...m,...S],categoriesToRemove:[]}});s.useEffect(()=>{p("categoriesToAdd",[...m,...S]),p("categoriesToRemove",[])},[m]);const M=h("categoriesToAdd"),x=h("categoriesToRemove"),a=()=>{p("categoriesToAdd",m),p("categoriesToRemove",[]),i(!1)},r=()=>{const n=v?M.filter(L=>!m.includes(L)):M,g=v?m.filter(L=>!M.includes(L)):x;i(!0,n,g),I&&ve("showAddToLibraryCategorySelectDialog",!1).catch(L=>A(t("search.error.label.failed_to_save_settings"),"error",D(L))),(n.length||g.length)&&(u||G.performAction("change_categories",T,{changeCategoriesPatch:{addToCategories:n,removeFromCategories:g}}).catch(B()))};return c.jsxs(ge,{sx:{".MuiDialog-paper":{maxHeight:435,width:"80%"}},maxWidth:"xs",open:o,onClose:a,children:[c.jsx(fe,{children:t("category.title.set_categories")}),c.jsx(he,{dividers:!0,children:c.jsxs(Te,{children:[d.length===0&&c.jsx("span",{children:t("category.error.no_categories_found.label.info")}),d.map(n=>c.jsx(xe,{checked:Fe(n.id,M,x,v),onChange:g=>{b(n.id,!1,{key:"categoriesToAdd"}),b(n.id,!1,{key:"categoriesToRemove"}),g&&b(n.id,!0,{key:"categoriesToAdd"}),g===!1&&b(n.id,!0,{key:"categoriesToRemove"})},label:n.name},n.id))]})}),c.jsx(me,{children:c.jsxs(U,{sx:{width:"100%"},children:[u&&c.jsx(Me,{sx:{margin:0},size:"small",label:t("global.button.dont_show_dialog_again"),onChange:n=>w(n.target.checked)}),c.jsxs(U,{direction:"row",sx:{justifyContent:"space-between",alignItems:"end",width:"100%"},children:[c.jsx(H,{component:be,to:oe.settings.childRoutes.categories.path,children:t(d.length?"global.button.edit":"global.button.create")}),c.jsxs(U,{direction:"row",children:[c.jsx(H,{autoFocus:!0,onClick:a,color:"primary",children:t("global.button.cancel")}),!!d.length&&c.jsx(H,{onClick:r,color:"primary",children:t("global.button.ok")})]})]})]})})]})}const Ge=({mangaId:e,mangaIds:t,onClose:o,addToLibrary:i})=>{const[l,f]=s.useState(!1),u=s.useMemo(()=>l?c.jsx(Oe,{open:l,onClose:(...v)=>{f(!1),o==null||o(...v)},mangaId:e,mangaIds:t,addToLibrary:i}):null,[e,t,i,o,l]);return{openCategorySelect:f,CategorySelectComponent:u}};var Z;const et=(e,t=!1)=>{var m,y;const{t:o}=ee(),i=ye(),[l,f]=s.useState(!!e.inLibrary),u=s.useCallback((C,d=[],S=[])=>{C&&z.updateManga(e.id,{updateManga:{inLibrary:!0},updateMangaCategories:{addToCategories:d,removeFromCategories:S}}).response.then(()=>A(o("library.info.label.added_to_library"),"success")).then(()=>f(!0)).catch(b=>{A(o("library.error.label.add_to_library"),"error",D(b))})},[e.id]),v=s.useCallback(async()=>{t&&await N({title:o("global.label.are_you_sure"),message:o("manga.action.library.remove.dialog.label.message",{title:e.title}),actions:{confirm:{title:o("global.button.remove")}}}),await G.removeFromLibrary([e.id]),f(!1)},[e.id,t]),{openCategorySelect:T,CategorySelectComponent:I}=Ge({mangaId:e.id,addToLibrary:!0,onClose:u}),w=s.useCallback(()=>{const C=async()=>{if(l){v().catch(B());return}let d;try{d=(await Se()).showAddToLibraryCategorySelectDialog}catch(x){A(o("global.error.label.failed_to_load_data"),"error",D(x));return}let S;try{S=await z.getCategories(te).response}catch(x){A(o("category.error.label.request_failure"),"error",D(x));return}const b=E.getUserCreated(S.data.categories.nodes);let p;try{p=await G.getDuplicateLibraryMangas(e.title).response}catch(x){await N({title:o("global.error.label.failed_to_load_data"),message:o("manga.action.library.add.dialog.duplicate.label.failure",{error:D(x)}),actions:{extra:{show:!0,title:o("global.button.retry"),contain:!0},confirm:{title:o("global.button.add")}},onExtra:()=>C().catch(B())})}if((p==null?void 0:p.data.mangas.totalCount)&&await N({title:o("global.label.are_you_sure"),message:o("manga.action.library.add.dialog.duplicate.label.info"),actions:{extra:{show:!0,title:o("migrate.dialog.action.button.show_entry"),contain:!0},confirm:{title:o("global.button.add")}},onExtra:()=>i(oe.manga.path(p.data.mangas.nodes[0].id))}),!(d&&!!b.length)){u(!0,E.getIds(E.getDefaults(b)));return}T(!0)};C().catch(B())},[l,v,u]);return{CategorySelectComponent:I,updateLibraryState:w,isInLibrary:(y=(m=G.getFromCache(e.id,Ce(Z||(Z=Q(["\n                    fragment MangaInLibraryState on MangaType {\n                        inLibrary\n                    }\n                "]))),"MangaInLibraryState"))==null?void 0:m.inLibrary)!=null?y:l}};export{qe as C,$e as D,Xe as F,Ze as M,Ke as R,Ne as V,et as a,Ge as b,Je as c,Ye as d,Ve as e,Qe as f,We as g,Ae as u};
