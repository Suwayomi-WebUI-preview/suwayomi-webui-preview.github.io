import{V as je,f as b,W as ke,X as Te,k as O,u as I,r as D,Y as _e,e as G,j as a,Z as B,_ as Me,$ as w,a0 as M,F as Ae,m as ne,g as ie,C as ge,I as Fe,y as P,z as ue,E as z,a1 as Be,a2 as Le,a3 as Ie,G as ve,B as we,A as Re,L as Ee,a4 as Oe,i as De,a5 as Ge}from"./index-lvqKmwz9.js";import{E as ce}from"./EmptyViewAbsoluteCentered-D8omcQaL.js";import{T as Ne,a as Ue}from"./Tabs-BaIZrnOC.js";import{F as Pe}from"./FilterList-BQlQW4QZ.js";import{C as R}from"./CheckboxInput-C87bTpzJ.js";import{S as ze,R as U}from"./SortRadioInput-CNDdI4ux.js";import{T}from"./ThreeStateCheckboxInput-Arxb39_m.js";import{O as Ye,S as We,a as Ve}from"./SelectionFAB-C7Mm7oX7.js";import{T as Ke}from"./Trackers-Bgo8y--2.js";import{M as Je,a as Qe}from"./Mangas-AqwSv1ee.js";import{R as $e}from"./ListPreference-KoD6vzUc.js";import{M as He,a as Xe}from"./MangaGrid-DdqCdrnx.js";import{A as Ze}from"./AppbarSearch-DjgZ8QuU.js";import{C as qe,U as et}from"./UpdateChecker-Ce7fQQCI.js";import{u as tt}from"./useManageMangaLibraryState-qzg-BOlm.js";import{C as at}from"./Checkbox-DQLqhxnA.js";import{e as Y}from"./Strings-CAV0u705.js";import{T as st}from"./TabsMenu-225Pj3aQ.js";import{T as rt}from"./TabsWrapper-C30Z7Oqv.js";import{u as ot}from"./useAppTitle-YubyQBZL.js";import{u as lt}from"./useAppAction-B99h7aaI.js";import{C as nt}from"./Chip-B9VQHaLQ.js";import"./StyledFab-DLL13wE9.js";import"./Chapters-X8vQV6zu.js";import"./DateHelper-Co0wUw9H.js";import"./Asserts-oTw7SpVz.js";import"./FormGroup-CfFdIdVB.js";import"./SwitchBase-DIBIAXOv.js";import"./Delete-DJ8WMnA5.js";import"./Download-XCXv7YcJ.js";import"./ContinueReadingTooltip-DCL-6jJ0.js";import"./AvatarSpinner-CVXZHkHH.js";import"./SpinnerImage-CUXl0kCo.js";import"./Refresh-NpbiqDjf.js";import"./Image-CH4ma2ii.js";import"./Card-cg4XgeTD.js";import"./ListCardContent-CZl4ReHs.js";import"./CheckCircle-D5R0llbc.js";import"./Metadata-BZjiCYwD.js";import"./MUI.util-CEodEA2f.js";import"./CardActionArea-wfiILIO1.js";import"./Link-CuLykgl6.js";import"./NumberSetting-CPnPthdS.js";import"./Slider-B8TVAqGI.js";import"./useMobilePicker-DcCDBqUh.js";import"./SelectSetting-6ERPkiTl.js";import"./Select-vVmO8--9.js";import"./Sync-BYHlK55j.js";import"./use-merged-ref-B5pGa7g7.js";import"./ListCardAvatar-fXjpaWO1.js";import"./PlayArrow-C6UqlnSC.js";import"./index-DJihNex-.js";import"./Virtuoso.util-qZZh8Jqe.js";import"./Progress-CxuTbZAg.js";const it={sortDesc:void 0,sortBy:void 0,hasDownloadedChapters:void 0,hasBookmarkedChapters:void 0,hasUnreadChapters:void 0,hasReadChapters:void 0,hasDuplicateChapters:void 0,hasTrackerBinding:{},hasStatus:{}},ct=e=>({...e,hasTrackerBinding:e.hasTrackerBinding?JSON.stringify(e.hasTrackerBinding):void 0,hasStatus:e.hasStatus?JSON.stringify(e.hasStatus):void 0}),dt=(e,s=it,o)=>je("category",e,s,void 0,o),me=(e,s,o)=>dt({...e,meta:ke(e.meta)},s,o),ht=(e,s)=>me(e,s),be=(e,s)=>{const o=me(e,s,b.useEffect);return b.useMemo(()=>o,[e,s])},pt=async(e,s,o)=>Te(e,[[s,ct({[s]:o})[s]]]),gt=(e,s=O())=>(o,t)=>pt(e,o,t).catch(s),ut={filter:"global.label.filter",sort:"global.label.sort",display:"global.label.display"},mt=[["unreadChapters","library.option.sort.label.by_unread_chapters"],["totalChapters","library.option.sort.label.by_total_chapters"],["alphabetically","library.option.sort.label.alphabetically"],["dateAdded","library.option.sort.label.by_date_added"],["lastRead","library.option.sort.label.by_last_read"],["latestFetchedChapter","library.option.sort.label.by_latest_fetched_chapter"],["latestUploadedChapter","library.option.sort.label.by_latest_uploaded_chapter"]],bt=({category:e,open:s,onClose:o})=>{var y,p;const{t}=I(),l=D.useGetTrackerList(_e),n=Ke.getLoggedIn((p=(y=l.data)==null?void 0:y.trackers.nodes)!=null?p:[]),r=be(e),i=gt(e,u=>ne(t("global.error.label.failed_to_save_changes"),"error",ie(u))),{settings:{showTabSize:m,showContinueReadingButton:S,showDownloadBadge:A,showUnreadBadge:x,gridLayout:g}}=G(),h=Ae(u=>ne(t("search.error.label.failed_to_save_settings"),"error",ie(u)));return a.jsx(Ye,{open:s,onClose:o,tabs:["filter","sort","display"],tabTitle:u=>t(ut[u]),tabContent:u=>u==="filter"?a.jsxs(a.Fragment,{children:[a.jsx(T,{label:t("global.filter.label.unread"),checked:r.hasUnreadChapters,onChange:d=>i("hasUnreadChapters",d)}),a.jsx(T,{label:t("global.filter.label.started"),checked:r.hasReadChapters,onChange:d=>i("hasReadChapters",d)}),a.jsx(T,{label:t("global.filter.label.downloaded"),checked:r.hasDownloadedChapters,onChange:d=>i("hasDownloadedChapters",d)}),a.jsx(T,{label:t("global.filter.label.bookmarked"),checked:r.hasBookmarkedChapters,onChange:d=>i("hasBookmarkedChapters",d)}),a.jsx(T,{label:t("global.filter.label.duplicate_chapters"),checked:r.hasDuplicateChapters,onChange:d=>i("hasDuplicateChapters",d)}),a.jsx(B,{sx:{mt:2},children:t("manga.label.status")}),Object.values(Me).map(d=>a.jsx(T,{label:t(Je[d]),checked:r.hasStatus[d],onChange:j=>i("hasStatus",{...r.hasStatus,[d]:j})},d)),a.jsx(B,{sx:{mt:2},children:t("global.filter.label.tracked")}),n.map(d=>a.jsx(T,{label:d.name,checked:r.hasTrackerBinding[d.id],onChange:j=>i("hasTrackerBinding",{...r.hasTrackerBinding,[d.id]:j})},d.id))]}):u==="sort"?mt.map(([d,j])=>a.jsx(ze,{label:t(j),checked:r.sortBy===d,sortDescending:r.sortDesc,onClick:()=>d!==r.sortBy?i("sortBy",d):i("sortDesc",!r.sortDesc)},d)):u==="display"?a.jsxs(a.Fragment,{children:[a.jsx(B,{children:t("global.grid_layout.title")}),a.jsxs($e,{onChange:d=>w("gridLayout",Number(d.target.value)),value:g,children:[a.jsx(U,{label:t("global.grid_layout.label.compact_grid"),value:M.Compact,checked:g==null||g===M.Compact}),a.jsx(U,{label:t("global.grid_layout.label.comfortable_grid"),value:M.Comfortable,checked:g===M.Comfortable}),a.jsx(U,{label:t("global.grid_layout.label.list"),value:M.List,checked:g===M.List})]}),a.jsx(B,{sx:{mt:2},children:t("library.option.display.badge.title")}),a.jsx(R,{label:t("library.option.display.badge.label.unread_badges"),checked:x,onChange:()=>w("showUnreadBadge",!x)}),a.jsx(R,{label:t("library.option.display.badge.label.download_badges"),checked:A,onChange:()=>w("showDownloadBadge",!A)}),a.jsx(B,{sx:{mt:2},children:t("library.option.display.tab.title")}),a.jsx(R,{label:t("library.option.display.tab.label.show_number_of_items"),checked:m,onChange:()=>h("showTabSize",!m)}),a.jsx(B,{sx:{mt:2},children:t("global.label.other")}),a.jsx(R,{label:t("library.option.display.other.label.show_continue_reading_button"),checked:S,onChange:()=>w("showContinueReadingButton",!S)})]}):null})},Ct=({category:e})=>{const{t:s}=I(),[o,t]=b.useState(!1),l=ht(e),n=l.hasDownloadedChapters!=null||l.hasUnreadChapters!=null||l.hasReadChapters!=null||l.hasBookmarkedChapters!=null||l.hasDuplicateChapters!=null||Object.values(l.hasStatus).some(r=>r!=null)||Object.values(l.hasTrackerBinding).some(r=>r!=null);return a.jsxs(a.Fragment,{children:[a.jsx(ge,{title:s("settings.title"),children:a.jsx(Fe,{onClick:()=>t(!o),color:n?"warning":"inherit",children:a.jsx(Pe,{})})}),a.jsx(bt,{category:e,open:o,onClose:()=>t(!1)})]})},ft=()=>{},de=({showFilteredOutMessage:e,message:s,messageExtra:o,...t})=>{const{t:l}=I(),{settings:{gridLayout:n}}=G();return b.useLayoutEffect(()=>(document.body.style.overflowY=n===M.List?"auto":"scroll",()=>{document.body.style.overflowY="auto"}),[]),a.jsx(He,{gridWrapperProps:{sx:{p:1}},...t,hasNextPage:!1,loadMore:ft,message:e?l("library.error.label.no_matches"):s,messageExtra:e?void 0:o,gridLayout:n})},xt=({isActive:e,areAllItemsSelected:s,areNoItemsSelected:o,onSelectAll:t,onModeChange:l})=>{const{t:n}=I();return a.jsxs(a.Fragment,{children:[e&&a.jsx(We,{areAllItemsSelected:s,areNoItemsSelected:o,onChange:t}),a.jsx(ge,{title:n(e?"global.button.cancel":"global.button.select_all"),children:a.jsx(at,{checkedIcon:a.jsx(qe,{}),sx:{padding:"8px",color:"inherit","&.Mui-checked":{color:"inherit"}},checked:e,onChange:(r,i)=>l(i)})})]})},W=(e,s,o)=>{switch(e){case!0:return s();case!1:return o();default:return!0}},E=(e,s)=>W(e,()=>!!s&&s>=1,()=>s===0),Ce=(e,s)=>W(e,()=>!!s,()=>!s),_=(e,s)=>{const o=e==null?void 0:e.filter(r=>r!=null),t=s==null?void 0:s.filter(r=>r!=null);if(!(o!=null&&o.length))return!0;const l=o.map(Y),n=t.map(Y).join(", ");return l.every(r=>n.includes(r))},yt=(e,{title:s,genre:o,description:t,artist:l,author:n,source:r,sourceId:i})=>_([e],[s])||_(e==null?void 0:e.split(","),o.map(m=>Y(m)))||_([e],[t])||_([e],[l])||_([e],[n])||_([e],[r==null?void 0:r.displayName])||_([e],[i]),St=(e,s)=>Object.entries(e).map(([o,t])=>{const l=s.trackRecords.nodes.some(n=>n.trackerId===Number(o));return W(t,()=>l,()=>!l)}).every(Boolean),jt=(e,s)=>Object.entries(e).map(([o,t])=>Ce(t,o===s.status)).every(Boolean),kt=(e,{hasDownloadedChapters:s,hasUnreadChapters:o,hasReadChapters:t,hasBookmarkedChapters:l,hasDuplicateChapters:n,hasTrackerBinding:r,hasStatus:i})=>E(s,e.downloadCount)&&E(o,e.unreadCount)&&E(t,e.chapters.totalCount-e.unreadCount)&&E(l,e.bookmarkCount)&&Ce(n,e.hasDuplicateChapters)&&St(r,e)&&jt(i,e),Tt=(e,s,o)=>{const t=o.ignoreFilters&&(s==null?void 0:s.length);return e.filter(l=>{const n=yt(s,l),r=t||kt(l,o);return n&&r})},L=(e=0,s=0)=>Number(e)-Number(s),_t=(e,s)=>e.localeCompare(s),Mt=(e,s,o)=>{const t=[...e];switch(s){case"alphabetically":t.sort((l,n)=>_t(l.title,n.title));break;case"dateAdded":t.sort((l,n)=>L(l.inLibraryAt,n.inLibraryAt));break;case"unreadChapters":t.sort((l,n)=>L(l.unreadCount,n.unreadCount));break;case"lastRead":t.sort((l,n)=>{var r,i;return L((r=l.lastReadChapter)==null?void 0:r.lastReadAt,(i=n.lastReadChapter)==null?void 0:i.lastReadAt)});break;case"latestUploadedChapter":t.sort((l,n)=>{var r,i;return L((r=l.latestUploadedChapter)==null?void 0:r.uploadDate,(i=n.latestUploadedChapter)==null?void 0:i.uploadDate)});break;case"latestFetchedChapter":t.sort((l,n)=>{var r,i;return L((r=l.latestFetchedChapter)==null?void 0:r.fetchedAt,(i=n.latestFetchedChapter)==null?void 0:i.fetchedAt)});break;case"totalChapters":t.sort((l,n)=>L(l.chapters.totalCount,n.chapters.totalCount));break}return o&&t.reverse(),t},At={id:-1},Ft=(e,s)=>{const[o]=P(z.QUERY,ue),t=be(s!=null?s:At),{hasUnreadChapters:l,hasReadChapters:n,hasDownloadedChapters:r,hasBookmarkedChapters:i,hasTrackerBinding:m,hasDuplicateChapters:S,hasStatus:A}=t,{settings:x}=G(),g=b.useMemo(()=>Tt(e,o,{...t,ignoreFilters:x.ignoreFilters}),[e,o,l,n,r,i,m,S,A,x.ignoreFilters]),h=b.useMemo(()=>Mt(g,t.sortBy,t.sortDesc),[g,t.sortBy,t.sortDesc]),y=Object.values(t.hasTrackerBinding).some(u=>u!=null),p=(l!=null||n!=null||r!=null||i!=null||!!o||y)&&g.length===0&&e.length>0;return{visibleMangas:h,showFilteredOutMessage:p,filterKey:"".concat(JSON.stringify(t)).concat(x.ignoreFilters)}},he=Oe("span")({display:"flex",alignItems:"center"}),pe=({sx:e,...s})=>a.jsx(nt,{...s,size:"small",sx:{...e,marginLeft:"5px"}});function Ba(){var te,ae,se,re,oe,le;const{t:e}=I(),{settings:{showTabSize:s}}=G(),{data:o,error:t,loading:l,refetch:n}=D.useGetCategories(Be,{notifyOnNetworkStatusChange:!0}),r=o==null?void 0:o.categories.nodes.filter(c=>c.id!==0||c.id===0&&c.mangas.totalCount),i=r!=null?r:[],m=D.useGetMangas(Le,{}),S=(ae=(te=m.data)==null?void 0:te.mangas.totalCount)!=null?ae:0,[A,x]=P(z.TAB,Ge),[g]=P(z.QUERY,ue),h=(se=i.find(c=>c.id===A))!=null?se:i[0],{data:y,error:p,loading:u,refetch:d}=D.useGetCategoryMangas(h==null?void 0:h.id,{skip:!h,notifyOnNetworkStatusChange:!0}),j=(re=y==null?void 0:y.mangas.nodes)!=null?re:[],{visibleMangas:f,showFilteredOutMessage:V,filterKey:K}=Ft(j,h),J=b.useCallback(()=>d().catch(O()),[d,h]),fe=b.useMemo(()=>f.map(c=>c.id),[f]),[k,v]=b.useState(!1),{areNoItemsForKeySelected:Q,areAllItemsForKeySelected:$,selectedItemIds:F,handleSelectAll:N,handleSelection:H,clearSelection:xe}=tt(f.length,{itemIds:fe,currentKey:h==null?void 0:h.id.toString()}),X=b.useCallback((c,C,Se)=>{v(!!(F.length+(C?1:-1))),H(c,C,Se)},[v,H]),Z=b.useMemo(()=>F.map(c=>Qe.getFromCache(c,Ie,"MANGA_CHAPTER_STAT_FIELDS")).filter(c=>!!c),[F.length,f]),q=b.useMemo(()=>k?a.jsx(Ve,{selectedItemsCount:F.length,title:"manga.title",children:(c,C)=>a.jsx(Xe,{selectedMangas:Z,onClose:()=>{c(),v(!1),xe()},setHideMenu:C})}):null,[k,Z]),ee=b.useMemo(()=>!!g&&a.jsx(ve,{sx:{p:2},children:a.jsx(we,{size:"large",component:Ee,to:Re.sources.childRoutes.searchAll.path(g),sx:{textTransform:"none",width:"100%"},children:e("library.action.label.search_globally",{query:g})})}),[g]);ot(a.jsxs(he,{children:[e("library.title"),s&&a.jsx(pe,{sx:{color:"inherit"},label:S})]}),e("library.title"),[e,s,S]),lt(a.jsxs(a.Fragment,{children:[!k&&h&&a.jsxs(a.Fragment,{children:[a.jsx(Ze,{}),a.jsx(Ct,{category:h}),a.jsx(et,{categoryId:h==null?void 0:h.id})]}),!!f.length&&a.jsx(xt,{isActive:k,areAllItemsSelected:$,areNoItemsSelected:Q,onSelectAll:c=>N(c,[...new Set(f.map(C=>C.id))]),onModeChange:c=>{v(c),c?N(!0,[...new Set(f.map(C=>C.id))]):i.forEach(C=>N(!1,[],C.id.toString()))}})]}),[k,Q,$,h,f.length]);const ye=c=>{x(c)};return t!=null||m.error?a.jsx(ce,{message:e("global.error.label.failed_to_load_data"),messageExtra:(le=t==null?void 0:t.message)!=null?le:(oe=m.error)==null?void 0:oe.message,retry:()=>{t&&n().catch(O()),m.error&&m.refetch().catch(O())}}):l||m.loading?a.jsx(De,{}):i.length===0?a.jsx(ce,{message:e("library.error.label.empty")}):i.length===1?a.jsxs(a.Fragment,{children:[ee,a.jsx(de,{mangas:f,message:e(p?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:p==null?void 0:p.message,isLoading:u,selectedMangaIds:F,isSelectModeActive:k,handleSelection:X,showFilteredOutMessage:!p&&V,retry:p&&J},K),q]}):a.jsxs(rt,{children:[a.jsx(st,{value:h.id,onChange:(c,C)=>ye(C),children:i.map(c=>a.jsx(Ne,{sx:{flexGrow:1,maxWidth:"unset"},label:a.jsxs(he,{children:[c.name,s?a.jsx(pe,{label:c.mangas.totalCount}):null]}),value:c.id},c.id))}),ee,i.map(c=>a.jsx(Ue,{index:c.order,currentIndex:h.order,children:c===h&&a.jsx(de,{mangas:f,message:e(p?"manga.error.label.request_failure":"category.error.label.empty"),messageExtra:p==null?void 0:p.message,isLoading:u,selectedMangaIds:F,isSelectModeActive:k,handleSelection:X,showFilteredOutMessage:!p&&V,retry:p&&J},K)},c.order)),q]})}export{Ba as Library};
