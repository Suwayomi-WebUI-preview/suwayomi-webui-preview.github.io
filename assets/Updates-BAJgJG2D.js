import{u as O,av as $,c as n,N as q,a as m,j as e,h as z,T as Q,bn as V,g as J,L as S,B as v,D as W,f as k,I as _,J as K,bo as X,m as E}from"./index-hGrGI_de.js";import{d as Y}from"./Download-PexyEcY-.js";import{d as Z}from"./Refresh-YymEaZ0l.js";import{E as I}from"./EmptyViewAbsoluteCentered-CeUeOoxL.js";import{D as ee}from"./DownloadStateIndicator-C7LBlmE6.js";import{U as te}from"./UpdateChecker-B-OOoej1.js";import{S as ae,a as oe,b as re}from"./StyledGroupItemWrapper-B3f6zOLL.js";import{M as se}from"./Mangas-1BSWhB_Q.js";import{S as ne}from"./SpinnerImage-BDp9shPt.js";import{T as L}from"./TypographyMaxLines-DH1Q6jH2.js";import{C as ie}from"./Card-MgQywnP9.js";import{C as le}from"./CardActionArea-BiLI2PLu.js";import{C as de}from"./CardContent-0oshIiMj.js";import{A as ce}from"./Avatar-Cf0uFFSV.js";import"./Progress-C6MA5_2N.js";import"./index-DHFHNtf5.js";import"./Chapters-DETV8P-0.js";const pe=o=>{if(!o.length)return[];const l=new Map;return o.forEach(u=>{var r;const d=K(X(Number(u.fetchedAt)));l.set(d,((r=l.get(d))!=null?r:0)+1)}),[...l.entries()]},Ie=()=>{var w,T;const{t:o}=O(),l=$(),{setTitle:u,setAction:d}=n.useContext(q),{data:r,loading:j,error:b,fetchMore:M,refetch:P}=m.useGetRecentlyUpdatedChapters(void 0,{fetchPolicy:"cache-and-network",notifyOnNetworkStatusChange:!0}),C=!!(r!=null&&r.chapters.pageInfo.hasNextPage),R=r==null?void 0:r.chapters.pageInfo.endCursor,c=(w=r==null?void 0:r.chapters.nodes)!=null?w:[],h=n.useMemo(()=>pe(c),[c]),D=n.useMemo(()=>h.map(t=>t[1]),[h]),{data:g}=m.useGetDownloadStatus(),G=(T=g==null?void 0:g.downloadStatus.queue)!=null?T:[],f=n.useRef(null),[A,B]=n.useState(0);n.useLayoutEffect(()=>{var t,a;B((a=(t=f.current)==null?void 0:t.clientHeight)!=null?a:0)},[f.current]);const{data:x}=m.useGetLastGlobalUpdateTimestamp({fetchPolicy:"cache-only"}),y=x==null?void 0:x.lastUpdateTimestamp.timestamp;n.useLayoutEffect(()=>(u(o("updates.title")),d(e.jsx(te,{})),()=>{u(""),d(null)}),[o,y]);const F=t=>{const{sourceOrder:a,mangaId:p}=t;return G.find(s=>a===s.chapter.sourceOrder&&p===s.manga.id)},H=async t=>{try{await m.addChapterToDownloadQueue(t.id).response}catch(a){E(o("download.queue.error.label.failed_to_remove"),"error")}},N=t=>{m.addChapterToDownloadQueue(t.id).response.catch(()=>E(o("global.error.label.failed_to_save_changes"),"error"))},U=n.useCallback(()=>{C&&M({variables:{offset:c.length}})},[C,R]);return b?e.jsx(I,{message:o("global.error.label.failed_to_load_data"),messageExtra:b.message,retry:()=>P().catch(z())}):!j&&c.length===0?e.jsx(I,{message:o("updates.error.label.no_updates_available")}):e.jsxs(e.Fragment,{children:[e.jsx(Q,{ref:f,sx:{marginLeft:"10px",paddingTop:t=>({[t.breakpoints.up("sm")]:{paddingTop:"6px"}})},children:o("library.settings.global_update.label.last_update",{date:y?V.format(+y):"-"})}),e.jsx(ae,{heightToSubtract:A,style:{height:"undefined"},components:{Footer:()=>j?e.jsx(J,{usePadding:!0}):null},overscan:window.innerHeight*.5,endReached:U,groupCounts:D,groupContent:t=>e.jsx(oe,{variant:"h5",component:"h2",isFirstItem:t===0,children:h[t][0]}),itemContent:t=>{const a=c[t],{manga:p}=a,s=F(a);return e.jsx(re,{children:e.jsx(ie,{children:e.jsx(le,{component:S,to:"/manga/".concat(a.manga.id,"/chapter/").concat(a.sourceOrder),state:l.state,sx:{color:i=>i.palette.text[a.isRead?"disabled":"primary"]},children:e.jsxs(de,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:1.5},children:[e.jsxs(v,{sx:{display:"flex"},children:[e.jsx(S,{to:"/manga/".concat(a.manga.id),style:{textDecoration:"none"},children:e.jsx(ce,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",marginRight:1,background:"transparent"},children:e.jsx(ne,{imgStyle:{objectFit:"cover",width:"100%",height:"100%",imageRendering:"pixelated"},spinnerStyle:{small:!0},alt:p.title,src:se.getThumbnailUrl(p)})})}),e.jsxs(v,{sx:{display:"flex",flexDirection:"column",justifyContent:"center",flexGrow:1,flexShrink:1,wordBreak:"break-word"},children:[e.jsx(L,{variant:"h6",component:"h3",children:p.title}),e.jsx(L,{variant:"caption",display:"block",lines:1,children:a.name})]})]}),s&&e.jsx(ee,{download:s}),(s==null?void 0:s.state)===W.Error&&e.jsx(k,{title:o("global.button.retry"),children:e.jsx(_,{onClick:i=>{i.preventDefault(),i.stopPropagation(),H(s.chapter)},size:"large",children:e.jsx(Z,{})})}),s==null&&!a.isDownloaded&&e.jsx(k,{title:o("chapter.action.download.add.label.action"),children:e.jsx(_,{onClick:i=>{i.stopPropagation(),i.preventDefault(),N(a)},size:"large",children:e.jsx(Y,{})})})]})})})},t)}})]})};export{Ie as Updates};
