import{F as ae,d as C,H as xe,J as Se,K as ye,h as D,u as B,r as O,N as je,b as E,j as s,O as ke,P as Te,Q as I,R as M,p as Me,m as se,g as re,C as ce,I as _e,U,V as Ae,W as Fe,X as ve,Y as Be,Z as we,f as Ie}from"./index-CBxbdOZa.js";import{u as de,S as Le,A as Re,N as De}from"./AppbarSearch-DDqDFRU_.js";import{E as oe}from"./EmptyViewAbsoluteCentered-DCgg8ff9.js";import{T as Oe,a as Ee}from"./Tabs-Dh2MNhFT.js";import{F as Ge}from"./FilterList-DX5t4YRj.js";import{C as L}from"./CheckboxInput-0NO2rdo0.js";import{S as Ne,R as N}from"./SortRadioInput-C0KOM6aU.js";import{T as k}from"./ThreeStateCheckboxInput-wiEnqza-.js";import{O as Ue,S as Pe,a as ze}from"./SelectionFAB-DSp0grfC.js";import{T as We}from"./Trackers-D4pSmk7a.js";import{F}from"./TextField-DuGJKvvj.js";import{R as Ye}from"./ListPreference-CfCfOuBQ.js";import{M as Ve,a as Ke}from"./MangaGrid-BdnTyJHa.js";import{C as Je,U as He}from"./UpdateChecker-_q13jvf7.js";import{u as Qe}from"./useManageMangaLibraryState-DEU-P4Qb.js";import{C as Xe}from"./Checkbox-D5Y8DhmM.js";import{T as Ze}from"./TabsMenu-vbORML4f.js";import{T as $e}from"./TabsWrapper-GgZTmZfl.js";import{u as qe}from"./useAppTitle-BmkqDPsV.js";import{u as et}from"./useAppAction-mbKoUHfz.js";import{C as tt}from"./Chip-BeTPtnoR.js";import"./ChaptersDownloadActionMenuItems-BVTXZK2z.js";import"./Card-BbGJVXOW.js";import"./ListCardContent-DPbnp6xG.js";import"./Avatar-CczBYppx.js";import"./InputAdornment-PGzZQUDk.js";import"./useFormControl-EdH_WGd-.js";import"./CheckCircle-BNV6sksU.js";import"./MUI.util-Bs9Vl2GD.js";import"./CardActionArea-Dl3PGSnS.js";import"./Link-CO7UWlYn.js";import"./NumberSetting-CFmaU-S2.js";import"./Slider-yvhelXje.js";import"./useMobilePicker-Dq_KXUip.js";import"./SelectSetting-BMUn1mO-.js";import"./Select-DcTUCpv6.js";import"./FormGroup-BzOyOVHv.js";import"./formControlState-Dq1zat_P.js";import"./StyledFab-tc657Z86.js";import"./SwitchBase-Bt1MmkrC.js";import"./Delete-CPYpmXa7.js";import"./Download-Dvr2tlzK.js";import"./Sync-QsScqzp8.js";import"./use-merged-ref-BIpNM0cx.js";import"./ListCardAvatar-Olf2Zaaj.js";import"./PlayArrow-Bu-WWWUu.js";import"./Progress-D2irP_JT.js";const at={sortDesc:void 0,sortBy:void 0,hasDownloadedChapters:void 0,hasBookmarkedChapters:void 0,hasUnreadChapters:void 0,hasReadChapters:void 0,hasDuplicateChapters:void 0,hasTrackerBinding:{},hasStatus:{}},he=e=>({...e,hasTrackerBinding:e.hasTrackerBinding?JSON.stringify(e.hasTrackerBinding):void 0,hasStatus:e.hasStatus?JSON.stringify(e.hasStatus):void 0}),st=e=>{var a,r;return{...e,hasTrackerBinding:(a=ae(e.hasTrackerBinding))!=null?a:void 0,hasStatus:(r=ae(e.hasStatus))!=null?r:void 0}},rt=(e,a=at,r)=>st(Se("category",e,he(a),void 0,r)),pe=(e,a,r)=>rt({...e,meta:xe(e.meta)},a,r),ot=(e,a)=>pe(e,a),ge=(e,a)=>{const r=pe(e,a,C.useEffect);return C.useMemo(()=>r,[e,a])},lt=async(e,a,r)=>ye(e,[[a,he({[a]:r})[a]]]),nt=(e,a=D())=>(r,t)=>lt(e,r,t).catch(a),it={filter:"global.label.filter",sort:"global.label.sort",display:"global.label.display"},ct=[["unreadChapters","library.option.sort.label.by_unread_chapters"],["totalChapters","library.option.sort.label.by_total_chapters"],["alphabetically","library.option.sort.label.alphabetically"],["dateAdded","library.option.sort.label.by_date_added"],["lastRead","library.option.sort.label.by_last_read"],["latestFetchedChapter","library.option.sort.label.by_latest_fetched_chapter"],["latestUploadedChapter","library.option.sort.label.by_latest_uploaded_chapter"]],dt=({category:e,open:a,onClose:r})=>{var p,y;const{t}=B(),l=O.useGetTrackerList(je),n=We.getLoggedIn((y=(p=l.data)==null?void 0:p.trackers.nodes)!=null?y:[]),o=ge(e),i=nt(e,g=>se(t("global.error.label.failed_to_save_changes"),"error",re(g))),{settings:{showTabSize:b,showContinueReadingButton:f,showDownloadBadge:_,showUnreadBadge:x,gridLayout:d}}=E(),S=Me(g=>se(t("search.error.label.failed_to_save_settings"),"error",re(g)));return s.jsx(Ue,{open:a,onClose:r,tabs:["filter","sort","display"],tabTitle:g=>t(it[g]),tabContent:g=>g==="filter"?s.jsxs(s.Fragment,{children:[s.jsx(k,{label:t("global.filter.label.unread"),checked:o.hasUnreadChapters,onChange:h=>i("hasUnreadChapters",h)}),s.jsx(k,{label:t("global.filter.label.started"),checked:o.hasReadChapters,onChange:h=>i("hasReadChapters",h)}),s.jsx(k,{label:t("global.filter.label.downloaded"),checked:o.hasDownloadedChapters,onChange:h=>i("hasDownloadedChapters",h)}),s.jsx(k,{label:t("global.filter.label.bookmarked"),checked:o.hasBookmarkedChapters,onChange:h=>i("hasBookmarkedChapters",h)}),s.jsx(k,{label:t("global.filter.label.duplicate_chapters"),checked:o.hasDuplicateChapters,onChange:h=>i("hasDuplicateChapters",h)}),s.jsx(F,{sx:{mt:2},children:t("manga.label.status")}),Object.values(ke).map(h=>s.jsx(k,{label:t(Te[h]),checked:o.hasStatus[h],onChange:u=>i("hasStatus",{...o.hasStatus,[h]:u})},h)),s.jsx(F,{sx:{mt:2},children:t("global.filter.label.tracked")}),n.map(h=>s.jsx(k,{label:h.name,checked:o.hasTrackerBinding[h.id],onChange:u=>i("hasTrackerBinding",{...o.hasTrackerBinding,[h.id]:u})},h.id))]}):g==="sort"?ct.map(([h,u])=>s.jsx(Ne,{label:t(u),checked:o.sortBy===h,sortDescending:o.sortDesc,onClick:()=>h!==o.sortBy?i("sortBy",h):i("sortDesc",!o.sortDesc)},h)):g==="display"?s.jsxs(s.Fragment,{children:[s.jsx(F,{children:t("global.grid_layout.title")}),s.jsxs(Ye,{onChange:h=>I("gridLayout",Number(h.target.value)),value:d,children:[s.jsx(N,{label:t("global.grid_layout.label.compact_grid"),value:M.Compact,checked:d==null||d===M.Compact}),s.jsx(N,{label:t("global.grid_layout.label.comfortable_grid"),value:M.Comfortable,checked:d===M.Comfortable}),s.jsx(N,{label:t("global.grid_layout.label.list"),value:M.List,checked:d===M.List})]}),s.jsx(F,{sx:{mt:2},children:t("library.option.display.badge.title")}),s.jsx(L,{label:t("library.option.display.badge.label.unread_badges"),checked:x,onChange:()=>I("showUnreadBadge",!x)}),s.jsx(L,{label:t("library.option.display.badge.label.download_badges"),checked:_,onChange:()=>I("showDownloadBadge",!_)}),s.jsx(F,{sx:{mt:2},children:t("library.option.display.tab.title")}),s.jsx(L,{label:t("library.option.display.tab.label.show_number_of_items"),checked:b,onChange:()=>S("showTabSize",!b)}),s.jsx(F,{sx:{mt:2},children:t("global.label.other")}),s.jsx(L,{label:t("library.option.display.other.label.show_continue_reading_button"),checked:f,onChange:()=>I("showContinueReadingButton",!f)})]}):null})},ht=({category:e})=>{const{t:a}=B(),[r,t]=C.useState(!1),l=ot(e),n=l.hasDownloadedChapters!=null||l.hasUnreadChapters!=null||l.hasReadChapters!=null||l.hasBookmarkedChapters!=null||l.hasDuplicateChapters!=null||Object.values(l.hasStatus).some(o=>o!=null)||Object.values(l.hasTrackerBinding).some(o=>o!=null);return s.jsxs(s.Fragment,{children:[s.jsx(ce,{title:a("settings.title"),children:s.jsx(_e,{onClick:()=>t(!r),color:n?"warning":"inherit",children:s.jsx(Ge,{})})}),s.jsx(dt,{category:e,open:r,onClose:()=>t(!1)})]})},pt=()=>{},le=({showFilteredOutMessage:e,message:a,messageExtra:r,...t})=>{const{t:l}=B(),{settings:{gridLayout:n}}=E();return C.useLayoutEffect(()=>(document.body.style.overflowY=n===M.List?"auto":"scroll",()=>{document.body.style.overflowY="auto"}),[]),s.jsx(Ve,{gridWrapperProps:{sx:{p:1}},...t,hasNextPage:!1,loadMore:pt,message:e?l("library.error.label.no_matches"):a,messageExtra:e?void 0:r,gridLayout:n})},gt=({isActive:e,areAllItemsSelected:a,areNoItemsSelected:r,onSelectAll:t,onModeChange:l})=>{const{t:n}=B();return s.jsxs(s.Fragment,{children:[e&&s.jsx(Pe,{areAllItemsSelected:a,areNoItemsSelected:r,onChange:t}),s.jsx(ce,{title:n(e?"global.button.cancel":"global.button.select_all"),children:s.jsx(Xe,{checkedIcon:s.jsx(Je,{}),sx:{padding:"8px",color:"inherit","&.Mui-checked":{color:"inherit"}},checked:e,onChange:(o,i)=>l(i)})})]})},P=(e,a,r)=>{switch(e){case!0:return a();case!1:return r();default:return!0}},R=(e,a)=>P(e,()=>!!a&&a>=1,()=>a===0),ue=(e,a)=>P(e,()=>!!a,()=>!a),T=(e,a)=>{const r=e==null?void 0:e.filter(o=>o!=null),t=a==null?void 0:a.filter(o=>o!=null);if(!(r!=null&&r.length))return!0;const l=r.map(U),n=t.map(U).join(", ");return l.every(o=>n.includes(o))},ut=(e,{title:a,genre:r,description:t,artist:l,author:n,source:o,sourceId:i})=>T([e],[a])||T(e==null?void 0:e.split(","),r.map(b=>U(b)))||T([e],[t])||T([e],[l])||T([e],[n])||T([e],[o==null?void 0:o.displayName])||T([e],[i]),bt=(e,a)=>Object.entries(e).map(([r,t])=>{const l=a.trackRecords.nodes.some(n=>n.trackerId===Number(r));return P(t,()=>l,()=>!l)}).every(Boolean),mt=(e,a)=>Object.entries(e).map(([r,t])=>ue(t,r===a.status)).every(Boolean),Ct=(e,{hasDownloadedChapters:a,hasUnreadChapters:r,hasReadChapters:t,hasBookmarkedChapters:l,hasDuplicateChapters:n,hasTrackerBinding:o,hasStatus:i})=>R(a,e.downloadCount)&&R(r,e.unreadCount)&&R(t,e.chapters.totalCount-e.unreadCount)&&R(l,e.bookmarkCount)&&ue(n,e.hasDuplicateChapters)&&bt(o,e)&&mt(i,e),ft=(e,a,r)=>{const t=r.ignoreFilters&&(a==null?void 0:a.length);return e.filter(l=>{const n=ut(a,l),o=t||Ct(l,r);return n&&o})},v=(e=0,a=0)=>Number(e)-Number(a),xt=(e,a)=>e.localeCompare(a),St=(e,a,r)=>{const t=[...e];switch(a){case"alphabetically":t.sort((l,n)=>xt(l.title,n.title));break;case"dateAdded":t.sort((l,n)=>v(l.inLibraryAt,n.inLibraryAt));break;case"unreadChapters":t.sort((l,n)=>v(l.unreadCount,n.unreadCount));break;case"lastRead":t.sort((l,n)=>{var o,i;return v((o=l.lastReadChapter)==null?void 0:o.lastReadAt,(i=n.lastReadChapter)==null?void 0:i.lastReadAt)});break;case"latestUploadedChapter":t.sort((l,n)=>{var o,i;return v((o=l.latestUploadedChapter)==null?void 0:o.uploadDate,(i=n.latestUploadedChapter)==null?void 0:i.uploadDate)});break;case"latestFetchedChapter":t.sort((l,n)=>{var o,i;return v((o=l.latestFetchedChapter)==null?void 0:o.fetchedAt,(i=n.latestFetchedChapter)==null?void 0:i.fetchedAt)});break;case"totalChapters":t.sort((l,n)=>v(l.chapters.totalCount,n.chapters.totalCount));break}return r&&t.reverse(),t},yt={id:-1},jt=(e,a)=>{const[r]=de("query",Le),t=ge(a!=null?a:yt),{hasUnreadChapters:l,hasReadChapters:n,hasDownloadedChapters:o,hasBookmarkedChapters:i,hasTrackerBinding:b,hasDuplicateChapters:f,hasStatus:_}=t,{settings:x}=E(),d=C.useMemo(()=>ft(e,r,{...t,ignoreFilters:x.ignoreFilters}),[e,r,l,n,o,i,b,f,_,x.ignoreFilters]),S=C.useMemo(()=>St(d,t.sortBy,t.sortDesc),[d,t.sortBy,t.sortDesc]),p=Object.values(t.hasTrackerBinding).some(g=>g!=null),y=(l!=null||n!=null||o!=null||i!=null||!!r||p)&&d.length===0&&e.length>0;return{visibleMangas:S,showFilteredOutMessage:y}},ne=we("span")({display:"flex",alignItems:"center"}),ie=({sx:e,...a})=>s.jsx(tt,{...a,size:"small",sx:{...e,marginLeft:"5px"}});function ma(){var X,Z,$,q,ee,te;const{t:e}=B(),{settings:{showTabSize:a}}=E(),{data:r,error:t,loading:l,refetch:n}=O.useGetCategories(Ae,{notifyOnNetworkStatusChange:!0}),o=r==null?void 0:r.categories.nodes.filter(c=>c.id!==0||c.id===0&&c.mangas.totalCount),i=o!=null?o:[],b=O.useGetMangas(Fe,{}),f=(Z=(X=b.data)==null?void 0:X.mangas.totalCount)!=null?Z:0,[_,x]=de("tab",De),d=($=i.find(c=>c.id===_))!=null?$:i[0],{data:S,error:p,loading:y,refetch:g}=O.useGetCategoryMangas(d==null?void 0:d.id,{skip:!d,notifyOnNetworkStatusChange:!0}),h=(q=S==null?void 0:S.mangas.nodes)!=null?q:[],{visibleMangas:u,showFilteredOutMessage:z}=jt(h,d),W=C.useCallback(()=>g().catch(D()),[g,d]),be=C.useMemo(()=>u.map(c=>c.id),[u]),[j,w]=C.useState(!1),{areNoItemsForKeySelected:Y,areAllItemsForKeySelected:V,selectedItemIds:A,handleSelectAll:G,handleSelection:K,clearSelection:me}=Qe(u.length,{itemIds:be,currentKey:d==null?void 0:d.id.toString()}),J=C.useCallback((c,m,fe)=>{w(!!(A.length+(m?1:-1))),K(c,m,fe)},[w,K]),H=C.useMemo(()=>A.map(c=>ve.getFromCache(c,Be,"MANGA_CHAPTER_STAT_FIELDS")).filter(c=>!!c),[A.length,u]),Q=C.useMemo(()=>j?s.jsx(ze,{selectedItemsCount:A.length,title:"manga.title",children:(c,m)=>s.jsx(Ke,{selectedMangas:H,onClose:()=>{c(),w(!1),me()},setHideMenu:m})}):null,[j,H]);qe(s.jsxs(ne,{children:[e("library.title"),a&&s.jsx(ie,{sx:{color:"inherit"},label:f})]}),e("library.title"),[e,a,f]),et(s.jsxs(s.Fragment,{children:[!j&&d&&s.jsxs(s.Fragment,{children:[s.jsx(Re,{}),s.jsx(ht,{category:d}),s.jsx(He,{categoryId:d==null?void 0:d.id})]}),s.jsx(gt,{isActive:j,areAllItemsSelected:V,areNoItemsSelected:Y,onSelectAll:c=>G(c,[...new Set(u.map(m=>m.id))]),onModeChange:c=>{w(c),c?G(!0,[...new Set(u.map(m=>m.id))]):i.forEach(m=>G(!1,[],m.id.toString()))}})]}),[j,Y,V,d]);const Ce=c=>{x(c)};return t!=null||b.error?s.jsx(oe,{message:e("global.error.label.failed_to_load_data"),messageExtra:(te=t==null?void 0:t.message)!=null?te:(ee=b.error)==null?void 0:ee.message,retry:()=>{t&&n().catch(D()),b.error&&b.refetch().catch(D())}}):l||b.loading?s.jsx(Ie,{}):i.length===0?s.jsx(oe,{message:e("library.error.label.empty")}):i.length===1?s.jsxs(s.Fragment,{children:[s.jsx(le,{mangas:u,message:e(p?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:p==null?void 0:p.message,isLoading:y,selectedMangaIds:A,isSelectModeActive:j,handleSelection:J,showFilteredOutMessage:!p&&z,retry:p&&W}),Q]}):s.jsxs($e,{children:[s.jsx(Ze,{value:d.id,onChange:(c,m)=>Ce(m),children:i.map(c=>s.jsx(Oe,{sx:{flexGrow:1,maxWidth:"unset"},label:s.jsxs(ne,{children:[c.name,a?s.jsx(ie,{label:c.mangas.totalCount}):null]}),value:c.id},c.id))}),i.map(c=>s.jsx(Ee,{index:c.order,currentIndex:d.order,children:c===d&&s.jsx(le,{mangas:u,message:e(p?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:p==null?void 0:p.message,isLoading:y,selectedMangaIds:A,isSelectModeActive:j,handleSelection:J,showFilteredOutMessage:!p&&z,retry:p&&W})},c.order)),Q]})}export{ma as Library};
