import{a4 as I,u as F,a as q,c as n,j as t,L as O,T as v,aI as Q,h as D,N as V,ay as W,d as _,g as z,E as J,B as A}from"./index-CKBxMd_h.js";import{u as K,A as U,S as X}from"./AppbarSearch-_0aDxcBv.js";import{s as P,l as Y,a as Z}from"./language-Dd9fpF5a.js";import{t as ee,L as te}from"./LangSelect-OTCsGC9c.js";import{u as T}from"./useDebounce-D1FpcHTB.js";import{B as se}from"./BaseMangaGrid-F9ux3pf9.js";import{C as re}from"./Card-Cr9utwej.js";import{C as oe}from"./CardActionArea-BHBGCn9v.js";import"./useManageMangaLibraryState-Buii7VAm.js";import"./Trackers-D4pSmk7a.js";import"./CardContent-D5B4KoK-.js";import"./Avatar-COfGnEWj.js";import"./Info-2xKqwcLI.js";import"./TextField-DKEWl0kG.js";import"./InputAdornment-0ZrWWhgd.js";import"./CheckCircle-C3BmOyh0.js";import"./SpinnerImage-0JZOfick.js";import"./TypographyMaxLines-CUvaPvl8.js";import"./Collapse-C7pJTB29.js";import"./Link-Md8SMvlM.js";import"./ListPreference-CM7aD9qg.js";import"./Checkbox-ahfba6_6.js";import"./SwitchBase-CSUbfhgD.js";import"./NumberSetting-Cyy9C5Bb.js";import"./useMobilePicker-D8SH1tv9.js";import"./Chip-0iDzqWXn.js";import"./SelectSetting-r_f7SmmX.js";import"./Select-CummqEgG.js";import"./CheckboxInput-OYYQUZ2R.js";import"./Mangas-Df_Z9EgA.js";import"./Chapters-C94eQhhe.js";import"./ThreeStateCheckboxInput-BsazusKT.js";import"./FilterList-B4MB-hNh.js";import"./cloneObject-DrOPTG0J.js";import"./Switch-QjdxAlZw.js";import"./MangaGrid-C-JrYcku.js";import"./index-DFMF3h4b.js";import"./Delete-CgmxhIrM.js";import"./Sync-Cq_IfjXs.js";import"./PlayArrow-DYZR5rOS.js";import"./StyledFab-gJcKMs5T.js";function ae(s){const r=[];return s.forEach(e=>{r.indexOf(e.lang)===-1&&r.push(e.lang)}),r.sort(Y),r}const ne=(s,r)=>s.displayName<r.displayName?-1:s.displayName>r.displayName?1:0,ie=(s,r,e)=>{var l,x,a,p;const g=!((l=e.get(s.id))!=null&&l.isLoading),i=!((x=e.get(r.id))!=null&&x.isLoading);if(g&&!i)return-1;if(!g&&i)return 1;if(!g&&!i)return 0;const m=!((a=e.get(s.id))!=null&&a.hasResults),u=!((p=e.get(r.id))!=null&&p.hasResults);return m&&!u?1:u&&!m?-1:0},ce=1e3,me=I.memo(({source:s,onSearchRequestFinished:r,searchString:e,emptyQuery:g,mode:i})=>{var L,E;const{t:m}=F(),{id:u,displayName:l,lang:x}=s,[a,p]=q.useSourceSearch(u,e!=null?e:"",void 0,1,{skipRequest:!e,addAbortSignal:!0}),{data:S,isLoading:c,error:y,abortRequest:w}=p[0],j=(E=(L=S==null?void 0:S.fetchSourceManga)==null?void 0:L.mangas)!=null?E:[],d=!c&&!j.length;n.useEffect(()=>{r(s,c,!d,!e)},[c,d,e]);let f;return y?f=m("search.error.label.source_search_failed"):d&&(f=m("manga.error.label.no_mangas_found")),n.useEffect(()=>()=>{w(new Error("SourceSearchPreview(".concat(u,", ").concat(l,"): search string changed")))},[e]),!c&&!e||g?null:t.jsxs(t.Fragment,{children:[t.jsx(re,{sx:{mb:1},children:t.jsxs(oe,{component:O,to:"/sources/".concat(u,"?query=").concat(e),sx:{p:3},children:[t.jsx(v,{variant:"h5",children:l}),t.jsx(v,{variant:"caption",children:ee(x)})]})}),f?t.jsx(Q,{sx:{alignItems:"start",height:void 0},noFaces:!0,message:f,messageExtra:y&&y.message,retry:y?()=>a(1).catch(D("SourceSearchPreview(".concat(s.id,")::refetch"))):void 0}):t.jsx(se,{gridWrapperProps:{sx:{px:0}},mangas:j,isLoading:c,hasNextPage:!1,loadMore:()=>{},horizontal:!0,noFaces:!0,message:f,inLibraryIndicator:!0,mode:i})]})}),Xe=()=>{var C;const{t:s}=F(),{setTitle:r,setAction:e}=n.useContext(V),{pathname:g,state:i}=W(),m=g.startsWith("/migrate/source"),u=i==null?void 0:i.mangaTitle,[l]=K("query",X),x=T(l,ce),[a,p]=_("shownSourceLangs",Z()),[S]=_("showNsfw",!0),{data:c,loading:y,error:w,refetch:j}=q.useGetSourceList({notifyOnNetworkStatusChange:!0}),d=(C=c==null?void 0:c.sources.nodes)!=null?C:[],[f,L]=n.useState(new Map),E=T(f,500),b=n.useMemo(()=>[...d].sort(ne),[d]),N=n.useMemo(()=>b.filter(o=>a.includes(o.lang)),[b,a]),M=n.useMemo(()=>N.filter(o=>S||!o.isNsfw),[N,S]),R=n.useMemo(()=>[...M].sort((o,h)=>ie(o,h,E)),[M,E]),$=n.useCallback(({id:o},h,k,G)=>{L(H=>{const B=new Map(H);return B.set(o,{isLoading:h,hasResults:k,emptySearch:G}),B})},[L]);return n.useLayoutEffect(()=>(r(s(m?"migrate.search.title":"search.title.global_search",{title:u})),e(t.jsxs(t.Fragment,{children:[t.jsx(U,{isClosable:!1}),t.jsx(te,{shownLangs:a,setShownLangs:p,allLangs:ae(d),forcedLangs:P()})]})),()=>{r(""),e(null)}),[s,a,p,d]),n.useEffect(()=>{const o=P().filter(h=>!a.includes(h));p([...a,...o])},[]),y?t.jsx(z,{}):w?t.jsx(J,{message:s("global.error.label.failed_to_load_data"),messageExtra:w.message,retry:()=>j().catch(D())}):t.jsx(A,{sx:{p:1},children:R.map((o,h)=>t.jsx(A,{sx:{pb:h+1!==R.length?2:0},children:t.jsx(me,{source:o,onSearchRequestFinished:$,searchString:x,emptyQuery:!l,mode:m?"migrate.select":"source"})},o.id))})};export{Xe as SearchAll};
