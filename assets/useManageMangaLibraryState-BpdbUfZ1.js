var J=Object.freeze,re=Object.defineProperty;var Q=(e,t)=>J(re(e,"raw",{value:J(t||e.slice())}));import{e as s,c as O,j as l,aq as se,ar as le,as as ce,ac as ie,a6 as ue,u as ee,r as z,dZ as te,l as de,n as ge,o as fe,aG as he,S as U,B as q,A as oe,L as me,d_ as be,Q as pe,m as A,g as D,X as G,i as B,f as ve,ba as H,d$ as ye,e0 as Ce}from"./index-Cfd-5nyg.js";import{T as Se}from"./ThreeStateCheckboxInput-SRKZKj89.js";import{C as xe}from"./CheckboxInput-c5h5Hxvq.js";import{F as Me}from"./FormGroup-DkqWHukv.js";var R=(e=>(e.Mouse="mouse",e.Touch="touch",e.Pointer="pointer",e))(R||{}),F=(e=>(e.CancelledByMovement="cancelled-by-movement",e.CancelledByRelease="cancelled-by-release",e.CancelledOutsideElement="cancelled-outside-element",e))(F||{});const Te=["mousedown","mousemove","mouseup","mouseleave","mouseout"],Ie=["touchstart","touchmove","touchend","touchcancel"],we=["pointerdown","pointermove","pointerup","pointerleave","pointerout"];function Le(e){return typeof e=="object"&&e!==null&&"pageX"in e&&typeof e.pageX=="number"&&"pageY"in e&&typeof e.pageY=="number"}function Ee(e){var t;return Te.includes((t=e==null?void 0:e.nativeEvent)==null?void 0:t.type)}function ae(e){var t;return Ie.includes((t=e==null?void 0:e.nativeEvent)==null?void 0:t.type)||"touches"in e}function _e(e){const{nativeEvent:t}=e;return t?we.includes(t==null?void 0:t.type)||"pointerId"in t:!1}function N(e){return Ee(e)||ae(e)||_e(e)}function W(e){var t;const o=ae(e)?(t=e==null?void 0:e.touches)==null?void 0:t[0]:e;return Le(o)?{x:o.pageX,y:o.pageY}:null}function ke(e){return{target:e.target,currentTarget:e.currentTarget,nativeEvent:e,persist:()=>{}}}function qe(e,{threshold:t=400,captureEvent:o=!1,detect:c=R.Pointer,cancelOnMovement:i=!1,cancelOutsideElement:f=!0,filterEvents:u,onStart:p,onMove:M,onFinish:I,onCancel:w}={}){const h=s.useRef(!1),y=s.useRef(!1),C=s.useRef(),d=s.useRef(),S=s.useRef(e),m=s.useRef(null),b=s.useCallback(n=>r=>{y.current||N(r)&&(u!==void 0&&!u(r)||(o&&r.persist(),p==null||p(r,{context:n}),m.current=W(r),y.current=!0,C.current=r.currentTarget,d.current=setTimeout(()=>{S.current&&(S.current(r,{context:n}),h.current=!0)},t)))},[o,u,p,t]),v=s.useCallback(n=>(r,a)=>{N(r)&&y.current&&(m.current=null,o&&r.persist(),h.current?I==null||I(r,{context:n}):y.current&&(w==null||w(r,{context:n,reason:a!=null?a:F.CancelledByRelease})),h.current=!1,y.current=!1,d.current!==void 0&&clearTimeout(d.current))},[o,I,w]),x=s.useCallback(n=>r=>{if(N(r)&&(M==null||M(r,{context:n}),i!==!1&&m.current)){const a=W(r);if(a){const T=i===!0?25:i,_={x:Math.abs(a.x-m.current.x),y:Math.abs(a.y-m.current.y)};(_.x>T||_.y>T)&&v(n)(r,F.CancelledByMovement)}}},[v,i,M]),g=s.useCallback(n=>{if(e===null)return{};switch(c){case R.Mouse:{const r={onMouseDown:b(n),onMouseMove:x(n),onMouseUp:v(n)};return f&&(r.onMouseLeave=a=>{v(n)(a,F.CancelledOutsideElement)}),r}case R.Touch:return{onTouchStart:b(n),onTouchMove:x(n),onTouchEnd:v(n)};case R.Pointer:{const r={onPointerDown:b(n),onPointerMove:x(n),onPointerUp:v(n)};return f&&(r.onPointerLeave=a=>v(n)(a,F.CancelledOutsideElement)),r}}},[e,v,f,c,x,b]);return s.useEffect(()=>{function n(r){const a=ke(r);v()(a)}return window.addEventListener("mouseup",n),window.addEventListener("touchend",n),window.addEventListener("pointerup",n),()=>{window.removeEventListener("mouseup",n),window.removeEventListener("touchend",n),window.removeEventListener("pointerup",n)}},[v]),s.useEffect(()=>()=>{d.current!==void 0&&clearTimeout(d.current)},[]),s.useEffect(()=>{S.current=e},[e]),g}const He=O(l.jsx("path",{d:"M19 5v14H5V5zm0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2"})),Ne=O(l.jsx("path",{d:"m1.79 12 5.58 5.59L5.96 19 .37 13.41zm.45-7.78L12.9 14.89l-1.28 1.28L7.44 12l-1.41 1.41L11.62 19l2.69-2.69 4.89 4.89 1.41-1.41L3.65 2.81zm14.9 9.27L23.62 7 22.2 5.59l-6.48 6.48zM17.96 7l-1.41-1.41-3.65 3.66 1.41 1.41z"})),Ke=O(l.jsx("path",{d:"M9 16.2 4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4z"})),$e=O(l.jsx("path",{d:"M16.5 3c-1.74 0-3.41.81-4.5 2.09C10.91 3.81 9.24 3 7.5 3 4.42 3 2 5.42 2 8.5c0 3.78 3.4 6.86 8.55 11.54L12 21.35l1.45-1.32C18.6 15.36 22 12.28 22 8.5 22 5.42 19.58 3 16.5 3m-4.4 15.55-.1.1-.1-.1C7.14 14.24 4 11.39 4 8.5 4 6.5 5.5 5 7.5 5c1.54 0 3.04.99 3.57 2.36h1.87C13.46 5.99 14.96 5 16.5 5c2 0 3.5 1.5 3.5 3.5 0 2.89-3.14 5.74-7.9 10.05"})),Xe=({title:e,Icon:t,...o})=>l.jsxs(se,{...o,children:[l.jsx(le,{children:l.jsx(t,{fontSize:"small"})}),l.jsx(ce,{children:e})]}),Ye=(e,t)=>(o,c)=>{const i=c>0?" (".concat(c,")"):"";return"".concat(ie(t[o].action[e?"single":"selected"])).concat(i)},Ve=e=>(t=!1)=>e?t:!0,Je=e=>t=>e?!1:t,Qe=O(l.jsx("path",{d:"M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2m0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2m0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2"})),We=({children:e,onClose:t,...o})=>{const[c,i]=s.useState(!1);return l.jsx(ue,{...o,open:o.open,onClose:t,sx:{visibility:!o.open||c?"hidden":"visible"},children:e(()=>{t({},"backdropClick"),i(!1)},i)})},je=(e,{itemIds:t=[],keyCount:o=e,currentKey:c,initialState:i={}})=>{var x;const[f,u]=s.useState(i),p=s.useRef(void 0),M=[...new Set(Object.values(f).flat())],I=M.length===e,w=!M.length,h=(x=f[c])!=null?x:[],y=h.length===o,C=h.length===0;C&&(p.current=void 0);const d=s.useCallback((g,n,{selectRange:r=!1,key:a=c}={})=>{var Y;const T=!n,{id:_,key:L}=(Y=p.current)!=null?Y:{};p.current={id:g,key:a};const P=r&&a===L&&_!==void 0,K=P?t.indexOf(_):-1,$=P?t.indexOf(g):-1,X=P?t.slice(Math.min(K,$),Math.max(K,$)+1):[g];if(T){u(k=>{var j,V;return{...k,[a]:(V=(j=k[a])==null?void 0:j.filter(ne=>!X.includes(ne)))!=null?V:[]}});return}u(k=>{var j;return{...k,[a]:[...new Set([...(j=k[a])!=null?j:[],...X])]}})},[c,t]),S=s.useCallback((g,n,r=c)=>{switch(g){case!0:u(a=>({...a,[r]:[...n]}));break;case!1:u(a=>({...a,[r]:[]}));break}},[c]),m=s.useCallback((g,n)=>{u(r=>({...r,[g]:[...n]}))},[]),b=s.useCallback(g=>f[g],[f]),v=s.useCallback(()=>{u({})},[]);return{selectedItemIds:M,keySelectedItemIds:h,handleSelection:d,handleSelectAll:S,areAllItemsSelected:I,areNoItemsSelected:w,areAllItemsForKeySelected:y,areNoItemsForKeySelected:C,setSelectionForKey:m,getSelectionForKey:b,clearSelection:v}},Ae=0;class E{static getIds(t){return t.map(o=>o.id)}static getUserCreated(t){return t.filter(o=>o.id!==Ae)}static getDefaults(t){return t.filter(o=>o.default)}}const De=e=>{const{data:t}=z.useGetManga(be,e!=null?e:-1,{skip:e===void 0});return s.useMemo(()=>e===void 0||!t?[]:E.getIds(t.manga.categories.nodes),[t==null?void 0:t.manga.categories.nodes,e])},Re=(e,t,o,c)=>{if(t.includes(e))return!0;if(!c&&o.includes(e))return!1};function Fe(e){const{t}=ee(),{open:o,onClose:c,mangaId:i,mangaIds:f,addToLibrary:u=!1}=e,p=i!==void 0,M=f!=null?f:[i],[I,w]=s.useState(!1),h=De(i),{data:y}=z.useGetCategories(te),C=y==null?void 0:y.categories.nodes,d=s.useMemo(()=>E.getUserCreated(C!=null?C:[]),[C]),S=s.useMemo(()=>u?E.getIds(E.getDefaults(d)):[],[d]),{handleSelection:m,setSelectionForKey:b,getSelectionForKey:v}=je(d.length,{currentKey:"categoriesToAdd",initialState:{categoriesToAdd:[...h,...S],categoriesToRemove:[]}});s.useEffect(()=>{b("categoriesToAdd",[...h,...S]),b("categoriesToRemove",[])},[h]);const x=v("categoriesToAdd"),g=v("categoriesToRemove"),n=()=>{b("categoriesToAdd",h),b("categoriesToRemove",[]),c(!1)},r=()=>{const a=p?x.filter(L=>!h.includes(L)):x,T=p?h.filter(L=>!x.includes(L)):g;c(!0,a,T),I&&pe("showAddToLibraryCategorySelectDialog",!1).catch(L=>A(t("search.error.label.failed_to_save_settings"),"error",D(L))),(a.length||T.length)&&(u||G.performAction("change_categories",M,{changeCategoriesPatch:{addToCategories:a,removeFromCategories:T}}).catch(B()))};return l.jsxs(de,{sx:{".MuiDialog-paper":{maxHeight:435,width:"80%"}},maxWidth:"xs",open:o,onClose:n,children:[l.jsx(ge,{children:t("category.title.set_categories")}),l.jsx(fe,{dividers:!0,children:l.jsxs(Me,{children:[d.length===0&&l.jsx("span",{children:t("category.error.no_categories_found.label.info")}),d.map(a=>l.jsx(Se,{checked:Re(a.id,x,g,p),onChange:T=>{m(a.id,!1,{key:"categoriesToAdd"}),m(a.id,!1,{key:"categoriesToRemove"}),T&&m(a.id,!0,{key:"categoriesToAdd"}),T===!1&&m(a.id,!0,{key:"categoriesToRemove"})},label:a.name},a.id))]})}),l.jsx(he,{children:l.jsxs(U,{sx:{width:"100%"},children:[u&&l.jsx(xe,{sx:{margin:0},size:"small",label:t("global.button.dont_show_dialog_again"),onChange:a=>w(a.target.checked)}),l.jsxs(U,{direction:"row",sx:{justifyContent:"space-between",alignItems:"end",width:"100%"},children:[l.jsx(q,{component:me,to:oe.settings.childRoutes.categories.path,children:t(d.length?"global.button.edit":"global.button.create")}),l.jsxs(U,{direction:"row",children:[l.jsx(q,{autoFocus:!0,onClick:n,color:"primary",children:t("global.button.cancel")}),!!d.length&&l.jsx(q,{onClick:r,color:"primary",children:t("global.button.ok")})]})]})]})})]})}const Oe=({mangaId:e,mangaIds:t,onClose:o,addToLibrary:c})=>{const[i,f]=s.useState(!1),u=s.useMemo(()=>i?l.jsx(Fe,{open:i,onClose:(...p)=>{f(!1),o==null||o(...p)},mangaId:e,mangaIds:t,addToLibrary:c}):null,[e,t,c,o,i]);return{openCategorySelect:f,CategorySelectComponent:u}};var Z;const Ze=(e,t=!1)=>{var h,y;const{t:o}=ee(),c=ve(),[i,f]=s.useState(!!e.inLibrary),u=s.useCallback((C,d=[],S=[])=>{C&&z.updateManga(e.id,{updateManga:{inLibrary:!0},updateMangaCategories:{addToCategories:d,removeFromCategories:S}}).response.then(()=>A(o("library.info.label.added_to_library"),"success")).then(()=>f(!0)).catch(m=>{A(o("library.error.label.add_to_library"),"error",D(m))})},[e.id]),p=s.useCallback(async()=>{t&&await H({title:o("global.label.are_you_sure"),message:o("manga.action.library.remove.dialog.label.message",{title:e.title}),actions:{confirm:{title:o("global.button.remove")}}}),await G.removeFromLibrary([e.id]),f(!1)},[e.id,t]),{openCategorySelect:M,CategorySelectComponent:I}=Oe({mangaId:e.id,addToLibrary:!0,onClose:u}),w=s.useCallback(()=>{const C=async()=>{if(i){p().catch(B());return}let d;try{d=(await Ce()).showAddToLibraryCategorySelectDialog}catch(g){A(o("global.error.label.failed_to_load_data"),"error",D(g));return}let S;try{S=await z.getCategories(te).response}catch(g){A(o("category.error.label.request_failure"),"error",D(g));return}const m=E.getUserCreated(S.data.categories.nodes);let b;try{b=await G.getDuplicateLibraryMangas(e.title).response}catch(g){await H({title:o("global.error.label.failed_to_load_data"),message:o("manga.action.library.add.dialog.duplicate.label.failure",{error:D(g)}),actions:{extra:{show:!0,title:o("global.button.retry"),contain:!0},confirm:{title:o("global.button.add")}},onExtra:()=>C().catch(B())})}if((b==null?void 0:b.data.mangas.totalCount)&&await H({title:o("global.label.are_you_sure"),message:o("manga.action.library.add.dialog.duplicate.label.info"),actions:{extra:{show:!0,title:o("migrate.dialog.action.button.show_entry"),contain:!0},confirm:{title:o("global.button.add")}},onExtra:()=>c(oe.manga.path(b.data.mangas.nodes[0].id))}),!(d&&!!m.length)){u(!0,E.getIds(E.getDefaults(m)));return}M(!0)};C().catch(B())},[i,p,u]);return{CategorySelectComponent:I,updateLibraryState:w,isInLibrary:(y=(h=G.getFromCache(e.id,ye(Z||(Z=Q(["\n                    fragment MangaInLibraryState on MangaType {\n                        inLibrary\n                    }\n                "]))),"MangaInLibraryState"))==null?void 0:h.inLibrary)!=null?y:i}};export{He as C,Ke as D,$e as F,We as M,Ne as R,qe as V,Ze as a,Oe as b,Ve as c,Xe as d,Ye as e,Je as f,Qe as g,je as u};
