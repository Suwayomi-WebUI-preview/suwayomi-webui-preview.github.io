import{c as r,n as at,j as t,B as F,a as H,ag as z,r as oe,i as ie,x as Rt,a5 as Et,ah as bt,a3 as we,ai as yt,aj as Pt,ak as Ve,s as Q,I as J,u as st,e as ot,al as it,am as Lt,an as St,f as re,T as Dt,ao as jt,W as Tt,ap as kt,U as Xe,aq as _t,X as Ot,ar as At,as as Ue,q as Ke,N as Nt,m as Ge,h as X,Z as It,E as Ye,at as $t,au as Wt}from"./index-BqZ4wM82.js";import{b as U,C as O}from"./Chapters-1pANrGE5.js";import{P as ue,i as Mt,R as Ft,u as zt,g as Ze,c as Ht}from"./ReaderSettingsOptions-BmWrh47i.js";import{S as Je}from"./SpinnerImage-kLJPOnKI.js";import{S as Qe}from"./Select-Wmi5YTAV.js";import{C as Bt}from"./Collapse-BMdJuZKE.js";import{a as et}from"./TextField-DwpiKHc0.js";import{u as qt}from"./useDebounce-DT1kR02Z.js";import"./NumberSetting-BN19gEkM.js";import"./Info-CLi70PhJ.js";import"./InputAdornment-CJgOdwe5.js";import"./Switch-BJeu8L6F.js";import"./SwitchBase-CkMgQfw8.js";const Vt=i=>{for(let n=0;n<i.children.length;n++){const o=i.children.item(n);if(o){const{left:u,right:c}=o.getBoundingClientRect();if(u<=window.innerWidth/2&&c>window.innerWidth/2)return n}}return-1},Xt=5,Ut=()=>window.innerWidth+window.scrollX>=document.body.scrollWidth-Xt,Kt=()=>window.scrollX<=0;function Gt(i){const{pages:n,curPage:o,initialPage:u,settings:c,setCurPage:s,prevChapter:p,nextChapter:C}=i,f=r.useRef(u),d=r.useRef(null),g=r.useRef([]);function L(){var x;o<n.length-1?((x=g.current[o+1])==null||x.scrollIntoView({inline:"center"}),s(e=>e+1)):c.loadNextOnEnding&&C()}function h(){var x;o>0?((x=g.current[o-1])==null||x.scrollIntoView({inline:"center"}),s(o-1)):o===0&&p()}function P(){c.readerType==="ContinuesHorizontalLTR"?h():L()}function S(){c.readerType==="ContinuesHorizontalLTR"?L():h()}const b=r.useRef(0);function l(x){window.scrollBy(b.current-x.pageX,0)}function a(x){var e;b.current=x.pageX,(e=d.current)==null||e.addEventListener("mousemove",l)}function v(){var x;(x=d.current)==null||x.removeEventListener("mousemove",l)}function T(x){x.clientX>=window.innerWidth*.85?S():x.clientX<=window.innerWidth*.15&&P()}const _=()=>{c.readerType==="ContinuesHorizontalLTR"?window.scrollX+window.innerWidth>=document.body.scrollWidth&&C():c.readerType==="ContinuesHorizontalRTL"&&window.scrollX<=window.innerWidth&&C()};return at(g.current[u],r.useCallback((x,e)=>{const m=g.current[u];m!=null&&m.offsetHeight&&(m.scrollIntoView({inline:"center"}),e.disconnect())},[g.current[u],u])),r.useEffect(()=>{var x,e;return(x=d.current)==null||x.addEventListener("mousedown",a),(e=d.current)==null||e.addEventListener("mouseup",v),()=>{var m,I;(m=d.current)==null||m.removeEventListener("mousedown",a),(I=d.current)==null||I.removeEventListener("mouseup",v)}},[d]),r.useEffect(()=>(c.loadNextOnEnding&&document.addEventListener("scroll",_),()=>{document.removeEventListener("scroll",_)}),[d,o,p,C]),r.useEffect(()=>{const x=()=>{if(!d.current)return;const e=Vt(d.current);e!==f.current&&(f.current=e,s(e)),(c.readerType==="ContinuesHorizontalLTR"?Ut():Kt())&&(f.current=n.length-1,s(f.current))};return window.addEventListener("scroll",x),()=>window.removeEventListener("scroll",x)},[c.readerType]),t.jsx(F,{ref:d,sx:{display:"flex",flexDirection:c.readerType==="ContinuesHorizontalLTR"?"row":"row-reverse",justifyContent:c.readerType==="ContinuesHorizontalLTR"?"flex-start":"flex-end",width:"auto",height:"auto",overflowX:"visible",userSelect:"none"},onClick:T,children:n.map(x=>t.jsx(ue,{index:x.index,src:x.src,onImageLoad:()=>{},settings:c,ref:e=>{g.current[x.index]=e}},x.index))})}function Yt(i){const{settings:n,curPage:o,pageCount:u}=i;return t.jsx(F,{sx:{display:n.showPageNumber?"block":"none",position:"fixed",bottom:"50px",padding:"2px",paddingLeft:"4px",paddingRight:"4px",textAlign:"center",backgroundColor:"rgba(0, 0, 0, 0.3)",borderRadius:"10px"},children:"".concat(o+1," / ").concat(u)})}function Zt(i){const{pages:n,settings:o,setCurPage:u,initialPage:c,curPage:s,nextChapter:p,prevChapter:C,chapter:f}=i,d=r.useRef(null);r.useEffect(()=>{const a=n.map(v=>{const T=H.requestImage(v.src);return T.response.catch(()=>{}),T});return()=>{a.forEach(v=>v.abortRequest(new Error("PagedPager::preload: chapter changed")))}},[f.id]);const g=a=>{u(a),window.scroll({top:0})};function L(){s<n.length-1?g(s+1):o.loadNextOnEnding&&p()}function h(){s>0?g(s-1):C()}function P(){o.readerType==="SingleLTR"?h():o.readerType==="SingleRTL"&&L()}function S(){o.readerType==="SingleLTR"?L():o.readerType==="SingleRTL"&&h()}function b(a){switch(a.key){case"Space":a.preventDefault(),L();break;case"ArrowRight":S();break;case"ArrowLeft":P();break}}function l(a){a.clientX>window.innerWidth/2?S():P()}return r.useEffect(()=>(document.addEventListener("keydown",b),()=>{document.removeEventListener("keydown",b)}),[d,s,o.readerType,C,p]),r.useEffect(()=>{setTimeout(()=>{g(c)},0)},[c]),t.jsx(F,{ref:d,sx:{display:"flex",flexDirection:"column",justifyContent:"center",width:"auto",height:"auto"},onClick:l,children:t.jsx(ue,{index:s,onImageLoad:()=>{},src:n[s].src,settings:o},s)})}const Jt=r.forwardRef((i,n)=>{const{image1src:o,image2src:u,index:c,onImageLoad:s,settings:p}=i,C=Mt(p),f={...C,width:p.fitPageToWindow?C.width:"calc(".concat(C.width," * 0.5)"),minWidth:p.fitPageToWindow&&p.scalePage?"calc(".concat(C.minWidth," * 0.5)"):C.minWidth,maxWidth:p.fitPageToWindow?"calc(".concat(C.maxWidth," * 0.5)"):C.maxWidth},d={...f,height:"100vh",width:"50%",backgroundColor:"#525252"};return t.jsxs(F,{ref:n,sx:{display:"flex",flexDirection:p.readerType==="DoubleLTR"?"row":"row-reverse",justifyContent:"center",width:"100%"},children:[t.jsx(Je,{src:o,onImageLoad:s,alt:"Page #".concat(c),spinnerStyle:d,imgStyle:{...f,objectPosition:p.readerType==="DoubleLTR"?z("right","left"):z("left","right")}}),t.jsx(Je,{src:u,onImageLoad:s,alt:"Page #".concat(c+1),spinnerStyle:{...d,width:"calc(50% - 5px)",marginLeft:"5px"},imgStyle:{...f,objectPosition:p.readerType==="DoubleLTR"?z("left","right"):z("right","left")}})]})}),Qt=i=>i.height/i.width<1,Re=(i,n,o)=>{if(n[i]||n[i+1]||i===n.length-1)return!0;const u=n.lastIndexOf(!0,i-1),c=i-(u+1);return o?c%2===0:c%2===1};function er(i){const{pages:n,settings:o,setCurPage:u,initialPage:c,curPage:s,chapter:p,nextChapter:C,prevChapter:f}=i,d=r.useRef(null),[g,L]=r.useState(Array(n.length).fill(!1)),[h,P]=r.useState(Array(n.length).fill(!1));function S(){let e=1;if(s<n.length&&h[s]&&(e=1,g[s]))return e;if(s+1<n.length&&h[s+1]){if(Re(s,g,o.offsetFirstPage))return e;e=2}return e}function b(){return Re(s-2,g,o.offsetFirstPage)?1:2}function l(){if(s<n.length-1){const e=s+S();u(e>=n.length?n.length-1:e)}else o.loadNextOnEnding&&C()}function a(){if(s>0){const e=s-b();u(e<0?0:e)}else f()}function v(){o.readerType==="DoubleLTR"?a():l()}function T(){o.readerType==="DoubleLTR"?l():a()}function _(e){switch(e.key){case"Space":e.preventDefault(),l();break;case"ArrowRight":T();break;case"ArrowLeft":v();break}}function x(e){e.clientX>window.innerWidth/2?T():v()}return r.useEffect(()=>(document.addEventListener("keydown",_),()=>{document.removeEventListener("keydown",_)}),[d,s,o.readerType,f,C,h,g]),r.useEffect(()=>{u(c)},[c]),r.useEffect(()=>{o.offsetFirstPage?S()===2&&u(s+1):s>0&&!Re(s-1,g,o.offsetFirstPage)&&u(s-1)},[o.offsetFirstPage]),r.useEffect(()=>{const e=n.map(m=>[m.index,H.requestImage(m.src)]);return e.forEach(async([m,I])=>{try{const N=await I.response,$=new Image;$.onload=()=>{URL.revokeObjectURL(N),P(A=>A.toSpliced(m,1,!0)),L(A=>A.toSpliced(m,1,Qt($)))},$.src=N}catch(N){}}),()=>{e.forEach(([m,I])=>I.abortRequest(new Error("DoublePagedPager::preload(".concat(m,"): chapter changed"))))}},[p.id]),t.jsx(F,{ref:d,onClick:x,children:t.jsx(F,{id:"display",sx:{display:"flex",flexDirection:o.readerType==="DoubleLTR"?"row":"row-reverse",justifyContent:"center",width:"auto",height:"auto"},children:S()===2?t.jsx(Jt,{index:s,image1src:n[s].src,image2src:n[s+1].src,settings:o},s):t.jsx(ue,{index:s,src:n[s].src,onImageLoad:()=>{},settings:o},s)})})}const tr=i=>{for(let n=0;n<i.children.length;n++){const o=i.children.item(n);if(o){const{top:u,bottom:c}=o.getBoundingClientRect();if(u<=window.innerHeight&&c>1)return n}}return-1},rr=5,nr=.95,tt=.25,ar="smooth",rt=()=>window.innerHeight+window.scrollY>=document.body.offsetHeight-rr,sr=()=>window.scrollY<=0;function nt(i){const{pages:n,settings:o,setCurPage:u,initialPage:c,nextChapter:s,prevChapter:p}=i,C=r.useRef(c),f=r.useRef(null),d=r.useRef([]);r.useEffect(()=>{let l=!1;const a=()=>{if(f.current)if(rt()){if(l)return;l=!0,C.current=n.length-1,u(C.current),o.loadNextOnEnding&&s()}else{l=!1;const v=tr(f.current);v!==C.current&&(C.current=v,u(v))}};return window.addEventListener("scroll",a),()=>{window.removeEventListener("scroll",a)}},[o.loadNextOnEnding,s]);const g=r.useRef(0),L=r.useRef(!1);function h(l){L.current=!0,window.scrollBy(0,g.current-l.pageY)}function P(l){var a;g.current=l.pageY,(a=f.current)==null||a.addEventListener("mousemove",h)}function S(){var l;(l=f.current)==null||l.removeEventListener("mousemove",h)}r.useEffect(()=>{var l,a;return(l=f.current)==null||l.addEventListener("mousedown",P),(a=f.current)==null||a.addEventListener("mouseup",S),()=>{var v,T;(v=f.current)==null||v.removeEventListener("mousedown",P),(T=f.current)==null||T.removeEventListener("mouseup",S)}},[f]);const b=r.useCallback((l,a=nr)=>{if(l==="down"&&rt()){s();return}if(l==="up"&&sr()){p();return}window.scroll({top:window.scrollY+window.innerHeight*a*(l==="up"?-1:1),behavior:ar})},[s,p]);return r.useEffect(()=>{const l=a=>{switch(a.key){case"Space":a.preventDefault(),b(a.shiftKey?"up":"down");break;case"ArrowDown":a.preventDefault(),b(a.shiftKey?"up":"down",tt);break;case"ArrowRight":a.preventDefault(),b(a.shiftKey?"up":"down");break;case"ArrowUp":a.preventDefault(),b(a.shiftKey?"down":"up",tt);break;case"ArrowLeft":a.preventDefault(),b(a.shiftKey?"down":"up");break}};return document.addEventListener("keydown",l,!1),()=>{document.removeEventListener("keydown",l)}},[b]),at(d.current[c],r.useCallback((l,a)=>{const v=d.current[c];v!=null&&v.offsetHeight&&(v.scrollIntoView(),a.disconnect())},[d.current[c],c])),t.jsx(F,{ref:f,sx:{display:"flex",flexDirection:"column",justifyContent:"center",width:"auto",height:"auto",userSelect:"none"},onClick:l=>{if(L.current){L.current=!1;return}b(l.clientX>window.innerWidth/2?"down":"up")},children:n.map(l=>t.jsx(ue,{index:l.index,src:l.src,onImageLoad:()=>{},settings:o,ref:a=>{d.current[l.index]=a}},l.index))})}var Ee={},or=ie;Object.defineProperty(Ee,"__esModule",{value:!0});var ct=Ee.default=void 0,ir=or(oe()),cr=t;ct=Ee.default=(0,ir.default)((0,cr.jsx)("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Close");var be={},lr=ie;Object.defineProperty(be,"__esModule",{value:!0});var ae=be.default=void 0,dr=lr(oe()),ur=t;ae=be.default=(0,dr.default)((0,ur.jsx)("path",{d:"M15.41 16.59 10.83 12l4.58-4.59L14 6l-6 6 6 6z"}),"KeyboardArrowLeft");var ye={},pr=ie;Object.defineProperty(ye,"__esModule",{value:!0});var se=ye.default=void 0,fr=pr(oe()),gr=t;se=ye.default=(0,fr.default)((0,gr.jsx)("path",{d:"M8.59 16.59 13.17 12 8.59 7.41 10 6l6 6-6 6z"}),"KeyboardArrowRight");var Pe={},hr=ie;Object.defineProperty(Pe,"__esModule",{value:!0});var lt=Pe.default=void 0,xr=hr(oe()),mr=t;lt=Pe.default=(0,xr.default)((0,mr.jsx)("path",{d:"M7.41 8.59 12 13.17l4.59-4.58L18 10l-6 6-6-6z"}),"KeyboardArrowDown");var Le={},Cr=ie;Object.defineProperty(Le,"__esModule",{value:!0});var dt=Le.default=void 0,vr=Cr(oe()),wr=t;dt=Le.default=(0,vr.default)((0,wr.jsx)("path",{d:"M7.41 15.41 12 10.83l4.59 4.58L18 14l-6-6-6 6z"}),"KeyboardArrowUp");const Rr=["addEndListener","appear","children","easing","in","onEnter","onEntered","onEntering","onExit","onExited","onExiting","style","timeout","TransitionComponent"],Er={entering:{transform:"none"},entered:{transform:"none"}},br=r.forwardRef(function(n,o){const u=Rt(),c={enter:u.transitions.duration.enteringScreen,exit:u.transitions.duration.leavingScreen},{addEndListener:s,appear:p=!0,children:C,easing:f,in:d,onEnter:g,onEntered:L,onEntering:h,onExit:P,onExited:S,onExiting:b,style:l,timeout:a=c,TransitionComponent:v=yt}=n,T=Et(n,Rr),_=r.useRef(null),x=bt(_,C.ref,o),e=R=>D=>{if(R){const w=_.current;D===void 0?R(w):R(w,D)}},m=e(h),I=e((R,D)=>{Pt(R);const w=Ve({style:l,timeout:a,easing:f},{mode:"enter"});R.style.webkitTransition=u.transitions.create("transform",w),R.style.transition=u.transitions.create("transform",w),g&&g(R,D)}),N=e(L),$=e(b),A=e(R=>{const D=Ve({style:l,timeout:a,easing:f},{mode:"exit"});R.style.webkitTransition=u.transitions.create("transform",D),R.style.transition=u.transitions.create("transform",D),P&&P(R)}),ee=e(S),B=R=>{s&&s(_.current,R)};return t.jsx(v,we({appear:p,in:d,nodeRef:_,onEnter:I,onEntered:N,onEntering:m,onExit:A,onExited:ee,onExiting:$,addEndListener:B,timeout:a},T,{children:(R,D)=>r.cloneElement(C,we({style:we({transform:"scale(0)",visibility:R==="exited"&&!d?"hidden":void 0},Er[R],l,C.props.style),ref:x},D))}))}),yr=br,Pr=Q("div")({zIndex:10}),Lr=Q("div")(({theme:i})=>({top:0,left:0,width:"300px",minWidth:"300px",height:"100vh",overflowY:"auto",backgroundColor:i.palette.background.default,"& header":{backgroundColor:i.palette.action.hover,display:"flex",alignItems:"center",minHeight:"64px",paddingLeft:"24px",paddingRight:"24px",transition:"left 2s ease","& button":{flexGrow:0,flexShrink:0},"& button:nth-child(1)":{marginRight:"16px"},"& h1":{fontSize:"1.25rem",flexGrow:1}}})),Sr=Q("div")({margin:"0 16px","& > span:nth-child(1)":{textAlign:"center",display:"block",marginTop:"16px"}}),Dr=Q("div")({display:"flex",flexWrap:"wrap",alignContent:"center",alignItems:"center",justifyContent:"center"}),jr=Q("div")({display:"grid",gridTemplateRows:"auto auto auto",gridTemplateColumns:"0fr 1fr 0fr",gridTemplateAreas:'"pre current next"',gridColumnGap:"5px",margin:"10px 0","& a":{textDecoration:"none",color:"inherit",display:"flex",flexWrap:"wrap",alignContent:"center"}}),Tr=Q(J)(({theme:i})=>({position:"fixed",top:20,left:30,height:"40px",width:"40px",borderRadius:5,backgroundColor:i.palette.custom.main,"&:hover":{backgroundColor:i.palette.custom.light}}));function kr(i){var D;const{t:n}=st(),o=ot(),u=it(),{prevDrawerOpen:c,prevSettingsCollapseOpen:s}=(D=u.state)!=null?D:{},{settings:p,setSettingValue:C,manga:f,chapter:d,chapters:g,curPage:L,scrollToPage:h,openNextChapter:P,retrievingNextChapter:S}=i,b=Lt(),l=r.useMemo(()=>new Set(g.map(({scanlator:w})=>w)).size>1,[g]),[a,v]=r.useState(p.staticNav||c),[T,_]=r.useState(!0),[x,e]=r.useState(p.staticNav||c),[m,I]=r.useState(0),[N,$]=r.useState(s!=null?s:!0),A=S,ee=(w,k,q)=>{_(w!=="staticNav"),C(w,k,q)},B=w=>{v(w),e(w)},R=()=>{const w=window.pageYOffset;Math.abs(w-m)>20&&(e(w>m),I(w))};return r.useEffect(()=>{T&&B(p.staticNav)},[p.staticNav]),r.useEffect(()=>{window.addEventListener("scroll",R);const w=document.querySelector("#root"),k=document.querySelector("#appMainContainer");return w.style.display="flex",w.style.flexDirection="column",k.style.display="none",()=>{w.style.display="block",k.style.display="block",window.removeEventListener("scroll",R)}},[R]),t.jsxs(Pr,{children:[t.jsx(St,{direction:z("right","left"),in:a,timeout:200,appear:!1,mountOnEnter:!0,unmountOnExit:!0,children:t.jsxs(Lr,{sx:{position:"fixed"},children:[t.jsxs("header",{children:[!p.staticNav&&t.jsx(re,{title:n("reader.button.close_menu"),children:t.jsx(J,{edge:"start",color:"inherit","aria-label":"menu",onClick:()=>B(!1),size:"large",children:z(t.jsx(ae,{}),t.jsx(se,{}))})}),t.jsx(Dt,{variant:"h1",textOverflow:"ellipsis",overflow:"hidden",sx:{py:1},children:d.name}),t.jsx(re,{title:n("reader.button.exit"),children:t.jsx(J,{edge:"start",color:"inherit","aria-label":"menu",onClick:b,size:"large",sx:{mr:-1},children:t.jsx(ct,{})})})]}),t.jsxs(jt,{ContainerComponent:"div",sx:{"& span":{fontWeight:"bold"}},children:[t.jsx(Tt,{primary:n("reader.settings.title.reader_settings")}),t.jsxs(J,{edge:"start",color:"inherit","aria-label":"menu",disableRipple:!0,disableFocusRipple:!0,onClick:()=>$(!N),size:"large",children:[N&&t.jsx(dt,{}),!N&&t.jsx(lt,{})]})]}),t.jsx(Bt,{in:N,timeout:"auto",unmountOnExit:!0,children:t.jsx(Ft,{setSettingValue:ee,staticNav:p.staticNav,showPageNumber:p.showPageNumber,loadNextOnEnding:p.loadNextOnEnding,skipDupChapters:p.skipDupChapters,fitPageToWindow:p.fitPageToWindow,scalePage:p.scalePage,readerType:p.readerType,offsetFirstPage:p.offsetFirstPage,readerWidth:p.readerWidth})}),t.jsx(kt,{sx:{my:1,mx:2}}),t.jsxs(Sr,{children:[t.jsxs(Dr,{children:[t.jsx("span",{children:n("reader.page_info.label.currently_on_page")}),t.jsx(et,{size:"small",sx:{margin:"0 5px"},disabled:A||d.pageCount===-1,children:t.jsx(Qe,{value:d.pageCount>-1?"".concat(L):"",displayEmpty:!0,onChange:({target:{value:w}})=>{h(Number(w))},children:Array(Math.max(0,d.pageCount)).fill(1).map((w,k)=>t.jsx(Xe,{value:k,children:k+1},"Page#".concat(k)))})}),t.jsx("span",{children:n("reader.page_info.label.of_max_pages",{maxPages:d.pageCount})})]}),t.jsxs(jr,{children:[t.jsx(re,{title:n("reader.button.previous_chapter"),children:t.jsx(J,{sx:{gridArea:"pre"},disabled:A||d.sourceOrder<=1,onClick:()=>P(U.PREV),children:z(t.jsx(ae,{}),t.jsx(se,{}))})}),t.jsx(et,{sx:{gridArea:"current"},size:"small",disabled:A||d.sourceOrder<1,children:t.jsx(Qe,{value:d.sourceOrder>=1?"".concat(d.sourceOrder):"",displayEmpty:!0,onChange:({target:{value:w}})=>{o("/manga/".concat(f.id,"/chapter/").concat(w),{replace:!0,state:{prevDrawerOpen:a,prevSettingsCollapseOpen:N}})},children:g.map(({id:w,sourceOrder:k,name:q,chapterNumber:pe,scanlator:te})=>t.jsx(Xe,{value:k,children:"#".concat(pe).concat(l&&te!=null?" (".concat(te,")"):""," | ").concat(q)},w))})}),t.jsx(re,{title:n("reader.button.next_chapter"),children:t.jsx(J,{sx:{gridArea:"next"},disabled:A||d.sourceOrder<1||d.sourceOrder>=f.chapters.totalCount,onClick:()=>P(U.NEXT),children:z(t.jsx(se,{}),t.jsx(ae,{}))})})]})]})]})}),t.jsx(yr,{in:!a,children:t.jsx(_t,{in:!x,children:t.jsx(re,{title:n("reader.button.open_menu"),children:t.jsx(Tr,{edge:"start","aria-label":"menu",disableRipple:!0,disableFocusRipple:!0,onClick:()=>B(!0),size:"large",children:z(t.jsx(se,{}),t.jsx(ae,{}))})})})})]})}const ne=i=>O.getFromCache(i,$t,"CHAPTER_READER_FIELDS"),_r=i=>{switch(i){case"ContinuesVertical":case"Webtoon":return nt;case"SingleVertical":case"SingleRTL":case"SingleLTR":return Zt;case"DoubleVertical":case"DoubleRTL":case"DoubleLTR":return er;case"ContinuesHorizontalLTR":case"ContinuesHorizontalRTL":return Gt;default:return nt}},Or=i=>Array.from({length:i},(n,o)=>o),Z={pageCount:-1,sourceOrder:-1,chapterCount:0,lastPageRead:0,name:"Loading...",manga:{id:-1}};function Kr(){var Ie,$e,We,Me,Fe,ze,He,Be;const{t:i}=st(),n=ot(),o=it(),{chapterIndex:u,mangaId:c}=Ot(),s=r.useMemo(()=>({id:+c,title:"",thumbnailUrl:"",genre:[],inLibraryAt:0,lastReadAt:0,chapters:{totalCount:0},trackRecords:{totalCount:0}}),[c]),{data:p,loading:C,error:f,refetch:d}=H.useGetManga(At,c),g=r.useRef(null),L=Number(c)===((Ie=g.current)==null?void 0:Ie.mangaId)&&Number(u)===(($e=g.current)==null?void 0:$e.sourceOrder)&&((We=g.current)==null?void 0:We.pageCount)!==-1,h=(Me=p==null?void 0:p.manga)!=null?Me:s,{data:P,loading:S,error:b,refetch:l}=H.useGetChapters(Ue,{condition:{mangaId:Number(c),sourceOrder:Number(u)}},{notifyOnNetworkStatusChange:!0}),a=P==null?void 0:P.chapters.nodes[0],v=r.useRef(!1),{settings:{downloadAheadLimit:T}}=Ke(),_=!!T,x=()=>{var M;return g.current&&L?a&&((M=g.current)==null?void 0:M.pageCount)!==a.pageCount?a:g.current:(v.current=!1,a||null)};g.current=x();const e=(Fe=g.current)!=null?Fe:Z,m=r.useRef(Z);m.current===Z&&(m.current=e),e.mangaId!==((ze=m.current)==null?void 0:ze.mangaId)&&(m.current=Z);const[I,{loading:N,error:$}]=H.useGetChapterPagesFetch(e.id),A=()=>{!S&&!e.isDownloaded?I().then(()=>{v.current=!0}).catch(X()):v.current=!0};r.useEffect(()=>{A()},[e.id]);const[ee,B]=r.useState(!1),[R,D]=r.useState(0),w=R===e.pageCount-1,k=qt(R,w?0:1e3),[q,pe]=r.useState(void 0),{setOverride:te,setTitle:Se}=r.useContext(Nt),[De,je]=r.useState(!1),{data:fe,loading:ut,error:Te,refetch:pt}=H.useGetMangaChapters(Ue,c,{nextFetchPolicy:"standby"}),E=fe==null?void 0:fe.chapters.nodes,ge=C||S||ut||N||!v.current&&!b&&!$,ke=(Be=(He=f!=null?f:b)!=null?He:Te)!=null?Be:$,{settings:he,loading:_e}=zt(),[y,Oe]=r.useState(Ze(h,he)),{settings:ce}=Ke(),Ae=r.useMemo(()=>y.skipDupChapters?O.removeDuplicates(m.current,E!=null?E:[]):E!=null?E:[],[m.current,E,y.skipDupChapters]),ft=r.useMemo(()=>O.getNextChapters(e,E!=null?E:[],{offset:U.PREV,skipDupe:y.skipDupChapters,skipDupeChapter:m.current}),[e,m.current,E,y.skipDupChapters]),gt=r.useMemo(()=>O.getNextChapters(e,E!=null?E:[],{skipDupe:y.skipDupChapters,skipDupeChapter:m.current}),[e,m.current,E,y.skipDupChapters]),le=r.useMemo(()=>O.getNextChapter(e,E!=null?E:[],{offset:U.PREV,skipDupe:y.skipDupChapters,skipDupeChapter:m.current}),[e,m.current,E,y.skipDupChapters]),K=r.useMemo(()=>O.getNextChapter(e,E!=null?E:[],{skipDupe:y.skipDupChapters,skipDupeChapter:m.current}),[e,m.current,E,y.skipDupChapters]),Ne=j=>{if(e===Z)return;const W=()=>{if(!(!!j.isRead&&!!ce.deleteChaptersWhileReading)||!E)return[];const Y=[e,...ft][ce.deleteChaptersWhileReading-1];if(!Y)return[];const me=ne(Y.id);return me.isRead&&O.isDeletable(me,ce.deleteChaptersWithBookmark)?y.skipDupChapters?O.getIds(O.addDuplicates([Y],E)):O.getIds([Y]):[]};(()=>{var Ce;const de=ne(e.id),Y=((Ce=j.lastPageRead)!=null?Ce:0)/e.pageCount>.25;if(_&&h.inLibrary&&!!(de!=null&&de.isDownloaded)&&Y){const ve=K?ne(K.id):null;if(!(ve!=null&&ve.isDownloaded))return;const qe=O.getNonRead(gt).map(V=>ne(V.id)).slice(-T).filter(V=>!V.isDownloaded).map(V=>V.id).filter(V=>!O.isDownloading(V));if(!qe.length)return;O.download(qe).catch(X())}})();const xe=y.skipDupChapters?O.getIds(O.addDuplicates([e],E!=null?E:[e])):[e.id];H.updateChapters(xe,{...j,chapterIdsToDelete:W(),trackProgressMangaId:ce.updateProgressAfterReading&&j.isRead&&h.trackRecords.totalCount?h.id:void 0},{errorPolicy:"all"}).response.catch(X())},ht=(j,W,M=!0)=>{Oe({...y,[j]:W}),M&&Wt(h,[[j,W]]).catch(()=>Ge(i("reader.settings.error.label.failed_to_save_settings"),"warning"))},G=r.useCallback(j=>{const W=j===U.NEXT,M=W?K:le;if(!M){Ge(i(W?"reader.error.label.next_chapter_does_not_exist":"reader.error.label.prev_chapter_does_not_exist"),"error");return}je(!0),D(0),n("/manga/".concat(h.id,"/chapter/").concat(M.sourceOrder),{replace:!0,state:o.state}),je(!1)},[h.id,le==null?void 0:le.id,K==null?void 0:K.id]);r.useEffect(()=>{if(ge||!e){D(0);return}B(!0),e.lastPageRead===e.pageCount-1?D(0):D(e.lastPageRead)},[e,ge]),r.useEffect(()=>{!(h!=null&&h.title)||e.name===i("global.label.loading")?Se(i("reader.title")):Se("".concat(h.title,": ").concat(e.name))},[i,h,e]),r.useEffect(()=>{!_e&&!C&&(Ht(h,"manga",he).catch(X()),Oe(Ze(h,he)))},[_e,C]),r.useEffect(()=>(te({status:!0,value:t.jsx(kr,{settings:y,setSettingValue:ht,manga:h,chapter:e,chapters:Ae,curPage:R,scrollToPage:pe,openNextChapter:G,retrievingNextChapter:De})}),()=>te({status:!1,value:t.jsx("div",{})})),[h,e,y,R,u,De,G,Ae]),r.useEffect(()=>{if(!ee||e===Z)return;const j=ne(e.id);if(k===(j==null?void 0:j.lastPageRead))return;const W=k!==-1,M=k===e.pageCount-1;(W||M)&&Ne({lastPageRead:W?k:void 0,isRead:M?!0:void 0})},[k,_]);const xt=r.useCallback(()=>{Ne({lastPageRead:e.pageCount-1,isRead:!0}),G(U.NEXT)},[e.pageCount,G,e,h]),mt=r.useCallback(()=>{G(U.PREV)},[G]);if(ge)return t.jsx(F,{sx:{height:"100vh",width:"100vw",display:"grid",placeItems:"center"},children:t.jsx(It,{thickness:5})});if(ke)return t.jsx(Ye,{message:i("global.error.label.failed_to_load_data"),messageExtra:ke.message,retry:()=>{f&&d().catch(X()),b&&l().catch(X()),Te&&pt().catch(X()),$&&A()}});if(!e.pageCount)return t.jsx(Ye,{message:i("reader.error.label.no_pages_found"),retry:A});const Ct=Or(e.pageCount).map(j=>({index:j,src:H.getChapterPageUrl(c,u,j)})),vt=_r(y.readerType),wt=q!=null?q:e.lastPageRead===e.pageCount-1?0:e.lastPageRead;return t.jsxs(F,{sx:{display:"flex",flexDirection:"column",alignContent:"center",alignItems:"center",justifyContent:"center",minWidth:y.staticNav?"calc((100vw - (100vw - 100%)) - 300px)":"calc(100vw - (100vw - 100%))",minHeight:"100vh",marginLeft:y.staticNav?"300px":"unset"},children:[t.jsx(Yt,{settings:y,curPage:R,pageCount:e.pageCount}),t.jsx(F,{sx:{alignSelf:"stretch"},children:t.jsx(vt,{pages:Ct,pageCount:e.pageCount,setCurPage:D,initialPage:wt,curPage:R,settings:y,manga:h,chapter:e,nextChapter:xt,prevChapter:mt},e.id)})]})}export{Kr as Reader};
