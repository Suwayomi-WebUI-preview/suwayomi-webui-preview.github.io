import{u as B,a as N,G as ge,c as u,w as G,l as P,j as t,x as me,y as j,z as be,t as Ce,m as te,A as z,f as ne,I as fe,C as xe,E as ye,h as ae,F as Se,N as je,g as ke}from"./index-B75kYtqP.js";import{u as ie,S as _e,A as Te,N as Me}from"./AppbarSearch-Ba_cWq3g.js";import{E as re}from"./EmptyViewAbsoluteCentered-Dv2qmjMZ.js";import{T as Fe,a as Le}from"./Tabs-sFn6GVYE.js";import{d as we}from"./FilterList-DbGkBpVg.js";import{C as I}from"./CheckboxInput-5tAgWhU1.js";import{S as Ae,R}from"./SortRadioInput-DZjM9Nnl.js";import{T as _}from"./ThreeStateCheckboxInput-CY-TUhFx.js";import{O as Be,S as Ie,a as ve}from"./SelectionFAB-BQyBy5Ea.js";import{T as Ee}from"./Trackers-D4pSmk7a.js";import{s as Oe,M as Re}from"./Mangas-D2HSZsaA.js";import{F as T}from"./TextField-BakXDSMW.js";import{R as De}from"./ListPreference-Bk-axmhK.js";import{M as Ne,a as Ue}from"./MangaGrid-DS-8iM-E.js";import{d as Ge,U as Pe}from"./UpdateChecker-5sY0wp_o.js";import{u as ze}from"./useManageMangaLibraryState-BsrDM68v.js";import{C as Ke}from"./Checkbox-t9Uk7KzA.js";import{e as U}from"./Strings-CWt9sr6N.js";import{T as We,a as He}from"./TabsMenu-B-wVZpua.js";import{C as Ve}from"./Chip-CzwVgLnr.js";import"./StyledFab-CEY0VxfO.js";import"./Chapters-DgElwDfT.js";import"./SwitchBase-Duq7XaEt.js";import"./index-CVCnai7L.js";import"./Delete-DtNRxYmz.js";import"./Download-yfqKuc1p.js";import"./Sync-XLURGeJh.js";import"./SpinnerImage-Di1Vm1fZ.js";import"./Refresh-BM2loQZ8.js";import"./TypographyMaxLines-BeeyZxDi.js";import"./Link-Wts2QMdV.js";import"./Card-B-9pq73x.js";import"./CardActionArea-CWB75ZuS.js";import"./CardContent-DC6XoZ_c.js";import"./Avatar-C1SgAJIR.js";import"./PlayArrow-FFVJeMYj.js";import"./Progress-2FB0cQJD.js";import"./Info-RQHop6tI.js";import"./InputAdornment-BHdajV9c.js";import"./CheckCircle-C8DPSJ94.js";import"./Collapse-C5s6cFn-.js";import"./NumberSetting-C_a65vI6.js";import"./useMobilePicker-CFHXAsUA.js";import"./SelectSetting-zGFM03RC.js";import"./Select-DdSp-cy3.js";const Ye={filter:"global.label.filter",sort:"global.label.sort",display:"global.label.display"},Qe=[["unreadChapters","library.option.sort.label.by_unread_chapters"],["totalChapters","library.option.sort.label.by_total_chapters"],["alphabetically","library.option.sort.label.alphabetically"],["dateAdded","library.option.sort.label.by_date_added"],["lastRead","library.option.sort.label.by_last_read"],["latestFetchedChapter","library.option.sort.label.by_latest_fetched_chapter"],["latestUploadedChapter","library.option.sort.label.by_latest_uploaded_chapter"]],$e=({category:e,open:s,onClose:i})=>{var f,b;const{t:a}=B(),o=N.useGetTrackerList(ge),l=Ee.getLoggedIn((b=(f=o.data)==null?void 0:f.trackers.nodes)!=null?b:[]),r=u.useMemo(()=>G(e),[e]),n=be(e,()=>te(a("global.error.label.failed_to_save_changes","error"))),{settings:{showTabSize:C}}=P(),L=Ce(()=>te(a("search.error.label.failed_to_save_settings"),"warning"));return t.jsx(Be,{open:s,onClose:i,tabs:["filter","sort","display"],tabTitle:h=>a(Ye[h]),tabContent:h=>{if(h==="filter")return t.jsxs(t.Fragment,{children:[t.jsx(_,{label:a("global.filter.label.unread"),checked:r.hasUnreadChapters,onChange:c=>n("hasUnreadChapters",c)}),t.jsx(_,{label:a("global.filter.label.downloaded"),checked:r.hasDownloadedChapters,onChange:c=>n("hasDownloadedChapters",c)}),t.jsx(_,{label:a("global.filter.label.bookmarked"),checked:r.hasBookmarkedChapters,onChange:c=>n("hasBookmarkedChapters",c)}),t.jsx(_,{label:a("global.filter.label.duplicate_chapters"),checked:r.hasDuplicateChapters,onChange:c=>n("hasDuplicateChapters",c)}),t.jsx(T,{sx:{mt:2},children:a("manga.label.status")}),Object.values(me).map(c=>t.jsx(_,{label:a(Oe[c]),checked:r.hasStatus[c],onChange:p=>n("hasStatus",{...r.hasStatus,[c]:p})},c)),t.jsx(T,{sx:{mt:2},children:a("global.filter.label.tracked")}),l.map(c=>t.jsx(_,{label:c.name,checked:r.hasTrackerBinding[c.id],onChange:p=>n("hasTrackerBinding",{...r.hasTrackerBinding,[c.id]:p})},c.id))]});if(h==="sort")return Qe.map(([c,p])=>t.jsx(Ae,{label:a(p),checked:r.sortBy===c,sortDescending:r.sortDesc,onClick:()=>c!==r.sortBy?n("sortBy",c):n("sortDesc",!r.sortDesc)},c));if(h==="display"){const{gridLayout:c,showContinueReadingButton:p,showDownloadBadge:x,showUnreadBadge:w}=r;return t.jsxs(t.Fragment,{children:[t.jsx(T,{children:a("global.grid_layout.title")}),t.jsxs(De,{onChange:v=>n("gridLayout",Number(v.target.value)),value:c,children:[t.jsx(R,{label:a("global.grid_layout.label.compact_grid"),value:j.Compact,checked:c==null||c===j.Compact}),t.jsx(R,{label:a("global.grid_layout.label.comfortable_grid"),value:j.Comfortable,checked:c===j.Comfortable}),t.jsx(R,{label:a("global.grid_layout.label.list"),value:j.List,checked:c===j.List})]}),t.jsx(T,{sx:{mt:2},children:a("library.option.display.badge.title")}),t.jsx(I,{label:a("library.option.display.badge.label.unread_badges"),checked:w,onChange:()=>n("showUnreadBadge",!w)}),t.jsx(I,{label:a("library.option.display.badge.label.download_badges"),checked:x,onChange:()=>n("showDownloadBadge",!x)}),t.jsx(T,{sx:{mt:2},children:a("library.option.display.tab.title")}),t.jsx(I,{label:a("library.option.display.tab.label.show_number_of_items"),checked:C,onChange:()=>L("showTabSize",!C)}),t.jsx(T,{sx:{mt:2},children:a("global.label.other")}),t.jsx(I,{label:a("library.option.display.other.label.show_continue_reading_button"),checked:p,onChange:()=>n("showContinueReadingButton",!p)})]})}return null}})},Je=({category:e})=>{const{t:s}=B(),[i,a]=u.useState(!1),{options:o}=z(),l=o.hasDownloadedChapters!=null||o.hasUnreadChapters!=null||o.hasBookmarkedChapters!=null||o.hasDuplicateChapters!=null||Object.values(o.hasStatus).some(r=>r!=null)||Object.values(o.hasTrackerBinding).some(r=>r!=null);return t.jsxs(t.Fragment,{children:[t.jsx(ne,{title:s("settings.title"),children:t.jsx(fe,{onClick:()=>a(!i),color:l?"warning":"inherit",children:t.jsx(we,{})})}),t.jsx($e,{category:e,open:i,onClose:()=>a(!1)})]})},se=({showFilteredOutMessage:e,message:s,messageExtra:i,...a})=>{const{t:o}=B(),{options:l}=z();return u.useLayoutEffect(()=>(document.body.style.overflowY=l.gridLayout===j.List?"auto":"scroll",()=>{document.body.style.overflowY="auto"}),[]),t.jsx(Ne,{gridWrapperProps:{sx:{p:1}},...a,hasNextPage:!1,loadMore:()=>{},message:e?o("library.error.label.no_matches"):s,messageExtra:e?void 0:i,gridLayout:l.gridLayout})},Xe=({isActive:e,areAllItemsSelected:s,areNoItemsSelected:i,onSelectAll:a,onModeChange:o})=>{const{t:l}=B();return t.jsxs(t.Fragment,{children:[e&&t.jsx(Ie,{areAllItemsSelected:s,areNoItemsSelected:i,onChange:a}),t.jsx(ne,{title:l(e?"global.button.cancel":"global.button.select_all"),children:t.jsx(Ke,{checkedIcon:t.jsx(Ge,{}),sx:{padding:"8px",color:"inherit","&.Mui-checked":{color:"inherit"}},checked:e,onChange:(r,n)=>o(n)})})]})},K=(e,s,i)=>{switch(e){case!0:return s();case!1:return i();default:return!0}},D=(e,s)=>K(e,()=>!!s&&s>=1,()=>s===0),ce=(e,s)=>K(e,()=>!!s,()=>!s),M=(e,s)=>{const i=e==null?void 0:e.filter(r=>r!=null),a=s==null?void 0:s.filter(r=>r!=null);if(!(i!=null&&i.length))return!0;const o=i.map(U),l=a.map(U).join(", ");return o.every(r=>l.includes(r))},Ze=(e,{title:s,genre:i,description:a,artist:o,author:l,source:r})=>M([e],[s])||M(e==null?void 0:e.split(","),i.map(n=>U(n)))||M([e],[a])||M([e],[o])||M([e],[l])||M([e],[r==null?void 0:r.displayName]),qe=(e,s)=>Object.entries(e).map(([i,a])=>{const o=s.trackRecords.nodes.some(l=>l.trackerId===Number(i));return K(a,()=>o,()=>!o)}).every(Boolean),et=(e,s)=>Object.entries(e).map(([i,a])=>ce(a,i===s.status)).every(Boolean),tt=(e,{hasDownloadedChapters:s,hasUnreadChapters:i,hasBookmarkedChapters:a,hasDuplicateChapters:o,hasTrackerBinding:l,hasStatus:r})=>D(s,e.downloadCount)&&D(i,e.unreadCount)&&D(a,e.bookmarkCount)&&ce(o,e.hasDuplicateChapters)&&qe(l,e)&&et(r,e),at=(e,s,i)=>{const a=i.ignoreFilters&&(s==null?void 0:s.length);return e.filter(o=>{const l=Ze(s,o),r=a||tt(o,i);return l&&r})},F=(e=0,s=0)=>Number(e)-Number(s),rt=(e,s)=>e.localeCompare(s),st=(e,s,i)=>{const a=[...e];switch(s){case"alphabetically":a.sort((o,l)=>rt(o.title,l.title));break;case"dateAdded":a.sort((o,l)=>F(o.inLibraryAt,l.inLibraryAt));break;case"unreadChapters":a.sort((o,l)=>F(o.unreadCount,l.unreadCount));break;case"lastRead":a.sort((o,l)=>{var r,n;return F((r=o.lastReadChapter)==null?void 0:r.lastReadAt,(n=l.lastReadChapter)==null?void 0:n.lastReadAt)});break;case"latestUploadedChapter":a.sort((o,l)=>{var r,n;return F((r=o.latestUploadedChapter)==null?void 0:r.uploadDate,(n=l.latestUploadedChapter)==null?void 0:n.uploadDate)});break;case"latestFetchedChapter":a.sort((o,l)=>{var r,n;return F((r=o.latestFetchedChapter)==null?void 0:r.fetchedAt,(n=l.latestFetchedChapter)==null?void 0:n.fetchedAt)});break;case"totalChapters":a.sort((o,l)=>F(o.chapters.totalCount,l.chapters.totalCount));break}return i&&a.reverse(),a},ot=(e,s)=>{const[i]=ie("query",_e),a=G(s),{hasUnreadChapters:o,hasDownloadedChapters:l,hasBookmarkedChapters:r,hasTrackerBinding:n,hasDuplicateChapters:C,hasStatus:L}=a,{settings:f}=P(),b=u.useMemo(()=>at(e,i,{...a,ignoreFilters:f.ignoreFilters}),[e,i,o,l,r,n,C,L,f.ignoreFilters]),h=u.useMemo(()=>st(b,a.sortBy,a.sortDesc),[b,a.sortBy,a.sortDesc]),c=Object.values(a.hasTrackerBinding).some(x=>x!=null),p=(o!=null||l!=null||r!=null||!!i||c)&&b.length===0&&e.length>0;return{visibleMangas:h,showFilteredOutMessage:p}},oe=xe("span")({display:"flex",alignItems:"center"}),le=({sx:e,...s})=>t.jsx(Ve,{...s,size:"small",sx:{...e,marginLeft:"5px"}});function Xt(){var q,ee;const{t:e}=B(),{settings:{showTabSize:s}}=P(),{data:i,error:a,loading:o,refetch:l}=N.useGetCategories(ye,{notifyOnNetworkStatusChange:!0}),r=i==null?void 0:i.categories.nodes.filter(d=>d.id!==0||d.id===0&&d.mangas.totalCount),n=r!=null?r:[],C=u.useMemo(()=>n.map(d=>d.mangas.totalCount).reduce((d,m)=>d+m,0),[n]),[L,f]=ie("tab",Me),{setOptions:b}=z(),h=(q=n.find(d=>d.order===L))!=null?q:n[0];u.useLayoutEffect(()=>{b(G(h))},[h]);const{data:c,error:p,loading:x,refetch:w}=N.useGetCategoryMangas(h==null?void 0:h.id,{skip:!h,notifyOnNetworkStatusChange:!0}),v=(ee=c==null?void 0:c.mangas.nodes)!=null?ee:[],{visibleMangas:g,showFilteredOutMessage:W}=ot(v,h),H=u.useCallback(()=>w().catch(ae()),[w,h]),de=u.useMemo(()=>g.map(d=>d.id),[g]),[y,E]=u.useState(!1),{areNoItemsForKeySelected:V,areAllItemsForKeySelected:Y,selectedItemIds:S,handleSelectAll:O,handleSelection:he,clearSelection:pe}=ze(g.length,{itemIds:de,currentKey:h==null?void 0:h.id.toString()}),Q=(d,m,k)=>{E(!!(S.length+(m?1:-1))),he(d,m,k)},$=u.useMemo(()=>S.map(d=>Re.getFromCache(d,Se,"MANGA_CHAPTER_STAT_FIELDS")).filter(d=>!!d),[S.length,g]),J=u.useMemo(()=>y?t.jsx(ve,{selectedItemsCount:S.length,title:"manga.title",children:(d,m)=>t.jsx(Ue,{selectedMangas:$,onClose:()=>{d(),E(!1),pe()},setHideMenu:m})}):null,[y,$]),{setTitle:X,setAction:Z}=u.useContext(je);u.useLayoutEffect(()=>{const d=e("library.title");return X(t.jsxs(oe,{children:[d,s&&t.jsx(le,{sx:{color:"inherit"},label:C})]}),d),Z(t.jsxs(t.Fragment,{children:[!y&&t.jsxs(t.Fragment,{children:[t.jsx(Te,{}),t.jsx(Je,{category:h}),t.jsx(Pe,{categoryId:h==null?void 0:h.id})]}),t.jsx(Xe,{isActive:y,areAllItemsSelected:Y,areNoItemsSelected:V,onSelectAll:k=>O(k,[...new Set(g.map(A=>A.id))]),onModeChange:k=>{E(k),k?O(!0,[...new Set(g.map(A=>A.id))]):n.forEach(A=>O(!1,[],A.id.toString()))}})]})),()=>{X(""),Z(null)}},[e,C,o,y,V,Y,S.length,g.length,h,s]);const ue=d=>{f(d)};return a!=null?t.jsx(re,{message:e("category.error.label.request_failure"),messageExtra:a.message,retry:()=>l().catch(ae())}):o?t.jsx(ke,{}):n.length===0?t.jsx(re,{message:e("library.error.label.empty")}):n.length===1?t.jsxs(t.Fragment,{children:[t.jsx(se,{mangas:g,message:e(p?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:p==null?void 0:p.message,isLoading:x,selectedMangaIds:S,isSelectModeActive:y,handleSelection:Q,showFilteredOutMessage:!p&&W,retry:p&&H}),J]}):t.jsxs(We,{children:[t.jsx(He,{value:h.order,onChange:(d,m)=>ue(m),children:n.map(d=>t.jsx(Fe,{sx:{display:"flex"},label:t.jsxs(oe,{children:[d.name,s?t.jsx(le,{label:d.mangas.totalCount}):null]}),value:d.order},d.id))}),n.map(d=>t.jsx(Le,{index:d.order,currentIndex:h.order,children:d===h&&t.jsx(se,{mangas:g,message:e(p?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:p==null?void 0:p.message,isLoading:x,selectedMangaIds:S,isSelectModeActive:y,handleSelection:Q,showFilteredOutMessage:!p&&W,retry:p&&H})},d.order)),J]})}export{Xt as Library};
