import{r as Ae,i as be,j as e,u as C,M as Ie,L as U,B as D,a as T,T as L,S as de,b as R,c as l,N as V,d as M,e as ve,f as pe,I as xe,g as z,E as G,h as v,m as y,k as Ce,l as _e}from"./index-CcCQevVR.js";import{s as ie,l as X,a as Oe,D as j,e as we}from"./language-CnrakgXN.js";import{t as B,L as he,i as ye,E as m}from"./LangSelect--ui4QMOk.js";import{SourceContentType as $}from"./SourceMangas-ChI6T9RV.js";import{S as K}from"./SpinnerImage-Bxy4Mp8Z.js";import{C as Q}from"./Card-CTCbNoj-.js";import{C as fe}from"./CardActionArea-BO43c0rN.js";import{C as Y}from"./CardContent-D-dG0MuI.js";import{A as J}from"./Avatar-xts1Wbj1.js";import{f as Ue}from"./file-selector-CrHF-rJC.js";import{d as De}from"./Add-C1m1mcfE.js";import{u as Pe,S as ke,A as Re}from"./AppbarSearch-D7gDCYWr.js";import{S as Me,a as Ge,b as me}from"./StyledGroupItemWrapper-DdXotscr.js";import{T as q,a as W}from"./Tabs-DBHcilIZ.js";import{T as Be,a as Fe}from"./TabsMenu-CiUlFNZc.js";import{C as He}from"./Chip-CUbj1W1O.js";import"./FilterList-BC87Z4iI.js";import"./cloneObject-DrOPTG0J.js";import"./Switch-CmQZzvyj.js";import"./SwitchBase-BQJu54st.js";import"./TextField-DlsyrlB4.js";import"./ExpandMore-C0uZIVXW.js";import"./GridLayouts-DOBzwvkJ.js";import"./Checkbox-DtM-KzVx.js";import"./ListPreference-CCb4APVb.js";import"./Delete-CXLsKRjh.js";import"./SortRadioInput-BwWO_3uw.js";import"./CheckboxInput-CNl7YvaR.js";import"./Collapse-C4h6KI5S.js";import"./useDebounce-Bjain5Om.js";import"./InputAdornment-BLbDYZqi.js";import"./ThreeStateCheckboxInput-BmQaFU8x.js";import"./StyledFab-BH96DFxM.js";import"./useManageMangaLibraryState-C5vILkCH.js";import"./Trackers-D4pSmk7a.js";import"./Info-CkxmG1sK.js";import"./CheckCircle-BmyebNpo.js";import"./TypographyMaxLines-CCTwEuv5.js";import"./Link-fNnv42xw.js";import"./NumberSetting-CON6kMdW.js";import"./useMobilePicker-wPl_pciy.js";import"./SelectSetting-VO8p7lUZ.js";import"./Select-BKCPXu5E.js";import"./Mangas-wfnNHRMu.js";import"./Chapters-DdxNJrI9.js";import"./BaseMangaGrid-M8MaDRIi.js";import"./MangaGrid-ClMRK0R1.js";import"./index-CNhL_dkv.js";import"./Sync-ciHWfXmx.js";import"./PlayArrow-CybGthf7.js";var Z={},$e=be;Object.defineProperty(Z,"__esModule",{value:!0});var ge=Z.default=void 0,qe=$e(Ae()),We=e;ge=Z.default=(0,qe.default)((0,We.jsx)("path",{d:"M19.3 16.9c.4-.7.7-1.5.7-2.4 0-2.5-2-4.5-4.5-4.5S11 12 11 14.5s2 4.5 4.5 4.5c.9 0 1.7-.3 2.4-.7l3.2 3.2 1.4-1.4zm-3.8.1c-1.4 0-2.5-1.1-2.5-2.5s1.1-2.5 2.5-2.5 2.5 1.1 2.5 2.5-1.1 2.5-2.5 2.5M12 20v2C6.48 22 2 17.52 2 12S6.48 2 12 2c4.84 0 8.87 3.44 9.8 8h-2.07c-.64-2.46-2.4-4.47-4.73-5.41V5c0 1.1-.9 2-2 2h-2v2c0 .55-.45 1-1 1H8v2h2v3H9l-4.79-4.79C4.08 10.79 4 11.38 4 12c0 4.41 3.59 8 8 8"}),"TravelExplore");const Ve=s=>{const{t}=C(),n=Ie.useIsMobileWidth(),{source:{id:o,name:c,lang:r,iconUrl:h,supportsLatest:f,isNsfw:E,extension:{repo:i}},showSourceRepo:S}=s;return e.jsx(Q,{sx:{margin:1,marginTop:0},children:e.jsx(fe,{component:U,to:"/sources/".concat(o),state:{contentType:$.POPULAR,clearCache:!0},children:e.jsxs(Y,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:1.5},children:[e.jsxs(D,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(J,{variant:"rounded",alt:c,sx:{width:56,height:56,flex:"0 0 auto",mr:1,background:"transparent"},children:e.jsx(K,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:c,src:T.getValidImgUrlFor(h)})}),e.jsxs(D,{sx:{display:"flex",flexDirection:"column",justifyContent:"center"},children:[e.jsx(L,{variant:"h6",component:"h3",children:c}),o!=="0"&&e.jsxs(L,{variant:"caption",sx:{display:"block"},children:[B(r),E&&e.jsx(L,{variant:"caption",color:"error",sx:{display:"inline"},children:" 18+"}),S&&e.jsx(L,{variant:"caption",sx:{display:"block"},children:i})]})]})]}),e.jsxs(de,{sx:{flexDirection:"row",gap:1},children:[f&&e.jsx(R,{variant:"outlined",component:U,to:"/sources/".concat(o),state:{contentType:$.LATEST,clearCache:!0},children:t("global.button.latest")}),!n&&e.jsx(R,{variant:"outlined",component:U,to:"/sources/".concat(o),state:{contentType:$.POPULAR,clearCache:!0},children:t("global.button.popular")})]})]})})})};function ze(s){const t=[];return s.forEach(n=>{t.indexOf(n.lang)===-1&&t.push(n.lang)}),t.sort(X),t}function Xe(s){const t={};return s.forEach(n=>{t[n.lang]===void 0&&(t[n.lang]=[]),t[n.lang].push(n)}),t}function Ke(){const{t:s}=C(),{setAction:t}=l.useContext(V),[n,o]=M("shownSourceLangs",Oe()),[c]=M("showNsfw",!0),{data:r,loading:h,error:f,refetch:E}=T.useGetSourceList({notifyOnNetworkStatusChange:!0}),i=r==null?void 0:r.sources.nodes,S=l.useMemo(()=>{if(!i||i!=null&&i.length)return!1;const{repo:d}=i[0].extension;return i.some(x=>x.extension.repo!==d)},[i]),_=ve();return l.useEffect(()=>{ie().forEach(d=>{let x=!1;n.forEach(p=>{p===d&&(x=!0)}),x||o(p=>(p.push(d),p))})},[]),l.useEffect(()=>(t(e.jsxs(e.Fragment,{children:[e.jsx(pe,{title:s("search.title.global_search"),children:e.jsx(xe,{onClick:()=>_("/sources/all/search/"),size:"large",color:"inherit",children:e.jsx(ge,{})})}),e.jsx(he,{shownLangs:n,setShownLangs:o,allLangs:ze(i!=null?i:[]),forcedLangs:ie()})]})),()=>{t(null)}),[s,n,i]),h?e.jsx(z,{}):f?e.jsx(G,{message:s("global.error.label.failed_to_load_data"),messageExtra:f.message,retry:()=>E().catch(v())}):(i==null?void 0:i.length)===0?e.jsx(G,{message:s("source.error.label.no_sources_found")}):e.jsx(e.Fragment,{children:Object.entries(Xe(i!=null?i:[])).sort((d,x)=>X(d[0],x[0])).map(([d,x])=>n.indexOf(d)!==-1&&e.jsxs(l.Fragment,{children:[e.jsx(L,{variant:"h5",component:"h2",sx:{paddingLeft:3,paddingTop:1,paddingBottom:2,fontWeight:"bold"},children:B(d)},d),x.filter(p=>c||!p.isNsfw).map(p=>e.jsx(Ve,{source:p,showSourceRepo:S},p.id))]},d))})}var Le=(s=>(s.UPDATE="UPDATE",s.UNINSTALL="UNINSTALL",s.INSTALL="INSTALL",s))(Le||{}),Ee=(s=>(s.OBSOLETE="OBSOLETE",s.UPDATING="UPDATING",s.UNINSTALLING="UNINSTALLING",s.INSTALLING="INSTALLING",s))(Ee||{});const g={...Le,...Ee},Qe={UPDATE:"UPDATING",UNINSTALL:"UNINSTALLING",INSTALL:"INSTALLING"},Ye={UPDATE:"UNINSTALL",UNINSTALL:"INSTALL",INSTALL:"UNINSTALL"},Je={[g.UNINSTALL]:"extension.action.label.uninstall",[g.INSTALL]:"extension.action.label.install",[g.UPDATE]:"extension.action.label.update",[g.OBSOLETE]:"extension.state.label.obsolete",[g.UPDATING]:"extension.state.label.updating",[g.UNINSTALLING]:"extension.state.label.uninstalling",[g.INSTALLING]:"extension.state.label.installing"},Ze={UPDATE:"extension.label.update_failed",INSTALL:"extension.label.installation_failed",UNINSTALL:"extension.label.uninstallation_failed"},le=(s,t,n)=>t?g.OBSOLETE:n?g.UPDATE:s?g.UNINSTALL:g.INSTALL;function et(s){const{t}=C(),{extension:{name:n,lang:o,versionName:c,isInstalled:r,hasUpdate:h,isObsolete:f,pkgName:E,iconUrl:i,isNsfw:S,repo:_},handleUpdate:d,showSourceRepo:x}=s,[p,O]=l.useState(le(r,f,h)),P=o==="all"?t("extension.language.all"):o.toUpperCase(),I=async A=>{const N=Ye[A],k=Qe[A];try{switch(O(k),A){case"INSTALL":await T.updateExtension(E,{install:!0,isObsolete:f}).response;break;case"UNINSTALL":await T.updateExtension(E,{uninstall:!0,isObsolete:f}).response;break;case"UPDATE":await T.updateExtension(E,{update:!0,isObsolete:f}).response;break;default:throw new Error('Unexpected ExtensionAction "'.concat(A,'"'))}O(N),d()}catch(H){O(le(r,f,h)),y(t(Ze[A]),"error")}};function F(){switch(p){case"INSTALL":case"UPDATE":case"UNINSTALL":I(p).catch(v());break;case"OBSOLETE":I("UNINSTALL").catch(v());break}}return e.jsx(Q,{children:e.jsxs(Y,{sx:{display:"flex",alignItems:"center",gap:1,p:1.5,"&:last-child":{paddingBottom:1.5}},children:[e.jsx(J,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",background:"transparent"},alt:n,children:e.jsx(K,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:n,src:T.getValidImgUrlFor(i)})}),e.jsxs(D,{sx:{display:"flex",flexDirection:"column",flexGrow:1,flexShrink:1,wordBreak:"break-word",justifyContent:"center"},children:[e.jsx(L,{variant:"h6",component:"h3",children:n}),e.jsxs(L,{variant:"caption",sx:{display:"block"},children:[P," ",c,S&&e.jsx(L,{variant:"caption",color:"error",sx:{display:"inline"},children:" 18+"})]}),x&&e.jsx(L,{variant:"caption",sx:{display:"block"},children:_})]}),e.jsx(R,{variant:"outlined",sx:{color:p===g.OBSOLETE?"red":"inherit",flexShrink:0},onClick:()=>F(),children:t(Je[p])})]})})}const ce=0,ue=1;function tt(s){const t=[],n={[m.OBSOLETE]:[],[m.INSTALLED]:[],[m.UPDATE_PENDING]:[],[j.ALL]:[],[j.OTHER]:[],[j.LOCAL_SOURCE]:[]};s.forEach(r=>{if(n[r.lang]===void 0&&(n[r.lang]=[],r.lang!=="all"&&t.push(r.lang)),r.isInstalled){if(r.hasUpdate){n[m.UPDATE_PENDING].push(r);return}if(r.isObsolete){n[m.OBSOLETE].push(r);return}n[m.INSTALLED].push(r)}else n[r.lang].push(r)}),t.sort(X);const o=[[m.OBSOLETE,n[m.OBSOLETE]],[m.UPDATE_PENDING,n[m.UPDATE_PENDING]],[m.INSTALLED,n[m.INSTALLED]],[j.ALL,n[j.ALL]],[j.OTHER,n[j.OTHER]],[j.LOCAL_SOURCE,n[j.LOCAL_SOURCE]]],c=t.map(r=>[r,n[r]]);return{allLangs:t,groupedExtensions:o.concat(c)}}function nt({tabsMenuHeight:s}){var oe,ae;const{t}=C(),{setAction:n}=l.useContext(V),{data:o,loading:c,error:r,refetch:h}=T.useGetServerSettings({notifyOnNetworkStatusChange:!0}),f=!!(o!=null&&o.settings.extensionRepos.length),E=((oe=o==null?void 0:o.settings.extensionRepos.length)!=null?oe:0)>1,i=l.useRef(null),[S,_]=M("shownExtensionLangs",we()),[d]=M("showNsfw",!0),[x]=Pe("query",ke),[p,O]=l.useState({}),[P,{data:I,loading:F,error:A}]=T.useExtensionListFetch(),N=(ae=I==null?void 0:I.fetchExtensions)==null?void 0:ae.extensions,k=l.useCallback(()=>O({}),[]);l.useEffect(()=>{P()},[p]);const H=l.useMemo(()=>(N!=null?N:[]).filter(a=>{const u=d||!a.isNsfw;return x?u&&a.name.toLowerCase().includes(x.toLowerCase()):u}),[N,d,x]),{allLangs:ee,groupedExtensions:te}=l.useMemo(()=>tt(H),[H]),w=l.useMemo(()=>te.filter(a=>a[ue].length>0).filter(a=>ye(a[ce])||S.includes(a[ce])),[S,te]),Te=l.useMemo(()=>w.map(a=>a[ue].length),[w]),Se=l.useMemo(()=>w.map(([,a])=>a).flat(1),[w]),ne=a=>{a.name.toLowerCase().endsWith("apk")?(i.current&&(i.current.value=""),y(t("extension.label.installing_file"),"info"),T.installExternalExtension(a).response.then(()=>{k(),y(t("extension.label.installed_successfully"),"success")}).catch(()=>y(t("extension.label.installation_failed"),"error"))):y(t("global.error.label.invalid_file_type"),"error")};l.useEffect(()=>(n(e.jsxs(e.Fragment,{children:[e.jsx(Re,{}),e.jsx(pe,{title:t("extension.action.label.install_external"),children:e.jsx(xe,{onClick:()=>{var a;return(a=i.current)==null?void 0:a.click()},size:"large",color:"inherit",children:e.jsx(De,{})})}),e.jsx(he,{shownLangs:S,setShownLangs:_,allLangs:ee})]})),()=>{n(null)}),[t,S,ee]),l.useEffect(()=>{const a=async b=>{b.preventDefault();const je=await Ue(b);ne(je[0])},u=b=>{b.preventDefault()};return document.addEventListener("drop",a),document.addEventListener("dragover",u),()=>{document.removeEventListener("drop",a),document.removeEventListener("dragover",u)}},[]);const se=l.useMemo(()=>e.jsx("input",{type:"file",style:{display:"none"},ref:i,onChange:a=>{var b;const u=(b=a.target.files)==null?void 0:b[0];u&&ne(u)}}),[]),Ne=c||F,re=r!=null?r:A;return Ne?e.jsx(z,{}):re?e.jsx(G,{message:t("global.error.label.failed_to_load_data"),messageExtra:re.message,retry:()=>{r&&h().catch(v()),A&&P().catch(v())}}):!(N!=null&&N.length)&&!f?e.jsxs(e.Fragment,{children:[se,e.jsxs(de,{sx:{alignItems:"center",justifyContent:"center",rowGap:"10px",paddingTop:"20px"},children:[e.jsx(L,{children:t("extension.label.add_repository_info")}),e.jsx(R,{component:U,variant:"contained",to:"/settings/browseSettings",children:t("settings.title")})]})]}):e.jsxs(e.Fragment,{children:[se,e.jsx(Me,{heightToSubtract:s,overscan:window.innerHeight*.5,groupCounts:Te,groupContent:a=>{const[u]=w[a];return e.jsx(Ge,{variant:"h5",component:"h2",isFirstItem:a===0,children:B(u)},u)},itemContent:a=>{const u=Se[a];return e.jsx(me,{children:e.jsx(et,{extension:u,handleUpdate:k,showSourceRepo:E})},"".concat(u.pkgName,"_").concat(u.isInstalled,"_").concat(u.isObsolete,"_").concat(u.hasUpdate))}})]})}const st=({id:s,name:t,lang:n,iconUrl:o,mangaCount:c})=>e.jsx(Q,{children:e.jsx(fe,{component:U,to:"/migrate/source/".concat(s,"/"),children:e.jsxs(Y,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",p:1.5},children:[e.jsxs(D,{sx:{display:"flex"},children:[e.jsx(J,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",mr:1,background:"transparent"},children:e.jsx(K,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:t,src:T.getValidImgUrlFor(o)})}),e.jsxs(D,{sx:{display:"flex",flexDirection:"column",justifyContent:"center"},children:[e.jsx(L,{variant:"h6",component:"h3",children:t}),e.jsx(L,{variant:"caption",sx:{display:"block"},children:B(n)})]})]}),e.jsx(He,{sx:{borderRadius:1},size:"small",label:c})]})})}),rt=s=>{if(!s)return{};const t={};return s.forEach(({sourceId:n,source:o})=>{var r;const c=(r=t[n])!=null?r:{id:n,name:n,lang:"unknown",iconUrl:null,mangaCount:0,...o};t[n]={...c,mangaCount:c.mangaCount+1}}),t},ot=()=>{const{t:s}=C(),{data:t,loading:n,error:o,refetch:c}=T.useGetMigratableSources({notifyOnNetworkStatusChange:!0}),r=l.useMemo(()=>rt(t==null?void 0:t.mangas.nodes),[t==null?void 0:t.mangas.nodes]);return n?e.jsx(z,{}):o?e.jsx(G,{message:s("global.error.label.failed_to_load_data"),messageExtra:o.message,retry:()=>c().catch(v())}):e.jsx(Ce,{children:Object.values(r).map(h=>e.jsx(me,{children:e.jsx(st,{...h})},h.id))})};function sn(){const{t:s}=C(),{setTitle:t}=l.useContext(V),n=l.useRef(null),[o,c]=l.useState(0);_e(n,l.useCallback(()=>c(n.current.offsetHeight),[n.current]));const[r,h]=l.useState(0);return l.useEffect(()=>{t(s("global.label.browse"))},[s]),e.jsxs(Be,{children:[e.jsxs(Fe,{ref:n,variant:"fullWidth",value:r,tabsCount:2,onChange:(f,E)=>h(E),children:[e.jsx(q,{sx:{textTransform:"none"},label:s("source.title_one")}),e.jsx(q,{sx:{textTransform:"none"},label:s("extension.title_other")}),e.jsx(q,{sx:{textTransform:"none"},label:s("migrate.title")})]}),e.jsx(W,{index:0,currentIndex:r,children:e.jsx(Ke,{})}),e.jsx(W,{index:1,currentIndex:r,children:e.jsx(nt,{tabsMenuHeight:o})}),e.jsx(W,{index:2,currentIndex:r,children:e.jsx(ot,{})})]})}export{sn as Browse};
