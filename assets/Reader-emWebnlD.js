import{c as r,l as ye,j as t,B as H,r as le,i as de,F as at,ao as Pt,ap as yt,aq as Et,ar as bt,as as Ke,x as ue,u as st,A as Lt,e as ot,at as it,au as St,av as Dt,aw as ne,f as ae,I as se,T as kt,ax as jt,a3 as Tt,ay as _t,a1 as qe,az as Nt,a4 as At,a as ee,aA as Ot,aB as Ge,p as Ue,N as It,m as Ye,h as U,M as Mt,a6 as $t,E as Ze,aC as Wt,aD as zt}from"./index-DRMCCeoY.js";import{b as Y,C as A}from"./Chapters-BF9azHJT.js";import{P as he,R as Bt,u as Ft,g as Qe,c as Ht}from"./ReaderSettingsOptions-Bh6kPOKa.js";import{S as Je}from"./Select-yKstr75i.js";import{C as Vt}from"./CustomIconButton-Cz42V2iV.js";import{C as Xt}from"./Collapse-jkk2DTox.js";import{a as et}from"./TextField-C00KWYJ7.js";import{u as Kt}from"./useDebounce-BlxkxYf5.js";import"./NumberSetting-7ZnPu6vC.js";import"./Info-DM8VcukM.js";import"./InputAdornment-D6sgKKlS.js";import"./SpinnerImage-Bb6iXLNY.js";import"./Switch-Cd_DFV58.js";import"./SwitchBase-DbWKMhI0.js";const qt=a=>{for(let c=0;c<a.children.length;c++){const i=a.children.item(c);if(i){const{left:g,right:d}=i.getBoundingClientRect();if(g<=window.innerWidth/2&&d>window.innerWidth/2)return c}}return-1},Gt=5,Ut=()=>window.innerWidth+window.scrollX>=document.body.scrollWidth-Gt,Yt=()=>window.scrollX<=0;function Zt(a){const{pages:c,curPage:i,initialPage:g,settings:d,setCurPage:p,prevChapter:L,nextChapter:v}=a,f=r.useRef(g),o=r.useRef(null),x=r.useRef([]);function E(){var e;i<c.length-1?((e=x.current[i+1])==null||e.scrollIntoView({inline:"center"}),p(u=>u+1)):d.loadNextOnEnding&&v()}function l(){var e;i>0?((e=x.current[i-1])==null||e.scrollIntoView({inline:"center"}),p(i-1)):i===0&&L()}function b(){d.readerType==="ContinuesHorizontalLTR"?l():E()}function T(){d.readerType==="ContinuesHorizontalLTR"?E():l()}const y=r.useRef(0);function n(e){window.scrollBy(y.current-e.pageX,0)}function s(e){var u;y.current=e.pageX,(u=o.current)==null||u.addEventListener("mousemove",n)}function P(){var e;(e=o.current)==null||e.removeEventListener("mousemove",n)}function O(e){e.clientX>=window.innerWidth*.85?T():e.clientX<=window.innerWidth*.15&&b()}function N(e){window.scrollBy({left:d.readerType==="ContinuesHorizontalLTR"?e.deltaY:e.deltaY*-1})}const R=()=>{d.readerType==="ContinuesHorizontalLTR"?window.scrollX+window.innerWidth>=document.body.scrollWidth&&v():d.readerType==="ContinuesHorizontalRTL"&&window.scrollX<=window.innerWidth&&v()};return ye(x.current[g],r.useCallback((e,u)=>{const w=x.current[g];w!=null&&w.offsetHeight&&(w.scrollIntoView({inline:"center"}),u.disconnect())},[x.current[g],g])),r.useEffect(()=>{var e,u;return(e=o.current)==null||e.addEventListener("mousedown",s),(u=o.current)==null||u.addEventListener("mouseup",P),()=>{var w,I;(w=o.current)==null||w.removeEventListener("mousedown",s),(I=o.current)==null||I.removeEventListener("mouseup",P)}},[o]),r.useEffect(()=>(d.loadNextOnEnding&&document.addEventListener("scroll",R),()=>{document.removeEventListener("scroll",R)}),[o,i,L,v]),r.useEffect(()=>{const e=()=>{if(!o.current)return;const u=qt(o.current);u!==f.current&&(f.current=u,p(u)),(d.readerType==="ContinuesHorizontalLTR"?Ut():Yt())&&(f.current=c.length-1,p(f.current))};return window.addEventListener("scroll",e),()=>window.removeEventListener("scroll",e)},[d.readerType]),t.jsx(H,{ref:o,sx:{display:"flex",flexDirection:d.readerType==="ContinuesHorizontalLTR"?"row":"row-reverse",justifyContent:d.readerType==="ContinuesHorizontalLTR"?"flex-start":"flex-end",width:"auto",height:"auto",overflowX:"visible",userSelect:"none"},onClick:O,onWheel:N,children:c.map(e=>t.jsx(he,{index:e.index,src:e.src,onImageLoad:()=>{},settings:d,ref:u=>{x.current[e.index]=u}},e.index))})}function Qt(a){const{settings:c,curPage:i,pageCount:g}=a;return t.jsx(H,{sx:{display:c.showPageNumber?"block":"none",position:"fixed",bottom:"50px",padding:"2px",paddingLeft:"4px",paddingRight:"4px",textAlign:"center",backgroundColor:"rgba(0, 0, 0, 0.3)",borderRadius:"10px"},children:"".concat(i+1," / ").concat(g)})}function Jt(a){const{pages:c,settings:i,setCurPage:g,initialPage:d,curPage:p,nextChapter:L,prevChapter:v}=a,f=r.useRef(null),o=n=>{g(n),window.scroll({top:0})};function x(){p<c.length-1?o(p+1):i.loadNextOnEnding&&L()}function E(){p>0?o(p-1):v()}function l(){i.readerType==="SingleLTR"?E():i.readerType==="SingleRTL"&&x()}function b(){i.readerType==="SingleLTR"?x():i.readerType==="SingleRTL"&&E()}function T(n){switch(n.key){case"Space":n.preventDefault(),x();break;case"ArrowRight":b();break;case"ArrowLeft":l();break}}function y(n){n.clientX>window.innerWidth/2?b():l()}return r.useEffect(()=>(document.addEventListener("keydown",T),()=>{document.removeEventListener("keydown",T)}),[f,p,i.readerType,v,L]),r.useEffect(()=>{setTimeout(()=>{o(d)},0)},[d]),t.jsx(H,{ref:f,sx:{display:"flex",flexDirection:"column",justifyContent:"center",width:"auto",height:"auto"},onClick:y,children:c.map(({index:n,src:s})=>t.jsx(he,{index:n,onImageLoad:()=>{},src:s,settings:i,display:n===p},s))})}const er=a=>a.height/a.width<1;function tr(a){const{pages:c,settings:i,setCurPage:g,initialPage:d,curPage:p,nextChapter:L,prevChapter:v}=a,f=r.useRef(null),o=r.useRef([]),x=r.useRef([]),[E,l]=r.useState(Array(c.length).fill(!1)),[b,T]=r.useState(Array(c.length).fill(!1));function y(){const R=w=>g(w===-1?c.length-1:w);if(o.current[c.length-1]&&i.loadNextOnEnding){p===c.length-1||R(c.length-1),L();return}const u=o.current.findIndex((w,I)=>!w&&I>p);R(u)}function n(){const R=w=>g(Math.max(w,0));if(o.current[0]){!p||R(0),v();return}const u=[...o.current].slice(0,p).findLastIndex(w=>!w);R(u)}function s(){i.readerType==="DoubleLTR"?n():y()}function P(){i.readerType==="DoubleLTR"?y():n()}function O(R){switch(R.key){case"Space":R.preventDefault(),y();break;case"ArrowRight":P();break;case"ArrowLeft":s();break}}function N(R){R.clientX>window.innerWidth/2?P():s()}return r.useEffect(()=>(document.addEventListener("keydown",O),()=>{document.removeEventListener("keydown",O)}),[f,p,i.readerType,v,L,b,E]),r.useEffect(()=>{g(d)},[d]),t.jsx(H,{ref:f,onClick:N,children:t.jsx(H,{id:"display",sx:{display:"flex",flexDirection:i.readerType==="DoubleLTR"?"row":"row-reverse",justifyContent:"center",width:"auto",height:"auto"},children:c.map(({index:R,src:e})=>{const u=(()=>{let k=x.current[p];return k===void 0&&(k=Math.max(E.lastIndexOf(!0,p),0),b.slice(0,p).every(Boolean)&&(x.current[p]=k)),k>0?k+1:k})(),w=p-u,I=p===0,F=Number(i.offsetFirstPage)+Number(i.offsetFirstPage&&!w&&!I),$=!((w-F)%2),X=p+($?1:-1),h=R===p,S=R===X,M=E[p],W=E[X],_=h||S&&!(M||W);return o.current[R]=_,t.jsx(he,{index:R,src:e,onImageLoad:()=>{const k=new Image;k.onload=()=>{T(K=>K.toSpliced(R,1,!0)),l(K=>K.toSpliced(R,1,er(k)))},k.src=e},settings:i,display:_},e)})})})}const rr=a=>{for(let c=0;c<a.children.length;c++){const i=a.children.item(c);if(i){const{top:g,bottom:d}=i.getBoundingClientRect();if(g<=window.innerHeight&&d>1)return c}}return-1},nr=5,ar=.95,tt=.25,sr="smooth",rt=()=>window.innerHeight+window.scrollY>=document.body.offsetHeight-nr,or=()=>window.scrollY<=0;function nt(a){const{pages:c,settings:i,setCurPage:g,initialPage:d,nextChapter:p,prevChapter:L}=a,v=r.useRef(d),f=r.useRef(null),o=r.useRef([]);r.useEffect(()=>{let n=!1;const s=()=>{if(f.current)if(rt()){if(n)return;n=!0,v.current=c.length-1,g(v.current),i.loadNextOnEnding&&p()}else{n=!1;const P=rr(f.current);P!==v.current&&(v.current=P,g(P))}};return window.addEventListener("scroll",s),()=>{window.removeEventListener("scroll",s)}},[i.loadNextOnEnding,p]);const x=r.useRef(0),E=r.useRef(!1);function l(n){E.current=!0,window.scrollBy(0,x.current-n.pageY)}function b(n){var s;x.current=n.pageY,(s=f.current)==null||s.addEventListener("mousemove",l)}function T(){var n;(n=f.current)==null||n.removeEventListener("mousemove",l)}r.useEffect(()=>{var n,s;return(n=f.current)==null||n.addEventListener("mousedown",b),(s=f.current)==null||s.addEventListener("mouseup",T),()=>{var P,O;(P=f.current)==null||P.removeEventListener("mousedown",b),(O=f.current)==null||O.removeEventListener("mouseup",T)}},[f]);const y=r.useCallback((n,s=ar)=>{if(n==="down"&&rt()){p();return}if(n==="up"&&or()){L();return}window.scroll({top:window.scrollY+window.innerHeight*s*(n==="up"?-1:1),behavior:sr})},[p,L]);return r.useEffect(()=>{const n=s=>{switch(s.key){case"Space":s.preventDefault(),y(s.shiftKey?"up":"down");break;case"ArrowDown":s.preventDefault(),y(s.shiftKey?"up":"down",tt);break;case"ArrowRight":s.preventDefault(),y(s.shiftKey?"up":"down");break;case"ArrowUp":s.preventDefault(),y(s.shiftKey?"down":"up",tt);break;case"ArrowLeft":s.preventDefault(),y(s.shiftKey?"down":"up");break}};return document.addEventListener("keydown",n,!1),()=>{document.removeEventListener("keydown",n)}},[y]),ye(o.current[d],r.useCallback((n,s)=>{const P=o.current[d];P!=null&&P.offsetHeight&&(P.scrollIntoView(),s.disconnect())},[o.current[d],d])),t.jsx(H,{ref:f,sx:{display:"flex",flexDirection:"column",justifyContent:"center",width:"auto",height:"auto",userSelect:"none"},onClick:n=>{if(E.current){E.current=!1;return}y(n.clientX>window.innerWidth/2?"down":"up")},children:c.map(n=>t.jsx(he,{index:n.index,src:n.src,onImageLoad:()=>{},settings:i,ref:s=>{o.current[n.index]=s}},n.index))})}var Ee={},ir=de;Object.defineProperty(Ee,"__esModule",{value:!0});var ct=Ee.default=void 0,cr=ir(le()),lr=t;ct=Ee.default=(0,cr.default)((0,lr.jsx)("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Close");var be={},dr=de;Object.defineProperty(be,"__esModule",{value:!0});var ie=be.default=void 0,ur=dr(le()),pr=t;ie=be.default=(0,ur.default)((0,pr.jsx)("path",{d:"M15.41 16.59 10.83 12l4.58-4.59L14 6l-6 6 6 6z"}),"KeyboardArrowLeft");var Le={},fr=de;Object.defineProperty(Le,"__esModule",{value:!0});var ce=Le.default=void 0,gr=fr(le()),hr=t;ce=Le.default=(0,gr.default)((0,hr.jsx)("path",{d:"M8.59 16.59 13.17 12 8.59 7.41 10 6l6 6-6 6z"}),"KeyboardArrowRight");var Se={},xr=de;Object.defineProperty(Se,"__esModule",{value:!0});var lt=Se.default=void 0,mr=xr(le()),Cr=t;lt=Se.default=(0,mr.default)((0,Cr.jsx)("path",{d:"M7.41 8.59 12 13.17l4.59-4.58L18 10l-6 6-6-6z"}),"KeyboardArrowDown");var De={},vr=de;Object.defineProperty(De,"__esModule",{value:!0});var dt=De.default=void 0,wr=vr(le()),Rr=t;dt=De.default=(0,wr.default)((0,Rr.jsx)("path",{d:"M7.41 15.41 12 10.83l4.59 4.58L18 14l-6-6-6 6z"}),"KeyboardArrowUp");const Pr={entering:{transform:"none"},entered:{transform:"none"}},yr=r.forwardRef(function(c,i){const g=at(),d={enter:g.transitions.duration.enteringScreen,exit:g.transitions.duration.leavingScreen},{addEndListener:p,appear:L=!0,children:v,easing:f,in:o,onEnter:x,onEntered:E,onEntering:l,onExit:b,onExited:T,onExiting:y,style:n,timeout:s=d,TransitionComponent:P=Et,...O}=c,N=r.useRef(null),R=Pt(N,yt(v),i),e=h=>S=>{if(h){const M=N.current;S===void 0?h(M):h(M,S)}},u=e(l),w=e((h,S)=>{bt(h);const M=Ke({style:n,timeout:s,easing:f},{mode:"enter"});h.style.webkitTransition=g.transitions.create("transform",M),h.style.transition=g.transitions.create("transform",M),x&&x(h,S)}),I=e(E),F=e(y),V=e(h=>{const S=Ke({style:n,timeout:s,easing:f},{mode:"exit"});h.style.webkitTransition=g.transitions.create("transform",S),h.style.transition=g.transitions.create("transform",S),b&&b(h)}),$=e(T),X=h=>{p&&p(N.current,h)};return t.jsx(P,{appear:L,in:o,nodeRef:N,onEnter:w,onEntered:I,onEntering:u,onExit:V,onExited:$,onExiting:F,addEndListener:X,timeout:s,...O,children:(h,S)=>r.cloneElement(v,{style:{transform:"scale(0)",visibility:h==="exited"&&!o?"hidden":void 0,...Pr[h],...n,...v.props.style},ref:R,...S})})}),Er=ue("div")({zIndex:10}),br=ue("div")(({theme:a})=>({position:"fixed",top:0,left:0,minWidth:"240px",maxWidth:"400px",height:"100vh",overflowY:"auto",backgroundColor:a.palette.background.default,"& header":{backgroundColor:a.palette.action.hover,display:"flex",alignItems:"center",padding:"".concat(a.spacing(1)," ").concat(a.spacing(3)),transition:"left 2s ease"}})),Lr=ue("div")(({theme:a})=>({margin:"0 ".concat(a.spacing(2))})),Sr=ue("div")({display:"flex",flexWrap:"wrap",alignContent:"center",alignItems:"center",justifyContent:"center"}),Dr=ue("div")(({theme:a})=>({display:"grid",gridTemplateRows:"auto auto auto",gridTemplateColumns:"0fr 1fr 0fr",gridTemplateAreas:'"pre current next"',gridColumnGap:a.spacing(.5),margin:"".concat(a.spacing(1)," 0"),"& a":{textDecoration:"none",color:"inherit",display:"flex",flexWrap:"wrap",alignContent:"center"}}));function kr(a){var q;const{t:c}=st(),{setReaderNavBarWidth:i}=Lt(),g=at(),d=ot(),p=it(),{prevDrawerOpen:L,prevSettingsCollapseOpen:v}=(q=p.state)!=null?q:{},f=r.useRef(null);ye(f,r.useCallback(()=>{var m;((m=f.current)==null?void 0:m.offsetWidth)!==void 0&&i(f.current.offsetWidth)},[f.current])),r.useLayoutEffect(()=>()=>i(0),[f]);const{settings:o,setSettingValue:x,manga:E,chapter:l,chapters:b,curPage:T,scrollToPage:y,openNextChapter:n,retrievingNextChapter:s}=a,P=St(),O=r.useMemo(()=>new Set(b.map(({scanlator:m})=>m)).size>1,[b]),[N,R]=r.useState(o.staticNav||L),[e,u]=r.useState(!0),[w,I]=r.useState(o.staticNav||L),[F,V]=r.useState(0),[$,X]=r.useState(v!=null?v:!0),h=s,S=(m,_,k)=>{u(m!=="staticNav"),x(m,_,k)},M=m=>{R(m),I(m)},W=()=>{const m=window.pageYOffset;Math.abs(m-F)>20&&(I(m>F),V(m))};return r.useEffect(()=>{e&&M(o.staticNav)},[o.staticNav]),r.useEffect(()=>{window.addEventListener("scroll",W);const m=document.querySelector("#root"),_=document.querySelector("#appMainContainer");return m.style.display="flex",m.style.flexDirection="column",_.style.display="none",()=>{m.style.display="block",_.style.display="block",window.removeEventListener("scroll",W)}},[W]),t.jsxs(Er,{children:[t.jsx(Dt,{direction:ne("right","left"),in:N,timeout:200,appear:!1,mountOnEnter:!0,unmountOnExit:!0,children:t.jsxs(br,{ref:f,children:[t.jsxs("header",{children:[!o.staticNav&&t.jsx(ae,{title:c("reader.button.close_menu"),children:t.jsx(se,{edge:"start",color:"inherit","aria-label":"menu",onClick:()=>M(!1),size:"large",children:ne(t.jsx(ie,{}),t.jsx(ce,{}))})}),t.jsx(kt,{variant:"h6",component:"h1",sx:{textOverflow:"ellipsis",overflow:"hidden",py:1,flexGrow:1},children:l.name}),t.jsx(ae,{title:c("reader.button.exit"),children:t.jsx(se,{edge:"start",color:"inherit","aria-label":"menu",onClick:P,size:"large",sx:{mr:-1},children:t.jsx(ct,{})})})]}),t.jsxs(jt,{ContainerComponent:"div",sx:{"& span":{fontWeight:"bold"}},children:[t.jsx(Tt,{primary:c("reader.settings.title.reader_settings")}),t.jsxs(se,{edge:"start",color:"inherit","aria-label":"menu",disableRipple:!0,disableFocusRipple:!0,onClick:()=>X(!$),size:"large",children:[$&&t.jsx(dt,{}),!$&&t.jsx(lt,{})]})]}),t.jsx(Xt,{in:$,timeout:"auto",unmountOnExit:!0,children:t.jsx(Bt,{setSettingValue:S,staticNav:o.staticNav,showPageNumber:o.showPageNumber,loadNextOnEnding:o.loadNextOnEnding,skipDupChapters:o.skipDupChapters,fitPageToWindow:o.fitPageToWindow,scalePage:o.scalePage,readerType:o.readerType,offsetFirstPage:o.offsetFirstPage,readerWidth:o.readerWidth})}),t.jsx(_t,{sx:{my:1,mx:2}}),t.jsxs(Lr,{children:[t.jsxs(Sr,{children:[t.jsx("span",{children:c("reader.page_info.label.currently_on_page")}),t.jsx(et,{size:"small",sx:{mx:.5},disabled:h||l.pageCount===-1,children:t.jsx(Je,{value:l.pageCount>-1?"".concat(T):"",displayEmpty:!0,onChange:({target:{value:m}})=>{y(Number(m))},children:Array(Math.max(0,l.pageCount)).fill(1).map((m,_)=>t.jsx(qe,{value:_,children:_+1},"Page#".concat(_)))})}),t.jsx("span",{children:c("reader.page_info.label.of_max_pages",{maxPages:l.pageCount})})]}),t.jsxs(Dr,{children:[t.jsx(ae,{title:c("reader.button.previous_chapter"),children:t.jsx(se,{sx:{gridArea:"pre"},disabled:h||l.sourceOrder<=1,onClick:()=>n(Y.PREV),children:ne(t.jsx(ie,{}),t.jsx(ce,{}))})}),t.jsx(et,{sx:{gridArea:"current"},size:"small",disabled:h||l.sourceOrder<1,children:t.jsx(Je,{value:l.sourceOrder>=1?"".concat(l.sourceOrder):"",displayEmpty:!0,onChange:({target:{value:m}})=>{d("/manga/".concat(E.id,"/chapter/").concat(m),{replace:!0,state:{prevDrawerOpen:N,prevSettingsCollapseOpen:$}})},children:b.map(({id:m,sourceOrder:_,name:k,chapterNumber:K,scanlator:re})=>t.jsx(qe,{value:_,children:"#".concat(K).concat(O&&re!=null?" (".concat(re,")"):""," | ").concat(k)},m))})}),t.jsx(ae,{title:c("reader.button.next_chapter"),children:t.jsx(se,{sx:{gridArea:"next"},disabled:h||l.sourceOrder<1||l.sourceOrder>=E.chapters.totalCount,onClick:()=>n(Y.NEXT),children:ne(t.jsx(ce,{}),t.jsx(ie,{}))})})]})]})]})}),t.jsx(yr,{in:!N,children:t.jsx(Nt,{in:!w,children:t.jsx(ae,{title:c("reader.button.open_menu"),children:t.jsx(Vt,{sx:{position:"fixed",top:20,left:20,backgroundColor:"rgba(255, 255, 255, 0.75);",color:"black",...g.applyStyles("dark",{backgroundColor:"rgba(0, 0, 0, 0.75);",color:"white"})},size:"large",variant:"contained",onClick:()=>M(!0),children:ne(t.jsx(ce,{}),t.jsx(ie,{}))})})})})]})}const oe=a=>A.getFromCache(a,Wt,"CHAPTER_READER_FIELDS"),jr=a=>{switch(a){case"ContinuesVertical":case"Webtoon":return nt;case"SingleVertical":case"SingleRTL":case"SingleLTR":return Jt;case"DoubleVertical":case"DoubleRTL":case"DoubleLTR":return tr;case"ContinuesHorizontalLTR":case"ContinuesHorizontalRTL":return Zt;default:return nt}},Tr=a=>Array.from({length:a},(c,i)=>i),te={pageCount:-1,sourceOrder:-1,chapterCount:0,lastPageRead:0,name:"Loading...",manga:{id:-1}};function qr(){var Me,$e,We,ze,Be,Fe,He,Ve;const{t:a}=st(),c=ot(),i=it(),{chapterIndex:g,mangaId:d}=At(),p=r.useMemo(()=>({id:+d,title:"",thumbnailUrl:"",genre:[],inLibraryAt:0,lastReadAt:0,chapters:{totalCount:0},trackRecords:{totalCount:0}}),[d]),{data:L,loading:v,error:f,refetch:o}=ee.useGetManga(Ot,d),x=r.useRef(null),E=Number(d)===((Me=x.current)==null?void 0:Me.mangaId)&&Number(g)===(($e=x.current)==null?void 0:$e.sourceOrder)&&((We=x.current)==null?void 0:We.pageCount)!==-1,l=(ze=L==null?void 0:L.manga)!=null?ze:p,{data:b,loading:T,error:y,refetch:n}=ee.useGetChapters(Ge,{condition:{mangaId:Number(d),sourceOrder:Number(g)}},{notifyOnNetworkStatusChange:!0}),s=b==null?void 0:b.chapters.nodes[0],P=r.useRef(!1),{settings:{downloadAheadLimit:O}}=Ue(),N=!!O,R=()=>{var B;return x.current&&E?s&&((B=x.current)==null?void 0:B.pageCount)!==s.pageCount?s:x.current:(P.current=!1,s||null)};x.current=R();const e=(Be=x.current)!=null?Be:te,u=r.useRef(te);u.current===te&&(u.current=e),e.mangaId!==((Fe=u.current)==null?void 0:Fe.mangaId)&&(u.current=te);const[w,{loading:I,error:F}]=ee.useGetChapterPagesFetch(e.id),V=()=>{T||w().then(()=>{P.current=!0}).catch(U())};r.useEffect(()=>{V()},[e.id]);const[$,X]=r.useState(!1),[h,S]=r.useState(0),M=h===e.pageCount-1,W=Kt(h,M?0:1e3),[q,m]=r.useState(void 0),{setOverride:_,setTitle:k,readerNavBarWidth:K}=r.useContext(It),[re,ke]=r.useState(!1),{data:xe,loading:ut,error:je,refetch:pt}=ee.useGetMangaChapters(Ge,d,{nextFetchPolicy:"standby"}),C=xe==null?void 0:xe.chapters.nodes,me=v||T||ut||I||!P.current&&!y&&!F,Te=(Ve=(He=f!=null?f:y)!=null?He:je)!=null?Ve:F,{settings:Ce,loading:_e}=Ft(),[D,Ne]=r.useState(Qe(l,Ce)),{settings:pe}=Ue(),Ae=r.useMemo(()=>D.skipDupChapters?A.removeDuplicates(u.current,C!=null?C:[]):C!=null?C:[],[u.current,C,D.skipDupChapters]),ft=r.useMemo(()=>A.getNextChapters(e,C!=null?C:[],{offset:Y.PREV,skipDupe:D.skipDupChapters,skipDupeChapter:u.current}),[e,u.current,C,D.skipDupChapters]),gt=r.useMemo(()=>A.getNextChapters(e,C!=null?C:[],{skipDupe:D.skipDupChapters,skipDupeChapter:u.current}),[e,u.current,C,D.skipDupChapters]),fe=r.useMemo(()=>A.getNextChapter(e,C!=null?C:[],{offset:Y.PREV,skipDupe:D.skipDupChapters,skipDupeChapter:u.current}),[e,u.current,C,D.skipDupChapters]),Z=r.useMemo(()=>A.getNextChapter(e,C!=null?C:[],{skipDupe:D.skipDupChapters,skipDupeChapter:u.current}),[e,u.current,C,D.skipDupChapters]),Oe=j=>{if(e===te)return;const z=()=>{if(!(!!j.isRead&&!!pe.deleteChaptersWhileReading)||!C)return[];const J=[e,...ft][pe.deleteChaptersWhileReading-1];if(!J)return[];const we=oe(J.id);return we.isRead&&A.isDeletable(we,pe.deleteChaptersWithBookmark)?D.skipDupChapters?A.getIds(A.addDuplicates([J],C)):A.getIds([J]):[]};(()=>{var Re;const ge=oe(e.id),J=((Re=j.lastPageRead)!=null?Re:0)/e.pageCount>.25;if(N&&l.inLibrary&&!!(ge!=null&&ge.isDownloaded)&&J){const Pe=Z?oe(Z.id):null;if(!(Pe!=null&&Pe.isDownloaded))return;const Xe=A.getNonRead(gt).map(G=>oe(G.id)).slice(-O).filter(G=>!G.isDownloaded).map(G=>G.id).filter(G=>!A.isDownloading(G));if(!Xe.length)return;A.download(Xe).catch(U())}})();const ve=D.skipDupChapters?A.getIds(A.addDuplicates([e],C!=null?C:[e])):[e.id];ee.updateChapters(ve,{...j,chapterIdsToDelete:z(),trackProgressMangaId:pe.updateProgressAfterReading&&j.isRead&&l.trackRecords.totalCount?l.id:void 0},{errorPolicy:"all"}).response.catch(U())},ht=(j,z,B=!0)=>{Ne({...D,[j]:z}),B&&zt(l,[[j,z]]).catch(()=>Ye(a("reader.settings.error.label.failed_to_save_settings"),"warning"))},Q=r.useCallback(j=>{const z=j===Y.NEXT,B=z?Z:fe;if(!B){Ye(a(z?"reader.error.label.next_chapter_does_not_exist":"reader.error.label.prev_chapter_does_not_exist"),"error");return}ke(!0),S(0),c("/manga/".concat(l.id,"/chapter/").concat(B.sourceOrder),{replace:!0,state:i.state}),ke(!1)},[l.id,fe==null?void 0:fe.id,Z==null?void 0:Z.id]);r.useEffect(()=>{if(me||!e){S(0);return}X(!0),e.lastPageRead===e.pageCount-1?S(0):S(e.lastPageRead)},[e,me]),r.useLayoutEffect(()=>{!(l!=null&&l.title)||e.name===a("global.label.loading")?k(a("reader.title")):k("".concat(l.title,": ").concat(e.name))},[a,l,e]),r.useEffect(()=>{!_e&&!v&&(Ht(l,"manga",Ce).catch(U()),Ne(Qe(l,Ce)))},[_e,v]),r.useLayoutEffect(()=>(_({status:!0,value:t.jsx(kr,{settings:D,setSettingValue:ht,manga:l,chapter:e,chapters:Ae,curPage:h,scrollToPage:m,openNextChapter:Q,retrievingNextChapter:re})}),()=>_({status:!1,value:t.jsx("div",{})})),[l,e,D,h,g,re,Q,Ae]),r.useEffect(()=>{if(!$||e===te)return;const j=oe(e.id);if(W===(j==null?void 0:j.lastPageRead))return;const z=W!==-1,B=W===e.pageCount-1;(z||B)&&Oe({lastPageRead:z?W:void 0,isRead:B?!0:void 0})},[W,N]);const xt=r.useCallback(()=>{Oe({lastPageRead:e.pageCount-1,isRead:!0}),Q(Y.NEXT)},[e.pageCount,Q,e,l]),mt=r.useCallback(()=>{Q(Y.PREV)},[Q]),Ct=Mt.useGetScrollbarSize("height");if(me)return t.jsx(H,{sx:{height:"100vh",width:"100vw",display:"grid",placeItems:"center"},children:t.jsx($t,{thickness:5})});if(Te)return t.jsx(Ze,{message:a("global.error.label.failed_to_load_data"),messageExtra:Te.message,retry:()=>{f&&o().catch(U()),y&&n().catch(U()),je&&pt().catch(U()),F&&V()}});if(!e.pageCount)return t.jsx(Ze,{message:a("reader.error.label.no_pages_found"),retry:V});const vt=Tr(e.pageCount).map(j=>({index:j,src:ee.getChapterPageUrl(d,g,j)})),wt=jr(D.readerType),Rt=q!=null?q:e.lastPageRead===e.pageCount-1?0:e.lastPageRead,Ie=D.staticNav?K:0;return t.jsxs(H,{sx:{display:"flex",flexDirection:"column",alignContent:"center",alignItems:"center",justifyContent:"center",minWidth:"calc((100vw - (100vw - 100%)) - ".concat(Ie,"px)"),minHeight:"calc(100vh - ".concat(Ct,"px)"),marginLeft:"".concat(Ie,"px")},children:[t.jsx(Qt,{settings:D,curPage:h,pageCount:e.pageCount}),t.jsx(H,{sx:{alignSelf:"stretch"},children:t.jsx(wt,{pages:vt,pageCount:e.pageCount,setCurPage:S,initialPage:Rt,curPage:h,settings:D,manga:l,chapter:e,nextChapter:xt,prevChapter:mt},e.id)})]})}export{qr as Reader};
