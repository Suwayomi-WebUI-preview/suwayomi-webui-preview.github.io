import{u as f,j as t,F as T,o as _,p as m,bq as D,W as X,m as R,g as S,b as N,aO as K,i as J,k as Q,n as Z,b2 as ee,S as v,q as te,B as L,br as ae,bs as F,C as oe,I as se,r as M,a$ as ne,a as le,e as de,f as U,w as re}from"./index-Bunimexy.js";import{T as ie}from"./TextSetting-BSPgKXgb.js";import{N as $}from"./NumberSetting-BIM10J8F.js";import{u as ce,g as he}from"./usePersistedValue-G3LSC5hY.js";import{S as b}from"./Switch-SZbhVDQ3.js";import{S as pe}from"./SelectSetting-DnLNFD5c.js";import{a as ue}from"./CategoriesInclusionSetting-B0Ihvi6K.js";import{E as ge}from"./EmptyViewAbsoluteCentered-BJsAF0H0.js";import{u as me}from"./useAppTitle-Cv6DabpI.js";import{D as we}from"./Delete-wcRF1CST.js";import{T as B}from"./TextField-B2Nq9xcg.js";import{I as xe}from"./InputAdornment-bKBiz75j.js";import{L as P}from"./ListSubheader-DBjDtMkz.js";import"./PasswordTextField-DajZPB08.js";import"./VisibilityOff-1kdIU2X1.js";import"./Slider-D5QWcpug.js";import"./SwitchBase-Dc738_PD.js";import"./useFormControl-CLpWWdfr.js";import"./Select-CtKjPRqn.js";import"./ThreeStateCheckboxInput-DR74o7gw.js";import"./Checkbox-VltQGsX4.js";import"./formControlState-Dq1zat_P.js";const _e=({downloadAheadLimit:e})=>{const{t:a}=f(),s=!!e,[n,h]=ce("lastDownloadAheadLimit",D.default,e,he),d=r=>{h(r===0?n:r),X("downloadAheadLimit",r).catch(u=>R(a("global.error.label.failed_to_save_changes"),"error",S(u)))},i=r=>{d(r?n:0)};return t.jsxs(T,{children:[t.jsxs(_,{children:[t.jsx(m,{primary:a("download.settings.download_ahead.label.while_reading")}),t.jsx(b,{edge:"end",checked:s,onChange:r=>i(r.target.checked)})]}),t.jsx($,{settingTitle:a("download.settings.download_ahead.label.unread_chapters_to_download"),settingValue:a("download.settings.download_ahead.label.value",{chapters:n,count:n}),value:n,minValue:D.min,maxValue:D.max,defaultValue:D.default,stepSize:D.step,showSlider:!0,dialogDescription:a("download.settings.download_ahead.label.description"),dialogDisclaimer:a("download.settings.download_ahead.label.disclaimer"),valueUnit:a("chapter.title_one"),handleUpdate:d,disabled:!s})]})},be=[0,1,2,3,4,5],Ce={0:{text:"global.label.disabled"},1:{text:"download.settings.delete_chapters.while_reading.option.label.first"},2:{text:"download.settings.delete_chapters.while_reading.option.label.second"},3:{text:"download.settings.delete_chapters.while_reading.option.label.third"},4:{text:"download.settings.delete_chapters.while_reading.option.label.fourth"},5:{text:"download.settings.delete_chapters.while_reading.option.label.fifth"}},fe=be.map(e=>[e,Ce[e]]),je=e=>typeof e=="boolean"?Number(e):e,De=({chapterToDelete:e,handleChange:a})=>{const{t:s}=f(),n=je(e);return t.jsx(pe,{settingName:s("download.settings.delete_chapters.while_reading.label.title"),value:n,values:fe,handleChange:a})},G="default",A="image/",V=-1,y=e=>e.replace(A,""),H=e=>y(e.toLowerCase().trim())===G,q=(e,a,s)=>s.slice(0,a).some(n=>n.mimeType===e),Y=e=>e==null||e>=F.min&&e<=F.max,Te=e=>e.some(({mimeType:a,compressionLevel:s},n)=>!Y(s)||q(a,n,e)),O=e=>e.map(a=>({...a,mimeType:y(a.mimeType),target:y(a.target)})),W=e=>e.filter(({mimeType:a,target:s})=>!!a&&!!s).map(a=>({...a,mimeType:"".concat(A).concat(a.mimeType),target:"".concat(A).concat(a.target)})),E=e=>[...e.some(({mimeType:s})=>H(s))?[]:[{mimeType:G,target:"",compressionLevel:null}],...e],ve=(e,a)=>e.length!==a.length?!0:e.some(({mimeType:s,target:n,compressionLevel:h},d)=>{const i=a[d];return y(s)!==i.mimeType||y(n)!==i.target||h!==i.compressionLevel}),z=({shouldAutoFocus:e,isDefault:a,isDuplicate:s,label:n,value:h,onUpdate:d})=>{const{t:i}=f();return t.jsx(B,{sx:{maxWidth:150},autoFocus:e,label:n,value:h,disabled:a,error:s,helperText:s&&i("global.error.label.invalid_input"),slotProps:{input:{startAdornment:t.jsx(xe,{position:"start",children:A})}},onChange:r=>d(r.target.value.trim())})},ye=({shouldAutoFocusMimeTypeTextField:e,conversion:{mimeType:a,target:s,compressionLevel:n},setFocusMimeTypeTextField:h,onChange:d,isDuplicate:i})=>{const{t:r}=f(),u=Y(n),w=H(a)&&!i,o=w&&!s&&n==null;return t.jsxs(v,{sx:{gap:1,flexDirection:"row",flexWrap:"nowrap",alignItems:"center",pt:1},children:[t.jsxs(v,{sx:{gap:1,flexDirection:"row",alignItems:"baseline",flexWrap:"wrap"},children:[t.jsx(z,{shouldAutoFocus:e,isDefault:w,isDuplicate:i,label:r("download.settings.conversion.mime_type"),value:a,onUpdate:c=>{h(!0),d({mimeType:c,target:s,compressionLevel:n})}}),t.jsx(ae,{sx:{mx:1},children:"→"}),t.jsx(z,{shouldAutoFocus:!1,isDefault:!1,isDuplicate:!1,label:r("download.settings.conversion.target"),value:s,onUpdate:c=>d({mimeType:a,target:c,compressionLevel:n})}),t.jsx(B,{label:r("download.settings.conversion.compression_level"),value:n!=null?n:"",type:"number",error:!u,helperText:u?"":r("global.error.label.invalid_input"),slotProps:{input:{inputProps:F}},onChange:c=>{d({mimeType:a,target:s,compressionLevel:c.target.value?Number(c.target.value):void 0})}})]}),t.jsx(oe,{disabled:o,title:r("chapter.action.download.delete.label.action"),children:t.jsx(se,{disabled:o,onClick:()=>{h(!1),d(null)},children:t.jsx(we,{})})})]})},Ee=({conversions:e,updateSetting:a})=>{const{t:s}=f(),[n,h]=N.useState(!1),[d,i]=N.useState(O(E(e))),[r,u]=N.useState(V),w=Te(d),o=ve(O(E(e)),d),c=(p=e)=>{i(O(E(p))),h(!1)},C=()=>{c(e)};return t.jsxs(t.Fragment,{children:[t.jsx(K,{disabled:!1,onClick:()=>h(!0),children:t.jsx(m,{primary:s("download.settings.conversion.title"),secondary:e.map(p=>"".concat(p.mimeType," → ").concat(p.target)).join("; "),secondaryTypographyProps:{style:{display:"flex",flexDirection:"column"}}})}),t.jsxs(J,{open:n,onClose:C,children:[t.jsx(Q,{children:s("download.settings.conversion.title")}),t.jsxs(Z,{children:[t.jsx(ee,{sx:{mb:2,whiteSpace:"pre-line"},children:s("download.settings.conversion.description",{value:"none"})}),t.jsx(v,{sx:{flexDirection:"column",gap:3},children:d.map((p,g)=>{const{mimeType:j}=p,l=q(j,g,d),k=g===r;return t.jsx(ye,{conversion:p,isDuplicate:l,setFocusMimeTypeTextField:x=>u(x?g:V),shouldAutoFocusMimeTypeTextField:k,onChange:x=>{i(I=>E(I.toSpliced(g,1,...x?[x]:[])))}},"".concat(j,"-").concat(g))})})]}),t.jsx(te,{children:t.jsxs(v,{direction:"row",sx:{justifyContent:"space-between",width:"100%"},children:[t.jsx(L,{variant:"outlined",onClick:()=>{i(p=>[...p,{mimeType:"",target:"",compressionLevel:null}])},children:s("global.button.add")}),t.jsxs(v,{direction:"row",children:[t.jsx(L,{onClick:C,children:s("global.button.cancel")}),t.jsx(L,{disabled:w||!o,onClick:()=>a(W(d)).then(()=>c(W(d))),children:s("global.button.ok")})]})]})})]})]})},Se=e=>({downloadAsCbz:e.downloadAsCbz,downloadsPath:e.downloadsPath,autoDownloadNewChapters:e.autoDownloadNewChapters,autoDownloadNewChaptersLimit:e.autoDownloadNewChaptersLimit,excludeEntryWithUnreadChapters:e.excludeEntryWithUnreadChapters,autoDownloadIgnoreReUploads:e.autoDownloadIgnoreReUploads,downloadConversions:e.downloadConversions}),Je=()=>{var p,g,j;const{t:e}=f();me(e("download.title.download"));const a=M.useGetCategories(ne),s=M.useGetServerSettings({notifyOnNetworkStatusChange:!0}),[n]=M.useUpdateServerSettings(),{settings:h,loading:d,request:{error:i,refetch:r}}=le();if(s.loading||d||a.loading)return t.jsx(de,{});const w=(g=(p=s.error)!=null?p:i)!=null?g:a.error;if(w)return t.jsx(ge,{message:e("global.error.label.failed_to_load_data"),messageExtra:S(w),retry:()=>{s.error&&s.refetch().catch(U()),i&&r().catch(U()),a.error&&a.refetch().catch(U())}});const o=Se(s.data.settings),c=(l,k)=>{const x=n({variables:{input:{settings:{[l]:k}}}});return x.catch(I=>R(e("global.error.label.failed_to_save_changes"),"error",S(I))),x},C=re(l=>R(e("global.error.label.failed_to_save_changes"),"error",S(l)));return t.jsxs(T,{sx:{pt:0},children:[t.jsx(ie,{settingName:e("download.settings.download_path.label.title"),dialogDescription:e("download.settings.download_path.label.description"),value:o==null?void 0:o.downloadsPath,settingDescription:o!=null&&o.downloadsPath.length?o.downloadsPath:e("global.label.default"),handleChange:l=>c("downloadsPath",l)}),t.jsxs(_,{children:[t.jsx(m,{primary:e("download.settings.file_type.label.cbz")}),t.jsx(b,{edge:"end",checked:!!(o!=null&&o.downloadAsCbz),onChange:l=>c("downloadAsCbz",l.target.checked)})]}),t.jsx(Ee,{conversions:o==null?void 0:o.downloadConversions,updateSetting:l=>c("downloadConversions",l)}),t.jsxs(T,{subheader:t.jsx(P,{component:"div",id:"download-settings-auto-delete-downloads",children:e("download.settings.delete_chapters.title")}),children:[t.jsxs(_,{children:[t.jsx(m,{primary:e("download.settings.delete_chapters.label.manually_marked_as_read")}),t.jsx(b,{edge:"end",checked:h.deleteChaptersManuallyMarkedRead,onChange:l=>C("deleteChaptersManuallyMarkedRead",l.target.checked)})]}),t.jsx(De,{chapterToDelete:h.deleteChaptersWhileReading,handleChange:l=>C("deleteChaptersWhileReading",l)}),t.jsxs(_,{children:[t.jsx(m,{primary:e("download.settings.delete_chapters.label.allow_deletion_of_bookmarked")}),t.jsx(b,{edge:"end",checked:h.deleteChaptersWithBookmark,onChange:l=>C("deleteChaptersWithBookmark",l.target.checked)})]})]}),t.jsxs(T,{subheader:t.jsx(P,{component:"div",id:"download-settings-auto-download",children:e("download.settings.auto_download.title")}),children:[t.jsxs(_,{children:[t.jsx(m,{primary:e("download.settings.auto_download.label.new_chapters")}),t.jsx(b,{edge:"end",checked:!!(o!=null&&o.autoDownloadNewChapters),onChange:l=>c("autoDownloadNewChapters",l.target.checked)})]}),t.jsx($,{disabled:!(o!=null&&o.autoDownloadNewChapters),settingTitle:e("download.settings.auto_download.download_limit.label.title"),dialogDescription:e("download.settings.auto_download.download_limit.label.description"),value:(j=o==null?void 0:o.autoDownloadNewChaptersLimit)!=null?j:0,settingValue:o.autoDownloadNewChaptersLimit?e("download.settings.download_ahead.label.value",{chapters:o.autoDownloadNewChaptersLimit,count:o.autoDownloadNewChaptersLimit}):e("global.label.none"),defaultValue:0,minValue:0,maxValue:20,showSlider:!0,valueUnit:e("chapter.title_one"),handleUpdate:l=>c("autoDownloadNewChaptersLimit",l)}),t.jsxs(_,{children:[t.jsx(m,{primary:e("download.settings.auto_download.label.ignore_with_unread_chapters")}),t.jsx(b,{edge:"end",checked:!!(o!=null&&o.excludeEntryWithUnreadChapters),onChange:l=>c("excludeEntryWithUnreadChapters",l.target.checked),disabled:!(o!=null&&o.autoDownloadNewChapters)})]}),t.jsxs(_,{children:[t.jsx(m,{primary:e("download.settings.auto_download.label.ignore_re_uploads")}),t.jsx(b,{edge:"end",checked:!!(o!=null&&o.autoDownloadIgnoreReUploads),onChange:l=>c("autoDownloadIgnoreReUploads",l.target.checked),disabled:!(o!=null&&o.autoDownloadNewChapters)})]}),t.jsx(ue,{categories:a.data.categories.nodes,includeField:"includeInDownload",dialogText:e("download.settings.auto_download.categories.label.include_in_download")})]}),t.jsx(T,{subheader:t.jsx(P,{component:"div",id:"download-settings-download-ahead",children:e("download.settings.download_ahead.title")}),children:t.jsx(_e,{downloadAheadLimit:h.downloadAheadLimit})})]})};export{Je as DownloadSettings};
