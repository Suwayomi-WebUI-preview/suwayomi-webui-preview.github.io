import{c as r,j as t,B as F,a as H,ae as B,r as te,i as re,o as gt,a3 as pt,af as ht,a1 as pe,ag as mt,ah as xt,ai as Me,s as Y,I as G,u as Ye,e as Ze,aj as Je,ak as vt,W as Ct,al as wt,g as J,T as Rt,am as bt,U as yt,an as Et,O as Fe,ao as Pt,V as Lt,N as St,n as ze,k as q,X as jt,E as Tt}from"./index-D6RYBNhe.js";import{b as X,C as T}from"./Chapters-CPKjKZCN.js";import{P as oe,i as Dt,R as kt,u as _t,g as Be,c as Ot}from"./ReaderSettingsOptions-CFyySwAJ.js";import{r as Nt}from"./metadata-S3rj_Joy.js";import{S as He}from"./SpinnerImage--77B1QOy.js";import{S as Ve}from"./Select-D4SlXrdS.js";import{C as At}from"./Collapse-DlmjrCDx.js";import{a as qe}from"./TextField-BsPhsFsz.js";import{u as It}from"./useDebounce-BDv83NHX.js";import{u as Xe}from"./metadataServerSettings-BzXqSfB-.js";import"./NumberSetting-B1PCWSx9.js";import"./Info-6eil46u_.js";import"./InputAdornment-BMkJJMlZ.js";import"./Switch-uJK7KaYC.js";import"./SwitchBase-B0rT0SwT.js";const $t=c=>{for(let n=0;n<c.children.length;n++){const o=c.children.item(n);if(o){const{left:p,right:d}=o.getBoundingClientRect();if(p<=window.innerWidth/2&&d>window.innerWidth/2)return n}}return-1},Wt=5,Mt=()=>window.innerWidth+window.scrollX>=document.body.scrollWidth-Wt,Ft=()=>window.scrollX<=0;function zt(c){const{pages:n,curPage:o,initialPage:p,settings:d,setCurPage:a,prevChapter:u,nextChapter:x}=c,h=r.useRef(p),f=r.useRef(null),v=r.useRef([]);function P(){var e;o<n.length-1?((e=v.current[o+1])==null||e.scrollIntoView({inline:"center"}),a(l=>l+1)):d.loadNextOnEnding&&x()}function m(){var e;o>0?((e=v.current[o-1])==null||e.scrollIntoView({inline:"center"}),a(o-1)):o===0&&u()}function R(){d.readerType==="ContinuesHorizontalLTR"?m():P()}function L(){d.readerType==="ContinuesHorizontalLTR"?P():m()}const w=r.useRef(0);function i(e){window.scrollBy(w.current-e.pageX,0)}function s(e){var l;w.current=e.pageX,(l=f.current)==null||l.addEventListener("mousemove",i)}function b(){var e;(e=f.current)==null||e.removeEventListener("mousemove",i)}function D(e){e.clientX>=window.innerWidth*.85?L():e.clientX<=window.innerWidth*.15&&R()}const k=()=>{d.readerType==="ContinuesHorizontalLTR"?window.scrollX+window.innerWidth>=document.body.scrollWidth&&x():d.readerType==="ContinuesHorizontalRTL"&&window.scrollX<=window.innerWidth&&x()};return r.useLayoutEffect(()=>{const e=v.current[p];if(!e)return()=>{};const l=new ResizeObserver(()=>{e.offsetHeight&&(e.scrollIntoView({inline:"center"}),l.disconnect())});return l.observe(e),()=>l.disconnect()},[p]),r.useEffect(()=>{var e,l;return(e=f.current)==null||e.addEventListener("mousedown",s),(l=f.current)==null||l.addEventListener("mouseup",b),()=>{var E,_;(E=f.current)==null||E.removeEventListener("mousedown",s),(_=f.current)==null||_.removeEventListener("mouseup",b)}},[f]),r.useEffect(()=>(d.loadNextOnEnding&&document.addEventListener("scroll",k),()=>{document.removeEventListener("scroll",k)}),[f,o,u,x]),r.useEffect(()=>{const e=()=>{if(!f.current)return;const l=$t(f.current);l!==h.current&&(h.current=l,a(l)),(d.readerType==="ContinuesHorizontalLTR"?Mt():Ft())&&(h.current=n.length-1,a(h.current))};return window.addEventListener("scroll",e),()=>window.removeEventListener("scroll",e)},[d.readerType]),t.jsx(F,{ref:f,sx:{display:"flex",flexDirection:d.readerType==="ContinuesHorizontalLTR"?"row":"row-reverse",justifyContent:d.readerType==="ContinuesHorizontalLTR"?"flex-start":"flex-end",width:"auto",height:"auto",overflowX:"visible",userSelect:"none"},onClick:D,children:n.map(e=>t.jsx(oe,{index:e.index,src:e.src,onImageLoad:()=>{},settings:d,ref:l=>{v.current[e.index]=l}},e.index))})}function Bt(c){const{settings:n,curPage:o,pageCount:p}=c;return t.jsx(F,{sx:{display:n.showPageNumber?"block":"none",position:"fixed",bottom:"50px",padding:"2px",paddingLeft:"4px",paddingRight:"4px",textAlign:"center",backgroundColor:"rgba(0, 0, 0, 0.3)",borderRadius:"10px"},children:"".concat(o+1," / ").concat(p)})}function Ht(c){const{pages:n,settings:o,setCurPage:p,initialPage:d,curPage:a,nextChapter:u,prevChapter:x,chapter:h}=c,f=r.useRef(null);r.useEffect(()=>{const s=n.map(b=>{const D=H.requestImage(b.src);return D.response.catch(()=>{}),D});return()=>{s.forEach(b=>b.abortRequest(new Error("PagedPager::preload: chapter changed")))}},[h.id]);const v=s=>{p(s),window.scroll({top:0})};function P(){a<n.length-1?v(a+1):o.loadNextOnEnding&&u()}function m(){a>0?v(a-1):x()}function R(){o.readerType==="SingleLTR"?m():o.readerType==="SingleRTL"&&P()}function L(){o.readerType==="SingleLTR"?P():o.readerType==="SingleRTL"&&m()}function w(s){switch(s.key){case"Space":s.preventDefault(),P();break;case"ArrowRight":L();break;case"ArrowLeft":R();break}}function i(s){s.clientX>window.innerWidth/2?L():R()}return r.useEffect(()=>(document.addEventListener("keydown",w),()=>{document.removeEventListener("keydown",w)}),[f,a,o.readerType,x,u]),r.useEffect(()=>{setTimeout(()=>{v(d)},0)},[d]),t.jsx(F,{ref:f,sx:{display:"flex",flexDirection:"column",justifyContent:"center",width:"auto",height:"auto"},onClick:i,children:t.jsx(oe,{index:a,onImageLoad:()=>{},src:n[a].src,settings:o},a)})}const Vt=r.forwardRef((c,n)=>{const{image1src:o,image2src:p,index:d,onImageLoad:a,settings:u}=c,x=Dt(u),h={...x,width:u.fitPageToWindow?x.width:"calc(".concat(x.width," * 0.5)"),minWidth:u.fitPageToWindow&&u.scalePage?"calc(".concat(x.minWidth," * 0.5)"):x.minWidth,maxWidth:u.fitPageToWindow?"calc(".concat(x.maxWidth," * 0.5)"):x.maxWidth},f={...h,height:"100vh",width:"50%",backgroundColor:"#525252"};return t.jsxs(F,{ref:n,sx:{display:"flex",flexDirection:u.readerType==="DoubleLTR"?"row":"row-reverse",justifyContent:"center",width:"100%"},children:[t.jsx(He,{src:o,onImageLoad:a,alt:"Page #".concat(d),spinnerStyle:f,imgStyle:{...h,objectPosition:u.readerType==="DoubleLTR"?B("right","left"):B("left","right")}}),t.jsx(He,{src:p,onImageLoad:a,alt:"Page #".concat(d+1),spinnerStyle:{...f,width:"calc(50% - 5px)",marginLeft:"5px"},imgStyle:{...h,objectPosition:u.readerType==="DoubleLTR"?B("left","right"):B("right","left")}})]})}),qt=c=>c.height/c.width<1,he=(c,n,o)=>{if(n[c]||n[c+1]||c===n.length-1)return!0;const p=n.lastIndexOf(!0,c-1),d=c-(p+1);return o?d%2===0:d%2===1};function Xt(c){const{pages:n,settings:o,setCurPage:p,initialPage:d,curPage:a,chapter:u,nextChapter:x,prevChapter:h}=c,f=r.useRef(null),[v,P]=r.useState(Array(n.length).fill(!1)),[m,R]=r.useState(Array(n.length).fill(!1));function L(){let l=1;if(a<n.length&&m[a]&&(l=1,v[a]))return l;if(a+1<n.length&&m[a+1]){if(he(a,v,o.offsetFirstPage))return l;l=2}return l}function w(){return he(a-2,v,o.offsetFirstPage)?1:2}function i(){if(a<n.length-1){const l=a+L();p(l>=n.length?n.length-1:l)}else o.loadNextOnEnding&&x()}function s(){if(a>0){const l=a-w();p(l<0?0:l)}else h()}function b(){o.readerType==="DoubleLTR"?s():i()}function D(){o.readerType==="DoubleLTR"?i():s()}function k(l){switch(l.key){case"Space":l.preventDefault(),i();break;case"ArrowRight":D();break;case"ArrowLeft":b();break}}function e(l){l.clientX>window.innerWidth/2?D():b()}return r.useEffect(()=>(document.addEventListener("keydown",k),()=>{document.removeEventListener("keydown",k)}),[f,a,o.readerType,h,x,m,v]),r.useEffect(()=>{p(d)},[d]),r.useEffect(()=>{o.offsetFirstPage?L()===2&&p(a+1):a>0&&!he(a-1,v,o.offsetFirstPage)&&p(a-1)},[o.offsetFirstPage]),r.useEffect(()=>{const l=n.map(E=>[E.index,H.requestImage(E.src)]);return l.forEach(async([E,_])=>{try{const O=await _.response,z=new Image;z.onload=()=>{URL.revokeObjectURL(O),R(A=>A.toSpliced(E,1,!0)),P(A=>A.toSpliced(E,1,qt(z)))},z.src=O}catch(O){}}),()=>{l.forEach(([E,_])=>_.abortRequest(new Error("DoublePagedPager::preload(".concat(E,"): chapter changed"))))}},[u.id]),t.jsx(F,{ref:f,onClick:e,children:t.jsx(F,{id:"display",sx:{display:"flex",flexDirection:o.readerType==="DoubleLTR"?"row":"row-reverse",justifyContent:"center",width:"auto",height:"auto"},children:L()===2?t.jsx(Vt,{index:a,image1src:n[a].src,image2src:n[a+1].src,settings:o},a):t.jsx(oe,{index:a,src:n[a].src,onImageLoad:()=>{},settings:o},a)})})}const Ut=c=>{for(let n=0;n<c.children.length;n++){const o=c.children.item(n);if(o){const{top:p,bottom:d}=o.getBoundingClientRect();if(p<=window.innerHeight&&d>1)return n}}return-1},Kt=5,Gt=.95,Ue=.25,Yt="smooth",Ke=()=>window.innerHeight+window.scrollY>=document.body.offsetHeight-Kt,Zt=()=>window.scrollY<=0;function Ge(c){const{pages:n,settings:o,setCurPage:p,initialPage:d,nextChapter:a,prevChapter:u}=c,x=r.useRef(d),h=r.useRef(null),f=r.useRef([]);r.useEffect(()=>{let i=!1;const s=()=>{if(h.current)if(Ke()){if(i)return;i=!0,x.current=n.length-1,p(x.current),o.loadNextOnEnding&&a()}else{i=!1;const b=Ut(h.current);b!==x.current&&(x.current=b,p(b))}};return window.addEventListener("scroll",s),()=>{window.removeEventListener("scroll",s)}},[o.loadNextOnEnding,a]);const v=r.useRef(0),P=r.useRef(!1);function m(i){P.current=!0,window.scrollBy(0,v.current-i.pageY)}function R(i){var s;v.current=i.pageY,(s=h.current)==null||s.addEventListener("mousemove",m)}function L(){var i;(i=h.current)==null||i.removeEventListener("mousemove",m)}r.useEffect(()=>{var i,s;return(i=h.current)==null||i.addEventListener("mousedown",R),(s=h.current)==null||s.addEventListener("mouseup",L),()=>{var b,D;(b=h.current)==null||b.removeEventListener("mousedown",R),(D=h.current)==null||D.removeEventListener("mouseup",L)}},[h]);const w=r.useCallback((i,s=Gt)=>{if(i==="down"&&Ke()){a();return}if(i==="up"&&Zt()){u();return}window.scroll({top:window.scrollY+window.innerHeight*s*(i==="up"?-1:1),behavior:Yt})},[a,u]);return r.useEffect(()=>{const i=s=>{switch(s.key){case"Space":s.preventDefault(),w(s.shiftKey?"up":"down");break;case"ArrowDown":s.preventDefault(),w(s.shiftKey?"up":"down",Ue);break;case"ArrowRight":s.preventDefault(),w(s.shiftKey?"up":"down");break;case"ArrowUp":s.preventDefault(),w(s.shiftKey?"down":"up",Ue);break;case"ArrowLeft":s.preventDefault(),w(s.shiftKey?"down":"up");break}};return document.addEventListener("keydown",i,!1),()=>{document.removeEventListener("keydown",i)}},[w]),r.useLayoutEffect(()=>{const i=f.current[d];if(!i)return()=>{};const s=new ResizeObserver(()=>{i.offsetHeight&&(i.scrollIntoView(),s.disconnect())});return s.observe(i),()=>s.disconnect()},[d]),t.jsx(F,{ref:h,sx:{display:"flex",flexDirection:"column",justifyContent:"center",width:"auto",height:"auto",userSelect:"none"},onClick:i=>{if(P.current){P.current=!1;return}w(i.clientX>window.innerWidth/2?"down":"up")},children:n.map(i=>t.jsx(oe,{index:i.index,src:i.src,onImageLoad:()=>{},settings:o,ref:s=>{f.current[i.index]=s}},i.index))})}var xe={},Jt=re;Object.defineProperty(xe,"__esModule",{value:!0});var Qe=xe.default=void 0,Qt=Jt(te()),er=t;Qe=xe.default=(0,Qt.default)((0,er.jsx)("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Close");var ve={},tr=re;Object.defineProperty(ve,"__esModule",{value:!0});var Q=ve.default=void 0,rr=tr(te()),nr=t;Q=ve.default=(0,rr.default)((0,nr.jsx)("path",{d:"M15.41 16.59 10.83 12l4.58-4.59L14 6l-6 6 6 6z"}),"KeyboardArrowLeft");var Ce={},ar=re;Object.defineProperty(Ce,"__esModule",{value:!0});var ee=Ce.default=void 0,sr=ar(te()),or=t;ee=Ce.default=(0,sr.default)((0,or.jsx)("path",{d:"M8.59 16.59 13.17 12 8.59 7.41 10 6l6 6-6 6z"}),"KeyboardArrowRight");var we={},ir=re;Object.defineProperty(we,"__esModule",{value:!0});var et=we.default=void 0,cr=ir(te()),lr=t;et=we.default=(0,cr.default)((0,lr.jsx)("path",{d:"M7.41 8.59 12 13.17l4.59-4.58L18 10l-6 6-6-6z"}),"KeyboardArrowDown");var Re={},dr=re;Object.defineProperty(Re,"__esModule",{value:!0});var tt=Re.default=void 0,ur=dr(te()),fr=t;tt=Re.default=(0,ur.default)((0,fr.jsx)("path",{d:"M7.41 15.41 12 10.83l4.59 4.58L18 14l-6-6-6 6z"}),"KeyboardArrowUp");const gr=["addEndListener","appear","children","easing","in","onEnter","onEntered","onEntering","onExit","onExited","onExiting","style","timeout","TransitionComponent"],pr={entering:{transform:"none"},entered:{transform:"none"}},hr=r.forwardRef(function(n,o){const p=gt(),d={enter:p.transitions.duration.enteringScreen,exit:p.transitions.duration.leavingScreen},{addEndListener:a,appear:u=!0,children:x,easing:h,in:f,onEnter:v,onEntered:P,onEntering:m,onExit:R,onExited:L,onExiting:w,style:i,timeout:s=d,TransitionComponent:b=mt}=n,D=pt(n,gr),k=r.useRef(null),e=ht(k,x.ref,o),l=g=>C=>{if(g){const I=k.current;C===void 0?g(I):g(I,C)}},E=l(m),_=l((g,C)=>{xt(g);const I=Me({style:i,timeout:s,easing:h},{mode:"enter"});g.style.webkitTransition=p.transitions.create("transform",I),g.style.transition=p.transitions.create("transform",I),v&&v(g,C)}),O=l(P),z=l(w),A=l(g=>{const C=Me({style:i,timeout:s,easing:h},{mode:"exit"});g.style.webkitTransition=p.transitions.create("transform",C),g.style.transition=p.transitions.create("transform",C),R&&R(g)}),N=l(L),M=g=>{a&&a(k.current,g)};return t.jsx(b,pe({appear:u,in:f,nodeRef:k,onEnter:_,onEntered:O,onEntering:E,onExit:A,onExited:N,onExiting:z,addEndListener:M,timeout:s},D,{children:(g,C)=>r.cloneElement(x,pe({style:pe({transform:"scale(0)",visibility:g==="exited"&&!f?"hidden":void 0},pr[g],i,x.props.style),ref:e},C))}))}),mr=hr,xr=Y("div")({zIndex:10}),vr=Y("div")(({theme:c})=>({top:0,left:0,width:"300px",minWidth:"300px",height:"100vh",overflowY:"auto",backgroundColor:c.palette.background.default,"& header":{backgroundColor:c.palette.action.hover,display:"flex",alignItems:"center",minHeight:"64px",paddingLeft:"24px",paddingRight:"24px",transition:"left 2s ease","& button":{flexGrow:0,flexShrink:0},"& button:nth-child(1)":{marginRight:"16px"},"& h1":{fontSize:"1.25rem",flexGrow:1}}})),Cr=Y("div")({margin:"0 16px","& > span:nth-child(1)":{textAlign:"center",display:"block",marginTop:"16px"}}),wr=Y("div")({display:"flex",flexWrap:"wrap",alignContent:"center",alignItems:"center",justifyContent:"center"}),Rr=Y("div")({display:"grid",gridTemplateRows:"auto auto auto",gridTemplateColumns:"0fr 1fr 0fr",gridTemplateAreas:'"pre current next"',gridColumnGap:"5px",margin:"10px 0","& a":{textDecoration:"none",color:"inherit",display:"flex",flexWrap:"wrap",alignContent:"center"}}),br=Y(G)(({theme:c})=>({position:"fixed",top:20,left:30,height:"40px",width:"40px",borderRadius:5,backgroundColor:c.palette.custom.main,"&:hover":{backgroundColor:c.palette.custom.light}}));function yr(c){var M;const{t:n}=Ye(),o=Ze(),p=Je(),{prevDrawerOpen:d,prevSettingsCollapseOpen:a}=(M=p.state)!=null?M:{},{settings:u,setSettingValue:x,manga:h,chapter:f,curPage:v,scrollToPage:P,openNextChapter:m,retrievingNextChapter:R}=c,L=vt();Ct("/manga/".concat(h.id));const[w,i]=r.useState(u.staticNav||d),[s,b]=r.useState(!0),[D,k]=r.useState(u.staticNav||d),[e,l]=r.useState(0),[E,_]=r.useState(a!=null?a:!0),O=R,z=(g,C,I)=>{b(g!=="staticNav"),x(g,C,I)},A=g=>{i(g),k(g)},N=()=>{const g=window.pageYOffset;Math.abs(g-e)>20&&(k(g>e),l(g))};return r.useEffect(()=>{s&&A(u.staticNav)},[u.staticNav]),r.useEffect(()=>{window.addEventListener("scroll",N);const g=document.querySelector("#root"),C=document.querySelector("#appMainContainer");return g.style.display="flex",g.style.flexDirection="column",C.style.display="none",()=>{g.style.display="block",C.style.display="block",window.removeEventListener("scroll",N)}},[N]),t.jsxs(xr,{children:[t.jsx(wt,{direction:B("right","left"),in:w,timeout:200,appear:!1,mountOnEnter:!0,unmountOnExit:!0,children:t.jsxs(vr,{sx:{position:"fixed"},children:[t.jsxs("header",{children:[!u.staticNav&&t.jsx(J,{title:n("reader.button.close_menu"),children:t.jsx(G,{edge:"start",color:"inherit","aria-label":"menu",disableRipple:!0,onClick:()=>A(!1),size:"large",children:B(t.jsx(Q,{}),t.jsx(ee,{}))})}),t.jsx(Rt,{variant:"h1",textOverflow:"ellipsis",overflow:"hidden",sx:{py:1},children:f.name}),t.jsx(J,{title:n("reader.button.exit"),children:t.jsx(G,{edge:"start",color:"inherit","aria-label":"menu",disableRipple:!0,onClick:L,size:"large",sx:{mr:-1},children:t.jsx(Qe,{})})})]}),t.jsxs(bt,{ContainerComponent:"div",sx:{"& span":{fontWeight:"bold"}},children:[t.jsx(yt,{primary:n("reader.settings.title.reader_settings")}),t.jsxs(G,{edge:"start",color:"inherit","aria-label":"menu",disableRipple:!0,disableFocusRipple:!0,onClick:()=>_(!E),size:"large",children:[E&&t.jsx(tt,{}),!E&&t.jsx(et,{})]})]}),t.jsx(At,{in:E,timeout:"auto",unmountOnExit:!0,children:t.jsx(kt,{setSettingValue:z,staticNav:u.staticNav,showPageNumber:u.showPageNumber,loadNextOnEnding:u.loadNextOnEnding,skipDupChapters:u.skipDupChapters,fitPageToWindow:u.fitPageToWindow,scalePage:u.scalePage,readerType:u.readerType,offsetFirstPage:u.offsetFirstPage,readerWidth:u.readerWidth})}),t.jsx(Et,{sx:{my:1,mx:2}}),t.jsxs(Cr,{children:[t.jsxs(wr,{children:[t.jsx("span",{children:n("reader.page_info.label.currently_on_page")}),t.jsx(qe,{size:"small",sx:{margin:"0 5px"},disabled:O||f.pageCount===-1,children:t.jsx(Ve,{value:f.pageCount>-1?"".concat(v):"",displayEmpty:!0,onChange:({target:{value:g}})=>{P(Number(g))},children:Array(Math.max(0,f.pageCount)).fill(1).map((g,C)=>t.jsx(Fe,{value:C,children:C+1},"Page#".concat(C)))})}),t.jsx("span",{children:n("reader.page_info.label.of_max_pages",{maxPages:f.pageCount})})]}),t.jsxs(Rr,{children:[t.jsx(J,{title:n("reader.button.previous_chapter"),children:t.jsx(G,{sx:{gridArea:"pre"},disabled:O||f.sourceOrder<=1,onClick:()=>m(X.PREV),children:B(t.jsx(Q,{}),t.jsx(ee,{}))})}),t.jsx(qe,{sx:{gridArea:"current"},size:"small",disabled:O||f.sourceOrder<1,children:t.jsx(Ve,{value:f.sourceOrder>=1?"".concat(f.sourceOrder):"",displayEmpty:!0,onChange:({target:{value:g}})=>{o("/manga/".concat(h.id,"/chapter/").concat(g),{replace:!0,state:{prevDrawerOpen:w,prevSettingsCollapseOpen:E}})},children:Array(Math.max(0,h.chapters.totalCount)).fill(1).map((g,C)=>t.jsx(Fe,{value:C+1,children:"".concat(n("chapter.title")," ").concat(C+1)},"Chapter#".concat(C+1)))})}),t.jsx(J,{title:n("reader.button.next_chapter"),children:t.jsx(G,{sx:{gridArea:"next"},disabled:O||f.sourceOrder<1||f.sourceOrder>=h.chapters.totalCount,onClick:()=>m(X.NEXT),children:B(t.jsx(ee,{}),t.jsx(Q,{}))})})]})]})]})}),t.jsx(mr,{in:!w,children:t.jsx(Pt,{in:!D,children:t.jsx(J,{title:n("reader.button.open_menu"),children:t.jsx(br,{edge:"start","aria-label":"menu",disableRipple:!0,disableFocusRipple:!0,onClick:()=>A(!0),size:"large",children:B(t.jsx(ee,{}),t.jsx(Q,{}))})})})})]})}const Er=c=>{switch(c){case"ContinuesVertical":case"Webtoon":return Ge;case"SingleVertical":case"SingleRTL":case"SingleLTR":return Ht;case"DoubleVertical":case"DoubleRTL":case"DoubleLTR":return Xt;case"ContinuesHorizontalLTR":case"ContinuesHorizontalRTL":return zt;default:return Ge}},Pr=c=>Array.from({length:c},(n,o)=>o),me={pageCount:-1,sourceOrder:-1,chapterCount:0,lastPageRead:0,name:"Loading..."};function Br(){var ke,_e,Oe,Ne,Ae,Ie,$e;const{t:c}=Ye(),n=Ze(),o=Je(),{chapterIndex:p,mangaId:d}=Lt(),a=r.useMemo(()=>({id:+d,title:"",thumbnailUrl:"",genre:[],inLibraryAt:0,lastReadAt:0,chapters:{totalCount:0},trackRecords:{totalCount:0}}),[d]),{data:u,loading:x,error:h,refetch:f}=H.useGetManga(d),v=r.useRef(null),P=Number(d)===((ke=v.current)==null?void 0:ke.manga.id)&&Number(p)===((_e=v.current)==null?void 0:_e.sourceOrder)&&((Oe=v.current)==null?void 0:Oe.pageCount)!==-1,m=(Ne=u==null?void 0:u.manga)!=null?Ne:a,{data:R,loading:L,error:w,refetch:i}=H.useGetMangaChapter(d,p,{notifyOnNetworkStatusChange:!0}),s=r.useRef(!1),{settings:{downloadAheadLimit:b}}=Xe(),D=!!b,k=()=>{var W;return v.current&&P?(R==null?void 0:R.chapter)&&((W=v.current)==null?void 0:W.pageCount)!==R.chapter.pageCount?R.chapter:v.current:(s.current=!1,R!=null&&R.chapter?R.chapter:null)};v.current=k();const e=(Ae=v.current)!=null?Ae:me,[l,{loading:E,error:_}]=H.useGetChapterPagesFetch(e.id),O=()=>{!L&&!e.isDownloaded?l().then(()=>{s.current=!0}).catch(q()):s.current=!0};r.useEffect(()=>{O()},[e.id]);const[z,A]=r.useState(!1),[N,M]=r.useState(0),g=N===e.pageCount-1,C=It(N,g?0:1e3),[I,rt]=r.useState(void 0),{setOverride:be,setTitle:ye}=r.useContext(St),[Ee,Pe]=r.useState(!1),{data:ie,loading:nt,error:Le,refetch:at}=H.useGetMangaChapters(d,{nextFetchPolicy:"standby"}),y=ie==null?void 0:ie.chapters.nodes,ce=x||L||nt||E||!s.current&&!w&&!_,Se=($e=(Ie=h!=null?h:w)!=null?Ie:Le)!=null?$e:_,{settings:le,loading:je}=_t(),[S,Te]=r.useState(Be(m,le)),{settings:ne}=Xe(),st=r.useMemo(()=>T.getNextChapters(e,y!=null?y:[],{offset:X.PREV,skipDupe:S.skipDupChapters}),[e,y,S.skipDupChapters]),ot=r.useMemo(()=>T.getNextChapters(e,y!=null?y:[],{skipDupe:S.skipDupChapters}),[e,y,S.skipDupChapters]),ae=r.useMemo(()=>T.getNextChapter(e,y!=null?y:[],{offset:X.PREV,skipDupe:S.skipDupChapters}),[e,y,S.skipDupChapters]),U=r.useMemo(()=>T.getNextChapter(e,y!=null?y:[],{skipDupe:S.skipDupChapters}),[e,y,S.skipDupChapters]),De=j=>{if(e===me)return;const $=()=>{if(!(!!j.isRead&&!!ne.deleteChaptersWhileReading)||!y)return[];const K=[e,...st][ne.deleteChaptersWhileReading-1];if(!K)return[];const ue=T.getFromCache(K.id);return ue.isRead&&T.isDeletable(ue,ne.deleteChaptersWithBookmark)?S.skipDupChapters?T.getIds(T.addDuplicates([K],y)):T.getIds([K]):[]};(()=>{var fe;const se=T.getFromCache(e.id),K=((fe=j.lastPageRead)!=null?fe:0)/e.pageCount>.25;if(D&&e.manga.inLibrary&&!!(se!=null&&se.isDownloaded)&&K){const ge=U?T.getFromCache(U.id):null;if(!(ge!=null&&ge.isDownloaded))return;const We=T.getNonRead(ot).map(V=>T.getFromCache(V.id)).slice(-b).filter(V=>!V.isDownloaded).map(V=>V.id).filter(V=>!T.isDownloading(V));if(!We.length)return;T.download(We).catch(q())}})();const de=S.skipDupChapters?T.getIds(T.addDuplicates([e],y!=null?y:[e])):[e.id];H.updateChapters(de,{...j,chapterIdsToDelete:$(),trackProgressMangaId:ne.updateProgressAfterReading&&j.isRead&&m.trackRecords.totalCount?m.id:void 0}).response.catch(q())},it=(j,$,W=!0)=>{Te({...S,[j]:$}),W&&Nt(m,[[j,$]]).catch(()=>ze(c("reader.settings.error.label.failed_to_save_settings"),"warning"))},Z=r.useCallback(j=>{const $=j===X.NEXT,W=$?U:ae;if(!W){ze(c($?"reader.error.label.next_chapter_does_not_exist":"reader.error.label.prev_chapter_does_not_exist"),"error");return}Pe(!0),M(0),n("/manga/".concat(m.id,"/chapter/").concat(W.sourceOrder),{replace:!0,state:o.state}),Pe(!1)},[m.id,ae==null?void 0:ae.id,U==null?void 0:U.id]);r.useEffect(()=>{if(ce||!e){M(0);return}A(!0),e.lastPageRead===e.pageCount-1?M(0):M(e.lastPageRead)},[e,ce]),r.useEffect(()=>{!(m!=null&&m.title)||e.name===c("global.label.loading")?ye(c("reader.title")):ye("".concat(m.title,": ").concat(e.name))},[c,m,e]),r.useEffect(()=>{!je&&!x&&(Ot(m,"manga",le).catch(q()),Te(Be(m,le)))},[je,x]),r.useEffect(()=>(be({status:!0,value:t.jsx(yr,{settings:S,setSettingValue:it,manga:m,chapter:e,curPage:N,scrollToPage:rt,openNextChapter:Z,retrievingNextChapter:Ee})}),()=>be({status:!1,value:t.jsx("div",{})})),[m,e,S,N,p,Ee]),r.useEffect(()=>{if(!z||e===me)return;const j=T.getFromCache(e.id);if(C===(j==null?void 0:j.lastPageRead))return;const $=C!==-1,W=C===e.pageCount-1;($||W)&&De({lastPageRead:$?C:void 0,isRead:W?!0:void 0})},[C,D]);const ct=r.useCallback(()=>{De({lastPageRead:e.pageCount-1,isRead:!0}),Z(X.NEXT)},[e.pageCount,Z,e,m]),lt=r.useCallback(()=>{Z(X.PREV)},[Z]);if(ce)return t.jsx(F,{sx:{height:"100vh",width:"100vw",display:"grid",placeItems:"center"},children:t.jsx(jt,{thickness:5})});if(Se)return t.jsx(Tt,{message:c("global.error.label.failed_to_load_data"),messageExtra:Se.message,retry:()=>{h&&f().catch(q()),w&&i().catch(q()),Le&&at().catch(q()),_&&O()}});const dt=Pr(e.pageCount).map(j=>({index:j,src:H.getChapterPageUrl(d,p,j)})),ut=Er(S.readerType),ft=I!=null?I:e.lastPageRead===e.pageCount-1?0:e.lastPageRead;return t.jsxs(F,{sx:{display:"flex",flexDirection:"column",alignContent:"center",alignItems:"center",justifyContent:"center",minWidth:S.staticNav?"calc((100vw - (100vw - 100%)) - 300px)":"calc(100vw - (100vw - 100%))",minHeight:"100vh",marginLeft:S.staticNav?"300px":"unset"},children:[t.jsx(Bt,{settings:S,curPage:N,pageCount:e.pageCount}),t.jsx(F,{sx:{alignSelf:"stretch"},children:t.jsx(ut,{pages:dt,pageCount:e.pageCount,setCurPage:M,initialPage:ft,curPage:N,settings:S,manga:m,chapter:e,nextChapter:ct,prevChapter:lt},e.id)})]})}export{Br as Reader};
