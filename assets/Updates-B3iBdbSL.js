import{u as H,ap as N,c as r,N as U,a as u,j as e,E as S,h as D,T as O,bg as $,g as q,L as k,B as v,f as V,I as z,w as Q,y as W,bh as J,m as K}from"./index-BpnB-2Sx.js";import{D as X}from"./DownloadStateIndicator-e-Jv8y_Z.js";import{U as Y}from"./UpdateChecker-C87kAddd.js";import{S as Z,a as ee,b as te}from"./StyledGroupItemWrapper-Ug_0sMfK.js";import{M as ae}from"./Mangas-BLBn37Jq.js";import{S as oe}from"./SpinnerImage-BBhnUIig.js";import{T as I}from"./TypographyMaxLines-CmsTVwKa.js";import{C as se}from"./Card-BQb1wMaJ.js";import{C as re}from"./CardActionArea-bBiiV_nl.js";import{C as ne}from"./CardContent-C0_Kxsn8.js";import{A as ie}from"./Avatar-BKFjhfbz.js";import"./Progress-BqqHxeth.js";import"./index-CpKxU2oX.js";import"./Chapters-D38Wlj-S.js";const le=s=>{if(!s.length)return[];const i=new Map;return s.forEach(p=>{var o;const l=W(J(Number(p.fetchedAt)));i.set(l,((o=i.get(l))!=null?o:0)+1)}),[...i.entries()]},Te=()=>{var w,T;const{t:s}=H(),i=N(),{setTitle:p,setAction:l}=r.useContext(U),{data:o,loading:j,error:C,fetchMore:_,refetch:E}=u.useGetRecentlyUpdatedChapters(void 0,{fetchPolicy:"cache-and-network",notifyOnNetworkStatusChange:!0}),b=!!(o!=null&&o.chapters.pageInfo.hasNextPage),L=o==null?void 0:o.chapters.pageInfo.endCursor,d=(w=o==null?void 0:o.chapters.nodes)!=null?w:[],h=r.useMemo(()=>le(d),[d]),M=r.useMemo(()=>h.map(t=>t[1]),[h]),{data:g}=u.useGetDownloadStatus(),G=(T=g==null?void 0:g.downloadStatus.queue)!=null?T:[],f=r.useRef(null),[P,R]=r.useState(0);r.useLayoutEffect(()=>{var t,a;R((a=(t=f.current)==null?void 0:t.clientHeight)!=null?a:0)},[f.current]);const{data:x}=u.useGetLastGlobalUpdateTimestamp({fetchPolicy:"cache-only"}),y=x==null?void 0:x.lastUpdateTimestamp.timestamp;r.useEffect(()=>(p(s("updates.title")),l(e.jsx(Y,{})),()=>{p(""),l(null)}),[s,y]);const A=t=>{const{sourceOrder:a,mangaId:c}=t;return G.find(n=>a===n.chapter.sourceOrder&&c===n.manga.id)},B=t=>{u.addChapterToDownloadQueue(t.id).response.catch(()=>K(s("global.error.label.failed_to_save_changes"),"error"))},F=r.useCallback(()=>{b&&_({variables:{offset:d.length}})},[b,L]);return C?e.jsx(S,{message:s("global.error.label.failed_to_load_data"),messageExtra:C.message,retry:()=>E().catch(D())}):!j&&d.length===0?e.jsx(S,{message:s("updates.error.label.no_updates_available")}):e.jsxs(e.Fragment,{children:[e.jsx(O,{ref:f,sx:{marginLeft:"10px",paddingTop:t=>({[t.breakpoints.up("sm")]:{paddingTop:"6px"}})},children:s("library.settings.global_update.label.last_update",{date:y?$.format(+y):"-"})}),e.jsx(Z,{heightToSubtract:P,style:{height:"undefined"},components:{Footer:()=>j?e.jsx(q,{usePadding:!0}):null},overscan:window.innerHeight*.5,endReached:F,groupCounts:M,groupContent:t=>e.jsx(ee,{variant:"h5",component:"h2",isFirstItem:t===0,children:h[t][0]}),itemContent:t=>{const a=d[t],{manga:c}=a,n=A(a);return e.jsx(te,{children:e.jsx(se,{children:e.jsx(re,{component:k,to:"/manga/".concat(a.manga.id,"/chapter/").concat(a.sourceOrder),state:i.state,sx:{color:m=>m.palette.text[a.isRead?"disabled":"primary"]},children:e.jsxs(ne,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:1.5},children:[e.jsxs(v,{sx:{display:"flex"},children:[e.jsx(k,{to:"/manga/".concat(a.manga.id),style:{textDecoration:"none"},children:e.jsx(ie,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",marginRight:1,background:"transparent"},children:e.jsx(oe,{imgStyle:{objectFit:"cover",width:"100%",height:"100%",imageRendering:"pixelated"},spinnerStyle:{small:!0},alt:c.title,src:ae.getThumbnailUrl(c)})})}),e.jsxs(v,{sx:{display:"flex",flexDirection:"column",justifyContent:"center",flexGrow:1,flexShrink:1,wordBreak:"break-word"},children:[e.jsx(I,{variant:"h6",component:"h3",children:c.title}),e.jsx(I,{variant:"caption",display:"block",lines:1,children:a.name})]})]}),n&&e.jsx(X,{download:n}),n==null&&!a.isDownloaded&&e.jsx(V,{title:s("chapter.action.download.add.label.action"),children:e.jsx(z,{onClick:m=>{m.stopPropagation(),m.preventDefault(),B(a)},size:"large",children:e.jsx(Q,{})})})]})})})},t)}})]})};export{Te as Updates};
