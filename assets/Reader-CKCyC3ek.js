import{c as n,j as t,B as F,a as H,af as B,r as te,i as ne,o as gt,a4 as pt,ag as ht,a2 as pe,ah as xt,ai as mt,aj as Me,s as Y,I as G,u as Ye,e as Ze,ak as Qe,al as vt,X as Ct,am as wt,g as Q,T as Rt,an as bt,V as yt,ao as Et,Q as Fe,ap as Pt,W as Lt,x as ze,N as St,n as Be,k as q,Y as jt,E as Tt,aq as Dt}from"./index-CcDVmPxM.js";import{b as X,C as T}from"./Chapters-CIqDBlOg.js";import{P as oe,i as kt,R as _t,u as Ot,g as He,c as Nt}from"./ReaderSettingsOptions-ChlD2L33.js";import{S as Ve}from"./SpinnerImage-Dw80zr-T.js";import{S as qe}from"./Select-BpBTyppc.js";import{C as At}from"./Collapse-C_qqUtl2.js";import{a as Xe}from"./TextField-G2U-r_0j.js";import{u as It}from"./useDebounce-D8g7EEuG.js";import"./NumberSetting-BpaBLGeg.js";import"./Info-Cl4r3ZKF.js";import"./InputAdornment-DMoHV6D6.js";import"./Switch-D5Z7dE-d.js";import"./SwitchBase-COJ8aiDd.js";const $t=c=>{for(let r=0;r<c.children.length;r++){const o=c.children.item(r);if(o){const{left:p,right:d}=o.getBoundingClientRect();if(p<=window.innerWidth/2&&d>window.innerWidth/2)return r}}return-1},Wt=5,Mt=()=>window.innerWidth+window.scrollX>=document.body.scrollWidth-Wt,Ft=()=>window.scrollX<=0;function zt(c){const{pages:r,curPage:o,initialPage:p,settings:d,setCurPage:a,prevChapter:u,nextChapter:m}=c,h=n.useRef(p),f=n.useRef(null),v=n.useRef([]);function P(){var e;o<r.length-1?((e=v.current[o+1])==null||e.scrollIntoView({inline:"center"}),a(l=>l+1)):d.loadNextOnEnding&&m()}function x(){var e;o>0?((e=v.current[o-1])==null||e.scrollIntoView({inline:"center"}),a(o-1)):o===0&&u()}function R(){d.readerType==="ContinuesHorizontalLTR"?x():P()}function L(){d.readerType==="ContinuesHorizontalLTR"?P():x()}const w=n.useRef(0);function i(e){window.scrollBy(w.current-e.pageX,0)}function s(e){var l;w.current=e.pageX,(l=f.current)==null||l.addEventListener("mousemove",i)}function b(){var e;(e=f.current)==null||e.removeEventListener("mousemove",i)}function D(e){e.clientX>=window.innerWidth*.85?L():e.clientX<=window.innerWidth*.15&&R()}const k=()=>{d.readerType==="ContinuesHorizontalLTR"?window.scrollX+window.innerWidth>=document.body.scrollWidth&&m():d.readerType==="ContinuesHorizontalRTL"&&window.scrollX<=window.innerWidth&&m()};return n.useLayoutEffect(()=>{const e=v.current[p];if(!e)return()=>{};const l=new ResizeObserver(()=>{e.offsetHeight&&(e.scrollIntoView({inline:"center"}),l.disconnect())});return l.observe(e),()=>l.disconnect()},[p]),n.useEffect(()=>{var e,l;return(e=f.current)==null||e.addEventListener("mousedown",s),(l=f.current)==null||l.addEventListener("mouseup",b),()=>{var E,_;(E=f.current)==null||E.removeEventListener("mousedown",s),(_=f.current)==null||_.removeEventListener("mouseup",b)}},[f]),n.useEffect(()=>(d.loadNextOnEnding&&document.addEventListener("scroll",k),()=>{document.removeEventListener("scroll",k)}),[f,o,u,m]),n.useEffect(()=>{const e=()=>{if(!f.current)return;const l=$t(f.current);l!==h.current&&(h.current=l,a(l)),(d.readerType==="ContinuesHorizontalLTR"?Mt():Ft())&&(h.current=r.length-1,a(h.current))};return window.addEventListener("scroll",e),()=>window.removeEventListener("scroll",e)},[d.readerType]),t.jsx(F,{ref:f,sx:{display:"flex",flexDirection:d.readerType==="ContinuesHorizontalLTR"?"row":"row-reverse",justifyContent:d.readerType==="ContinuesHorizontalLTR"?"flex-start":"flex-end",width:"auto",height:"auto",overflowX:"visible",userSelect:"none"},onClick:D,children:r.map(e=>t.jsx(oe,{index:e.index,src:e.src,onImageLoad:()=>{},settings:d,ref:l=>{v.current[e.index]=l}},e.index))})}function Bt(c){const{settings:r,curPage:o,pageCount:p}=c;return t.jsx(F,{sx:{display:r.showPageNumber?"block":"none",position:"fixed",bottom:"50px",padding:"2px",paddingLeft:"4px",paddingRight:"4px",textAlign:"center",backgroundColor:"rgba(0, 0, 0, 0.3)",borderRadius:"10px"},children:"".concat(o+1," / ").concat(p)})}function Ht(c){const{pages:r,settings:o,setCurPage:p,initialPage:d,curPage:a,nextChapter:u,prevChapter:m,chapter:h}=c,f=n.useRef(null);n.useEffect(()=>{const s=r.map(b=>{const D=H.requestImage(b.src);return D.response.catch(()=>{}),D});return()=>{s.forEach(b=>b.abortRequest(new Error("PagedPager::preload: chapter changed")))}},[h.id]);const v=s=>{p(s),window.scroll({top:0})};function P(){a<r.length-1?v(a+1):o.loadNextOnEnding&&u()}function x(){a>0?v(a-1):m()}function R(){o.readerType==="SingleLTR"?x():o.readerType==="SingleRTL"&&P()}function L(){o.readerType==="SingleLTR"?P():o.readerType==="SingleRTL"&&x()}function w(s){switch(s.key){case"Space":s.preventDefault(),P();break;case"ArrowRight":L();break;case"ArrowLeft":R();break}}function i(s){s.clientX>window.innerWidth/2?L():R()}return n.useEffect(()=>(document.addEventListener("keydown",w),()=>{document.removeEventListener("keydown",w)}),[f,a,o.readerType,m,u]),n.useEffect(()=>{setTimeout(()=>{v(d)},0)},[d]),t.jsx(F,{ref:f,sx:{display:"flex",flexDirection:"column",justifyContent:"center",width:"auto",height:"auto"},onClick:i,children:t.jsx(oe,{index:a,onImageLoad:()=>{},src:r[a].src,settings:o},a)})}const Vt=n.forwardRef((c,r)=>{const{image1src:o,image2src:p,index:d,onImageLoad:a,settings:u}=c,m=kt(u),h={...m,width:u.fitPageToWindow?m.width:"calc(".concat(m.width," * 0.5)"),minWidth:u.fitPageToWindow&&u.scalePage?"calc(".concat(m.minWidth," * 0.5)"):m.minWidth,maxWidth:u.fitPageToWindow?"calc(".concat(m.maxWidth," * 0.5)"):m.maxWidth},f={...h,height:"100vh",width:"50%",backgroundColor:"#525252"};return t.jsxs(F,{ref:r,sx:{display:"flex",flexDirection:u.readerType==="DoubleLTR"?"row":"row-reverse",justifyContent:"center",width:"100%"},children:[t.jsx(Ve,{src:o,onImageLoad:a,alt:"Page #".concat(d),spinnerStyle:f,imgStyle:{...h,objectPosition:u.readerType==="DoubleLTR"?B("right","left"):B("left","right")}}),t.jsx(Ve,{src:p,onImageLoad:a,alt:"Page #".concat(d+1),spinnerStyle:{...f,width:"calc(50% - 5px)",marginLeft:"5px"},imgStyle:{...h,objectPosition:u.readerType==="DoubleLTR"?B("left","right"):B("right","left")}})]})}),qt=c=>c.height/c.width<1,he=(c,r,o)=>{if(r[c]||r[c+1]||c===r.length-1)return!0;const p=r.lastIndexOf(!0,c-1),d=c-(p+1);return o?d%2===0:d%2===1};function Xt(c){const{pages:r,settings:o,setCurPage:p,initialPage:d,curPage:a,chapter:u,nextChapter:m,prevChapter:h}=c,f=n.useRef(null),[v,P]=n.useState(Array(r.length).fill(!1)),[x,R]=n.useState(Array(r.length).fill(!1));function L(){let l=1;if(a<r.length&&x[a]&&(l=1,v[a]))return l;if(a+1<r.length&&x[a+1]){if(he(a,v,o.offsetFirstPage))return l;l=2}return l}function w(){return he(a-2,v,o.offsetFirstPage)?1:2}function i(){if(a<r.length-1){const l=a+L();p(l>=r.length?r.length-1:l)}else o.loadNextOnEnding&&m()}function s(){if(a>0){const l=a-w();p(l<0?0:l)}else h()}function b(){o.readerType==="DoubleLTR"?s():i()}function D(){o.readerType==="DoubleLTR"?i():s()}function k(l){switch(l.key){case"Space":l.preventDefault(),i();break;case"ArrowRight":D();break;case"ArrowLeft":b();break}}function e(l){l.clientX>window.innerWidth/2?D():b()}return n.useEffect(()=>(document.addEventListener("keydown",k),()=>{document.removeEventListener("keydown",k)}),[f,a,o.readerType,h,m,x,v]),n.useEffect(()=>{p(d)},[d]),n.useEffect(()=>{o.offsetFirstPage?L()===2&&p(a+1):a>0&&!he(a-1,v,o.offsetFirstPage)&&p(a-1)},[o.offsetFirstPage]),n.useEffect(()=>{const l=r.map(E=>[E.index,H.requestImage(E.src)]);return l.forEach(async([E,_])=>{try{const O=await _.response,z=new Image;z.onload=()=>{URL.revokeObjectURL(O),R(A=>A.toSpliced(E,1,!0)),P(A=>A.toSpliced(E,1,qt(z)))},z.src=O}catch(O){}}),()=>{l.forEach(([E,_])=>_.abortRequest(new Error("DoublePagedPager::preload(".concat(E,"): chapter changed"))))}},[u.id]),t.jsx(F,{ref:f,onClick:e,children:t.jsx(F,{id:"display",sx:{display:"flex",flexDirection:o.readerType==="DoubleLTR"?"row":"row-reverse",justifyContent:"center",width:"auto",height:"auto"},children:L()===2?t.jsx(Vt,{index:a,image1src:r[a].src,image2src:r[a+1].src,settings:o},a):t.jsx(oe,{index:a,src:r[a].src,onImageLoad:()=>{},settings:o},a)})})}const Kt=c=>{for(let r=0;r<c.children.length;r++){const o=c.children.item(r);if(o){const{top:p,bottom:d}=o.getBoundingClientRect();if(p<=window.innerHeight&&d>1)return r}}return-1},Ut=5,Gt=.95,Ke=.25,Yt="smooth",Ue=()=>window.innerHeight+window.scrollY>=document.body.offsetHeight-Ut,Zt=()=>window.scrollY<=0;function Ge(c){const{pages:r,settings:o,setCurPage:p,initialPage:d,nextChapter:a,prevChapter:u}=c,m=n.useRef(d),h=n.useRef(null),f=n.useRef([]);n.useEffect(()=>{let i=!1;const s=()=>{if(h.current)if(Ue()){if(i)return;i=!0,m.current=r.length-1,p(m.current),o.loadNextOnEnding&&a()}else{i=!1;const b=Kt(h.current);b!==m.current&&(m.current=b,p(b))}};return window.addEventListener("scroll",s),()=>{window.removeEventListener("scroll",s)}},[o.loadNextOnEnding,a]);const v=n.useRef(0),P=n.useRef(!1);function x(i){P.current=!0,window.scrollBy(0,v.current-i.pageY)}function R(i){var s;v.current=i.pageY,(s=h.current)==null||s.addEventListener("mousemove",x)}function L(){var i;(i=h.current)==null||i.removeEventListener("mousemove",x)}n.useEffect(()=>{var i,s;return(i=h.current)==null||i.addEventListener("mousedown",R),(s=h.current)==null||s.addEventListener("mouseup",L),()=>{var b,D;(b=h.current)==null||b.removeEventListener("mousedown",R),(D=h.current)==null||D.removeEventListener("mouseup",L)}},[h]);const w=n.useCallback((i,s=Gt)=>{if(i==="down"&&Ue()){a();return}if(i==="up"&&Zt()){u();return}window.scroll({top:window.scrollY+window.innerHeight*s*(i==="up"?-1:1),behavior:Yt})},[a,u]);return n.useEffect(()=>{const i=s=>{switch(s.key){case"Space":s.preventDefault(),w(s.shiftKey?"up":"down");break;case"ArrowDown":s.preventDefault(),w(s.shiftKey?"up":"down",Ke);break;case"ArrowRight":s.preventDefault(),w(s.shiftKey?"up":"down");break;case"ArrowUp":s.preventDefault(),w(s.shiftKey?"down":"up",Ke);break;case"ArrowLeft":s.preventDefault(),w(s.shiftKey?"down":"up");break}};return document.addEventListener("keydown",i,!1),()=>{document.removeEventListener("keydown",i)}},[w]),n.useLayoutEffect(()=>{const i=f.current[d];if(!i)return()=>{};const s=new ResizeObserver(()=>{i.offsetHeight&&(i.scrollIntoView(),s.disconnect())});return s.observe(i),()=>s.disconnect()},[d]),t.jsx(F,{ref:h,sx:{display:"flex",flexDirection:"column",justifyContent:"center",width:"auto",height:"auto",userSelect:"none"},onClick:i=>{if(P.current){P.current=!1;return}w(i.clientX>window.innerWidth/2?"down":"up")},children:r.map(i=>t.jsx(oe,{index:i.index,src:i.src,onImageLoad:()=>{},settings:o,ref:s=>{f.current[i.index]=s}},i.index))})}var me={},Qt=ne;Object.defineProperty(me,"__esModule",{value:!0});var Je=me.default=void 0,Jt=Qt(te()),en=t;Je=me.default=(0,Jt.default)((0,en.jsx)("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Close");var ve={},tn=ne;Object.defineProperty(ve,"__esModule",{value:!0});var J=ve.default=void 0,nn=tn(te()),rn=t;J=ve.default=(0,nn.default)((0,rn.jsx)("path",{d:"M15.41 16.59 10.83 12l4.58-4.59L14 6l-6 6 6 6z"}),"KeyboardArrowLeft");var Ce={},an=ne;Object.defineProperty(Ce,"__esModule",{value:!0});var ee=Ce.default=void 0,sn=an(te()),on=t;ee=Ce.default=(0,sn.default)((0,on.jsx)("path",{d:"M8.59 16.59 13.17 12 8.59 7.41 10 6l6 6-6 6z"}),"KeyboardArrowRight");var we={},cn=ne;Object.defineProperty(we,"__esModule",{value:!0});var et=we.default=void 0,ln=cn(te()),dn=t;et=we.default=(0,ln.default)((0,dn.jsx)("path",{d:"M7.41 8.59 12 13.17l4.59-4.58L18 10l-6 6-6-6z"}),"KeyboardArrowDown");var Re={},un=ne;Object.defineProperty(Re,"__esModule",{value:!0});var tt=Re.default=void 0,fn=un(te()),gn=t;tt=Re.default=(0,fn.default)((0,gn.jsx)("path",{d:"M7.41 15.41 12 10.83l4.59 4.58L18 14l-6-6-6 6z"}),"KeyboardArrowUp");const pn=["addEndListener","appear","children","easing","in","onEnter","onEntered","onEntering","onExit","onExited","onExiting","style","timeout","TransitionComponent"],hn={entering:{transform:"none"},entered:{transform:"none"}},xn=n.forwardRef(function(r,o){const p=gt(),d={enter:p.transitions.duration.enteringScreen,exit:p.transitions.duration.leavingScreen},{addEndListener:a,appear:u=!0,children:m,easing:h,in:f,onEnter:v,onEntered:P,onEntering:x,onExit:R,onExited:L,onExiting:w,style:i,timeout:s=d,TransitionComponent:b=xt}=r,D=pt(r,pn),k=n.useRef(null),e=ht(k,m.ref,o),l=g=>C=>{if(g){const I=k.current;C===void 0?g(I):g(I,C)}},E=l(x),_=l((g,C)=>{mt(g);const I=Me({style:i,timeout:s,easing:h},{mode:"enter"});g.style.webkitTransition=p.transitions.create("transform",I),g.style.transition=p.transitions.create("transform",I),v&&v(g,C)}),O=l(P),z=l(w),A=l(g=>{const C=Me({style:i,timeout:s,easing:h},{mode:"exit"});g.style.webkitTransition=p.transitions.create("transform",C),g.style.transition=p.transitions.create("transform",C),R&&R(g)}),N=l(L),M=g=>{a&&a(k.current,g)};return t.jsx(b,pe({appear:u,in:f,nodeRef:k,onEnter:_,onEntered:O,onEntering:E,onExit:A,onExited:N,onExiting:z,addEndListener:M,timeout:s},D,{children:(g,C)=>n.cloneElement(m,pe({style:pe({transform:"scale(0)",visibility:g==="exited"&&!f?"hidden":void 0},hn[g],i,m.props.style),ref:e},C))}))}),mn=xn,vn=Y("div")({zIndex:10}),Cn=Y("div")(({theme:c})=>({top:0,left:0,width:"300px",minWidth:"300px",height:"100vh",overflowY:"auto",backgroundColor:c.palette.background.default,"& header":{backgroundColor:c.palette.action.hover,display:"flex",alignItems:"center",minHeight:"64px",paddingLeft:"24px",paddingRight:"24px",transition:"left 2s ease","& button":{flexGrow:0,flexShrink:0},"& button:nth-child(1)":{marginRight:"16px"},"& h1":{fontSize:"1.25rem",flexGrow:1}}})),wn=Y("div")({margin:"0 16px","& > span:nth-child(1)":{textAlign:"center",display:"block",marginTop:"16px"}}),Rn=Y("div")({display:"flex",flexWrap:"wrap",alignContent:"center",alignItems:"center",justifyContent:"center"}),bn=Y("div")({display:"grid",gridTemplateRows:"auto auto auto",gridTemplateColumns:"0fr 1fr 0fr",gridTemplateAreas:'"pre current next"',gridColumnGap:"5px",margin:"10px 0","& a":{textDecoration:"none",color:"inherit",display:"flex",flexWrap:"wrap",alignContent:"center"}}),yn=Y(G)(({theme:c})=>({position:"fixed",top:20,left:30,height:"40px",width:"40px",borderRadius:5,backgroundColor:c.palette.custom.main,"&:hover":{backgroundColor:c.palette.custom.light}}));function En(c){var M;const{t:r}=Ye(),o=Ze(),p=Qe(),{prevDrawerOpen:d,prevSettingsCollapseOpen:a}=(M=p.state)!=null?M:{},{settings:u,setSettingValue:m,manga:h,chapter:f,curPage:v,scrollToPage:P,openNextChapter:x,retrievingNextChapter:R}=c,L=vt();Ct("/manga/".concat(h.id));const[w,i]=n.useState(u.staticNav||d),[s,b]=n.useState(!0),[D,k]=n.useState(u.staticNav||d),[e,l]=n.useState(0),[E,_]=n.useState(a!=null?a:!0),O=R,z=(g,C,I)=>{b(g!=="staticNav"),m(g,C,I)},A=g=>{i(g),k(g)},N=()=>{const g=window.pageYOffset;Math.abs(g-e)>20&&(k(g>e),l(g))};return n.useEffect(()=>{s&&A(u.staticNav)},[u.staticNav]),n.useEffect(()=>{window.addEventListener("scroll",N);const g=document.querySelector("#root"),C=document.querySelector("#appMainContainer");return g.style.display="flex",g.style.flexDirection="column",C.style.display="none",()=>{g.style.display="block",C.style.display="block",window.removeEventListener("scroll",N)}},[N]),t.jsxs(vn,{children:[t.jsx(wt,{direction:B("right","left"),in:w,timeout:200,appear:!1,mountOnEnter:!0,unmountOnExit:!0,children:t.jsxs(Cn,{sx:{position:"fixed"},children:[t.jsxs("header",{children:[!u.staticNav&&t.jsx(Q,{title:r("reader.button.close_menu"),children:t.jsx(G,{edge:"start",color:"inherit","aria-label":"menu",disableRipple:!0,onClick:()=>A(!1),size:"large",children:B(t.jsx(J,{}),t.jsx(ee,{}))})}),t.jsx(Rt,{variant:"h1",textOverflow:"ellipsis",overflow:"hidden",sx:{py:1},children:f.name}),t.jsx(Q,{title:r("reader.button.exit"),children:t.jsx(G,{edge:"start",color:"inherit","aria-label":"menu",disableRipple:!0,onClick:L,size:"large",sx:{mr:-1},children:t.jsx(Je,{})})})]}),t.jsxs(bt,{ContainerComponent:"div",sx:{"& span":{fontWeight:"bold"}},children:[t.jsx(yt,{primary:r("reader.settings.title.reader_settings")}),t.jsxs(G,{edge:"start",color:"inherit","aria-label":"menu",disableRipple:!0,disableFocusRipple:!0,onClick:()=>_(!E),size:"large",children:[E&&t.jsx(tt,{}),!E&&t.jsx(et,{})]})]}),t.jsx(At,{in:E,timeout:"auto",unmountOnExit:!0,children:t.jsx(_t,{setSettingValue:z,staticNav:u.staticNav,showPageNumber:u.showPageNumber,loadNextOnEnding:u.loadNextOnEnding,skipDupChapters:u.skipDupChapters,fitPageToWindow:u.fitPageToWindow,scalePage:u.scalePage,readerType:u.readerType,offsetFirstPage:u.offsetFirstPage,readerWidth:u.readerWidth})}),t.jsx(Et,{sx:{my:1,mx:2}}),t.jsxs(wn,{children:[t.jsxs(Rn,{children:[t.jsx("span",{children:r("reader.page_info.label.currently_on_page")}),t.jsx(Xe,{size:"small",sx:{margin:"0 5px"},disabled:O||f.pageCount===-1,children:t.jsx(qe,{value:f.pageCount>-1?"".concat(v):"",displayEmpty:!0,onChange:({target:{value:g}})=>{P(Number(g))},children:Array(Math.max(0,f.pageCount)).fill(1).map((g,C)=>t.jsx(Fe,{value:C,children:C+1},"Page#".concat(C)))})}),t.jsx("span",{children:r("reader.page_info.label.of_max_pages",{maxPages:f.pageCount})})]}),t.jsxs(bn,{children:[t.jsx(Q,{title:r("reader.button.previous_chapter"),children:t.jsx(G,{sx:{gridArea:"pre"},disabled:O||f.sourceOrder<=1,onClick:()=>x(X.PREV),children:B(t.jsx(J,{}),t.jsx(ee,{}))})}),t.jsx(Xe,{sx:{gridArea:"current"},size:"small",disabled:O||f.sourceOrder<1,children:t.jsx(qe,{value:f.sourceOrder>=1?"".concat(f.sourceOrder):"",displayEmpty:!0,onChange:({target:{value:g}})=>{o("/manga/".concat(h.id,"/chapter/").concat(g),{replace:!0,state:{prevDrawerOpen:w,prevSettingsCollapseOpen:E}})},children:Array(Math.max(0,h.chapters.totalCount)).fill(1).map((g,C)=>t.jsx(Fe,{value:C+1,children:"".concat(r("chapter.title")," ").concat(C+1)},"Chapter#".concat(C+1)))})}),t.jsx(Q,{title:r("reader.button.next_chapter"),children:t.jsx(G,{sx:{gridArea:"next"},disabled:O||f.sourceOrder<1||f.sourceOrder>=h.chapters.totalCount,onClick:()=>x(X.NEXT),children:B(t.jsx(ee,{}),t.jsx(J,{}))})})]})]})]})}),t.jsx(mn,{in:!w,children:t.jsx(Pt,{in:!D,children:t.jsx(Q,{title:r("reader.button.open_menu"),children:t.jsx(yn,{edge:"start","aria-label":"menu",disableRipple:!0,disableFocusRipple:!0,onClick:()=>A(!0),size:"large",children:B(t.jsx(ee,{}),t.jsx(J,{}))})})})})]})}const Pn=c=>{switch(c){case"ContinuesVertical":case"Webtoon":return Ge;case"SingleVertical":case"SingleRTL":case"SingleLTR":return Ht;case"DoubleVertical":case"DoubleRTL":case"DoubleLTR":return Xt;case"ContinuesHorizontalLTR":case"ContinuesHorizontalRTL":return zt;default:return Ge}},Ln=c=>Array.from({length:c},(r,o)=>o),xe={pageCount:-1,sourceOrder:-1,chapterCount:0,lastPageRead:0,name:"Loading..."};function zn(){var ke,_e,Oe,Ne,Ae,Ie,$e;const{t:c}=Ye(),r=Ze(),o=Qe(),{chapterIndex:p,mangaId:d}=Lt(),a=n.useMemo(()=>({id:+d,title:"",thumbnailUrl:"",genre:[],inLibraryAt:0,lastReadAt:0,chapters:{totalCount:0},trackRecords:{totalCount:0}}),[d]),{data:u,loading:m,error:h,refetch:f}=H.useGetManga(d),v=n.useRef(null),P=Number(d)===((ke=v.current)==null?void 0:ke.manga.id)&&Number(p)===((_e=v.current)==null?void 0:_e.sourceOrder)&&((Oe=v.current)==null?void 0:Oe.pageCount)!==-1,x=(Ne=u==null?void 0:u.manga)!=null?Ne:a,{data:R,loading:L,error:w,refetch:i}=H.useGetMangaChapter(d,p,{notifyOnNetworkStatusChange:!0}),s=n.useRef(!1),{settings:{downloadAheadLimit:b}}=ze(),D=!!b,k=()=>{var W;return v.current&&P?(R==null?void 0:R.chapter)&&((W=v.current)==null?void 0:W.pageCount)!==R.chapter.pageCount?R.chapter:v.current:(s.current=!1,R!=null&&R.chapter?R.chapter:null)};v.current=k();const e=(Ae=v.current)!=null?Ae:xe,[l,{loading:E,error:_}]=H.useGetChapterPagesFetch(e.id),O=()=>{!L&&!e.isDownloaded?l().then(()=>{s.current=!0}).catch(q()):s.current=!0};n.useEffect(()=>{O()},[e.id]);const[z,A]=n.useState(!1),[N,M]=n.useState(0),g=N===e.pageCount-1,C=It(N,g?0:1e3),[I,nt]=n.useState(void 0),{setOverride:be,setTitle:ye}=n.useContext(St),[Ee,Pe]=n.useState(!1),{data:ie,loading:rt,error:Le,refetch:at}=H.useGetMangaChapters(d,{nextFetchPolicy:"standby"}),y=ie==null?void 0:ie.chapters.nodes,ce=m||L||rt||E||!s.current&&!w&&!_,Se=($e=(Ie=h!=null?h:w)!=null?Ie:Le)!=null?$e:_,{settings:le,loading:je}=Ot(),[S,Te]=n.useState(He(x,le)),{settings:re}=ze(),st=n.useMemo(()=>T.getNextChapters(e,y!=null?y:[],{offset:X.PREV,skipDupe:S.skipDupChapters}),[e,y,S.skipDupChapters]),ot=n.useMemo(()=>T.getNextChapters(e,y!=null?y:[],{skipDupe:S.skipDupChapters}),[e,y,S.skipDupChapters]),ae=n.useMemo(()=>T.getNextChapter(e,y!=null?y:[],{offset:X.PREV,skipDupe:S.skipDupChapters}),[e,y,S.skipDupChapters]),K=n.useMemo(()=>T.getNextChapter(e,y!=null?y:[],{skipDupe:S.skipDupChapters}),[e,y,S.skipDupChapters]),De=j=>{if(e===xe)return;const $=()=>{if(!(!!j.isRead&&!!re.deleteChaptersWhileReading)||!y)return[];const U=[e,...st][re.deleteChaptersWhileReading-1];if(!U)return[];const ue=T.getFromCache(U.id);return ue.isRead&&T.isDeletable(ue,re.deleteChaptersWithBookmark)?S.skipDupChapters?T.getIds(T.addDuplicates([U],y)):T.getIds([U]):[]};(()=>{var fe;const se=T.getFromCache(e.id),U=((fe=j.lastPageRead)!=null?fe:0)/e.pageCount>.25;if(D&&e.manga.inLibrary&&!!(se!=null&&se.isDownloaded)&&U){const ge=K?T.getFromCache(K.id):null;if(!(ge!=null&&ge.isDownloaded))return;const We=T.getNonRead(ot).map(V=>T.getFromCache(V.id)).slice(-b).filter(V=>!V.isDownloaded).map(V=>V.id).filter(V=>!T.isDownloading(V));if(!We.length)return;T.download(We).catch(q())}})();const de=S.skipDupChapters?T.getIds(T.addDuplicates([e],y!=null?y:[e])):[e.id];H.updateChapters(de,{...j,chapterIdsToDelete:$(),trackProgressMangaId:re.updateProgressAfterReading&&j.isRead&&x.trackRecords.totalCount?x.id:void 0}).response.catch(q())},it=(j,$,W=!0)=>{Te({...S,[j]:$}),W&&Dt(x,[[j,$]]).catch(()=>Be(c("reader.settings.error.label.failed_to_save_settings"),"warning"))},Z=n.useCallback(j=>{const $=j===X.NEXT,W=$?K:ae;if(!W){Be(c($?"reader.error.label.next_chapter_does_not_exist":"reader.error.label.prev_chapter_does_not_exist"),"error");return}Pe(!0),M(0),r("/manga/".concat(x.id,"/chapter/").concat(W.sourceOrder),{replace:!0,state:o.state}),Pe(!1)},[x.id,ae==null?void 0:ae.id,K==null?void 0:K.id]);n.useEffect(()=>{if(ce||!e){M(0);return}A(!0),e.lastPageRead===e.pageCount-1?M(0):M(e.lastPageRead)},[e,ce]),n.useEffect(()=>{!(x!=null&&x.title)||e.name===c("global.label.loading")?ye(c("reader.title")):ye("".concat(x.title,": ").concat(e.name))},[c,x,e]),n.useEffect(()=>{!je&&!m&&(Nt(x,"manga",le).catch(q()),Te(He(x,le)))},[je,m]),n.useEffect(()=>(be({status:!0,value:t.jsx(En,{settings:S,setSettingValue:it,manga:x,chapter:e,curPage:N,scrollToPage:nt,openNextChapter:Z,retrievingNextChapter:Ee})}),()=>be({status:!1,value:t.jsx("div",{})})),[x,e,S,N,p,Ee]),n.useEffect(()=>{if(!z||e===xe)return;const j=T.getFromCache(e.id);if(C===(j==null?void 0:j.lastPageRead))return;const $=C!==-1,W=C===e.pageCount-1;($||W)&&De({lastPageRead:$?C:void 0,isRead:W?!0:void 0})},[C,D]);const ct=n.useCallback(()=>{De({lastPageRead:e.pageCount-1,isRead:!0}),Z(X.NEXT)},[e.pageCount,Z,e,x]),lt=n.useCallback(()=>{Z(X.PREV)},[Z]);if(ce)return t.jsx(F,{sx:{height:"100vh",width:"100vw",display:"grid",placeItems:"center"},children:t.jsx(jt,{thickness:5})});if(Se)return t.jsx(Tt,{message:c("global.error.label.failed_to_load_data"),messageExtra:Se.message,retry:()=>{h&&f().catch(q()),w&&i().catch(q()),Le&&at().catch(q()),_&&O()}});const dt=Ln(e.pageCount).map(j=>({index:j,src:H.getChapterPageUrl(d,p,j)})),ut=Pn(S.readerType),ft=I!=null?I:e.lastPageRead===e.pageCount-1?0:e.lastPageRead;return t.jsxs(F,{sx:{display:"flex",flexDirection:"column",alignContent:"center",alignItems:"center",justifyContent:"center",minWidth:S.staticNav?"calc((100vw - (100vw - 100%)) - 300px)":"calc(100vw - (100vw - 100%))",minHeight:"100vh",marginLeft:S.staticNav?"300px":"unset"},children:[t.jsx(Bt,{settings:S,curPage:N,pageCount:e.pageCount}),t.jsx(F,{sx:{alignSelf:"stretch"},children:t.jsx(ut,{pages:dt,pageCount:e.pageCount,setCurPage:M,initialPage:ft,curPage:N,settings:S,manga:x,chapter:e,nextChapter:ct,prevChapter:lt},e.id)})]})}export{zn as Reader};
