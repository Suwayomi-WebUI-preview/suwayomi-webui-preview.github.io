import{r as Ae,i as be,j as e,s as xe,u as _,L as v,B as y,a as T,T as L,b as D,c as l,N as V,d as B,e as ve,f as ce,g as he,I as me,h as X,E as G,k as C,l as z,m as ye,n as Ce,M as _e,o as Oe,S as we,D as N,p as Ue,q as De}from"./index-DfklFglD.js";import{t as F,L as fe,i as Pe,E as f}from"./LangSelect-DjGh5bIi.js";import{SourceContentType as M}from"./SourceMangas-CHWHcMwM.js";import{S as K}from"./SpinnerImage-DA4-HJ6P.js";import{C as Q,a as ge}from"./index-BfzuAxR7.js";import{C as Y}from"./TypographyMaxLines-DOEP0QdL.js";import{A as J}from"./Avatar-TRL1BSE6.js";import{f as ke}from"./file-selector-B69GXZVk.js";import{d as Re}from"./Add-DoVzG8lM.js";import{u as Me,S as Be,A as Ge}from"./AppbarSearch-BSOHiWG4.js";import{S as Fe,a as $e}from"./StyledGroupHeader-D3k7Ti_V.js";import{S as Le}from"./StyledGroupItemWrapper-BvaswPIp.js";import{T as H,a as W}from"./Tabs-C7c999sV.js";import{T as qe,a as He}from"./TabsMenu-CjhlR_Bh.js";import{C as We}from"./Chip-DGoyOcek.js";import"./FilterList-Cf78USv8.js";import"./cloneObject-DrOPTG0J.js";import"./Switch-CaZqNdcE.js";import"./SwitchBase-DFDorVSP.js";import"./TextField-CayxvvBt.js";import"./Favorite-BaNp7ZbC.js";import"./GridLayouts-B7DfmpTw.js";import"./ViewModule-Cn3Y_LUv.js";import"./Checkbox-l9Tb8bBM.js";import"./ListPreference-B-GstjFg.js";import"./Delete-Bn34JGUD.js";import"./SortRadioInput-ClQkMCJg.js";import"./CheckboxInput-KCsH1oYu.js";import"./Collapse-DsmQb-eo.js";import"./useDebounce-DYhkU9HH.js";import"./InputAdornment-B2lMFbn_.js";import"./ThreeStateCheckboxInput-byB4M3Hy.js";import"./StyledFab-B6X76Drs.js";import"./useManageMangaLibraryState-DTqcBB_c.js";import"./Trackers-y2kGZe-r.js";import"./Info-DxG20Nd6.js";import"./Link-D9Tvr723.js";import"./NumberSetting-CddEK8v8.js";import"./useMobilePicker-Dg4A6As7.js";import"./SelectSetting-DWEEpxNL.js";import"./Select-DN6lQiuD.js";import"./Mangas-B_3FaMhn.js";import"./Chapters-Bfm-begS.js";import"./MangaGrid-DDlUynYy.js";import"./Sync-C3x00COy.js";import"./PlayArrow-BXdB74U9.js";var Z={},Ve=be;Object.defineProperty(Z,"__esModule",{value:!0});var Te=Z.default=void 0,Xe=Ve(Ae()),ze=e;Te=Z.default=(0,Xe.default)((0,ze.jsx)("path",{d:"M19.3 16.9c.4-.7.7-1.5.7-2.4 0-2.5-2-4.5-4.5-4.5S11 12 11 14.5s2 4.5 4.5 4.5c.9 0 1.7-.3 2.4-.7l3.2 3.2 1.4-1.4zm-3.8.1c-1.4 0-2.5-1.1-2.5-2.5s1.1-2.5 2.5-2.5 2.5 1.1 2.5 2.5-1.1 2.5-2.5 2.5M12 20v2C6.48 22 2 17.52 2 12S6.48 2 12 2c4.84 0 8.87 3.44 9.8 8h-2.07c-.64-2.46-2.4-4.47-4.73-5.41V5c0 1.1-.9 2-2 2h-2v2c0 .55-.45 1-1 1H8v2h2v3H9l-4.79-4.79C4.08 10.79 4 11.38 4 12c0 4.41 3.59 8 8 8"}),"TravelExplore");const Ke=xe("div")(({theme:t})=>({display:"flex",[t.breakpoints.up("sm")]:{display:"none"}})),Qe=xe("div")(({theme:t})=>({display:"flex",[t.breakpoints.down("sm")]:{display:"none"},"& .MuiButton-root":{marginLeft:"20px"}})),Ye=t=>{const{t:s}=_(),{source:{id:n,name:o,lang:c,iconUrl:r,supportsLatest:m,isNsfw:x,extension:{repo:E}},showSourceRepo:i}=t;return e.jsx(Q,{sx:{margin:"10px",marginTop:0},children:e.jsx(ge,{component:v,to:"/sources/".concat(n),state:{contentType:M.POPULAR,clearCache:!0},children:e.jsxs(Y,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:2},children:[e.jsxs(y,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(J,{variant:"rounded",alt:o,sx:{width:56,height:56,flex:"0 0 auto",mr:2,background:"transparent"},children:e.jsx(K,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:o,src:T.getValidImgUrlFor(r)})}),e.jsxs(y,{sx:{display:"flex",flexDirection:"column",justifyContent:"center"},children:[e.jsx(L,{variant:"h5",component:"h2",children:o}),n!=="0"&&e.jsxs(L,{variant:"caption",display:"block",gutterBottom:!0,children:[F(c),x&&e.jsx(L,{variant:"caption",display:"inline",gutterBottom:!0,color:"red",children:" 18+"}),i&&e.jsx(L,{variant:"caption",display:"block",children:E})]})]})]}),e.jsxs(e.Fragment,{children:[e.jsx(Ke,{children:m&&e.jsx(D,{variant:"outlined",component:v,to:"/sources/".concat(n),state:{contentType:M.LATEST,clearCache:!0},children:s("global.button.latest")})}),e.jsxs(Qe,{children:[m&&e.jsx(D,{variant:"outlined",component:v,to:"/sources/".concat(n),state:{contentType:M.LATEST,clearCache:!0},children:s("global.button.latest")}),e.jsx(D,{variant:"outlined",component:v,to:"/sources/".concat(n),state:{contentType:M.POPULAR,clearCache:!0},children:s("global.button.popular")})]})]})]})})})};function Je(t){const s=[];return t.forEach(n=>{s.indexOf(n.lang)===-1&&s.push(n.lang)}),s.sort(z),s}function Ze(t){const s={};return t.forEach(n=>{s[n.lang]===void 0&&(s[n.lang]=[]),s[n.lang].push(n)}),s}function et(){const{t}=_(),{setAction:s}=l.useContext(V),[n,o]=B("shownSourceLangs",ye()),[c]=B("showNsfw",!0),{data:r,loading:m,error:x,refetch:E}=T.useGetSourceList({notifyOnNetworkStatusChange:!0}),i=r==null?void 0:r.sources.nodes,j=l.useMemo(()=>{if(!i||i!=null&&i.length)return!1;const{repo:d}=i[0].extension;return i.some(h=>h.extension.repo!==d)},[i]),O=ve();return l.useEffect(()=>{ce().forEach(d=>{let h=!1;n.forEach(p=>{p===d&&(h=!0)}),h||o(p=>(p.push(d),p))})},[]),l.useEffect(()=>(s(e.jsxs(e.Fragment,{children:[e.jsx(he,{title:t("search.title.global_search"),children:e.jsx(me,{onClick:()=>O("/sources/all/search/"),size:"large",children:e.jsx(Te,{})})}),e.jsx(fe,{shownLangs:n,setShownLangs:o,allLangs:Je(i!=null?i:[]),forcedLangs:ce()})]})),()=>{s(null)}),[t,n,i]),m?e.jsx(X,{}):x?e.jsx(G,{message:t("global.error.label.failed_to_load_data"),messageExtra:x.message,retry:()=>E().catch(C())}):(i==null?void 0:i.length)===0?e.jsx(G,{message:t("source.error.label.no_sources_found")}):e.jsx(e.Fragment,{children:Object.entries(Ze(i!=null?i:[])).sort((d,h)=>z(d[0],h[0])).map(([d,h])=>n.indexOf(d)!==-1&&e.jsxs(l.Fragment,{children:[e.jsx(L,{variant:"h4",style:{paddingLeft:"24px",paddingTop:"6px",paddingBottom:"16px",fontWeight:"bold"},children:F(d)},d),h.filter(p=>c||!p.isNsfw).map(p=>e.jsx(Ye,{source:p,showSourceRepo:j},p.id))]},d))})}var Ee=(t=>(t.UPDATE="UPDATE",t.UNINSTALL="UNINSTALL",t.INSTALL="INSTALL",t))(Ee||{}),Se=(t=>(t.OBSOLETE="OBSOLETE",t.UPDATING="UPDATING",t.UNINSTALLING="UNINSTALLING",t.INSTALLING="INSTALLING",t))(Se||{});const g={...Ee,...Se},tt={UPDATE:"UPDATING",UNINSTALL:"UNINSTALLING",INSTALL:"INSTALLING"},nt={UPDATE:"UNINSTALL",UNINSTALL:"INSTALL",INSTALL:"UNINSTALL"},st={[g.UNINSTALL]:"extension.action.label.uninstall",[g.INSTALL]:"extension.action.label.install",[g.UPDATE]:"extension.action.label.update",[g.OBSOLETE]:"extension.state.label.obsolete",[g.UPDATING]:"extension.state.label.updating",[g.UNINSTALLING]:"extension.state.label.uninstalling",[g.INSTALLING]:"extension.state.label.installing"},rt={UPDATE:"extension.label.update_failed",INSTALL:"extension.label.installation_failed",UNINSTALL:"extension.label.uninstallation_failed"},ue=(t,s,n)=>s?g.OBSOLETE:n?g.UPDATE:t?g.UNINSTALL:g.INSTALL;function at(t){const{t:s}=_(),{extension:{name:n,lang:o,versionName:c,isInstalled:r,hasUpdate:m,isObsolete:x,pkgName:E,iconUrl:i,isNsfw:j,repo:O},handleUpdate:d,showSourceRepo:h}=t,[p,w]=l.useState(ue(r,x,m)),P=o==="all"?s("extension.language.all"):o.toUpperCase(),b=async I=>{const S=nt[I],k=tt[I];try{switch(w(k),I){case"INSTALL":await T.updateExtension(E,{install:!0,isObsolete:x}).response;break;case"UNINSTALL":await T.updateExtension(E,{uninstall:!0,isObsolete:x}).response;break;case"UPDATE":await T.updateExtension(E,{update:!0,isObsolete:x}).response;break;default:throw new Error('Unexpected ExtensionAction "'.concat(I,'"'))}w(S),d()}catch(q){w(ue(r,x,m)),Ce(s(rt[I]),"error")}};function $(){switch(p){case"INSTALL":case"UPDATE":case"UNINSTALL":b(p).catch(C());break;case"OBSOLETE":b("UNINSTALL").catch(C());break}}return e.jsx(Q,{children:e.jsxs(Y,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",p:2,"&:last-child":{paddingBottom:2}},children:[e.jsxs(y,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(J,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",mr:2,background:"transparent"},alt:n,children:e.jsx(K,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:n,src:T.getValidImgUrlFor(i)})}),e.jsxs(y,{sx:{display:"flex",flexDirection:"column"},children:[e.jsx(L,{variant:"h5",component:"h2",children:n}),e.jsxs(L,{variant:"caption",display:"block",children:[P," ",c,j&&e.jsx(L,{variant:"caption",display:"inline",color:"red",children:" 18+"})]}),h&&e.jsx(L,{variant:"caption",display:"block",children:O})]})]}),e.jsx(D,{variant:"outlined",sx:{color:p===g.OBSOLETE?"red":"inherit"},onClick:()=>$(),children:s(st[p])})]})})}const de=0,pe=1;function ot(t){const s=[],n={[f.OBSOLETE]:[],[f.INSTALLED]:[],[f.UPDATE_PENDING]:[],[N.ALL]:[],[N.OTHER]:[],[N.LOCAL_SOURCE]:[]};t.forEach(r=>{if(n[r.lang]===void 0&&(n[r.lang]=[],r.lang!=="all"&&s.push(r.lang)),r.isInstalled){if(r.hasUpdate){n[f.UPDATE_PENDING].push(r);return}if(r.isObsolete){n[f.OBSOLETE].push(r);return}n[f.INSTALLED].push(r)}else n[r.lang].push(r)}),s.sort(z);const o=[[f.OBSOLETE,n[f.OBSOLETE]],[f.UPDATE_PENDING,n[f.UPDATE_PENDING]],[f.INSTALLED,n[f.INSTALLED]],[N.ALL,n[N.ALL]],[N.OTHER,n[N.OTHER]],[N.LOCAL_SOURCE,n[N.LOCAL_SOURCE]]],c=s.map(r=>[r,n[r]]);return{allLangs:s,groupedExtensions:o.concat(c)}}function it(){var ie,le;const{t}=_(),{setAction:s}=l.useContext(V),n=_e.useIsMobileWidth(),{data:o,loading:c,error:r,refetch:m}=T.useGetServerSettings({notifyOnNetworkStatusChange:!0}),x=!!(o!=null&&o.settings.extensionRepos.length),E=((ie=o==null?void 0:o.settings.extensionRepos.length)!=null?ie:0)>1,i=l.useRef(null),[j,O]=B("shownExtensionLangs",Ue()),[d]=B("showNsfw",!0),[h]=Me("query",Be),[p,w]=l.useState({}),[P,{data:b,loading:$,error:I}]=T.useExtensionListFetch(),S=(le=b==null?void 0:b.fetchExtensions)==null?void 0:le.extensions,k=l.useCallback(()=>w({}),[]);l.useEffect(()=>{P()},[p]);const q=l.useMemo(()=>(S!=null?S:[]).filter(a=>{const u=d||!a.isNsfw;return h?u&&a.name.toLowerCase().includes(h.toLowerCase()):u}),[S,d,h]),{allLangs:ee,groupedExtensions:te}=l.useMemo(()=>ot(q),[q]),U=l.useMemo(()=>te.filter(a=>a[pe].length>0).filter(a=>Pe(a[de])||j.includes(a[de])),[j,te]),Ne=l.useMemo(()=>U.map(a=>a[pe].length),[U]),ne=l.useMemo(()=>U.map(([,a])=>a).flat(1),[U]),[se,R]=Oe(l.useState([])),re=a=>{a.name.toLowerCase().endsWith("apk")?(i.current&&(i.current.value=""),R(t("extension.label.installing_file"),"info"),T.installExternalExtension(a).response.then(()=>{k(),R(t("extension.label.installed_successfully"),"success")}).catch(()=>R(t("extension.label.installation_failed"),"error"))):R(t("global.error.label.invalid_file_type"),"error")};l.useEffect(()=>(s(e.jsxs(e.Fragment,{children:[e.jsx(Ge,{}),e.jsx(he,{title:t("extension.action.label.install_external"),children:e.jsx(me,{onClick:()=>{var a;return(a=i.current)==null?void 0:a.click()},size:"large",children:e.jsx(Re,{})})}),e.jsx(fe,{shownLangs:j,setShownLangs:O,allLangs:ee})]})),()=>{s(null)}),[t,j,ee]),l.useEffect(()=>{const a=async A=>{A.preventDefault();const Ie=await ke(A);re(Ie[0])},u=A=>{A.preventDefault()};return document.addEventListener("drop",a),document.addEventListener("dragover",u),()=>{document.removeEventListener("drop",a),document.removeEventListener("dragover",u)}},[]);const ae=l.useMemo(()=>e.jsx("input",{type:"file",style:{display:"none"},ref:i,onChange:a=>{var A;const u=(A=a.target.files)==null?void 0:A[0];u&&re(u)}}),[]),je=c||$,oe=r!=null?r:I;return je?e.jsx(X,{}):oe?e.jsx(G,{message:t("global.error.label.failed_to_load_data"),messageExtra:oe.message,retry:()=>{r&&m().catch(C()),I&&P().catch(C())}}):!(S!=null&&S.length)&&!x?e.jsxs(e.Fragment,{children:[se,ae,e.jsxs(we,{sx:{paddingTop:"20px"},alignItems:"center",justifyContent:"center",rowGap:"10px",children:[e.jsx(L,{children:t("extension.label.add_repository_info")}),e.jsx(D,{component:v,variant:"contained",to:"/settings/browseSettings",children:t("settings.title")})]})]}):e.jsxs(e.Fragment,{children:[se,ae,e.jsx(Fe,{style:{height:"undefined"},heightToSubtract:n?48:53,overscan:window.innerHeight*.5,groupCounts:Ne,groupContent:a=>{const[u]=U[a];return e.jsx($e,{variant:"h4",style:{paddingLeft:"24px",paddingTop:"6px",paddingBottom:"16px",fontWeight:"bold"},isFirstItem:a===0,children:F(u)},u)},itemContent:a=>{const u=ne[a];return e.jsx(Le,{isLastItem:a===ne.length-1,children:e.jsx(at,{extension:u,handleUpdate:k,showSourceRepo:E})},"".concat(u.pkgName,"_").concat(u.isInstalled,"_").concat(u.isObsolete,"_").concat(u.hasUpdate))}})]})}const lt=({id:t,name:s,lang:n,iconUrl:o,mangaCount:c})=>e.jsx(Q,{children:e.jsx(ge,{component:v,to:"/migrate/source/".concat(t,"/"),children:e.jsxs(Y,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",p:2},children:[e.jsxs(y,{sx:{display:"flex"},children:[e.jsx(J,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",mr:2,background:"transparent"},children:e.jsx(K,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:s,src:T.getValidImgUrlFor(o)})}),e.jsxs(y,{sx:{display:"flex",flexDirection:"column"},children:[e.jsx(L,{variant:"h5",component:"h2",children:s}),e.jsx(L,{variant:"caption",display:"block",children:F(n)})]})]}),e.jsx(We,{sx:{borderRadius:"5px"},size:"small",label:c})]})})}),ct=t=>{if(!t)return{};const s={};return t.forEach(({sourceId:n,source:o})=>{var r;const c=(r=s[n])!=null?r:{id:n,name:n,lang:"unknown",iconUrl:null,mangaCount:0,...o};s[n]={...c,mangaCount:c.mangaCount+1}}),s},ut=()=>{const{t}=_(),{data:s,loading:n,error:o,refetch:c}=T.useGetMigratableSources({notifyOnNetworkStatusChange:!0}),r=l.useMemo(()=>ct(s==null?void 0:s.mangas.nodes),[s==null?void 0:s.mangas.nodes]);return n?e.jsx(X,{}):o?e.jsx(G,{message:t("global.error.label.failed_to_load_data"),messageExtra:o.message,retry:()=>c().catch(C())}):e.jsx(De,{children:Object.values(r).map((m,x)=>e.jsx(Le,{isLastItem:x===Object.values(r).length-1,children:e.jsx(lt,{...m})},m.id))})};function rn(){const{t}=_(),{setTitle:s}=l.useContext(V),[n,o]=l.useState(0);return l.useEffect(()=>{s(t("global.label.browse"))},[t]),e.jsxs(qe,{children:[e.jsxs(He,{value:n,tabsCount:2,onChange:(c,r)=>o(r),children:[e.jsx(H,{sx:{textTransform:"none"},label:t("source.title")}),e.jsx(H,{sx:{textTransform:"none"},label:t("extension.title")}),e.jsx(H,{sx:{textTransform:"none"},label:t("migrate.title")})]}),e.jsx(W,{index:0,currentIndex:n,children:e.jsx(et,{})}),e.jsx(W,{index:1,currentIndex:n,children:e.jsx(it,{})}),e.jsx(W,{index:2,currentIndex:n,children:e.jsx(ut,{})})]})}export{rn as Browse};
