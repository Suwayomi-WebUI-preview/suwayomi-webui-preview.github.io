import{u as H,al as N,c as r,N as U,a as m,j as e,E as S,h as D,T as O,bd as $,g as q,L as v,B as I,f as V,I as z,w as Q,y as W,be as J}from"./index-Dho87l6m.js";import{D as K}from"./DownloadStateIndicator-DiG00IlU.js";import{U as X}from"./UpdateChecker-KbztJtRF.js";import{S as Y,a as Z,b as ee}from"./StyledGroupItemWrapper-ChMz6Xj3.js";import{M as te}from"./Mangas-D9PDeeci.js";import{S as ae}from"./SpinnerImage-CNv__mxL.js";import{C as se,T as E}from"./TypographyMaxLines-DIplEUwQ.js";import{C as oe,a as re}from"./index-CWXfGevU.js";import{A as ne}from"./Avatar-D5YL_4Qw.js";import"./Progress-PUwb0Gh9.js";import"./Chapters-IAOdNx0D.js";const ie=o=>{if(!o.length)return[];const i=new Map;return o.forEach(p=>{var s;const l=W(J(Number(p.fetchedAt)));i.set(l,((s=i.get(l))!=null?s:0)+1)}),[...i.entries()]},je=()=>{var T,w;const{t:o}=H(),i=N(),{setTitle:p,setAction:l}=r.useContext(U),{data:s,loading:j,error:C,fetchMore:L,refetch:M}=m.useGetRecentlyUpdatedChapters(void 0,{fetchPolicy:"cache-and-network",notifyOnNetworkStatusChange:!0}),b=!!(s!=null&&s.chapters.pageInfo.hasNextPage),k=s==null?void 0:s.chapters.pageInfo.endCursor,d=(T=s==null?void 0:s.chapters.nodes)!=null?T:[],g=r.useMemo(()=>ie(d),[d]),P=r.useMemo(()=>g.map(t=>t[1]),[g]),{data:h}=m.useGetDownloadStatus(),R=(w=h==null?void 0:h.downloadStatus.queue)!=null?w:[],x=r.useRef(null),[_,A]=r.useState(0);r.useLayoutEffect(()=>{var t,a;A((a=(t=x.current)==null?void 0:t.clientHeight)!=null?a:0)},[x.current]);const{data:f}=m.useGetLastGlobalUpdateTimestamp({fetchPolicy:"cache-only"}),y=f==null?void 0:f.lastUpdateTimestamp.timestamp;r.useEffect(()=>(p(o("updates.title")),l(e.jsx(X,{})),()=>{p(""),l(null)}),[o,y]);const G=t=>{const{sourceOrder:a,mangaId:c}=t;return R.find(n=>a===n.chapter.sourceOrder&&c===n.manga.id)},B=t=>{m.addChapterToDownloadQueue(t.id)},F=r.useCallback(()=>{b&&L({variables:{offset:d.length}})},[b,k]);return C?e.jsx(S,{message:o("global.error.label.failed_to_load_data"),messageExtra:C.message,retry:()=>M().catch(D())}):!j&&d.length===0?e.jsx(S,{message:o("updates.error.label.no_updates_available")}):e.jsxs(e.Fragment,{children:[e.jsx(O,{ref:x,sx:{marginLeft:"10px",paddingTop:t=>({[t.breakpoints.up("sm")]:{paddingTop:"6px"}})},children:o("library.settings.global_update.label.last_update",{date:y?$.format(+y):"-"})}),e.jsx(Y,{heightToSubtract:_,style:{height:"undefined"},components:{Footer:()=>j?e.jsx(q,{usePadding:!0}):null},overscan:window.innerHeight*.5,endReached:F,groupCounts:P,groupContent:t=>e.jsx(Z,{variant:"h5",isFirstItem:t===0,children:g[t][0]}),itemContent:t=>{const a=d[t],{manga:c}=a,n=G(a);return e.jsx(ee,{children:e.jsx(oe,{children:e.jsx(re,{component:v,to:"/manga/".concat(a.manga.id,"/chapter/").concat(a.sourceOrder),state:i.state,sx:{color:u=>u.palette.text[a.isRead?"disabled":"primary"]},children:e.jsxs(se,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:2},children:[e.jsxs(I,{sx:{display:"flex"},children:[e.jsx(v,{to:"/manga/".concat(a.manga.id),style:{textDecoration:"none"},children:e.jsx(ne,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",marginRight:2,background:"transparent"},children:e.jsx(ae,{imgStyle:{objectFit:"cover",width:"100%",height:"100%",imageRendering:"pixelated"},spinnerStyle:{small:!0},alt:c.title,src:te.getThumbnailUrl(c)})})}),e.jsxs(I,{sx:{display:"flex",flexDirection:"column"},children:[e.jsx(E,{variant:"h5",component:"h2",children:c.title}),e.jsx(E,{variant:"caption",display:"block",gutterBottom:!0,lines:1,children:a.name})]})]}),n&&e.jsx(K,{download:n}),n==null&&!a.isDownloaded&&e.jsx(V,{title:o("chapter.action.download.add.label.action"),children:e.jsx(z,{onClick:u=>{u.stopPropagation(),u.preventDefault(),B(a)},size:"large",children:e.jsx(Q,{})})})]})})})},t)}})]})};export{je as Updates};
