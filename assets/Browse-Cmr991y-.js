import{c as de,j as e,u as N,M as ze,C as $,a as Oe,A as O,L as F,b as Q,B as R,S as ue,r as f,T as m,d as he,e as G,f as Te,g as Y,h as q,i as h,k as xe,l as U,I as P,m as J,E as H,n as T,o as M,p as Me,q as k,D as Ne,s as Ve,t as We,v as Ke,w as qe,x as Xe,y as $e,z as Qe,F as Ye,G as Je,H as Ie,J as Ae,K as Ze,N as et,O as ae,P as ie}from"./index-DSAuvmW1.js";import{u as Re,S as Ue,A as tt}from"./AppbarSearch-rgR8bWBJ.js";import{s as _e,l as Pe,D as X,a as st,e as nt}from"./Languages-Bv4V6vCq.js";import{SourceContentType as le}from"./SourceMangas--Q4yobCV.js";import{t as z,L as De,g as K,I as ot,a as rt,E as Be,b as C,c as at,d as it,e as Fe,f as lt,i as ct,h as dt}from"./LangSelect-CKEZ7wJA.js";import{A as pe}from"./Avatar-dcDiravw.js";import{f as ut}from"./file-selector-DlHkLoY8.js";import{S as ge,V as ht,a as xt,b as pt}from"./Virtuoso.util-C6WwVWwk.js";import{T as gt}from"./TabsWrapper-BNsfwdaE.js";import{A as mt,a as ft}from"./SortRadioInput-BUCSyu9a.js";import{C as jt}from"./Chip-Dqjzn38U.js";import"./ChaptersDownloadActionMenuItems-CQ4MERgi.js";import"./Trackers-D4pSmk7a.js";import"./Info-BUWfulVT.js";import"./CheckCircle-DB6te7On.js";import"./ListPreference-FjID9QWF.js";import"./NumberSetting-rkwV9BNl.js";import"./useMobilePicker-BRpQeYNd.js";import"./SelectSetting-T15WpPN1.js";import"./FilterList-C_MiaN2B.js";import"./GridLayouts-CcG8s0Iz.js";import"./ExpandMore-Bu_AMq-j.js";import"./useDebounce-BiT6yYLT.js";import"./StyledFab-f60xQNVw.js";import"./BaseMangaGrid-UbqHZYHd.js";import"./MangaGrid-BkMW_-cZ.js";import"./Sync-DMcG7dXT.js";import"./PlayArrow-Bvhi23ay.js";import"./cloneObject-DrOPTG0J.js";const St=de(e.jsx("path",{d:"M19.3 16.9c.4-.7.7-1.5.7-2.4 0-2.5-2-4.5-4.5-4.5S11 12 11 14.5s2 4.5 4.5 4.5c.9 0 1.7-.3 2.4-.7l3.2 3.2 1.4-1.4zm-3.8.1c-1.4 0-2.5-1.1-2.5-2.5s1.1-2.5 2.5-2.5 2.5 1.1 2.5 2.5-1.1 2.5-2.5 2.5M12 20v2C6.48 22 2 17.52 2 12S6.48 2 12 2c4.84 0 8.87 3.44 9.8 8h-2.07c-.64-2.46-2.4-4.47-4.73-5.41V5c0 1.1-.9 2-2 2h-2v2c0 .55-.45 1-1 1H8v2h2v3H9l-4.79-4.79C4.08 10.79 4 11.38 4 12c0 4.41 3.59 8 8 8"}),"TravelExplore"),Et=a=>{const{t}=N(),n=ze.useIsMobileWidth(),{source:{id:c,name:i,lang:o,iconUrl:d,supportsLatest:r,isNsfw:x,extension:{repo:s}},showSourceRepo:E}=a,u=Number(c)===0?t("source.local_source.title"):i;return e.jsx($,{sx:{margin:1,marginTop:0},children:e.jsx(Oe,{component:F,to:O.sources.childRoutes.browse.path(c),state:{contentType:le.POPULAR,clearCache:!0},children:e.jsxs(Q,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:1.5},children:[e.jsxs(R,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(pe,{variant:"rounded",alt:u,sx:{width:56,height:56,flex:"0 0 auto",mr:1,background:"transparent"},children:e.jsx(ue,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:u,src:f.getValidImgUrlFor(d)})}),e.jsxs(R,{sx:{display:"flex",flexDirection:"column",justifyContent:"center"},children:[e.jsx(m,{variant:"h6",component:"h3",children:u}),e.jsxs(m,{variant:"caption",sx:{display:"block"},children:[z(o),x&&e.jsx(m,{variant:"caption",color:"error",sx:{display:"inline"},children:" 18+"}),E&&e.jsx(m,{variant:"caption",sx:{display:"block"},children:s})]})]})]}),e.jsxs(he,{sx:{flexDirection:"row",gap:1},children:[r&&e.jsx(G,{...Te.preventRippleProp(),variant:"outlined",component:F,to:O.sources.childRoutes.browse.path(c),state:{contentType:le.LATEST,clearCache:!0},children:t("global.button.latest")}),!n&&e.jsx(G,{...Te.preventRippleProp(),variant:"outlined",component:F,to:O.sources.childRoutes.browse.path(c),state:{contentType:le.POPULAR,clearCache:!0},children:t("global.button.popular")})]})]})})})};function bt(a){const t=new Set;return a.forEach(n=>{const i=Number(n.id)===0?X.OTHER:n.lang;t.add(i)}),[...t].sort(Pe)}function vt(a){const t={};return a.forEach(n=>{var o;const i=Number(n.id)===0?X.OTHER:n.lang;(o=t[i])!=null||(t[i]=[]),t[i].push(n)}),Object.values(t).forEach(n=>n.sort((c,i)=>c.name.localeCompare(i.name))),t}function wt(){const{t:a}=N(),{setAction:t}=Y(),[n,c]=q("shownSourceLangs",st()),[i]=q("showNsfw",!0),{data:o,loading:d,error:r,refetch:x}=f.useGetSourceList({notifyOnNetworkStatusChange:!0}),s=o==null?void 0:o.sources.nodes,E=h.useMemo(()=>{if(!s||s!=null&&s.length)return!1;const{repo:u}=s[0].extension;return s.some(j=>j.extension.repo!==u)},[s]),S=xe();return h.useEffect(()=>{_e().forEach(u=>{let j=!1;n.forEach(g=>{g===u&&(j=!0)}),j||c(g=>(g.push(u),g))})},[]),h.useLayoutEffect(()=>(t(e.jsxs(e.Fragment,{children:[e.jsx(U,{title:a("search.title.global_search"),children:e.jsx(P,{onClick:()=>S(O.sources.childRoutes.searchAll.path),color:"inherit",children:e.jsx(St,{})})}),e.jsx(De,{shownLangs:n,setShownLangs:c,allLangs:bt(s!=null?s:[]),forcedLangs:_e()})]})),()=>{t(null)}),[a,n,s]),d?e.jsx(J,{}):r?e.jsx(H,{message:a("global.error.label.failed_to_load_data"),messageExtra:T(r),retry:()=>x().catch(M())}):(s==null?void 0:s.length)===0?e.jsx(H,{message:a("source.error.label.no_sources_found")}):e.jsx(e.Fragment,{children:Object.entries(vt(s!=null?s:[])).sort((u,j)=>Pe(u[0],j[0])).map(([u,j])=>(u===X.OTHER||n.includes(u))&&e.jsxs(h.Fragment,{children:[e.jsx(m,{variant:"h5",component:"h2",sx:{paddingLeft:3,paddingTop:1,paddingBottom:2,fontWeight:"bold"},children:z(u)},u),j.filter(g=>{if(u===X.OTHER){const w=Number(g.id)===0;if(!(n.includes(u)||w))return!1}return i||!g.isNsfw}).map(g=>e.jsx(Et,{source:g,showSourceRepo:E},g.id))]},u))})}function Lt(a){const{t}=N(),{extension:{name:n,lang:c,versionName:i,isInstalled:o,hasUpdate:d,isObsolete:r,pkgName:x,iconUrl:s,isNsfw:E,repo:S},handleUpdate:u,showOptions:j,showSourceRepo:g,forcedState:b}=a,[w,I]=h.useState(K(o,r,d)),L=b!=null?b:w;h.useEffect(()=>{I(K(o,r,d))},[K(o,r,d)]);const D=c==="all"?t("extension.language.all"):c.toUpperCase(),V=async y=>{const B=it[y],ee=at[y];try{switch(I(ee),y){case C.INSTALL:await f.updateExtension(x,{install:!0,isObsolete:r}).response;break;case C.UNINSTALL:await f.updateExtension(x,{uninstall:!0,isObsolete:r}).response;break;case C.UPDATE:await f.updateExtension(x,{update:!0,isObsolete:r}).response;break;default:throw new Error('Unexpected ExtensionAction "'.concat(y,'"'))}I(B),u()}catch(W){I(K(o,r,d)),k(t(Fe[y],{count:1}),"error",T(W))}};function Z(){switch(L){case C.INSTALL:case C.UPDATE:case C.UNINSTALL:V(L).catch(M());break;case Be.OBSOLETE:V(C.UNINSTALL).catch(M());break}}return e.jsx($,{children:e.jsxs(Q,{sx:{display:"flex",alignItems:"center",gap:1,p:1.5,"&:last-child":{paddingBottom:1.5}},children:[e.jsx(pe,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",background:"transparent"},alt:n,children:e.jsx(ue,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:n,src:f.getValidImgUrlFor(s)})}),e.jsxs(R,{sx:{display:"flex",flexDirection:"column",flexGrow:1,flexShrink:1,wordBreak:"break-word",justifyContent:"center"},children:[e.jsx(m,{variant:"h6",component:"h3",children:n}),e.jsxs(m,{variant:"caption",sx:{display:"block"},children:[D," ",i,E&&e.jsx(m,{variant:"caption",color:"error",sx:{display:"inline"},children:" 18+"})]}),g&&e.jsx(m,{variant:"caption",sx:{display:"block"},children:S})]}),o&&e.jsx(U,{title:t("settings.title"),children:e.jsx(P,{onClick:j,color:"inherit",children:e.jsx(Me,{})})}),e.jsx(G,{variant:"outlined",sx:{color:L===rt.OBSOLETE?"red":"inherit",flexShrink:0},onClick:()=>Z(),children:t(ot[L])})]})})}function yt({extensionId:a,closeDialog:t}){const{t:n}=N(),c=xe(),{data:i,loading:o,error:d,refetch:r}=f.useGetSourceList({notifyOnNetworkStatusChange:!0});if(d)return e.jsx(Ne,{open:!!a,onClose:t});const x=h.useMemo(()=>a?i==null?void 0:i.sources.nodes.filter(s=>s.extension.pkgName===a):[],[i==null?void 0:i.sources.nodes,a]);return e.jsxs(Ne,{open:!!a,onClose:t,maxWidth:"md",fullWidth:!0,children:[e.jsx(Ve,{children:n("extension.settings.dialog.title")}),e.jsxs(We,{children:[o&&e.jsx(J,{}),d&&e.jsx(H,{message:n("global.error.label.failed_to_load_data"),messageExtra:T(d),retry:()=>r().catch(M())}),!o&&!d&&e.jsx(R,{children:x==null?void 0:x.map(s=>e.jsx(ge,{sx:{px:0},children:e.jsx($,{children:e.jsxs(Q,{sx:{display:"flex",alignItems:"center",gap:1,p:1.5,"&:last-child":{paddingBottom:1.5}},children:[e.jsx(m,{variant:"h6",component:"h3",sx:{flexGrow:1},children:z(s.lang)}),s.isConfigurable&&e.jsx(U,{title:n("settings.title"),children:e.jsx(P,{onClick:()=>c(O.sources.childRoutes.configure.path(s.id)),color:"inherit",children:e.jsx(Me,{})})})]})})},s.id))})]})]})}const ce=0,ke=1;function Ct({tabsMenuHeight:a}){var Le,ye;const{t}=N(),{setAction:n}=Y(),c=xe(),{pathname:i,search:o,state:d}=Ke(),r=d==null?void 0:d.selectedExtensionPkg,x=l=>{c(i+o,{replace:!0,state:{selectedExtensionPkg:l}})},{data:s,loading:E,error:S,refetch:u}=f.useGetServerSettings({notifyOnNetworkStatusChange:!0}),j=!!(s!=null&&s.settings.extensionRepos.length),g=((Le=s==null?void 0:s.settings.extensionRepos.length)!=null?Le:0)>1,b=h.useRef(null),[w,I]=q("shownExtensionLangs",nt()),[L]=q("showNsfw",!0),[D]=Re("query",Ue),[V,Z]=h.useState({}),[y,{data:B,loading:ee,error:W}]=f.useExtensionListFetch(),A=(ye=B==null?void 0:B.fetchExtensions)==null?void 0:ye.extensions,[me,fe]=h.useState([]),te=h.useCallback(()=>Z({}),[]);h.useEffect(()=>{y()},[V]);const je=h.useMemo(()=>(A!=null?A:[]).filter(l=>{const p=L||!l.isNsfw;return D?p&&l.name.toLowerCase().includes(D.toLowerCase()):p}),[A,L,D]),{allLangs:Se,groupedExtensions:se}=h.useMemo(()=>lt(je),[je]),_=h.useMemo(()=>se.filter(l=>l[ke].length>0).filter(l=>ct(l[ce])||w.includes(l[ce])),[w,se]),Ee=h.useMemo(()=>_.map(l=>l[ke].length),[_]),ne=h.useMemo(()=>_.map(([,l])=>l).flat(1),[_]),Ge=ht.useCreateGroupedComputeItemKey(Ee,h.useCallback(l=>_[l][ce],[_]),h.useCallback(l=>ne[l].pkgName,[ne])),be=l=>{l.name.toLowerCase().endsWith("apk")?(b.current&&(b.current.value=""),k(t("extension.label.installing_file"),"info"),f.installExternalExtension(l).response.then(()=>{te(),k(t("extension.label.installed_successfully"),"success")}).catch(p=>k(t("extension.label.installation_failed"),"error",T(p)))):k(t("global.error.label.invalid_file_type"),"error")};h.useLayoutEffect(()=>(n(e.jsxs(e.Fragment,{children:[e.jsx(tt,{}),e.jsx(U,{title:t("extension.action.label.install_external"),children:e.jsx(P,{onClick:()=>{var l;return(l=b.current)==null?void 0:l.click()},color:"inherit",children:e.jsx(qe,{})})}),e.jsx(De,{shownLangs:w,setShownLangs:I,allLangs:Se})]})),()=>{n(null)}),[t,w,Se]),h.useEffect(()=>{const l=async v=>{v.preventDefault();const oe=await ut(v);be(oe[0])},p=v=>{v.preventDefault()};return document.addEventListener("drop",l),document.addEventListener("dragover",p),()=>{document.removeEventListener("drop",l),document.removeEventListener("dragover",p)}},[]);const ve=h.useMemo(()=>e.jsx("input",{type:"file",style:{display:"none"},ref:b,onChange:l=>{var v;const p=(v=l.target.files)==null?void 0:v[0];p&&be(p)}}),[]),He=E||ee,we=S!=null?S:W;return He?e.jsx(J,{}):we?e.jsx(H,{message:t("global.error.label.failed_to_load_data"),messageExtra:T(we),retry:()=>{S&&u().catch(M()),W&&y().catch(M())}}):!(A!=null&&A.length)&&!j?e.jsxs(e.Fragment,{children:[ve,e.jsxs(he,{sx:{alignItems:"center",justifyContent:"center",rowGap:"10px",paddingTop:"20px"},children:[e.jsx(m,{children:t("extension.label.add_repository_info")}),e.jsx(G,{component:F,variant:"contained",to:O.browse.path,children:t("settings.title")})]})]}):e.jsxs(e.Fragment,{children:[ve,e.jsx(xt,{heightToSubtract:a,overscan:window.innerHeight*.5,groupCounts:Ee,groupContent:l=>{const[p,v]=_[l],oe=p===dt.UPDATE_PENDING;return e.jsxs(pt,{isFirstItem:l===0,sx:{flexDirection:"row",justifyContent:"space-between",alignItems:"center",pr:1},children:[e.jsx(m,{variant:"h5",component:"h2",children:z(p)}),oe&&e.jsx(G,{disabled:!!me.length,variant:"contained",onClick:()=>{const Ce=v.map(re=>re.pkgName);fe(Ce),f.updateExtensions(Ce,{update:!0}).response.then(()=>te()).catch(re=>k(t(Fe[C.UPDATE],{count:se.length}),"error",T(re))).finally(()=>fe([]))},children:t("extension.action.label.update_all")})]},p)},computeItemKey:Ge,itemContent:l=>{const p=ne[l];return e.jsx(ge,{children:e.jsx(Lt,{extension:p,handleUpdate:te,showSourceRepo:g,forcedState:me.includes(p.pkgName)?Be.UPDATING:void 0,showOptions:()=>x(p.pkgName)})})}}),e.jsx(yt,{extensionId:r,closeDialog:()=>x(void 0)})]})}const Tt=de(e.jsx("path",{d:"M14.94 4.66h-4.72l2.36-2.36zm-4.69 14.71h4.66l-2.33 2.33zM6.1 6.27 1.6 17.73h1.84l.92-2.45h5.11l.92 2.45h1.84L7.74 6.27zm-1.13 7.37 1.94-5.18 1.94 5.18zm10.76 2.5h6.12v1.59h-8.53v-1.29l5.92-8.56h-5.88v-1.6h8.3v1.26z"}),"SortByAlpha"),Nt=de(e.jsx("path",{d:"M20 10V8h-4V4h-2v4h-4V4H8v4H4v2h4v4H4v2h4v4h2v-4h4v4h2v-4h4v-2h-4v-4zm-6 4h-4v-4h4z"}),"Tag"),It=({id:a,name:t,lang:n,iconUrl:c,mangaCount:i})=>{const{t:o}=N(),r=Number(a)===0?o("source.local_source.title"):t;return e.jsx($,{children:e.jsx(Oe,{component:F,to:O.migrate.path(a),children:e.jsxs(Q,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",p:1.5},children:[e.jsxs(R,{sx:{display:"flex"},children:[e.jsx(pe,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",mr:1,background:"transparent"},children:e.jsx(ue,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:r,src:f.getValidImgUrlFor(c)})}),e.jsxs(R,{sx:{display:"flex",flexDirection:"column",justifyContent:"center"},children:[e.jsx(m,{variant:"h6",component:"h3",children:r}),e.jsx(m,{variant:"caption",sx:{display:"block"},children:z(n)})]})]}),e.jsx(jt,{sx:{borderRadius:1},size:"small",label:i})]})})})},At=(a,{sortBy:t,sortOrder:n})=>{if(!a)return[];const c={};a.forEach(({sourceId:o,source:d})=>{var x;const r=(x=c[o])!=null?x:{id:o,name:o,lang:"unknown",iconUrl:null,mangaCount:0,...d};c[o]={...r,mangaCount:r.mangaCount+1}});const i=Object.values(c).toSorted((o,d)=>{switch(t){case Ie.SOURCE_NAME:return o.name.localeCompare(d.name);case Ie.MANGA_COUNT:return o.mangaCount-d.mangaCount;default:throw new Error('Unexpected "sortBy" "'.concat(t,'"'))}});switch(n){case Ae.ASC:return i;case Ae.DESC:return i.toReversed();default:throw new Error('Unexpected "sortOrder" "'.concat(n,'"'))}},_t=({tabsMenuHeight:a})=>{const{t}=N(),{appBarHeight:n}=Y(),{settings:{migrateSortSettings:c}}=Xe(),i=$e(u=>k(t("global.error.label.failed_to_save_changes"),"error",T(u))),{sortBy:o,sortOrder:d}=c,{data:r,loading:x,error:s,refetch:E}=f.useGetMigratableSources({notifyOnNetworkStatusChange:!0}),S=h.useMemo(()=>At(r==null?void 0:r.mangas.nodes,c),[r==null?void 0:r.mangas.nodes,c]);return x?e.jsx(J,{}):s?e.jsx(H,{message:t("global.error.label.failed_to_load_data"),messageExtra:T(s),retry:()=>E().catch(M())}):e.jsxs(e.Fragment,{children:[e.jsxs(he,{sx:{position:"sticky",top:"".concat(n+a,"px"),flexDirection:"row",justifyContent:"end",alignItems:"center",gap:1,p:1,backgroundColor:"background.default",zIndex:1},children:[e.jsx(U,{title:t(Qe[o]),children:e.jsx(P,{color:"inherit",onClick:()=>i("migrateSortSettings",{sortBy:(o+1)%2,sortOrder:d}),children:o?e.jsx(Nt,{}):e.jsx(Tt,{})})}),e.jsx(U,{title:t(Ye[d]),children:e.jsx(P,{color:"inherit",onClick:()=>i("migrateSortSettings",{sortBy:o,sortOrder:(d+1)%2}),children:d?e.jsx(mt,{}):e.jsx(ft,{})})})]}),e.jsx(Je,{sx:{p:0},children:S.map(u=>e.jsx(ge,{children:e.jsx(It,{...u})},u.id))})]})};function ls(){const{t:a}=N(),{setTitle:t}=Y();h.useLayoutEffect(()=>{t(a("global.label.browse"))},[a]);const n=h.useRef(null),[c,i]=h.useState(0);Ze(n,h.useCallback(()=>i(n.current.offsetHeight),[n.current]));const[o,d]=Re("tab",Ue,{}),r=o!=null?o:"source";return o||d(r,"replaceIn"),e.jsxs(gt,{children:[e.jsxs(et,{ref:n,variant:"fullWidth",value:r,onChange:(x,s)=>d(s,"replaceIn"),children:[e.jsx(ae,{value:"source",sx:{textTransform:"none"},label:a("source.title_one")}),e.jsx(ae,{value:"extensions",sx:{textTransform:"none"},label:a("extension.title_other")}),e.jsx(ae,{value:"migrate",sx:{textTransform:"none"},label:a("migrate.title")})]}),e.jsx(ie,{index:"source",currentIndex:r,children:e.jsx(wt,{})}),e.jsx(ie,{index:"extensions",currentIndex:r,children:e.jsx(Ct,{tabsMenuHeight:c})}),e.jsx(ie,{index:"migrate",currentIndex:r,children:e.jsx(_t,{tabsMenuHeight:c})})]})}export{ls as Browse};
