import{u as B,a as N,G as ge,w as le,l as U,j as e,x as me,y as j,z as be,t as Ce,m as ee,c as u,A as P,f as ne,I as fe,C as xe,E as ye,F as Se,h as te,H as je,N as ke,g as _e}from"./index-C4qwXpmq.js";import{u as ie,S as Te,A as Me,N as Fe}from"./AppbarSearch-ExOSXWmn.js";import{E as ae}from"./EmptyViewAbsoluteCentered-B72QzW5m.js";import{T as Le,a as Ae}from"./Tabs-GKsJA7GL.js";import{d as we}from"./FilterList-DrGSWTGP.js";import{C as I}from"./CheckboxInput-CG0-TUfr.js";import{S as Be,R}from"./SortRadioInput-B_CWmFHk.js";import{T as _}from"./ThreeStateCheckboxInput-C-n_AaUF.js";import{O as Ie,S as Ee,e as G,a as ve}from"./SelectionFAB-B9CH1Zy2.js";import{T as Oe}from"./Trackers-D4pSmk7a.js";import{s as Re,M as De}from"./Mangas-CsWXKpxZ.js";import{F as T}from"./TextField-BNsfONQP.js";import{R as Ne}from"./ListPreference-B0OP4uDN.js";import{M as Ge,a as Ue}from"./MangaGrid-BgpFfzCz.js";import{d as Pe,U as ze}from"./UpdateChecker-6H6jltQ7.js";import{u as Ke}from"./useManageMangaLibraryState-DJYVmgZo.js";import{C as He}from"./Checkbox-OHPjDEGs.js";import{T as We,a as Ye}from"./TabsMenu-CXIttOwV.js";import{C as Ve}from"./Chip--5E8K8ZA.js";import"./StyledFab-Dik-Stx6.js";import"./Chapters-C1Oi359V.js";import"./SwitchBase-B0snjHZd.js";import"./index-DmPE5XcG.js";import"./Delete-WBPkCX_q.js";import"./Download-lgtQcg2y.js";import"./Sync-CYkPFPx0.js";import"./SpinnerImage-CjUcgnVH.js";import"./Refresh-8ASZ8-V5.js";import"./TypographyMaxLines-CokQutrb.js";import"./Link-CIe6iV5f.js";import"./Card-4tnuY9-5.js";import"./CardActionArea-BKl1iYLA.js";import"./CardContent-DmdpfO1T.js";import"./Avatar-Bu6yq9mQ.js";import"./PlayArrow-CyLNGm8-.js";import"./Progress-BX2JqOdp.js";import"./Info-B1nwnUwY.js";import"./InputAdornment-CXJi4Hxk.js";import"./CheckCircle-pjc9U-3s.js";import"./Collapse-Bo46tBQs.js";import"./NumberSetting-CJzMbVkK.js";import"./useMobilePicker-DOIHUetg.js";import"./SelectSetting-BnPHoBmD.js";import"./Select-DPwqeTtk.js";const Qe={filter:"global.label.filter",sort:"global.label.sort",display:"global.label.display"},$e=[["unreadChapters","library.option.sort.label.by_unread_chapters"],["totalChapters","library.option.sort.label.by_total_chapters"],["alphabetically","library.option.sort.label.alphabetically"],["dateAdded","library.option.sort.label.by_date_added"],["lastRead","library.option.sort.label.by_last_read"],["latestFetchedChapter","library.option.sort.label.by_latest_fetched_chapter"],["latestUploadedChapter","library.option.sort.label.by_latest_uploaded_chapter"]],Je=({category:t,open:r,onClose:i})=>{var f,b;const{t:a}=B(),o=N.useGetTrackerList(ge),l=Oe.getLoggedIn((b=(f=o.data)==null?void 0:f.trackers.nodes)!=null?b:[]),s=le(t),n=be(t,()=>ee(a("global.error.label.failed_to_save_changes","error"))),{settings:{showTabSize:C}}=U(),L=Ce(()=>ee(a("search.error.label.failed_to_save_settings"),"warning"));return e.jsx(Ie,{open:r,onClose:i,tabs:["filter","sort","display"],tabTitle:h=>a(Qe[h]),tabContent:h=>{if(h==="filter")return e.jsxs(e.Fragment,{children:[e.jsx(_,{label:a("global.filter.label.unread"),checked:s.hasUnreadChapters,onChange:c=>n("hasUnreadChapters",c)}),e.jsx(_,{label:a("global.filter.label.downloaded"),checked:s.hasDownloadedChapters,onChange:c=>n("hasDownloadedChapters",c)}),e.jsx(_,{label:a("global.filter.label.bookmarked"),checked:s.hasBookmarkedChapters,onChange:c=>n("hasBookmarkedChapters",c)}),e.jsx(_,{label:a("global.filter.label.duplicate_chapters"),checked:s.hasDuplicateChapters,onChange:c=>n("hasDuplicateChapters",c)}),e.jsx(T,{sx:{mt:2},children:a("manga.label.status")}),Object.values(me).map(c=>e.jsx(_,{label:a(Re[c]),checked:s.hasStatus[c],onChange:p=>n("hasStatus",{...s.hasStatus,[c]:p})},c)),e.jsx(T,{sx:{mt:2},children:a("global.filter.label.tracked")}),l.map(c=>e.jsx(_,{label:c.name,checked:s.hasTrackerBinding[c.id],onChange:p=>n("hasTrackerBinding",{...s.hasTrackerBinding,[c.id]:p})},c.id))]});if(h==="sort")return $e.map(([c,p])=>e.jsx(Be,{label:a(p),checked:s.sortBy===c,sortDescending:s.sortDesc,onClick:()=>c!==s.sortBy?n("sortBy",c):n("sortDesc",!s.sortDesc)},c));if(h==="display"){const{gridLayout:c,showContinueReadingButton:p,showDownloadBadge:x,showUnreadBadge:A}=s;return e.jsxs(e.Fragment,{children:[e.jsx(T,{children:a("global.grid_layout.title")}),e.jsxs(Ne,{onChange:E=>n("gridLayout",Number(E.target.value)),value:c,children:[e.jsx(R,{label:a("global.grid_layout.label.compact_grid"),value:j.Compact,checked:c==null||c===j.Compact}),e.jsx(R,{label:a("global.grid_layout.label.comfortable_grid"),value:j.Comfortable,checked:c===j.Comfortable}),e.jsx(R,{label:a("global.grid_layout.label.list"),value:j.List,checked:c===j.List})]}),e.jsx(T,{sx:{mt:2},children:a("library.option.display.badge.title")}),e.jsx(I,{label:a("library.option.display.badge.label.unread_badges"),checked:A,onChange:()=>n("showUnreadBadge",!A)}),e.jsx(I,{label:a("library.option.display.badge.label.download_badges"),checked:x,onChange:()=>n("showDownloadBadge",!x)}),e.jsx(T,{sx:{mt:2},children:a("library.option.display.tab.title")}),e.jsx(I,{label:a("library.option.display.tab.label.show_number_of_items"),checked:C,onChange:()=>L("showTabSize",!C)}),e.jsx(T,{sx:{mt:2},children:a("global.label.other")}),e.jsx(I,{label:a("library.option.display.other.label.show_continue_reading_button"),checked:p,onChange:()=>n("showContinueReadingButton",!p)})]})}return null}})},Xe=({category:t})=>{const{t:r}=B(),[i,a]=u.useState(!1),{options:o}=P(),l=o.hasDownloadedChapters!=null||o.hasUnreadChapters!=null||o.hasBookmarkedChapters!=null||o.hasDuplicateChapters!=null||Object.values(o.hasStatus).some(s=>s!=null)||Object.values(o.hasTrackerBinding).some(s=>s!=null);return e.jsxs(e.Fragment,{children:[e.jsx(ne,{title:r("settings.title"),children:e.jsx(fe,{onClick:()=>a(!i),color:l?"warning":"inherit",children:e.jsx(we,{})})}),e.jsx(Je,{category:t,open:i,onClose:()=>a(!1)})]})},re=({showFilteredOutMessage:t,message:r,messageExtra:i,...a})=>{const{t:o}=B(),{options:l}=P();return u.useLayoutEffect(()=>(document.body.style.overflowY=l.gridLayout===j.List?"auto":"scroll",()=>{document.body.style.overflowY="auto"}),[]),e.jsx(Ge,{gridWrapperProps:{sx:{p:1}},...a,hasNextPage:!1,loadMore:()=>{},message:t?o("library.error.label.no_matches"):r,messageExtra:t?void 0:i,gridLayout:l.gridLayout})},Ze=({isActive:t,areAllItemsSelected:r,areNoItemsSelected:i,onSelectAll:a,onModeChange:o})=>{const{t:l}=B();return e.jsxs(e.Fragment,{children:[t&&e.jsx(Ee,{areAllItemsSelected:r,areNoItemsSelected:i,onChange:a}),e.jsx(ne,{title:l(t?"global.button.cancel":"global.button.select_all"),children:e.jsx(He,{checkedIcon:e.jsx(Pe,{}),sx:{padding:"8px",color:"inherit","&.Mui-checked":{color:"inherit"}},checked:t,onChange:(s,n)=>o(n)})})]})},z=(t,r,i)=>{switch(t){case!0:return r();case!1:return i();default:return!0}},D=(t,r)=>z(t,()=>!!r&&r>=1,()=>r===0),ce=(t,r)=>z(t,()=>!!r,()=>!r),M=(t,r)=>{const i=t==null?void 0:t.filter(s=>s!=null),a=r==null?void 0:r.filter(s=>s!=null);if(!(i!=null&&i.length))return!0;const o=i.map(G),l=a.map(G).join(", ");return o.every(s=>l.includes(s))},qe=(t,{title:r,genre:i,description:a,artist:o,author:l,source:s})=>M([t],[r])||M(t==null?void 0:t.split(","),i.map(n=>G(n)))||M([t],[a])||M([t],[o])||M([t],[l])||M([t],[s==null?void 0:s.displayName]),et=(t,r)=>Object.entries(t).map(([i,a])=>{const o=r.trackRecords.nodes.some(l=>l.trackerId===Number(i));return z(a,()=>o,()=>!o)}).every(Boolean),tt=(t,r)=>Object.entries(t).map(([i,a])=>ce(a,i===r.status)).every(Boolean),at=(t,{hasDownloadedChapters:r,hasUnreadChapters:i,hasBookmarkedChapters:a,hasDuplicateChapters:o,hasTrackerBinding:l,hasStatus:s})=>D(r,t.downloadCount)&&D(i,t.unreadCount)&&D(a,t.bookmarkCount)&&ce(o,t.hasDuplicateChapters)&&et(l,t)&&tt(s,t),rt=(t,r,i)=>{const a=i.ignoreFilters&&(r==null?void 0:r.length);return t.filter(o=>{const l=qe(r,o),s=a||at(o,i);return l&&s})},F=(t=0,r=0)=>Number(t)-Number(r),st=(t,r)=>t.localeCompare(r),ot=(t,r,i)=>{const a=[...t];switch(r){case"alphabetically":a.sort((o,l)=>st(o.title,l.title));break;case"dateAdded":a.sort((o,l)=>F(o.inLibraryAt,l.inLibraryAt));break;case"unreadChapters":a.sort((o,l)=>F(o.unreadCount,l.unreadCount));break;case"lastRead":a.sort((o,l)=>{var s,n;return F((s=o.lastReadChapter)==null?void 0:s.lastReadAt,(n=l.lastReadChapter)==null?void 0:n.lastReadAt)});break;case"latestUploadedChapter":a.sort((o,l)=>{var s,n;return F((s=o.latestUploadedChapter)==null?void 0:s.uploadDate,(n=l.latestUploadedChapter)==null?void 0:n.uploadDate)});break;case"latestFetchedChapter":a.sort((o,l)=>{var s,n;return F((s=o.latestFetchedChapter)==null?void 0:s.fetchedAt,(n=l.latestFetchedChapter)==null?void 0:n.fetchedAt)});break;case"totalChapters":a.sort((o,l)=>F(o.chapters.totalCount,l.chapters.totalCount));break}return i&&a.reverse(),a},lt={id:-1},nt=(t,r)=>{const[i]=ie("query",Te),a=le(r!=null?r:lt),{hasUnreadChapters:o,hasDownloadedChapters:l,hasBookmarkedChapters:s,hasTrackerBinding:n,hasDuplicateChapters:C,hasStatus:L}=a,{settings:f}=U(),b=u.useMemo(()=>rt(t,i,{...a,ignoreFilters:f.ignoreFilters}),[t,i,o,l,s,n,C,L,f.ignoreFilters]),h=u.useMemo(()=>ot(b,a.sortBy,a.sortDesc),[b,a.sortBy,a.sortDesc]),c=Object.values(a.hasTrackerBinding).some(x=>x!=null),p=(o!=null||l!=null||s!=null||!!i||c)&&b.length===0&&t.length>0;return{visibleMangas:h,showFilteredOutMessage:p}},se=xe("span")({display:"flex",alignItems:"center"}),oe=({sx:t,...r})=>e.jsx(Ve,{...r,size:"small",sx:{...t,marginLeft:"5px"}});function Zt(){var Z,q;const{t}=B(),{settings:{showTabSize:r}}=U(),{data:i,error:a,loading:o,refetch:l}=N.useGetCategories(ye,{notifyOnNetworkStatusChange:!0}),s=i==null?void 0:i.categories.nodes.filter(d=>d.id!==0||d.id===0&&d.mangas.totalCount),n=s!=null?s:[],C=u.useMemo(()=>n.map(d=>d.mangas.totalCount).reduce((d,m)=>d+m,0),[n]),[L,f]=ie("tab",Fe),{setOptions:b}=P(),h=(Z=n.find(d=>d.order===L))!=null?Z:n[0];u.useLayoutEffect(()=>{b(Se(h!=null?h:{id:-1}))},[h]);const{data:c,error:p,loading:x,refetch:A}=N.useGetCategoryMangas(h==null?void 0:h.id,{skip:!h,notifyOnNetworkStatusChange:!0}),E=(q=c==null?void 0:c.mangas.nodes)!=null?q:[],{visibleMangas:g,showFilteredOutMessage:K}=nt(E,h),H=u.useCallback(()=>A().catch(te()),[A,h]),de=u.useMemo(()=>g.map(d=>d.id),[g]),[y,v]=u.useState(!1),{areNoItemsForKeySelected:W,areAllItemsForKeySelected:Y,selectedItemIds:S,handleSelectAll:O,handleSelection:he,clearSelection:pe}=Ke(g.length,{itemIds:de,currentKey:h==null?void 0:h.id.toString()}),V=(d,m,k)=>{v(!!(S.length+(m?1:-1))),he(d,m,k)},Q=u.useMemo(()=>S.map(d=>De.getFromCache(d,je,"MANGA_CHAPTER_STAT_FIELDS")).filter(d=>!!d),[S.length,g]),$=u.useMemo(()=>y?e.jsx(ve,{selectedItemsCount:S.length,title:"manga.title",children:(d,m)=>e.jsx(Ue,{selectedMangas:Q,onClose:()=>{d(),v(!1),pe()},setHideMenu:m})}):null,[y,Q]),{setTitle:J,setAction:X}=u.useContext(ke);u.useLayoutEffect(()=>{const d=t("library.title");return J(e.jsxs(se,{children:[d,r&&e.jsx(oe,{sx:{color:"inherit"},label:C})]}),d),X(e.jsxs(e.Fragment,{children:[!y&&h&&e.jsxs(e.Fragment,{children:[e.jsx(Me,{}),e.jsx(Xe,{category:h}),e.jsx(ze,{categoryId:h==null?void 0:h.id})]}),e.jsx(Ze,{isActive:y,areAllItemsSelected:Y,areNoItemsSelected:W,onSelectAll:k=>O(k,[...new Set(g.map(w=>w.id))]),onModeChange:k=>{v(k),k?O(!0,[...new Set(g.map(w=>w.id))]):n.forEach(w=>O(!1,[],w.id.toString()))}})]})),()=>{J(""),X(null)}},[t,C,o,y,W,Y,S.length,g.length,h,r]);const ue=d=>{f(d)};return a!=null?e.jsx(ae,{message:t("category.error.label.request_failure"),messageExtra:a.message,retry:()=>l().catch(te())}):o?e.jsx(_e,{}):n.length===0?e.jsx(ae,{message:t("library.error.label.empty")}):n.length===1?e.jsxs(e.Fragment,{children:[e.jsx(re,{mangas:g,message:t(p?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:p==null?void 0:p.message,isLoading:x,selectedMangaIds:S,isSelectModeActive:y,handleSelection:V,showFilteredOutMessage:!p&&K,retry:p&&H}),$]}):e.jsxs(We,{children:[e.jsx(Ye,{value:h.order,onChange:(d,m)=>ue(m),children:n.map(d=>e.jsx(Le,{sx:{display:"flex"},label:e.jsxs(se,{children:[d.name,r?e.jsx(oe,{label:d.mangas.totalCount}):null]}),value:d.order},d.id))}),n.map(d=>e.jsx(Ae,{index:d.order,currentIndex:h.order,children:d===h&&e.jsx(re,{mangas:g,message:t(p?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:p==null?void 0:p.message,isLoading:x,selectedMangaIds:S,isSelectModeActive:y,handleSelection:V,showFilteredOutMessage:!p&&K,retry:p&&H})},d.order)),$]})}export{Zt as Library};
