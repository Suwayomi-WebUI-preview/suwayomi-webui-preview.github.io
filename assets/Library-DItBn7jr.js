import{u as w,r as v,P as ye,Q as he,q as P,j as t,U as F,W as Se,X as je,Y as k,Z as R,_ as ke,y as _e,n as le,l as oe,f as p,$ as z,i as ue,I as Te,a0 as Me,a1 as U,a2 as Fe,a3 as Le,a4 as Ae,a5 as Ie,m as N,a6 as we,a7 as Be,N as Re,E as ne,k as Oe,D as ve,F as Ee,G as De}from"./index-Br_UsbXy.js";import{u as ge,S as Ne,A as Ge,N as Ue}from"./AppbarSearch-DCVuo1sd.js";import{F as Pe}from"./FilterList-CIbQaqgA.js";import{S as ze,R as G}from"./SortRadioInput-OtzBS_Qh.js";import{T as j}from"./ThreeStateCheckboxInput-CaizDX59.js";import{O as We,S as Ye,a as Ke}from"./SelectionFAB-DXkS8mh-.js";import{T as He}from"./Trackers-D4pSmk7a.js";import{R as Ve}from"./ListPreference-BIAa9CfE.js";import{M as Qe,a as Xe}from"./MangaGrid-DAqOfyJA.js";import{C as Ze,U as $e}from"./UpdateChecker-odg5JYh3.js";import{u as Je}from"./useManageMangaLibraryState-C2s4w3Ob.js";import{T as qe}from"./TabsWrapper-CGQP7Z7-.js";import{C as ea}from"./Chip-D7F7I4pY.js";import"./StyledFab-Fec0Sjd_.js";import"./Sync-CSOrEXtD.js";import"./Avatar-BRpf_njd.js";import"./PlayArrow-DIRZBCrL.js";import"./Progress-3Vv7UgnH.js";import"./Info-8DGx28ud.js";import"./CheckCircle-Bw9jGBj3.js";import"./NumberSetting-Ca14HWeT.js";import"./useMobilePicker-DaN88Jw8.js";import"./SelectSetting-CdI2rjjR.js";const aa={filter:"global.label.filter",sort:"global.label.sort",display:"global.label.display"},ta=[["unreadChapters","library.option.sort.label.by_unread_chapters"],["totalChapters","library.option.sort.label.by_total_chapters"],["alphabetically","library.option.sort.label.alphabetically"],["dateAdded","library.option.sort.label.by_date_added"],["lastRead","library.option.sort.label.by_last_read"],["latestFetchedChapter","library.option.sort.label.by_latest_fetched_chapter"],["latestUploadedChapter","library.option.sort.label.by_latest_uploaded_chapter"]],sa=({category:e,open:r,onClose:c})=>{var T,C;const{t:a}=w(),o=v.useGetTrackerList(ye),i=He.getLoggedIn((C=(T=o.data)==null?void 0:T.trackers.nodes)!=null?C:[]),l=he(e),n=ke(e,u=>le(a("global.error.label.failed_to_save_changes"),"error",oe(u))),{settings:{showTabSize:b}}=P(),_=_e(u=>le(a("search.error.label.failed_to_save_settings"),"error",oe(u)));return t.jsx(We,{open:r,onClose:c,tabs:["filter","sort","display"],tabTitle:u=>a(aa[u]),tabContent:u=>{if(u==="filter")return t.jsxs(t.Fragment,{children:[t.jsx(j,{label:a("global.filter.label.unread"),checked:l.hasUnreadChapters,onChange:s=>n("hasUnreadChapters",s)}),t.jsx(j,{label:a("global.filter.label.started"),checked:l.hasReadChapters,onChange:s=>n("hasReadChapters",s)}),t.jsx(j,{label:a("global.filter.label.downloaded"),checked:l.hasDownloadedChapters,onChange:s=>n("hasDownloadedChapters",s)}),t.jsx(j,{label:a("global.filter.label.bookmarked"),checked:l.hasBookmarkedChapters,onChange:s=>n("hasBookmarkedChapters",s)}),t.jsx(j,{label:a("global.filter.label.duplicate_chapters"),checked:l.hasDuplicateChapters,onChange:s=>n("hasDuplicateChapters",s)}),t.jsx(F,{sx:{mt:2},children:a("manga.label.status")}),Object.values(Se).map(s=>t.jsx(j,{label:a(je[s]),checked:l.hasStatus[s],onChange:g=>n("hasStatus",{...l.hasStatus,[s]:g})},s)),t.jsx(F,{sx:{mt:2},children:a("global.filter.label.tracked")}),i.map(s=>t.jsx(j,{label:s.name,checked:l.hasTrackerBinding[s.id],onChange:g=>n("hasTrackerBinding",{...l.hasTrackerBinding,[s.id]:g})},s.id))]});if(u==="sort")return ta.map(([s,g])=>t.jsx(ze,{label:a(g),checked:l.sortBy===s,sortDescending:l.sortDesc,onClick:()=>s!==l.sortBy?n("sortBy",s):n("sortDesc",!l.sortDesc)},s));if(u==="display"){const{gridLayout:s,showContinueReadingButton:g,showDownloadBadge:h,showUnreadBadge:x}=l;return t.jsxs(t.Fragment,{children:[t.jsx(F,{children:a("global.grid_layout.title")}),t.jsxs(Ve,{onChange:B=>n("gridLayout",Number(B.target.value)),value:s,children:[t.jsx(G,{label:a("global.grid_layout.label.compact_grid"),value:k.Compact,checked:s==null||s===k.Compact}),t.jsx(G,{label:a("global.grid_layout.label.comfortable_grid"),value:k.Comfortable,checked:s===k.Comfortable}),t.jsx(G,{label:a("global.grid_layout.label.list"),value:k.List,checked:s===k.List})]}),t.jsx(F,{sx:{mt:2},children:a("library.option.display.badge.title")}),t.jsx(R,{label:a("library.option.display.badge.label.unread_badges"),checked:x,onChange:()=>n("showUnreadBadge",!x)}),t.jsx(R,{label:a("library.option.display.badge.label.download_badges"),checked:h,onChange:()=>n("showDownloadBadge",!h)}),t.jsx(F,{sx:{mt:2},children:a("library.option.display.tab.title")}),t.jsx(R,{label:a("library.option.display.tab.label.show_number_of_items"),checked:b,onChange:()=>_("showTabSize",!b)}),t.jsx(F,{sx:{mt:2},children:a("global.label.other")}),t.jsx(R,{label:a("library.option.display.other.label.show_continue_reading_button"),checked:g,onChange:()=>n("showContinueReadingButton",!g)})]})}return null}})},ra=({category:e})=>{const{t:r}=w(),[c,a]=p.useState(!1),{options:o}=z(),i=o.hasDownloadedChapters!=null||o.hasUnreadChapters!=null||o.hasReadChapters!=null||o.hasBookmarkedChapters!=null||o.hasDuplicateChapters!=null||Object.values(o.hasStatus).some(l=>l!=null)||Object.values(o.hasTrackerBinding).some(l=>l!=null);return t.jsxs(t.Fragment,{children:[t.jsx(ue,{title:r("settings.title"),children:t.jsx(Te,{onClick:()=>a(!c),color:i?"warning":"inherit",children:t.jsx(Pe,{})})}),t.jsx(sa,{category:e,open:c,onClose:()=>a(!1)})]})},ie=({showFilteredOutMessage:e,message:r,messageExtra:c,...a})=>{const{t:o}=w(),{options:i}=z();return p.useLayoutEffect(()=>(document.body.style.overflowY=i.gridLayout===k.List?"auto":"scroll",()=>{document.body.style.overflowY="auto"}),[]),t.jsx(Qe,{gridWrapperProps:{sx:{p:1}},...a,hasNextPage:!1,loadMore:()=>{},message:e?o("library.error.label.no_matches"):r,messageExtra:e?void 0:c,gridLayout:i.gridLayout})},la=({isActive:e,areAllItemsSelected:r,areNoItemsSelected:c,onSelectAll:a,onModeChange:o})=>{const{t:i}=w();return t.jsxs(t.Fragment,{children:[e&&t.jsx(Ye,{areAllItemsSelected:r,areNoItemsSelected:c,onChange:a}),t.jsx(ue,{title:i(e?"global.button.cancel":"global.button.select_all"),children:t.jsx(Me,{checkedIcon:t.jsx(Ze,{}),sx:{padding:"8px",color:"inherit","&.Mui-checked":{color:"inherit"}},checked:e,onChange:(l,n)=>o(n)})})]})},W=(e,r,c)=>{switch(e){case!0:return r();case!1:return c();default:return!0}},O=(e,r)=>W(e,()=>!!r&&r>=1,()=>r===0),pe=(e,r)=>W(e,()=>!!r,()=>!r),L=(e,r)=>{const c=e==null?void 0:e.filter(l=>l!=null),a=r==null?void 0:r.filter(l=>l!=null);if(!(c!=null&&c.length))return!0;const o=c.map(U),i=a.map(U).join(", ");return o.every(l=>i.includes(l))},oa=(e,{title:r,genre:c,description:a,artist:o,author:i,source:l})=>L([e],[r])||L(e==null?void 0:e.split(","),c.map(n=>U(n)))||L([e],[a])||L([e],[o])||L([e],[i])||L([e],[l==null?void 0:l.displayName]),na=(e,r)=>Object.entries(e).map(([c,a])=>{const o=r.trackRecords.nodes.some(i=>i.trackerId===Number(c));return W(a,()=>o,()=>!o)}).every(Boolean),ia=(e,r)=>Object.entries(e).map(([c,a])=>pe(a,c===r.status)).every(Boolean),ca=(e,{hasDownloadedChapters:r,hasUnreadChapters:c,hasReadChapters:a,hasBookmarkedChapters:o,hasDuplicateChapters:i,hasTrackerBinding:l,hasStatus:n})=>O(r,e.downloadCount)&&O(c,e.unreadCount)&&O(a,e.chapters.totalCount-e.unreadCount)&&O(o,e.bookmarkCount)&&pe(i,e.hasDuplicateChapters)&&na(l,e)&&ia(n,e),da=(e,r,c)=>{const a=c.ignoreFilters&&(r==null?void 0:r.length);return e.filter(o=>{const i=oa(r,o),l=a||ca(o,c);return i&&l})},A=(e=0,r=0)=>Number(e)-Number(r),ha=(e,r)=>e.localeCompare(r),ua=(e,r,c)=>{const a=[...e];switch(r){case"alphabetically":a.sort((o,i)=>ha(o.title,i.title));break;case"dateAdded":a.sort((o,i)=>A(o.inLibraryAt,i.inLibraryAt));break;case"unreadChapters":a.sort((o,i)=>A(o.unreadCount,i.unreadCount));break;case"lastRead":a.sort((o,i)=>{var l,n;return A((l=o.lastReadChapter)==null?void 0:l.lastReadAt,(n=i.lastReadChapter)==null?void 0:n.lastReadAt)});break;case"latestUploadedChapter":a.sort((o,i)=>{var l,n;return A((l=o.latestUploadedChapter)==null?void 0:l.uploadDate,(n=i.latestUploadedChapter)==null?void 0:n.uploadDate)});break;case"latestFetchedChapter":a.sort((o,i)=>{var l,n;return A((l=o.latestFetchedChapter)==null?void 0:l.fetchedAt,(n=i.latestFetchedChapter)==null?void 0:n.fetchedAt)});break;case"totalChapters":a.sort((o,i)=>A(o.chapters.totalCount,i.chapters.totalCount));break}return c&&a.reverse(),a},ga={id:-1},pa=(e,r)=>{const[c]=ge("query",Ne),a=he(r!=null?r:ga),{hasUnreadChapters:o,hasReadChapters:i,hasDownloadedChapters:l,hasBookmarkedChapters:n,hasTrackerBinding:b,hasDuplicateChapters:_,hasStatus:T}=a,{settings:C}=P(),u=p.useMemo(()=>da(e,c,{...a,ignoreFilters:C.ignoreFilters}),[e,c,o,i,l,n,b,_,T,C.ignoreFilters]),s=p.useMemo(()=>ua(u,a.sortBy,a.sortDesc),[u,a.sortBy,a.sortDesc]),g=Object.values(a.hasTrackerBinding).some(x=>x!=null),h=(o!=null||i!=null||l!=null||n!=null||!!c||g)&&u.length===0&&e.length>0;return{visibleMangas:s,showFilteredOutMessage:h}},ce=Fe("span")({display:"flex",alignItems:"center"}),de=({sx:e,...r})=>t.jsx(ea,{...r,size:"small",sx:{...e,marginLeft:"5px"}});function Na(){var q,ee,ae,te,se,re;const{t:e}=w(),{settings:{showTabSize:r}}=P(),{data:c,error:a,loading:o,refetch:i}=v.useGetCategories(Le,{notifyOnNetworkStatusChange:!0}),l=c==null?void 0:c.categories.nodes.filter(d=>d.id!==0||d.id===0&&d.mangas.totalCount),n=l!=null?l:[],b=v.useGetMangas(Ae,{}),_=(ee=(q=b.data)==null?void 0:q.mangas.totalCount)!=null?ee:0,[T,C]=ge("tab",Ue),{setOptions:u}=z(),s=(ae=n.find(d=>d.order===T))!=null?ae:n[0];p.useLayoutEffect(()=>{u(Ie(s!=null?s:{id:-1}))},[s]);const{data:g,error:h,loading:x,refetch:B}=v.useGetCategoryMangas(s==null?void 0:s.id,{skip:!s,notifyOnNetworkStatusChange:!0}),be=(te=g==null?void 0:g.mangas.nodes)!=null?te:[],{visibleMangas:m,showFilteredOutMessage:Y}=pa(be,s),K=p.useCallback(()=>B().catch(N()),[B,s]),me=p.useMemo(()=>m.map(d=>d.id),[m]),[f,E]=p.useState(!1),{areNoItemsForKeySelected:H,areAllItemsForKeySelected:V,selectedItemIds:y,handleSelectAll:D,handleSelection:Ce,clearSelection:xe}=Je(m.length,{itemIds:me,currentKey:s==null?void 0:s.id.toString()}),Q=(d,S,M)=>{E(!!(y.length+(S?1:-1))),Ce(d,S,M)},X=p.useMemo(()=>y.map(d=>we.getFromCache(d,Be,"MANGA_CHAPTER_STAT_FIELDS")).filter(d=>!!d),[y.length,m]),Z=p.useMemo(()=>f?t.jsx(Ke,{selectedItemsCount:y.length,title:"manga.title",children:(d,S)=>t.jsx(Xe,{selectedMangas:X,onClose:()=>{d(),E(!1),xe()},setHideMenu:S})}):null,[f,X]),{setTitle:$,setAction:J}=p.useContext(Re);p.useLayoutEffect(()=>{const d=e("library.title");return $(t.jsxs(ce,{children:[d,r&&t.jsx(de,{sx:{color:"inherit"},label:_})]}),d),J(t.jsxs(t.Fragment,{children:[!f&&s&&t.jsxs(t.Fragment,{children:[t.jsx(Ge,{}),t.jsx(ra,{category:s}),t.jsx($e,{categoryId:s==null?void 0:s.id})]}),t.jsx(la,{isActive:f,areAllItemsSelected:V,areNoItemsSelected:H,onSelectAll:M=>D(M,[...new Set(m.map(I=>I.id))]),onModeChange:M=>{E(M),M?D(!0,[...new Set(m.map(I=>I.id))]):n.forEach(I=>D(!1,[],I.id.toString()))}})]})),()=>{$(""),J(null)}},[e,_,o,f,H,V,y.length,m.length,s,r]);const fe=d=>{C(d)};return a!=null||b.error?t.jsx(ne,{message:e("global.error.label.failed_to_load_data"),messageExtra:(re=a==null?void 0:a.message)!=null?re:(se=b.error)==null?void 0:se.message,retry:()=>{a&&i().catch(N()),b.error&&b.refetch().catch(N())}}):o||b.loading?t.jsx(Oe,{}):n.length===0?t.jsx(ne,{message:e("library.error.label.empty")}):n.length===1?t.jsxs(t.Fragment,{children:[t.jsx(ie,{mangas:m,message:e(h?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:h==null?void 0:h.message,isLoading:x,selectedMangaIds:y,isSelectModeActive:f,handleSelection:Q,showFilteredOutMessage:!h&&Y,retry:h&&K}),Z]}):t.jsxs(qe,{children:[t.jsx(ve,{value:s.order,onChange:(d,S)=>fe(S),children:n.map(d=>t.jsx(Ee,{sx:{flexGrow:1,maxWidth:"unset"},label:t.jsxs(ce,{children:[d.name,r?t.jsx(de,{label:d.mangas.totalCount}):null]}),value:d.order},d.id))}),n.map(d=>t.jsx(De,{index:d.order,currentIndex:s.order,children:d===s&&t.jsx(ie,{mangas:m,message:e(h?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:h==null?void 0:h.message,isLoading:x,selectedMangaIds:y,isSelectModeActive:f,handleSelection:Q,showFilteredOutMessage:!h&&Y,retry:h&&K})},d.order)),Z]})}export{Na as Library};
