import{w as me,j as e,r as Y,i as J,R as y,T as he,Q as Ae,B as M,aB as fe,V as Se,S as G,c as S,aY as k,ao as De,u as K,b as E,z as Re,g as Q,I as ve,A as qe,J as Ge,K as Ne,at as Be,au as Ue,av as He,k as je,aW as ze,aV as Ve,aZ as We,a_ as Qe,s as X,N as Ye,W as Je,e as Ke,ak as xe,X as Xe,x as Ze,a$ as q,b0 as et,a as P,b1 as tt,b2 as at,b3 as st,n as nt}from"./index-CgwpgmzX.js";import{d as rt,u as ot,A as it,S as lt}from"./AppbarSearch-BEzYKaJO.js";import{d as ct}from"./Favorite-91FZmA9E.js";import{d as be}from"./FilterList-DYfCYQCu.js";import{G as ut}from"./GridLayouts-0f2tDZN2.js";import{d as dt}from"./Delete-CNXFT6xJ.js";import{S as pt,O as gt}from"./SortRadioInput-CBgJqxOG.js";import{C as xt}from"./CheckboxInput-z11lWREO.js";import{a as Ce,I as ye,M as mt,b as ht,T as ft}from"./TextField-2w_Aa973.js";import{C as Te}from"./Collapse-AEWCvR_t.js";import{u as St}from"./useDebounce-CelBV1Gb.js";import{I as vt}from"./InputAdornment-COdo-9fV.js";import{T as jt}from"./ThreeStateCheckboxInput-Cub-dL0z.js";import{S as bt}from"./StyledFab-2U1Kldhf.js";import{o as Ct}from"./useManageMangaLibraryState-Bjnhc4hd.js";import{C as yt}from"./Chip-D_giEhEV.js";import{M as Tt,g as Ft}from"./MangaGrid-BNOBrVw-.js";import{L as _t}from"./Link-B6Yv1IDU.js";import"./ViewModule-BDA7HIl5.js";import"./Checkbox-DCoF1kSO.js";import"./SwitchBase-BWPfpppt.js";import"./ListPreference-BMHY7-R_.js";import"./index-BDuKUTxJ.js";import"./CardContent-WastZZpR.js";import"./Avatar-Gc3ZUICh.js";import"./Info-DumgNkXl.js";import"./SpinnerImage-C5KxRMfX.js";import"./NumberSetting-NbToRaJk.js";import"./useMobilePicker-DReU6gdT.js";import"./SelectSetting-knR1H-3a.js";import"./Select-Bpy-_SaN.js";import"./Mangas-DYPxkouH.js";import"./Chapters-CpzI1SdB.js";import"./Sync-BeCG5YiP.js";import"./PlayArrow--SqiJEmL.js";function Lt(){const{options:{SourcegridLayout:t},setOptions:s}=me();function o(n){s(a=>({...a,SourcegridLayout:n}))}return e.jsx(ut,{gridLayout:t,onChange:o})}var Z={},Mt=J;Object.defineProperty(Z,"__esModule",{value:!0});var Fe=Z.default=void 0,kt=Mt(Y()),$t=e;Fe=Z.default=(0,kt.default)((0,$t.jsx)("path",{d:"M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3m3-10H5V5h10z"}),"Save");const It=t=>{const{state:s,name:o,position:n,group:a,updateFilterValue:c,update:r}=t,[l,i]=y.useState(s),p=d=>{i(d.target.checked);const x=r.filter(v=>!(n===v.position&&a===v.group));c([...x,{type:"checkBoxState",position:n,state:d.target.checked,group:a}])};return s!==void 0?e.jsx(xt,{label:o,checked:l,onChange:p}):null},Et=({name:t})=>e.jsx(he,{sx:{mt:2},variant:"subtitle2",children:t},t);function Pt(t,s,o,n,a,c,r){const[l,i]=y.useState(o);if(t){const p=x=>{const v=t.indexOf("".concat(x.target.value));i(v);const m=c.filter(u=>!(n===u.position&&r===u.group));a([...m,{type:"selectState",position:n,state:v,group:r}])},d=t.map(x=>e.jsx(Ae,{value:x,children:x},"".concat(s," ").concat(x)));return e.jsxs(Ce,{sx:{my:1},variant:"standard",children:[e.jsx(ye,{children:s}),e.jsx(mt,{name:s,value:t[l],label:s,onChange:p,children:d})]})}return null}const wt=({values:t,name:s,state:o,position:n,updateFilterValue:a,update:c,group:r})=>Pt(t,s,o,n,a,c,r);var ee={},Ot=J;Object.defineProperty(ee,"__esModule",{value:!0});var te=ee.default=void 0,At=Ot(Y()),Dt=e;te=ee.default=(0,At.default)((0,Dt.jsx)("path",{d:"m12 8-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"}),"ExpandLess");var ae={},Rt=J;Object.defineProperty(ae,"__esModule",{value:!0});var se=ae.default=void 0,qt=Rt(Y()),Gt=e;se=ae.default=(0,qt.default)((0,Gt.jsx)("path",{d:"M16.59 8.59 12 13.17 7.41 8.59 6 10l6 6 6-6z"}),"ExpandMore");const Nt=t=>{const{values:s,name:o,state:n,position:a,group:c,updateFilterValue:r,update:l}=t,[i,p]=y.useState(n),[d,x]=y.useState(!1),v=()=>{x(!d)};if(s){const m=u=>{const h=i;h.index===u?h.ascending=!h.ascending:h.ascending=!0,h.index=u,p(h);const b=l.filter(f=>!(a===f.position&&c===f.group));r([...b,{type:"sortState",position:a,state:h,group:c}])};return e.jsxs(M,{sx:{mx:-2},children:[e.jsxs(fe,{onClick:v,children:[e.jsx(Se,{primary:o}),d?e.jsx(te,{}):e.jsx(se,{})]}),e.jsx(Te,{in:d,children:e.jsx(G,{sx:{mx:4},children:s.map((u,h)=>e.jsx(pt,{label:u,checked:i.index===h,sortDescending:!i.ascending,onClick:()=>m(h)},"".concat(o," ").concat(u)))})})]})}return null},Bt=t=>{const{state:s,name:o,position:n,group:a,updateFilterValue:c,update:r}=t,[l,i]=y.useState(s||""),p=St(l,500);return S.useEffect(()=>{const d=r.filter(x=>!(n===x.position&&a===x.group));c([...d,{type:"textState",position:n,state:p,group:a}])},[p]),s!==void 0?e.jsxs(Ce,{sx:{my:1},variant:"standard",children:[e.jsx(ye,{children:o}),e.jsx(ht,{name:o,value:l,onChange:({target:{value:d}})=>i(d),endAdornment:e.jsx(vt,{position:"end",children:e.jsx(rt,{})})})]}):null},Ut=t=>{switch(t){case k.Ignore:return 0;case k.Include:return 1;case k.Exclude:return 2;default:throw new Error("Unexpected TriState ".concat(t))}},Ht=t=>{switch(t){case 0:return k.Ignore;case 1:return k.Include;case 2:return k.Exclude;default:throw new Error("Unexpected state number ".concat(t))}},zt=t=>{const{state:s,name:o,position:n,group:a,updateFilterValue:c,update:r}=t,[l,i]=y.useState(Ut(s)),p=d=>{const x=d===void 0?0:d?1:2;i(x);const v=r.filter(m=>!(n===m.position&&a===m.group));c([...v,{type:"triState",position:n,state:Ht(x),group:a}])};return s!==void 0?e.jsx(jt,{label:o,checked:[void 0,!0,!1][l],onChange:d=>p(d)}):null},Vt=t=>{const{state:s,name:o,position:n,updateFilterValue:a,update:c}=t,[r,l]=y.useState(!1);return e.jsxs(M,{sx:{mx:-2},children:[e.jsxs(fe,{onClick:()=>l(!r),children:[e.jsx(Se,{primary:o}),r?e.jsx(te,{}):e.jsx(se,{})]}),e.jsx(Te,{in:r,children:e.jsx(G,{sx:{mx:4},children:e.jsx(_e,{sourceFilter:s,group:n,updateFilterValue:a,update:c})})})]})},Wt=({name:t})=>e.jsx(De,{sx:{my:1},textAlign:"center",children:t},t);function _e({sourceFilter:t,group:s,updateFilterValue:o,update:n}){return e.jsx(G,{children:t.map((a,c)=>{var l,i;let r=n.find(p=>p.group===s&&p.position===c);switch(r=r&&r.state,a.type){case"CheckBoxFilter":return e.jsx(It,{name:a.name,state:r!=null?r:a.CheckBoxFilterDefault,position:c,group:s,updateFilterValue:o,update:n},"filters ".concat(a.name));case"GroupFilter":return e.jsx(Vt,{name:a.name,state:a.filters,position:c,updateFilterValue:o,update:n},"filters ".concat(a.name));case"HeaderFilter":return e.jsx(Et,{name:a.name},"filters ".concat(a.name));case"SelectFilter":return e.jsx(wt,{name:a.name,values:a.values,state:r!=null?parseInt(r,10):a.SelectFilterDefault,position:c,group:s,updateFilterValue:o,update:n},"filters ".concat(a.name));case"SeparatorFilter":return e.jsx(Wt,{name:a.name},"filters ".concat(a.name));case"SortFilter":return e.jsx(Nt,{name:a.name,values:a.values,state:r!=null?r:{ascending:(l=a.SortFilterDefault)==null?void 0:l.ascending,index:(i=a.SortFilterDefault)==null?void 0:i.index},position:c,group:s,updateFilterValue:o,update:n},"filters ".concat(a.name));case"TextFilter":return e.jsx(Bt,{name:a.name,state:r!=null?r:a.TextFilterDefault,position:c,group:s,updateFilterValue:o,update:n},"filters ".concat(a.name));case"TriStateFilter":return e.jsx(zt,{name:a.name,state:r!=null?r:a.TriStateFilterDefault,position:c,group:s,updateFilterValue:o,update:n},"filters ".concat(a.name));default:throw new Error('Unknown source filter "'.concat(a,'"'))}})},"filters ".concat(s))}function Qt({savedSearches:t={},selectSavedSearch:s,updateSavedSearches:o,sourceFilter:n,updateFilterValue:a,resetFilterValue:c,setTriggerUpdate:r,update:l}){const{t:i}=K(),[p,d]=S.useState(!1),[x,v]=S.useState(""),m=Object.keys(t),u=!!m.length;function h(){c(0),d(!1)}function b(){r(0),d(!1)}return e.jsxs(e.Fragment,{children:[e.jsxs(bt,{onClick:()=>d(!p),variant:"extended",color:"primary",children:[e.jsx(be,{}),i("global.button.filter")]}),e.jsxs(gt,{open:p,onClose:()=>d(!1),children:[e.jsxs(M,{sx:{p:2,pb:u?void 0:0},children:[e.jsxs(M,{sx:{display:"flex",pb:1},children:[e.jsx(E,{onClick:h,children:i("global.button.reset")}),e.jsx(Re,{variant:"dialog",popupId:"source-browse-save-search",children:f=>e.jsxs(e.Fragment,{children:[e.jsx(Q,{title:i("source.filter.save_search.label.save"),children:e.jsx(ve,{sx:{marginLeft:"auto"},...qe(f),children:e.jsx(Fe,{})})}),e.jsxs(Ge,{...Ne(f),maxWidth:"xs",fullWidth:!0,children:[e.jsx(Be,{children:i("source.filter.save_search.dialog.label.title")}),e.jsx(Ue,{children:e.jsx(ft,{sx:{width:"100%"},inputProps:{maxLength:50},value:x,onChange:$=>v($.target.value)})}),e.jsxs(He,{children:[e.jsx(E,{onClick:()=>{v(""),f.close()},children:i("global.button.cancel")}),e.jsx(E,{onClick:()=>{o(x,"create"),v(""),f.close()},children:i("global.button.ok")})]})]})]})}),e.jsx(E,{variant:"contained",onClick:b,children:i("global.button.submit")})]}),u&&e.jsxs(e.Fragment,{children:[e.jsx(he,{sx:{pb:1},children:"Saved searches"}),e.jsx(G,{sx:{flexDirection:"row"},children:m.map(f=>e.jsx(yt,{label:f,onClick:()=>{d(!1),s(f)},onDelete:()=>{Ct({title:i("global.label.are_you_sure"),message:i("source.filter.save_search.dialog.label.delete",{name:f}),actions:{confirm:{title:i("global.button.delete")}}}).then(()=>o(f,"delete")).catch(je())},deleteIcon:e.jsx(Q,{title:i("source.filter.save_search.label.delete"),children:e.jsx(dt,{})}),variant:"outlined"}))})]})]}),e.jsx(M,{sx:{pb:2,mx:2},children:e.jsx(_e,{sourceFilter:n,updateFilterValue:a,group:void 0,update:l})})]})]})}function Yt(t){const{t:s}=K(),{mangas:o,isLoading:n,hasNextPage:a,loadMore:c,message:r,messageExtra:l,gridLayout:i}=t,p=o,d=p.length===0&&o.length>0;return e.jsx(Tt,{mangas:p,isLoading:n,hasNextPage:a,loadMore:c,message:d?s("manga.error.label.no_matches"):r,messageExtra:l,gridLayout:i,inLibraryIndicator:!0,mode:"source"})}const Jt=t=>({...t,savedSearches:t.savedSearches?JSON.stringify(t.savedSearches):void 0}),Kt=t=>{var s;return{...t,savedSearches:(s=We(t.savedSearches))!=null?s:void 0}},Xt=({meta:t}={},s)=>Kt(ze({meta:Ve(t)},{savedSearches:void 0},s)),Zt=async(t,s,o)=>Qe(t,[[s,Jt({[s]:o})[s]]]),ea=(t,s=je())=>(o,n)=>Zt(t,o,n).catch(s),ta=X("div")(({theme:t})=>({display:"flex",position:"fixed",top:"64px",width:"100%",zIndex:1,backgroundColor:t.palette.background.default,[t.breakpoints.down("sm")]:{top:"56px"}})),W=X(E)(()=>({marginTop:"13px",marginBottom:"13px",marginLeft:"13px"})),aa=X(M,{shouldForwardProp:t=>t!=="hasContent"})(({theme:t,hasContent:s})=>({marginTop:"calc(62.5px ".concat(s?"- 8px":"",")"),minHeight:"calc(100vh - 64px - 62.5px)",position:"relative",[t.breakpoints.down("sm")]:{marginTop:"calc(62.5px - 8px ".concat(s?"- 8px":"",")"),minHeight:"calc(100vh - 64px - 64px - 62.5px)"}}));var sa=(t=>(t[t.POPULAR=0]="POPULAR",t[t.LATEST=1]="LATEST",t[t.SEARCH=2]="SEARCH",t))(sa||{});const na={0:"manga.error.label.no_mangas_found",1:"manga.error.label.no_mangas_found",2:"manga.error.label.no_matches"},ra=t=>{const s={},o=[];return t.forEach(n=>{!!s[n.id]||(s[n.id]=n,o.push(n))}),o},oa=(t,s,o,n,a,c)=>{let r;switch(s){case 0:r=P.useGetSourcePopularMangas(t,a);break;case 1:r=P.useGetSourceLatestMangas(t,a);break;case 2:r=P.useSourceSearch(t,o!=null?o:"",n.map(m=>{const{position:u,state:h,group:b}=m;return b!==void 0?{position:b,groupChange:{position:u,[m.type]:h}}:{position:u,[m.type]:h}}),a);break;default:throw new Error('Unknown ContentType "'.concat(s,'"'))}const l=r[1],i=l.findLastIndex(m=>{var u;return!!((u=m.data)!=null&&u.fetchSourceManga)}),p=l[i],d=l.slice(-1)[0].isLoading;let x=!d;const v=S.useMemo(()=>{let m=[];return l.forEach((u,h)=>{var T,w;const b=(w=(T=u.data)==null?void 0:T.fetchSourceManga.mangas)!=null?w:[],f=b.filter(O=>!c||!O.inLibrary),$=ra([...m,...f]);x=!d&&l.length===h+1&&!f.length&&!!b.length,m=$}),m},[l,c]);return i===-1?[r[0],{...r[1][r[1].length-1],filteredOutAllItemsOfFetchedPage:x}]:[r[0],{...l[l.length-1],data:{...p.data,fetchSourceManga:{...p.data.fetchSourceManga,hasNextPage:l.length>i+1?!1:p.data.fetchSourceManga.hasNextPage,mangas:v}},filteredOutAllItemsOfFetchedPage:x}]};function Ha(){var ce,ue,de,pe;const{t}=K(),{setTitle:s,setAction:o}=S.useContext(Ye),{sourceId:n}=Je(),a=Ke(),c=xe(),{key:r,state:l}=c,{contentType:i=0,clearCache:p=!1}=(ce=xe().state)!=null?ce:{};Xe("browse");const[d,x]=S.useState(!0);S.useEffect(()=>{x(!1)},[]);const{settings:{hideLibraryEntries:v}}=Ze(),{options:m}=me(),[u]=ot("query",lt),[h,b]=q("source-mangas-".concat(n,"-filters"),[]),[f,$]=q("source-mangas-location-".concat(r,"-").concat(n,"-filters"),h!=null?h:[]),[N,T]=S.useState(f),[w,O]=q("source-mangas-".concat(n,"-content-type"),i),[C,Le]=q("source-mangas-location-".concat(r,"-").concat(n,"-content-type"),u?2:w);S.useEffect(()=>()=>{b(void 0),O(void 0)},[n]);const A=S.useCallback(()=>{et.session.setItem(Ft(c),void 0,!1),window.scrollTo(0,0)},[r]),B=j=>{b(j),$(j),A()},ne=j=>{O(j),Le(j)},[re,{data:F,isLoading:U,size:H,abortRequest:Me,filteredOutAllItemsOfFetchedPage:z}]=oa(n,C,u,f,1,v),oe=U||z,ie=(ue=F==null?void 0:F.fetchSourceManga.mangas)!=null?ue:[],D=(de=F==null?void 0:F.fetchSourceManga.hasNextPage)!=null?de:!1,{data:V}=P.useGetSource(n),g=V==null?void 0:V.source,ke=(pe=g==null?void 0:g.filters)!=null?pe:[],{savedSearches:_={}}=S.useMemo(()=>Xt(g),[g,g==null?void 0:g.meta]),le=ea(g!=null?g:{id:n},()=>nt(t("global.error.label.failed_to_save_changes"),"error")),$e=S.useCallback(j=>{const{query:L,filters:I}=_[j];I&&(T(I),B(I)),a({pathname:"",search:L?"query=".concat(L):void 0},{state:{...l,contentType:2}})},[_,l]),Ie=S.useCallback((j,L)=>{if(L==="delete"){const ge={..._};delete ge[j],le("savedSearches",ge);return}const I={..._,[j]:{query:u!=null?u:void 0,filters:f}};le("savedSearches",I)},[_,u,f]),Ee=oe?void 0:t(na[C]),Pe=n==="0"?e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:[t("source.local_source.label.checkout")," "]}),e.jsx(_t,{href:"https://github.com/Suwayomi/Suwayomi-Server/wiki/Local-Source",target:"_blank",rel:"noreferrer",children:t("source.local_source.label.guide")})]}):void 0,R=S.useCallback((j,L)=>{ne(j),A(),u&&!L&&a({pathname:""},{state:{...l,contentType:j}})},[ne,u,A]);!!u&&C!==2&&R(2,u);const we=S.useCallback(()=>{D&&re(H+1)},[H,D,C]),Oe=()=>{T([]),B([])};return S.useEffect(()=>{z&&D&&!U&&re(H+1)},[z,U]),S.useEffect(()=>{!p||!st.REVALIDATION.includes(n)||P.clearBrowseCacheFor(n)},[p]),S.useEffect(()=>()=>{C!==2||d||(Me(new Error("SourceMangas(".concat(n,"): search string changed"))),A())},[u]),S.useEffect(()=>{var j;return s((j=g==null?void 0:g.displayName)!=null?j:t("source.title")),o(e.jsxs(e.Fragment,{children:[e.jsx(it,{}),e.jsx(Lt,{}),(g==null?void 0:g.isConfigurable)&&e.jsx(Q,{title:t("settings.title"),children:e.jsx(ve,{onClick:()=>a("/sources/".concat(n,"/configure/")),"aria-label":"display more actions",edge:"end",color:"inherit",size:"large",children:e.jsx(tt,{})})})]})),()=>{s(""),o(null)}},[t,g]),e.jsxs(aa,{hasContent:!!ie.length,children:[e.jsxs(ta,{children:[e.jsx(W,{variant:C===0?"contained":"outlined",startIcon:e.jsx(ct,{}),onClick:()=>R(0),children:t("global.button.popular")}),(g==null?void 0:g.supportsLatest)===void 0||g.supportsLatest?e.jsx(W,{disabled:!(g!=null&&g.supportsLatest),variant:C===1?"contained":"outlined",startIcon:e.jsx(at,{}),onClick:()=>R(1),children:t("global.button.latest")}):null,e.jsx(W,{variant:C===2?"contained":"outlined",startIcon:e.jsx(be,{}),onClick:()=>R(2,u),children:t("global.button.filter")})]}),e.jsx(Yt,{mangas:ie,hasNextPage:D,loadMore:we,message:Ee,messageExtra:Pe,isLoading:oe,gridLayout:m.SourcegridLayout},C),C===2&&e.jsx(Qt,{savedSearches:_,selectSavedSearch:$e,updateSavedSearches:Ie,sourceFilter:ke,updateFilterValue:T,setTriggerUpdate:()=>{B(N)},resetFilterValue:Oe,update:N})]})}export{sa as SourceContentType,Ha as SourceMangas};
