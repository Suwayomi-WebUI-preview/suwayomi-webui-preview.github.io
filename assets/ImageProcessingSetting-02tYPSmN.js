import{bB as B,bC as b,bD as N,bE as z,bF as k,bG as F,aL as v,bH as V,u as A,ap as X,j as s,b as T,b6 as D,bI as w,C as Q,I as Z,au as dt,T as tt,B as G,bg as W,f as et,bJ as ut,bc as mt,bd as gt,bK as pt,aA as xt,bL as bt,r as $,i as Tt,g as H,k as St,bM as ft,m as It}from"./index-D8Oh_qVq.js";import{E as ht}from"./EmptyViewAbsoluteCentered-31nAN-mp.js";import{a as Et}from"./Asserts-mFxccwFC.js";import{u as _t}from"./useAppTitle-LfOXXKjx.js";import{D as nt}from"./Delete-qK5fizcQ.js";import{S as jt}from"./Select-CeEAyCPy.js";import{u as Ct}from"./use-resize-observer-wDk1Yt1K.js";let st=0;const E=t=>t.replace(N,""),O=t=>E(t.toLowerCase().trim())===B,lt=(t,e,n)=>{var l;return(l=n==null?void 0:n.slice(0,e).some(({name:o})=>o===t))!=null?l:!1},vt=t=>{var e;return(e=t==null?void 0:t.some((n,l)=>lt(n.name,l,t)))!=null?e:!1},ot=(t,e,n)=>n.slice(0,e).some(l=>l.mimeType===t),L=t=>t!==""&&!!t.match(/^https?:\/\/.+/),Y=(t,e,n)=>t==null||t>=e&&t<=n,it=t=>Y(t?v(t).seconds.inWholeSeconds:null,F.min,F.max),at=t=>Y(t?v(t).seconds.inWholeSeconds:null,V.min,V.max),rt=t=>Y(t,k.min,k.max),Dt=(t,e)=>t===""&&e==="",wt=(t,e,n)=>O(n)&&!t?!1:e===b.URL&&!L(t),Mt=t=>t.some(({mimeType:e,compressionLevel:n,target:l,callTimeout:o,connectTimeout:a,headers:d,mode:r},c)=>Dt(e,l)||wt(l,r,e)||!rt(n)||!it(o)||!at(a)||ot(e,c,t)||vt(d)),At=t=>{const e=E(t);return e===z?b.DISABLED:L(e)?b.URL:b.IMAGE},ct=t=>t.map(e=>{var n;return{id:(n=e.id)!=null?n:st++,...e}}),R=t=>t.map(e=>{var n;return{id:(n=e.id)!=null?n:st++,...e,mode:At(E(e.target)),headers:e.headers?ct(e.headers):null}}),K=t=>t.map(e=>({...e,mimeType:E(e.mimeType),target:E(e.target)})),Pt=t=>O(t)?B:"".concat(N).concat(t),yt=t=>t.filter(({mimeType:e,target:n})=>!!e&&!!n).map(({id:e,mode:n,...l})=>{var o,a;return{...l,mimeType:Pt(l.mimeType),target:L(l.target)?l.target:"".concat(N).concat(l.target),headers:(a=(o=l.headers)==null?void 0:o.map(({id:d,...r})=>r))!=null?a:null}}),U=t=>[...t.some(({mimeType:n})=>O(n))?[]:[{id:-1,mode:b.IMAGE,mimeType:B,target:"",compressionLevel:null,headers:null,callTimeout:null,connectTimeout:null}],...t],q=t=>t==null?void 0:t.filter(({name:e})=>e!==""),Gt=(t,e)=>t.length!==e.length?!0:t.some(({mimeType:n,target:l,compressionLevel:o,callTimeout:a,connectTimeout:d,headers:r},c)=>{var _,j;const u=e[c],i=q(r),m=q(u.headers);return E(n)!==u.mimeType||E(l)!==u.target||o!==u.compressionLevel||a!==u.callTimeout||d!==u.connectTimeout||((_=i==null?void 0:i.length)!=null?_:0)!==((j=m==null?void 0:m.length)!=null?j:0)||!!(i!=null&&i.some((S,h)=>{var f,p;return S.name!==((f=m==null?void 0:m[h])==null?void 0:f.name)||S.value!==((p=m==null?void 0:m[h])==null?void 0:p.value)}))}),Nt=({id:t,name:e,value:n,onChange:l,isDuplicate:o})=>{const{t:a}=A(),d=X();return s.jsxs(T,{sx:{gap:1,flexDirection:"row",flexWrap:"nowrap",alignItems:"center"},children:[s.jsxs(T,{sx:{flexDirection:"row",gap:2,[d.breakpoints.down("md")]:{flexDirection:"column",width:"100%"}},children:[s.jsx(D,{autoFocus:!0,sx:{width:w},label:a("download.settings.conversion.headers.name"),value:e,error:o,helperText:o&&a("global.error.label.invalid_input"),onChange:r=>l({id:t,name:r.target.value,value:n})}),s.jsx(D,{sx:{width:w},label:a("download.settings.conversion.headers.value"),value:n,onChange:r=>l({id:t,name:e,value:r.target.value})})]}),s.jsx(Q,{disabled:!1,title:a("chapter.action.download.delete.label.action"),children:s.jsx(Z,{onClick:()=>{l(null)},children:s.jsx(nt,{})})})]})},Ot=({open:t,headers:e,onChange:n})=>{const{t:l}=A();return s.jsx(dt,{in:t,children:s.jsxs(T,{sx:{justifyContent:"start",gap:2,pt:2},children:[s.jsx(tt,{children:l("download.settings.conversion.headers.title")}),e==null?void 0:e.map((o,a)=>s.jsx(Nt,{...o,isDuplicate:lt(o.name,a,e),onChange:d=>{if(d==null){n(e==null?void 0:e.toSpliced(a,1));return}n((e!=null?e:[]).toSpliced(a,1,d))}},o.id)),s.jsx(G,{onClick:()=>n([...e!=null?e:[],...ct([{name:"",value:""}])]),variant:"contained",sx:{width:"fit-content"},children:l("global.button.add")})]})})},J=({shouldAutoFocus:t,isDefault:e,isDuplicate:n,label:l,value:o,onUpdate:a,mode:d})=>{const{t:r}=A(),c=d===b.IMAGE,u=!o.length||L(o),i=!n&&(c||u);return s.jsx(D,{sx:{width:w},autoFocus:t,label:l,value:o,disabled:e,error:!i,helperText:!i&&r("global.error.label.invalid_input"),slotProps:{input:{startAdornment:s.jsx(W,{position:"start",children:c?N:null})}},onChange:m=>a(m.target.value.trim())})},Lt=({conversion:t,conversion:{mode:e,mimeType:n,target:l,compressionLevel:o,headers:a,callTimeout:d,connectTimeout:r},onChange:c,isDuplicate:u})=>{const{t:i}=A(),m=X(),{ref:_,height:j}=Ct(),[S,h]=et.useState(!0),f=e===b.DISABLED,p=e===b.IMAGE,I=it(d),C=at(r),P=rt(o),M=O(n)&&!u,y=M&&!l&&o==null;return s.jsxs(T,{children:[s.jsxs(T,{sx:{gap:1,flexDirection:"row",flexWrap:"nowrap",alignItems:"center",pt:1},children:[s.jsxs(T,{sx:{gap:1,flexDirection:"row",alignItems:"baseline",flexWrap:"wrap",[m.breakpoints.down("md")]:{flexDirection:"column",width:"100%"}},children:[s.jsx(J,{mode:b.IMAGE,shouldAutoFocus:!0,isDefault:M,isDuplicate:u,label:i("download.settings.conversion.mime_type"),value:n,onUpdate:g=>{c({...t,mimeType:g})}}),s.jsx(ut,{sx:{[m.breakpoints.up("md")]:{mx:1}},children:"â†’"}),s.jsxs(mt,{sx:{minWidth:"100px"},children:[s.jsx(gt,{id:"image-conversion-target-mode-label",children:i("download.settings.conversion.target_modes.title")}),s.jsx(jt,{ref:_,id:"image-conversion-target-mode",labelId:"image-conversion-target-mode-label",label:i("download.settings.conversion.target_modes.title"),value:e,onChange:g=>c({...t,mode:g.target.value,target:g.target.value===b.DISABLED?z:""}),children:pt.map(([g,{text:x}])=>s.jsx(xt,{value:g,children:i(x)},g))})]}),!f&&s.jsx(J,{mode:e,shouldAutoFocus:!1,isDefault:!1,isDuplicate:!1,label:i("download.settings.conversion.target"),value:l,onUpdate:g=>c({...t,target:g})}),(()=>{var g;return f?null:p?s.jsx(D,{sx:{width:w},label:i("download.settings.conversion.compression_level"),value:o!=null?o:"",type:"number",error:!P,helperText:P?"":i("global.error.label.invalid_input"),slotProps:{input:{inputProps:k}},onChange:x=>{c({...t,compressionLevel:x.target.value?Number(x.target.value):null})}}):s.jsxs(s.Fragment,{children:[s.jsx(D,{sx:{width:w},label:i("download.settings.conversion.call_timeout"),value:d?v(d).seconds.inWholeSeconds:"",type:"number",error:!I,helperText:I?"":i("global.error.label.invalid_input"),slotProps:{input:{inputProps:F,endAdornment:s.jsx(W,{position:"end",children:i("global.date.label.second_other")})}},onChange:x=>{c({...t,callTimeout:x.target.value?v(Number(x.target.value)).seconds.toISOString():null})}}),s.jsx(D,{sx:{width:w},label:i("download.settings.conversion.connect_timeout"),value:r?v(r).seconds.inWholeSeconds:"",type:"number",error:!C,helperText:C?"":i("global.error.label.invalid_input"),slotProps:{input:{inputProps:V,endAdornment:s.jsx(W,{position:"end",children:i("global.date.label.second_other")})}},onChange:x=>{c({...t,connectTimeout:x.target.value?v(Number(x.target.value)).seconds.toISOString():null})}}),s.jsx(G,{onClick:()=>h(!S),variant:S?"outlined":"contained",sx:{height:j},children:i("download.settings.conversion.headers.button",{count:(g=a==null?void 0:a.length)!=null?g:0})})]})})()]}),s.jsx(Q,{disabled:y,title:i("chapter.action.download.delete.label.action"),children:s.jsx(Z,{disabled:y,onClick:()=>{c(null)},children:s.jsx(nt,{})})})]}),s.jsx(Ot,{open:!S,headers:a,onChange:g=>c({...t,headers:g})})]})},zt=({type:t})=>{var h,f;const{t:e}=A();_t(e(bt[t]));const{data:n,loading:l,error:o,refetch:a}=$.useGetServerSettings({notifyOnNetworkStatusChange:!0}),[d]=$.useUpdateServerSettings();if(l)return s.jsx(Tt,{});if(o)return s.jsx(ht,{message:e("global.error.label.failed_to_load_data"),messageExtra:H(o),retry:()=>a().catch(St())});const r=ft[t];Et((h=n==null?void 0:n.settings)==null?void 0:h[r]);const c=(f=n==null?void 0:n.settings)==null?void 0:f[r],[u,i]=et.useState(K(U(R(c)))),m=Mt(u),_=Gt(K(U(R(c))),u),j=p=>{const I=d({variables:{input:{settings:{[r]:p}}}});return I.catch(C=>It(e("global.error.label.failed_to_save_changes"),"error",H(C))),I},S=async()=>{try{await j(yt(u))}catch(p){}};return s.jsxs(T,{sx:{p:2,gap:3},children:[s.jsx(tt,{children:e("download.settings.conversion.description",{value:z})}),s.jsx(T,{sx:{flexDirection:"column",gap:5},children:u.map((p,I)=>{const{mimeType:C}=p,P=ot(C,I,u);return s.jsx(Lt,{conversion:p,isDuplicate:P,onChange:M=>{i(y=>U(y.toSpliced(I,1,...M?[M]:[])))}},p.id)})}),s.jsxs(T,{direction:"row",sx:{gap:1},children:[s.jsx(G,{variant:"outlined",onClick:()=>{i(p=>[...p,...R([{mimeType:"",target:"",compressionLevel:null,headers:null,callTimeout:null,connectTimeout:null}])])},children:e("global.button.add")}),s.jsx(G,{variant:"contained",disabled:m||!_,onClick:S,children:e("global.button.save")})]})]})};export{zt as ImageProcessingSetting};
