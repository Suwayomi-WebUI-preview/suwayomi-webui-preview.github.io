import{R as H,u as T,a as P,c as n,j as s,L as I,T as _,an as O,h as q,N as Q,ag as V,d as v,g as z,E as W}from"./index-Dk3evM22.js";import{u as J,A as K,S as U}from"./AppbarSearch-DzAe9zxA.js";import{s as A,l as X,a as Y}from"./language-Bj3gVW5K.js";import{t as Z,L as ee}from"./LangSelect-CLKc8_HA.js";import{M as te}from"./MangaGrid-CXsFJhkQ.js";import{u as F}from"./useDebounce-D7hnVAd3.js";import{C as se,a as re}from"./index-l5SbcfCU.js";import"./useManageMangaLibraryState-C2muUN_t.js";import"./Trackers-y2kGZe-r.js";import"./TypographyMaxLines-DqqMyla0.js";import"./Avatar-BV6wLhu-.js";import"./Info-hMvXlY1W.js";import"./TextField-BrUu_0I2.js";import"./InputAdornment-D4bngkVQ.js";import"./SpinnerImage-DwAMaCI3.js";import"./Collapse-BQSfT_wp.js";import"./Link-F3Dk8mwd.js";import"./ListPreference-CGDX4hiE.js";import"./Checkbox-Dg3iacm0.js";import"./SwitchBase-CIJZyjD0.js";import"./NumberSetting-BdHRoB9V.js";import"./useMobilePicker-DiSzu7Fq.js";import"./Chip-CaShj2-o.js";import"./SelectSetting-1EgEuYIm.js";import"./Select-D7gXRjDY.js";import"./CheckboxInput-Bv0Ihyt3.js";import"./Mangas-DjdaaETO.js";import"./Chapters-BrKnupEp.js";import"./ThreeStateCheckboxInput-BsVY_tTx.js";import"./FilterList-CHjJ3ggE.js";import"./cloneObject-DrOPTG0J.js";import"./Switch-C6dPPV3f.js";import"./Delete-vNDXq9Mw.js";import"./Sync-CFQniJco.js";import"./PlayArrow-Cs6TdtDL.js";import"./StyledFab-DMKwIkYi.js";function ae(t){const r=[];return t.forEach(e=>{r.indexOf(e.lang)===-1&&r.push(e.lang)}),r.sort(X),r}const oe=(t,r)=>t.displayName<r.displayName?-1:t.displayName>r.displayName?1:0,ne=(t,r,e)=>{var g,h,o,m;const p=!((g=e.get(t.id))!=null&&g.isLoading),i=!((h=e.get(r.id))!=null&&h.isLoading);if(p&&!i)return-1;if(!p&&i)return 1;if(!p&&!i)return 0;const u=!((o=e.get(t.id))!=null&&o.hasResults),d=!((m=e.get(r.id))!=null&&m.hasResults);return u&&!d?1:d&&!u?-1:0},ie=1e3,ce=H.memo(({source:t,onSearchRequestFinished:r,searchString:e,emptyQuery:p,mode:i})=>{var y,L;const{t:u}=T(),{id:d,displayName:g,lang:h}=t,[o,m]=P.useSourceSearch(d,e!=null?e:"",void 0,1,{skipRequest:!e,addAbortSignal:!0}),{data:S,isLoading:c,error:x,abortRequest:w}=m[0],j=(L=(y=S==null?void 0:S.fetchSourceManga)==null?void 0:y.mangas)!=null?L:[],l=!c&&!j.length;n.useEffect(()=>{r(t,c,!l,!e)},[c,l,e]);let f;return x?f=u("search.error.label.source_search_failed"):l&&(f=u("manga.error.label.no_mangas_found")),n.useEffect(()=>()=>{w(new Error("SourceSearchPreview(".concat(t.id,", ").concat(t.displayName,"): search string changed")))},[e]),!c&&!e||p?null:s.jsxs(s.Fragment,{children:[s.jsx(se,{sx:{margin:"10px"},children:s.jsxs(re,{component:I,to:"/sources/".concat(d,"?query=").concat(e),sx:{p:3},children:[s.jsx(_,{variant:"h5",children:g}),s.jsx(_,{variant:"caption",children:Z(h)})]})}),f?s.jsx(O,{sx:{alignItems:"start"},noFaces:!0,message:f,messageExtra:x&&x.message,retry:x?()=>o(1).catch(q("SourceSearchPreview(".concat(t.id,")::refetch"))):void 0}):s.jsx(te,{mangas:j,isLoading:c,hasNextPage:!1,loadMore:()=>{},horizontal:!0,noFaces:!0,message:f,inLibraryIndicator:!0,mode:i})]})}),Ve=()=>{var b;const{t}=T(),{setTitle:r,setAction:e}=n.useContext(Q),{pathname:p,state:i}=V(),u=p.startsWith("/migrate/source"),d=i==null?void 0:i.mangaTitle,[g]=J("query",U),h=F(g,ie),[o,m]=v("shownSourceLangs",Y()),[S]=v("showNsfw",!0),{data:c,loading:x,error:w,refetch:j}=P.useGetSourceList({notifyOnNetworkStatusChange:!0}),l=(b=c==null?void 0:c.sources.nodes)!=null?b:[],[f,y]=n.useState(new Map),L=F(f,500),N=n.useMemo(()=>[...l].sort(oe),[l]),M=n.useMemo(()=>N.filter(a=>o.includes(a.lang)),[N,o]),R=n.useMemo(()=>M.filter(a=>S||!a.isNsfw),[M,S]),B=n.useMemo(()=>[...R].sort((a,E)=>ne(a,E,L)),[R,L]),D=n.useCallback(({id:a},E,$,k)=>{y(G=>{const C=new Map(G);return C.set(a,{isLoading:E,hasResults:$,emptySearch:k}),C})},[y]);return n.useEffect(()=>(r(t(u?"migrate.search.title":"search.title.global_search",{title:d})),e(s.jsxs(s.Fragment,{children:[s.jsx(K,{isClosable:!1}),s.jsx(ee,{shownLangs:o,setShownLangs:m,allLangs:ae(l),forcedLangs:A()})]})),()=>{r(""),e(null)}),[t,o,m,l]),n.useEffect(()=>{const a=A().filter(E=>!o.includes(E));m([...o,...a])},[]),x?s.jsx(z,{}):w?s.jsx(W,{message:t("global.error.label.failed_to_load_data"),messageExtra:w.message,retry:()=>j().catch(q())}):s.jsx(s.Fragment,{children:B.map(a=>s.jsx(ce,{source:a,onSearchRequestFinished:D,searchString:h,emptyQuery:!g,mode:u?"migrate.select":"source"},a.id))})};export{Ve as SearchAll};
