import{a1 as I,u as F,a as q,c as i,j as t,L as O,T as B,h as D,N as Q,av as V,d as _,g as W,B as A}from"./index-B75kYtqP.js";import{u as z,A as J,S as K}from"./AppbarSearch-Ba_cWq3g.js";import{s as P,l as U,a as X}from"./Languages-CbeKLN01.js";import{t as Y,L as Z}from"./LangSelect-BULjFqcr.js";import{u as T}from"./useDebounce-BX7-zlkJ.js";import{a as ee,E as te}from"./EmptyViewAbsoluteCentered-Dv2qmjMZ.js";import{B as re}from"./BaseMangaGrid-BJb3wpb7.js";import{C as se}from"./Card-B-9pq73x.js";import{C as oe}from"./CardActionArea-CWB75ZuS.js";import"./useManageMangaLibraryState-BsrDM68v.js";import"./Trackers-D4pSmk7a.js";import"./CardContent-DC6XoZ_c.js";import"./Avatar-C1SgAJIR.js";import"./Info-RQHop6tI.js";import"./TextField-BakXDSMW.js";import"./InputAdornment-BHdajV9c.js";import"./CheckCircle-C8DPSJ94.js";import"./SpinnerImage-Di1Vm1fZ.js";import"./Refresh-BM2loQZ8.js";import"./TypographyMaxLines-BeeyZxDi.js";import"./Collapse-C5s6cFn-.js";import"./Link-Wts2QMdV.js";import"./ListPreference-Bk-axmhK.js";import"./Checkbox-t9Uk7KzA.js";import"./SwitchBase-Duq7XaEt.js";import"./NumberSetting-C_a65vI6.js";import"./useMobilePicker-CFHXAsUA.js";import"./Chip-CzwVgLnr.js";import"./SelectSetting-zGFM03RC.js";import"./Select-DdSp-cy3.js";import"./CheckboxInput-5tAgWhU1.js";import"./Mangas-D2HSZsaA.js";import"./Chapters-DgElwDfT.js";import"./ThreeStateCheckboxInput-CY-TUhFx.js";import"./FilterList-DbGkBpVg.js";import"./cloneObject-DrOPTG0J.js";import"./Switch-DMp580lv.js";import"./MangaGrid-DS-8iM-E.js";import"./index-CVCnai7L.js";import"./Delete-DtNRxYmz.js";import"./Download-yfqKuc1p.js";import"./Sync-XLURGeJh.js";import"./PlayArrow-FFVJeMYj.js";import"./StyledFab-CEY0VxfO.js";function ae(r){const s=[];return r.forEach(e=>{s.indexOf(e.lang)===-1&&s.push(e.lang)}),s.sort(U),s}const ie=(r,s)=>r.displayName<s.displayName?-1:r.displayName>s.displayName?1:0,ne=(r,s,e)=>{var l,x,a,p;const g=!((l=e.get(r.id))!=null&&l.isLoading),n=!((x=e.get(s.id))!=null&&x.isLoading);if(g&&!n)return-1;if(!g&&n)return 1;if(!g&&!n)return 0;const m=!((a=e.get(r.id))!=null&&a.hasResults),u=!((p=e.get(s.id))!=null&&p.hasResults);return m&&!u?1:u&&!m?-1:0},ce=1e3,me=I.memo(({source:r,onSearchRequestFinished:s,searchString:e,emptyQuery:g,mode:n})=>{var y,E;const{t:m}=F(),{id:u,displayName:l,lang:x}=r,[a,p]=q.useSourceSearch(u,e!=null?e:"",void 0,1,{skipRequest:!e,addAbortSignal:!0}),{data:S,isLoading:c,error:L,abortRequest:w}=p[0],j=(E=(y=S==null?void 0:S.fetchSourceManga)==null?void 0:y.mangas)!=null?E:[],d=!c&&!j.length;i.useEffect(()=>{s(r,c,!d,!e)},[c,d,e]);let f;return L?f=m("search.error.label.source_search_failed"):d&&(f=m("manga.error.label.no_mangas_found")),i.useEffect(()=>()=>{w(new Error("SourceSearchPreview(".concat(u,", ").concat(l,"): search string changed")))},[e]),!c&&!e||g?null:t.jsxs(t.Fragment,{children:[t.jsx(se,{sx:{mb:1},children:t.jsxs(oe,{component:O,to:"/sources/".concat(u,"?query=").concat(e),sx:{p:3},children:[t.jsx(B,{variant:"h5",children:l}),t.jsx(B,{variant:"caption",children:Y(x)})]})}),f?t.jsx(ee,{sx:{alignItems:"start",height:void 0},noFaces:!0,message:f,messageExtra:L&&L.message,retry:L?()=>a(1).catch(D("SourceSearchPreview(".concat(r.id,")::refetch"))):void 0}):t.jsx(re,{gridWrapperProps:{sx:{px:0}},mangas:j,isLoading:c,hasNextPage:!1,loadMore:()=>{},horizontal:!0,noFaces:!0,message:f,inLibraryIndicator:!0,mode:n})]})}),et=()=>{var C;const{t:r}=F(),{setTitle:s,setAction:e}=i.useContext(Q),{pathname:g,state:n}=V(),m=g.startsWith("/migrate/source"),u=n==null?void 0:n.mangaTitle,[l]=z("query",K),x=T(l,ce),[a,p]=_("shownSourceLangs",X()),[S]=_("showNsfw",!0),{data:c,loading:L,error:w,refetch:j}=q.useGetSourceList({notifyOnNetworkStatusChange:!0}),d=(C=c==null?void 0:c.sources.nodes)!=null?C:[],[f,y]=i.useState(new Map),E=T(f,500),b=i.useMemo(()=>[...d].sort(ie),[d]),N=i.useMemo(()=>b.filter(o=>a.includes(o.lang)),[b,a]),M=i.useMemo(()=>N.filter(o=>S||!o.isNsfw),[N,S]),R=i.useMemo(()=>[...M].sort((o,h)=>ne(o,h,E)),[M,E]),$=i.useCallback(({id:o},h,k,G)=>{y(H=>{const v=new Map(H);return v.set(o,{isLoading:h,hasResults:k,emptySearch:G}),v})},[y]);return i.useLayoutEffect(()=>(s(r(m?"migrate.search.title":"search.title.global_search",{title:u})),e(t.jsxs(t.Fragment,{children:[t.jsx(J,{isClosable:!1}),t.jsx(Z,{shownLangs:a,setShownLangs:p,allLangs:ae(d),forcedLangs:P()})]})),()=>{s(""),e(null)}),[r,a,p,d]),i.useEffect(()=>{const o=P().filter(h=>!a.includes(h));p([...a,...o])},[]),L?t.jsx(W,{}):w?t.jsx(te,{message:r("global.error.label.failed_to_load_data"),messageExtra:w.message,retry:()=>j().catch(D())}):t.jsx(A,{sx:{p:1},children:R.map((o,h)=>t.jsx(A,{sx:{pb:h+1!==R.length?2:0},children:t.jsx(me,{source:o,onSearchRequestFinished:$,searchString:x,emptyQuery:!l,mode:m?"migrate.select":"source"})},o.id))})};export{et as SearchAll};
