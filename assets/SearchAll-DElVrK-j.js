import{e as i,u as D,q as Q,a as V,b as U,ax as J,d as K,r as H,j as t,h as X,g as C,i as N,p as A,S as q,B as v,s as Y,an as Z,A as ee,L as te,T as z,ay as re,m as oe}from"./index-DrA3uk5J.js";import{u as se,S as ne,A as ae}from"./AppbarSearch-Bqqr9_K2.js";import{P as ie}from"./PushPin-Cq7j4FJO.js";import{D as ce}from"./DoneAll-njhOxyRS.js";import{F as ue}from"./FilterList-DrHesDla.js";import{t as le,L as me}from"./LanguageSelect-BFyhrsy_.js";import{u as B}from"./useDebounce-ynC5e9mO.js";import{B as de}from"./BaseMangaGrid-CMONrzPD.js";import{E as pe}from"./EmptyViewAbsoluteCentered-B8-z0gAN.js";import{S as T,g as O}from"./Sources-DH7YSJaU.js";import{u as ge}from"./useAppTitleAndAction-DvQc_iUX.js";import{C as he}from"./Card-DhE5cVay.js";import{C as fe}from"./CardActionArea-C1-PpQSV.js";import"./ChaptersDownloadActionMenuItems-DepLlEVQ.js";import"./Trackers-D4pSmk7a.js";import"./ListCardContent-qmNHTXK1.js";import"./Avatar-Di3rA0Jh.js";import"./TextField-BGfSbTDW.js";import"./useFormControl-D7eHQFKi.js";import"./formControlState-Dq1zat_P.js";import"./InputAdornment-eRbX7E3n.js";import"./CheckCircle-CgNWZmwZ.js";import"./MUI.util-OKTrxvtu.js";import"./Link-30LDJ8Mz.js";import"./useManageMangaLibraryState-4woI8HO0.js";import"./ThreeStateCheckboxInput-DWmXiVGm.js";import"./Checkbox-BE65rDGA.js";import"./SwitchBase-BsBEeoDI.js";import"./CheckboxInput-C_hpEuLP.js";import"./FormGroup-D_8KUtf5.js";import"./ListPreference-DA6_NlNN.js";import"./NumberSetting-MNQpLukd.js";import"./Slider-Ch9A92-x.js";import"./useMobilePicker-wDRlD4iP.js";import"./Chip-Bf015-8r.js";import"./SelectSetting-BZ0RGcR6.js";import"./Select-K0bgJrJV.js";import"./Switch-CjvXqzlt.js";import"./MangaGrid-m4MK0KHv.js";import"./Delete-kZSrawxS.js";import"./Download-DTGlwocR.js";import"./Sync-D3nhokvq.js";import"./use-merged-ref-Cg7vSAhT.js";import"./ListCardAvatar-B5AB3PzH.js";import"./PlayArrow-1p0mnP2p.js";import"./StyledFab-Dfgw5FjT.js";import"./useAppTitle-z5slhRbE.js";import"./useAppAction-DE7oRLFR.js";const Se={x:0,y:0,width:0,height:0,top:0,left:0,bottom:0,right:0};function xe(o){const c=i.useRef(0),e=i.useRef(null),[p,h]=i.useState(Se),r=i.useMemo(()=>typeof window<"u"?new ResizeObserver(s=>{const n=s[0];n&&(cancelAnimationFrame(c.current),c.current=requestAnimationFrame(()=>{var m,d;if(e.current){const l=((m=n.borderBoxSize)==null?void 0:m[0])||((d=n.contentBoxSize)==null?void 0:d[0]);if(l){const f=l.inlineSize,x=l.blockSize;h({width:f,height:x,x:n.contentRect.x,y:n.contentRect.y,top:n.contentRect.top,left:n.contentRect.left,bottom:n.contentRect.bottom,right:n.contentRect.right})}else h(n.contentRect)}}))}):null,[]);return i.useEffect(()=>(e.current&&(r==null||r.observe(e.current,o)),()=>{r==null||r.disconnect(),c.current&&cancelAnimationFrame(c.current)}),[e.current]),[e,p]}function ye(o){const[c,{width:e,height:p}]=xe(o);return{ref:c,width:e,height:p}}const Re=(o,c)=>o.displayName.localeCompare(c.displayName),be=(o,c,e)=>{const p=O(o).isPinned,h=O(c).isPinned,r=e.get(o.id),s=e.get(c.id),n=!(r!=null&&r.isLoading),m=!!(r!=null&&r.error),d=!(r!=null&&r.hasResults)&&!m,l=!(s!=null&&s.isLoading),f=!!(s!=null&&s.error),x=!(s!=null&&s.hasResults)&&!f;return n&&!l?-1:!n&&l||d&&!x?1:x&&!d||!m&&f?-1:m&&!f?1:p&&!h?-1:!p&&h?1:0},we=1e3,Le=Z.memo(({source:o,onSearchRequestFinished:c,searchString:e,emptyQuery:p,mode:h})=>{var w,M;const{t:r}=D(),{id:s,displayName:n,lang:m}=o,d=i.useRef(e),l=i.useRef(()=>{});d.current!==e&&(d.current=e,l.current(new Error("SourceSearchPreview(".concat(s,", ").concat(n,"): search string changed"))));const[x,L]=H.useSourceSearch(s,e!=null?e:"",void 0,1,{skipRequest:!e,addAbortSignal:!0}),{data:g,isLoading:R,error:S,abortRequest:E}=L[0];l.current=E;const b=(M=(w=g==null?void 0:g.fetchSourceManga)==null?void 0:w.mangas)!=null?M:[],j=!S&&!R&&!b.length;i.useEffect(()=>{c(o,{isLoading:R,hasResults:!j,emptySearch:!e,error:S})},[R,j,e,S]);let y;return S?y=r("search.error.label.source_search_failed"):j&&(y=r("manga.error.label.no_mangas_found")),!R&&!e||p?null:t.jsxs(t.Fragment,{children:[t.jsx(he,{sx:{mb:1},children:t.jsxs(fe,{component:te,to:"".concat(ee.sources.childRoutes.browse.path(s),"?query=").concat(e),sx:{p:3},children:[t.jsx(z,{variant:"h5",children:n}),t.jsx(z,{variant:"caption",children:le(m)})]})}),y?t.jsx(re,{sx:{alignItems:"start",height:void 0},noFaces:!0,message:y,messageExtra:C(S),retry:S?()=>x(1).catch(N("SourceSearchPreview(".concat(o.id,")::refetch"))):void 0}):t.jsx(de,{gridWrapperProps:{sx:{px:0}},mangas:b,isLoading:R,hasNextPage:!1,loadMore:()=>{},horizontal:!0,noFaces:!0,message:y,inLibraryIndicator:!0,mode:h},e)]})}),xt=()=>{const{t:o}=D(),{pathname:c,state:e}=Q(),{ref:p,height:h}=ye(),r=c.startsWith("/migrate/source"),[s]=se("query",ne),n=B(s,we),[m,d]=V("shownSourceLangs",U()),[l,f]=J("SearchAll::shouldShowOnlyPinnedSources",!0),{settings:{showNsfw:x,shouldShowOnlySourcesWithResults:L}}=K(),{data:g,loading:R,error:S,refetch:E}=H.useGetSourceList({notifyOnNetworkStatusChange:!0}),b=i.useMemo(()=>{var u;return(u=g==null?void 0:g.sources.nodes)!=null?u:[]},[g==null?void 0:g.sources.nodes]),[j,y]=i.useState(new Map),w=B(j,500),M=i.useMemo(()=>T.getLanguages(b),[b]),P=i.useMemo(()=>T.filter(b,{showNsfw:x,languages:m,keepLocalSource:!0,pinned:l}),[b,m,l]),_=i.useMemo(()=>L?P.filter(u=>{const a=w.get(u.id);return!a||(a==null?void 0:a.isLoading)||(a==null?void 0:a.hasResults)&&!(a!=null&&a.error)}):P,[P,L,w]),k=i.useMemo(()=>[..._].toSorted(Re),[_]),F=i.useMemo(()=>[...k].sort((u,a)=>be(u,a,w)),[k,w]),$=i.useCallback(({id:u},a)=>{y(W=>{const I=new Map(W);return I.set(u,a),I})},[y]),G=Y(u=>oe(o("global.error.label.failed_to_save_changes"),"error",C(u)));return ge(o(r?"migrate.search.title":"search.title.global_search",{title:e==null?void 0:e.mangaTitle}),t.jsxs(t.Fragment,{children:[t.jsx(ae,{isClosable:!1}),t.jsx(me,{selectedLanguages:m,setSelectedLanguages:d,languages:M})]}),[m,d,M]),R?t.jsx(X,{}):S?t.jsx(pe,{message:o("global.error.label.failed_to_load_data"),messageExtra:C(S),retry:()=>E().catch(N())}):t.jsxs(A,{sx:{position:"relative",px:1,pb:1},children:[t.jsxs(q,{ref:p,sx:{width:"100%",position:"fixed",zIndex:1,flexDirection:"row",gap:2,pt:1,pb:2,background:u=>u.palette.background.default},children:[t.jsxs(q,{sx:{flexDirection:"row",gap:1},children:[t.jsx(v,{startIcon:t.jsx(ie,{}),variant:l?"contained":"outlined",onClick:()=>f(!0),children:o("global.label.pinned")}),t.jsx(v,{startIcon:t.jsx(ce,{}),variant:l?"outlined":"contained",onClick:()=>f(!1),children:o("extension.language.all")})]}),t.jsx(v,{startIcon:t.jsx(ue,{}),variant:L?"contained":"outlined",onClick:()=>G("shouldShowOnlySourcesWithResults",!L),children:o("search.filter.has_results")})]}),t.jsx(A,{sx:{pt:"".concat(h,"px")},children:F.map((u,a)=>t.jsx(A,{sx:{pb:a+1!==F.length?2:0},children:t.jsx(Le,{source:u,onSearchRequestFinished:$,searchString:n,emptyQuery:!s,mode:r?"migrate.select":"source"})},u.id))})]})};export{xt as SearchAll};
