import{r as T,i as q,j as e,u as $,a as n,c as g,N as B,f as m,I as u,g as N,h as S,B as v,L as F,S as G,T as R,D as K,m as j}from"./index-BLgYiawO.js";import{d as W}from"./Delete-yg-QzkHg.js";import{D as J,S as U,P as X,d as Y}from"./StrictModeDroppable-b8mJGYnI.js";import{d as Z}from"./PlayArrow-qrxQsm6h.js";import{V as ee}from"./index-DxfBLnT1.js";import{d as re}from"./Refresh-n1UR1Umw.js";import{D as te}from"./DownloadStateIndicator-D7CRwvt8.js";import{E as I}from"./EmptyViewAbsoluteCentered-DdVIYYLb.js";import{C as ae}from"./Card-qMlyKuip.js";import{C as oe}from"./CardActionArea-CzxepwG4.js";import{C as se}from"./CardContent-CSR8wzft.js";var w={},ne=q;Object.defineProperty(w,"__esModule",{value:!0});var k=w.default=void 0,le=ne(T()),ie=e;k=w.default=(0,le.default)((0,ie.jsx)("path",{d:"M6 19h4V5H6zm8-14v14h4V5z"}),"Pause");var D={},de=q;Object.defineProperty(D,"__esModule",{value:!0});var O=D.default=void 0,ce=de(T()),ue=e;O=D.default=(0,ce.default)((0,ue.jsx)("path",{d:"M15 16h4v2h-4zm0-8h7v2h-7zm0 4h6v2h-6zM3 18c0 1.1.9 2 2 2h6c1.1 0 2-.9 2-2V8H3zM14 5h-3l-1-1H6L5 5H2v2h12z"}),"DeleteSweep");const pe=({children:t,...o})=>e.jsx(v,{...o,style:{height:o["data-known-size"]||void 0},children:t}),z=({provided:t,item:o,handleDelete:x,handleRetry:d})=>{const{t:p}=$();return e.jsx(v,{...t.draggableProps,...t.dragHandleProps,ref:t.innerRef,sx:{p:1,pb:0},children:e.jsx(ae,{children:e.jsx(oe,{component:F,to:"/manga/".concat(o.manga.id),children:e.jsxs(se,{sx:{display:"flex",alignItems:"center",p:1.5},children:[e.jsx(u,{sx:{pointerEvents:"none"},children:e.jsx(Y,{})}),e.jsxs(G,{sx:{flex:1,ml:1},direction:"column",children:[e.jsx(R,{variant:"h6",component:"h3",children:o.manga.title}),e.jsx(R,{variant:"caption",sx:{display:"block"},children:o.chapter.name})]}),e.jsx(te,{download:o}),o.state===K.Error&&e.jsx(m,{title:p("global.button.retry"),children:e.jsx(u,{onClick:l=>{l.preventDefault(),l.stopPropagation(),d(o.chapter)},size:"large",children:e.jsx(re,{})})}),e.jsx(m,{title:p("chapter.action.download.delete.label.action"),children:e.jsx(u,{onClick:l=>{l.preventDefault(),l.stopPropagation(),x(o.chapter)},size:"large",children:e.jsx(W,{})})})]})})})})},Ce=()=>{var E,P;const{t}=$(),[o,{reset:x}]=n.useReorderChapterInDownloadQueue(),{data:d,loading:p,error:l,refetch:H}=n.useGetDownloadStatus({notifyOnNetworkStatusChange:!0}),i=d==null?void 0:d.downloadStatus,h=(E=i==null?void 0:i.queue)!=null?E:[],c=(P=i==null?void 0:i.state)!=null?P:"STARTED",f=!h.length,{setTitle:b,setAction:_}=g.useContext(B),L=async()=>{try{await n.clearDownloads().response}catch(r){j(t("download.queue.error.label.failed_delete_all"),"error")}},M=()=>{c==="STOPPED"?n.startDownloads():n.stopDownloads()};g.useLayoutEffect(()=>(b(t("download.queue.title")),_(e.jsxs(e.Fragment,{children:[e.jsx(m,{title:t("download.queue.label.delete_all"),children:e.jsx(u,{onClick:L,size:"large",color:"inherit",children:e.jsx(O,{})})}),e.jsx(m,{title:t(c==="STOPPED"?"global.button.start":"global.button.stop"),children:e.jsx(u,{onClick:M,size:"large",disabled:f,color:"inherit",children:c==="STOPPED"?e.jsx(Z,{}):e.jsx(k,{})})})]})),()=>{b(""),_(null)}),[t,c,f]),g.useEffect(()=>{const r=a=>{(a.message==="ResizeObserver loop completed with undelivered notifications."||a.message==="ResizeObserver loop limit exceeded")&&a.stopImmediatePropagation()};return window.addEventListener("error",r),()=>window.removeEventListener("error",r)},[]);const Q=(r,a,s)=>{a!==s&&o({variables:{input:{chapterId:r[a].chapter.id,to:s}}}).catch(()=>{x()})},A=r=>{r.destination&&Q(h,r.source.index,r.destination.index)},C=async r=>{try{await n.addChapterToDownloadQueue(r.id).response}catch(a){j(t("download.queue.error.label.failed_to_remove"),"error")}},y=async r=>{const a=c==="STARTED";try{a&&await n.stopDownloads().response,await Promise.all([n.removeChapterFromDownloadQueue(r.id).response,n.deleteDownloadedChapter(r.id).response])}catch(s){j(t("download.queue.error.label.failed_to_retry"),"error")}a&&n.startDownloads().response.catch(S())};return p?e.jsx(N,{}):l?e.jsx(I,{message:t("global.error.label.failed_to_load_data"),messageExtra:l.message,retry:()=>H().catch(S())}):f?e.jsx(I,{message:t("download.queue.label.no_downloads")}):e.jsx(J,{onDragEnd:A,children:e.jsx(U,{droppableId:"droppable",mode:"virtual",renderClone:(r,a,s)=>e.jsx(z,{provided:r,item:h[s.source.index],handleDelete:y,handleRetry:C}),children:r=>e.jsx(v,{ref:r.innerRef,children:e.jsx(ee,{useWindowScroll:!0,overscan:window.innerHeight*.5,data:h,components:{Item:pe},computeItemKey:(a,s)=>s.manga.id,itemContent:(a,s)=>e.jsx(X,{draggableId:"".concat(s.manga.id,"-").concat(s.chapter.sourceOrder),index:a,children:V=>e.jsx(z,{provided:V,item:s,handleDelete:y,handleRetry:C})})})})})})};export{Ce as DownloadQueue};
