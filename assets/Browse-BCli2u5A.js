import{r as X,i as K,j as e,u as _,M as Re,L as R,B as D,a as N,T,S as Q,b as P,c as p,N as Y,d as B,e as De,f as G,I as $,g as J,h as w,m as O,k as ke,l as Me,s as Pe,n as Be,o as Ge,p as xe,q as me,t as $e,v as He}from"./index-BVmGrBUs.js";import{u as Ee,S as Te,A as Fe}from"./AppbarSearch-4TGDPsKn.js";import{s as fe,l as Z,D as g,a as ze,e as qe}from"./Languages-BE7dBnqD.js";import{t as F,L as Ne,i as Ve,E as S}from"./LangSelect-CbiT0O0R.js";import{SourceContentType as q}from"./SourceMangas-pZs4MDmQ.js";import{S as ee}from"./SpinnerImage-DjAkUmuY.js";import{C as te}from"./Card-BRxUt46b.js";import{C as je}from"./CardActionArea-CIgIk5nK.js";import{C as ne}from"./CardContent-CS62nbBb.js";import{A as se}from"./Avatar-BY9Dze0_.js";import{E as H}from"./EmptyViewAbsoluteCentered-C87ddrgD.js";import{f as We}from"./file-selector-CPaIiPy8.js";import{d as Xe}from"./Add-Co-LFFla.js";import{S as Ke,a as Qe,b as ve}from"./StyledGroupItemWrapper-Osd8PIfc.js";import{T as V,a as W}from"./Tabs-C0wz9jTW.js";import{T as Ye,a as Je}from"./TabsMenu-BJD51zY5.js";import{d as Ze,a as et}from"./SortRadioInput-Dm1iIyJr.js";import{C as tt}from"./Chip-2KPIsYJv.js";import"./useManageMangaLibraryState-DqOFXj3D.js";import"./Trackers-D4pSmk7a.js";import"./Info-D-LxlH9c.js";import"./TextField-Dkp98Bg7.js";import"./InputAdornment-CJBsuTiY.js";import"./CheckCircle-DXYWI0az.js";import"./TypographyMaxLines-CpFLMsBV.js";import"./Collapse-zSSvrfGh.js";import"./Link-pQ27zRdd.js";import"./ListPreference-zwTaKqgL.js";import"./Checkbox-CH2sJXA1.js";import"./SwitchBase-DREOMkff.js";import"./NumberSetting-D3hgxZzY.js";import"./useMobilePicker-CfFeUaZQ.js";import"./SelectSetting-DgSLNqiW.js";import"./Select-DaY8zb3t.js";import"./CheckboxInput-D_MKFGrG.js";import"./Mangas-Be0-HAcX.js";import"./Chapters-CK-JPigc.js";import"./ThreeStateCheckboxInput-DzETotRm.js";import"./FilterList-6gaWnDnn.js";import"./cloneObject-DrOPTG0J.js";import"./Switch-UO4_To1Z.js";import"./ExpandMore-B4fUiggR.js";import"./GridLayouts-B_NZbFW3.js";import"./Delete-Bgotw3rN.js";import"./useDebounce-0mfXh0oQ.js";import"./StyledFab-Dz6Ea34h.js";import"./BaseMangaGrid-BVh8Y5k_.js";import"./MangaGrid-BIRADhdp.js";import"./index-CN7lqFi0.js";import"./Download-QLG0gbzi.js";import"./Sync-BAwuVjDv.js";import"./PlayArrow-C_yh1jYA.js";import"./Refresh-CKR4F3wd.js";var re={},nt=K;Object.defineProperty(re,"__esModule",{value:!0});var be=re.default=void 0,st=nt(X()),rt=e;be=re.default=(0,st.default)((0,rt.jsx)("path",{d:"M19.3 16.9c.4-.7.7-1.5.7-2.4 0-2.5-2-4.5-4.5-4.5S11 12 11 14.5s2 4.5 4.5 4.5c.9 0 1.7-.3 2.4-.7l3.2 3.2 1.4-1.4zm-3.8.1c-1.4 0-2.5-1.1-2.5-2.5s1.1-2.5 2.5-2.5 2.5 1.1 2.5 2.5-1.1 2.5-2.5 2.5M12 20v2C6.48 22 2 17.52 2 12S6.48 2 12 2c4.84 0 8.87 3.44 9.8 8h-2.07c-.64-2.46-2.4-4.47-4.73-5.41V5c0 1.1-.9 2-2 2h-2v2c0 .55-.45 1-1 1H8v2h2v3H9l-4.79-4.79C4.08 10.79 4 11.38 4 12c0 4.41 3.59 8 8 8"}),"TravelExplore");const ot=s=>{const{t:n}=_(),t=Re.useIsMobileWidth(),{source:{id:a,name:c,lang:o,iconUrl:r,supportsLatest:i,isNsfw:h,extension:{repo:l}},showSourceRepo:L}=s,d=Number(a)===0?n("source.local_source.title"):c;return e.jsx(te,{sx:{margin:1,marginTop:0},children:e.jsx(je,{component:R,to:"/sources/".concat(a),state:{contentType:q.POPULAR,clearCache:!0},children:e.jsxs(ne,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:1.5},children:[e.jsxs(D,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(se,{variant:"rounded",alt:d,sx:{width:56,height:56,flex:"0 0 auto",mr:1,background:"transparent"},children:e.jsx(ee,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:d,src:N.getValidImgUrlFor(r)})}),e.jsxs(D,{sx:{display:"flex",flexDirection:"column",justifyContent:"center"},children:[e.jsx(T,{variant:"h6",component:"h3",children:d}),e.jsxs(T,{variant:"caption",sx:{display:"block"},children:[F(o),h&&e.jsx(T,{variant:"caption",color:"error",sx:{display:"inline"},children:" 18+"}),L&&e.jsx(T,{variant:"caption",sx:{display:"block"},children:l})]})]})]}),e.jsxs(Q,{sx:{flexDirection:"row",gap:1},children:[i&&e.jsx(P,{variant:"outlined",component:R,to:"/sources/".concat(a),state:{contentType:q.LATEST,clearCache:!0},children:n("global.button.latest")}),!t&&e.jsx(P,{variant:"outlined",component:R,to:"/sources/".concat(a),state:{contentType:q.POPULAR,clearCache:!0},children:n("global.button.popular")})]})]})})})};function at(s){const n=new Set;return s.forEach(t=>{const c=Number(t.id)===0?g.OTHER:t.lang;n.add(c)}),[...n].sort(Z)}function it(s){const n={};return s.forEach(t=>{var o;const c=Number(t.id)===0?g.OTHER:t.lang;(o=n[c])!=null||(n[c]=[]),n[c].push(t)}),Object.values(n).forEach(t=>t.sort((a,c)=>a.name.localeCompare(c.name))),n}function lt(){const{t:s}=_(),{setAction:n}=p.useContext(Y),[t,a]=B("shownSourceLangs",ze()),[c]=B("showNsfw",!0),{data:o,loading:r,error:i,refetch:h}=N.useGetSourceList({notifyOnNetworkStatusChange:!0}),l=o==null?void 0:o.sources.nodes,L=p.useMemo(()=>{if(!l||l!=null&&l.length)return!1;const{repo:d}=l[0].extension;return l.some(f=>f.extension.repo!==d)},[l]),v=De();return p.useEffect(()=>{fe().forEach(d=>{let f=!1;t.forEach(x=>{x===d&&(f=!0)}),f||a(x=>(x.push(d),x))})},[]),p.useLayoutEffect(()=>(n(e.jsxs(e.Fragment,{children:[e.jsx(G,{title:s("search.title.global_search"),children:e.jsx($,{onClick:()=>v("/sources/all/search/"),size:"large",color:"inherit",children:e.jsx(be,{})})}),e.jsx(Ne,{shownLangs:t,setShownLangs:a,allLangs:at(l!=null?l:[]),forcedLangs:fe()})]})),()=>{n(null)}),[s,t,l]),r?e.jsx(J,{}):i?e.jsx(H,{message:s("global.error.label.failed_to_load_data"),messageExtra:i.message,retry:()=>h().catch(w())}):(l==null?void 0:l.length)===0?e.jsx(H,{message:s("source.error.label.no_sources_found")}):e.jsx(e.Fragment,{children:Object.entries(it(l!=null?l:[])).sort((d,f)=>Z(d[0],f[0])).map(([d,f])=>(d===g.OTHER||t.includes(d))&&e.jsxs(p.Fragment,{children:[e.jsx(T,{variant:"h5",component:"h2",sx:{paddingLeft:3,paddingTop:1,paddingBottom:2,fontWeight:"bold"},children:F(d)},d),f.filter(x=>{if(d===g.OTHER){const y=Number(x.id)===0;if(!(t.includes(d)||y))return!1}return c||!x.isNsfw}).map(x=>e.jsx(ot,{source:x,showSourceRepo:L},x.id))]},d))})}var Ae=(s=>(s.UPDATE="UPDATE",s.UNINSTALL="UNINSTALL",s.INSTALL="INSTALL",s))(Ae||{}),Ie=(s=>(s.OBSOLETE="OBSOLETE",s.UPDATING="UPDATING",s.UNINSTALLING="UNINSTALLING",s.INSTALLING="INSTALLING",s))(Ie||{});const E={...Ae,...Ie},ct={UPDATE:"UPDATING",UNINSTALL:"UNINSTALLING",INSTALL:"INSTALLING"},ut={UPDATE:"UNINSTALL",UNINSTALL:"INSTALL",INSTALL:"UNINSTALL"},dt={[E.UNINSTALL]:"extension.action.label.uninstall",[E.INSTALL]:"extension.action.label.install",[E.UPDATE]:"extension.action.label.update",[E.OBSOLETE]:"extension.state.label.obsolete",[E.UPDATING]:"extension.state.label.updating",[E.UNINSTALLING]:"extension.state.label.uninstalling",[E.INSTALLING]:"extension.state.label.installing"},pt={UPDATE:"extension.label.update_failed",INSTALL:"extension.label.installation_failed",UNINSTALL:"extension.label.uninstallation_failed"},ge=(s,n,t)=>n?E.OBSOLETE:t?E.UPDATE:s?E.UNINSTALL:E.INSTALL;function ht(s){const{t:n}=_(),{extension:{name:t,lang:a,versionName:c,isInstalled:o,hasUpdate:r,isObsolete:i,pkgName:h,iconUrl:l,isNsfw:L,repo:v},handleUpdate:d,showSourceRepo:f}=s,[x,C]=p.useState(ge(o,i,r)),y=a==="all"?n("extension.language.all"):a.toUpperCase(),A=async b=>{const j=ut[b],M=ct[b];try{switch(C(M),b){case"INSTALL":await N.updateExtension(h,{install:!0,isObsolete:i}).response;break;case"UNINSTALL":await N.updateExtension(h,{uninstall:!0,isObsolete:i}).response;break;case"UPDATE":await N.updateExtension(h,{update:!0,isObsolete:i}).response;break;default:throw new Error('Unexpected ExtensionAction "'.concat(b,'"'))}C(j),d()}catch(z){C(ge(o,i,r)),O(n(pt[b]),"error")}};function k(){switch(x){case"INSTALL":case"UPDATE":case"UNINSTALL":A(x).catch(w());break;case"OBSOLETE":A("UNINSTALL").catch(w());break}}return e.jsx(te,{children:e.jsxs(ne,{sx:{display:"flex",alignItems:"center",gap:1,p:1.5,"&:last-child":{paddingBottom:1.5}},children:[e.jsx(se,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",background:"transparent"},alt:t,children:e.jsx(ee,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:t,src:N.getValidImgUrlFor(l)})}),e.jsxs(D,{sx:{display:"flex",flexDirection:"column",flexGrow:1,flexShrink:1,wordBreak:"break-word",justifyContent:"center"},children:[e.jsx(T,{variant:"h6",component:"h3",children:t}),e.jsxs(T,{variant:"caption",sx:{display:"block"},children:[y," ",c,L&&e.jsx(T,{variant:"caption",color:"error",sx:{display:"inline"},children:" 18+"})]}),f&&e.jsx(T,{variant:"caption",sx:{display:"block"},children:v})]}),e.jsx(P,{variant:"outlined",sx:{color:x===E.OBSOLETE?"red":"inherit",flexShrink:0},onClick:()=>k(),children:n(dt[x])})]})})}const Le=0,Se=1;function xt(s){const n=[],t={[S.OBSOLETE]:[],[S.INSTALLED]:[],[S.UPDATE_PENDING]:[],[g.ALL]:[],[g.OTHER]:[],[g.LOCAL_SOURCE]:[]};s.forEach(r=>{if(t[r.lang]===void 0&&(t[r.lang]=[],r.lang!=="all"&&n.push(r.lang)),r.isInstalled){if(r.hasUpdate){t[S.UPDATE_PENDING].push(r);return}if(r.isObsolete){t[S.OBSOLETE].push(r);return}t[S.INSTALLED].push(r)}else t[r.lang].push(r)}),n.sort(Z);const a=[[S.OBSOLETE,t[S.OBSOLETE]],[S.UPDATE_PENDING,t[S.UPDATE_PENDING]],[S.INSTALLED,t[S.INSTALLED]],[g.ALL,t[g.ALL]],[g.OTHER,t[g.OTHER]],[g.LOCAL_SOURCE,t[g.LOCAL_SOURCE]]],c=n.map(r=>[r,t[r]]),o=a.concat(c);return o.forEach(([,r])=>r.sort((i,h)=>i.name.localeCompare(h.name))),{allLangs:n,groupedExtensions:o}}function mt({tabsMenuHeight:s}){var pe,he;const{t:n}=_(),{setAction:t}=p.useContext(Y),{data:a,loading:c,error:o,refetch:r}=N.useGetServerSettings({notifyOnNetworkStatusChange:!0}),i=!!(a!=null&&a.settings.extensionRepos.length),h=((pe=a==null?void 0:a.settings.extensionRepos.length)!=null?pe:0)>1,l=p.useRef(null),[L,v]=B("shownExtensionLangs",qe()),[d]=B("showNsfw",!0),[f]=Ee("query",Te),[x,C]=p.useState({}),[y,{data:A,loading:k,error:b}]=N.useExtensionListFetch(),j=(he=A==null?void 0:A.fetchExtensions)==null?void 0:he.extensions,M=p.useCallback(()=>C({}),[]);p.useEffect(()=>{y()},[x]);const z=p.useMemo(()=>(j!=null?j:[]).filter(u=>{const m=d||!u.isNsfw;return f?m&&u.name.toLowerCase().includes(f.toLowerCase()):m}),[j,d,f]),{allLangs:ie,groupedExtensions:le}=p.useMemo(()=>xt(z),[z]),U=p.useMemo(()=>le.filter(u=>u[Se].length>0).filter(u=>Ve(u[Le])||L.includes(u[Le])),[L,le]),ye=p.useMemo(()=>U.map(u=>u[Se].length),[U]),Oe=p.useMemo(()=>U.map(([,u])=>u).flat(1),[U]),ce=u=>{u.name.toLowerCase().endsWith("apk")?(l.current&&(l.current.value=""),O(n("extension.label.installing_file"),"info"),N.installExternalExtension(u).response.then(()=>{M(),O(n("extension.label.installed_successfully"),"success")}).catch(()=>O(n("extension.label.installation_failed"),"error"))):O(n("global.error.label.invalid_file_type"),"error")};p.useLayoutEffect(()=>(t(e.jsxs(e.Fragment,{children:[e.jsx(Fe,{}),e.jsx(G,{title:n("extension.action.label.install_external"),children:e.jsx($,{onClick:()=>{var u;return(u=l.current)==null?void 0:u.click()},size:"large",color:"inherit",children:e.jsx(Xe,{})})}),e.jsx(Ne,{shownLangs:L,setShownLangs:v,allLangs:ie})]})),()=>{t(null)}),[n,L,ie]),p.useEffect(()=>{const u=async I=>{I.preventDefault();const Ue=await We(I);ce(Ue[0])},m=I=>{I.preventDefault()};return document.addEventListener("drop",u),document.addEventListener("dragover",m),()=>{document.removeEventListener("drop",u),document.removeEventListener("dragover",m)}},[]);const ue=p.useMemo(()=>e.jsx("input",{type:"file",style:{display:"none"},ref:l,onChange:u=>{var I;const m=(I=u.target.files)==null?void 0:I[0];m&&ce(m)}}),[]),we=c||k,de=o!=null?o:b;return we?e.jsx(J,{}):de?e.jsx(H,{message:n("global.error.label.failed_to_load_data"),messageExtra:de.message,retry:()=>{o&&r().catch(w()),b&&y().catch(w())}}):!(j!=null&&j.length)&&!i?e.jsxs(e.Fragment,{children:[ue,e.jsxs(Q,{sx:{alignItems:"center",justifyContent:"center",rowGap:"10px",paddingTop:"20px"},children:[e.jsx(T,{children:n("extension.label.add_repository_info")}),e.jsx(P,{component:R,variant:"contained",to:"/settings/browseSettings",children:n("settings.title")})]})]}):e.jsxs(e.Fragment,{children:[ue,e.jsx(Ke,{heightToSubtract:s,overscan:window.innerHeight*.5,groupCounts:ye,groupContent:u=>{const[m]=U[u];return e.jsx(Qe,{variant:"h5",component:"h2",isFirstItem:u===0,children:F(m)},m)},itemContent:u=>{const m=Oe[u];return e.jsx(ve,{children:e.jsx(ht,{extension:m,handleUpdate:M,showSourceRepo:h})},"".concat(m.pkgName,"_").concat(m.isInstalled,"_").concat(m.isObsolete,"_").concat(m.hasUpdate))}})]})}var oe={},ft=K;Object.defineProperty(oe,"__esModule",{value:!0});var _e=oe.default=void 0,gt=ft(X()),Lt=e;_e=oe.default=(0,gt.default)((0,Lt.jsx)("path",{d:"M14.94 4.66h-4.72l2.36-2.36zm-4.69 14.71h4.66l-2.33 2.33zM6.1 6.27 1.6 17.73h1.84l.92-2.45h5.11l.92 2.45h1.84L7.74 6.27zm-1.13 7.37 1.94-5.18 1.94 5.18zm10.76 2.5h6.12v1.59h-8.53v-1.29l5.92-8.56h-5.88v-1.6h8.3v1.26z"}),"SortByAlpha");var ae={},St=K;Object.defineProperty(ae,"__esModule",{value:!0});var Ce=ae.default=void 0,Et=St(X()),Tt=e;Ce=ae.default=(0,Et.default)((0,Tt.jsx)("path",{d:"M20 10V8h-4V4h-2v4h-4V4H8v4H4v2h4v4H4v2h4v4h2v-4h4v4h2v-4h4v-2h-4v-4zm-6 4h-4v-4h4z"}),"Tag");const Nt=({id:s,name:n,lang:t,iconUrl:a,mangaCount:c})=>{const{t:o}=_(),i=Number(s)===0?o("source.local_source.title"):n;return e.jsx(te,{children:e.jsx(je,{component:R,to:"/migrate/source/".concat(s,"/"),children:e.jsxs(ne,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",p:1.5},children:[e.jsxs(D,{sx:{display:"flex"},children:[e.jsx(se,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",mr:1,background:"transparent"},children:e.jsx(ee,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:i,src:N.getValidImgUrlFor(a)})}),e.jsxs(D,{sx:{display:"flex",flexDirection:"column",justifyContent:"center"},children:[e.jsx(T,{variant:"h6",component:"h3",children:i}),e.jsx(T,{variant:"caption",sx:{display:"block"},children:F(t)})]})]}),e.jsx(tt,{sx:{borderRadius:1},size:"small",label:c})]})})})},jt=(s,{sortBy:n,sortOrder:t})=>{if(!s)return[];const a={};s.forEach(({sourceId:o,source:r})=>{var h;const i=(h=a[o])!=null?h:{id:o,name:o,lang:"unknown",iconUrl:null,mangaCount:0,...r};a[o]={...i,mangaCount:i.mangaCount+1}});const c=Object.values(a).toSorted((o,r)=>{switch(n){case xe.SOURCE_NAME:return o.name.localeCompare(r.name);case xe.MANGA_COUNT:return o.mangaCount-r.mangaCount;default:throw new Error('Unexpected "sortBy" "'.concat(n,'"'))}});switch(t){case me.ASC:return c;case me.DESC:return c.toReversed();default:throw new Error('Unexpected "sortOrder" "'.concat(t,'"'))}},vt=({tabsMenuHeight:s})=>{const{t:n}=_(),{appBarHeight:t}=ke(),{settings:{migrateSortSettings:a}}=Me(),c=$e(()=>O(n("global.error.label.failed_to_save_changes"),"error")),{sortBy:o,sortOrder:r}=a,{data:i,loading:h,error:l,refetch:L}=N.useGetMigratableSources({notifyOnNetworkStatusChange:!0}),v=p.useMemo(()=>jt(i==null?void 0:i.mangas.nodes,a),[i==null?void 0:i.mangas.nodes,a]);return h?e.jsx(J,{}):l?e.jsx(H,{message:n("global.error.label.failed_to_load_data"),messageExtra:l.message,retry:()=>L().catch(w())}):e.jsxs(e.Fragment,{children:[e.jsxs(Q,{sx:{position:"sticky",top:"".concat(t+s,"px"),flexDirection:"row",justifyContent:"end",alignItems:"center",gap:1,p:1,backgroundColor:"background.default",zIndex:1},children:[e.jsx(G,{title:n(Pe[o]),children:e.jsx($,{size:"large",color:"inherit",onClick:()=>c("migrateSortSettings",{sortBy:(o+1)%2,sortOrder:r}),children:o?e.jsx(Ce,{}):e.jsx(_e,{})})}),e.jsx(G,{title:n(Be[r]),children:e.jsx($,{size:"large",color:"inherit",onClick:()=>c("migrateSortSettings",{sortBy:o,sortOrder:(r+1)%2}),children:r?e.jsx(Ze,{}):e.jsx(et,{})})})]}),e.jsx(Ge,{sx:{p:0},children:v.map(d=>e.jsx(ve,{children:e.jsx(Nt,{...d})},d.id))})]})};function An(){const{t:s}=_(),{setTitle:n}=p.useContext(Y);p.useLayoutEffect(()=>{n(s("global.label.browse"))},[s]);const t=p.useRef(null),[a,c]=p.useState(0);He(t,p.useCallback(()=>c(t.current.offsetHeight),[t.current]));const[o,r]=Ee("tab",Te,{}),i=o!=null?o:"source";return o||r(i,"replaceIn"),e.jsxs(Ye,{children:[e.jsxs(Je,{ref:t,variant:"fullWidth",value:i,onChange:(h,l)=>r(l,"replaceIn"),children:[e.jsx(V,{value:"source",sx:{textTransform:"none"},label:s("source.title_one")}),e.jsx(V,{value:"extensions",sx:{textTransform:"none"},label:s("extension.title_other")}),e.jsx(V,{value:"migrate",sx:{textTransform:"none"},label:s("migrate.title")})]}),e.jsx(W,{index:"source",currentIndex:i,children:e.jsx(lt,{})}),e.jsx(W,{index:"extensions",currentIndex:i,children:e.jsx(mt,{tabsMenuHeight:a})}),e.jsx(W,{index:"migrate",currentIndex:i,children:e.jsx(vt,{tabsMenuHeight:a})})]})}export{An as Browse};
