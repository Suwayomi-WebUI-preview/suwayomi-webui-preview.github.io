import{c as r,v as Pe,j as t,B as H,r as ce,i as le,J as rt,aq as wt,ar as Rt,as as Pt,at as yt,au as Xe,C as de,u as nt,k as Et,av as bt,e as at,aw as st,ax as Lt,ay as St,f as ne,I as ae,T as Dt,az as kt,a5 as jt,aA as Tt,a3 as Ue,aB as _t,a6 as Ot,a as J,aC as Nt,aD as Ke,l as qe,N as At,m as Ge,M as It,a8 as $t,h as Q,aE as Mt,aF as Wt}from"./index-bzZBvN07.js";import{P as he,R as zt,u as Bt,g as Ft}from"./ReaderSettingsOptions-BWkWHV0V.js";import{S as Ye}from"./Select-CUJbL-F7.js";import{C as Ht}from"./CustomIconButton-BHwHKq22.js";import{D as q,C as _}from"./Chapters-BfJKimYN.js";import{C as Vt}from"./Collapse-ALulIn13.js";import{a as Ze}from"./TextField-bUrPaMer.js";import{u as Xt}from"./useDebounce-BI8tg3sb.js";import{E as Je}from"./EmptyViewAbsoluteCentered-aKEOBFkM.js";import"./NumberSetting-Cu8QmNKC.js";import"./Info-EL8IofpS.js";import"./InputAdornment-CIgb_nrR.js";import"./SpinnerImage-BX3EiImH.js";import"./Refresh-BO6PZrid.js";import"./Switch-V-JMeDM4.js";import"./SwitchBase-zTg1Vf7G.js";const Ut=s=>{for(let c=0;c<s.children.length;c++){const i=s.children.item(c);if(i){const{left:p,right:l}=i.getBoundingClientRect();if(p<=window.innerWidth/2&&l>window.innerWidth/2)return c}}return-1},Kt=5,qt=()=>window.innerWidth+window.scrollX>=document.body.scrollWidth-Kt,Gt=()=>window.scrollX<=0;function Yt(s){const{pages:c,curPage:i,initialPage:p,settings:l,setCurPage:f,prevChapter:L,nextChapter:R}=s,h=r.useRef(p),u=r.useRef(null),o=r.useRef([]);function j(){var e;i<c.length-1?((e=o.current[i+1])==null||e.scrollIntoView({inline:"center"}),f(d=>d+1)):l.loadNextOnEnding&&R()}function x(){var e;i>0?((e=o.current[i-1])==null||e.scrollIntoView({inline:"center"}),f(i-1)):i===0&&L()}function C(){l.readerType==="ContinuesHorizontalLTR"?x():j()}function D(){l.readerType==="ContinuesHorizontalLTR"?j():x()}const E=r.useRef(0);function n(e){window.scrollBy(E.current-e.pageX,0)}function a(e){var d;E.current=e.pageX,(d=u.current)==null||d.addEventListener("mousemove",n)}function y(){var e;(e=u.current)==null||e.removeEventListener("mousemove",n)}function O(e){e.clientX>=window.innerWidth*.85?D():e.clientX<=window.innerWidth*.15&&C()}function N(e){window.scrollBy({left:l.readerType==="ContinuesHorizontalLTR"?e.deltaY:e.deltaY*-1})}const m=()=>{l.readerType==="ContinuesHorizontalLTR"?window.scrollX+window.innerWidth>=document.body.scrollWidth&&R():l.readerType==="ContinuesHorizontalRTL"&&window.scrollX<=window.innerWidth&&R()};return Pe(o.current[p],r.useCallback((e,d)=>{const P=o.current[p];P!=null&&P.offsetHeight&&(P.scrollIntoView({inline:"center"}),d.disconnect())},[o.current[p],p])),r.useEffect(()=>{var e,d;return(e=u.current)==null||e.addEventListener("mousedown",a),(d=u.current)==null||d.addEventListener("mouseup",y),()=>{var P,A;(P=u.current)==null||P.removeEventListener("mousedown",a),(A=u.current)==null||A.removeEventListener("mouseup",y)}},[u]),r.useEffect(()=>(l.loadNextOnEnding&&document.addEventListener("scroll",m),()=>{document.removeEventListener("scroll",m)}),[u,i,L,R]),r.useEffect(()=>{const e=()=>{if(!u.current)return;const d=Ut(u.current);d!==h.current&&(h.current=d,f(d)),(l.readerType==="ContinuesHorizontalLTR"?qt():Gt())&&(h.current=c.length-1,f(h.current))};return window.addEventListener("scroll",e),()=>window.removeEventListener("scroll",e)},[l.readerType]),t.jsx(H,{ref:u,sx:{display:"flex",flexDirection:l.readerType==="ContinuesHorizontalLTR"?"row":"row-reverse",justifyContent:l.readerType==="ContinuesHorizontalLTR"?"flex-start":"flex-end",width:"auto",height:"auto",overflowX:"visible",userSelect:"none"},onClick:O,onWheel:N,children:c.map(e=>t.jsx(he,{index:e.index,src:e.src,onImageLoad:()=>{},settings:l,ref:d=>{o.current[e.index]=d}},e.index))})}function Zt(s){const{settings:c,curPage:i,pageCount:p}=s;return t.jsx(H,{sx:{display:c.showPageNumber?"block":"none",position:"fixed",bottom:"50px",padding:"2px",paddingLeft:"4px",paddingRight:"4px",textAlign:"center",backgroundColor:"rgba(0, 0, 0, 0.3)",borderRadius:"10px"},children:"".concat(i+1," / ").concat(p)})}function Jt(s){const{pages:c,settings:i,setCurPage:p,initialPage:l,curPage:f,nextChapter:L,prevChapter:R}=s,h=r.useRef(null),u=n=>{p(n),window.scroll({top:0})};function o(){f<c.length-1?u(f+1):i.loadNextOnEnding&&L()}function j(){f>0?u(f-1):R()}function x(){i.readerType==="SingleLTR"?j():i.readerType==="SingleRTL"&&o()}function C(){i.readerType==="SingleLTR"?o():i.readerType==="SingleRTL"&&j()}function D(n){switch(n.key){case"Space":n.preventDefault(),o();break;case"ArrowRight":C();break;case"ArrowLeft":x();break}}function E(n){n.clientX>window.innerWidth/2?C():x()}return r.useEffect(()=>(document.addEventListener("keydown",D),()=>{document.removeEventListener("keydown",D)}),[h,f,i.readerType,R,L]),r.useEffect(()=>{setTimeout(()=>{u(l)},0)},[l]),t.jsx(H,{ref:h,sx:{display:"flex",flexDirection:"column",justifyContent:"center",width:"auto",height:"auto"},onClick:E,children:c.map(({index:n,src:a})=>t.jsx(he,{index:n,onImageLoad:()=>{},src:a,settings:i,display:n===f},a))})}const Qt=s=>s.height/s.width<1;function er(s){const{pages:c,settings:i,setCurPage:p,initialPage:l,curPage:f,nextChapter:L,prevChapter:R}=s,h=r.useRef(null),u=r.useRef([]),[o,j]=r.useState(Array(c.length).fill(!1)),[x,C]=r.useState(Array(c.length).fill(!1)),D=r.useMemo(()=>o.map((m,e)=>e+o.slice(0,e).filter(Boolean).length),[o]);function E(){const m=P=>p(P===-1?c.length-1:P);if(u.current[c.length-1]&&i.loadNextOnEnding){f===c.length-1||m(c.length-1),L();return}const d=u.current.findIndex((P,A)=>!P&&A>f);m(d)}function n(){const m=P=>p(Math.max(P,0));if(u.current[0]){!f||m(0),R();return}const d=[...u.current].slice(0,f).findLastIndex(P=>!P);m(d)}function a(){i.readerType==="DoubleLTR"?n():E()}function y(){i.readerType==="DoubleLTR"?E():n()}function O(m){switch(m.key){case"Space":m.preventDefault(),E();break;case"ArrowRight":y();break;case"ArrowLeft":a();break}}function N(m){m.clientX>window.innerWidth/2?y():a()}return r.useEffect(()=>(document.addEventListener("keydown",O),()=>{document.removeEventListener("keydown",O)}),[h,f,i.readerType,R,L,x,o]),r.useEffect(()=>{p(l)},[l]),t.jsx(H,{ref:h,onClick:N,children:t.jsx(H,{id:"display",sx:{display:"flex",flexDirection:i.readerType==="DoubleLTR"?"row":"row-reverse",justifyContent:"center",width:"auto",height:"auto"},children:c.map(({index:m,src:e})=>{const P=!(D[f]%2),A=(()=>{const g=i.offsetFirstPage?-1:1;return(P?1:-1)*g})(),I=f+A,F=f===0,X=m===f,$=m===I,v=o[f],b=o[I],M=v||b,W=F&&i.offsetFirstPage,U=X||$&&!M&&!W;return u.current[m]=U,t.jsx(he,{index:m,src:e,onImageLoad:()=>{const g=new Image;g.onload=()=>{C(k=>k.toSpliced(m,1,!0)),j(k=>k.toSpliced(m,1,Qt(g)))},g.src=e},settings:i,display:U},e)})})})}const tr=s=>{for(let c=0;c<s.children.length;c++){const i=s.children.item(c);if(i){const{top:p,bottom:l}=i.getBoundingClientRect();if(p<=window.innerHeight&&l>1)return c}}return-1},rr=5,nr=.95,Qe=.25,ar="smooth",et=()=>window.innerHeight+window.scrollY>=document.body.offsetHeight-rr,sr=()=>window.scrollY<=0;function tt(s){const{pages:c,settings:i,setCurPage:p,initialPage:l,nextChapter:f,prevChapter:L}=s,R=r.useRef(l),h=r.useRef(null),u=r.useRef([]);r.useEffect(()=>{let n=!1;const a=()=>{if(h.current)if(et()){if(n)return;n=!0,R.current=c.length-1,p(R.current),i.loadNextOnEnding&&f()}else{n=!1;const y=tr(h.current);y!==R.current&&(R.current=y,p(y))}};return window.addEventListener("scroll",a),()=>{window.removeEventListener("scroll",a)}},[i.loadNextOnEnding,f]);const o=r.useRef(0),j=r.useRef(!1);function x(n){j.current=!0,window.scrollBy(0,o.current-n.pageY)}function C(n){var a;o.current=n.pageY,(a=h.current)==null||a.addEventListener("mousemove",x)}function D(){var n;(n=h.current)==null||n.removeEventListener("mousemove",x)}r.useEffect(()=>{var n,a;return(n=h.current)==null||n.addEventListener("mousedown",C),(a=h.current)==null||a.addEventListener("mouseup",D),()=>{var y,O;(y=h.current)==null||y.removeEventListener("mousedown",C),(O=h.current)==null||O.removeEventListener("mouseup",D)}},[h]);const E=r.useCallback((n,a=nr)=>{if(n==="down"&&et()){f();return}if(n==="up"&&sr()){L();return}window.scroll({top:window.scrollY+window.innerHeight*a*(n==="up"?-1:1),behavior:ar})},[f,L]);return r.useEffect(()=>{const n=a=>{switch(a.key){case"Space":a.preventDefault(),E(a.shiftKey?"up":"down");break;case"ArrowDown":a.preventDefault(),E(a.shiftKey?"up":"down",Qe);break;case"ArrowRight":a.preventDefault(),E(a.shiftKey?"up":"down");break;case"ArrowUp":a.preventDefault(),E(a.shiftKey?"down":"up",Qe);break;case"ArrowLeft":a.preventDefault(),E(a.shiftKey?"down":"up");break}};return document.addEventListener("keydown",n,!1),()=>{document.removeEventListener("keydown",n)}},[E]),Pe(u.current[l],r.useCallback((n,a)=>{const y=u.current[l];y!=null&&y.offsetHeight&&(y.scrollIntoView(),a.disconnect())},[u.current[l],l])),t.jsx(H,{ref:h,sx:{display:"flex",flexDirection:"column",justifyContent:"center",width:"auto",height:"auto",userSelect:"none"},onClick:n=>{if(j.current){j.current=!1;return}E(n.clientX>window.innerWidth/2?"down":"up")},children:c.map(n=>t.jsx(he,{index:n.index,src:n.src,onImageLoad:()=>{},settings:i,ref:a=>{u.current[n.index]=a}},n.index))})}var ye={},or=le;Object.defineProperty(ye,"__esModule",{value:!0});var ot=ye.default=void 0,ir=or(ce()),cr=t;ot=ye.default=(0,ir.default)((0,cr.jsx)("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Close");var Ee={},lr=le;Object.defineProperty(Ee,"__esModule",{value:!0});var oe=Ee.default=void 0,dr=lr(ce()),ur=t;oe=Ee.default=(0,dr.default)((0,ur.jsx)("path",{d:"M15.41 16.59 10.83 12l4.58-4.59L14 6l-6 6 6 6z"}),"KeyboardArrowLeft");var be={},pr=le;Object.defineProperty(be,"__esModule",{value:!0});var ie=be.default=void 0,fr=pr(ce()),gr=t;ie=be.default=(0,fr.default)((0,gr.jsx)("path",{d:"M8.59 16.59 13.17 12 8.59 7.41 10 6l6 6-6 6z"}),"KeyboardArrowRight");var Le={},hr=le;Object.defineProperty(Le,"__esModule",{value:!0});var it=Le.default=void 0,xr=hr(ce()),mr=t;it=Le.default=(0,xr.default)((0,mr.jsx)("path",{d:"M7.41 8.59 12 13.17l4.59-4.58L18 10l-6 6-6-6z"}),"KeyboardArrowDown");var Se={},Cr=le;Object.defineProperty(Se,"__esModule",{value:!0});var ct=Se.default=void 0,vr=Cr(ce()),wr=t;ct=Se.default=(0,vr.default)((0,wr.jsx)("path",{d:"M7.41 15.41 12 10.83l4.59 4.58L18 14l-6-6-6 6z"}),"KeyboardArrowUp");const Rr={entering:{transform:"none"},entered:{transform:"none"}},Pr=r.forwardRef(function(c,i){const p=rt(),l={enter:p.transitions.duration.enteringScreen,exit:p.transitions.duration.leavingScreen},{addEndListener:f,appear:L=!0,children:R,easing:h,in:u,onEnter:o,onEntered:j,onEntering:x,onExit:C,onExited:D,onExiting:E,style:n,timeout:a=l,TransitionComponent:y=Pt,...O}=c,N=r.useRef(null),m=wt(N,Rt(R),i),e=v=>b=>{if(v){const M=N.current;b===void 0?v(M):v(M,b)}},d=e(x),P=e((v,b)=>{yt(v);const M=Xe({style:n,timeout:a,easing:h},{mode:"enter"});v.style.webkitTransition=p.transitions.create("transform",M),v.style.transition=p.transitions.create("transform",M),o&&o(v,b)}),A=e(j),I=e(E),F=e(v=>{const b=Xe({style:n,timeout:a,easing:h},{mode:"exit"});v.style.webkitTransition=p.transitions.create("transform",b),v.style.transition=p.transitions.create("transform",b),C&&C(v)}),X=e(D),$=v=>{f&&f(N.current,v)};return t.jsx(y,{appear:L,in:u,nodeRef:N,onEnter:P,onEntered:A,onEntering:d,onExit:F,onExited:X,onExiting:I,addEndListener:$,timeout:a,...O,children:(v,b)=>r.cloneElement(R,{style:{transform:"scale(0)",visibility:v==="exited"&&!u?"hidden":void 0,...Rr[v],...n,...R.props.style},ref:m,...b})})}),yr=de("div")({zIndex:10}),Er=de("div")(({theme:s})=>({position:"fixed",top:0,left:0,minWidth:"240px",maxWidth:"400px",height:"100vh",overflowY:"auto",backgroundColor:s.palette.background.default,"& header":{backgroundColor:s.palette.action.hover,display:"flex",alignItems:"center",padding:"".concat(s.spacing(1)," ").concat(s.spacing(3)),transition:"left 2s ease"}})),br=de("div")(({theme:s})=>({margin:"0 ".concat(s.spacing(2))})),Lr=de("div")({display:"flex",flexWrap:"wrap",alignContent:"center",alignItems:"center",justifyContent:"center"}),Sr=de("div")(({theme:s})=>({display:"grid",gridTemplateRows:"auto auto auto",gridTemplateColumns:"0fr 1fr 0fr",gridTemplateAreas:'"pre current next"',gridColumnGap:s.spacing(.5),margin:"".concat(s.spacing(1)," 0"),"& a":{textDecoration:"none",color:"inherit",display:"flex",flexWrap:"wrap",alignContent:"center"}}));function Dr(s){var U;const{t:c}=nt(),{setReaderNavBarWidth:i}=Et(),p=rt(),l=bt(),f=at(),L=st(),{prevDrawerOpen:R,prevSettingsCollapseOpen:h}=(U=L.state)!=null?U:{},u=r.useRef(null);Pe(u,r.useCallback(()=>{var g;((g=u.current)==null?void 0:g.offsetWidth)!==void 0&&i(u.current.offsetWidth)},[u.current])),r.useLayoutEffect(()=>()=>i(0),[u]);const{settings:o,setSettingValue:j,manga:x,chapter:C,chapters:D,curPage:E,scrollToPage:n,openNextChapter:a,retrievingNextChapter:y}=s,O=Lt(),N=r.useMemo(()=>new Set(D.map(({scanlator:g})=>g)).size>1,[D]),[m,e]=r.useState(o.staticNav||R),[d,P]=r.useState(!0),[A,I]=r.useState(o.staticNav||R),[F,X]=r.useState(0),[$,v]=r.useState(h!=null?h:!0),b=y,M=(g,k,te)=>{P(g!=="staticNav"),j(g,k,te)},W=g=>{e(g),I(g)},V=()=>{const g=window.pageYOffset;Math.abs(g-F)>20&&(I(g>F),X(g))};return r.useEffect(()=>{d&&W(o.staticNav)},[o.staticNav]),r.useEffect(()=>{window.addEventListener("scroll",V);const g=document.querySelector("#root"),k=document.querySelector("#appMainContainer");return g.style.display="flex",g.style.flexDirection="column",k.style.display="none",()=>{g.style.display="block",k.style.display="block",window.removeEventListener("scroll",V)}},[V]),t.jsxs(yr,{children:[t.jsx(St,{direction:l("right","left"),in:m,timeout:200,appear:!1,mountOnEnter:!0,unmountOnExit:!0,children:t.jsxs(Er,{ref:u,children:[t.jsxs("header",{children:[!o.staticNav&&t.jsx(ne,{title:c("reader.button.close_menu"),children:t.jsx(ae,{edge:"start",color:"inherit","aria-label":"menu",onClick:()=>W(!1),size:"large",children:l(t.jsx(oe,{}),t.jsx(ie,{}))})}),t.jsx(Dt,{variant:"h6",component:"h1",sx:{textOverflow:"ellipsis",overflow:"hidden",py:1,flexGrow:1},children:C.name}),t.jsx(ne,{title:c("reader.button.exit"),children:t.jsx(ae,{edge:"start",color:"inherit","aria-label":"menu",onClick:O,size:"large",sx:{mr:-1},children:t.jsx(ot,{})})})]}),t.jsxs(kt,{ContainerComponent:"div",sx:{"& span":{fontWeight:"bold"}},children:[t.jsx(jt,{primary:c("reader.settings.title.reader_settings")}),t.jsxs(ae,{edge:"start",color:"inherit","aria-label":"menu",disableRipple:!0,disableFocusRipple:!0,onClick:()=>v(!$),size:"large",children:[$&&t.jsx(ct,{}),!$&&t.jsx(it,{})]})]}),t.jsx(Vt,{in:$,timeout:"auto",unmountOnExit:!0,children:t.jsx(zt,{setSettingValue:M,staticNav:o.staticNav,showPageNumber:o.showPageNumber,loadNextOnEnding:o.loadNextOnEnding,skipDupChapters:o.skipDupChapters,fitPageToWindow:o.fitPageToWindow,scalePage:o.scalePage,readerType:o.readerType,offsetFirstPage:o.offsetFirstPage,readerWidth:o.readerWidth})}),t.jsx(Tt,{sx:{my:1,mx:2}}),t.jsxs(br,{children:[t.jsxs(Lr,{children:[t.jsx("span",{children:c("reader.page_info.label.currently_on_page")}),t.jsx(Ze,{size:"small",sx:{mx:.5},disabled:b||C.pageCount===-1,children:t.jsx(Ye,{value:C.pageCount>-1?"".concat(E):"",displayEmpty:!0,onChange:({target:{value:g}})=>{n(Number(g))},children:Array(Math.max(0,C.pageCount)).fill(1).map((g,k)=>t.jsx(Ue,{value:k,children:k+1},"Page#".concat(k)))})}),t.jsx("span",{children:c("reader.page_info.label.of_max_pages",{maxPages:C.pageCount})})]}),t.jsxs(Sr,{children:[t.jsx(ne,{title:c("reader.button.previous_chapter"),children:t.jsx(ae,{sx:{gridArea:"pre"},disabled:b||C.sourceOrder<=1,onClick:()=>a(q.PREVIOUS),children:l(t.jsx(oe,{}),t.jsx(ie,{}))})}),t.jsx(Ze,{sx:{gridArea:"current"},size:"small",disabled:b||C.sourceOrder<1,children:t.jsx(Ye,{value:C.sourceOrder>=1?"".concat(C.sourceOrder):"",displayEmpty:!0,onChange:({target:{value:g}})=>{f("/manga/".concat(x.id,"/chapter/").concat(g),{replace:!0,state:{prevDrawerOpen:m,prevSettingsCollapseOpen:$}})},children:D.map(({id:g,sourceOrder:k,name:te,chapterNumber:ue,scanlator:re})=>t.jsx(Ue,{value:k,children:"#".concat(ue).concat(N&&re!=null?" (".concat(re,")"):""," | ").concat(te)},g))})}),t.jsx(ne,{title:c("reader.button.next_chapter"),children:t.jsx(ae,{sx:{gridArea:"next"},disabled:b||C.sourceOrder<1||C.sourceOrder>=x.chapters.totalCount,onClick:()=>a(q.NEXT),children:l(t.jsx(ie,{}),t.jsx(oe,{}))})})]})]})]})}),t.jsx(Pr,{in:!m,children:t.jsx(_t,{in:!A,children:t.jsx(ne,{title:c("reader.button.open_menu"),children:t.jsx(Ht,{sx:{position:"fixed",top:20,left:20,backgroundColor:"rgba(255, 255, 255, 0.75);",color:"black",...p.applyStyles("dark",{backgroundColor:"rgba(0, 0, 0, 0.75);",color:"white"})},size:"large",variant:"contained",onClick:()=>W(!0),children:l(t.jsx(ie,{}),t.jsx(oe,{}))})})})})]})}const se=s=>_.getFromCache(s,Mt,"CHAPTER_READER_FIELDS"),kr=s=>{switch(s){case"ContinuesVertical":case"Webtoon":return tt;case"SingleVertical":case"SingleRTL":case"SingleLTR":return Jt;case"DoubleVertical":case"DoubleRTL":case"DoubleLTR":return er;case"ContinuesHorizontalLTR":case"ContinuesHorizontalRTL":return Yt;default:return tt}},jr=s=>Array.from({length:s},(c,i)=>i),ee={pageCount:-1,sourceOrder:-1,chapterCount:0,lastPageRead:0,name:"Loading...",manga:{id:-1}};function qr(){var Ie,$e,Me,We,ze,Be,Fe,He;const{t:s}=nt(),c=at(),i=st(),{chapterIndex:p,mangaId:l}=Ot(),f=r.useMemo(()=>({id:+l,title:"",thumbnailUrl:"",genre:[],inLibraryAt:0,lastReadAt:0,chapters:{totalCount:0},trackRecords:{totalCount:0}}),[l]),{data:L,loading:R,error:h,refetch:u}=J.useGetManga(Nt,l),o=r.useRef(null),j=Number(l)===((Ie=o.current)==null?void 0:Ie.mangaId)&&Number(p)===(($e=o.current)==null?void 0:$e.sourceOrder)&&((Me=o.current)==null?void 0:Me.pageCount)!==-1,x=(We=L==null?void 0:L.manga)!=null?We:f,{data:C,loading:D,error:E,refetch:n}=J.useGetChapters(Ke,{condition:{mangaId:Number(l),sourceOrder:Number(p)}},{notifyOnNetworkStatusChange:!0}),a=C==null?void 0:C.chapters.nodes[0],y=r.useRef(!1),{settings:{downloadAheadLimit:O}}=qe(),N=!!O,m=()=>{var B;return o.current&&j?a&&((B=o.current)==null?void 0:B.pageCount)!==a.pageCount?a:o.current:(y.current=!1,a||null)};o.current=m();const e=(ze=o.current)!=null?ze:ee,d=r.useRef(ee);d.current===ee&&(d.current=e),e.mangaId!==((Be=d.current)==null?void 0:Be.mangaId)&&(d.current=ee);const[P,{loading:A,error:I}]=J.useGetChapterPagesFetch(e.id),F=()=>{D||P().then(()=>{y.current=!0}).catch(Q())};r.useEffect(()=>{F()},[e.id]);const[X,$]=r.useState(!1),[v,b]=r.useState(0),M=v===e.pageCount-1,W=Xt(v,M?0:1e3),[V,U]=r.useState(void 0),{setOverride:g,setTitle:k,readerNavBarWidth:te}=r.useContext(At),[ue,re]=r.useState(!1),{data:xe,loading:lt,error:De,refetch:dt}=J.useGetMangaChapters(Ke,l,{nextFetchPolicy:"standby"}),w=xe==null?void 0:xe.chapters.nodes,me=R||D||lt||A||!y.current&&!E&&!I,ke=(He=(Fe=h!=null?h:E)!=null?Fe:De)!=null?He:I,{settings:je,loading:Te}=Bt(),[S,_e]=r.useState(je),{settings:pe}=qe(),Oe=r.useMemo(()=>S.skipDupChapters?_.removeDuplicates(d.current,w!=null?w:[]):w!=null?w:[],[d.current,w,S.skipDupChapters]),ut=r.useMemo(()=>_.getNextChapters(e,w!=null?w:[],{offset:q.PREVIOUS,skipDupe:S.skipDupChapters,skipDupeChapter:d.current}),[e,d.current,w,S.skipDupChapters]),pt=r.useMemo(()=>_.getNextChapters(e,w!=null?w:[],{skipDupe:S.skipDupChapters,skipDupeChapter:d.current}),[e,d.current,w,S.skipDupChapters]),fe=r.useMemo(()=>_.getNextChapter(e,w!=null?w:[],{offset:q.PREVIOUS,skipDupe:S.skipDupChapters,skipDupeChapter:d.current}),[e,d.current,w,S.skipDupChapters]),G=r.useMemo(()=>_.getNextChapter(e,w!=null?w:[],{skipDupe:S.skipDupChapters,skipDupeChapter:d.current}),[e,d.current,w,S.skipDupChapters]),Ne=T=>{if(e===ee)return;const z=()=>{if(!(!!T.isRead&&!!pe.deleteChaptersWhileReading)||!w)return[];const Z=[e,...ut][pe.deleteChaptersWhileReading-1];if(!Z)return[];const ve=se(Z.id);return ve.isRead&&_.isDeletable(ve,pe.deleteChaptersWithBookmark)?S.skipDupChapters?_.getIds(_.addDuplicates([Z],w)):_.getIds([Z]):[]};(()=>{var we;const ge=se(e.id),Z=((we=T.lastPageRead)!=null?we:0)/e.pageCount>.25;if(N&&x.inLibrary&&!!(ge!=null&&ge.isDownloaded)&&Z){const Re=G?se(G.id):null;if(!(Re!=null&&Re.isDownloaded))return;const Ve=_.getNonRead(pt).map(K=>se(K.id)).slice(-O).filter(K=>!K.isDownloaded).map(K=>K.id).filter(K=>!_.isDownloading(K));if(!Ve.length)return;_.download(Ve).catch(Q())}})();const Ce=S.skipDupChapters?_.getIds(_.addDuplicates([e],w!=null?w:[e])):[e.id];J.updateChapters(Ce,{...T,chapterIdsToDelete:z(),trackProgressMangaId:pe.updateProgressAfterReading&&T.isRead&&x.trackRecords.totalCount?x.id:void 0},{errorPolicy:"all"}).response.catch(Q())},ft=(T,z,B=!0)=>{_e({...S,[T]:z}),B&&Wt(x,[[T,z]]).catch(()=>Ge(s("reader.settings.error.label.failed_to_save_settings"),"warning"))},Y=r.useCallback(T=>{const z=T===q.NEXT,B=z?G:fe;if(!B){Ge(s(z?"reader.error.label.next_chapter_does_not_exist":"reader.error.label.prev_chapter_does_not_exist"),"error");return}re(!0),b(0),c("/manga/".concat(x.id,"/chapter/").concat(B.sourceOrder),{replace:!0,state:i.state}),re(!1)},[x.id,fe==null?void 0:fe.id,G==null?void 0:G.id]);r.useEffect(()=>{if(me||!e){b(0);return}$(!0),e.lastPageRead===e.pageCount-1?b(0):b(e.lastPageRead)},[e,me]),r.useLayoutEffect(()=>{!(x!=null&&x.title)||e.name===s("global.label.loading")?k(s("reader.title")):k("".concat(x.title,": ").concat(e.name))},[s,x,e]),r.useEffect(()=>{!Te&&!R&&_e(Ft(x,je))},[Te,R]),r.useLayoutEffect(()=>(g({status:!0,value:t.jsx(Dr,{settings:S,setSettingValue:ft,manga:x,chapter:e,chapters:Oe,curPage:v,scrollToPage:U,openNextChapter:Y,retrievingNextChapter:ue})}),()=>g({status:!1,value:t.jsx("div",{})})),[x,e,S,v,p,ue,Y,Oe]),r.useEffect(()=>{if(!X||e===ee)return;const T=se(e.id);if(W===(T==null?void 0:T.lastPageRead))return;const z=W!==-1,B=W===e.pageCount-1;(z||B)&&Ne({lastPageRead:z?W:void 0,isRead:B?!0:void 0})},[W,N]);const gt=r.useCallback(()=>{Ne({lastPageRead:e.pageCount-1,isRead:!0}),Y(q.NEXT)},[e.pageCount,Y,e,x]),ht=r.useCallback(()=>{Y(q.PREVIOUS)},[Y]),xt=It.useGetScrollbarSize("height");if(me)return t.jsx(H,{sx:{height:"100vh",width:"100vw",display:"grid",placeItems:"center"},children:t.jsx($t,{thickness:5})});if(ke)return t.jsx(Je,{message:s("global.error.label.failed_to_load_data"),messageExtra:ke.message,retry:()=>{h&&u().catch(Q()),E&&n().catch(Q()),De&&dt().catch(Q()),I&&F()}});if(!e.pageCount)return t.jsx(Je,{message:s("reader.error.label.no_pages_found"),retry:F});const mt=jr(e.pageCount).map(T=>({index:T,src:J.getChapterPageUrl(l,p,T)})),Ct=kr(S.readerType),vt=V!=null?V:e.lastPageRead===e.pageCount-1?0:e.lastPageRead,Ae=S.staticNav?te:0;return t.jsxs(H,{sx:{display:"flex",flexDirection:"column",alignContent:"center",alignItems:"center",justifyContent:"center",minWidth:"calc((100vw - (100vw - 100%)) - ".concat(Ae,"px)"),minHeight:"calc(100vh - ".concat(xt,"px)"),marginLeft:"".concat(Ae,"px")},children:[t.jsx(Zt,{settings:S,curPage:v,pageCount:e.pageCount}),t.jsx(H,{sx:{alignSelf:"stretch"},children:t.jsx(Ct,{pages:mt,pageCount:e.pageCount,setCurPage:b,initialPage:vt,curPage:v,settings:S,manga:x,chapter:e,nextChapter:gt,prevChapter:ht},e.id)})]})}export{qr as Reader};
