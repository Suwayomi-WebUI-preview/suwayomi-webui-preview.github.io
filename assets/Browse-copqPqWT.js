import{r as Ae,i as Ie,j as e,s as pe,u as y,L as v,B as k,a as E,T as L,b as U,c as i,N as V,d as M,e as ve,f as xe,I as he,g as z,E as B,h as _,m as _e,k as ye,S as Ce,l as Oe,n as we}from"./index-oRIRLdTc.js";import{s as le,l as X,a as Ue,D as N,e as ke}from"./language-dNRM_i9S.js";import{t as F,L as fe,i as De,E as m}from"./LangSelect-CytjTYnU.js";import{SourceContentType as G}from"./SourceMangas-Cgz7Ub6S.js";import{S as K}from"./SpinnerImage-DW9OsWzH.js";import{C as Y,a as me}from"./index-GvSbNFLs.js";import{C as Q}from"./TypographyMaxLines-BNHg7A0t.js";import{A as J}from"./Avatar-CcDXsjIp.js";import{f as Pe}from"./file-selector-DwAuWEzn.js";import{d as Re}from"./Add-C7WQstQo.js";import{u as Ge,S as Me,A as Be}from"./AppbarSearch-C1YQ0CB4.js";import{S as Fe,a as He,b as ge}from"./StyledGroupItemWrapper-C30bXO4v.js";import{T as q,a as W}from"./Tabs-D6fIrhbX.js";import{T as $e,a as qe}from"./TabsMenu-Dq9xWiDD.js";import{C as We}from"./Chip-JPf_ZSz1.js";import"./FilterList-DGjncu9R.js";import"./cloneObject-DrOPTG0J.js";import"./Switch-VMDINBIy.js";import"./SwitchBase-BlBfNF3c.js";import"./TextField-DMTi1w9F.js";import"./Favorite-BM0qxl-U.js";import"./GridLayouts-DtT-4td7.js";import"./ViewModule-DjT7HQWu.js";import"./Checkbox-BdS23FYY.js";import"./ListPreference-CXUgdAnc.js";import"./Delete-BVPdRoPh.js";import"./SortRadioInput-rRGQkf2n.js";import"./CheckboxInput-DMbgtOSw.js";import"./Collapse-B8XrT4qm.js";import"./useDebounce-DeLFY8e2.js";import"./InputAdornment-D_9Ms7n1.js";import"./ThreeStateCheckboxInput-B-CbCuTI.js";import"./StyledFab-Cb3Wf9hh.js";import"./useManageMangaLibraryState-CDblByhM.js";import"./Trackers-D4pSmk7a.js";import"./Info-9sXqn82X.js";import"./Link-C1gu1KUN.js";import"./NumberSetting-Bj_AJdfH.js";import"./useMobilePicker-DtWyLc-8.js";import"./SelectSetting-R9bHNOf-.js";import"./Select-5E6XA32z.js";import"./Mangas-kvZcDncw.js";import"./Chapters-hIKX2fci.js";import"./BaseMangaGrid-PuPw9uR6.js";import"./MangaGrid-BL_K3BuO.js";import"./Sync-B3l4Ax5K.js";import"./PlayArrow-DZuT6F0m.js";var Z={},Ve=Ie;Object.defineProperty(Z,"__esModule",{value:!0});var Le=Z.default=void 0,ze=Ve(Ae()),Xe=e;Le=Z.default=(0,ze.default)((0,Xe.jsx)("path",{d:"M19.3 16.9c.4-.7.7-1.5.7-2.4 0-2.5-2-4.5-4.5-4.5S11 12 11 14.5s2 4.5 4.5 4.5c.9 0 1.7-.3 2.4-.7l3.2 3.2 1.4-1.4zm-3.8.1c-1.4 0-2.5-1.1-2.5-2.5s1.1-2.5 2.5-2.5 2.5 1.1 2.5 2.5-1.1 2.5-2.5 2.5M12 20v2C6.48 22 2 17.52 2 12S6.48 2 12 2c4.84 0 8.87 3.44 9.8 8h-2.07c-.64-2.46-2.4-4.47-4.73-5.41V5c0 1.1-.9 2-2 2h-2v2c0 .55-.45 1-1 1H8v2h2v3H9l-4.79-4.79C4.08 10.79 4 11.38 4 12c0 4.41 3.59 8 8 8"}),"TravelExplore");const Ke=pe("div")(({theme:s})=>({display:"flex",[s.breakpoints.up("sm")]:{display:"none"}})),Ye=pe("div")(({theme:s})=>({display:"flex",[s.breakpoints.down("sm")]:{display:"none"},"& .MuiButton-root":{marginLeft:"20px"}})),Qe=s=>{const{t:n}=y(),{source:{id:t,name:a,lang:c,iconUrl:r,supportsLatest:x,isNsfw:f,extension:{repo:T}},showSourceRepo:l}=s;return e.jsx(Y,{sx:{margin:"10px",marginTop:0},children:e.jsx(me,{component:v,to:"/sources/".concat(t),state:{contentType:G.POPULAR,clearCache:!0},children:e.jsxs(Q,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:2},children:[e.jsxs(k,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(J,{variant:"rounded",alt:a,sx:{width:56,height:56,flex:"0 0 auto",mr:2,background:"transparent"},children:e.jsx(K,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:a,src:E.getValidImgUrlFor(r)})}),e.jsxs(k,{sx:{display:"flex",flexDirection:"column",justifyContent:"center"},children:[e.jsx(L,{variant:"h5",component:"h2",children:a}),t!=="0"&&e.jsxs(L,{variant:"caption",display:"block",gutterBottom:!0,children:[F(c),f&&e.jsx(L,{variant:"caption",display:"inline",gutterBottom:!0,color:"red",children:" 18+"}),l&&e.jsx(L,{variant:"caption",display:"block",children:T})]})]})]}),e.jsxs(e.Fragment,{children:[e.jsx(Ke,{children:x&&e.jsx(U,{variant:"outlined",component:v,to:"/sources/".concat(t),state:{contentType:G.LATEST,clearCache:!0},children:n("global.button.latest")})}),e.jsxs(Ye,{children:[x&&e.jsx(U,{variant:"outlined",component:v,to:"/sources/".concat(t),state:{contentType:G.LATEST,clearCache:!0},children:n("global.button.latest")}),e.jsx(U,{variant:"outlined",component:v,to:"/sources/".concat(t),state:{contentType:G.POPULAR,clearCache:!0},children:n("global.button.popular")})]})]})]})})})};function Je(s){const n=[];return s.forEach(t=>{n.indexOf(t.lang)===-1&&n.push(t.lang)}),n.sort(X),n}function Ze(s){const n={};return s.forEach(t=>{n[t.lang]===void 0&&(n[t.lang]=[]),n[t.lang].push(t)}),n}function et(){const{t:s}=y(),{setAction:n}=i.useContext(V),[t,a]=M("shownSourceLangs",Ue()),[c]=M("showNsfw",!0),{data:r,loading:x,error:f,refetch:T}=E.useGetSourceList({notifyOnNetworkStatusChange:!0}),l=r==null?void 0:r.sources.nodes,j=i.useMemo(()=>{if(!l||l!=null&&l.length)return!1;const{repo:d}=l[0].extension;return l.some(h=>h.extension.repo!==d)},[l]),C=ve();return i.useEffect(()=>{le().forEach(d=>{let h=!1;t.forEach(p=>{p===d&&(h=!0)}),h||a(p=>(p.push(d),p))})},[]),i.useEffect(()=>(n(e.jsxs(e.Fragment,{children:[e.jsx(xe,{title:s("search.title.global_search"),children:e.jsx(he,{onClick:()=>C("/sources/all/search/"),size:"large",children:e.jsx(Le,{})})}),e.jsx(fe,{shownLangs:t,setShownLangs:a,allLangs:Je(l!=null?l:[]),forcedLangs:le()})]})),()=>{n(null)}),[s,t,l]),x?e.jsx(z,{}):f?e.jsx(B,{message:s("global.error.label.failed_to_load_data"),messageExtra:f.message,retry:()=>T().catch(_())}):(l==null?void 0:l.length)===0?e.jsx(B,{message:s("source.error.label.no_sources_found")}):e.jsx(e.Fragment,{children:Object.entries(Ze(l!=null?l:[])).sort((d,h)=>X(d[0],h[0])).map(([d,h])=>t.indexOf(d)!==-1&&e.jsxs(i.Fragment,{children:[e.jsx(L,{variant:"h4",style:{paddingLeft:"24px",paddingTop:"6px",paddingBottom:"16px",fontWeight:"bold"},children:F(d)},d),h.filter(p=>c||!p.isNsfw).map(p=>e.jsx(Qe,{source:p,showSourceRepo:j},p.id))]},d))})}var Te=(s=>(s.UPDATE="UPDATE",s.UNINSTALL="UNINSTALL",s.INSTALL="INSTALL",s))(Te||{}),Ee=(s=>(s.OBSOLETE="OBSOLETE",s.UPDATING="UPDATING",s.UNINSTALLING="UNINSTALLING",s.INSTALLING="INSTALLING",s))(Ee||{});const g={...Te,...Ee},tt={UPDATE:"UPDATING",UNINSTALL:"UNINSTALLING",INSTALL:"INSTALLING"},nt={UPDATE:"UNINSTALL",UNINSTALL:"INSTALL",INSTALL:"UNINSTALL"},st={[g.UNINSTALL]:"extension.action.label.uninstall",[g.INSTALL]:"extension.action.label.install",[g.UPDATE]:"extension.action.label.update",[g.OBSOLETE]:"extension.state.label.obsolete",[g.UPDATING]:"extension.state.label.updating",[g.UNINSTALLING]:"extension.state.label.uninstalling",[g.INSTALLING]:"extension.state.label.installing"},rt={UPDATE:"extension.label.update_failed",INSTALL:"extension.label.installation_failed",UNINSTALL:"extension.label.uninstallation_failed"},ce=(s,n,t)=>n?g.OBSOLETE:t?g.UPDATE:s?g.UNINSTALL:g.INSTALL;function at(s){const{t:n}=y(),{extension:{name:t,lang:a,versionName:c,isInstalled:r,hasUpdate:x,isObsolete:f,pkgName:T,iconUrl:l,isNsfw:j,repo:C},handleUpdate:d,showSourceRepo:h}=s,[p,O]=i.useState(ce(r,f,x)),D=a==="all"?n("extension.language.all"):a.toUpperCase(),I=async b=>{const S=nt[b],P=tt[b];try{switch(O(P),b){case"INSTALL":await E.updateExtension(T,{install:!0,isObsolete:f}).response;break;case"UNINSTALL":await E.updateExtension(T,{uninstall:!0,isObsolete:f}).response;break;case"UPDATE":await E.updateExtension(T,{update:!0,isObsolete:f}).response;break;default:throw new Error('Unexpected ExtensionAction "'.concat(b,'"'))}O(S),d()}catch($){O(ce(r,f,x)),_e(n(rt[b]),"error")}};function H(){switch(p){case"INSTALL":case"UPDATE":case"UNINSTALL":I(p).catch(_());break;case"OBSOLETE":I("UNINSTALL").catch(_());break}}return e.jsx(Y,{children:e.jsxs(Q,{sx:{display:"flex",alignItems:"center",gap:2,p:2,"&:last-child":{paddingBottom:2}},children:[e.jsx(J,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",background:"transparent"},alt:t,children:e.jsx(K,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:t,src:E.getValidImgUrlFor(l)})}),e.jsxs(k,{sx:{display:"flex",flexDirection:"column",flexGrow:1,flexShrink:1,wordBreak:"break-word"},children:[e.jsx(L,{variant:"h5",component:"h2",children:t}),e.jsxs(L,{variant:"caption",display:"block",children:[D," ",c,j&&e.jsx(L,{variant:"caption",display:"inline",color:"red",children:" 18+"})]}),h&&e.jsx(L,{variant:"caption",display:"block",children:C})]}),e.jsx(U,{variant:"outlined",sx:{color:p===g.OBSOLETE?"red":"inherit",flexShrink:0},onClick:()=>H(),children:n(st[p])})]})})}const ue=0,de=1;function ot(s){const n=[],t={[m.OBSOLETE]:[],[m.INSTALLED]:[],[m.UPDATE_PENDING]:[],[N.ALL]:[],[N.OTHER]:[],[N.LOCAL_SOURCE]:[]};s.forEach(r=>{if(t[r.lang]===void 0&&(t[r.lang]=[],r.lang!=="all"&&n.push(r.lang)),r.isInstalled){if(r.hasUpdate){t[m.UPDATE_PENDING].push(r);return}if(r.isObsolete){t[m.OBSOLETE].push(r);return}t[m.INSTALLED].push(r)}else t[r.lang].push(r)}),n.sort(X);const a=[[m.OBSOLETE,t[m.OBSOLETE]],[m.UPDATE_PENDING,t[m.UPDATE_PENDING]],[m.INSTALLED,t[m.INSTALLED]],[N.ALL,t[N.ALL]],[N.OTHER,t[N.OTHER]],[N.LOCAL_SOURCE,t[N.LOCAL_SOURCE]]],c=n.map(r=>[r,t[r]]);return{allLangs:n,groupedExtensions:a.concat(c)}}function it({tabsMenuHeight:s}){var oe,ie;const{t:n}=y(),{setAction:t}=i.useContext(V),{data:a,loading:c,error:r,refetch:x}=E.useGetServerSettings({notifyOnNetworkStatusChange:!0}),f=!!(a!=null&&a.settings.extensionRepos.length),T=((oe=a==null?void 0:a.settings.extensionRepos.length)!=null?oe:0)>1,l=i.useRef(null),[j,C]=M("shownExtensionLangs",ke()),[d]=M("showNsfw",!0),[h]=Ge("query",Me),[p,O]=i.useState({}),[D,{data:I,loading:H,error:b}]=E.useExtensionListFetch(),S=(ie=I==null?void 0:I.fetchExtensions)==null?void 0:ie.extensions,P=i.useCallback(()=>O({}),[]);i.useEffect(()=>{D()},[p]);const $=i.useMemo(()=>(S!=null?S:[]).filter(o=>{const u=d||!o.isNsfw;return h?u&&o.name.toLowerCase().includes(h.toLowerCase()):u}),[S,d,h]),{allLangs:ee,groupedExtensions:te}=i.useMemo(()=>ot($),[$]),w=i.useMemo(()=>te.filter(o=>o[de].length>0).filter(o=>De(o[ue])||j.includes(o[ue])),[j,te]),Se=i.useMemo(()=>w.map(o=>o[de].length),[w]),Ne=i.useMemo(()=>w.map(([,o])=>o).flat(1),[w]),[ne,R]=ye(i.useState([])),se=o=>{o.name.toLowerCase().endsWith("apk")?(l.current&&(l.current.value=""),R(n("extension.label.installing_file"),"info"),E.installExternalExtension(o).response.then(()=>{P(),R(n("extension.label.installed_successfully"),"success")}).catch(()=>R(n("extension.label.installation_failed"),"error"))):R(n("global.error.label.invalid_file_type"),"error")};i.useEffect(()=>(t(e.jsxs(e.Fragment,{children:[e.jsx(Be,{}),e.jsx(xe,{title:n("extension.action.label.install_external"),children:e.jsx(he,{onClick:()=>{var o;return(o=l.current)==null?void 0:o.click()},size:"large",children:e.jsx(Re,{})})}),e.jsx(fe,{shownLangs:j,setShownLangs:C,allLangs:ee})]})),()=>{t(null)}),[n,j,ee]),i.useEffect(()=>{const o=async A=>{A.preventDefault();const be=await Pe(A);se(be[0])},u=A=>{A.preventDefault()};return document.addEventListener("drop",o),document.addEventListener("dragover",u),()=>{document.removeEventListener("drop",o),document.removeEventListener("dragover",u)}},[]);const re=i.useMemo(()=>e.jsx("input",{type:"file",style:{display:"none"},ref:l,onChange:o=>{var A;const u=(A=o.target.files)==null?void 0:A[0];u&&se(u)}}),[]),je=c||H,ae=r!=null?r:b;return je?e.jsx(z,{}):ae?e.jsx(B,{message:n("global.error.label.failed_to_load_data"),messageExtra:ae.message,retry:()=>{r&&x().catch(_()),b&&D().catch(_())}}):!(S!=null&&S.length)&&!f?e.jsxs(e.Fragment,{children:[ne,re,e.jsxs(Ce,{sx:{paddingTop:"20px"},alignItems:"center",justifyContent:"center",rowGap:"10px",children:[e.jsx(L,{children:n("extension.label.add_repository_info")}),e.jsx(U,{component:v,variant:"contained",to:"/settings/browseSettings",children:n("settings.title")})]})]}):e.jsxs(e.Fragment,{children:[ne,re,e.jsx(Fe,{heightToSubtract:s,overscan:window.innerHeight*.5,groupCounts:Se,groupContent:o=>{const[u]=w[o];return e.jsx(He,{variant:"h4",isFirstItem:o===0,children:F(u)},u)},itemContent:o=>{const u=Ne[o];return e.jsx(ge,{children:e.jsx(at,{extension:u,handleUpdate:P,showSourceRepo:T})},"".concat(u.pkgName,"_").concat(u.isInstalled,"_").concat(u.isObsolete,"_").concat(u.hasUpdate))}})]})}const lt=({id:s,name:n,lang:t,iconUrl:a,mangaCount:c})=>e.jsx(Y,{children:e.jsx(me,{component:v,to:"/migrate/source/".concat(s,"/"),children:e.jsxs(Q,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",p:2},children:[e.jsxs(k,{sx:{display:"flex"},children:[e.jsx(J,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",mr:2,background:"transparent"},children:e.jsx(K,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:n,src:E.getValidImgUrlFor(a)})}),e.jsxs(k,{sx:{display:"flex",flexDirection:"column"},children:[e.jsx(L,{variant:"h5",component:"h2",children:n}),e.jsx(L,{variant:"caption",display:"block",children:F(t)})]})]}),e.jsx(We,{sx:{borderRadius:"5px"},size:"small",label:c})]})})}),ct=s=>{if(!s)return{};const n={};return s.forEach(({sourceId:t,source:a})=>{var r;const c=(r=n[t])!=null?r:{id:t,name:t,lang:"unknown",iconUrl:null,mangaCount:0,...a};n[t]={...c,mangaCount:c.mangaCount+1}}),n},ut=()=>{const{t:s}=y(),{data:n,loading:t,error:a,refetch:c}=E.useGetMigratableSources({notifyOnNetworkStatusChange:!0}),r=i.useMemo(()=>ct(n==null?void 0:n.mangas.nodes),[n==null?void 0:n.mangas.nodes]);return t?e.jsx(z,{}):a?e.jsx(B,{message:s("global.error.label.failed_to_load_data"),messageExtra:a.message,retry:()=>c().catch(_())}):e.jsx(Oe,{children:Object.values(r).map(x=>e.jsx(ge,{children:e.jsx(lt,{...x})},x.id))})};function an(){const{t:s}=y(),{setTitle:n}=i.useContext(V),t=i.useRef(null),[a,c]=i.useState(0);we(t,i.useCallback(()=>c(t.current.offsetHeight),[t.current]));const[r,x]=i.useState(0);return i.useEffect(()=>{n(s("global.label.browse"))},[s]),e.jsxs($e,{children:[e.jsxs(qe,{ref:t,variant:"fullWidth",value:r,tabsCount:2,onChange:(f,T)=>x(T),children:[e.jsx(q,{sx:{textTransform:"none"},label:s("source.title_one")}),e.jsx(q,{sx:{textTransform:"none"},label:s("extension.title_other")}),e.jsx(q,{sx:{textTransform:"none"},label:s("migrate.title")})]}),e.jsx(W,{index:0,currentIndex:r,children:e.jsx(et,{})}),e.jsx(W,{index:1,currentIndex:r,children:e.jsx(it,{tabsMenuHeight:a})}),e.jsx(W,{index:2,currentIndex:r,children:e.jsx(ut,{})})]})}export{an as Browse};
