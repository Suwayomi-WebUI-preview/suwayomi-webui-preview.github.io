import{c as k,j as e,u as H,r as n,f,N as V,i as m,I as u,H as x,k as B,E as P,l as g,m as z,B as v,V as O,C as N,a as F,L as K,A as G,b as J,d as W,T as R,J as $,K as U,R as X,O as Y,n as b}from"./index-CAaFayaL.js";import{D as Z,S as ee,P as te,a as oe}from"./StrictModeDroppable-COuYELiY.js";import{P as re}from"./PlayArrow-BCAI9cYw.js";const ae=k(e.jsx("path",{d:"M6 19h4V5H6zm8-14v14h4V5z"}),"Pause"),se=k(e.jsx("path",{d:"M15 16h4v2h-4zm0-8h7v2h-7zm0 4h6v2h-6zM3 18c0 1.1.9 2 2 2h6c1.1 0 2-.9 2-2V8H3zM14 5h-3l-1-1H6L5 5H2v2h12z"}),"DeleteSweep"),ne=({children:o,...a})=>e.jsx(v,{...a,style:{height:a["data-known-size"]||void 0},children:o}),_=({provided:o,item:a,handleDelete:w,handleRetry:d})=>{const{t:p}=H();return e.jsx(v,{...o.draggableProps,...o.dragHandleProps,ref:o.innerRef,sx:{p:1,pb:0},children:e.jsx(N,{children:e.jsx(F,{component:K,to:G.manga.path(a.manga.id),children:e.jsxs(J,{sx:{display:"flex",alignItems:"center",p:1.5},children:[e.jsx(u,{sx:{pointerEvents:"none"},children:e.jsx(oe,{})}),e.jsxs(W,{sx:{flex:1,ml:1},direction:"column",children:[e.jsx(R,{variant:"h6",component:"h3",children:a.manga.title}),e.jsx(R,{variant:"caption",sx:{display:"block"},children:a.chapter.name})]}),e.jsx($,{download:a}),a.state===U.Error&&e.jsx(m,{title:p("global.button.retry"),children:e.jsx(u,{onClick:l=>{l.preventDefault(),l.stopPropagation(),d(a.chapter)},size:"large",children:e.jsx(X,{})})}),e.jsx(m,{title:p("chapter.action.download.delete.label.action"),children:e.jsx(u,{onClick:l=>{l.preventDefault(),l.stopPropagation(),w(a.chapter)},size:"large",children:e.jsx(Y,{})})})]})})})})},ce=()=>{var S,E;const{t:o}=H(),[a,{reset:w}]=n.useReorderChapterInDownloadQueue(),{data:d,loading:p,error:l,refetch:q}=n.useGetDownloadStatus({notifyOnNetworkStatusChange:!0}),i=d==null?void 0:d.downloadStatus,h=(S=i==null?void 0:i.queue)!=null?S:[],c=(E=i==null?void 0:i.state)!=null?E:"STARTED",j=!h.length,{setTitle:D,setAction:y}=f.useContext(V),T=async()=>{try{await n.clearDownloads().response}catch(t){b(o("download.queue.error.label.failed_delete_all"),"error",g(t))}},A=()=>{c===x.Stopped?n.startDownloads():n.stopDownloads()};f.useLayoutEffect(()=>(D(o("download.queue.title")),y(e.jsxs(e.Fragment,{children:[e.jsx(m,{title:o("download.queue.label.delete_all"),children:e.jsx(u,{onClick:T,size:"large",color:"inherit",children:e.jsx(se,{})})}),e.jsx(m,{title:o(c===x.Started?"global.button.start":"global.button.stop"),children:e.jsx(u,{onClick:A,size:"large",disabled:j,color:"inherit",children:c===x.Stopped?e.jsx(re,{}):e.jsx(ae,{})})})]})),()=>{D(""),y(null)}),[o,c,j]),f.useEffect(()=>{const t=r=>{(r.message==="ResizeObserver loop completed with undelivered notifications."||r.message==="ResizeObserver loop limit exceeded")&&r.stopImmediatePropagation()};return window.addEventListener("error",t),()=>window.removeEventListener("error",t)},[]);const L=(t,r,s)=>{r!==s&&a({variables:{input:{chapterId:t[r].chapter.id,to:s}}}).catch(()=>{w()})},M=t=>{t.destination&&L(h,t.source.index,t.destination.index)},C=async t=>{try{await n.addChapterToDownloadQueue(t.id).response}catch(r){b(o("download.queue.error.label.failed_to_remove"),"error",g(r))}},I=async t=>{const r=c===x.Started;try{r&&await n.stopDownloads().response,await Promise.all([n.removeChapterFromDownloadQueue(t.id).response,n.deleteDownloadedChapter(t.id).response])}catch(s){b(o("download.queue.error.label.failed_to_remove"),"error",g(s))}r&&n.startDownloads().response.catch(z())};return p?e.jsx(B,{}):l?e.jsx(P,{message:o("global.error.label.failed_to_load_data"),messageExtra:g(l),retry:()=>q().catch(z())}):j?e.jsx(P,{message:o("download.queue.label.no_downloads")}):e.jsx(Z,{onDragEnd:M,children:e.jsx(ee,{droppableId:"droppable",mode:"virtual",renderClone:(t,r,s)=>e.jsx(_,{provided:t,item:h[s.source.index],handleDelete:I,handleRetry:C}),children:t=>e.jsx(v,{ref:t.innerRef,children:e.jsx(O,{useWindowScroll:!0,overscan:window.innerHeight*.5,data:h,components:{Item:ne},computeItemKey:(r,s)=>s.chapter.id,itemContent:(r,s)=>e.jsx(te,{draggableId:"".concat(s.chapter.id),index:r,children:Q=>e.jsx(_,{provided:Q,item:s,handleDelete:I,handleRetry:C})})})})})})};export{ce as DownloadQueue};
