import{ea as E,eb as S,ec as O,ed as _,ee as x,ef as g,eg as C,eh as L,ei as F,ej as M,r as l,ek as T,A as I,bi as D,dA as P,b5 as B,as as k,m as A,g as Q,d4 as w,dr as v}from"./index-TsR_l2G6.js";import{g as H,e as q}from"./DateHelper-B2USb8im.js";import{a as j}from"./Asserts-DxNwYpSQ.js";function U(u){return E("useFragment",W,S(u.client))(u)}function W(u){var e=S(u.client),t=e.cache,a=u.from,r=O(u,["from"]),o=_.useMemo(function(){return typeof a=="string"?a:a===null?null:t.identify(a)},[t,a]),s=x(function(){return g(g({},r),{from:o})},[r,o]),c=_.useMemo(function(){var m=s.fragment,d=s.fragmentName,b=s.from,f=s.optimistic,p=f===void 0?!0:f;if(b===null)return{result:R({result:{},complete:!1})};var h=e.cache,N=h.diff(g(g({},s),{returnPartialData:!0,id:b,query:h.getFragmentDoc(m,d),optimistic:p}));return{result:R(g(g({},N),{result:e.queryManager.maskFragment({fragment:m,fragmentName:d,data:N.result})}))}},[e,s]),i=_.useCallback(function(){return c.result},[c]);return C(_.useCallback(function(m){var d=0,b=s.from===null?null:e.watchFragment(s).subscribe({next:function(f){L(f,c.result)||(c.result=f,clearTimeout(d),d=setTimeout(m))}});return function(){b==null||b.unsubscribe(),clearTimeout(d)}},[e,s,c]),i,i)}function R(u){var e={data:u.result,complete:!!u.complete};return u.missing&&(e.missing=F(u.missing.map(function(t){return t.missing}))),e}const $={id:-1,name:"",realUrl:"",isBookmarked:!1},z={unread:void 0,downloaded:void 0,bookmarked:void 0,reverse:!0,sortBy:"source",showChapterNumber:!1,excludedScanlators:[]},J={source:"global.sort.label.by_source",chapterNumber:"global.sort.label.by_chapter_number",uploadedAt:"global.sort.label.by_upload_date",fetchedAt:"global.sort.label.by_fetch_date"},X={download:{always:!1,bulkAction:!1,bulkActionCountForce:300},delete:{always:!0,bulkAction:!0},bookmark:{always:!1,bulkAction:!1},unbookmark:{always:!1,bulkAction:!0},mark_as_read:{always:!1,bulkAction:!0},mark_as_unread:{always:!1,bulkAction:!0}},y={download:{action:{single:"chapter.action.download.add.label.action",selected:"chapter.action.download.add.button.selected"},confirmation:"chapter.action.download.add.label.confirmation",success:"chapter.action.download.add.label.success",error:"chapter.action.download.add.label.error"},delete:{action:{single:"chapter.action.download.delete.label.action",selected:"chapter.action.download.delete.button.selected"},confirmation:"chapter.action.download.delete.label.confirmation",success:"chapter.action.download.delete.label.success",error:"chapter.action.download.delete.label.error"},bookmark:{action:{single:"chapter.action.bookmark.add.label.action",selected:"chapter.action.bookmark.add.button.selected"},success:"chapter.action.bookmark.add.label.success",error:"chapter.action.bookmark.add.label.error"},unbookmark:{action:{single:"chapter.action.bookmark.remove.label.action",selected:"chapter.action.bookmark.remove.button.selected"},confirmation:"chapter.action.bookmark.remove.label.confirmation",success:"chapter.action.bookmark.remove.label.success",error:"chapter.action.bookmark.remove.label.error"},mark_as_read:{action:{single:"chapter.action.mark_as_read.add.label.action.current",selected:"chapter.action.mark_as_read.add.button.selected"},confirmation:"chapter.action.mark_as_read.add.label.confirmation",success:"chapter.action.mark_as_read.add.label.success",error:"chapter.action.mark_as_read.add.label.error"},mark_as_unread:{action:{single:"chapter.action.mark_as_read.remove.label.action",selected:"chapter.action.mark_as_read.remove.button.selected"},confirmation:"chapter.action.mark_as_read.remove.label.confirmation",success:"chapter.action.mark_as_read.remove.label.success",error:"chapter.action.mark_as_read.remove.label.error"}};class n{static getIds(e){return e.map(t=>t.id)}static getFromCache(e,t=M,a="CHAPTER_LIST_FIELDS"){return l.graphQLClient.client.cache.readFragment({id:l.graphQLClient.client.cache.identify({__typename:"ChapterType",id:e}),fragment:t,fragmentName:a})}static getDownloadStatusFromCache(e,t=T,a="DOWNLOAD_TYPE_FIELDS"){return l.graphQLClient.client.cache.readFragment({id:l.graphQLClient.client.cache.identify({__typename:"DownloadType",chapter:{__ref:l.graphQLClient.client.cache.identify({__typename:"ChapterType",id:e})}}),fragment:t,fragmentName:a})}static useDownloadStatusFromCache(e,t=T,a="DOWNLOAD_TYPE_FIELDS"){var o;const r=U({from:{__typename:"DownloadType",chapter:{__ref:l.graphQLClient.client.cache.identify({__typename:"ChapterType",id:e})}},fragment:t,fragmentName:a,client:l.graphQLClient.client});return!r.complete||!Object.keys((o=r.data)!=null?o:{}).length?null:r.data}static getReaderUrl(e){return I.reader.path(e.mangaId,e.sourceOrder)}static isDownloading(e){const t=[D.Downloading,D.Queued],a=n.getDownloadStatusFromCache(e);return t.includes(a==null?void 0:a.state)}static isDownloaded({isDownloaded:e}){return e}static getDownloaded(e){return e.filter(n.isDownloaded)}static isDownloadable(e){const t=n.getDownloadStatusFromCache(e.id);return!n.isDownloaded(e)&&(!t||t.state===D.Error)}static getDownloadable(e){return e.filter(this.isDownloadable)}static isDeletable({isBookmarked:e,...t},a=!1){return n.isDownloaded(t)&&(!e||a)}static getDeletable(e,t){return e.filter(a=>n.isDeletable(a,t))}static isBookmarked({isBookmarked:e}){return e}static getBookmarked(e){return e.filter(n.isBookmarked)}static getNonBookmarked(e){return e.filter(t=>!n.isBookmarked(t))}static isRead({isRead:e}){return e}static getRead(e){return e.filter(n.isRead)}static getNonRead(e){return e.filter(t=>!n.isRead(t))}static getMatchingChapterNumberChapters(e,t){return e.map(a=>{const r=t.find(o=>a.chapterNumber===o.chapterNumber);return r?[a,r]:null}).filter(a=>a!==null)}static async download(e,t){return n.executeAction("download",e.length,()=>l.addChaptersToDownloadQueue(e).response,t)}static async delete(e,t){return n.executeAction("delete",e.length,()=>l.deleteDownloadedChapters(e).response,t)}static async markAsRead(e,t=!1,a,r){const{deleteChaptersManuallyMarkedRead:o,deleteChaptersWithBookmark:s,updateProgressManualMarkRead:c}=await P(),i=o&&t?n.getIds(n.getDeletable(e,s)):[];return n.executeAction("mark_as_read",e.length,()=>l.updateChapters(n.getIds(e),{isRead:!0,lastPageRead:0,chapterIdsToDelete:i,trackProgressMangaId:c&&t?a:void 0}).response,r)}static async markAsUnread(e,t){return n.executeAction("mark_as_unread",e.length,()=>l.updateChapters(e,{isRead:!1}).response,t)}static async bookmark(e){return n.executeAction("bookmark",e.length,()=>l.updateChapters(e,{isBookmarked:!0}).response)}static async unBookmark(e){return n.executeAction("unbookmark",e.length,()=>l.updateChapters(e,{isBookmarked:!1}).response)}static async executeAction(e,t,a,r){const{always:o,bulkAction:s,bulkActionCountForce:c}=X[e],i=!r&&(o||s&&t>1)||c&&t>=c,m=y[e].confirmation;try{if(i){j(m);try{await B({title:k("global.label.are_you_sure"),message:k(m,{count:t}),actions:{confirm:{title:k("global.button.ok")}}})}catch(d){return}}await a(),A(k(y[e].success,{count:t}),"success")}catch(d){throw A(k(y[e].error,{count:t}),"error",Q(d)),d}}static async performAction(e,t,{wasManuallyMarkedAsRead:a,trackProgressMangaId:r,chapters:o}){switch(e){case"download":return n.download(t);case"delete":return n.delete(t);case"mark_as_read":return n.markAsRead(o,a,r);case"mark_as_unread":return n.markAsUnread(t);case"bookmark":return n.bookmark(t);case"unbookmark":return n.unBookmark(t);default:throw new Error('Chapters::performAction: unknown action "'.concat(e,'"'))}}static addDuplicates(e,t){const a=Object.groupBy(t,({chapterNumber:r})=>r);return e.map(r=>{var o;return(o=a[r.chapterNumber])!=null?o:[r]}).flat()}static removeDuplicates(e,t){const a=Object.groupBy(t,({chapterNumber:o})=>o),r=Object.values(a).map(o=>{var s,c;return(c=(s=o.find(i=>i.id===e.id))!=null?s:o.findLast(i=>i.scanlator===e.scanlator))!=null?c:o.slice(-1)[0]});return t.map(({id:o})=>r.find(s=>s.id===o)).filter(o=>!!o)}static getNextChapter(e,t,{offset:a=w.NEXT,...r}={}){const o=n.getNextChapters(e,t,{offset:a,...r}),s=a===w.NEXT,c=s?-1:0,i=s?void 0:1;return o.slice(c,i)[0]}static getNextChapters(e,t,{offset:a=w.NEXT,onlyUnread:r=!1,skipDupe:o=!1,skipDupeChapter:s=e}={}){const c=t.findIndex(h=>h.id===e.id),i=a===w.NEXT,m=i?0:c,d=i?c+1:void 0,b=t.slice(m,d),p=(o?n.removeDuplicates(s,b):b).toSpliced(i?-1:0,1);return r?n.getNonRead(p):p}static getReaderResumeMode(e){return e.isRead?v.START:v.LAST_READ}static getReaderOpenChapterLocationState(e,t){return{resumeMode:n.getReaderResumeMode(e),updateInitialChapter:t}}static groupByDate(e,t){return Object.groupBy(e,a=>H(q(Number(a[t]))))}static getMissingCount(e){const t=e.toSorted((a,r)=>a.chapterNumber-r.chapterNumber);return t.reduce((a,r,o)=>a+n.getGap(r,t[o-1]),0)}static getGap(e,t){if(!e||!t||e.chapterNumber===-1||t.chapterNumber===-1)return 0;const a=Math.max(e.chapterNumber,t.chapterNumber),r=Math.min(e.chapterNumber,t.chapterNumber);return Math.max(0,Math.floor(a)-Math.floor(r)-1)}static getScanlators(e){return[...new Set(e.map(t=>t.scanlator).filter(t=>typeof t=="string"))]}}export{n as C,z as D,$ as F,J as a,y as b,X as c};
