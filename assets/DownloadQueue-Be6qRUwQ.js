import{c as z,j as e,u as L,r as n,d as N,g as i,C as j,I as h,F as g,n as C,k as f,l as k,i as W,G as P,B as J,A as X,L as Y,a as Z,T as _,H as $,R as ee}from"./index-YAtlvmGf.js";import{D as te}from"./Delete-CG4c_Wcp.js";import{D as oe,a as re,c as ae,S as se,v as ne,b as le,d as ie,e as de}from"./DndOverlayItem-DRB8rx1s.js";import{P as ce}from"./PlayArrow-DRVnzrY2.js";import{K as pe,M as b}from"./MUI.util-CRrI--AY.js";import{D as ue}from"./DownloadStateIndicator-BlPLoN2a.js";import{E as A}from"./EmptyViewAbsoluteCentered-6ui_Uq2m.js";import{C as he}from"./Card-BU1dYrjx.js";import{C as me}from"./CardActionArea-C9R1S_-n.js";import{C as xe}from"./CardContent-Ci5UNtd0.js";const ge=z(e.jsx("path",{d:"M6 19h4V5H6zm8-14v14h4V5z"})),fe=z(e.jsx("path",{d:"M15 16h4v2h-4zm0-8h7v2h-7zm0 4h6v2h-6zM3 18c0 1.1.9 2 2 2h6c1.1 0 2-.9 2-2V8H3zM14 5h-3l-1-1H6L5 5H2v2h12z"})),q=i.memo(({item:o,handleDelete:w,handleRetry:v})=>{const{t:d}=L();return e.jsx(J,{sx:{p:1,pb:0},children:e.jsx(he,{children:e.jsx(me,{component:Y,to:X.manga.path(o.manga.id),children:e.jsxs(xe,{sx:{display:"flex",alignItems:"center",p:1.5},children:[e.jsx(h,{...b.preventRippleProp(),sx:{pointerEvents:"none"},children:e.jsx(de,{})}),e.jsxs(Z,{sx:{flex:1,ml:1},direction:"column",children:[e.jsx(_,{variant:"h6",component:"h3",children:o.manga.title}),e.jsx(_,{variant:"caption",sx:{display:"block"},children:o.chapter.name})]}),e.jsx(ue,{chapterId:o.chapter.id}),o.state===$.Error&&e.jsx(j,{title:d("global.button.retry"),children:e.jsx(h,{...b.preventRippleProp(),onClick:l=>{l.preventDefault(),l.stopPropagation(),v(o.chapter)},children:e.jsx(ee,{})})}),e.jsx(j,{title:d("chapter.action.download.delete.label.action"),children:e.jsx(h,{...b.preventRippleProp(),onClick:l=>{l.preventDefault(),l.stopPropagation(),w(o.chapter)},children:e.jsx(te,{})})})]})})})})}),Re=()=>{var E,R;const{t:o}=L(),[w,{reset:v}]=n.useReorderChapterInDownloadQueue(),{data:d,loading:l,error:y,refetch:M}=n.useGetDownloadStatus({notifyOnNetworkStatusChange:!0}),c=d==null?void 0:d.downloadStatus,a=(E=c==null?void 0:c.queue)!=null?E:[],p=(R=c==null?void 0:c.state)!=null?R:"STARTED",m=!a.length,{setTitle:S,setAction:I}=N(),T=i.useMemo(()=>a.map(t=>t.chapter),[a]),H=oe.useSensorsForDevice(),[u,x]=i.useState(null),Q=async()=>{try{await n.clearDownloads().response}catch(t){C(o("download.queue.error.label.failed_delete_all"),"error",f(t))}},O=()=>{p===g.Stopped?n.startDownloads():n.stopDownloads()};i.useLayoutEffect(()=>(S(o("download.queue.title")),I(e.jsxs(e.Fragment,{children:[e.jsx(j,{title:o("download.queue.label.delete_all"),children:e.jsx(h,{onClick:Q,color:"inherit",children:e.jsx(fe,{})})}),e.jsx(j,{title:o(p===g.Started?"global.button.start":"global.button.stop"),disabled:m,children:e.jsx(h,{onClick:O,disabled:m,color:"inherit",children:p===g.Stopped?e.jsx(ce,{}):e.jsx(ge,{})})})]})),()=>{S(""),I(null)}),[o,p,m]),i.useEffect(()=>{const t=r=>{(r.message==="ResizeObserver loop completed with undelivered notifications."||r.message==="ResizeObserver loop limit exceeded")&&r.stopImmediatePropagation()};return window.addEventListener("error",t),()=>window.removeEventListener("error",t)},[]);const B=(t,r,s)=>{r!==s&&w({variables:{input:{chapterId:t[r].chapter.id,to:s}}}).catch(()=>{v()})},F=t=>{const{active:r,over:s}=t;if(x(null),!s||r.id===s.id)return;const U=a.findIndex(D=>D.chapter.id===r.id),G=a.findIndex(D=>D.chapter.id===s.id);B(a,U,G)},K=i.useCallback(async t=>{try{await n.addChapterToDownloadQueue(t.id).response}catch(r){C(o("download.queue.error.label.failed_to_remove"),"error",f(r))}},[]),V=i.useCallback(async t=>{const r=p===g.Started;try{r&&await n.stopDownloads().response,await Promise.all([n.removeChapterFromDownloadQueue(t.id).response,n.deleteDownloadedChapter(t.id).response])}catch(s){C(o("download.queue.error.label.failed_to_remove"),"error",f(s))}r&&n.startDownloads().response.catch(k())},[]);return l?e.jsx(W,{}):y?e.jsx(A,{message:o("global.error.label.failed_to_load_data"),messageExtra:f(y),retry:()=>M().catch(k())}):m?e.jsx(A,{message:o("download.queue.label.no_downloads")}):e.jsxs(re,{sensors:H,collisionDetection:ae,onDragStart:t=>{var r;return x((r=a.find(s=>s.chapter.id===t.active.id))!=null?r:null)},onDragEnd:F,onDragCancel:()=>x(null),onDragAbort:()=>x(null),children:[e.jsx(se,{items:T,strategy:ne,children:e.jsx(pe,{useWindowScroll:!0,overscan:window.innerHeight*.5,totalCount:a.length,computeItemKey:t=>a[t].chapter.id,itemContent:t=>e.jsx(le,{id:a[t].chapter.id,isDragging:a[t].chapter.id===(u==null?void 0:u.chapter.id),children:e.jsx(q,{item:a[t],handleDelete:V,handleRetry:K})})})}),e.jsx(ie,{isActive:!!u,children:e.jsx(q,{item:u,handleDelete:P,handleRetry:P})})]})};export{Re as DownloadQueue};
