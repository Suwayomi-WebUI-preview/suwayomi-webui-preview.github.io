import{h as s,j as e,C as S,a as M,aa as T,A as P,L as k,b as A,B as _,bL as v,J as B,u as F,f as H,r as b,E as y,m as O,n as N,T as j,bM as V,l as K}from"./index-N2t7Zd_e.js";import{U as q}from"./UpdateChecker-CWXF-NWg.js";import{V as l,S as J,a as W,b as z}from"./Virtuoso.util-DsbZIQti.js";import{C as D,a as Q,b as X}from"./ChapterDownloadRetryButton-C8DMNF-A.js";import"./Progress-BW_AFZF1.js";import"./Avatar-DpfbwOY0.js";const Y=s.memo(({chapter:t})=>{const{manga:o}=t;return e.jsx(S,{children:e.jsx(M,{component:k,to:P.reader.path(t.manga.id,t.sourceOrder),state:T.getReaderOpenChapterLocationState(t),sx:{color:i=>i.palette.text[t.isRead?"disabled":"primary"]},children:e.jsxs(A,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:1.5},children:[e.jsxs(_,{sx:{display:"flex",flexGrow:1},children:[e.jsx(D,{mangaId:o.id,mangaTitle:o.title,thumbnailUrl:o.thumbnailUrl,thumbnailUrlLastFetched:o.thumbnailUrlLastFetched}),e.jsx(v,{title:o.title,secondaryText:t.name})]}),e.jsx(B,{chapterId:t.id}),e.jsx(Q,{chapterId:t.id}),e.jsx(X,{chapterId:t.id,isDownloaded:t.isDownloaded})]})})})}),re=()=>{var C;const{t}=F(),{setTitle:o,setAction:i}=H(),{data:r,loading:c,error:h,fetchMore:I,refetch:L}=b.useGetRecentlyUpdatedChapters(void 0,{fetchPolicy:"cache-and-network",notifyOnNetworkStatusChange:!0}),g=!!(r!=null&&r.chapters.pageInfo.hasNextPage),U=r==null?void 0:r.chapters.pageInfo.endCursor,n=(C=r==null?void 0:r.chapters.nodes)!=null?C:[],d=s.useMemo(()=>Object.entries(T.groupByDate(n,"fetchedAt")),[n]),x=s.useMemo(()=>d.map(a=>a[l.ITEMS].length),[d]),w=l.useCreateGroupedComputeItemKey(x,s.useCallback(a=>d[a][l.GROUP],[d]),s.useCallback(a=>n[a].id,[n])),u=s.useRef(null),[E,R]=s.useState(0);s.useLayoutEffect(()=>{var a,f;R((f=(a=u.current)==null?void 0:a.clientHeight)!=null?f:0)},[u.current]);const{data:p}=b.useGetLastGlobalUpdateTimestamp({fetchPolicy:"cache-only"}),m=p==null?void 0:p.lastUpdateTimestamp.timestamp;s.useLayoutEffect(()=>(o(t("updates.title")),i(e.jsx(q,{})),()=>{o(""),i(null)}),[t,m]);const G=s.useCallback(()=>{g&&I({variables:{offset:n.length}})},[g,U]);return h?e.jsx(y,{message:t("global.error.label.failed_to_load_data"),messageExtra:O(h),retry:()=>L().catch(N())}):!c&&n.length===0?e.jsx(y,{message:t("updates.error.label.no_updates_available")}):e.jsxs(e.Fragment,{children:[e.jsx(j,{ref:u,sx:{marginLeft:"10px",paddingTop:a=>({[a.breakpoints.up("sm")]:{paddingTop:"6px"}})},children:t("library.settings.global_update.label.last_update",{date:m?V.format(+m):"-"})}),e.jsx(J,{heightToSubtract:E,style:{height:"undefined"},components:{Footer:()=>c?e.jsx(K,{usePadding:!0}):null},overscan:window.innerHeight*.5,endReached:G,groupCounts:x,groupContent:a=>e.jsx(z,{isFirstItem:a===0,children:e.jsx(j,{variant:"h5",component:"h2",children:d[a][l.GROUP]})}),computeItemKey:w,itemContent:a=>e.jsx(W,{children:e.jsx(Y,{chapter:n[a]})})})]})};export{re as Updates};
