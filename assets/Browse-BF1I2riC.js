import{c as ae,j as e,u as L,M as Ue,A as N,L as G,r as f,S as q,T as g,B as D,a as K,b as Re,s as Pe,d as ie,e as l,f as ce,C as U,I as R,g as X,h as C,i as k,k as Ce,m as y,D as Se,l as Be,n as Ge,o as re,p as De,q as Le,t as Fe,v as He,w as ze,x as Ee,y as be,z as Ve,G as We}from"./index-DWz4TNtd.js";import{u as Te,S as we,A as qe}from"./AppbarSearch-I-jhwbd8.js";import{SourceContentType as se}from"./SourceMangas-BWi1UGbB.js";import{t as H,L as ye,g as W,I as Ke,a as Xe,E as _e,b as w,c as $e,d as Qe,e as Ae,f as Ye,h as Ze,i as Je,j as et}from"./LanguageSelect-DJGNTrTp.js";import{M as ve}from"./MUI.util-BHb8I4Fi.js";import{S as O}from"./Sources-CFddsDZp.js";import{L as le}from"./ListCardAvatar-DBmIeoJi.js";import{L as ue}from"./ListCardContent-D0gc0Fug.js";import{C as $}from"./Card-8Hlh2tNY.js";import{C as Ie}from"./CardActionArea-DZr1-Ien.js";import{E as F}from"./EmptyViewAbsoluteCentered-DPrnddnF.js";import{f as tt}from"./file-selector-DlHkLoY8.js";import{A as st}from"./Add-83t_xa_6.js";import{S as de,V as nt,a as ot,b as rt}from"./Virtuoso.util-zkXm-8Xh.js";import{C as at}from"./CardContent-CJ5i7b3K.js";import{T as ne,a as oe}from"./Tabs-CgaLWDU0.js";import{T as it}from"./TabsWrapper-CJBHW_jV.js";import{T as ct}from"./TabsMenu-Dgyz8PyL.js";import{A as lt,a as ut}from"./SortRadioInput-CDwC33C3.js";import{C as dt}from"./Chip-vNVf609j.js";import"./ChaptersDownloadActionMenuItems-B7yKOewR.js";import"./Trackers-D4pSmk7a.js";import"./Avatar-aJufYokf.js";import"./TextField-p1pWQlzT.js";import"./useFormControl-BeXl2Zas.js";import"./formControlState-Dq1zat_P.js";import"./InputAdornment-D2Hu2W11.js";import"./CheckCircle-V9AVHnfh.js";import"./Link-CkgbKDy3.js";import"./useManageMangaLibraryState-SIk1Scuh.js";import"./ThreeStateCheckboxInput-bOClE9Pj.js";import"./Checkbox-BBcQZP1l.js";import"./SwitchBase-DdFM11Au.js";import"./CheckboxInput-DJhQhiao.js";import"./FormGroup-CzBp0i4z.js";import"./ListPreference-O4j_Xj-q.js";import"./NumberSetting-f5eDW7ri.js";import"./Slider-DpJVGl_w.js";import"./useMobilePicker-Din-egOw.js";import"./SelectSetting-Bb9lWjRf.js";import"./Select-DTupB29O.js";import"./Favorite-DO_ID7fD.js";import"./FilterList-dvyjNZLc.js";import"./GridLayouts-prSGoA8C.js";import"./Delete-Da55i9yt.js";import"./ExpandMore-BzZG9s_A.js";import"./useDebounce-CMKJipzi.js";import"./StyledFab-CsCAQaVn.js";import"./BaseMangaGrid-BmzKoi3H.js";import"./MangaGrid-DcHgkAx9.js";import"./Download-BNw0zcIk.js";import"./Sync-DNaSioGT.js";import"./PlayArrow-PCjqY2mO.js";import"./Switch-D7_BGcgb.js";const pt=ae(e.jsx("path",{d:"M19.3 16.9c.4-.7.7-1.5.7-2.4 0-2.5-2-4.5-4.5-4.5S11 12 11 14.5s2 4.5 4.5 4.5c.9 0 1.7-.3 2.4-.7l3.2 3.2 1.4-1.4zm-3.8.1c-1.4 0-2.5-1.1-2.5-2.5s1.1-2.5 2.5-2.5 2.5 1.1 2.5 2.5-1.1 2.5-2.5 2.5M12 20v2C6.48 22 2 17.52 2 12S6.48 2 12 2c4.84 0 8.87 3.44 9.8 8h-2.07c-.64-2.46-2.4-4.47-4.73-5.41V5c0 1.1-.9 2-2 2h-2v2c0 .55-.45 1-1 1H8v2h2v3H9l-4.79-4.79C4.08 10.79 4 11.38 4 12c0 4.41 3.59 8 8 8"})),ht=o=>{const{t:s}=L(),a=Ue.useIsMobileWidth(),{source:u,showSourceRepo:d}=o,{id:t,name:r,lang:n,iconUrl:p,supportsLatest:c,isNsfw:h,extension:{repo:b}}=u,x=O.isLocalSource(u)?s("source.local_source.title"):r;return e.jsx($,{sx:{margin:1,marginTop:0},children:e.jsx(Ie,{component:G,to:N.sources.childRoutes.browse.path(t),state:{contentType:se.POPULAR,clearCache:!0},children:e.jsxs(ue,{children:[e.jsx(le,{iconUrl:f.getValidImgUrlFor(p),alt:x}),e.jsxs(q,{sx:{justifyContent:"center",flexGrow:1,flexShrink:1,wordBreak:"break-word"},children:[e.jsx(g,{variant:"h6",component:"h3",children:x}),e.jsxs(g,{variant:"caption",children:[H(n),h&&e.jsx(g,{variant:"caption",color:"error",children:" 18+"})]}),d&&e.jsx(g,{variant:"caption",children:b})]}),c&&e.jsx(D,{...ve.preventRippleProp(),variant:"outlined",component:G,to:N.sources.childRoutes.browse.path(t),state:{contentType:se.LATEST,clearCache:!0},children:s("global.button.latest")}),!a&&e.jsx(D,{...ve.preventRippleProp(),variant:"outlined",component:G,to:N.sources.childRoutes.browse.path(t),state:{contentType:se.POPULAR,clearCache:!0},children:s("global.button.popular")})]})})})};function xt(){const{t:o}=L(),{setAction:s}=K(),[a,u]=Re("shownSourceLangs",Pe()),{settings:{showNsfw:d}}=ie(),{data:t,loading:r,error:n,refetch:p}=f.useGetSourceList({notifyOnNetworkStatusChange:!0}),c=t==null?void 0:t.sources.nodes,h=l.useMemo(()=>O.filter(c!=null?c:[],{showNsfw:d,languages:a,keepLocalSource:!0}),[c,a]),b=l.useMemo(()=>Object.entries(O.groupByLanguage(h)),[h]),x=l.useMemo(()=>O.getLanguages(c!=null?c:[]),[c]),_=l.useMemo(()=>O.areFromMultipleRepos(h),[h]),P=ce();return l.useLayoutEffect(()=>(s(e.jsxs(e.Fragment,{children:[e.jsx(U,{title:o("search.title.global_search"),children:e.jsx(R,{onClick:()=>P(N.sources.childRoutes.searchAll.path),color:"inherit",children:e.jsx(pt,{})})}),e.jsx(ye,{selectedLanguages:a,setSelectedLanguages:u,languages:x})]})),()=>{s(null)}),[o,a,x]),r?e.jsx(X,{}):n?e.jsx(F,{message:o("global.error.label.failed_to_load_data"),messageExtra:C(n),retry:()=>p().catch(k())}):(c==null?void 0:c.length)===0?e.jsx(F,{message:o("source.error.label.no_sources_found")}):e.jsx(e.Fragment,{children:b.map(([S,T])=>e.jsxs(l.Fragment,{children:[e.jsx(g,{variant:"h5",component:"h2",sx:{paddingLeft:3,paddingTop:1,paddingBottom:2,fontWeight:"bold"},children:H(S)},S),T.map(E=>e.jsx(ht,{source:E,showSourceRepo:_},E.id))]},S))})}function mt(o){const{t:s}=L(),{extension:{name:a,lang:u,versionName:d,isInstalled:t,hasUpdate:r,isObsolete:n,pkgName:p,iconUrl:c,isNsfw:h,repo:b},handleUpdate:x,showOptions:_,showSourceRepo:P,forcedState:S}=o,[T,E]=l.useState(W(t,n,r)),M=S!=null?S:T;l.useEffect(()=>{E(W(t,n,r))},[W(t,n,r)]);const z=u==="all"?s("extension.language.all"):u.toUpperCase(),B=async A=>{const Y=Qe[A],Z=$e[A];try{switch(E(Z),A){case w.INSTALL:await f.updateExtension(p,{install:!0,isObsolete:n}).response;break;case w.UNINSTALL:await f.updateExtension(p,{uninstall:!0,isObsolete:n}).response;break;case w.UPDATE:await f.updateExtension(p,{update:!0,isObsolete:n}).response;break;default:throw new Error('Unexpected ExtensionAction "'.concat(A,'"'))}E(Y),x()}catch(V){E(W(t,n,r)),y(s(Ae[A],{count:1}),"error",C(V))}};function Q(){switch(M){case w.INSTALL:case w.UPDATE:case w.UNINSTALL:B(M).catch(k());break;case _e.OBSOLETE:B(w.UNINSTALL).catch(k());break}}return e.jsx($,{children:e.jsxs(ue,{children:[e.jsx(le,{iconUrl:f.getValidImgUrlFor(c),alt:a}),e.jsxs(q,{sx:{justifyContent:"center",flexGrow:1,flexShrink:1,wordBreak:"break-word"},children:[e.jsx(g,{variant:"h6",component:"h3",children:a}),e.jsxs(g,{variant:"caption",children:[z," ",d,h&&e.jsx(g,{variant:"caption",color:"error",children:" 18+"})]}),P&&e.jsx(g,{variant:"caption",children:b})]}),t&&e.jsx(U,{title:s("settings.title"),children:e.jsx(R,{onClick:_,color:"inherit",children:e.jsx(Ce,{})})}),e.jsx(D,{variant:"outlined",sx:{color:M===Xe.OBSOLETE?"red":"inherit",flexShrink:0},onClick:()=>Q(),children:s(Ke[M])})]})})}function gt({extensionId:o,closeDialog:s}){const{t:a}=L(),u=ce(),{data:d,loading:t,error:r,refetch:n}=f.useGetSourceList({notifyOnNetworkStatusChange:!0});if(r)return e.jsx(Se,{open:!!o,onClose:s});const p=l.useMemo(()=>o?d==null?void 0:d.sources.nodes.filter(c=>c.extension.pkgName===o):[],[d==null?void 0:d.sources.nodes,o]);return e.jsxs(Se,{open:!!o,onClose:s,maxWidth:"md",fullWidth:!0,children:[e.jsx(Be,{children:a("extension.settings.dialog.title")}),e.jsxs(Ge,{children:[t&&e.jsx(X,{}),r&&e.jsx(F,{message:a("global.error.label.failed_to_load_data"),messageExtra:C(r),retry:()=>n().catch(k())}),!t&&!r&&e.jsx(re,{children:p==null?void 0:p.map(c=>e.jsx(de,{sx:{px:0},children:e.jsx($,{children:e.jsxs(at,{sx:{display:"flex",alignItems:"center",gap:1,p:1.5,"&:last-child":{paddingBottom:1.5}},children:[e.jsx(g,{variant:"h6",component:"h3",sx:{flexGrow:1},children:H(O.getLanguage(c))}),c.isConfigurable&&e.jsx(U,{title:a("settings.title"),children:e.jsx(R,{onClick:()=>u(N.sources.childRoutes.configure.path(c.id)),color:"inherit",children:e.jsx(Ce,{})})})]})})},c.id))})]})]})}const ft=0,jt=1,St=({groupName:o,isFirstItem:s,groupExtensionIds:a,isUpdateGroup:u,updatingExtensionIds:d,setUpdatingExtensionIds:t,handleExtensionUpdate:r})=>{const{t:n}=L();return e.jsxs(rt,{isFirstItem:s,sx:{flexDirection:"row",justifyContent:"space-between",alignItems:"center",pr:1},children:[e.jsx(g,{variant:"h5",component:"h2",children:H(o)}),u&&e.jsx(D,{disabled:!!d.length,variant:"contained",onClick:()=>{t(a),f.updateExtensions(a,{update:!0}).response.then(()=>r()).catch(p=>y(n(Ae[w.UPDATE],{count:a.length}),"error",C(p))).finally(()=>t([]))},children:n("extension.action.label.update_all")})]},o)};function Et({tabsMenuHeight:o}){var fe,je;const{t:s}=L(),{setAction:a}=K(),u=ce(),{pathname:d,search:t,state:r}=De(),n=r==null?void 0:r.selectedExtensionPkg,{data:p,loading:c,error:h,refetch:b}=f.useGetServerSettings({notifyOnNetworkStatusChange:!0}),[x,{data:_,loading:P,error:S}]=f.useExtensionListFetch(),{settings:{extensionLanguages:T,showNsfw:E}}=ie(),M=Le(i=>y(s("global.error.label.failed_to_save_changes"),"error",C(i))),[z]=Te("query",we),[B,Q]=l.useState([]),[A,Y]=l.useState({}),Z=c||P,V=h!=null?h:S,Ne=!!(p!=null&&p.settings.extensionRepos.length),ke=((fe=p==null?void 0:p.settings.extensionRepos.length)!=null?fe:0)>1,j=(je=_==null?void 0:_.fetchExtensions)==null?void 0:je.extensions,pe=l.useMemo(()=>Ye(j!=null?j:[]),[j]),he=l.useMemo(()=>Ze(j!=null?j:[],{selectedLanguages:T,showNsfw:E,query:z}),[j,T,E,z]),I=l.useMemo(()=>Je(he),[he]),xe=l.useMemo(()=>I.map(i=>i[jt].length),[I]),J=l.useMemo(()=>I.map(([,i])=>i).flat(1),[I]),Me=nt.useCreateGroupedComputeItemKey(xe,l.useCallback(i=>I[i][ft],[I]),l.useCallback(i=>J[i].pkgName,[J])),ee=l.useCallback(()=>Y({}),[]),me=i=>{u(d+t,{replace:!0,state:{selectedExtensionPkg:i}})},ge=i=>{if(!i.name.toLowerCase().endsWith("apk")){y(s("global.error.label.invalid_file_type"),"error");return}y(s("extension.label.installing_file"),"info"),f.installExternalExtension(i).response.then(()=>{ee(),y(s("extension.label.installed_successfully"),"success")}).catch(m=>y(s("extension.label.installation_failed"),"error",C(m)))};return l.useEffect(()=>{x()},[A]),l.useLayoutEffect(()=>(a(e.jsxs(e.Fragment,{children:[e.jsx(qe,{}),e.jsx(U,{title:s("extension.action.label.install_external"),children:e.jsx(R,{onClick:()=>{const i=document.createElement("input");i.style.display="none",i.type="file",i.onchange=()=>{var v;const m=(v=i.files)==null?void 0:v[0];m&&ge(m)},document.documentElement.appendChild(i),i.click(),document.documentElement.removeChild(i)},color:"inherit",children:e.jsx(st,{})})}),e.jsx(ye,{selectedLanguages:T,setSelectedLanguages:i=>M("extensionLanguages",i),languages:pe})]})),()=>{a(null)}),[s,T,pe]),l.useEffect(()=>{const i=async v=>{v.preventDefault();const te=await tt(v);ge(te[0])},m=v=>{v.preventDefault()};return document.addEventListener("drop",i),document.addEventListener("dragover",m),()=>{document.removeEventListener("drop",i),document.removeEventListener("dragover",m)}},[]),Z?e.jsx(X,{}):V?e.jsx(F,{message:s("global.error.label.failed_to_load_data"),messageExtra:C(V),retry:()=>{h&&b().catch(k()),S&&x().catch(k())}}):!(j!=null&&j.length)&&!Ne?e.jsxs(q,{sx:{alignItems:"center",justifyContent:"center",rowGap:"10px",paddingTop:"20px"},children:[e.jsx(g,{children:s("extension.label.add_repository_info")}),e.jsx(D,{component:G,variant:"contained",to:N.browse.path,children:s("settings.title")})]}):e.jsxs(e.Fragment,{children:[e.jsx(ot,{heightToSubtract:o,overscan:window.innerHeight*.5,groupCounts:xe,groupContent:i=>{const[m,v]=I[i],te=m===et.UPDATE_PENDING;return e.jsx(St,{groupName:m,isFirstItem:i===0,groupExtensionIds:v.map(Oe=>Oe.pkgName),isUpdateGroup:te,updatingExtensionIds:B,setUpdatingExtensionIds:Q,handleExtensionUpdate:ee})},computeItemKey:Me,itemContent:i=>{const m=J[i];return e.jsx(de,{children:e.jsx(mt,{extension:m,handleUpdate:ee,showSourceRepo:ke,forcedState:B.includes(m.pkgName)?_e.UPDATING:void 0,showOptions:()=>me(m.pkgName)})})}}),e.jsx(gt,{extensionId:n,closeDialog:()=>me(void 0)})]})}const bt=ae(e.jsx("path",{d:"M14.94 4.66h-4.72l2.36-2.36zm-4.69 14.71h4.66l-2.33 2.33zM6.1 6.27 1.6 17.73h1.84l.92-2.45h5.11l.92 2.45h1.84L7.74 6.27zm-1.13 7.37 1.94-5.18 1.94 5.18zm10.76 2.5h6.12v1.59h-8.53v-1.29l5.92-8.56h-5.88v-1.6h8.3v1.26z"})),vt=ae(e.jsx("path",{d:"M20 10V8h-4V4h-2v4h-4V4H8v4H4v2h4v4H4v2h4v4h2v-4h4v4h2v-4h4v-2h-4v-4zm-6 4h-4v-4h4z"})),Ct=({id:o,name:s,lang:a,iconUrl:u,mangaCount:d})=>{const{t}=L(),n=Number(o)===0?t("source.local_source.title"):s;return e.jsx($,{children:e.jsx(Ie,{component:G,to:N.migrate.path(o),children:e.jsxs(ue,{sx:{justifyContent:"space-between"},children:[e.jsxs(re,{sx:{display:"flex",gap:1},children:[e.jsx(le,{iconUrl:f.getValidImgUrlFor(u),alt:n}),e.jsxs(re,{sx:{display:"flex",flexDirection:"column",justifyContent:"center"},children:[e.jsx(g,{variant:"h6",component:"h3",children:n}),e.jsx(g,{variant:"caption",sx:{display:"block"},children:H(a)})]})]}),e.jsx(dt,{sx:{borderRadius:1},size:"small",label:d})]})})})},Lt=(o,{sortBy:s,sortOrder:a})=>{if(!o)return[];const u={};o.forEach(({sourceId:t,source:r})=>{var p;const n=(p=u[t])!=null?p:{id:t,name:t,lang:"unknown",iconUrl:null,mangaCount:0,...r};u[t]={...n,mangaCount:n.mangaCount+1}});const d=Object.values(u).toSorted((t,r)=>{switch(s){case Ee.SOURCE_NAME:return t.name.localeCompare(r.name);case Ee.MANGA_COUNT:return t.mangaCount-r.mangaCount;default:throw new Error('Unexpected "sortBy" "'.concat(s,'"'))}});switch(a){case be.ASC:return d;case be.DESC:return d.toReversed();default:throw new Error('Unexpected "sortOrder" "'.concat(a,'"'))}},Tt=({tabsMenuHeight:o})=>{const{t:s}=L(),{appBarHeight:a}=K(),{settings:{migrateSortSettings:u}}=ie(),d=Le(x=>y(s("global.error.label.failed_to_save_changes"),"error",C(x))),{sortBy:t,sortOrder:r}=u,{data:n,loading:p,error:c,refetch:h}=f.useGetMigratableSources({notifyOnNetworkStatusChange:!0}),b=l.useMemo(()=>Lt(n==null?void 0:n.mangas.nodes,u),[n==null?void 0:n.mangas.nodes,u]);return p?e.jsx(X,{}):c?e.jsx(F,{message:s("global.error.label.failed_to_load_data"),messageExtra:C(c),retry:()=>h().catch(k())}):e.jsxs(e.Fragment,{children:[e.jsxs(q,{sx:{position:"sticky",top:"".concat(a+o,"px"),flexDirection:"row",justifyContent:"end",alignItems:"center",gap:1,p:1,backgroundColor:"background.default",zIndex:1},children:[e.jsx(U,{title:s(Fe[t]),children:e.jsx(R,{color:"inherit",onClick:()=>d("migrateSortSettings",{sortBy:(t+1)%2,sortOrder:r}),children:t?e.jsx(vt,{}):e.jsx(bt,{})})}),e.jsx(U,{title:s(He[r]),children:e.jsx(R,{color:"inherit",onClick:()=>d("migrateSortSettings",{sortBy:t,sortOrder:(r+1)%2}),children:r?e.jsx(lt,{}):e.jsx(ut,{})})})]}),e.jsx(ze,{sx:{p:0},children:b.map(x=>e.jsx(de,{children:e.jsx(Ct,{...x})},x.id))})]})};function ys(){const{t:o}=L(),{setTitle:s}=K();l.useLayoutEffect(()=>{s(o("global.label.browse"))},[o]);const a=l.useRef(null),[u,d]=l.useState(0);Ve(a,l.useCallback(()=>d(a.current.offsetHeight),[a.current]));const[t,r]=Te("tab",we,{}),n=t!=null?t:"source";return t||r(n,"replaceIn"),e.jsxs(it,{children:[e.jsxs(ct,{ref:a,sx:{zIndex:We},variant:"fullWidth",value:n,onChange:(p,c)=>r(c,"replaceIn"),children:[e.jsx(ne,{value:"source",sx:{textTransform:"none"},label:o("source.title_one")}),e.jsx(ne,{value:"extensions",sx:{textTransform:"none"},label:o("extension.title_other")}),e.jsx(ne,{value:"migrate",sx:{textTransform:"none"},label:o("migrate.title")})]}),e.jsx(oe,{index:"source",currentIndex:n,children:e.jsx(xt,{})}),e.jsx(oe,{index:"extensions",currentIndex:n,children:e.jsx(Et,{tabsMenuHeight:u})}),e.jsx(oe,{index:"migrate",currentIndex:n,children:e.jsx(Tt,{tabsMenuHeight:u})})]})}export{ys as Browse};
