import{h as r,aa as G,u as P,aT as F,j as e,C as H,a as O,A as T,L as k,b as N,B as S,S as V,a7 as K,bL as v,J as q,K as z,k as I,I as R,R as Q,aj as J,r as m,o as E,m as y,f as W,E as L,n as X,T as _,bM as Y,l as Z}from"./index-lurey2IN.js";import{U as $}from"./UpdateChecker-BBeZAhHy.js";import{V as p,S as ee,a as te,b as ae}from"./Virtuoso.util-CkvPQUQU.js";import{A as se}from"./Avatar-cR29cwvm.js";import"./Progress-BPl-uJNk.js";const oe=r.memo(({chapter:t})=>{const{manga:l}=t,n=G.useDownloadStatusFromCache(t.id),{t:s}=P(),c=F(),u=async()=>{try{await m.addChapterToDownloadQueue(t.id).response}catch(o){E(s("download.queue.error.label.failed_to_retry"),"error",y(o))}},h=()=>{m.addChapterToDownloadQueue(t.id).response.catch(o=>E(s("global.error.label.failed_to_save_changes"),"error",y(o)))};return e.jsx(H,{children:e.jsx(O,{component:k,to:T.reader.path(t.manga.id,t.sourceOrder),state:c.state,sx:{color:o=>o.palette.text[t.isRead?"disabled":"primary"]},children:e.jsxs(N,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:1.5},children:[e.jsxs(S,{sx:{display:"flex",flexGrow:1},children:[e.jsx(k,{to:T.manga.path(t.manga.id),style:{textDecoration:"none"},children:e.jsx(se,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",marginRight:1,background:"transparent"},children:e.jsx(V,{imgStyle:{objectFit:"cover",width:"100%",height:"100%",imageRendering:"pixelated"},spinnerStyle:{small:!0},alt:l.title,src:K.getThumbnailUrl(l)})})}),e.jsxs(S,{sx:{display:"flex",flexDirection:"column",justifyContent:"center",flexGrow:1,flexShrink:1,wordBreak:"break-word"},children:[e.jsx(v,{variant:"h6",component:"h3",children:l.title}),e.jsx(v,{variant:"caption",display:"block",lines:1,children:t.name})]})]}),e.jsx(q,{chapterId:t.id}),(n==null?void 0:n.state)===z.Error&&e.jsx(I,{title:s("global.button.retry"),children:e.jsx(R,{onClick:o=>{o.preventDefault(),o.stopPropagation(),u()},size:"large",children:e.jsx(Q,{})})}),n==null&&!t.isDownloaded&&e.jsx(I,{title:s("chapter.action.download.add.label.action"),children:e.jsx(R,{onClick:o=>{o.stopPropagation(),o.preventDefault(),h()},size:"large",children:e.jsx(J,{})})})]})})})}),ce=()=>{var b;const{t}=P(),{setTitle:l,setAction:n}=W(),{data:s,loading:c,error:u,fetchMore:h,refetch:o}=m.useGetRecentlyUpdatedChapters(void 0,{fetchPolicy:"cache-and-network",notifyOnNetworkStatusChange:!0}),j=!!(s!=null&&s.chapters.pageInfo.hasNextPage),M=s==null?void 0:s.chapters.pageInfo.endCursor,i=(b=s==null?void 0:s.chapters.nodes)!=null?b:[],d=r.useMemo(()=>Object.entries(G.groupByDate(i,"fetchedAt")),[i]),C=r.useMemo(()=>d.map(a=>a[p.ITEMS].length),[d]),U=p.useCreateGroupedComputeItemKey(C,r.useCallback(a=>d[a][p.GROUP],[d]),r.useCallback(a=>i[a].id,[i])),g=r.useRef(null),[A,B]=r.useState(0);r.useLayoutEffect(()=>{var a,w;B((w=(a=g.current)==null?void 0:a.clientHeight)!=null?w:0)},[g.current]);const{data:x}=m.useGetLastGlobalUpdateTimestamp({fetchPolicy:"cache-only"}),f=x==null?void 0:x.lastUpdateTimestamp.timestamp;r.useLayoutEffect(()=>(l(t("updates.title")),n(e.jsx($,{})),()=>{l(""),n(null)}),[t,f]);const D=r.useCallback(()=>{j&&h({variables:{offset:i.length}})},[j,M]);return u?e.jsx(L,{message:t("global.error.label.failed_to_load_data"),messageExtra:y(u),retry:()=>o().catch(X())}):!c&&i.length===0?e.jsx(L,{message:t("updates.error.label.no_updates_available")}):e.jsxs(e.Fragment,{children:[e.jsx(_,{ref:g,sx:{marginLeft:"10px",paddingTop:a=>({[a.breakpoints.up("sm")]:{paddingTop:"6px"}})},children:t("library.settings.global_update.label.last_update",{date:f?Y.format(+f):"-"})}),e.jsx(ee,{heightToSubtract:A,style:{height:"undefined"},components:{Footer:()=>c?e.jsx(Z,{usePadding:!0}):null},overscan:window.innerHeight*.5,endReached:D,groupCounts:C,groupContent:a=>e.jsx(ae,{isFirstItem:a===0,children:e.jsx(_,{variant:"h5",component:"h2",children:d[a][p.GROUP]})}),computeItemKey:U,itemContent:a=>e.jsx(te,{children:e.jsx(oe,{chapter:i[a]})})})]})};export{ce as Updates};
