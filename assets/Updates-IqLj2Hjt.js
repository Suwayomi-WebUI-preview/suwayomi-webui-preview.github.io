import{h as n,a8 as U,u as L,aJ as B,j as e,C as H,a as F,L as w,A as T,b as N,B as k,S as V,a6 as q,bA as S,H as z,J,k as v,I,R as K,ag as O,r as p,o as E,m as f,f as Q,E as R,n as W,T as _,bB as X,l as Y,bC as Z,bD as $}from"./index-b9u_iuUy.js";import{U as ee}from"./UpdateChecker-BHZFRlSK.js";import{V as te,S as ae,a as se,b as oe}from"./Virtuoso.util-g8jQJ_vw.js";import{A as re}from"./Avatar-tX7RzUEK.js";import"./Progress-Oy-62F9O.js";const ne=n.memo(({chapter:t})=>{const{manga:r}=t,i=U.useDownloadStatusFromCache(t.id),{t:a}=L(),l=B(),u=async()=>{try{await p.addChapterToDownloadQueue(t.id).response}catch(o){E(a("download.queue.error.label.failed_to_remove"),"error",f(o))}},m=()=>{p.addChapterToDownloadQueue(t.id).response.catch(o=>E(a("global.error.label.failed_to_save_changes"),"error",f(o)))};return e.jsx(H,{children:e.jsx(F,{component:w,to:T.reader.path(t.manga.id,t.sourceOrder),state:l.state,sx:{color:o=>o.palette.text[t.isRead?"disabled":"primary"]},children:e.jsxs(N,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:1.5},children:[e.jsxs(k,{sx:{display:"flex",flexGrow:1},children:[e.jsx(w,{to:T.manga.path(t.manga.id),style:{textDecoration:"none"},children:e.jsx(re,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",marginRight:1,background:"transparent"},children:e.jsx(V,{imgStyle:{objectFit:"cover",width:"100%",height:"100%",imageRendering:"pixelated"},spinnerStyle:{small:!0},alt:r.title,src:q.getThumbnailUrl(r)})})}),e.jsxs(k,{sx:{display:"flex",flexDirection:"column",justifyContent:"center",flexGrow:1,flexShrink:1,wordBreak:"break-word"},children:[e.jsx(S,{variant:"h6",component:"h3",children:r.title}),e.jsx(S,{variant:"caption",display:"block",lines:1,children:t.name})]})]}),e.jsx(z,{chapterId:t.id}),(i==null?void 0:i.state)===J.Error&&e.jsx(v,{title:a("global.button.retry"),children:e.jsx(I,{onClick:o=>{o.preventDefault(),o.stopPropagation(),u()},size:"large",children:e.jsx(K,{})})}),i==null&&!t.isDownloaded&&e.jsx(v,{title:a("chapter.action.download.add.label.action"),children:e.jsx(I,{onClick:o=>{o.stopPropagation(),o.preventDefault(),m()},size:"large",children:e.jsx(O,{})})})]})})})}),ie=t=>{if(!t.length)return[];const r=new Map;return t.forEach(i=>{var l;const a=Z($(Number(i.fetchedAt)));r.set(a,((l=r.get(a))!=null?l:0)+1)}),[...r.entries()]},me=()=>{var C;const{t}=L(),{setTitle:r,setAction:i}=Q(),{data:a,loading:l,error:u,fetchMore:m,refetch:o}=p.useGetRecentlyUpdatedChapters(void 0,{fetchPolicy:"cache-and-network",notifyOnNetworkStatusChange:!0}),b=!!(a!=null&&a.chapters.pageInfo.hasNextPage),A=a==null?void 0:a.chapters.pageInfo.endCursor,d=(C=a==null?void 0:a.chapters.nodes)!=null?C:[],c=n.useMemo(()=>ie(d),[d]),y=n.useMemo(()=>c.map(s=>s[1]),[c]),M=te.useCreateGroupedComputeItemKey(y,n.useCallback(s=>c[s][0],[c]),n.useCallback(s=>d[s].id,[d])),h=n.useRef(null),[D,G]=n.useState(0);n.useLayoutEffect(()=>{var s,j;G((j=(s=h.current)==null?void 0:s.clientHeight)!=null?j:0)},[h.current]);const{data:g}=p.useGetLastGlobalUpdateTimestamp({fetchPolicy:"cache-only"}),x=g==null?void 0:g.lastUpdateTimestamp.timestamp;n.useLayoutEffect(()=>(r(t("updates.title")),i(e.jsx(ee,{})),()=>{r(""),i(null)}),[t,x]);const P=n.useCallback(()=>{b&&m({variables:{offset:d.length}})},[b,A]);return u?e.jsx(R,{message:t("global.error.label.failed_to_load_data"),messageExtra:f(u),retry:()=>o().catch(W())}):!l&&d.length===0?e.jsx(R,{message:t("updates.error.label.no_updates_available")}):e.jsxs(e.Fragment,{children:[e.jsx(_,{ref:h,sx:{marginLeft:"10px",paddingTop:s=>({[s.breakpoints.up("sm")]:{paddingTop:"6px"}})},children:t("library.settings.global_update.label.last_update",{date:x?X.format(+x):"-"})}),e.jsx(ae,{heightToSubtract:D,style:{height:"undefined"},components:{Footer:()=>l?e.jsx(Y,{usePadding:!0}):null},overscan:window.innerHeight*.5,endReached:P,groupCounts:y,groupContent:s=>e.jsx(se,{isFirstItem:s===0,children:e.jsx(_,{variant:"h5",component:"h2",children:c[s][0]})}),computeItemKey:M,itemContent:s=>e.jsx(oe,{children:e.jsx(ne,{chapter:d[s]})})})]})};export{me as Updates};
