import{g as he,Y as xe,j as e,r as Ge,i as qe,ax as T,Z as Ue,T as me,ay as Be,bi as fe,bj as Se,bk as Ne,B as k,aQ as be,aA as je,d as B,f as b,bl as He,bm as M,aX as Ve,u as ve,e as w,af as ze,k as K,I as Ce,ag as Qe,ao as We,ap as Ye,aJ as Je,aK as Ke,aM as Xe,bn as Ze,n as X,Q as et,bo as tt,bp as at,bq as st,br as nt,a2 as Z,N as rt,aB as ot,h as it,aI as pe,s as lt,bs as U,bt as ct,c as P,bu as ut,aq as dt,A as pt,bv as gt,aH as ht,E as xt,bw as mt,m as ge,bx as ft,o as St}from"./index-DU51TenU.js";import{d as bt,u as jt,A as vt,S as Ct}from"./AppbarSearch-DN19FAdO.js";import{b as ye,a as Te,d as yt}from"./ExpandMore-DCNeaXCj.js";import{d as Fe}from"./FilterList-C5_2Ef_u.js";import{G as Tt}from"./GridLayouts-Dl2M7i3Q.js";import{S as Ft,O as Et}from"./SortRadioInput-DbgMadr3.js";import{b as Ee}from"./useManageMangaLibraryState-B6a6Yvuk.js";import{u as _t}from"./useDebounce-Dw2BcUql.js";import{I as Lt}from"./InputAdornment-CFW10Y78.js";import{T as kt}from"./ThreeStateCheckboxInput-DU5aaTj5.js";import{S as Mt}from"./StyledFab-BMHInxb1.js";import{T as It}from"./TextField-DeB6wrZP.js";import{C as At}from"./Chip-BejE5hGD.js";import{B as $t}from"./BaseMangaGrid-C9OY-UH8.js";import{g as wt}from"./MangaGrid-Dve0U7kQ.js";import"./ListPreference-lmqny-zy.js";import"./Trackers-D4pSmk7a.js";import"./Avatar-CpZBWiSm.js";import"./Info-yh-TQoaT.js";import"./CheckCircle-CmWT6i6e.js";import"./Mangas-B0zberX4.js";import"./NumberSetting-CqDEqpp7.js";import"./useMobilePicker-C-kmpNcM.js";import"./SelectSetting-5sRwo4QJ.js";import"./Sync-BpiBGZ__.js";import"./PlayArrow-DAK-k5tf.js";function Pt(){const[t,s]=he("source-grid-layout",xe.Compact);return e.jsx(Tt,{gridLayout:t,onChange:s})}var ee={},Ot=qe;Object.defineProperty(ee,"__esModule",{value:!0});var _e=ee.default=void 0,Rt=Ot(Ge()),Dt=e;_e=ee.default=(0,Rt.default)((0,Dt.jsx)("path",{d:"M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3m3-10H5V5h10z"}),"Save");const Gt=t=>{const{state:s,name:r,position:o,group:a,updateFilterValue:l,update:n}=t,[c,i]=T.useState(s),m=u=>{i(u.target.checked);const g=n.filter(j=>!(o===j.position&&a===j.group));l([...g,{type:"checkBoxState",position:o,state:u.target.checked,group:a}])};return s!==void 0?e.jsx(Ue,{label:r,checked:c,onChange:m}):null},qt=({name:t})=>e.jsx(me,{sx:{mt:2},variant:"subtitle2",children:t},t);function Ut(t,s,r,o,a,l,n){const[c,i]=T.useState(r);if(t){const m=g=>{const j=t.indexOf("".concat(g.target.value));i(j);const d=l.filter(p=>!(o===p.position&&n===p.group));a([...d,{type:"selectState",position:o,state:j,group:n}])},u=t.map(g=>e.jsx(Be,{value:g,children:g},"".concat(s," ").concat(g)));return e.jsxs(fe,{sx:{my:1},variant:"standard",children:[e.jsx(Se,{children:s}),e.jsx(Ne,{name:s,value:t[c],label:s,onChange:m,children:u})]})}return null}const Bt=({values:t,name:s,state:r,position:o,updateFilterValue:a,update:l,group:n})=>Ut(t,s,r,o,a,l,n),Nt=t=>{const{values:s,name:r,state:o,position:a,group:l,updateFilterValue:n,update:c}=t,[i,m]=T.useState(o),[u,g]=T.useState(!1),j=()=>{g(!u)};if(s){const d=p=>{const h=i;h.index===p?h.ascending=!h.ascending:h.ascending=!0,h.index=p,m(h);const C=c.filter(f=>!(a===f.position&&l===f.group));n([...C,{type:"sortState",position:a,state:h,group:l}])};return e.jsxs(k,{sx:{mx:-2},children:[e.jsxs(be,{onClick:j,children:[e.jsx(je,{primary:r}),u?e.jsx(ye,{}):e.jsx(Te,{})]}),e.jsx(Ee,{in:u,children:e.jsx(B,{sx:{mx:4},children:s.map((p,h)=>e.jsx(Ft,{label:p,checked:i.index===h,sortDescending:!i.ascending,onClick:()=>d(h)},"".concat(r," ").concat(p)))})})]})}return null},Ht=t=>{const{state:s,name:r,position:o,group:a,updateFilterValue:l,update:n}=t,[c,i]=T.useState(s||""),m=_t(c,500);return b.useEffect(()=>{const u=n.filter(g=>!(o===g.position&&a===g.group));l([...u,{type:"textState",position:o,state:m,group:a}])},[m]),s!==void 0?e.jsxs(fe,{sx:{my:1},variant:"standard",children:[e.jsx(Se,{children:r}),e.jsx(He,{name:r,value:c,onChange:({target:{value:u}})=>i(u),endAdornment:e.jsx(Lt,{position:"end",children:e.jsx(bt,{})})})]}):null},Vt=t=>{switch(t){case M.Ignore:return 0;case M.Include:return 1;case M.Exclude:return 2;default:throw new Error("Unexpected TriState ".concat(t))}},zt=t=>{switch(t){case 0:return M.Ignore;case 1:return M.Include;case 2:return M.Exclude;default:throw new Error("Unexpected state number ".concat(t))}},Qt=t=>{const{state:s,name:r,position:o,group:a,updateFilterValue:l,update:n}=t,[c,i]=T.useState(Vt(s)),m=u=>{const g=u===void 0?0:u?1:2;i(g);const j=n.filter(d=>!(o===d.position&&a===d.group));l([...j,{type:"triState",position:o,state:zt(g),group:a}])};return s!==void 0?e.jsx(kt,{label:r,checked:[void 0,!0,!1][c],onChange:u=>m(u)}):null},Wt=t=>{const{state:s,name:r,position:o,updateFilterValue:a,update:l}=t,[n,c]=T.useState(!1);return e.jsxs(k,{sx:{mx:-2},children:[e.jsxs(be,{onClick:()=>c(!n),children:[e.jsx(je,{primary:r}),n?e.jsx(ye,{}):e.jsx(Te,{})]}),e.jsx(Ee,{in:n,children:e.jsx(B,{sx:{mx:4},children:e.jsx(Le,{sourceFilter:s,group:o,updateFilterValue:a,update:l})})})]})},Yt=({name:t})=>e.jsx(Ve,{sx:{my:1},textAlign:"center",children:t},t);function Le({sourceFilter:t,group:s,updateFilterValue:r,update:o}){return e.jsx(B,{children:t.map((a,l)=>{var c,i;let n=o.find(m=>m.group===s&&m.position===l);switch(n=n&&n.state,a.type){case"CheckBoxFilter":return e.jsx(Gt,{name:a.name,state:n!=null?n:a.CheckBoxFilterDefault,position:l,group:s,updateFilterValue:r,update:o},"filters ".concat(a.name));case"GroupFilter":return e.jsx(Wt,{name:a.name,state:a.filters,position:l,updateFilterValue:r,update:o},"filters ".concat(a.name));case"HeaderFilter":return e.jsx(qt,{name:a.name},"filters ".concat(a.name));case"SelectFilter":return e.jsx(Bt,{name:a.name,values:a.values,state:n!=null?parseInt(n,10):a.SelectFilterDefault,position:l,group:s,updateFilterValue:r,update:o},"filters ".concat(a.name));case"SeparatorFilter":return e.jsx(Yt,{name:a.name},"filters ".concat(a.name));case"SortFilter":return e.jsx(Nt,{name:a.name,values:a.values,state:n!=null?n:{ascending:(c=a.SortFilterDefault)==null?void 0:c.ascending,index:(i=a.SortFilterDefault)==null?void 0:i.index},position:l,group:s,updateFilterValue:r,update:o},"filters ".concat(a.name));case"TextFilter":return e.jsx(Ht,{name:a.name,state:n!=null?n:a.TextFilterDefault,position:l,group:s,updateFilterValue:r,update:o},"filters ".concat(a.name));case"TriStateFilter":return e.jsx(Qt,{name:a.name,state:n!=null?n:a.TriStateFilterDefault,position:l,group:s,updateFilterValue:r,update:o},"filters ".concat(a.name));default:throw new Error('Unknown source filter "'.concat(a,'"'))}})},"filters ".concat(s))}function Jt({savedSearches:t={},selectSavedSearch:s,updateSavedSearches:r,sourceFilter:o,updateFilterValue:a,resetFilterValue:l,setTriggerUpdate:n,update:c}){const{t:i}=ve(),[m,u]=b.useState(!1),[g,j]=b.useState(""),d=Object.keys(t),p=!!d.length;function h(){l(0),u(!1)}function C(){n(0),u(!1)}return e.jsxs(e.Fragment,{children:[e.jsxs(Mt,{onClick:()=>u(!m),variant:"extended",color:"primary",children:[e.jsx(Fe,{}),i("global.button.filter")]}),e.jsxs(Et,{open:m,onClose:()=>u(!1),children:[e.jsxs(k,{sx:{p:2,pb:p?void 0:0},children:[e.jsxs(k,{sx:{display:"flex",pb:1},children:[e.jsx(w,{onClick:h,children:i("global.button.reset")}),e.jsx(ze,{variant:"dialog",popupId:"source-browse-save-search",children:f=>e.jsxs(e.Fragment,{children:[e.jsx(K,{title:i("source.filter.save_search.label.save"),children:e.jsx(Ce,{sx:{marginLeft:"auto"},...Qe(f),children:e.jsx(_e,{})})}),e.jsxs(We,{...Ye(f),maxWidth:"xs",fullWidth:!0,children:[e.jsx(Je,{children:i("source.filter.save_search.dialog.label.title")}),e.jsx(Ke,{children:e.jsx(It,{sx:{width:"100%"},value:g,onChange:y=>j(y.target.value),slotProps:{htmlInput:{maxLength:50}}})}),e.jsxs(Xe,{children:[e.jsx(w,{onClick:()=>{j(""),f.close()},children:i("global.button.cancel")}),e.jsx(w,{onClick:()=>{r(g,"create"),j(""),f.close()},children:i("global.button.ok")})]})]})]})}),e.jsx(w,{variant:"contained",onClick:C,children:i("global.button.submit")})]}),p&&e.jsxs(e.Fragment,{children:[e.jsx(me,{sx:{pb:1},children:"Saved searches"}),e.jsx(B,{sx:{flexDirection:"row"},children:d.map(f=>e.jsx(At,{label:f,onClick:()=>{u(!1),s(f)},onDelete:()=>{Ze({title:i("global.label.are_you_sure"),message:i("source.filter.save_search.dialog.label.delete",{name:f}),actions:{confirm:{title:i("global.button.delete")}}}).then(()=>r(f,"delete")).catch(X())},deleteIcon:e.jsx(K,{title:i("source.filter.save_search.label.delete"),children:e.jsx(et,{})}),variant:"outlined"}))})]})]}),e.jsx(k,{sx:{pb:2,mx:2},children:e.jsx(Le,{sourceFilter:o,updateFilterValue:a,group:void 0,update:c})})]})]})}const Kt={savedSearches:void 0},ke=t=>({...t,savedSearches:t.savedSearches?JSON.stringify(t.savedSearches):void 0}),Xt=t=>{var s;return{...t,savedSearches:(s=st(t.savedSearches))!=null?s:void 0}},Zt=(t,s)=>Xt(tt("source",{...t,meta:at(t.meta)},ke(Kt),void 0,!0,s)),ea=t=>{const s=Zt(t,b.useEffect);return b.useMemo(()=>s,[t])},ta=async(t,s,r)=>nt(t,[[s,ke({[s]:r})[s]]]),aa=(t,s=X())=>(r,o)=>ta(t,r,o).catch(s),sa={id:"-1"},na=Z("div")(({theme:t})=>({display:"flex",position:"sticky",width:"100%",zIndex:1,padding:t.spacing(1),gap:t.spacing(1),backgroundColor:t.palette.background.default})),J=Z(w)(()=>({})),ra=Z(k)(()=>({minHeight:"100%",position:"relative"}));var oa=(t=>(t[t.POPULAR=0]="POPULAR",t[t.LATEST=1]="LATEST",t[t.SEARCH=2]="SEARCH",t))(oa||{});const ia={0:"manga.error.label.no_mangas_found",1:"manga.error.label.no_mangas_found",2:"manga.error.label.no_matches"},la=t=>{const s={},r=[];return t.forEach(o=>{!!s[o.id]||(s[o.id]=o,r.push(o))}),r},ca=(t,s,r,o,a,l)=>{var d;let n;switch(s){case 0:n=P.useGetSourcePopularMangas(t,a);break;case 1:n=P.useGetSourceLatestMangas(t,a);break;case 2:n=P.useSourceSearch(t,r!=null?r:"",o.map(p=>{const{position:h,state:C,group:f}=p;return f!==void 0?{position:f,groupChange:{position:h,[p.type]:C}}:{position:h,[p.type]:C}}),a);break;default:throw new Error('Unknown ContentType "'.concat(s,'"'))}const c=n[1],i=c.findLastIndex(p=>{var h;return!!((h=p.data)!=null&&h.fetchSourceManga)}),m=c[i],u=c.slice(-1)[0].isLoading;let g=!u;const j=b.useMemo(()=>{let p=[];return c.forEach((h,C)=>{var A,v,O;const f=(O=(v=(A=h.data)==null?void 0:A.fetchSourceManga)==null?void 0:v.mangas)!=null?O:[],y=f.filter(F=>!l||!F.inLibrary),I=la([...p,...y]);g=!u&&c.length===C+1&&!y.length&&!!f.length,p=I}),p},[c,l]);return i===-1?[n[0],{...n[1][n[1].length-1],filteredOutAllItemsOfFetchedPage:g}]:[n[0],{...c[c.length-1],data:{...m.data,fetchSourceManga:{...m.data.fetchSourceManga,hasNextPage:c.length>i+1?!1:!!((d=m.data.fetchSourceManga)!=null&&d.hasNextPage),mangas:j}},filteredOutAllItemsOfFetchedPage:g}]};function Ga(){var oe,ie,le,ce,ue;const{t}=ve(),{setTitle:s,setAction:r,appBarHeight:o}=b.useContext(rt),{sourceId:a}=ot(),l=it(),n=pe(),{key:c,state:i}=n,{contentType:m=0,clearCache:u=!1}=(oe=pe().state)!=null?oe:{},{settings:{hideLibraryEntries:g}}=lt(),[j]=he("source-grid-layout",xe.Compact),[d]=jt("query",Ct),[p,h]=U("source-mangas-".concat(a,"-filters"),[]),[C,f]=U("source-mangas-location-".concat(c,"-").concat(a,"-filters"),p!=null?p:[]),[y,I]=b.useState(C),[te,A]=U("source-mangas-".concat(a,"-content-type"),m),[v,O]=U("source-mangas-location-".concat(c,"-").concat(a,"-content-type"),d?2:te),F=b.useCallback(()=>{ct.session.setItem(wt(n),void 0,!1),window.scrollTo(0,0)},[c]),ae=b.useRef(d),se=b.useRef(()=>{});ae.current!==d&&v===2&&(ae.current=d,se.current(new Error("SourceMangas(".concat(a,"): search string changed"))),F()),b.useEffect(()=>()=>{h(void 0),A(void 0)},[a]);const N=S=>{h(S),f(S),F()},ne=S=>{A(S),O(S)},[H,{data:E,error:R,isLoading:V,size:D,abortRequest:Me,filteredOutAllItemsOfFetchedPage:z}]=ca(a,v,d,C,1,g);se.current=Me;const Q=V||z,W=(le=(ie=E==null?void 0:E.fetchSourceManga)==null?void 0:ie.mangas)!=null?le:[],G=!!((ce=E==null?void 0:E.fetchSourceManga)!=null&&ce.hasNextPage),{data:Y}=P.useGetSource(ut,a),x=Y==null?void 0:Y.source,Ie=(ue=x==null?void 0:x.filters)!=null?ue:[],{savedSearches:_={}}=ea(x!=null?x:sa),re=aa(x!=null?x:{id:"-1"},S=>St(t("global.error.label.failed_to_save_changes"),"error",ge(S))),Ae=b.useCallback(S=>{const{query:L,filters:$}=_[S];$&&(I($),N($)),l({pathname:"",search:L?"query=".concat(L):void 0},{state:{...i,contentType:2}})},[_,i]),$e=b.useCallback((S,L)=>{if(L==="delete"){const de={..._};delete de[S],re("savedSearches",de);return}const $={..._,[S]:{query:d!=null?d:void 0,filters:y}};re("savedSearches",$)},[_,d,y]),we=Q?void 0:t(ia[v]),Pe=a==="0"?e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:[t("source.local_source.label.checkout")," "]}),e.jsx(dt,{href:"https://github.com/Suwayomi/Suwayomi-Server/wiki/Local-Source",target:"_blank",rel:"noreferrer",children:t("source.local_source.label.guide")})]}):void 0,q=b.useCallback((S,L)=>{ne(S),F(),d&&!L&&l({pathname:""},{state:{...i,contentType:S}})},[ne,d,F]);!!d&&v!==2&&q(2,d);const Oe=b.useCallback(()=>{G&&H(D+1)},[D,G,v]),Re=()=>{I([]),N([])};b.useEffect(()=>{z&&G&&!V&&H(D+1)},[z,V]),b.useEffect(()=>{!u||!ft.REVALIDATION.includes(a)||P.clearBrowseCacheFor(a)},[u]),b.useLayoutEffect(()=>{var S;return s((S=x==null?void 0:x.displayName)!=null?S:t("source.title_one")),r(e.jsxs(e.Fragment,{children:[e.jsx(vt,{}),e.jsx(Pt,{}),(x==null?void 0:x.isConfigurable)&&e.jsx(K,{title:t("settings.title"),children:e.jsx(Ce,{onClick:()=>l(pt.sources.childRoutes.configure.path(a)),"aria-label":"display more actions",edge:"end",color:"inherit",size:"large",children:e.jsx(gt,{})})})]})),()=>{s(""),r(null)}},[t,x]);const De=W.length?ht:xt;return e.jsxs(ra,{children:[e.jsxs(na,{sx:{top:"".concat(o,"px")},children:[e.jsx(J,{variant:v===0?"contained":"outlined",startIcon:e.jsx(yt,{}),onClick:()=>q(0),children:t("global.button.popular")}),(x==null?void 0:x.supportsLatest)===void 0||x.supportsLatest?e.jsx(J,{disabled:!(x!=null&&x.supportsLatest),variant:v===1?"contained":"outlined",startIcon:e.jsx(mt,{}),onClick:()=>q(1),children:t("global.button.latest")}):null,e.jsx(J,{variant:v===2?"contained":"outlined",startIcon:e.jsx(Fe,{}),onClick:()=>q(2,d),children:t("global.button.filter")})]}),(Q||!R||!!R&&!!W.length)&&e.jsx($t,{gridWrapperProps:{sx:{px:1,pb:1}},mangas:W,hasNextPage:G,loadMore:Oe,message:we,messageExtra:Pe,isLoading:Q,gridLayout:j,mode:"source",inLibraryIndicator:!0},v),R&&e.jsx(De,{message:t("global.error.label.failed_to_load_data"),messageExtra:ge(R),retry:()=>H(D).catch(X())}),v===2&&e.jsx(Jt,{savedSearches:_,selectSavedSearch:Ae,updateSavedSearches:$e,sourceFilter:Ie,updateFilterValue:I,setTriggerUpdate:()=>{N(y)},resetFilterValue:Re,update:y})]})}export{oa as SourceContentType,Ga as SourceMangas};
