import{d as ce,z as ue,j as e,r as we,i as Ae,a4 as T,T as de,a5 as Re,B as I,aP as pe,a7 as me,S as q,c as x,bd as E,aC as De,u as ge,b as P,P as Ge,f as K,I as he,R as qe,_ as Ne,$ as Be,aJ as Ue,aK as He,aL as ze,h as fe,ba as Ve,b9 as We,be as Je,bf as Ke,F as Q,N as Qe,a8 as Ye,e as Xe,ay as le,l as Ze,bg as G,bh as et,a as O,bi as tt,bj as at,bk as st,bl as rt,m as nt}from"./index-CKBxMd_h.js";import{d as ot,u as it,A as lt,S as ct}from"./AppbarSearch-_0aDxcBv.js";import{b as xe,a as Se,d as ut}from"./ExpandMore-XF74jtek.js";import{d as je}from"./FilterList-B4MB-hNh.js";import{G as dt}from"./GridLayouts-CXaAIugm.js";import{d as pt}from"./Delete-CgmxhIrM.js";import{S as mt,O as gt}from"./SortRadioInput-DyHfYr02.js";import{C as ht}from"./CheckboxInput-OYYQUZ2R.js";import{a as be,I as ve,S as ft,b as xt,T as St}from"./TextField-DKEWl0kG.js";import{C as Ce}from"./Collapse-C7pJTB29.js";import{u as jt}from"./useDebounce-D1FpcHTB.js";import{I as bt}from"./InputAdornment-0ZrWWhgd.js";import{T as vt}from"./ThreeStateCheckboxInput-BsazusKT.js";import{S as Ct}from"./StyledFab-gJcKMs5T.js";import{o as yt}from"./useManageMangaLibraryState-Buii7VAm.js";import{C as Tt}from"./Chip-0iDzqWXn.js";import{B as Ft}from"./BaseMangaGrid-F9ux3pf9.js";import{g as Lt}from"./MangaGrid-C-JrYcku.js";import{L as _t}from"./Link-Md8SMvlM.js";import"./Checkbox-ahfba6_6.js";import"./SwitchBase-CSUbfhgD.js";import"./ListPreference-CM7aD9qg.js";import"./Trackers-D4pSmk7a.js";import"./Card-Cr9utwej.js";import"./CardContent-D5B4KoK-.js";import"./Avatar-COfGnEWj.js";import"./Info-2xKqwcLI.js";import"./CheckCircle-C3BmOyh0.js";import"./SpinnerImage-0JZOfick.js";import"./TypographyMaxLines-CUvaPvl8.js";import"./CardActionArea-BHBGCn9v.js";import"./NumberSetting-Cyy9C5Bb.js";import"./useMobilePicker-D8SH1tv9.js";import"./SelectSetting-r_f7SmmX.js";import"./Select-CummqEgG.js";import"./Mangas-Df_Z9EgA.js";import"./Chapters-C94eQhhe.js";import"./index-DFMF3h4b.js";import"./Sync-Cq_IfjXs.js";import"./PlayArrow-DYZR5rOS.js";function kt(){const[t,s]=ce("source-grid-layout",ue.Compact);return e.jsx(dt,{gridLayout:t,onChange:s})}var Y={},It=Ae;Object.defineProperty(Y,"__esModule",{value:!0});var ye=Y.default=void 0,Et=It(we()),Mt=e;ye=Y.default=(0,Et.default)((0,Mt.jsx)("path",{d:"M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3m3-10H5V5h10z"}),"Save");const $t=t=>{const{state:s,name:n,position:o,group:a,updateFilterValue:c,update:r}=t,[u,i]=T.useState(s),h=d=>{i(d.target.checked);const m=r.filter(S=>!(o===S.position&&a===S.group));c([...m,{type:"checkBoxState",position:o,state:d.target.checked,group:a}])};return s!==void 0?e.jsx(ht,{label:n,checked:u,onChange:h}):null},Pt=({name:t})=>e.jsx(de,{sx:{mt:2},variant:"subtitle2",children:t},t);function Ot(t,s,n,o,a,c,r){const[u,i]=T.useState(n);if(t){const h=m=>{const S=t.indexOf("".concat(m.target.value));i(S);const b=c.filter(g=>!(o===g.position&&r===g.group));a([...b,{type:"selectState",position:o,state:S,group:r}])},d=t.map(m=>e.jsx(Re,{value:m,children:m},"".concat(s," ").concat(m)));return e.jsxs(be,{sx:{my:1},variant:"standard",children:[e.jsx(ve,{children:s}),e.jsx(ft,{name:s,value:t[u],label:s,onChange:h,children:d})]})}return null}const wt=({values:t,name:s,state:n,position:o,updateFilterValue:a,update:c,group:r})=>Ot(t,s,n,o,a,c,r),At=t=>{const{values:s,name:n,state:o,position:a,group:c,updateFilterValue:r,update:u}=t,[i,h]=T.useState(o),[d,m]=T.useState(!1),S=()=>{m(!d)};if(s){const b=g=>{const l=i;l.index===g?l.ascending=!l.ascending:l.ascending=!0,l.index=g,h(l);const v=u.filter(f=>!(a===f.position&&c===f.group));r([...v,{type:"sortState",position:a,state:l,group:c}])};return e.jsxs(I,{sx:{mx:-2},children:[e.jsxs(pe,{onClick:S,children:[e.jsx(me,{primary:n}),d?e.jsx(xe,{}):e.jsx(Se,{})]}),e.jsx(Ce,{in:d,children:e.jsx(q,{sx:{mx:4},children:s.map((g,l)=>e.jsx(mt,{label:g,checked:i.index===l,sortDescending:!i.ascending,onClick:()=>b(l)},"".concat(n," ").concat(g)))})})]})}return null},Rt=t=>{const{state:s,name:n,position:o,group:a,updateFilterValue:c,update:r}=t,[u,i]=T.useState(s||""),h=jt(u,500);return x.useEffect(()=>{const d=r.filter(m=>!(o===m.position&&a===m.group));c([...d,{type:"textState",position:o,state:h,group:a}])},[h]),s!==void 0?e.jsxs(be,{sx:{my:1},variant:"standard",children:[e.jsx(ve,{children:n}),e.jsx(xt,{name:n,value:u,onChange:({target:{value:d}})=>i(d),endAdornment:e.jsx(bt,{position:"end",children:e.jsx(ot,{})})})]}):null},Dt=t=>{switch(t){case E.Ignore:return 0;case E.Include:return 1;case E.Exclude:return 2;default:throw new Error("Unexpected TriState ".concat(t))}},Gt=t=>{switch(t){case 0:return E.Ignore;case 1:return E.Include;case 2:return E.Exclude;default:throw new Error("Unexpected state number ".concat(t))}},qt=t=>{const{state:s,name:n,position:o,group:a,updateFilterValue:c,update:r}=t,[u,i]=T.useState(Dt(s)),h=d=>{const m=d===void 0?0:d?1:2;i(m);const S=r.filter(b=>!(o===b.position&&a===b.group));c([...S,{type:"triState",position:o,state:Gt(m),group:a}])};return s!==void 0?e.jsx(vt,{label:n,checked:[void 0,!0,!1][u],onChange:d=>h(d)}):null},Nt=t=>{const{state:s,name:n,position:o,updateFilterValue:a,update:c}=t,[r,u]=T.useState(!1);return e.jsxs(I,{sx:{mx:-2},children:[e.jsxs(pe,{onClick:()=>u(!r),children:[e.jsx(me,{primary:n}),r?e.jsx(xe,{}):e.jsx(Se,{})]}),e.jsx(Ce,{in:r,children:e.jsx(q,{sx:{mx:4},children:e.jsx(Te,{sourceFilter:s,group:o,updateFilterValue:a,update:c})})})]})},Bt=({name:t})=>e.jsx(De,{sx:{my:1},textAlign:"center",children:t},t);function Te({sourceFilter:t,group:s,updateFilterValue:n,update:o}){return e.jsx(q,{children:t.map((a,c)=>{var u,i;let r=o.find(h=>h.group===s&&h.position===c);switch(r=r&&r.state,a.type){case"CheckBoxFilter":return e.jsx($t,{name:a.name,state:r!=null?r:a.CheckBoxFilterDefault,position:c,group:s,updateFilterValue:n,update:o},"filters ".concat(a.name));case"GroupFilter":return e.jsx(Nt,{name:a.name,state:a.filters,position:c,updateFilterValue:n,update:o},"filters ".concat(a.name));case"HeaderFilter":return e.jsx(Pt,{name:a.name},"filters ".concat(a.name));case"SelectFilter":return e.jsx(wt,{name:a.name,values:a.values,state:r!=null?parseInt(r,10):a.SelectFilterDefault,position:c,group:s,updateFilterValue:n,update:o},"filters ".concat(a.name));case"SeparatorFilter":return e.jsx(Bt,{name:a.name},"filters ".concat(a.name));case"SortFilter":return e.jsx(At,{name:a.name,values:a.values,state:r!=null?r:{ascending:(u=a.SortFilterDefault)==null?void 0:u.ascending,index:(i=a.SortFilterDefault)==null?void 0:i.index},position:c,group:s,updateFilterValue:n,update:o},"filters ".concat(a.name));case"TextFilter":return e.jsx(Rt,{name:a.name,state:r!=null?r:a.TextFilterDefault,position:c,group:s,updateFilterValue:n,update:o},"filters ".concat(a.name));case"TriStateFilter":return e.jsx(qt,{name:a.name,state:r!=null?r:a.TriStateFilterDefault,position:c,group:s,updateFilterValue:n,update:o},"filters ".concat(a.name));default:throw new Error('Unknown source filter "'.concat(a,'"'))}})},"filters ".concat(s))}function Ut({savedSearches:t={},selectSavedSearch:s,updateSavedSearches:n,sourceFilter:o,updateFilterValue:a,resetFilterValue:c,setTriggerUpdate:r,update:u}){const{t:i}=ge(),[h,d]=x.useState(!1),[m,S]=x.useState(""),b=Object.keys(t),g=!!b.length;function l(){c(0),d(!1)}function v(){r(0),d(!1)}return e.jsxs(e.Fragment,{children:[e.jsxs(Ct,{onClick:()=>d(!h),variant:"extended",color:"primary",children:[e.jsx(je,{}),i("global.button.filter")]}),e.jsxs(gt,{open:h,onClose:()=>d(!1),children:[e.jsxs(I,{sx:{p:2,pb:g?void 0:0},children:[e.jsxs(I,{sx:{display:"flex",pb:1},children:[e.jsx(P,{onClick:l,children:i("global.button.reset")}),e.jsx(Ge,{variant:"dialog",popupId:"source-browse-save-search",children:f=>e.jsxs(e.Fragment,{children:[e.jsx(K,{title:i("source.filter.save_search.label.save"),children:e.jsx(he,{sx:{marginLeft:"auto"},...qe(f),children:e.jsx(ye,{})})}),e.jsxs(Ne,{...Be(f),maxWidth:"xs",fullWidth:!0,children:[e.jsx(Ue,{children:i("source.filter.save_search.dialog.label.title")}),e.jsx(He,{children:e.jsx(St,{sx:{width:"100%"},value:m,onChange:y=>S(y.target.value),slotProps:{htmlInput:{maxLength:50}}})}),e.jsxs(ze,{children:[e.jsx(P,{onClick:()=>{S(""),f.close()},children:i("global.button.cancel")}),e.jsx(P,{onClick:()=>{n(m,"create"),S(""),f.close()},children:i("global.button.ok")})]})]})]})}),e.jsx(P,{variant:"contained",onClick:v,children:i("global.button.submit")})]}),g&&e.jsxs(e.Fragment,{children:[e.jsx(de,{sx:{pb:1},children:"Saved searches"}),e.jsx(q,{sx:{flexDirection:"row"},children:b.map(f=>e.jsx(Tt,{label:f,onClick:()=>{d(!1),s(f)},onDelete:()=>{yt({title:i("global.label.are_you_sure"),message:i("source.filter.save_search.dialog.label.delete",{name:f}),actions:{confirm:{title:i("global.button.delete")}}}).then(()=>n(f,"delete")).catch(fe())},deleteIcon:e.jsx(K,{title:i("source.filter.save_search.label.delete"),children:e.jsx(pt,{})}),variant:"outlined"}))})]})]}),e.jsx(I,{sx:{pb:2,mx:2},children:e.jsx(Te,{sourceFilter:o,updateFilterValue:a,group:void 0,update:u})})]})]})}const Ht=t=>({...t,savedSearches:t.savedSearches?JSON.stringify(t.savedSearches):void 0}),zt=t=>{var s;return{...t,savedSearches:(s=Je(t.savedSearches))!=null?s:void 0}},Vt=({meta:t}={},s)=>zt(Ve({meta:We(t)},{savedSearches:void 0},s)),Wt=async(t,s,n)=>Ke(t,[[s,Ht({[s]:n})[s]]]),Jt=(t,s=fe())=>(n,o)=>Wt(t,n,o).catch(s),Kt=Q("div")(({theme:t})=>({display:"flex",position:"sticky",width:"100%",zIndex:1,padding:t.spacing(1),gap:t.spacing(1),backgroundColor:t.palette.background.default})),J=Q(P)(()=>({})),Qt=Q(I)(()=>({minHeight:"100%",position:"relative"}));var Yt=(t=>(t[t.POPULAR=0]="POPULAR",t[t.LATEST=1]="LATEST",t[t.SEARCH=2]="SEARCH",t))(Yt||{});const Xt={0:"manga.error.label.no_mangas_found",1:"manga.error.label.no_mangas_found",2:"manga.error.label.no_matches"},Zt=t=>{const s={},n=[];return t.forEach(o=>{!!s[o.id]||(s[o.id]=o,n.push(o))}),n},ea=(t,s,n,o,a,c)=>{var b;let r;switch(s){case 0:r=O.useGetSourcePopularMangas(t,a);break;case 1:r=O.useGetSourceLatestMangas(t,a);break;case 2:r=O.useSourceSearch(t,n!=null?n:"",o.map(g=>{const{position:l,state:v,group:f}=g;return f!==void 0?{position:f,groupChange:{position:l,[g.type]:v}}:{position:l,[g.type]:v}}),a);break;default:throw new Error('Unknown ContentType "'.concat(s,'"'))}const u=r[1],i=u.findLastIndex(g=>{var l;return!!((l=g.data)!=null&&l.fetchSourceManga)}),h=u[i],d=u.slice(-1)[0].isLoading;let m=!d;const S=x.useMemo(()=>{let g=[];return u.forEach((l,v)=>{var F,w,M;const f=(M=(w=(F=l.data)==null?void 0:F.fetchSourceManga)==null?void 0:w.mangas)!=null?M:[],y=f.filter(C=>!c||!C.inLibrary),N=Zt([...g,...y]);m=!d&&u.length===v+1&&!y.length&&!!f.length,g=N}),g},[u,c]);return i===-1?[r[0],{...r[1][r[1].length-1],filteredOutAllItemsOfFetchedPage:m}]:[r[0],{...u[u.length-1],data:{...h.data,fetchSourceManga:{...h.data.fetchSourceManga,hasNextPage:u.length>i+1?!1:!!((b=h.data.fetchSourceManga)!=null&&b.hasNextPage),mangas:S}},filteredOutAllItemsOfFetchedPage:m}]};function Ua(){var ae,se,re,ne,oe;const{t}=ge(),{setTitle:s,setAction:n,appBarHeight:o}=x.useContext(Qe),{sourceId:a}=Ye(),c=Xe(),r=le(),{key:u,state:i}=r,{contentType:h=0,clearCache:d=!1}=(ae=le().state)!=null?ae:{},[m,S]=x.useState(!0);x.useEffect(()=>{S(!1)},[]);const{settings:{hideLibraryEntries:b}}=Ze(),[g]=ce("source-grid-layout",ue.Compact),[l]=it("query",ct),[v,f]=G("source-mangas-".concat(a,"-filters"),[]),[y,N]=G("source-mangas-location-".concat(u,"-").concat(a,"-filters"),v!=null?v:[]),[B,F]=x.useState(y),[w,M]=G("source-mangas-".concat(a,"-content-type"),h),[C,Fe]=G("source-mangas-location-".concat(u,"-").concat(a,"-content-type"),l?2:w);x.useEffect(()=>()=>{f(void 0),M(void 0)},[a]);const A=x.useCallback(()=>{et.session.setItem(Lt(r),void 0,!1),window.scrollTo(0,0)},[u]),U=j=>{f(j),N(j),A()},X=j=>{M(j),Fe(j)},[Z,{data:L,isLoading:H,size:z,abortRequest:Le,filteredOutAllItemsOfFetchedPage:V}]=ea(a,C,l,y,1,b),ee=H||V,_e=(re=(se=L==null?void 0:L.fetchSourceManga)==null?void 0:se.mangas)!=null?re:[],R=!!((ne=L==null?void 0:L.fetchSourceManga)!=null&&ne.hasNextPage),{data:W}=O.useGetSource(tt,a),p=W==null?void 0:W.source,ke=(oe=p==null?void 0:p.filters)!=null?oe:[],{savedSearches:_={}}=x.useMemo(()=>Vt(p),[p,p==null?void 0:p.meta]),te=Jt(p!=null?p:{id:a},()=>nt(t("global.error.label.failed_to_save_changes"),"error")),Ie=x.useCallback(j=>{const{query:k,filters:$}=_[j];$&&(F($),U($)),c({pathname:"",search:k?"query=".concat(k):void 0},{state:{...i,contentType:2}})},[_,i]),Ee=x.useCallback((j,k)=>{if(k==="delete"){const ie={..._};delete ie[j],te("savedSearches",ie);return}const $={..._,[j]:{query:l!=null?l:void 0,filters:y}};te("savedSearches",$)},[_,l,y]),Me=ee?void 0:t(Xt[C]),$e=a==="0"?e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:[t("source.local_source.label.checkout")," "]}),e.jsx(_t,{href:"https://github.com/Suwayomi/Suwayomi-Server/wiki/Local-Source",target:"_blank",rel:"noreferrer",children:t("source.local_source.label.guide")})]}):void 0,D=x.useCallback((j,k)=>{X(j),A(),l&&!k&&c({pathname:""},{state:{...i,contentType:j}})},[X,l,A]);!!l&&C!==2&&D(2,l);const Pe=x.useCallback(()=>{R&&Z(z+1)},[z,R,C]),Oe=()=>{F([]),U([])};return x.useEffect(()=>{V&&R&&!H&&Z(z+1)},[V,H]),x.useEffect(()=>{!d||!rt.REVALIDATION.includes(a)||O.clearBrowseCacheFor(a)},[d]),x.useEffect(()=>()=>{C!==2||m||(Le(new Error("SourceMangas(".concat(a,"): search string changed"))),A())},[l]),x.useLayoutEffect(()=>{var j;return s((j=p==null?void 0:p.displayName)!=null?j:t("source.title_one")),n(e.jsxs(e.Fragment,{children:[e.jsx(lt,{}),e.jsx(kt,{}),(p==null?void 0:p.isConfigurable)&&e.jsx(K,{title:t("settings.title"),children:e.jsx(he,{onClick:()=>c("/sources/".concat(a,"/configure/")),"aria-label":"display more actions",edge:"end",color:"inherit",size:"large",children:e.jsx(at,{})})})]})),()=>{s(""),n(null)}},[t,p]),e.jsxs(Qt,{children:[e.jsxs(Kt,{sx:{top:"".concat(o,"px")},children:[e.jsx(J,{variant:C===0?"contained":"outlined",startIcon:e.jsx(ut,{}),onClick:()=>D(0),children:t("global.button.popular")}),(p==null?void 0:p.supportsLatest)===void 0||p.supportsLatest?e.jsx(J,{disabled:!(p!=null&&p.supportsLatest),variant:C===1?"contained":"outlined",startIcon:e.jsx(st,{}),onClick:()=>D(1),children:t("global.button.latest")}):null,e.jsx(J,{variant:C===2?"contained":"outlined",startIcon:e.jsx(je,{}),onClick:()=>D(2,l),children:t("global.button.filter")})]}),e.jsx(Ft,{gridWrapperProps:{sx:{px:1,pb:1}},mangas:_e,hasNextPage:R,loadMore:Pe,message:Me,messageExtra:$e,isLoading:ee,gridLayout:g,mode:"source",inLibraryIndicator:!0},C),C===2&&e.jsx(Ut,{savedSearches:_,selectSavedSearch:Ie,updateSavedSearches:Ee,sourceFilter:ke,updateFilterValue:F,setTriggerUpdate:()=>{U(B)},resetFilterValue:Oe,update:B})]})}export{Yt as SourceContentType,Ua as SourceMangas};
