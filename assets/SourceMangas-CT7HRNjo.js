import{o as fe,j as e,r as K,i as Q,R as T,T as ge,U as Ae,B as M,aE as Se,W as ve,S as N,c as g,b0 as E,ap as De,u as je,b as I,P as qe,f as J,I as be,z as Ge,J as Ne,K as Be,aw as Ue,ax as He,ay as ze,h as Ce,aZ as Ve,aY as We,b1 as Ye,b2 as Je,s as X,N as Ke,X as Qe,e as Xe,al as he,q as Ze,b3 as G,b4 as et,a as P,b5 as tt,b6 as at,b7 as st,b8 as nt,m as rt}from"./index-DcjaYI8c.js";import{d as ot,u as it,A as lt,S as ct}from"./AppbarSearch-B8oFCjyO.js";import{d as ut}from"./Favorite-C16DNXIp.js";import{d as ye}from"./FilterList-abhqIMob.js";import{G as dt}from"./GridLayouts-BMUdFB-1.js";import{d as pt}from"./Delete-B0s0JAXe.js";import{S as xt,O as mt}from"./SortRadioInput-BVUyDL6z.js";import{C as ht}from"./CheckboxInput-DOEarRVG.js";import{a as Te,I as _e,M as ft,b as gt,T as St}from"./TextField-P1VnsQdP.js";import{C as Fe}from"./Collapse-B84VMEE9.js";import{u as vt}from"./useDebounce-BagHWvYz.js";import{I as jt}from"./InputAdornment-Bl0wL1zG.js";import{T as bt}from"./ThreeStateCheckboxInput-Bf1rWHh2.js";import{S as Ct}from"./StyledFab-Bqz4D-BH.js";import{o as yt}from"./useManageMangaLibraryState-Dy3_oqWO.js";import{C as Tt}from"./Chip-_2cYwc_k.js";import{B as _t}from"./BaseMangaGrid-VwPw7xXn.js";import{g as Ft}from"./MangaGrid-G-iNYNxE.js";import{L as Lt}from"./Link-C97l5ECR.js";import"./ViewModule-DvIa-DWB.js";import"./Checkbox-CbJD-4sR.js";import"./SwitchBase-DQjqP4cs.js";import"./ListPreference-CCc6K8Qc.js";import"./Trackers-D4pSmk7a.js";import"./index-DDfX7Zj7.js";import"./TypographyMaxLines-1L5NpRNp.js";import"./Avatar-QPsDaqXc.js";import"./Info-CoQv9wZa.js";import"./SpinnerImage-B3MbjRH_.js";import"./NumberSetting-Bst7V28q.js";import"./useMobilePicker-vN4r9D--.js";import"./SelectSetting-Dk2k-gXE.js";import"./Select-Be8eKYzO.js";import"./Mangas-CMSl1BV2.js";import"./Chapters-s0nMzLvZ.js";import"./Sync-BV2q-eN1.js";import"./PlayArrow-eq3rPZO8.js";function Mt(){const{options:{SourcegridLayout:t},setOptions:s}=fe();function o(n){s(a=>({...a,SourcegridLayout:n}))}return e.jsx(dt,{gridLayout:t,onChange:o})}var Z={},Et=Q;Object.defineProperty(Z,"__esModule",{value:!0});var Le=Z.default=void 0,$t=Et(K()),kt=e;Le=Z.default=(0,$t.default)((0,kt.jsx)("path",{d:"M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3m3-10H5V5h10z"}),"Save");const It=t=>{const{state:s,name:o,position:n,group:a,updateFilterValue:u,update:r}=t,[c,l]=T.useState(s),h=d=>{l(d.target.checked);const x=r.filter(S=>!(n===S.position&&a===S.group));u([...x,{type:"checkBoxState",position:n,state:d.target.checked,group:a}])};return s!==void 0?e.jsx(ht,{label:o,checked:c,onChange:h}):null},Pt=({name:t})=>e.jsx(ge,{sx:{mt:2},variant:"subtitle2",children:t},t);function Ot(t,s,o,n,a,u,r){const[c,l]=T.useState(o);if(t){const h=x=>{const S=t.indexOf("".concat(x.target.value));l(S);const j=u.filter(i=>!(n===i.position&&r===i.group));a([...j,{type:"selectState",position:n,state:S,group:r}])},d=t.map(x=>e.jsx(Ae,{value:x,children:x},"".concat(s," ").concat(x)));return e.jsxs(Te,{sx:{my:1},variant:"standard",children:[e.jsx(_e,{children:s}),e.jsx(ft,{name:s,value:t[c],label:s,onChange:h,children:d})]})}return null}const wt=({values:t,name:s,state:o,position:n,updateFilterValue:a,update:u,group:r})=>Ot(t,s,o,n,a,u,r);var ee={},Rt=Q;Object.defineProperty(ee,"__esModule",{value:!0});var te=ee.default=void 0,At=Rt(K()),Dt=e;te=ee.default=(0,At.default)((0,Dt.jsx)("path",{d:"m12 8-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"}),"ExpandLess");var ae={},qt=Q;Object.defineProperty(ae,"__esModule",{value:!0});var se=ae.default=void 0,Gt=qt(K()),Nt=e;se=ae.default=(0,Gt.default)((0,Nt.jsx)("path",{d:"M16.59 8.59 12 13.17 7.41 8.59 6 10l6 6 6-6z"}),"ExpandMore");const Bt=t=>{const{values:s,name:o,state:n,position:a,group:u,updateFilterValue:r,update:c}=t,[l,h]=T.useState(n),[d,x]=T.useState(!1),S=()=>{x(!d)};if(s){const j=i=>{const m=l;m.index===i?m.ascending=!m.ascending:m.ascending=!0,m.index=i,h(m);const C=c.filter(f=>!(a===f.position&&u===f.group));r([...C,{type:"sortState",position:a,state:m,group:u}])};return e.jsxs(M,{sx:{mx:-2},children:[e.jsxs(Se,{onClick:S,children:[e.jsx(ve,{primary:o}),d?e.jsx(te,{}):e.jsx(se,{})]}),e.jsx(Fe,{in:d,children:e.jsx(N,{sx:{mx:4},children:s.map((i,m)=>e.jsx(xt,{label:i,checked:l.index===m,sortDescending:!l.ascending,onClick:()=>j(m)},"".concat(o," ").concat(i)))})})]})}return null},Ut=t=>{const{state:s,name:o,position:n,group:a,updateFilterValue:u,update:r}=t,[c,l]=T.useState(s||""),h=vt(c,500);return g.useEffect(()=>{const d=r.filter(x=>!(n===x.position&&a===x.group));u([...d,{type:"textState",position:n,state:h,group:a}])},[h]),s!==void 0?e.jsxs(Te,{sx:{my:1},variant:"standard",children:[e.jsx(_e,{children:o}),e.jsx(gt,{name:o,value:c,onChange:({target:{value:d}})=>l(d),endAdornment:e.jsx(jt,{position:"end",children:e.jsx(ot,{})})})]}):null},Ht=t=>{switch(t){case E.Ignore:return 0;case E.Include:return 1;case E.Exclude:return 2;default:throw new Error("Unexpected TriState ".concat(t))}},zt=t=>{switch(t){case 0:return E.Ignore;case 1:return E.Include;case 2:return E.Exclude;default:throw new Error("Unexpected state number ".concat(t))}},Vt=t=>{const{state:s,name:o,position:n,group:a,updateFilterValue:u,update:r}=t,[c,l]=T.useState(Ht(s)),h=d=>{const x=d===void 0?0:d?1:2;l(x);const S=r.filter(j=>!(n===j.position&&a===j.group));u([...S,{type:"triState",position:n,state:zt(x),group:a}])};return s!==void 0?e.jsx(bt,{label:o,checked:[void 0,!0,!1][c],onChange:d=>h(d)}):null},Wt=t=>{const{state:s,name:o,position:n,updateFilterValue:a,update:u}=t,[r,c]=T.useState(!1);return e.jsxs(M,{sx:{mx:-2},children:[e.jsxs(Se,{onClick:()=>c(!r),children:[e.jsx(ve,{primary:o}),r?e.jsx(te,{}):e.jsx(se,{})]}),e.jsx(Fe,{in:r,children:e.jsx(N,{sx:{mx:4},children:e.jsx(Me,{sourceFilter:s,group:n,updateFilterValue:a,update:u})})})]})},Yt=({name:t})=>e.jsx(De,{sx:{my:1},textAlign:"center",children:t},t);function Me({sourceFilter:t,group:s,updateFilterValue:o,update:n}){return e.jsx(N,{children:t.map((a,u)=>{var c,l;let r=n.find(h=>h.group===s&&h.position===u);switch(r=r&&r.state,a.type){case"CheckBoxFilter":return e.jsx(It,{name:a.name,state:r!=null?r:a.CheckBoxFilterDefault,position:u,group:s,updateFilterValue:o,update:n},"filters ".concat(a.name));case"GroupFilter":return e.jsx(Wt,{name:a.name,state:a.filters,position:u,updateFilterValue:o,update:n},"filters ".concat(a.name));case"HeaderFilter":return e.jsx(Pt,{name:a.name},"filters ".concat(a.name));case"SelectFilter":return e.jsx(wt,{name:a.name,values:a.values,state:r!=null?parseInt(r,10):a.SelectFilterDefault,position:u,group:s,updateFilterValue:o,update:n},"filters ".concat(a.name));case"SeparatorFilter":return e.jsx(Yt,{name:a.name},"filters ".concat(a.name));case"SortFilter":return e.jsx(Bt,{name:a.name,values:a.values,state:r!=null?r:{ascending:(c=a.SortFilterDefault)==null?void 0:c.ascending,index:(l=a.SortFilterDefault)==null?void 0:l.index},position:u,group:s,updateFilterValue:o,update:n},"filters ".concat(a.name));case"TextFilter":return e.jsx(Ut,{name:a.name,state:r!=null?r:a.TextFilterDefault,position:u,group:s,updateFilterValue:o,update:n},"filters ".concat(a.name));case"TriStateFilter":return e.jsx(Vt,{name:a.name,state:r!=null?r:a.TriStateFilterDefault,position:u,group:s,updateFilterValue:o,update:n},"filters ".concat(a.name));default:throw new Error('Unknown source filter "'.concat(a,'"'))}})},"filters ".concat(s))}function Jt({savedSearches:t={},selectSavedSearch:s,updateSavedSearches:o,sourceFilter:n,updateFilterValue:a,resetFilterValue:u,setTriggerUpdate:r,update:c}){const{t:l}=je(),[h,d]=g.useState(!1),[x,S]=g.useState(""),j=Object.keys(t),i=!!j.length;function m(){u(0),d(!1)}function C(){r(0),d(!1)}return e.jsxs(e.Fragment,{children:[e.jsxs(Ct,{onClick:()=>d(!h),variant:"extended",color:"primary",children:[e.jsx(ye,{}),l("global.button.filter")]}),e.jsxs(mt,{open:h,onClose:()=>d(!1),children:[e.jsxs(M,{sx:{p:2,pb:i?void 0:0},children:[e.jsxs(M,{sx:{display:"flex",pb:1},children:[e.jsx(I,{onClick:m,children:l("global.button.reset")}),e.jsx(qe,{variant:"dialog",popupId:"source-browse-save-search",children:f=>e.jsxs(e.Fragment,{children:[e.jsx(J,{title:l("source.filter.save_search.label.save"),children:e.jsx(be,{sx:{marginLeft:"auto"},...Ge(f),children:e.jsx(Le,{})})}),e.jsxs(Ne,{...Be(f),maxWidth:"xs",fullWidth:!0,children:[e.jsx(Ue,{children:l("source.filter.save_search.dialog.label.title")}),e.jsx(He,{children:e.jsx(St,{sx:{width:"100%"},inputProps:{maxLength:50},value:x,onChange:y=>S(y.target.value)})}),e.jsxs(ze,{children:[e.jsx(I,{onClick:()=>{S(""),f.close()},children:l("global.button.cancel")}),e.jsx(I,{onClick:()=>{o(x,"create"),S(""),f.close()},children:l("global.button.ok")})]})]})]})}),e.jsx(I,{variant:"contained",onClick:C,children:l("global.button.submit")})]}),i&&e.jsxs(e.Fragment,{children:[e.jsx(ge,{sx:{pb:1},children:"Saved searches"}),e.jsx(N,{sx:{flexDirection:"row"},children:j.map(f=>e.jsx(Tt,{label:f,onClick:()=>{d(!1),s(f)},onDelete:()=>{yt({title:l("global.label.are_you_sure"),message:l("source.filter.save_search.dialog.label.delete",{name:f}),actions:{confirm:{title:l("global.button.delete")}}}).then(()=>o(f,"delete")).catch(Ce())},deleteIcon:e.jsx(J,{title:l("source.filter.save_search.label.delete"),children:e.jsx(pt,{})}),variant:"outlined"}))})]})]}),e.jsx(M,{sx:{pb:2,mx:2},children:e.jsx(Me,{sourceFilter:n,updateFilterValue:a,group:void 0,update:c})})]})]})}const Kt=t=>({...t,savedSearches:t.savedSearches?JSON.stringify(t.savedSearches):void 0}),Qt=t=>{var s;return{...t,savedSearches:(s=Ye(t.savedSearches))!=null?s:void 0}},Xt=({meta:t}={},s)=>Qt(Ve({meta:We(t)},{savedSearches:void 0},s)),Zt=async(t,s,o)=>Je(t,[[s,Kt({[s]:o})[s]]]),ea=(t,s=Ce())=>(o,n)=>Zt(t,o,n).catch(s),ta=X("div")(({theme:t})=>({display:"flex",position:"fixed",top:"64px",width:"100%",zIndex:1,backgroundColor:t.palette.background.default,[t.breakpoints.down("sm")]:{top:"56px"}})),Y=X(I)(()=>({marginTop:"13px",marginBottom:"13px",marginLeft:"13px"})),aa=X(M,{shouldForwardProp:t=>t!=="hasContent"})(({theme:t,hasContent:s})=>({marginTop:"calc(62.5px ".concat(s?"- 8px":"",")"),minHeight:"calc(100vh - 64px - 62.5px)",position:"relative",[t.breakpoints.down("sm")]:{marginTop:"calc(62.5px - 8px ".concat(s?"- 8px":"",")"),minHeight:"calc(100vh - 64px - 64px - 62.5px)"}}));var sa=(t=>(t[t.POPULAR=0]="POPULAR",t[t.LATEST=1]="LATEST",t[t.SEARCH=2]="SEARCH",t))(sa||{});const na={0:"manga.error.label.no_mangas_found",1:"manga.error.label.no_mangas_found",2:"manga.error.label.no_matches"},ra=t=>{const s={},o=[];return t.forEach(n=>{!!s[n.id]||(s[n.id]=n,o.push(n))}),o},oa=(t,s,o,n,a,u)=>{var j;let r;switch(s){case 0:r=P.useGetSourcePopularMangas(t,a);break;case 1:r=P.useGetSourceLatestMangas(t,a);break;case 2:r=P.useSourceSearch(t,o!=null?o:"",n.map(i=>{const{position:m,state:C,group:f}=i;return f!==void 0?{position:f,groupChange:{position:m,[i.type]:C}}:{position:m,[i.type]:C}}),a);break;default:throw new Error('Unknown ContentType "'.concat(s,'"'))}const c=r[1],l=c.findLastIndex(i=>{var m;return!!((m=i.data)!=null&&m.fetchSourceManga)}),h=c[l],d=c.slice(-1)[0].isLoading;let x=!d;const S=g.useMemo(()=>{let i=[];return c.forEach((m,C)=>{var R,$,b;const f=(b=($=(R=m.data)==null?void 0:R.fetchSourceManga)==null?void 0:$.mangas)!=null?b:[],y=f.filter(B=>!u||!B.inLibrary),O=ra([...i,...y]);x=!d&&c.length===C+1&&!y.length&&!!f.length,i=O}),i},[c,u]);return l===-1?[r[0],{...r[1][r[1].length-1],filteredOutAllItemsOfFetchedPage:x}]:[r[0],{...c[c.length-1],data:{...h.data,fetchSourceManga:{...h.data.fetchSourceManga,hasNextPage:c.length>l+1?!1:!!((j=h.data.fetchSourceManga)!=null&&j.hasNextPage),mangas:S}},filteredOutAllItemsOfFetchedPage:x}]};function Va(){var ce,ue,de,pe,xe;const{t}=je(),{setTitle:s,setAction:o}=g.useContext(Ke),{sourceId:n}=Qe(),a=Xe(),u=he(),{key:r,state:c}=u,{contentType:l=0,clearCache:h=!1}=(ce=he().state)!=null?ce:{},[d,x]=g.useState(!0);g.useEffect(()=>{x(!1)},[]);const{settings:{hideLibraryEntries:S}}=Ze(),{options:j}=fe(),[i]=it("query",ct),[m,C]=G("source-mangas-".concat(n,"-filters"),[]),[f,y]=G("source-mangas-location-".concat(r,"-").concat(n,"-filters"),m!=null?m:[]),[O,w]=g.useState(f),[R,$]=G("source-mangas-".concat(n,"-content-type"),l),[b,B]=G("source-mangas-location-".concat(r,"-").concat(n,"-content-type"),i?2:R);g.useEffect(()=>()=>{C(void 0),$(void 0)},[n]);const A=g.useCallback(()=>{et.session.setItem(Ft(u),void 0,!1),window.scrollTo(0,0)},[r]),U=v=>{C(v),y(v),A()},ne=v=>{$(v),B(v)},[re,{data:_,isLoading:H,size:z,abortRequest:Ee,filteredOutAllItemsOfFetchedPage:V}]=oa(n,b,i,f,1,S),oe=H||V,ie=(de=(ue=_==null?void 0:_.fetchSourceManga)==null?void 0:ue.mangas)!=null?de:[],D=!!((pe=_==null?void 0:_.fetchSourceManga)!=null&&pe.hasNextPage),{data:W}=P.useGetSource(tt,n),p=W==null?void 0:W.source,$e=(xe=p==null?void 0:p.filters)!=null?xe:[],{savedSearches:F={}}=g.useMemo(()=>Xt(p),[p,p==null?void 0:p.meta]),le=ea(p!=null?p:{id:n},()=>rt(t("global.error.label.failed_to_save_changes"),"error")),ke=g.useCallback(v=>{const{query:L,filters:k}=F[v];k&&(w(k),U(k)),a({pathname:"",search:L?"query=".concat(L):void 0},{state:{...c,contentType:2}})},[F,c]),Ie=g.useCallback((v,L)=>{if(L==="delete"){const me={...F};delete me[v],le("savedSearches",me);return}const k={...F,[v]:{query:i!=null?i:void 0,filters:f}};le("savedSearches",k)},[F,i,f]),Pe=oe?void 0:t(na[b]),Oe=n==="0"?e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:[t("source.local_source.label.checkout")," "]}),e.jsx(Lt,{href:"https://github.com/Suwayomi/Suwayomi-Server/wiki/Local-Source",target:"_blank",rel:"noreferrer",children:t("source.local_source.label.guide")})]}):void 0,q=g.useCallback((v,L)=>{ne(v),A(),i&&!L&&a({pathname:""},{state:{...c,contentType:v}})},[ne,i,A]);!!i&&b!==2&&q(2,i);const we=g.useCallback(()=>{D&&re(z+1)},[z,D,b]),Re=()=>{w([]),U([])};return g.useEffect(()=>{V&&D&&!H&&re(z+1)},[V,H]),g.useEffect(()=>{!h||!nt.REVALIDATION.includes(n)||P.clearBrowseCacheFor(n)},[h]),g.useEffect(()=>()=>{b!==2||d||(Ee(new Error("SourceMangas(".concat(n,"): search string changed"))),A())},[i]),g.useEffect(()=>{var v;return s((v=p==null?void 0:p.displayName)!=null?v:t("source.title_one")),o(e.jsxs(e.Fragment,{children:[e.jsx(lt,{}),e.jsx(Mt,{}),(p==null?void 0:p.isConfigurable)&&e.jsx(J,{title:t("settings.title"),children:e.jsx(be,{onClick:()=>a("/sources/".concat(n,"/configure/")),"aria-label":"display more actions",edge:"end",color:"inherit",size:"large",children:e.jsx(at,{})})})]})),()=>{s(""),o(null)}},[t,p]),e.jsxs(aa,{hasContent:!!ie.length,children:[e.jsxs(ta,{children:[e.jsx(Y,{variant:b===0?"contained":"outlined",startIcon:e.jsx(ut,{}),onClick:()=>q(0),children:t("global.button.popular")}),(p==null?void 0:p.supportsLatest)===void 0||p.supportsLatest?e.jsx(Y,{disabled:!(p!=null&&p.supportsLatest),variant:b===1?"contained":"outlined",startIcon:e.jsx(st,{}),onClick:()=>q(1),children:t("global.button.latest")}):null,e.jsx(Y,{variant:b===2?"contained":"outlined",startIcon:e.jsx(ye,{}),onClick:()=>q(2,i),children:t("global.button.filter")})]}),e.jsx(_t,{mangas:ie,hasNextPage:D,loadMore:we,message:Pe,messageExtra:Oe,isLoading:oe,gridLayout:j.SourcegridLayout,mode:"source",inLibraryIndicator:!0},b),b===2&&e.jsx(Jt,{savedSearches:F,selectSavedSearch:ke,updateSavedSearches:Ie,sourceFilter:$e,updateFilterValue:w,setTriggerUpdate:()=>{U(O)},resetFilterValue:Re,update:O})]})}export{sa as SourceContentType,Va as SourceMangas};
