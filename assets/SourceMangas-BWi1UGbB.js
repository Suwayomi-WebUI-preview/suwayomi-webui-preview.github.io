import{b as ge,P as he,j as e,c as Ge,am as T,T as xe,ap as Ue,o as k,aI as fe,ar as Se,ak as be,S as q,e as b,b7 as M,aN as Ne,u as je,B as w,a3 as Be,C as X,I as ve,a4 as qe,D as Ve,aa as He,l as We,n as ze,aE as Qe,b8 as Ye,i as ee,b9 as Je,ba as Ke,a1 as Ze,a0 as Xe,a as et,as as tt,bb as st,f as at,p as pe,d as rt,bc as B,bd as nt,r as O,be as ot,k as it,A as ct,aw as lt,Z as te,bf as ut,h as me,bg as dt,m as pt}from"./index-DWz4TNtd.js";import{a as mt,u as gt,A as ht,S as xt}from"./AppbarSearch-I-jhwbd8.js";import{F as ft}from"./Favorite-DO_ID7fD.js";import{F as Ce}from"./FilterList-dvyjNZLc.js";import{G as St}from"./GridLayouts-prSGoA8C.js";import{D as bt}from"./Delete-Da55i9yt.js";import{S as jt,O as vt}from"./SortRadioInput-CDwC33C3.js";import{C as Ct}from"./CheckboxInput-DJhQhiao.js";import{a as ye,I as Te,S as yt,b as Tt,T as Ft}from"./TextField-p1pWQlzT.js";import{a as Fe,E as Ee}from"./ExpandMore-BzZG9s_A.js";import{u as Et}from"./useDebounce-CMKJipzi.js";import{I as Lt}from"./InputAdornment-D2Hu2W11.js";import{T as It}from"./ThreeStateCheckboxInput-bOClE9Pj.js";import{S as kt}from"./StyledFab-CsCAQaVn.js";import{C as Mt}from"./Chip-vNVf609j.js";import{B as At}from"./BaseMangaGrid-BmzKoi3H.js";import{g as _t}from"./MangaGrid-DcHgkAx9.js";import{E as Pt}from"./EmptyViewAbsoluteCentered-DPrnddnF.js";import{S as wt}from"./Sources-CFddsDZp.js";import{L as Ot}from"./Link-CkgbKDy3.js";import"./ChaptersDownloadActionMenuItems-B7yKOewR.js";import"./Trackers-D4pSmk7a.js";import"./Card-8Hlh2tNY.js";import"./CardContent-CJ5i7b3K.js";import"./Avatar-aJufYokf.js";import"./CheckCircle-V9AVHnfh.js";import"./MUI.util-BHb8I4Fi.js";import"./CardActionArea-DZr1-Ien.js";import"./useManageMangaLibraryState-SIk1Scuh.js";import"./FormGroup-CzBp0i4z.js";import"./useFormControl-BeXl2Zas.js";import"./formControlState-Dq1zat_P.js";import"./ListPreference-O4j_Xj-q.js";import"./Checkbox-BBcQZP1l.js";import"./SwitchBase-DdFM11Au.js";import"./NumberSetting-f5eDW7ri.js";import"./Slider-DpJVGl_w.js";import"./useMobilePicker-Din-egOw.js";import"./SelectSetting-Bb9lWjRf.js";import"./Select-DTupB29O.js";import"./Download-BNw0zcIk.js";import"./Sync-DNaSioGT.js";import"./ListCardAvatar-DBmIeoJi.js";import"./ListCardContent-D0gc0Fug.js";import"./PlayArrow-PCjqY2mO.js";function Dt(){const[t,a]=ge("source-grid-layout",he.Compact);return e.jsx(St,{gridLayout:t,onChange:a})}const Rt=Ge(e.jsx("path",{d:"M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3m3-10H5V5h10z"})),$t=t=>{const{state:a,name:n,position:o,group:s,updateFilterValue:l,update:r}=t,[u,c]=T.useState(a),p=d=>{c(d.target.checked);const m=r.filter(S=>!(o===S.position&&s===S.group));l([...m,{type:"checkBoxState",position:o,state:d.target.checked,group:s}])};return a!==void 0?e.jsx(Ct,{label:n,checked:u,onChange:p}):null},Gt=({name:t})=>e.jsx(xe,{sx:{mt:2},variant:"subtitle2",children:t},t);function Ut(t,a,n,o,s,l,r){const[u,c]=T.useState(n);if(t){const p=m=>{const S=t.indexOf("".concat(m.target.value));c(S);const j=l.filter(g=>!(o===g.position&&r===g.group));s([...j,{type:"selectState",position:o,state:S,group:r}])},d=t.map(m=>e.jsx(Ue,{value:m,children:m},"".concat(a," ").concat(m)));return e.jsxs(ye,{sx:{my:1},variant:"standard",children:[e.jsx(Te,{children:a}),e.jsx(yt,{name:a,value:t[u],label:a,onChange:p,children:d})]})}return null}const Nt=({values:t,name:a,state:n,position:o,updateFilterValue:s,update:l,group:r})=>Ut(t,a,n,o,s,l,r),Bt=t=>{const{values:a,name:n,state:o,position:s,group:l,updateFilterValue:r,update:u}=t,[c,p]=T.useState(o),[d,m]=T.useState(!1),S=()=>{m(!d)};if(a){const j=g=>{const i=c;i.index===g?i.ascending=!i.ascending:i.ascending=!0,i.index=g,p(i);const v=u.filter(x=>!(s===x.position&&l===x.group));r([...v,{type:"sortState",position:s,state:i,group:l}])};return e.jsxs(k,{sx:{mx:-2},children:[e.jsxs(fe,{onClick:S,children:[e.jsx(Se,{primary:n}),d?e.jsx(Fe,{}):e.jsx(Ee,{})]}),e.jsx(be,{in:d,children:e.jsx(q,{sx:{mx:4},children:a.map((g,i)=>e.jsx(jt,{label:g,checked:c.index===i,sortDescending:!c.ascending,onClick:()=>j(i)},"".concat(n," ").concat(g)))})})]})}return null},qt=t=>{const{state:a,name:n,position:o,group:s,updateFilterValue:l,update:r}=t,[u,c]=T.useState(a||""),p=Et(u,500);return b.useEffect(()=>{const d=r.filter(m=>!(o===m.position&&s===m.group));l([...d,{type:"textState",position:o,state:p,group:s}])},[p]),a!==void 0?e.jsxs(ye,{sx:{my:1},variant:"standard",children:[e.jsx(Te,{children:n}),e.jsx(Tt,{name:n,value:u,onChange:({target:{value:d}})=>c(d),endAdornment:e.jsx(Lt,{position:"end",children:e.jsx(mt,{})})})]}):null},Vt=t=>{switch(t){case M.Ignore:return 0;case M.Include:return 1;case M.Exclude:return 2;default:throw new Error("Unexpected TriState ".concat(t))}},Ht=t=>{switch(t){case 0:return M.Ignore;case 1:return M.Include;case 2:return M.Exclude;default:throw new Error("Unexpected state number ".concat(t))}},Wt=t=>{const{state:a,name:n,position:o,group:s,updateFilterValue:l,update:r}=t,[u,c]=T.useState(Vt(a)),p=d=>{const m=d===void 0?0:d?1:2;c(m);const S=r.filter(j=>!(o===j.position&&s===j.group));l([...S,{type:"triState",position:o,state:Ht(m),group:s}])};return a!==void 0?e.jsx(It,{label:n,checked:[void 0,!0,!1][u],onChange:d=>p(d)}):null},zt=t=>{const{state:a,name:n,position:o,updateFilterValue:s,update:l}=t,[r,u]=T.useState(!1);return e.jsxs(k,{sx:{mx:-2},children:[e.jsxs(fe,{onClick:()=>u(!r),children:[e.jsx(Se,{primary:n}),r?e.jsx(Fe,{}):e.jsx(Ee,{})]}),e.jsx(be,{in:r,children:e.jsx(q,{sx:{mx:4},children:e.jsx(Le,{sourceFilter:a,group:o,updateFilterValue:s,update:l})})})]})},Qt=({name:t})=>e.jsx(Ne,{sx:{my:1},textAlign:"center",children:t},t);function Le({sourceFilter:t,group:a,updateFilterValue:n,update:o}){return e.jsx(q,{children:t.map((s,l)=>{var u,c;let r=o.find(p=>p.group===a&&p.position===l);switch(r=r&&r.state,s.type){case"CheckBoxFilter":return e.jsx($t,{name:s.name,state:r!=null?r:s.CheckBoxFilterDefault,position:l,group:a,updateFilterValue:n,update:o},"filters ".concat(s.name));case"GroupFilter":return e.jsx(zt,{name:s.name,state:s.filters,position:l,updateFilterValue:n,update:o},"filters ".concat(s.name));case"HeaderFilter":return e.jsx(Gt,{name:s.name},"filters ".concat(s.name));case"SelectFilter":return e.jsx(Nt,{name:s.name,values:s.values,state:r!=null?parseInt(r,10):s.SelectFilterDefault,position:l,group:a,updateFilterValue:n,update:o},"filters ".concat(s.name));case"SeparatorFilter":return e.jsx(Qt,{name:s.name},"filters ".concat(s.name));case"SortFilter":return e.jsx(Bt,{name:s.name,values:s.values,state:r!=null?r:{ascending:(u=s.SortFilterDefault)==null?void 0:u.ascending,index:(c=s.SortFilterDefault)==null?void 0:c.index},position:l,group:a,updateFilterValue:n,update:o},"filters ".concat(s.name));case"TextFilter":return e.jsx(qt,{name:s.name,state:r!=null?r:s.TextFilterDefault,position:l,group:a,updateFilterValue:n,update:o},"filters ".concat(s.name));case"TriStateFilter":return e.jsx(Wt,{name:s.name,state:r!=null?r:s.TriStateFilterDefault,position:l,group:a,updateFilterValue:n,update:o},"filters ".concat(s.name));default:throw new Error('Unknown source filter "'.concat(s,'"'))}})},"filters ".concat(a))}function Yt({savedSearches:t={},selectSavedSearch:a,updateSavedSearches:n,sourceFilter:o,updateFilterValue:s,resetFilterValue:l,setTriggerUpdate:r,update:u}){const{t:c}=je(),[p,d]=b.useState(!1),[m,S]=b.useState(""),j=Object.keys(t),g=!!j.length;function i(){l(0),d(!1)}function v(){r(0),d(!1)}return e.jsxs(e.Fragment,{children:[e.jsxs(kt,{onClick:()=>d(!p),variant:"extended",color:"primary",children:[e.jsx(Ce,{}),c("global.button.filter")]}),e.jsxs(vt,{open:p,onClose:()=>d(!1),children:[e.jsxs(k,{sx:{p:2,pb:g?void 0:0},children:[e.jsxs(k,{sx:{display:"flex",pb:1},children:[e.jsx(w,{onClick:i,children:c("global.button.reset")}),e.jsx(Be,{variant:"dialog",popupId:"source-browse-save-search",children:x=>e.jsxs(e.Fragment,{children:[e.jsx(X,{title:c("source.filter.save_search.label.save"),children:e.jsx(ve,{sx:{marginLeft:"auto"},...qe(x),children:e.jsx(Rt,{})})}),e.jsxs(Ve,{...He(x),maxWidth:"xs",fullWidth:!0,children:[e.jsx(We,{children:c("source.filter.save_search.dialog.label.title")}),e.jsx(ze,{children:e.jsx(Ft,{sx:{width:"100%"},value:m,onChange:y=>S(y.target.value),slotProps:{htmlInput:{maxLength:50}}})}),e.jsxs(Qe,{children:[e.jsx(w,{onClick:()=>{S(""),x.close()},children:c("global.button.cancel")}),e.jsx(w,{onClick:()=>{n(m,"create"),S(""),x.close()},children:c("global.button.ok")})]})]})]})}),e.jsx(w,{variant:"contained",onClick:v,children:c("global.button.submit")})]}),g&&e.jsxs(e.Fragment,{children:[e.jsx(xe,{sx:{pb:1},children:"Saved searches"}),e.jsx(q,{sx:{flexDirection:"row"},children:j.map(x=>e.jsx(Mt,{label:x,onClick:()=>{d(!1),a(x)},onDelete:()=>{Ye({title:c("global.label.are_you_sure"),message:c("source.filter.save_search.dialog.label.delete",{name:x}),actions:{confirm:{title:c("global.button.delete")}}}).then(()=>n(x,"delete")).catch(ee())},deleteIcon:e.jsx(X,{title:c("source.filter.save_search.label.delete"),children:e.jsx(bt,{})}),variant:"outlined"}))})]})]}),e.jsx(k,{sx:{pb:2,mx:2},children:e.jsx(Le,{sourceFilter:o,updateFilterValue:s,group:void 0,update:u})})]})]})}const Jt={savedSearches:void 0},Ie=t=>({...t,savedSearches:t.savedSearches?JSON.stringify(t.savedSearches):void 0}),Kt=t=>{var a;return{...t,savedSearches:(a=Ke(t.savedSearches))!=null?a:void 0}},Zt=(t,a)=>Kt(Ze("source",{...t,meta:Xe(t.meta)},Ie(Jt),void 0,a)),Xt=t=>{const a=Zt(t,b.useEffect);return b.useMemo(()=>a,[t])},es=async(t,a,n)=>Je(t,[[a,Ie({[a]:n})[a]]]),ts=(t,a=ee())=>(n,o)=>es(t,n,o).catch(a),ss={id:"-1"},as=te("div")(({theme:t})=>({display:"flex",position:"sticky",width:"100%",zIndex:1,padding:t.spacing(1),gap:t.spacing(1),backgroundColor:t.palette.background.default})),Z=te(w)(()=>({})),rs=te(k)(()=>({minHeight:"100%",position:"relative"}));var ns=(t=>(t[t.POPULAR=0]="POPULAR",t[t.LATEST=1]="LATEST",t[t.SEARCH=2]="SEARCH",t))(ns||{});const os={0:"manga.error.label.no_mangas_found",1:"manga.error.label.no_mangas_found",2:"manga.error.label.no_matches"},is=t=>{const a={},n=[];return t.forEach(o=>{!!a[o.id]||(a[o.id]=o,n.push(o))}),n},cs=(t,a,n,o,s,l)=>{var j;let r;switch(a){case 0:r=O.useGetSourcePopularMangas(t,s);break;case 1:r=O.useGetSourceLatestMangas(t,s);break;case 2:r=O.useSourceSearch(t,n!=null?n:"",o.map(g=>{const{position:i,state:v,group:x}=g;return x!==void 0?{position:x,groupChange:{position:i,[g.type]:v}}:{position:i,[g.type]:v}}),s);break;default:throw new Error('Unknown ContentType "'.concat(a,'"'))}const u=r[1],c=u.findLastIndex(g=>{var i;return!!((i=g.data)!=null&&i.fetchSourceManga)}),p=u[c],d=u.slice(-1)[0].isLoading;let m=!d;const S=b.useMemo(()=>{let g=[];return u.forEach((i,v)=>{var F,D,_;const x=(_=(D=(F=i.data)==null?void 0:F.fetchSourceManga)==null?void 0:D.mangas)!=null?_:[],y=x.filter(C=>!l||!C.inLibrary),V=is([...g,...y]);m=!d&&u.length===v+1&&!y.length&&!!x.length,g=V}),g},[u,l]);return c===-1?[r[0],{...r[1][r[1].length-1],filteredOutAllItemsOfFetchedPage:m}]:[r[0],{...u[u.length-1],data:{...p.data,fetchSourceManga:{...p.data.fetchSourceManga,hasNextPage:u.length>c+1?!1:!!((j=p.data.fetchSourceManga)!=null&&j.hasNextPage),mangas:S}},filteredOutAllItemsOfFetchedPage:m}]};function aa(){var oe,ie,ce,le,ue;const{t}=je(),{setTitle:a,setAction:n,appBarHeight:o}=et(),{sourceId:s}=tt(),[l,r]=st(),u=at(),c=pe(),{key:p,state:d}=c,{contentType:m=0,clearCache:S=!1}=(oe=pe().state)!=null?oe:{},{settings:{hideLibraryEntries:j}}=rt(),[g]=ge("source-grid-layout",he.Compact),[i]=gt("query",xt),[v,x]=B("source-mangas-".concat(s,"-filters"),[]),[y,V]=B("source-mangas-location-".concat(p,"-").concat(s,"-filters"),v!=null?v:[]),[A,F]=b.useState(y),[D,_]=B("source-mangas-".concat(s,"-content-type"),m),[C,ke]=B("source-mangas-location-".concat(p,"-").concat(s,"-content-type"),i?2:D),R=b.useCallback(()=>{nt.session.setItem(_t(c),void 0,!1),window.scrollTo(0,0)},[p]),se=b.useRef(i),ae=b.useRef(()=>{});se.current!==i&&C===2&&(se.current=i,ae.current(new Error("SourceMangas(".concat(s,"): search string changed"))),R()),b.useEffect(()=>()=>{x(void 0),_(void 0)},[s]);const H=f=>{x(f),V(f),R()},re=f=>{_(f),ke(f)},[W,{data:E,error:$,isLoading:z,size:G,abortRequest:Me,filteredOutAllItemsOfFetchedPage:Q}]=cs(s,C,i,y,1,j);ae.current=Me;const Y=z||Q,J=(ce=(ie=E==null?void 0:E.fetchSourceManga)==null?void 0:ie.mangas)!=null?ce:[],U=!!((le=E==null?void 0:E.fetchSourceManga)!=null&&le.hasNextPage),{data:K}=O.useGetSource(ot,s),h=K==null?void 0:K.source,Ae=(ue=h==null?void 0:h.filters)!=null?ue:[],{savedSearches:L={}}=Xt(h!=null?h:ss),ne=ts(h!=null?h:{id:"-1"},f=>pt(t("global.error.label.failed_to_save_changes"),"error",me(f))),_e=b.useCallback(f=>{const{query:I,filters:P}=L[f];P&&(F(P),H(P)),I&&(l.set("query",I),r(l))},[L,d]),Pe=b.useCallback((f,I)=>{if(I==="delete"){const de={...L};delete de[f],ne("savedSearches",de);return}const P={...L,[f]:{query:i!=null?i:void 0,filters:A}};ne("savedSearches",P)},[L,i,A]),we=Y?void 0:t(os[C]),Oe=s===wt.LOCAL_SOURCE_ID?e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:[t("source.local_source.label.checkout")," "]}),e.jsx(Ot,{href:"https://github.com/Suwayomi/Suwayomi-Server/wiki/Local-Source",target:"_blank",rel:"noreferrer",children:t("source.local_source.label.guide")})]}):void 0,N=b.useCallback((f,I)=>{re(f),R(),i&&!I&&u({pathname:""},{state:{...d,contentType:f}})},[re,i,R]);!!i&&C!==2&&N(2,i);const De=b.useCallback(()=>{U&&W(G+1)},[G,U,C]),Re=()=>{F([]),H([])};b.useEffect(()=>{Q&&U&&!z&&W(G+1)},[Q,z]),b.useEffect(()=>{!S||!dt.REVALIDATION.includes(s)||O.clearBrowseCacheFor(s)},[S]),b.useLayoutEffect(()=>{var f;return a((f=h==null?void 0:h.displayName)!=null?f:t("source.title_one")),n(e.jsxs(e.Fragment,{children:[e.jsx(ht,{}),e.jsx(Dt,{}),(h==null?void 0:h.isConfigurable)&&e.jsx(X,{title:t("settings.title"),children:e.jsx(ve,{onClick:()=>u(ct.sources.childRoutes.configure.path(s)),"aria-label":"display more actions",edge:"end",color:"inherit",children:e.jsx(it,{})})})]})),()=>{a(""),n(null)}},[t,h]);const $e=J.length?lt:Pt;return e.jsxs(rs,{children:[e.jsxs(as,{sx:{top:"".concat(o,"px")},children:[e.jsx(Z,{variant:C===0?"contained":"outlined",startIcon:e.jsx(ft,{}),onClick:()=>N(0),children:t("global.button.popular")}),(h==null?void 0:h.supportsLatest)===void 0||h.supportsLatest?e.jsx(Z,{disabled:!(h!=null&&h.supportsLatest),variant:C===1?"contained":"outlined",startIcon:e.jsx(ut,{}),onClick:()=>N(1),children:t("global.button.latest")}):null,e.jsx(Z,{variant:C===2?"contained":"outlined",startIcon:e.jsx(Ce,{}),onClick:()=>N(2,i),children:t("global.button.filter")})]}),(Y||!$||!!$&&!!J.length)&&e.jsx(At,{gridWrapperProps:{sx:{px:1,pb:1}},mangas:J,hasNextPage:U,loadMore:De,message:we,messageExtra:Oe,isLoading:Y,gridLayout:g,mode:"source",inLibraryIndicator:!0},C),$&&e.jsx($e,{message:t("global.error.label.failed_to_load_data"),messageExtra:me($),retry:()=>W(G).catch(ee())}),C===2&&e.jsx(Yt,{savedSearches:L,selectSavedSearch:_e,updateSavedSearches:Pe,sourceFilter:Ae,updateFilterValue:F,setTriggerUpdate:()=>{H(A)},resetFilterValue:Re,update:A})]})}export{ns as SourceContentType,aa as SourceMangas};
