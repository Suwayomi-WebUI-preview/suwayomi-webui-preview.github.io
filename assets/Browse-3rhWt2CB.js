import{r as X,i as Q,j as e,u as C,M as ke,L as R,B as k,a as N,T,S as Y,b as P,c as d,N as J,d as B,e as De,f as G,I as H,g as Z,h as U,m as w,k as Me,l as Pe,s as Be,n as Ge,o as He,p as fe,q as ge,t as Fe,v as $e}from"./index-BLgYiawO.js";import{u as Ne,S as je,A as ze}from"./AppbarSearch-CS6GP7w1.js";import{s as Le,l as ee,D as g,a as qe,e as Ve}from"./Languages-B1mFw-Iq.js";import{t as $,L as ve,i as We,E as S}from"./LangSelect-Cvpc62T-.js";import{SourceContentType as V}from"./SourceMangas-weuvQlEn.js";import{S as te}from"./SpinnerImage-BKahaNo_.js";import{C as ne}from"./Card-qMlyKuip.js";import{C as be}from"./CardActionArea-CzxepwG4.js";import{C as se}from"./CardContent-CSR8wzft.js";import{A as re}from"./Avatar-CoCpqgd0.js";import{E as F}from"./EmptyViewAbsoluteCentered-DdVIYYLb.js";import{f as Ke}from"./file-selector-dNdbteOu.js";import{d as Xe}from"./Add-CSZKIl-5.js";import{V as Qe,S as Ye,a as Je,b as Ie}from"./Virtuoso.util-CuAimmpM.js";import{T as W,a as K}from"./Tabs-Bl1heplo.js";import{T as Ze,a as et}from"./TabsMenu-COKUuXb3.js";import{d as tt,a as nt}from"./SortRadioInput-Dz7IKPD8.js";import{C as st}from"./Chip-C0edXhid.js";import"./useManageMangaLibraryState-vuUZRzEt.js";import"./Trackers-D4pSmk7a.js";import"./Info-lIpiSW30.js";import"./TextField-DjPg3JDd.js";import"./InputAdornment-D0Kz6aT1.js";import"./CheckCircle-DFAyKAc3.js";import"./TypographyMaxLines-DgqbLyXa.js";import"./Mangas-BNy2IDHP.js";import"./Chapters-Dg3CQzep.js";import"./Collapse-barFscOo.js";import"./Link-DGgLj-kO.js";import"./ListPreference-Df7TMBpU.js";import"./Checkbox-C2R3MqBz.js";import"./SwitchBase-C5DQKxRJ.js";import"./NumberSetting-Cy_AuEb1.js";import"./useMobilePicker-CYQOQmND.js";import"./SelectSetting-FKar5L0O.js";import"./Select-O-0yV8lJ.js";import"./CheckboxInput-Bmcx3LoB.js";import"./ThreeStateCheckboxInput-CWoMaR0c.js";import"./FilterList-DNkkQzxZ.js";import"./cloneObject-DrOPTG0J.js";import"./Switch-Bg2J76rN.js";import"./ExpandMore-FjQQVekc.js";import"./GridLayouts-ZrJa2kvp.js";import"./Delete-yg-QzkHg.js";import"./useDebounce-DU1qUFqx.js";import"./StyledFab-Bn_g68I2.js";import"./BaseMangaGrid-B9-u6g0Q.js";import"./MangaGrid-CBCABCYr.js";import"./index-DxfBLnT1.js";import"./Download-CekKEQTg.js";import"./Sync-CTViG22A.js";import"./PlayArrow-qrxQsm6h.js";import"./Refresh-n1UR1Umw.js";var oe={},rt=Q;Object.defineProperty(oe,"__esModule",{value:!0});var Ae=oe.default=void 0,ot=rt(X()),at=e;Ae=oe.default=(0,ot.default)((0,at.jsx)("path",{d:"M19.3 16.9c.4-.7.7-1.5.7-2.4 0-2.5-2-4.5-4.5-4.5S11 12 11 14.5s2 4.5 4.5 4.5c.9 0 1.7-.3 2.4-.7l3.2 3.2 1.4-1.4zm-3.8.1c-1.4 0-2.5-1.1-2.5-2.5s1.1-2.5 2.5-2.5 2.5 1.1 2.5 2.5-1.1 2.5-2.5 2.5M12 20v2C6.48 22 2 17.52 2 12S6.48 2 12 2c4.84 0 8.87 3.44 9.8 8h-2.07c-.64-2.46-2.4-4.47-4.73-5.41V5c0 1.1-.9 2-2 2h-2v2c0 .55-.45 1-1 1H8v2h2v3H9l-4.79-4.79C4.08 10.79 4 11.38 4 12c0 4.41 3.59 8 8 8"}),"TravelExplore");const it=s=>{const{t:n}=C(),t=ke.useIsMobileWidth(),{source:{id:a,name:u,lang:o,iconUrl:r,supportsLatest:i,isNsfw:h,extension:{repo:l}},showSourceRepo:L}=s,p=Number(a)===0?n("source.local_source.title"):u;return e.jsx(ne,{sx:{margin:1,marginTop:0},children:e.jsx(be,{component:R,to:"/sources/".concat(a),state:{contentType:V.POPULAR,clearCache:!0},children:e.jsxs(se,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:1.5},children:[e.jsxs(k,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(re,{variant:"rounded",alt:p,sx:{width:56,height:56,flex:"0 0 auto",mr:1,background:"transparent"},children:e.jsx(te,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:p,src:N.getValidImgUrlFor(r)})}),e.jsxs(k,{sx:{display:"flex",flexDirection:"column",justifyContent:"center"},children:[e.jsx(T,{variant:"h6",component:"h3",children:p}),e.jsxs(T,{variant:"caption",sx:{display:"block"},children:[$(o),h&&e.jsx(T,{variant:"caption",color:"error",sx:{display:"inline"},children:" 18+"}),L&&e.jsx(T,{variant:"caption",sx:{display:"block"},children:l})]})]})]}),e.jsxs(Y,{sx:{flexDirection:"row",gap:1},children:[i&&e.jsx(P,{variant:"outlined",component:R,to:"/sources/".concat(a),state:{contentType:V.LATEST,clearCache:!0},children:n("global.button.latest")}),!t&&e.jsx(P,{variant:"outlined",component:R,to:"/sources/".concat(a),state:{contentType:V.POPULAR,clearCache:!0},children:n("global.button.popular")})]})]})})})};function lt(s){const n=new Set;return s.forEach(t=>{const u=Number(t.id)===0?g.OTHER:t.lang;n.add(u)}),[...n].sort(ee)}function ct(s){const n={};return s.forEach(t=>{var o;const u=Number(t.id)===0?g.OTHER:t.lang;(o=n[u])!=null||(n[u]=[]),n[u].push(t)}),Object.values(n).forEach(t=>t.sort((a,u)=>a.name.localeCompare(u.name))),n}function ut(){const{t:s}=C(),{setAction:n}=d.useContext(J),[t,a]=B("shownSourceLangs",qe()),[u]=B("showNsfw",!0),{data:o,loading:r,error:i,refetch:h}=N.useGetSourceList({notifyOnNetworkStatusChange:!0}),l=o==null?void 0:o.sources.nodes,L=d.useMemo(()=>{if(!l||l!=null&&l.length)return!1;const{repo:p}=l[0].extension;return l.some(m=>m.extension.repo!==p)},[l]),v=De();return d.useEffect(()=>{Le().forEach(p=>{let m=!1;t.forEach(x=>{x===p&&(m=!0)}),m||a(x=>(x.push(p),x))})},[]),d.useLayoutEffect(()=>(n(e.jsxs(e.Fragment,{children:[e.jsx(G,{title:s("search.title.global_search"),children:e.jsx(H,{onClick:()=>v("/sources/all/search/"),size:"large",color:"inherit",children:e.jsx(Ae,{})})}),e.jsx(ve,{shownLangs:t,setShownLangs:a,allLangs:lt(l!=null?l:[]),forcedLangs:Le()})]})),()=>{n(null)}),[s,t,l]),r?e.jsx(Z,{}):i?e.jsx(F,{message:s("global.error.label.failed_to_load_data"),messageExtra:i.message,retry:()=>h().catch(U())}):(l==null?void 0:l.length)===0?e.jsx(F,{message:s("source.error.label.no_sources_found")}):e.jsx(e.Fragment,{children:Object.entries(ct(l!=null?l:[])).sort((p,m)=>ee(p[0],m[0])).map(([p,m])=>(p===g.OTHER||t.includes(p))&&e.jsxs(d.Fragment,{children:[e.jsx(T,{variant:"h5",component:"h2",sx:{paddingLeft:3,paddingTop:1,paddingBottom:2,fontWeight:"bold"},children:$(p)},p),m.filter(x=>{if(p===g.OTHER){const O=Number(x.id)===0;if(!(t.includes(p)||O))return!1}return u||!x.isNsfw}).map(x=>e.jsx(it,{source:x,showSourceRepo:L},x.id))]},p))})}var _e=(s=>(s.UPDATE="UPDATE",s.UNINSTALL="UNINSTALL",s.INSTALL="INSTALL",s))(_e||{}),Ce=(s=>(s.OBSOLETE="OBSOLETE",s.UPDATING="UPDATING",s.UNINSTALLING="UNINSTALLING",s.INSTALLING="INSTALLING",s))(Ce||{});const E={..._e,...Ce},dt={UPDATE:"UPDATING",UNINSTALL:"UNINSTALLING",INSTALL:"INSTALLING"},pt={UPDATE:"UNINSTALL",UNINSTALL:"INSTALL",INSTALL:"UNINSTALL"},ht={[E.UNINSTALL]:"extension.action.label.uninstall",[E.INSTALL]:"extension.action.label.install",[E.UPDATE]:"extension.action.label.update",[E.OBSOLETE]:"extension.state.label.obsolete",[E.UPDATING]:"extension.state.label.updating",[E.UNINSTALLING]:"extension.state.label.uninstalling",[E.INSTALLING]:"extension.state.label.installing"},xt={UPDATE:"extension.label.update_failed",INSTALL:"extension.label.installation_failed",UNINSTALL:"extension.label.uninstallation_failed"},Se=(s,n,t)=>n?E.OBSOLETE:t?E.UPDATE:s?E.UNINSTALL:E.INSTALL;function mt(s){const{t:n}=C(),{extension:{name:t,lang:a,versionName:u,isInstalled:o,hasUpdate:r,isObsolete:i,pkgName:h,iconUrl:l,isNsfw:L,repo:v},handleUpdate:p,showSourceRepo:m}=s,[x,y]=d.useState(Se(o,i,r)),O=a==="all"?n("extension.language.all"):a.toUpperCase(),I=async b=>{const j=pt[b],M=dt[b];try{switch(y(M),b){case"INSTALL":await N.updateExtension(h,{install:!0,isObsolete:i}).response;break;case"UNINSTALL":await N.updateExtension(h,{uninstall:!0,isObsolete:i}).response;break;case"UPDATE":await N.updateExtension(h,{update:!0,isObsolete:i}).response;break;default:throw new Error('Unexpected ExtensionAction "'.concat(b,'"'))}y(j),p()}catch(z){y(Se(o,i,r)),w(n(xt[b]),"error")}};function D(){switch(x){case"INSTALL":case"UPDATE":case"UNINSTALL":I(x).catch(U());break;case"OBSOLETE":I("UNINSTALL").catch(U());break}}return e.jsx(ne,{children:e.jsxs(se,{sx:{display:"flex",alignItems:"center",gap:1,p:1.5,"&:last-child":{paddingBottom:1.5}},children:[e.jsx(re,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",background:"transparent"},alt:t,children:e.jsx(te,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:t,src:N.getValidImgUrlFor(l)})}),e.jsxs(k,{sx:{display:"flex",flexDirection:"column",flexGrow:1,flexShrink:1,wordBreak:"break-word",justifyContent:"center"},children:[e.jsx(T,{variant:"h6",component:"h3",children:t}),e.jsxs(T,{variant:"caption",sx:{display:"block"},children:[O," ",u,L&&e.jsx(T,{variant:"caption",color:"error",sx:{display:"inline"},children:" 18+"})]}),m&&e.jsx(T,{variant:"caption",sx:{display:"block"},children:v})]}),e.jsx(P,{variant:"outlined",sx:{color:x===E.OBSOLETE?"red":"inherit",flexShrink:0},onClick:()=>D(),children:n(ht[x])})]})})}const Ee=0,Te=1;function ft(s){const n=[],t={[S.OBSOLETE]:[],[S.INSTALLED]:[],[S.UPDATE_PENDING]:[],[g.ALL]:[],[g.OTHER]:[],[g.LOCAL_SOURCE]:[]};s.forEach(r=>{if(t[r.lang]===void 0&&(t[r.lang]=[],r.lang!=="all"&&n.push(r.lang)),r.isInstalled){if(r.hasUpdate){t[S.UPDATE_PENDING].push(r);return}if(r.isObsolete){t[S.OBSOLETE].push(r);return}t[S.INSTALLED].push(r)}else t[r.lang].push(r)}),n.sort(ee);const a=[[S.OBSOLETE,t[S.OBSOLETE]],[S.UPDATE_PENDING,t[S.UPDATE_PENDING]],[S.INSTALLED,t[S.INSTALLED]],[g.ALL,t[g.ALL]],[g.OTHER,t[g.OTHER]],[g.LOCAL_SOURCE,t[g.LOCAL_SOURCE]]],u=n.map(r=>[r,t[r]]),o=a.concat(u);return o.forEach(([,r])=>r.sort((i,h)=>i.name.localeCompare(h.name))),{allLangs:n,groupedExtensions:o}}function gt({tabsMenuHeight:s}){var xe,me;const{t:n}=C(),{setAction:t}=d.useContext(J),{data:a,loading:u,error:o,refetch:r}=N.useGetServerSettings({notifyOnNetworkStatusChange:!0}),i=!!(a!=null&&a.settings.extensionRepos.length),h=((xe=a==null?void 0:a.settings.extensionRepos.length)!=null?xe:0)>1,l=d.useRef(null),[L,v]=B("shownExtensionLangs",Ve()),[p]=B("showNsfw",!0),[m]=Ne("query",je),[x,y]=d.useState({}),[O,{data:I,loading:D,error:b}]=N.useExtensionListFetch(),j=(me=I==null?void 0:I.fetchExtensions)==null?void 0:me.extensions,M=d.useCallback(()=>y({}),[]);d.useEffect(()=>{O()},[x]);const z=d.useMemo(()=>(j!=null?j:[]).filter(c=>{const f=p||!c.isNsfw;return m?f&&c.name.toLowerCase().includes(m.toLowerCase()):f}),[j,p,m]),{allLangs:le,groupedExtensions:ce}=d.useMemo(()=>ft(z),[z]),A=d.useMemo(()=>ce.filter(c=>c[Te].length>0).filter(c=>We(c[Ee])||L.includes(c[Ee])),[L,ce]),ue=d.useMemo(()=>A.map(c=>c[Te].length),[A]),q=d.useMemo(()=>A.map(([,c])=>c).flat(1),[A]),we=Qe.useCreateGroupedComputeItemKey(ue,d.useCallback(c=>A[c][0],[A]),d.useCallback(c=>q[c].pkgName,[q])),de=c=>{c.name.toLowerCase().endsWith("apk")?(l.current&&(l.current.value=""),w(n("extension.label.installing_file"),"info"),N.installExternalExtension(c).response.then(()=>{M(),w(n("extension.label.installed_successfully"),"success")}).catch(()=>w(n("extension.label.installation_failed"),"error"))):w(n("global.error.label.invalid_file_type"),"error")};d.useLayoutEffect(()=>(t(e.jsxs(e.Fragment,{children:[e.jsx(ze,{}),e.jsx(G,{title:n("extension.action.label.install_external"),children:e.jsx(H,{onClick:()=>{var c;return(c=l.current)==null?void 0:c.click()},size:"large",color:"inherit",children:e.jsx(Xe,{})})}),e.jsx(ve,{shownLangs:L,setShownLangs:v,allLangs:le})]})),()=>{t(null)}),[n,L,le]),d.useEffect(()=>{const c=async _=>{_.preventDefault();const Re=await Ke(_);de(Re[0])},f=_=>{_.preventDefault()};return document.addEventListener("drop",c),document.addEventListener("dragover",f),()=>{document.removeEventListener("drop",c),document.removeEventListener("dragover",f)}},[]);const pe=d.useMemo(()=>e.jsx("input",{type:"file",style:{display:"none"},ref:l,onChange:c=>{var _;const f=(_=c.target.files)==null?void 0:_[0];f&&de(f)}}),[]),Ue=u||D,he=o!=null?o:b;return Ue?e.jsx(Z,{}):he?e.jsx(F,{message:n("global.error.label.failed_to_load_data"),messageExtra:he.message,retry:()=>{o&&r().catch(U()),b&&O().catch(U())}}):!(j!=null&&j.length)&&!i?e.jsxs(e.Fragment,{children:[pe,e.jsxs(Y,{sx:{alignItems:"center",justifyContent:"center",rowGap:"10px",paddingTop:"20px"},children:[e.jsx(T,{children:n("extension.label.add_repository_info")}),e.jsx(P,{component:R,variant:"contained",to:"/settings/browseSettings",children:n("settings.title")})]})]}):e.jsxs(e.Fragment,{children:[pe,e.jsx(Ye,{heightToSubtract:s,overscan:window.innerHeight*.5,groupCounts:ue,groupContent:c=>{const[f]=A[c];return e.jsx(Je,{variant:"h5",component:"h2",isFirstItem:c===0,children:$(f)},f)},computeItemKey:we,itemContent:c=>{const f=q[c];return e.jsx(Ie,{children:e.jsx(mt,{extension:f,handleUpdate:M,showSourceRepo:h})})}})]})}var ae={},Lt=Q;Object.defineProperty(ae,"__esModule",{value:!0});var ye=ae.default=void 0,St=Lt(X()),Et=e;ye=ae.default=(0,St.default)((0,Et.jsx)("path",{d:"M14.94 4.66h-4.72l2.36-2.36zm-4.69 14.71h4.66l-2.33 2.33zM6.1 6.27 1.6 17.73h1.84l.92-2.45h5.11l.92 2.45h1.84L7.74 6.27zm-1.13 7.37 1.94-5.18 1.94 5.18zm10.76 2.5h6.12v1.59h-8.53v-1.29l5.92-8.56h-5.88v-1.6h8.3v1.26z"}),"SortByAlpha");var ie={},Tt=Q;Object.defineProperty(ie,"__esModule",{value:!0});var Oe=ie.default=void 0,Nt=Tt(X()),jt=e;Oe=ie.default=(0,Nt.default)((0,jt.jsx)("path",{d:"M20 10V8h-4V4h-2v4h-4V4H8v4H4v2h4v4H4v2h4v4h2v-4h4v4h2v-4h4v-2h-4v-4zm-6 4h-4v-4h4z"}),"Tag");const vt=({id:s,name:n,lang:t,iconUrl:a,mangaCount:u})=>{const{t:o}=C(),i=Number(s)===0?o("source.local_source.title"):n;return e.jsx(ne,{children:e.jsx(be,{component:R,to:"/migrate/source/".concat(s,"/"),children:e.jsxs(se,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",p:1.5},children:[e.jsxs(k,{sx:{display:"flex"},children:[e.jsx(re,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",mr:1,background:"transparent"},children:e.jsx(te,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:i,src:N.getValidImgUrlFor(a)})}),e.jsxs(k,{sx:{display:"flex",flexDirection:"column",justifyContent:"center"},children:[e.jsx(T,{variant:"h6",component:"h3",children:i}),e.jsx(T,{variant:"caption",sx:{display:"block"},children:$(t)})]})]}),e.jsx(st,{sx:{borderRadius:1},size:"small",label:u})]})})})},bt=(s,{sortBy:n,sortOrder:t})=>{if(!s)return[];const a={};s.forEach(({sourceId:o,source:r})=>{var h;const i=(h=a[o])!=null?h:{id:o,name:o,lang:"unknown",iconUrl:null,mangaCount:0,...r};a[o]={...i,mangaCount:i.mangaCount+1}});const u=Object.values(a).toSorted((o,r)=>{switch(n){case fe.SOURCE_NAME:return o.name.localeCompare(r.name);case fe.MANGA_COUNT:return o.mangaCount-r.mangaCount;default:throw new Error('Unexpected "sortBy" "'.concat(n,'"'))}});switch(t){case ge.ASC:return u;case ge.DESC:return u.toReversed();default:throw new Error('Unexpected "sortOrder" "'.concat(t,'"'))}},It=({tabsMenuHeight:s})=>{const{t:n}=C(),{appBarHeight:t}=Me(),{settings:{migrateSortSettings:a}}=Pe(),u=Fe(()=>w(n("global.error.label.failed_to_save_changes"),"error")),{sortBy:o,sortOrder:r}=a,{data:i,loading:h,error:l,refetch:L}=N.useGetMigratableSources({notifyOnNetworkStatusChange:!0}),v=d.useMemo(()=>bt(i==null?void 0:i.mangas.nodes,a),[i==null?void 0:i.mangas.nodes,a]);return h?e.jsx(Z,{}):l?e.jsx(F,{message:n("global.error.label.failed_to_load_data"),messageExtra:l.message,retry:()=>L().catch(U())}):e.jsxs(e.Fragment,{children:[e.jsxs(Y,{sx:{position:"sticky",top:"".concat(t+s,"px"),flexDirection:"row",justifyContent:"end",alignItems:"center",gap:1,p:1,backgroundColor:"background.default",zIndex:1},children:[e.jsx(G,{title:n(Be[o]),children:e.jsx(H,{size:"large",color:"inherit",onClick:()=>u("migrateSortSettings",{sortBy:(o+1)%2,sortOrder:r}),children:o?e.jsx(Oe,{}):e.jsx(ye,{})})}),e.jsx(G,{title:n(Ge[r]),children:e.jsx(H,{size:"large",color:"inherit",onClick:()=>u("migrateSortSettings",{sortBy:o,sortOrder:(r+1)%2}),children:r?e.jsx(tt,{}):e.jsx(nt,{})})})]}),e.jsx(He,{sx:{p:0},children:v.map(p=>e.jsx(Ie,{children:e.jsx(vt,{...p})},p.id))})]})};function _n(){const{t:s}=C(),{setTitle:n}=d.useContext(J);d.useLayoutEffect(()=>{n(s("global.label.browse"))},[s]);const t=d.useRef(null),[a,u]=d.useState(0);$e(t,d.useCallback(()=>u(t.current.offsetHeight),[t.current]));const[o,r]=Ne("tab",je,{}),i=o!=null?o:"source";return o||r(i,"replaceIn"),e.jsxs(Ze,{children:[e.jsxs(et,{ref:t,variant:"fullWidth",value:i,onChange:(h,l)=>r(l,"replaceIn"),children:[e.jsx(W,{value:"source",sx:{textTransform:"none"},label:s("source.title_one")}),e.jsx(W,{value:"extensions",sx:{textTransform:"none"},label:s("extension.title_other")}),e.jsx(W,{value:"migrate",sx:{textTransform:"none"},label:s("migrate.title")})]}),e.jsx(K,{index:"source",currentIndex:i,children:e.jsx(ut,{})}),e.jsx(K,{index:"extensions",currentIndex:i,children:e.jsx(gt,{tabsMenuHeight:a})}),e.jsx(K,{index:"migrate",currentIndex:i,children:e.jsx(It,{tabsMenuHeight:a})})]})}export{_n as Browse};
