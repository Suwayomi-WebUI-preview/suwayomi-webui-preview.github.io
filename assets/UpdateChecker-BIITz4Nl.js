import{c as M,j as e,u as U,O as _,b as g,r as i,f as j,a5 as E,C as G,I as R,a4 as P,S,a6 as L,a7 as w,ax as y,m as v,g as T}from"./index-C3WByR-J.js";import{R as F}from"./Refresh-B1Ucy-WH.js";import{P as H}from"./Progress-CpAGDcOS.js";import{d as J}from"./DateHelper-CLUGbQ23.js";const q=M(e.jsx("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}));let o=!1;function Q({categoryId:p,handleFinishedUpdate:n}){const{t}=U(),d=_.useIsTouchDevice(),[m,b]=g.useState(!1),{data:l,refetch:f}=i.useGetLastGlobalUpdateTimestamp(),x=l==null?void 0:l.lastUpdateTimestamp.timestamp,{data:c}=i.useGetGlobalUpdateSummary(),a=c==null?void 0:c.libraryUpdateStatus,r=!!(a!=null&&a.jobsInfo.isRunning),h=a?a.jobsInfo.finishedJobs/a.jobsInfo.totalJobs*100:0;g.useEffect(()=>{!o&&r&&(o=!0),o&&h===100&&(o=!1,n==null||n(),f().catch(j()))},[r]);const I=async s=>{try{o=!0,await i.startGlobalUpdate(s!==void 0?[s]:void 0).response,f().catch(j("UpdateChecker::reFetchLastTimestamp"))}catch(k){o=!1,v(t("global.error.label.update_failed"),"error",T(k))}},C=async()=>{try{await i.resetGlobalUpdate()}catch(s){v(t("library.error.label.stop_global_update"),"error",T(s))}},u=async s=>{r?C():I(s)};return e.jsx(E,{variant:"popover",popupId:"library-update-checker-menu",children:s=>e.jsxs(e.Fragment,{children:[e.jsx(G,{title:r?t("library.action.label.stop_update"):t("library.settings.global_update.label.last_update_tooltip",{date:x?J.format(+x):"-"}),children:e.jsx(R,{sx:{position:"relative"},...p!==void 0&&!r?P(s):{onClick:()=>u()},onMouseEnter:()=>b(!0),onMouseLeave:()=>b(!1),color:"inherit",children:r?e.jsxs(e.Fragment,{children:[e.jsx(q,{sx:{opacity:Number(d||m)}}),e.jsx(S,{sx:{position:"absolute"},children:e.jsx(H,{progress:h,showText:!d&&!m,progressProps:{color:"inherit"}})})]}):e.jsx(F,{})})}),e.jsxs(L,{...w(s),children:[e.jsx(y,{onClick:()=>{s.close(),u()},children:t("library.action.label.update_library")}),e.jsx(y,{onClick:()=>{s.close(),u(p)},children:t("library.action.label.update_category")})]})]})})}export{q as C,Q as U};
