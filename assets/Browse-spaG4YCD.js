import{r as se,i as ne,j as e,u as I,M as Fe,C as re,a as Ce,L as M,A,b as oe,B as U,S as ae,c as S,T as m,d as ie,e as D,f as l,N as le,g as z,h as He,k as $,I as q,l as ce,E as V,m as N,n as O,o as _,p as Ge,q as ze,s as $e,t as qe,v as Ve,w as We,x as be,y as ye,z as Ke,D as Xe,F as Qe,G as Z,H as ee}from"./index-CdMcb195.js";import{u as _e,S as Ne,A as Ye}from"./AppbarSearch-B_2neIxw.js";import{s as Le,l as Ie,D as W,a as Je,e as Ze}from"./Languages-DFkVStzf.js";import{SourceContentType as te}from"./SourceMangas-BnIJvU4B.js";import{t as K,L as Ae,g as G,I as et,a as tt,E as Oe,b as T,c as ke,d as st,e as nt,f as rt,i as ot,h as at}from"./LangSelect-ygaV5m1k.js";import{A as ue}from"./Avatar-Ct8d5o_D.js";import{f as it}from"./file-selector-CIas8os3.js";import{V as lt,S as ct,a as ut,b as Re}from"./Virtuoso.util-X2kl8SCm.js";import{T as dt}from"./TabsWrapper-BN1ho33g.js";import{d as ht,a as pt}from"./SortRadioInput-DT20Mj1T.js";import{C as xt}from"./Chip-DbdfJyI_.js";import"./useManageMangaLibraryState-KmbQ71__.js";import"./Trackers-D4pSmk7a.js";import"./Info-BSYioBHW.js";import"./TextField-DkLSmkb0.js";import"./InputAdornment-BGaBK0bW.js";import"./CheckCircle-DWvfCuQo.js";import"./Mangas-CzvEKOUW.js";import"./ListPreference-CUwS6a0A.js";import"./NumberSetting-UX0icsce.js";import"./useMobilePicker-BOYaXgKY.js";import"./SelectSetting-C5gfJX-r.js";import"./ThreeStateCheckboxInput-GKATmTG8.js";import"./ExpandMore-Du064NeC.js";import"./FilterList-Cv9T65hF.js";import"./GridLayouts-vt7PDl5Z.js";import"./useDebounce-BCSw4Kix.js";import"./StyledFab-r6IH_f0C.js";import"./BaseMangaGrid-BGdslGf4.js";import"./MangaGrid-D7WZD9JN.js";import"./Sync-6H_6mf7K.js";import"./PlayArrow-BRV_mkpZ.js";import"./cloneObject-DrOPTG0J.js";import"./Switch-C04UYt68.js";var de={},ft=ne;Object.defineProperty(de,"__esModule",{value:!0});var Me=de.default=void 0,gt=ft(se()),mt=e;Me=de.default=(0,gt.default)((0,mt.jsx)("path",{d:"M19.3 16.9c.4-.7.7-1.5.7-2.4 0-2.5-2-4.5-4.5-4.5S11 12 11 14.5s2 4.5 4.5 4.5c.9 0 1.7-.3 2.4-.7l3.2 3.2 1.4-1.4zm-3.8.1c-1.4 0-2.5-1.1-2.5-2.5s1.1-2.5 2.5-2.5 2.5 1.1 2.5 2.5-1.1 2.5-2.5 2.5M12 20v2C6.48 22 2 17.52 2 12S6.48 2 12 2c4.84 0 8.87 3.44 9.8 8h-2.07c-.64-2.46-2.4-4.47-4.73-5.41V5c0 1.1-.9 2-2 2h-2v2c0 .55-.45 1-1 1H8v2h2v3H9l-4.79-4.79C4.08 10.79 4 11.38 4 12c0 4.41 3.59 8 8 8"}),"TravelExplore");const jt=c=>{const{t}=I(),n=Fe.useIsMobileWidth(),{source:{id:r,name:d,lang:s,iconUrl:h,supportsLatest:o,isNsfw:f,extension:{repo:a}},showSourceRepo:j}=c,u=Number(r)===0?t("source.local_source.title"):d;return e.jsx(re,{sx:{margin:1,marginTop:0},children:e.jsx(Ce,{component:M,to:A.sources.childRoutes.browse.path(r),state:{contentType:te.POPULAR,clearCache:!0},children:e.jsxs(oe,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:1.5},children:[e.jsxs(U,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(ue,{variant:"rounded",alt:u,sx:{width:56,height:56,flex:"0 0 auto",mr:1,background:"transparent"},children:e.jsx(ae,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:u,src:S.getValidImgUrlFor(h)})}),e.jsxs(U,{sx:{display:"flex",flexDirection:"column",justifyContent:"center"},children:[e.jsx(m,{variant:"h6",component:"h3",children:u}),e.jsxs(m,{variant:"caption",sx:{display:"block"},children:[K(s),f&&e.jsx(m,{variant:"caption",color:"error",sx:{display:"inline"},children:" 18+"}),j&&e.jsx(m,{variant:"caption",sx:{display:"block"},children:a})]})]})]}),e.jsxs(ie,{sx:{flexDirection:"row",gap:1},children:[o&&e.jsx(D,{variant:"outlined",component:M,to:A.sources.childRoutes.browse.path(r),state:{contentType:te.LATEST,clearCache:!0},children:t("global.button.latest")}),!n&&e.jsx(D,{variant:"outlined",component:M,to:A.sources.childRoutes.browse.path(r),state:{contentType:te.POPULAR,clearCache:!0},children:t("global.button.popular")})]})]})})})};function St(c){const t=new Set;return c.forEach(n=>{const d=Number(n.id)===0?W.OTHER:n.lang;t.add(d)}),[...t].sort(Ie)}function vt(c){const t={};return c.forEach(n=>{var s;const d=Number(n.id)===0?W.OTHER:n.lang;(s=t[d])!=null||(t[d]=[]),t[d].push(n)}),Object.values(t).forEach(n=>n.sort((r,d)=>r.name.localeCompare(d.name))),t}function Et(){const{t:c}=I(),{setAction:t}=l.useContext(le),[n,r]=z("shownSourceLangs",Je()),[d]=z("showNsfw",!0),{data:s,loading:h,error:o,refetch:f}=S.useGetSourceList({notifyOnNetworkStatusChange:!0}),a=s==null?void 0:s.sources.nodes,j=l.useMemo(()=>{if(!a||a!=null&&a.length)return!1;const{repo:u}=a[0].extension;return a.some(g=>g.extension.repo!==u)},[a]),L=He();return l.useEffect(()=>{Le().forEach(u=>{let g=!1;n.forEach(x=>{x===u&&(g=!0)}),g||r(x=>(x.push(u),x))})},[]),l.useLayoutEffect(()=>(t(e.jsxs(e.Fragment,{children:[e.jsx($,{title:c("search.title.global_search"),children:e.jsx(q,{onClick:()=>L(A.sources.childRoutes.searchAll.path),size:"large",color:"inherit",children:e.jsx(Me,{})})}),e.jsx(Ae,{shownLangs:n,setShownLangs:r,allLangs:St(a!=null?a:[]),forcedLangs:Le()})]})),()=>{t(null)}),[c,n,a]),h?e.jsx(ce,{}):o?e.jsx(V,{message:c("global.error.label.failed_to_load_data"),messageExtra:N(o),retry:()=>f().catch(O())}):(a==null?void 0:a.length)===0?e.jsx(V,{message:c("source.error.label.no_sources_found")}):e.jsx(e.Fragment,{children:Object.entries(vt(a!=null?a:[])).sort((u,g)=>Ie(u[0],g[0])).map(([u,g])=>(u===W.OTHER||n.includes(u))&&e.jsxs(l.Fragment,{children:[e.jsx(m,{variant:"h5",component:"h2",sx:{paddingLeft:3,paddingTop:1,paddingBottom:2,fontWeight:"bold"},children:K(u)},u),g.filter(x=>{if(u===W.OTHER){const v=Number(x.id)===0;if(!(n.includes(u)||v))return!1}return d||!x.isNsfw}).map(x=>e.jsx(jt,{source:x,showSourceRepo:j},x.id))]},u))})}function bt(c){const{t}=I(),{extension:{name:n,lang:r,versionName:d,isInstalled:s,hasUpdate:h,isObsolete:o,pkgName:f,iconUrl:a,isNsfw:j,repo:L},handleUpdate:u,showSourceRepo:g,forcedState:x}=c,[B,v]=l.useState(G(s,o,h)),E=x!=null?x:B;l.useEffect(()=>{v(G(s,o,h))},[G(s,o,h)]);const P=r==="all"?t("extension.language.all"):r.toUpperCase(),k=async w=>{const F=st[w],R=nt[w];try{switch(v(R),w){case T.INSTALL:await S.updateExtension(f,{install:!0,isObsolete:o}).response;break;case T.UNINSTALL:await S.updateExtension(f,{uninstall:!0,isObsolete:o}).response;break;case T.UPDATE:await S.updateExtension(f,{update:!0,isObsolete:o}).response;break;default:throw new Error('Unexpected ExtensionAction "'.concat(w,'"'))}v(F),u()}catch(H){v(G(s,o,h)),_(t(ke[w],{count:1}),"error",N(H))}};function b(){switch(E){case T.INSTALL:case T.UPDATE:case T.UNINSTALL:k(E).catch(O());break;case Oe.OBSOLETE:k(T.UNINSTALL).catch(O());break}}return e.jsx(re,{children:e.jsxs(oe,{sx:{display:"flex",alignItems:"center",gap:1,p:1.5,"&:last-child":{paddingBottom:1.5}},children:[e.jsx(ue,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",background:"transparent"},alt:n,children:e.jsx(ae,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:n,src:S.getValidImgUrlFor(a)})}),e.jsxs(U,{sx:{display:"flex",flexDirection:"column",flexGrow:1,flexShrink:1,wordBreak:"break-word",justifyContent:"center"},children:[e.jsx(m,{variant:"h6",component:"h3",children:n}),e.jsxs(m,{variant:"caption",sx:{display:"block"},children:[P," ",d,j&&e.jsx(m,{variant:"caption",color:"error",sx:{display:"inline"},children:" 18+"})]}),g&&e.jsx(m,{variant:"caption",sx:{display:"block"},children:L})]}),e.jsx(D,{variant:"outlined",sx:{color:E===et.OBSOLETE?"red":"inherit",flexShrink:0},onClick:()=>b(),children:t(tt[E])})]})})}const we=0,Te=1;function yt({tabsMenuHeight:c}){var Se,ve;const{t}=I(),{setAction:n}=l.useContext(le),{data:r,loading:d,error:s,refetch:h}=S.useGetServerSettings({notifyOnNetworkStatusChange:!0}),o=!!(r!=null&&r.settings.extensionRepos.length),f=((Se=r==null?void 0:r.settings.extensionRepos.length)!=null?Se:0)>1,a=l.useRef(null),[j,L]=z("shownExtensionLangs",Ze()),[u]=z("showNsfw",!0),[g]=_e("query",Ne),[x,B]=l.useState({}),[v,{data:E,loading:P,error:k}]=S.useExtensionListFetch(),b=(ve=E==null?void 0:E.fetchExtensions)==null?void 0:ve.extensions,[w,F]=l.useState([]),R=l.useCallback(()=>B({}),[]);l.useEffect(()=>{v()},[x]);const H=l.useMemo(()=>(b!=null?b:[]).filter(i=>{const p=u||!i.isNsfw;return g?p&&i.name.toLowerCase().includes(g.toLowerCase()):p}),[b,u,g]),{allLangs:xe,groupedExtensions:X}=l.useMemo(()=>rt(H),[H]),C=l.useMemo(()=>X.filter(i=>i[Te].length>0).filter(i=>ot(i[we])||j.includes(i[we])),[j,X]),fe=l.useMemo(()=>C.map(i=>i[Te].length),[C]),Q=l.useMemo(()=>C.map(([,i])=>i).flat(1),[C]),Be=lt.useCreateGroupedComputeItemKey(fe,l.useCallback(i=>C[i][0],[C]),l.useCallback(i=>Q[i].pkgName,[Q])),ge=i=>{i.name.toLowerCase().endsWith("apk")?(a.current&&(a.current.value=""),_(t("extension.label.installing_file"),"info"),S.installExternalExtension(i).response.then(()=>{R(),_(t("extension.label.installed_successfully"),"success")}).catch(p=>_(t("extension.label.installation_failed"),"error",N(p)))):_(t("global.error.label.invalid_file_type"),"error")};l.useLayoutEffect(()=>(n(e.jsxs(e.Fragment,{children:[e.jsx(Ye,{}),e.jsx($,{title:t("extension.action.label.install_external"),children:e.jsx(q,{onClick:()=>{var i;return(i=a.current)==null?void 0:i.click()},size:"large",color:"inherit",children:e.jsx(Ge,{})})}),e.jsx(Ae,{shownLangs:j,setShownLangs:L,allLangs:xe})]})),()=>{n(null)}),[t,j,xe]),l.useEffect(()=>{const i=async y=>{y.preventDefault();const Y=await it(y);ge(Y[0])},p=y=>{y.preventDefault()};return document.addEventListener("drop",i),document.addEventListener("dragover",p),()=>{document.removeEventListener("drop",i),document.removeEventListener("dragover",p)}},[]);const me=l.useMemo(()=>e.jsx("input",{type:"file",style:{display:"none"},ref:a,onChange:i=>{var y;const p=(y=i.target.files)==null?void 0:y[0];p&&ge(p)}}),[]),Pe=d||P,je=s!=null?s:k;return Pe?e.jsx(ce,{}):je?e.jsx(V,{message:t("global.error.label.failed_to_load_data"),messageExtra:N(je),retry:()=>{s&&h().catch(O()),k&&v().catch(O())}}):!(b!=null&&b.length)&&!o?e.jsxs(e.Fragment,{children:[me,e.jsxs(ie,{sx:{alignItems:"center",justifyContent:"center",rowGap:"10px",paddingTop:"20px"},children:[e.jsx(m,{children:t("extension.label.add_repository_info")}),e.jsx(D,{component:M,variant:"contained",to:A.browse.path,children:t("settings.title")})]})]}):e.jsxs(e.Fragment,{children:[me,e.jsx(ct,{heightToSubtract:c,overscan:window.innerHeight*.5,groupCounts:fe,groupContent:i=>{const[p,y]=C[i],Y=p===at.UPDATE_PENDING;return e.jsxs(ut,{isFirstItem:i===0,sx:{flexDirection:"row",justifyContent:"space-between",alignItems:"center",pr:1},children:[e.jsx(m,{variant:"h5",component:"h2",children:K(p)}),Y&&e.jsx(D,{disabled:!!w.length,variant:"contained",onClick:()=>{const Ee=y.map(J=>J.pkgName);F(Ee),S.updateExtensions(Ee,{update:!0}).response.then(()=>R()).catch(J=>_(t(ke[T.UPDATE],{count:X.length}),"error",N(J))).finally(()=>F([]))},children:t("extension.action.label.update_all")})]},p)},computeItemKey:Be,itemContent:i=>{const p=Q[i];return e.jsx(Re,{children:e.jsx(bt,{extension:p,handleUpdate:R,showSourceRepo:f,forcedState:w.includes(p.pkgName)?Oe.UPDATING:void 0})})}})]})}var he={},Lt=ne;Object.defineProperty(he,"__esModule",{value:!0});var Ue=he.default=void 0,wt=Lt(se()),Tt=e;Ue=he.default=(0,wt.default)((0,Tt.jsx)("path",{d:"M14.94 4.66h-4.72l2.36-2.36zm-4.69 14.71h4.66l-2.33 2.33zM6.1 6.27 1.6 17.73h1.84l.92-2.45h5.11l.92 2.45h1.84L7.74 6.27zm-1.13 7.37 1.94-5.18 1.94 5.18zm10.76 2.5h6.12v1.59h-8.53v-1.29l5.92-8.56h-5.88v-1.6h8.3v1.26z"}),"SortByAlpha");var pe={},Ct=ne;Object.defineProperty(pe,"__esModule",{value:!0});var De=pe.default=void 0,_t=Ct(se()),Nt=e;De=pe.default=(0,_t.default)((0,Nt.jsx)("path",{d:"M20 10V8h-4V4h-2v4h-4V4H8v4H4v2h4v4H4v2h4v4h2v-4h4v4h2v-4h4v-2h-4v-4zm-6 4h-4v-4h4z"}),"Tag");const It=({id:c,name:t,lang:n,iconUrl:r,mangaCount:d})=>{const{t:s}=I(),o=Number(c)===0?s("source.local_source.title"):t;return e.jsx(re,{children:e.jsx(Ce,{component:M,to:A.migrate.path(c),children:e.jsxs(oe,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",p:1.5},children:[e.jsxs(U,{sx:{display:"flex"},children:[e.jsx(ue,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",mr:1,background:"transparent"},children:e.jsx(ae,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:o,src:S.getValidImgUrlFor(r)})}),e.jsxs(U,{sx:{display:"flex",flexDirection:"column",justifyContent:"center"},children:[e.jsx(m,{variant:"h6",component:"h3",children:o}),e.jsx(m,{variant:"caption",sx:{display:"block"},children:K(n)})]})]}),e.jsx(xt,{sx:{borderRadius:1},size:"small",label:d})]})})})},At=(c,{sortBy:t,sortOrder:n})=>{if(!c)return[];const r={};c.forEach(({sourceId:s,source:h})=>{var f;const o=(f=r[s])!=null?f:{id:s,name:s,lang:"unknown",iconUrl:null,mangaCount:0,...h};r[s]={...o,mangaCount:o.mangaCount+1}});const d=Object.values(r).toSorted((s,h)=>{switch(t){case be.SOURCE_NAME:return s.name.localeCompare(h.name);case be.MANGA_COUNT:return s.mangaCount-h.mangaCount;default:throw new Error('Unexpected "sortBy" "'.concat(t,'"'))}});switch(n){case ye.ASC:return d;case ye.DESC:return d.toReversed();default:throw new Error('Unexpected "sortOrder" "'.concat(n,'"'))}},Ot=({tabsMenuHeight:c})=>{const{t}=I(),{appBarHeight:n}=ze(),{settings:{migrateSortSettings:r}}=$e(),d=Ke(u=>_(t("global.error.label.failed_to_save_changes"),"error",N(u))),{sortBy:s,sortOrder:h}=r,{data:o,loading:f,error:a,refetch:j}=S.useGetMigratableSources({notifyOnNetworkStatusChange:!0}),L=l.useMemo(()=>At(o==null?void 0:o.mangas.nodes,r),[o==null?void 0:o.mangas.nodes,r]);return f?e.jsx(ce,{}):a?e.jsx(V,{message:t("global.error.label.failed_to_load_data"),messageExtra:N(a),retry:()=>j().catch(O())}):e.jsxs(e.Fragment,{children:[e.jsxs(ie,{sx:{position:"sticky",top:"".concat(n+c,"px"),flexDirection:"row",justifyContent:"end",alignItems:"center",gap:1,p:1,backgroundColor:"background.default",zIndex:1},children:[e.jsx($,{title:t(qe[s]),children:e.jsx(q,{size:"large",color:"inherit",onClick:()=>d("migrateSortSettings",{sortBy:(s+1)%2,sortOrder:h}),children:s?e.jsx(De,{}):e.jsx(Ue,{})})}),e.jsx($,{title:t(Ve[h]),children:e.jsx(q,{size:"large",color:"inherit",onClick:()=>d("migrateSortSettings",{sortBy:s,sortOrder:(h+1)%2}),children:h?e.jsx(ht,{}):e.jsx(pt,{})})})]}),e.jsx(We,{sx:{p:0},children:L.map(u=>e.jsx(Re,{children:e.jsx(It,{...u})},u.id))})]})};function xs(){const{t:c}=I(),{setTitle:t}=l.useContext(le);l.useLayoutEffect(()=>{t(c("global.label.browse"))},[c]);const n=l.useRef(null),[r,d]=l.useState(0);Xe(n,l.useCallback(()=>d(n.current.offsetHeight),[n.current]));const[s,h]=_e("tab",Ne,{}),o=s!=null?s:"source";return s||h(o,"replaceIn"),e.jsxs(dt,{children:[e.jsxs(Qe,{ref:n,variant:"fullWidth",value:o,onChange:(f,a)=>h(a,"replaceIn"),children:[e.jsx(Z,{value:"source",sx:{textTransform:"none"},label:c("source.title_one")}),e.jsx(Z,{value:"extensions",sx:{textTransform:"none"},label:c("extension.title_other")}),e.jsx(Z,{value:"migrate",sx:{textTransform:"none"},label:c("migrate.title")})]}),e.jsx(ee,{index:"source",currentIndex:o,children:e.jsx(Et,{})}),e.jsx(ee,{index:"extensions",currentIndex:o,children:e.jsx(yt,{tabsMenuHeight:r})}),e.jsx(ee,{index:"migrate",currentIndex:o,children:e.jsx(Ot,{tabsMenuHeight:r})})]})}export{xs as Browse};
