import{c as z,j as e,u as L,r as n,g as W,i,l as w,I as h,Q as g,q as b,n as j,o as P,m as G,E as k,R as X,U as _,B as Y,C as J,a as Z,A as $,L as ee,b as te,f as C,d as oe,T as q,V as ae,W as re,X as se,Y as ne}from"./index-BgT5c6fp.js";import{D as le,a as ie,c as de,S as ce,v as pe,b as ue,d as he,e as xe}from"./DndOverlayItem-CG___qRB.js";import{P as me}from"./PlayArrow-C67GgLrn.js";const ge=z(e.jsx("path",{d:"M6 19h4V5H6zm8-14v14h4V5z"})),je=z(e.jsx("path",{d:"M15 16h4v2h-4zm0-8h7v2h-7zm0 4h6v2h-6zM3 18c0 1.1.9 2 2 2h6c1.1 0 2-.9 2-2V8H3zM14 5h-3l-1-1H6L5 5H2v2h12z"})),A=i.memo(({item:o,handleDelete:v,handleRetry:D})=>{const{t:d}=L();return e.jsx(Y,{sx:{p:1,pb:0},children:e.jsx(J,{children:e.jsx(Z,{component:ee,to:$.manga.path(o.manga.id),children:e.jsxs(te,{sx:{display:"flex",alignItems:"center",p:1.5},children:[e.jsx(h,{...C.preventRippleProp(),sx:{pointerEvents:"none"},children:e.jsx(xe,{})}),e.jsxs(oe,{sx:{flex:1,ml:1},direction:"column",children:[e.jsx(q,{variant:"h6",component:"h3",children:o.manga.title}),e.jsx(q,{variant:"caption",sx:{display:"block"},children:o.chapter.name})]}),e.jsx(ae,{chapterId:o.chapter.id}),o.state===re.Error&&e.jsx(w,{title:d("global.button.retry"),children:e.jsx(h,{...C.preventRippleProp(),onClick:l=>{l.preventDefault(),l.stopPropagation(),D(o.chapter)},children:e.jsx(se,{})})}),e.jsx(w,{title:d("chapter.action.download.delete.label.action"),children:e.jsx(h,{...C.preventRippleProp(),onClick:l=>{l.preventDefault(),l.stopPropagation(),v(o.chapter)},children:e.jsx(ne,{})})})]})})})})}),fe=()=>{var E,R;const{t:o}=L(),[v,{reset:D}]=n.useReorderChapterInDownloadQueue(),{data:d,loading:l,error:y,refetch:T}=n.useGetDownloadStatus({notifyOnNetworkStatusChange:!0}),c=d==null?void 0:d.downloadStatus,r=(E=c==null?void 0:c.queue)!=null?E:[],p=(R=c==null?void 0:c.state)!=null?R:"STARTED",x=!r.length,{setTitle:S,setAction:I}=W(),M=i.useMemo(()=>r.map(t=>t.chapter),[r]),Q=le.useSensorsForDevice(),[u,m]=i.useState(null),H=async()=>{try{await n.clearDownloads().response}catch(t){b(o("download.queue.error.label.failed_delete_all"),"error",j(t))}},O=()=>{p===g.Stopped?n.startDownloads():n.stopDownloads()};i.useLayoutEffect(()=>(S(o("download.queue.title")),I(e.jsxs(e.Fragment,{children:[e.jsx(w,{title:o("download.queue.label.delete_all"),children:e.jsx(h,{onClick:H,color:"inherit",children:e.jsx(je,{})})}),e.jsx(w,{title:o(p===g.Started?"global.button.start":"global.button.stop"),disabled:x,children:e.jsx(h,{onClick:O,disabled:x,color:"inherit",children:p===g.Stopped?e.jsx(me,{}):e.jsx(ge,{})})})]})),()=>{S(""),I(null)}),[o,p,x]),i.useEffect(()=>{const t=a=>{(a.message==="ResizeObserver loop completed with undelivered notifications."||a.message==="ResizeObserver loop limit exceeded")&&a.stopImmediatePropagation()};return window.addEventListener("error",t),()=>window.removeEventListener("error",t)},[]);const V=(t,a,s)=>{a!==s&&v({variables:{input:{chapterId:t[a].chapter.id,to:s}}}).catch(()=>{D()})},B=t=>{const{active:a,over:s}=t;if(m(null),!s||a.id===s.id)return;const K=r.findIndex(f=>f.chapter.id===a.id),N=r.findIndex(f=>f.chapter.id===s.id);V(r,K,N)},U=i.useCallback(async t=>{try{await n.addChapterToDownloadQueue(t.id).response}catch(a){b(o("download.queue.error.label.failed_to_remove"),"error",j(a))}},[]),F=i.useCallback(async t=>{const a=p===g.Started;try{a&&await n.stopDownloads().response,await Promise.all([n.removeChapterFromDownloadQueue(t.id).response,n.deleteDownloadedChapter(t.id).response])}catch(s){b(o("download.queue.error.label.failed_to_remove"),"error",j(s))}a&&n.startDownloads().response.catch(P())},[]);return l?e.jsx(G,{}):y?e.jsx(k,{message:o("global.error.label.failed_to_load_data"),messageExtra:j(y),retry:()=>T().catch(P())}):x?e.jsx(k,{message:o("download.queue.label.no_downloads")}):e.jsxs(ie,{sensors:Q,collisionDetection:de,onDragStart:t=>{var a;return m((a=r.find(s=>s.chapter.id===t.active.id))!=null?a:null)},onDragEnd:B,onDragCancel:()=>m(null),onDragAbort:()=>m(null),children:[e.jsx(ce,{items:M,strategy:pe,children:e.jsx(X,{useWindowScroll:!0,overscan:window.innerHeight*.5,totalCount:r.length,computeItemKey:t=>r[t].chapter.id,itemContent:t=>e.jsx(ue,{id:r[t].chapter.id,isDragging:r[t].chapter.id===(u==null?void 0:u.chapter.id),children:e.jsx(A,{item:r[t],handleDelete:F,handleRetry:U})})})}),e.jsx(he,{isActive:!!u,children:e.jsx(A,{item:u,handleDelete:_,handleRetry:_})})]})};export{fe as DownloadQueue};
