import{c as J,j as a,u as U,M as _,h as u,r as c,n as C,af as R,k as I,I as E,ag as G,R as P,d as H,bJ as L,ai as N,aj as S,aH as j,o as y,m as v}from"./index-BKHCEc_C.js";import{P as w}from"./Progress-nE-cTEGs.js";const F=J(a.jsx("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Clear"),q=s=>{if(!s)return 0;const r=s.failedJobs.mangas.totalCount+s.completeJobs.mangas.totalCount,t=r+s.pendingJobs.mangas.totalCount+s.runningJobs.mangas.totalCount,i=100*(r/t);return Number.isNaN(i)?0:i};let n=!1;function Q({categoryId:s,handleFinishedUpdate:r}){const{t}=U(),i=_.useIsTouchDevice(),[g,b]=u.useState(!1),{data:p,refetch:f}=c.useGetLastGlobalUpdateTimestamp(),h=p==null?void 0:p.lastUpdateTimestamp.timestamp,{data:d}=c.useGetGlobalUpdateSummary(),e=d==null?void 0:d.updateStatus,l=!!(e!=null&&e.isRunning),x=u.useMemo(()=>q(e),[e==null?void 0:e.failedJobs.mangas.totalCount,e==null?void 0:e.completeJobs.mangas.totalCount,e==null?void 0:e.pendingJobs.mangas.totalCount,e==null?void 0:e.runningJobs.mangas.totalCount]);u.useEffect(()=>{!n&&(e!=null&&e.isRunning)&&(n=!0),n&&x===100&&(n=!1,r==null||r(),f().catch(C()))},[e==null?void 0:e.isRunning]);const M=async o=>{try{n=!0,await c.startGlobalUpdate(o!==void 0?[o]:void 0).response,f().catch(C("UpdateChecker::reFetchLastTimestamp"))}catch(k){n=!1,y(t("global.error.label.update_failed"),"error",v(k))}},T=async()=>{try{await c.resetGlobalUpdate()}catch(o){y(t("library.error.label.stop_global_update"),"error",v(o))}},m=async o=>{l?T():M(o)};return a.jsx(R,{variant:"popover",popupId:"library-update-checker-menu",children:o=>a.jsxs(a.Fragment,{children:[a.jsx(I,{title:l?t("library.action.label.stop_update"):t("library.settings.global_update.label.last_update_tooltip",{date:h?L.format(+h):"-"}),children:a.jsx(E,{sx:{position:"relative"},...s!==void 0&&!l?G(o):{onClick:()=>m()},onMouseEnter:()=>b(!0),onMouseLeave:()=>b(!1),color:"inherit",children:l?a.jsxs(a.Fragment,{children:[a.jsx(F,{sx:{opacity:Number(i||g)}}),a.jsx(H,{sx:{position:"absolute"},children:a.jsx(w,{progress:x,showText:!i&&!g,progressProps:{color:"inherit"}})})]}):a.jsx(P,{})})}),a.jsxs(N,{...S(o),children:[a.jsx(j,{onClick:()=>{o.close(),m()},children:t("library.action.label.update_library")}),a.jsx(j,{onClick:()=>{o.close(),m(s)},children:t("library.action.label.update_category")})]})]})})}export{F as C,Q as U};
