import{a as n,c9 as S,bk as E,bU as k,m as A,F as D}from"./index-3BgSjiAU.js";import{C as p}from"./Chapters-BQSVXONB.js";const v={download:{action:{single:"chapter.action.download.add.label.action",selected:"chapter.action.download.add.button.selected"},success:"chapter.action.download.add.label.success",error:"chapter.action.download.add.label.error"},delete:{action:{single:"chapter.action.download.delete.label.action",selected:"chapter.action.download.delete.button.selected"},success:"chapter.action.download.delete.label.success",error:"chapter.action.download.delete.label.error"},mark_as_read:{action:{single:"chapter.action.mark_as_read.add.label.action.current",selected:"chapter.action.mark_as_read.add.button.selected"},success:"chapter.action.mark_as_read.add.label.success",error:"chapter.action.mark_as_read.add.label.error"},mark_as_unread:{action:{single:"chapter.action.mark_as_read.remove.label.action",selected:"chapter.action.mark_as_read.remove.button.selected"},success:"chapter.action.mark_as_read.remove.label.success",error:"chapter.action.mark_as_read.remove.label.error"},remove_from_library:{action:{single:"manga.action.library.remove.label.action",selected:"manga.action.library.remove.button.selected"},success:"manga.action.library.remove.label.success",error:"manga.action.library.remove.label.error"},change_categories:{action:{single:"manga.action.category.label.action",selected:"manga.action.category.button.selected"},success:"manga.action.category.label.success",error:"manga.action.category.label.error"},migrate:{action:{single:"global.button.migrate",selected:"global.button.migrate"},success:"manga.action.migrate.label.success",error:"manga.action.migrate.label.error"},track:{action:{single:"manga.action.track.add.label.action",selected:"manga.action.track.add.label.action"},success:"manga.action.track.add.label.success",error:"manga.action.track.add.label.error"}};class a{static getIds(e){return e.map(t=>t.id)}static getFromCache(e,t=S,r="MANGA_BASE_FIELDS"){return n.graphQLClient.client.cache.readFragment({id:n.graphQLClient.client.cache.identify({__typename:"MangaType",id:e}),fragment:t,fragmentName:r})}static isNotDownloaded({downloadCount:e}){return e===0}static getNotDownloaded(e){return e.filter(a.isNotDownloaded)}static isFullyDownloaded({downloadCount:e,chapters:{totalCount:t}}){return e===t}static getFullyDownloaded(e){return e.filter(a.isFullyDownloaded)}static isPartiallyDownloaded(e){return!a.isNotDownloaded(e)&&!a.isFullyDownloaded(e)}static getPartiallyDownloaded(e){return e.filter(a.isPartiallyDownloaded)}static isUnread({unreadCount:e,chapters:{totalCount:t}}){return e===t}static getUnread(e){return e.filter(a.isUnread)}static isFullyRead({unreadCount:e}){return e===0}static getFullyRead(e){return e.filter(a.isFullyRead)}static isPartiallyRead(e){return!a.isUnread(e)&&!a.isFullyRead(e)}static getPartiallyRead(e){return e.filter(a.isPartiallyRead)}static getThumbnailUrl(e){const t=e.thumbnailUrl?"".concat(e.thumbnailUrl,"?fetchedAt=").concat(e.thumbnailUrlLastFetched):"";return n.getValidImgUrlFor(t)}static getDuplicateLibraryMangas(e){return n.getMangas(E,{condition:{inLibrary:!0},filter:{title:{likeInsensitive:e}}})}static async getChapterIdsWithState(e,t){const{data:r}=await n.getMangasChapterIdsWithState(e,t).response;return r.chapters.nodes}static async downloadChapters(e,{size:t,onlyUnread:r,downloadAhead:c=!1}={}){const[o,s]=await Promise.all([a.getChapterIdsWithState(e,{isRead:r?!1:void 0,isDownloaded:!1}),c?a.getChapterIdsWithState(e,{isRead:!1,isDownloaded:!0}):[]]),i=e.map(d=>[String(d),t]),u=Object.groupBy(o,({mangaId:d})=>d),l=Object.groupBy(s,({mangaId:d})=>d),w=Object.entries(l).map(([d,g=[]])=>{const h=Math.max(0,(t!=null?t:g.length)-g.length);return[d,c?h:t]}),b=Object.entries(Object.fromEntries([...i,...w])).map(([d,g])=>{var C;const h=(C=u[Number(d)])!=null?C:[];if(!h.length)return[];if(g===void 0)return h;const R=p.removeDuplicates(h[0],h).slice(0,g);return p.addDuplicates(R,h)}).flat();return b.length?p.download(p.getIds(b)):Promise.resolve()}static async deleteChapters(e){const t=await a.getChapterIdsWithState(e,{isDownloaded:!0});return p.delete(p.getIds(t))}static async markAsRead(e,t=!1){const r=await a.getChapterIdsWithState(e,{isRead:!1});return p.markAsRead(r,t,e.length===1?e[0]:void 0)}static async markAsUnread(e){const t=await a.getChapterIdsWithState(e,{isRead:!0});return p.markAsUnread(p.getIds(t))}static async removeFromLibrary(e){const{removeMangaFromCategories:t}=await k();return a.executeAction("remove_from_library",e.length,()=>n.updateMangas(e,{updateMangas:{inLibrary:!1},updateMangasCategories:t?{clearCategories:!0}:void 0}).response)}static async changeCategories(e,t){return a.executeAction("change_categories",e.length,()=>n.updateMangasCategories(e,t).response)}static migrateChapters(e,t,r){var l,w;if(!t.chapters||!((l=r.fetchChapters)!=null&&l.chapters))throw new Error("Chapters are missing");const c=t.chapters.nodes,o=(w=r.fetchChapters)==null?void 0:w.chapters,s=p.getMatchingChapterNumberChapters(c,o),i=[],u=[];return s.forEach(([m,b])=>{const{isRead:d,isBookmarked:g}=m;d&&i.push(b.id),g&&u.push(b.id)}),{copy:()=>[i.length&&n.updateChapters(i,{isRead:!0}).response,u.length&&n.updateChapters(u,{isBookmarked:!0}).response].filter(m=>!!m),cleanup:()=>{var m,b;return e==="migrate"?[n.deleteDownloadedChapters(p.getIds(p.getDownloaded((b=(m=t.chapters)==null?void 0:m.nodes)!=null?b:[]))).response]:[]}}}static migrateTracking(e,t,r){if(!t.trackRecords)throw new Error("TrackRecords of manga to migrate are missing");if(!r.trackRecords)throw new Error("TrackRecords of manga to migrate to are missing");const c=t.trackRecords.nodes.filter(o=>{var s;return(s=r.trackRecords)==null?void 0:s.nodes.every(i=>o.remoteId!==i.remoteId)});return{copy:()=>c.map(o=>n.bindTracker(r.id,o.trackerId,o.remoteId).response),cleanup:()=>{var o,s;return e==="migrate"?(s=(o=t.trackRecords)==null?void 0:o.nodes.map(i=>n.unbindTracker(i.id).response))!=null?s:[]:[]}}}static migrateManga(e,t,r,c,o){if(!(t!=null&&t.categories))throw new Error("Categories are missing");return{copy:()=>{var s;return[n.updateManga(r.id,{updateManga:{inLibrary:!0},updateMangaCategories:c?{addToCategories:(s=t.categories)==null?void 0:s.nodes.map(i=>i.id)}:void 0}).response]},cleanup:()=>e==="migrate"?[n.updateManga(t.id,{updateManga:{inLibrary:!1},updateMangaCategories:o?{clearCategories:!0}:void 0}).response]:[]}}static async migrate(e,t,{mode:r,migrateChapters:c,migrateCategories:o,migrateTracking:s,deleteChapters:i}){return a.executeAction("migrate",1,async()=>{var d,g;const[{data:u},{data:l},{removeMangaFromCategories:w}]=await Promise.all([n.getMangaToMigrate(e,{migrateChapters:c,migrateCategories:o,migrateTracking:s,deleteChapters:i}).response,n.getMangaToMigrateToFetch(t,{migrateChapters:c,migrateCategories:o,migrateTracking:s,apolloOptions:{errorPolicy:"all"}}).response,k()]);if(!u.manga||!((d=l==null?void 0:l.fetchManga)!=null&&d.manga))throw new Error("Mangas::migrate: missing manga data");if(c&&!u.manga.chapters)throw new Error("Mangas::migrate: missing chapters data");(g=l.fetchChapters)!=null&&g.chapters||(l.fetchChapters={chapters:[]});const m=async(h,...y)=>Promise.all(y.filter(([f])=>f).map(([,f])=>f[h]()).flat());await(async(...h)=>{const y=["copy","cleanup"];for(const f of y)await m(f,...h)})([c,a.migrateChapters(r,u.manga,l)],[s,a.migrateTracking(r,u.manga,l.fetchManga.manga)],[!0,a.migrateManga(r,u.manga,l.fetchManga.manga,!!o,w)])})}static async executeAction(e,t,r){try{await r(),A(D(v[e].success,{count:t}),"success")}catch(c){throw A(D(v[e].error,{count:t}),"error"),c}}static async performAction(e,t,{wasManuallyMarkedAsRead:r,changeCategoriesPatch:c,mangaIdToMigrateTo:o,downloadAhead:s,onlyUnread:i,size:u,...l}){switch(e){case"download":return a.downloadChapters(t,{downloadAhead:s,onlyUnread:i,size:u});case"delete":return a.deleteChapters(t);case"mark_as_read":return a.markAsRead(t,r);case"mark_as_unread":return a.markAsUnread(t);case"remove_from_library":return a.removeFromLibrary(t);case"change_categories":return a.changeCategories(t,c);case"migrate":return a.migrate(t[0],o,l);default:throw new Error('Mangas::performAction: unknown action "'.concat(e,'"'))}}}export{a as M,v as a};
