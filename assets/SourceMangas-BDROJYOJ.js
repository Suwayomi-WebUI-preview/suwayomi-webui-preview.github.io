import{a as ge,R as he,j as e,c as $e,ak as F,T as xe,an as Ge,n as k,aG as fe,ap as Se,ai as be,S as N,d as b,b5 as M,aL as Ue,u as je,B as w,a1 as qe,C as K,I as ve,a2 as Ne,D as Be,a8 as He,k as Ve,l as We,aC as ze,b6 as Qe,h as Z,b7 as Je,F as Ye,J as Ke,H as Ze,q as Xe,aq as et,b8 as tt,e as st,o as pe,b as at,b9 as q,ba as rt,r as O,bb as nt,i as ot,A as it,au as ct,Z as X,bc as lt,g as me,bd as ut,m as dt}from"./index-CBxbdOZa.js";import{a as pt,u as mt,A as gt,S as ht}from"./AppbarSearch-DDqDFRU_.js";import{F as xt}from"./Favorite-C1IjVGUp.js";import{F as Ce}from"./FilterList-DX5t4YRj.js";import{G as ft}from"./GridLayouts-DHVdgnJy.js";import{D as St}from"./Delete-CPYpmXa7.js";import{S as bt,O as jt}from"./SortRadioInput-C0KOM6aU.js";import{C as vt}from"./CheckboxInput-0NO2rdo0.js";import{a as ye,I as Fe,S as Ct,b as yt,T as Ft}from"./TextField-DuGJKvvj.js";import{a as Te,E as Le}from"./ExpandMore-Al-iG_6o.js";import{u as Tt}from"./useDebounce-Cy8G1E5s.js";import{I as Lt}from"./InputAdornment-PGzZQUDk.js";import{T as Et}from"./ThreeStateCheckboxInput-wiEnqza-.js";import{S as It}from"./StyledFab-tc657Z86.js";import{C as kt}from"./Chip-BeTPtnoR.js";import{B as Mt}from"./BaseMangaGrid-B507VjY3.js";import{g as At}from"./MangaGrid-BdnTyJHa.js";import{E as _t}from"./EmptyViewAbsoluteCentered-DCgg8ff9.js";import{S as Pt}from"./Sources-3VCFbudu.js";import{u as wt}from"./useAppTitleAndAction-D4rw2KWz.js";import{L as Ot}from"./Link-CO7UWlYn.js";import"./ChaptersDownloadActionMenuItems-BVTXZK2z.js";import"./Trackers-D4pSmk7a.js";import"./Card-BbGJVXOW.js";import"./ListCardContent-DPbnp6xG.js";import"./Avatar-CczBYppx.js";import"./CheckCircle-BNV6sksU.js";import"./MUI.util-Bs9Vl2GD.js";import"./CardActionArea-Dl3PGSnS.js";import"./useManageMangaLibraryState-DEU-P4Qb.js";import"./FormGroup-BzOyOVHv.js";import"./useFormControl-EdH_WGd-.js";import"./formControlState-Dq1zat_P.js";import"./ListPreference-CfCfOuBQ.js";import"./Checkbox-D5Y8DhmM.js";import"./SwitchBase-Bt1MmkrC.js";import"./NumberSetting-CFmaU-S2.js";import"./Slider-yvhelXje.js";import"./useMobilePicker-Dq_KXUip.js";import"./SelectSetting-BMUn1mO-.js";import"./Select-DcTUCpv6.js";import"./Download-Dvr2tlzK.js";import"./Sync-QsScqzp8.js";import"./use-merged-ref-BIpNM0cx.js";import"./ListCardAvatar-Olf2Zaaj.js";import"./PlayArrow-Bu-WWWUu.js";import"./useAppTitle-BmkqDPsV.js";import"./useAppAction-mbKoUHfz.js";function Dt(){const[t,a]=ge("source-grid-layout",he.Compact);return e.jsx(ft,{gridLayout:t,onChange:a})}const Rt=$e(e.jsx("path",{d:"M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3m3-10H5V5h10z"})),$t=t=>{const{state:a,name:r,position:o,group:s,updateFilterValue:l,update:n}=t,[c,i]=F.useState(a),x=u=>{i(u.target.checked);const m=n.filter(S=>!(o===S.position&&s===S.group));l([...m,{type:"checkBoxState",position:o,state:u.target.checked,group:s}])};return a!==void 0?e.jsx(vt,{label:r,checked:c,onChange:x}):null},Gt=({name:t})=>e.jsx(xe,{sx:{mt:2},variant:"subtitle2",children:t},t);function Ut(t,a,r,o,s,l,n){const[c,i]=F.useState(r);if(t){const x=m=>{const S=t.indexOf("".concat(m.target.value));i(S);const d=l.filter(p=>!(o===p.position&&n===p.group));s([...d,{type:"selectState",position:o,state:S,group:n}])},u=t.map(m=>e.jsx(Ge,{value:m,children:m},"".concat(a," ").concat(m)));return e.jsxs(ye,{sx:{my:1},variant:"standard",children:[e.jsx(Fe,{children:a}),e.jsx(Ct,{name:a,value:t[c],label:a,onChange:x,children:u})]})}return null}const qt=({values:t,name:a,state:r,position:o,updateFilterValue:s,update:l,group:n})=>Ut(t,a,r,o,s,l,n),Nt=t=>{const{values:a,name:r,state:o,position:s,group:l,updateFilterValue:n,update:c}=t,[i,x]=F.useState(o),[u,m]=F.useState(!1),S=()=>{m(!u)};if(a){const d=p=>{const g=i;g.index===p?g.ascending=!g.ascending:g.ascending=!0,g.index=p,x(g);const C=c.filter(f=>!(s===f.position&&l===f.group));n([...C,{type:"sortState",position:s,state:g,group:l}])};return e.jsxs(k,{sx:{mx:-2},children:[e.jsxs(fe,{onClick:S,children:[e.jsx(Se,{primary:r}),u?e.jsx(Te,{}):e.jsx(Le,{})]}),e.jsx(be,{in:u,children:e.jsx(N,{sx:{mx:4},children:a.map((p,g)=>e.jsx(bt,{label:p,checked:i.index===g,sortDescending:!i.ascending,onClick:()=>d(g)},"".concat(r," ").concat(p)))})})]})}return null},Bt=t=>{const{state:a,name:r,position:o,group:s,updateFilterValue:l,update:n}=t,[c,i]=F.useState(a||""),x=Tt(c,500);return b.useEffect(()=>{const u=n.filter(m=>!(o===m.position&&s===m.group));l([...u,{type:"textState",position:o,state:x,group:s}])},[x]),a!==void 0?e.jsxs(ye,{sx:{my:1},variant:"standard",children:[e.jsx(Fe,{children:r}),e.jsx(yt,{name:r,value:c,onChange:({target:{value:u}})=>i(u),endAdornment:e.jsx(Lt,{position:"end",children:e.jsx(pt,{})})})]}):null},Ht=t=>{switch(t){case M.Ignore:return 0;case M.Include:return 1;case M.Exclude:return 2;default:throw new Error("Unexpected TriState ".concat(t))}},Vt=t=>{switch(t){case 0:return M.Ignore;case 1:return M.Include;case 2:return M.Exclude;default:throw new Error("Unexpected state number ".concat(t))}},Wt=t=>{const{state:a,name:r,position:o,group:s,updateFilterValue:l,update:n}=t,[c,i]=F.useState(Ht(a)),x=u=>{const m=u===void 0?0:u?1:2;i(m);const S=n.filter(d=>!(o===d.position&&s===d.group));l([...S,{type:"triState",position:o,state:Vt(m),group:s}])};return a!==void 0?e.jsx(Et,{label:r,checked:[void 0,!0,!1][c],onChange:u=>x(u)}):null},zt=t=>{const{state:a,name:r,position:o,updateFilterValue:s,update:l}=t,[n,c]=F.useState(!1);return e.jsxs(k,{sx:{mx:-2},children:[e.jsxs(fe,{onClick:()=>c(!n),children:[e.jsx(Se,{primary:r}),n?e.jsx(Te,{}):e.jsx(Le,{})]}),e.jsx(be,{in:n,children:e.jsx(N,{sx:{mx:4},children:e.jsx(Ee,{sourceFilter:a,group:o,updateFilterValue:s,update:l})})})]})},Qt=({name:t})=>e.jsx(Ue,{sx:{my:1},textAlign:"center",children:t},t);function Ee({sourceFilter:t,group:a,updateFilterValue:r,update:o}){return e.jsx(N,{children:t.map((s,l)=>{var c,i;let n=o.find(x=>x.group===a&&x.position===l);switch(n=n&&n.state,s.type){case"CheckBoxFilter":return e.jsx($t,{name:s.name,state:n!=null?n:s.CheckBoxFilterDefault,position:l,group:a,updateFilterValue:r,update:o},"filters ".concat(s.name));case"GroupFilter":return e.jsx(zt,{name:s.name,state:s.filters,position:l,updateFilterValue:r,update:o},"filters ".concat(s.name));case"HeaderFilter":return e.jsx(Gt,{name:s.name},"filters ".concat(s.name));case"SelectFilter":return e.jsx(qt,{name:s.name,values:s.values,state:n!=null?parseInt(n,10):s.SelectFilterDefault,position:l,group:a,updateFilterValue:r,update:o},"filters ".concat(s.name));case"SeparatorFilter":return e.jsx(Qt,{name:s.name},"filters ".concat(s.name));case"SortFilter":return e.jsx(Nt,{name:s.name,values:s.values,state:n!=null?n:{ascending:(c=s.SortFilterDefault)==null?void 0:c.ascending,index:(i=s.SortFilterDefault)==null?void 0:i.index},position:l,group:a,updateFilterValue:r,update:o},"filters ".concat(s.name));case"TextFilter":return e.jsx(Bt,{name:s.name,state:n!=null?n:s.TextFilterDefault,position:l,group:a,updateFilterValue:r,update:o},"filters ".concat(s.name));case"TriStateFilter":return e.jsx(Wt,{name:s.name,state:n!=null?n:s.TriStateFilterDefault,position:l,group:a,updateFilterValue:r,update:o},"filters ".concat(s.name));default:throw new Error('Unknown source filter "'.concat(s,'"'))}})},"filters ".concat(a))}function Jt({savedSearches:t={},selectSavedSearch:a,updateSavedSearches:r,sourceFilter:o,updateFilterValue:s,resetFilterValue:l,setTriggerUpdate:n,update:c}){const{t:i}=je(),[x,u]=b.useState(!1),[m,S]=b.useState(""),d=Object.keys(t),p=!!d.length;function g(){l(0),u(!1)}function C(){n(0),u(!1)}return e.jsxs(e.Fragment,{children:[e.jsxs(It,{onClick:()=>u(!x),variant:"extended",color:"primary",children:[e.jsx(Ce,{}),i("global.button.filter")]}),e.jsxs(jt,{open:x,onClose:()=>u(!1),children:[e.jsxs(k,{sx:{p:2,pb:p?void 0:0},children:[e.jsxs(k,{sx:{display:"flex",pb:1},children:[e.jsx(w,{onClick:g,children:i("global.button.reset")}),e.jsx(qe,{variant:"dialog",popupId:"source-browse-save-search",children:f=>e.jsxs(e.Fragment,{children:[e.jsx(K,{title:i("source.filter.save_search.label.save"),children:e.jsx(ve,{sx:{marginLeft:"auto"},...Ne(f),children:e.jsx(Rt,{})})}),e.jsxs(Be,{...He(f),maxWidth:"xs",fullWidth:!0,children:[e.jsx(Ve,{children:i("source.filter.save_search.dialog.label.title")}),e.jsx(We,{children:e.jsx(Ft,{sx:{width:"100%"},value:m,onChange:y=>S(y.target.value),slotProps:{htmlInput:{maxLength:50}}})}),e.jsxs(ze,{children:[e.jsx(w,{onClick:()=>{S(""),f.close()},children:i("global.button.cancel")}),e.jsx(w,{onClick:()=>{r(m,"create"),S(""),f.close()},children:i("global.button.ok")})]})]})]})}),e.jsx(w,{variant:"contained",onClick:C,children:i("global.button.submit")})]}),p&&e.jsxs(e.Fragment,{children:[e.jsx(xe,{sx:{pb:1},children:"Saved searches"}),e.jsx(N,{sx:{flexDirection:"row"},children:d.map(f=>e.jsx(kt,{label:f,onClick:()=>{u(!1),a(f)},onDelete:()=>{Qe({title:i("global.label.are_you_sure"),message:i("source.filter.save_search.dialog.label.delete",{name:f}),actions:{confirm:{title:i("global.button.delete")}}}).then(()=>r(f,"delete")).catch(Z())},deleteIcon:e.jsx(K,{title:i("source.filter.save_search.label.delete"),children:e.jsx(St,{})}),variant:"outlined"}))})]})]}),e.jsx(k,{sx:{pb:2,mx:2},children:e.jsx(Ee,{sourceFilter:o,updateFilterValue:s,group:void 0,update:c})})]})]})}const Yt={savedSearches:void 0},Ie=t=>({...t,savedSearches:t.savedSearches?JSON.stringify(t.savedSearches):void 0}),Kt=t=>{var a;return{...t,savedSearches:(a=Ye(t.savedSearches))!=null?a:void 0}},Zt=(t,a)=>Kt(Ke("source",{...t,meta:Ze(t.meta)},Ie(Yt),void 0,a)),Xt=t=>{const a=Zt(t,b.useEffect);return b.useMemo(()=>a,[t])},es=async(t,a,r)=>Je(t,[[a,Ie({[a]:r})[a]]]),ts=(t,a=Z())=>(r,o)=>es(t,r,o).catch(a),ss={id:"-1"},as=X("div")(({theme:t})=>({display:"flex",position:"sticky",width:"100%",zIndex:1,padding:t.spacing(1),gap:t.spacing(1),backgroundColor:t.palette.background.default})),Y=X(w)(()=>({})),rs=X(k)(()=>({minHeight:"100%",position:"relative"}));var ns=(t=>(t[t.POPULAR=0]="POPULAR",t[t.LATEST=1]="LATEST",t[t.SEARCH=2]="SEARCH",t))(ns||{});const os={0:"manga.error.label.no_mangas_found",1:"manga.error.label.no_mangas_found",2:"manga.error.label.no_matches"},is=t=>{const a={},r=[];return t.forEach(o=>{!!a[o.id]||(a[o.id]=o,r.push(o))}),r},cs=(t,a,r,o,s,l)=>{var d;let n;switch(a){case 0:n=O.useGetSourcePopularMangas(t,s);break;case 1:n=O.useGetSourceLatestMangas(t,s);break;case 2:n=O.useSourceSearch(t,r!=null?r:"",o.map(p=>{const{position:g,state:C,group:f}=p;return f!==void 0?{position:f,groupChange:{position:g,[p.type]:C}}:{position:g,[p.type]:C}}),s);break;default:throw new Error('Unknown ContentType "'.concat(a,'"'))}const c=n[1],i=c.findLastIndex(p=>{var g;return!!((g=p.data)!=null&&g.fetchSourceManga)}),x=c[i],u=c.slice(-1)[0].isLoading;let m=!u;const S=b.useMemo(()=>{let p=[];return c.forEach((g,C)=>{var _,v,D;const f=(D=(v=(_=g.data)==null?void 0:_.fetchSourceManga)==null?void 0:v.mangas)!=null?D:[],y=f.filter(T=>!l||!T.inLibrary),A=is([...p,...y]);m=!u&&c.length===C+1&&!y.length&&!!f.length,p=A}),p},[c,l]);return i===-1?[n[0],{...n[1][n[1].length-1],filteredOutAllItemsOfFetchedPage:m}]:[n[0],{...c[c.length-1],data:{...x.data,fetchSourceManga:{...x.data.fetchSourceManga,hasNextPage:c.length>i+1?!1:!!((d=x.data.fetchSourceManga)!=null&&d.hasNextPage),mangas:S}},filteredOutAllItemsOfFetchedPage:m}]};function oa(){var ne,oe,ie,ce,le,ue;const{t}=je(),{appBarHeight:a}=Xe(),{sourceId:r}=et(),[o,s]=tt(),l=st(),n=pe(),{key:c,state:i}=n,{contentType:x=0,clearCache:u=!1}=(ne=pe().state)!=null?ne:{},{settings:{hideLibraryEntries:m}}=at(),[S]=ge("source-grid-layout",he.Compact),[d]=mt("query",ht),[p,g]=q("source-mangas-".concat(r,"-filters"),[]),[C,f]=q("source-mangas-location-".concat(c,"-").concat(r,"-filters"),p!=null?p:[]),[y,A]=b.useState(C),[ee,_]=q("source-mangas-".concat(r,"-content-type"),x),[v,D]=q("source-mangas-location-".concat(c,"-").concat(r,"-content-type"),d?2:ee),T=b.useCallback(()=>{rt.session.setItem(At(n),void 0,!1),window.scrollTo(0,0)},[c]),te=b.useRef(d),se=b.useRef(()=>{});te.current!==d&&v===2&&(te.current=d,se.current(new Error("SourceMangas(".concat(r,"): search string changed"))),T()),b.useEffect(()=>()=>{g(void 0),_(void 0)},[r]);const B=j=>{g(j),f(j),T()},ae=j=>{_(j),D(j)},[H,{data:L,error:R,isLoading:V,size:$,abortRequest:ke,filteredOutAllItemsOfFetchedPage:W}]=cs(r,v,d,C,1,m);se.current=ke;const z=V||W,Q=(ie=(oe=L==null?void 0:L.fetchSourceManga)==null?void 0:oe.mangas)!=null?ie:[],G=!!((ce=L==null?void 0:L.fetchSourceManga)!=null&&ce.hasNextPage),{data:J}=O.useGetSource(nt,r),h=J==null?void 0:J.source,Me=(le=h==null?void 0:h.filters)!=null?le:[],{savedSearches:E={}}=Xt(h!=null?h:ss),re=ts(h!=null?h:{id:"-1"},j=>dt(t("global.error.label.failed_to_save_changes"),"error",me(j))),Ae=b.useCallback(j=>{const{query:I,filters:P}=E[j];P&&(A(P),B(P)),I&&(o.set("query",I),s(o))},[E,i]),_e=b.useCallback((j,I)=>{if(I==="delete"){const de={...E};delete de[j],re("savedSearches",de);return}const P={...E,[j]:{query:d!=null?d:void 0,filters:y}};re("savedSearches",P)},[E,d,y]),Pe=z?void 0:t(os[v]),we=r===Pt.LOCAL_SOURCE_ID?e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:[t("source.local_source.label.checkout")," "]}),e.jsx(Ot,{href:"https://github.com/Suwayomi/Suwayomi-Server/wiki/Local-Source",target:"_blank",rel:"noreferrer",children:t("source.local_source.label.guide")})]}):void 0,U=b.useCallback((j,I)=>{ae(j),T(),d&&!I&&l({pathname:""},{state:{...i,contentType:j}})},[ae,d,T]);!!d&&v!==2&&U(2,d);const Oe=b.useCallback(()=>{G&&H($+1)},[$,G,v]),De=()=>{A([]),B([])};b.useEffect(()=>{W&&G&&!V&&H($+1)},[W,V]),b.useEffect(()=>{!u||!ut.REVALIDATION.includes(r)||O.clearBrowseCacheFor(r)},[u]),wt((ue=h==null?void 0:h.displayName)!=null?ue:t("source.title_one"),e.jsxs(e.Fragment,{children:[e.jsx(gt,{}),e.jsx(Dt,{}),(h==null?void 0:h.isConfigurable)&&e.jsx(K,{title:t("settings.title"),children:e.jsx(ve,{onClick:()=>l(it.sources.childRoutes.configure.path(r)),"aria-label":"display more actions",edge:"end",color:"inherit",children:e.jsx(ot,{})})})]}),[h]);const Re=Q.length?ct:_t;return e.jsxs(rs,{children:[e.jsxs(as,{sx:{top:"".concat(a,"px")},children:[e.jsx(Y,{variant:v===0?"contained":"outlined",startIcon:e.jsx(xt,{}),onClick:()=>U(0),children:t("global.button.popular")}),(h==null?void 0:h.supportsLatest)===void 0||h.supportsLatest?e.jsx(Y,{disabled:!(h!=null&&h.supportsLatest),variant:v===1?"contained":"outlined",startIcon:e.jsx(lt,{}),onClick:()=>U(1),children:t("global.button.latest")}):null,e.jsx(Y,{variant:v===2?"contained":"outlined",startIcon:e.jsx(Ce,{}),onClick:()=>U(2,d),children:t("global.button.filter")})]}),(z||!R||!!R&&!!Q.length)&&e.jsx(Mt,{gridWrapperProps:{sx:{px:1,pb:1}},mangas:Q,hasNextPage:G,loadMore:Oe,message:Pe,messageExtra:we,isLoading:z,gridLayout:S,mode:"source",inLibraryIndicator:!0},v),R&&e.jsx(Re,{message:t("global.error.label.failed_to_load_data"),messageExtra:me(R),retry:()=>H($).catch(Z())}),v===2&&e.jsx(Jt,{savedSearches:E,selectSavedSearch:Ae,updateSavedSearches:_e,sourceFilter:Me,updateFilterValue:A,setTriggerUpdate:()=>{B(y)},resetFilterValue:De,update:y})]})}export{ns as SourceContentType,oa as SourceMangas};
