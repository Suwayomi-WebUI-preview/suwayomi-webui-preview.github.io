import{av as xe,X as fe,j as e,c as Ne,aA as F,T as Se,aD as Be,x as T,aP as be,p as je,aw as Ce,S as B,b as j,ba as k,aU as qe,u as ve,B as w,a6 as He,C as X,I as ye,a4 as Ve,i as We,ao as Ke,k as Qe,n as Ye,q as ze,bb as Je,f as Z,y as Xe,aF as Ze,bc as et,d as tt,aG as me,a as st,v as ge,bd as N,r as M,be as at,W as rt,s as nt,A as ot,aL as it,a1 as ee,bf as lt,g as he,bg as ct,m as ut}from"./index-KJngWC4P.js";import{a as dt,u as pt,A as mt,S as gt}from"./AppbarSearch-DMUOBgnp.js";import{F as ht}from"./Favorite-j3Xt6pOv.js";import{F as Fe}from"./FilterList-BimCGcRH.js";import{G as xt}from"./GridLayouts-DRd6o8O_.js";import{D as ft}from"./Delete-CJkQiPPL.js";import{S as St,O as bt}from"./SortRadioInput-DVros_kD.js";import{C as jt}from"./CheckboxInput-1XE0fp5y.js";import{a as Ee,I as Ie,S as Ct,b as vt,T as yt}from"./TextField-BtGPrD9J.js";import{a as Le,E as Te}from"./ExpandMore-CfLfnEEI.js";import{u as Ft}from"./useDebounce-CUobWXnK.js";import{I as Et}from"./InputAdornment-BP-n1P8E.js";import{T as It}from"./ThreeStateCheckboxInput-KgzYBO46.js";import{S as Lt}from"./StyledFab-DcOYkPDD.js";import{C as Tt}from"./Chip-3ltX2Afk.js";import{B as kt}from"./BaseMangaGrid-DaZ90n-Q.js";import{b as Pt}from"./MangaGrid-Dss9SDAw.js";import{u as _t,c as At,S as wt}from"./Sources-C61JYrbU.js";import{E as Mt}from"./EmptyViewAbsoluteCentered-DVFS0qF1.js";import{u as Ot}from"./useAppTitleAndAction-C6Oj1kcA.js";import{V as $t}from"./Virtuoso.util-DwdU3ppG.js";import{L as Rt}from"./Link-DKbZRjNA.js";import"./ChaptersDownloadActionMenuItems-CXiYRS66.js";import"./Trackers-Bgo8y--2.js";import"./Card-BMli_BAZ.js";import"./ListCardContent-Ct4im15q.js";import"./Avatar-CG7r50A0.js";import"./VisibilityOff-MGpZwfVp.js";import"./CheckCircle-Ds_C5nRa.js";import"./Metadata-Bn_ZPmkh.js";import"./MUI.util-CYBuX_Wz.js";import"./CardActionArea-DcfNUvnY.js";import"./useManageMangaLibraryState-COci5tq0.js";import"./FormGroup-CIUE2Acw.js";import"./useFormControl-Ct92ZYaj.js";import"./formControlState-Dq1zat_P.js";import"./ListPreference-eArkr4j0.js";import"./Checkbox-CgvaHY7S.js";import"./SwitchBase-Xv_ULLWe.js";import"./NumberSetting-Bf6JI8jn.js";import"./Slider-DO9jj9rx.js";import"./useMobilePicker-LbWEkrSe.js";import"./SelectSetting-C3GGjfff.js";import"./Select-BWaNa6Ve.js";import"./Download-WEcpOhJZ.js";import"./Sync-BXEu-yuX.js";import"./use-merged-ref-DRHY-1vg.js";import"./ListCardAvatar-bLukzetS.js";import"./PlayArrow-zScrcO_g.js";import"./index-COskZQL4.js";import"./useAppTitle-DrK6vEjZ.js";import"./useAppAction-kt7f7PmF.js";function Dt(){const[t,n]=xe("source-grid-layout",fe.Compact);return e.jsx(xt,{gridLayout:t,onChange:n})}const Gt=Ne(e.jsx("path",{d:"M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3m3-10H5V5h10z"})),Ut=t=>{const{state:n,name:a,position:o,group:s,updateFilterValue:l,update:r}=t,[c,i]=F.useState(n),x=u=>{i(u.target.checked);const m=r.filter(S=>!(o===S.position&&s===S.group));l([...m,{type:"checkBoxState",position:o,state:u.target.checked,group:s}])};return n!==void 0?e.jsx(jt,{label:a,checked:c,onChange:x}):null},Nt=({name:t})=>e.jsx(Se,{sx:{mt:2},variant:"subtitle2",children:t},t);function Bt(t,n,a,o,s,l,r){const[c,i]=F.useState(a);if(t){const x=m=>{const S=t.indexOf("".concat(m.target.value));i(S);const d=l.filter(p=>!(o===p.position&&r===p.group));s([...d,{type:"selectState",position:o,state:S,group:r}])},u=t.map(m=>e.jsx(Be,{value:m,children:m},"".concat(n," ").concat(m)));return e.jsxs(Ee,{sx:{my:1},variant:"standard",children:[e.jsx(Ie,{children:n}),e.jsx(Ct,{name:n,value:t[c],label:n,onChange:x,children:u})]})}return null}const qt=({values:t,name:n,state:a,position:o,updateFilterValue:s,update:l,group:r})=>Bt(t,n,a,o,s,l,r),Ht=t=>{const{values:n,name:a,state:o,position:s,group:l,updateFilterValue:r,update:c}=t,[i,x]=F.useState(o),[u,m]=F.useState(!1),S=()=>{m(!u)};if(n){const d=p=>{const g=i;g.index===p?g.ascending=!g.ascending:g.ascending=!0,g.index=p,x(g);const v=c.filter(f=>!(s===f.position&&l===f.group));r([...v,{type:"sortState",position:s,state:g,group:l}])};return e.jsxs(T,{sx:{mx:-2},children:[e.jsxs(be,{onClick:S,children:[e.jsx(je,{primary:a}),u?e.jsx(Le,{}):e.jsx(Te,{})]}),e.jsx(Ce,{in:u,children:e.jsx(B,{sx:{mx:4},children:n.map((p,g)=>e.jsx(St,{label:p,checked:i.index===g,sortDescending:!i.ascending,onClick:()=>d(g)},"".concat(a," ").concat(p)))})})]})}return null},Vt=t=>{const{state:n,name:a,position:o,group:s,updateFilterValue:l,update:r}=t,[c,i]=F.useState(n||""),x=Ft(c,500);return j.useEffect(()=>{const u=r.filter(m=>!(o===m.position&&s===m.group));l([...u,{type:"textState",position:o,state:x,group:s}])},[x]),n!==void 0?e.jsxs(Ee,{sx:{my:1},variant:"standard",children:[e.jsx(Ie,{children:a}),e.jsx(vt,{name:a,value:c,onChange:({target:{value:u}})=>i(u),endAdornment:e.jsx(Et,{position:"end",children:e.jsx(dt,{})})})]}):null},Wt=t=>{switch(t){case k.Ignore:return 0;case k.Include:return 1;case k.Exclude:return 2;default:throw new Error("Unexpected TriState ".concat(t))}},Kt=t=>{switch(t){case 0:return k.Ignore;case 1:return k.Include;case 2:return k.Exclude;default:throw new Error("Unexpected state number ".concat(t))}},Qt=t=>{const{state:n,name:a,position:o,group:s,updateFilterValue:l,update:r}=t,[c,i]=F.useState(Wt(n)),x=u=>{const m=u===void 0?0:u?1:2;i(m);const S=r.filter(d=>!(o===d.position&&s===d.group));l([...S,{type:"triState",position:o,state:Kt(m),group:s}])};return n!==void 0?e.jsx(It,{label:a,checked:[void 0,!0,!1][c],onChange:u=>x(u)}):null},Yt=t=>{const{state:n,name:a,position:o,updateFilterValue:s,update:l}=t,[r,c]=F.useState(!1);return e.jsxs(T,{sx:{mx:-2},children:[e.jsxs(be,{onClick:()=>c(!r),children:[e.jsx(je,{primary:a}),r?e.jsx(Le,{}):e.jsx(Te,{})]}),e.jsx(Ce,{in:r,children:e.jsx(B,{sx:{mx:4},children:e.jsx(ke,{sourceFilter:n,group:o,updateFilterValue:s,update:l})})})]})},zt=({name:t})=>e.jsx(qe,{sx:{my:1},textAlign:"center",children:t},t);function ke({sourceFilter:t,group:n,updateFilterValue:a,update:o}){return e.jsx(B,{children:t.map((s,l)=>{var c,i;let r=o.find(x=>x.group===n&&x.position===l);switch(r=r&&r.state,s.type){case"CheckBoxFilter":return e.jsx(Ut,{name:s.name,state:r!=null?r:s.CheckBoxFilterDefault,position:l,group:n,updateFilterValue:a,update:o},"filters ".concat(s.name));case"GroupFilter":return e.jsx(Yt,{name:s.name,state:s.filters,position:l,updateFilterValue:a,update:o},"filters ".concat(s.name));case"HeaderFilter":return e.jsx(Nt,{name:s.name},"filters ".concat(s.name));case"SelectFilter":return e.jsx(qt,{name:s.name,values:s.values,state:r!=null?parseInt(r,10):s.SelectFilterDefault,position:l,group:n,updateFilterValue:a,update:o},"filters ".concat(s.name));case"SeparatorFilter":return e.jsx(zt,{name:s.name},"filters ".concat(s.name));case"SortFilter":return e.jsx(Ht,{name:s.name,values:s.values,state:r!=null?r:{ascending:(c=s.SortFilterDefault)==null?void 0:c.ascending,index:(i=s.SortFilterDefault)==null?void 0:i.index},position:l,group:n,updateFilterValue:a,update:o},"filters ".concat(s.name));case"TextFilter":return e.jsx(Vt,{name:s.name,state:r!=null?r:s.TextFilterDefault,position:l,group:n,updateFilterValue:a,update:o},"filters ".concat(s.name));case"TriStateFilter":return e.jsx(Qt,{name:s.name,state:r!=null?r:s.TriStateFilterDefault,position:l,group:n,updateFilterValue:a,update:o},"filters ".concat(s.name));default:throw new Error('Unknown source filter "'.concat(s,'"'))}})},"filters ".concat(n))}function Jt({savedSearches:t={},selectSavedSearch:n,updateSavedSearches:a,sourceFilter:o,updateFilterValue:s,resetFilterValue:l,setTriggerUpdate:r,update:c}){const{t:i}=ve(),[x,u]=j.useState(!1),[m,S]=j.useState(""),d=Object.keys(t),p=!!d.length;function g(){l(0),u(!1)}function v(){r(0),u(!1)}return e.jsxs(e.Fragment,{children:[e.jsxs(Lt,{onClick:()=>u(!x),variant:"extended",color:"primary",children:[e.jsx(Fe,{}),i("global.button.filter")]}),e.jsxs(bt,{open:x,onClose:()=>u(!1),children:[e.jsxs(T,{sx:{p:2,pb:p?void 0:0},children:[e.jsxs(T,{sx:{display:"flex",pb:1},children:[e.jsx(w,{onClick:g,children:i("global.button.reset")}),e.jsx(He,{variant:"dialog",popupId:"source-browse-save-search",children:f=>e.jsxs(e.Fragment,{children:[e.jsx(X,{title:i("source.filter.save_search.label.save"),children:e.jsx(ye,{sx:{marginLeft:"auto"},...Ve(f),children:e.jsx(Gt,{})})}),e.jsxs(We,{...Ke(f),maxWidth:"xs",fullWidth:!0,children:[e.jsx(Qe,{children:i("source.filter.save_search.dialog.label.title")}),e.jsx(Ye,{children:e.jsx(yt,{sx:{width:"100%"},value:m,onChange:y=>S(y.target.value),slotProps:{htmlInput:{maxLength:50}}})}),e.jsxs(ze,{children:[e.jsx(w,{onClick:()=>{S(""),f.close()},children:i("global.button.cancel")}),e.jsx(w,{onClick:()=>{a(m,"create"),S(""),f.close()},children:i("global.button.ok")})]})]})]})}),e.jsx(w,{variant:"contained",onClick:v,children:i("global.button.submit")})]}),p&&e.jsxs(e.Fragment,{children:[e.jsx(Se,{sx:{pb:1},children:"Saved searches"}),e.jsx(B,{sx:{flexDirection:"row"},children:d.map(f=>e.jsx(Tt,{label:f,onClick:()=>{u(!1),n(f)},onDelete:()=>{Je({title:i("global.label.are_you_sure"),message:i("source.filter.save_search.dialog.label.delete",{name:f}),actions:{confirm:{title:i("global.button.delete")}}}).then(()=>a(f,"delete")).catch(Z())},deleteIcon:e.jsx(X,{title:i("source.filter.save_search.label.delete"),children:e.jsx(ft,{})}),variant:"outlined"}))})]})]}),e.jsx(T,{sx:{pb:2,mx:2},children:e.jsx(ke,{sourceFilter:o,updateFilterValue:s,group:void 0,update:c})})]})]})}const Xt={id:"-1"},Zt=ee("div")(({theme:t})=>({display:"flex",position:"sticky",width:"100%",zIndex:1,padding:t.spacing(1),gap:t.spacing(1),backgroundColor:t.palette.background.default})),J=ee(w)(()=>({})),es=ee(T)(()=>({minHeight:"100%",position:"relative"}));var ts=(t=>(t[t.POPULAR=0]="POPULAR",t[t.LATEST=1]="LATEST",t[t.SEARCH=2]="SEARCH",t))(ts||{});const ss={0:"manga.error.label.no_mangas_found",1:"manga.error.label.no_mangas_found",2:"manga.error.label.no_matches"},as=t=>{const n={},a=[];return t.forEach(o=>{!!n[o.id]||(n[o.id]=o,a.push(o))}),a},rs=(t,n,a,o,s,l)=>{var d;let r;switch(n){case 0:r=M.useGetSourcePopularMangas(t,s);break;case 1:r=M.useGetSourceLatestMangas(t,s);break;case 2:r=M.useSourceSearch(t,a!=null?a:"",o.map(p=>{const{position:g,state:v,group:f}=p;return f!==void 0?{position:f,groupChange:{position:g,[p.type]:v}}:{position:g,[p.type]:v}}),s);break;default:throw new Error('Unknown ContentType "'.concat(n,'"'))}const c=r[1],i=c.findLastIndex(p=>{var g;return!!((g=p.data)!=null&&g.fetchSourceManga)}),x=c[i],u=c.slice(-1)[0].isLoading;let m=!u;const S=j.useMemo(()=>{let p=[];return c.forEach((g,v)=>{var _,C,O;const f=(O=(C=(_=g.data)==null?void 0:_.fetchSourceManga)==null?void 0:C.mangas)!=null?O:[],y=f.filter(q=>!l||!q.inLibrary),P=as([...p,...y]);m=!u&&c.length===v+1&&!y.length&&!!f.length,p=P}),p},[c,l]);return i===-1?[r[0],{...r[1][r[1].length-1],filteredOutAllItemsOfFetchedPage:m}]:[r[0],{...c[c.length-1],data:{...x.data,fetchSourceManga:{...x.data.fetchSourceManga,hasNextPage:c.length>i+1?!1:!!((d=x.data.fetchSourceManga)!=null&&d.hasNextPage),mangas:S}},filteredOutAllItemsOfFetchedPage:m}]};function oa(){var oe,ie,le,ce,ue,de;const{t}=ve(),{appBarHeight:n}=Xe(),{sourceId:a}=Ze(),[o,s]=et(),l=tt(),r=me(),{key:c,state:i}=r,{contentType:x=0,clearCache:u=!1}=(oe=me().state)!=null?oe:{},{settings:{hideLibraryEntries:m}}=st(),[S]=xe("source-grid-layout",fe.Compact),[d]=pt(ge.QUERY,gt),[p,g]=N("source-mangas-".concat(a,"-filters"),[]),[v,f]=N("source-mangas-location-".concat(c,"-").concat(a,"-filters"),p!=null?p:[]),[y,P]=j.useState(v),[te,_]=N("source-mangas-".concat(a,"-content-type"),x),[C,O]=N("source-mangas-location-".concat(c,"-").concat(a,"-content-type"),d?2:te),{key:q,deleteState:Pe}=$t.usePersistState(Pt),$=j.useCallback(()=>{Pe(),window.scrollTo(0,0)},[q]),se=j.useRef(d),ae=j.useRef(()=>{});se.current!==d&&C===2&&(se.current=d,ae.current(new Error("SourceMangas(".concat(a,"): search string changed"))),$()),j.useEffect(()=>()=>{g(void 0),_(void 0)},[a]);const H=b=>{g(b),f(b),$()},re=b=>{_(b),O(b)},_e="".concat(C).concat(JSON.stringify(v)).concat(d),[V,{data:E,error:R,isLoading:W,size:D,abortRequest:Ae,filteredOutAllItemsOfFetchedPage:K}]=rs(a,C,d,v,1,m);ae.current=Ae;const Q=W||K,Y=(le=(ie=E==null?void 0:E.fetchSourceManga)==null?void 0:ie.mangas)!=null?le:[],G=!!((ce=E==null?void 0:E.fetchSourceManga)!=null&&ce.hasNextPage),{data:z}=M.useGetSource(at,a),h=z==null?void 0:z.source,we=(ue=h==null?void 0:h.filters)!=null?ue:[],{savedSearches:I={}}=_t(h!=null?h:Xt),ne=At(h!=null?h:{id:"-1"},b=>ut(t("global.error.label.failed_to_save_changes"),"error",he(b))),Me=j.useCallback(b=>{const{query:L,filters:A}=I[b];A&&(P(A),H(A)),L&&(o.set(ge.QUERY,L),s(o))},[I,i]),Oe=j.useCallback((b,L)=>{if(L==="delete"){const pe={...I};delete pe[b],ne("savedSearches",pe);return}const A={...I,[b]:{query:d!=null?d:void 0,filters:y}};ne("savedSearches",A)},[I,d,y]),$e=Q?void 0:t(ss[C]),Re=a===wt.LOCAL_SOURCE_ID?e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:[t("source.local_source.label.checkout")," "]}),e.jsx(Rt,{href:"https://github.com/Suwayomi/Suwayomi-Server/wiki/Local-Source",target:"_blank",rel:"noreferrer",children:t("source.local_source.label.guide")})]}):void 0,U=j.useCallback((b,L)=>{re(b),$(),d&&!L&&l({pathname:""},{state:{...i,contentType:b}})},[re,d,$]);!!d&&C!==2&&U(2,d);const De=j.useCallback(()=>{G&&V(D+1)},[D,G,C]),Ge=()=>{P([]),H([])};j.useEffect(()=>{rt("lastUsedSourceId",a).catch(Z())},[a]),j.useEffect(()=>{K&&G&&!W&&V(D+1)},[K,W]),j.useEffect(()=>{!u||!ct.REVALIDATION.includes(a)||M.clearBrowseCacheFor(a)},[u]),Ot((de=h==null?void 0:h.displayName)!=null?de:t("source.title_one"),e.jsxs(e.Fragment,{children:[e.jsx(mt,{}),e.jsx(Dt,{}),(h==null?void 0:h.isConfigurable)&&e.jsx(X,{title:t("settings.title"),children:e.jsx(ye,{onClick:()=>l(ot.sources.childRoutes.configure.path(a)),"aria-label":"display more actions",edge:"end",color:"inherit",children:e.jsx(nt,{})})})]}),[h]);const Ue=Y.length?it:Mt;return e.jsxs(es,{children:[e.jsxs(Zt,{sx:{top:"".concat(n,"px")},children:[e.jsx(J,{variant:C===0?"contained":"outlined",startIcon:e.jsx(ht,{}),onClick:()=>U(0),children:t("global.button.popular")}),(h==null?void 0:h.supportsLatest)===void 0||h.supportsLatest?e.jsx(J,{disabled:!(h!=null&&h.supportsLatest),variant:C===1?"contained":"outlined",startIcon:e.jsx(lt,{}),onClick:()=>U(1),children:t("global.button.latest")}):null,e.jsx(J,{variant:C===2?"contained":"outlined",startIcon:e.jsx(Fe,{}),onClick:()=>U(2,d),children:t("global.button.filter")})]}),(Q||!R||!!R&&!!Y.length)&&e.jsx(kt,{gridWrapperProps:{sx:{px:1,pb:1}},mangas:Y,hasNextPage:G,loadMore:De,message:$e,messageExtra:Re,isLoading:Q,gridLayout:S,mode:"source",inLibraryIndicator:!0},_e),R&&e.jsx(Ue,{message:t("global.error.label.failed_to_load_data"),messageExtra:he(R),retry:()=>V(D).catch(Z())}),C===2&&e.jsx(Jt,{savedSearches:I,selectSavedSearch:Me,updateSavedSearches:Oe,sourceFilter:we,updateFilterValue:P,setTriggerUpdate:()=>{H(y)},resetFilterValue:Ge,update:y})]})}export{ts as SourceContentType,oa as SourceMangas};
