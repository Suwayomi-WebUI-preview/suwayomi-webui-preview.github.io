import{e as i,u as D,q as U,a as Q,b as V,ax as J,d as K,r as H,j as e,h as X,g as v,i as N,p as E,S as z,B as A,s as Y,an as Z,A as ee,L as te,T as B,C as re,I as oe,ay as se,az as ne,m as ae}from"./index-C4SExTDW.js";import{u as ie,S as ce,A as ue}from"./AppbarSearch-CX2MF2DP.js";import{P as le}from"./PushPin-BCjWBjt2.js";import{D as me}from"./DoneAll-Cog9Noqd.js";import{F as de}from"./FilterList-C2g-ZBKB.js";import{t as pe,L as he}from"./LanguageSelect-BsrfhEEA.js";import{u as T}from"./useDebounce-4L-sn3gl.js";import{B as ge}from"./BaseMangaGrid-5cGSLq-v.js";import{E as fe}from"./EmptyViewAbsoluteCentered-Bj5D8sO9.js";import{S as q,g as O}from"./Sources-4HA2npFp.js";import{u as xe}from"./useAppTitleAndAction-DSptROrL.js";import{M as Se}from"./MUI.util-DLhsU2rp.js";import{C as Re}from"./Card-CRsN8YZQ.js";import{C as ye}from"./CardActionArea-tHlVxgny.js";import"./ChaptersDownloadActionMenuItems-TPHPpKN3.js";import"./Trackers-D4pSmk7a.js";import"./ListCardContent-Dhfr2z-M.js";import"./Avatar-D1nb2BkW.js";import"./TextField-BPDoYjhv.js";import"./useFormControl-B9uxGZrm.js";import"./formControlState-Dq1zat_P.js";import"./InputAdornment-D-CkUtXa.js";import"./CheckCircle-Csgsl1tx.js";import"./Link-CqypWjwb.js";import"./useManageMangaLibraryState-CXWLmISA.js";import"./ThreeStateCheckboxInput-0BxEW1hS.js";import"./Checkbox-DSeIXg9i.js";import"./SwitchBase-CwsYQNAh.js";import"./CheckboxInput-DfM1M1D4.js";import"./FormGroup-DMATKdjp.js";import"./ListPreference-B91oYGsN.js";import"./NumberSetting-rFT7TWO8.js";import"./Slider-DQOQiSLT.js";import"./useMobilePicker-BnoaaJJJ.js";import"./Chip-CnqLOSwz.js";import"./SelectSetting-DqMY7CvG.js";import"./Select-B_2oTE3-.js";import"./Switch-D-7oU1yk.js";import"./MangaGrid-CDqg-5Z6.js";import"./Delete-uHYNNdzR.js";import"./Download-BJGgeFW_.js";import"./Sync-BIy3xqfC.js";import"./use-merged-ref-B0P6l6fN.js";import"./ListCardAvatar-Bdc_io0-.js";import"./PlayArrow-CflMcSX_.js";import"./StyledFab-CG8s8Vip.js";import"./useAppTitle-CnXg8KcH.js";import"./useAppAction-C1Uo5KZc.js";const be={x:0,y:0,width:0,height:0,top:0,left:0,bottom:0,right:0};function we(o){const c=i.useRef(0),t=i.useRef(null),[p,g]=i.useState(be),r=i.useMemo(()=>typeof window<"u"?new ResizeObserver(s=>{const n=s[0];n&&(cancelAnimationFrame(c.current),c.current=requestAnimationFrame(()=>{var m,d;if(t.current){const l=((m=n.borderBoxSize)==null?void 0:m[0])||((d=n.contentBoxSize)==null?void 0:d[0]);if(l){const f=l.inlineSize,S=l.blockSize;g({width:f,height:S,x:n.contentRect.x,y:n.contentRect.y,top:n.contentRect.top,left:n.contentRect.left,bottom:n.contentRect.bottom,right:n.contentRect.right})}else g(n.contentRect)}}))}):null,[]);return i.useEffect(()=>(t.current&&(r==null||r.observe(t.current,o)),()=>{r==null||r.disconnect(),c.current&&cancelAnimationFrame(c.current)}),[t.current]),[t,p]}function je(o){const[c,{width:t,height:p}]=we(o);return{ref:c,width:t,height:p}}const Le=(o,c)=>o.displayName.localeCompare(c.displayName),Me=(o,c,t)=>{const p=O(o).isPinned,g=O(c).isPinned,r=t.get(o.id),s=t.get(c.id),n=!(r!=null&&r.isLoading),m=!!(r!=null&&r.error),d=!(r!=null&&r.hasResults)&&!m,l=!(s!=null&&s.isLoading),f=!!(s!=null&&s.error),S=!(s!=null&&s.hasResults)&&!f;return n&&!l?-1:!n&&l||d&&!S?1:S&&!d||!m&&f?-1:m&&!f?1:p&&!g?-1:!p&&g?1:0},Ee=1e3,Pe=Z.memo(({source:o,onSearchRequestFinished:c,searchString:t,emptyQuery:p,mode:g})=>{var w,M;const{t:r}=D(),{id:s,name:n,lang:m}=o,d=i.useRef(t),l=i.useRef(()=>{});d.current!==t&&(d.current=t,l.current(new Error("SourceSearchPreview(".concat(s,", ").concat(n,"): search string changed"))));const[S,j]=H.useSourceSearch(s,t!=null?t:"",void 0,1,{skipRequest:!t,addAbortSignal:!0}),{data:h,isLoading:y,error:x,abortRequest:P}=j[0];l.current=P;const b=(M=(w=h==null?void 0:h.fetchSourceManga)==null?void 0:w.mangas)!=null?M:[],L=!x&&!y&&!b.length;i.useEffect(()=>{c(o,{isLoading:y,hasResults:!L,emptySearch:!t,error:x})},[y,L,t,x]);let R;return x?R=r("search.error.label.source_search_failed"):L&&(R=r("manga.error.label.no_mangas_found")),!y&&!t||p?null:e.jsxs(e.Fragment,{children:[e.jsx(Re,{sx:{mb:1},children:e.jsxs(ye,{component:te,to:ee.sources.childRoutes.browse.path(s,t),sx:{p:1,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(E,{children:[e.jsx(B,{variant:"h5",children:n}),e.jsx(B,{variant:"caption",children:pe(m)})]}),e.jsx(re,{title:r("global.button.show_more"),children:e.jsx(oe,{...Se.preventRippleProp(),children:e.jsx(se,{})})})]})}),R?e.jsx(ne,{sx:{alignItems:"start",height:void 0},noFaces:!0,message:R,messageExtra:v(x),retry:x?()=>S(1).catch(N("SourceSearchPreview(".concat(o.id,")::refetch"))):void 0}):e.jsx(ge,{gridWrapperProps:{sx:{px:0}},mangas:b,isLoading:y,hasNextPage:!1,loadMore:()=>{},horizontal:!0,noFaces:!0,message:R,inLibraryIndicator:!0,mode:g},t)]})}),wt=()=>{const{t:o}=D(),{pathname:c,state:t}=U(),{ref:p,height:g}=je(),r=c.startsWith("/migrate/source"),[s]=ie("query",ce),n=T(s,Ee),[m,d]=Q("shownSourceLangs",V()),[l,f]=J("SearchAll::shouldShowOnlyPinnedSources",!0),{settings:{showNsfw:S,shouldShowOnlySourcesWithResults:j}}=K(),{data:h,loading:y,error:x,refetch:P}=H.useGetSourceList({notifyOnNetworkStatusChange:!0}),b=i.useMemo(()=>{var u;return(u=h==null?void 0:h.sources.nodes)!=null?u:[]},[h==null?void 0:h.sources.nodes]),[L,R]=i.useState(new Map),w=T(L,500),M=i.useMemo(()=>q.getLanguages(b),[b]),C=i.useMemo(()=>q.filter(b,{showNsfw:S,languages:m,keepLocalSource:!0,pinned:l}),[b,m,l]),I=i.useMemo(()=>j?C.filter(u=>{const a=w.get(u.id);return!a||(a==null?void 0:a.isLoading)||(a==null?void 0:a.hasResults)&&!(a!=null&&a.error)}):C,[C,j,w]),_=i.useMemo(()=>[...I].toSorted(Le),[I]),k=i.useMemo(()=>[..._].sort((u,a)=>Me(u,a,w)),[_,w]),G=i.useCallback(({id:u},a)=>{R($=>{const F=new Map($);return F.set(u,a),F})},[R]),W=Y(u=>ae(o("global.error.label.failed_to_save_changes"),"error",v(u)));return xe(o(r?"migrate.search.title":"search.title.global_search",{title:t==null?void 0:t.mangaTitle}),e.jsxs(e.Fragment,{children:[e.jsx(ue,{isClosable:!1}),e.jsx(he,{selectedLanguages:m,setSelectedLanguages:d,languages:M})]}),[m,d,M]),y?e.jsx(X,{}):x?e.jsx(fe,{message:o("global.error.label.failed_to_load_data"),messageExtra:v(x),retry:()=>P().catch(N())}):e.jsxs(E,{sx:{position:"relative",px:1,pb:1},children:[e.jsxs(z,{ref:p,sx:{width:"100%",position:"fixed",zIndex:1,flexDirection:"row",gap:2,pt:1,pb:2,background:u=>u.palette.background.default},children:[e.jsxs(z,{sx:{flexDirection:"row",gap:1},children:[e.jsx(A,{startIcon:e.jsx(le,{}),variant:l?"contained":"outlined",onClick:()=>f(!0),children:o("global.label.pinned")}),e.jsx(A,{startIcon:e.jsx(me,{}),variant:l?"outlined":"contained",onClick:()=>f(!1),children:o("extension.language.all")})]}),e.jsx(A,{startIcon:e.jsx(de,{}),variant:j?"contained":"outlined",onClick:()=>W("shouldShowOnlySourcesWithResults",!j),children:o("search.filter.has_results")})]}),e.jsx(E,{sx:{pt:"".concat(g,"px")},children:k.map((u,a)=>e.jsx(E,{sx:{pb:a+1!==k.length?2:0},children:e.jsx(Pe,{source:u,onSearchRequestFinished:G,searchString:n,emptyQuery:!s,mode:r?"migrate.select":"source"})},u.id))})]})};export{wt as SearchAll};
