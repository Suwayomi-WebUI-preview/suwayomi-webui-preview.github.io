import{c as ae,j as e,u as L,M as Re,C as q,a as Ce,A as k,L as G,b as X,B as U,S as ie,r as f,T as m,d as le,e as F,f as be,g as $,h as Pe,s as Be,i as ce,k as c,l as de,m as R,I as P,n as Q,E as H,o as C,p as N,q as Le,t as T,D as Ee,v as De,w as Ge,x as Fe,y as He,z as we,F as ze,G as Ve,H as We,J as ve,K as ye,N as Ke,O as qe,P as ne,Q as oe}from"./index-FX96rGzE.js";import{u as Te,S as Ae,A as Xe}from"./AppbarSearch-CvTdGwff.js";import{SourceContentType as re}from"./SourceMangas-DrcywzHF.js";import{t as z,L as _e,g as K,I as $e,a as Qe,E as Ie,b as w,c as Ye,d as Je,e as ke,f as Ze,h as et,i as tt,j as st}from"./LanguageSelect-CLpsh2VP.js";import{S as O}from"./Sources-wBHCBenc.js";import{A as ue}from"./Avatar-BAZliP1c.js";import{f as nt}from"./file-selector-DlHkLoY8.js";import{S as he,V as ot,a as rt,b as at}from"./Virtuoso.util-vEs9YnKO.js";import{T as it}from"./TabsWrapper-C_EhSSqW.js";import{A as lt,a as ct}from"./SortRadioInput-B7yNYMOu.js";import{C as dt}from"./Chip-MOmFd805.js";import"./ChaptersDownloadActionMenuItems-Z9ODZZYD.js";import"./Trackers-D4pSmk7a.js";import"./CheckCircle-QwLDNfSw.js";import"./ListPreference-DKcRPY0h.js";import"./NumberSetting-CDzCgP1z.js";import"./useMobilePicker-Cv_9HfI3.js";import"./SelectSetting-Dulz7ePw.js";import"./FilterList-qHf6XsUZ.js";import"./GridLayouts-NiFIkgy5.js";import"./ExpandMore-_eqXyQu4.js";import"./useDebounce-BSM2W4i3.js";import"./StyledFab-DB55LD-B.js";import"./BaseMangaGrid-BLWyfCNT.js";import"./MangaGrid-B-yKksxd.js";import"./Sync-0XJKHOyf.js";import"./PlayArrow-ClZyigNT.js";const ut=ae(e.jsx("path",{d:"M19.3 16.9c.4-.7.7-1.5.7-2.4 0-2.5-2-4.5-4.5-4.5S11 12 11 14.5s2 4.5 4.5 4.5c.9 0 1.7-.3 2.4-.7l3.2 3.2 1.4-1.4zm-3.8.1c-1.4 0-2.5-1.1-2.5-2.5s1.1-2.5 2.5-2.5 2.5 1.1 2.5 2.5-1.1 2.5-2.5 2.5M12 20v2C6.48 22 2 17.52 2 12S6.48 2 12 2c4.84 0 8.87 3.44 9.8 8h-2.07c-.64-2.46-2.4-4.47-4.73-5.41V5c0 1.1-.9 2-2 2h-2v2c0 .55-.45 1-1 1H8v2h2v3H9l-4.79-4.79C4.08 10.79 4 11.38 4 12c0 4.41 3.59 8 8 8"})),ht=o=>{const{t:s}=L(),r=Re.useIsMobileWidth(),{source:d,showSourceRepo:u}=o,{id:t,name:a,lang:n,iconUrl:h,supportsLatest:l,isNsfw:p,extension:{repo:b}}=d,x=O.isLocalSource(d)?s("source.local_source.title"):a;return e.jsx(q,{sx:{margin:1,marginTop:0},children:e.jsx(Ce,{component:G,to:k.sources.childRoutes.browse.path(t),state:{contentType:re.POPULAR,clearCache:!0},children:e.jsxs(X,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:1.5},children:[e.jsxs(U,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(ue,{variant:"rounded",alt:x,sx:{width:56,height:56,flex:"0 0 auto",mr:1,background:"transparent"},children:e.jsx(ie,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:x,src:f.getValidImgUrlFor(h)})}),e.jsxs(U,{sx:{display:"flex",flexDirection:"column",justifyContent:"center"},children:[e.jsx(m,{variant:"h6",component:"h3",children:x}),e.jsxs(m,{variant:"caption",sx:{display:"block"},children:[z(n),p&&e.jsx(m,{variant:"caption",color:"error",sx:{display:"inline"},children:" 18+"}),u&&e.jsx(m,{variant:"caption",sx:{display:"block"},children:b})]})]})]}),e.jsxs(le,{sx:{flexDirection:"row",gap:1},children:[l&&e.jsx(F,{...be.preventRippleProp(),variant:"outlined",component:G,to:k.sources.childRoutes.browse.path(t),state:{contentType:re.LATEST,clearCache:!0},children:s("global.button.latest")}),!r&&e.jsx(F,{...be.preventRippleProp(),variant:"outlined",component:G,to:k.sources.childRoutes.browse.path(t),state:{contentType:re.POPULAR,clearCache:!0},children:s("global.button.popular")})]})]})})})};function xt(){const{t:o}=L(),{setAction:s}=$(),[r,d]=Pe("shownSourceLangs",Be()),{settings:{showNsfw:u}}=ce(),{data:t,loading:a,error:n,refetch:h}=f.useGetSourceList({notifyOnNetworkStatusChange:!0}),l=t==null?void 0:t.sources.nodes,p=c.useMemo(()=>O.filter(l!=null?l:[],{showNsfw:u,languages:r,keepLocalSource:!0}),[l,r]),b=c.useMemo(()=>Object.entries(O.groupByLanguage(p)),[p]),x=c.useMemo(()=>O.getLanguages(l!=null?l:[]),[l]),A=c.useMemo(()=>O.areFromMultipleRepos(p),[p]),B=de();return c.useLayoutEffect(()=>(s(e.jsxs(e.Fragment,{children:[e.jsx(R,{title:o("search.title.global_search"),children:e.jsx(P,{onClick:()=>B(k.sources.childRoutes.searchAll.path),color:"inherit",children:e.jsx(ut,{})})}),e.jsx(_e,{selectedLanguages:r,setSelectedLanguages:d,languages:x})]})),()=>{s(null)}),[o,r,x]),a?e.jsx(Q,{}):n?e.jsx(H,{message:o("global.error.label.failed_to_load_data"),messageExtra:C(n),retry:()=>h().catch(N())}):(l==null?void 0:l.length)===0?e.jsx(H,{message:o("source.error.label.no_sources_found")}):e.jsx(e.Fragment,{children:b.map(([S,E])=>e.jsxs(c.Fragment,{children:[e.jsx(m,{variant:"h5",component:"h2",sx:{paddingLeft:3,paddingTop:1,paddingBottom:2,fontWeight:"bold"},children:z(S)},S),E.map(v=>e.jsx(ht,{source:v,showSourceRepo:A},v.id))]},S))})}function pt(o){const{t:s}=L(),{extension:{name:r,lang:d,versionName:u,isInstalled:t,hasUpdate:a,isObsolete:n,pkgName:h,iconUrl:l,isNsfw:p,repo:b},handleUpdate:x,showOptions:A,showSourceRepo:B,forcedState:S}=o,[E,v]=c.useState(K(t,n,a)),M=S!=null?S:E;c.useEffect(()=>{v(K(t,n,a))},[K(t,n,a)]);const V=d==="all"?s("extension.language.all"):d.toUpperCase(),D=async _=>{const J=Je[_],Z=Ye[_];try{switch(v(Z),_){case w.INSTALL:await f.updateExtension(h,{install:!0,isObsolete:n}).response;break;case w.UNINSTALL:await f.updateExtension(h,{uninstall:!0,isObsolete:n}).response;break;case w.UPDATE:await f.updateExtension(h,{update:!0,isObsolete:n}).response;break;default:throw new Error('Unexpected ExtensionAction "'.concat(_,'"'))}v(J),x()}catch(W){v(K(t,n,a)),T(s(ke[_],{count:1}),"error",C(W))}};function Y(){switch(M){case w.INSTALL:case w.UPDATE:case w.UNINSTALL:D(M).catch(N());break;case Ie.OBSOLETE:D(w.UNINSTALL).catch(N());break}}return e.jsx(q,{children:e.jsxs(X,{sx:{display:"flex",alignItems:"center",gap:1,p:1.5,"&:last-child":{paddingBottom:1.5}},children:[e.jsx(ue,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",background:"transparent"},alt:r,children:e.jsx(ie,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:r,src:f.getValidImgUrlFor(l)})}),e.jsxs(U,{sx:{display:"flex",flexDirection:"column",flexGrow:1,flexShrink:1,wordBreak:"break-word",justifyContent:"center"},children:[e.jsx(m,{variant:"h6",component:"h3",children:r}),e.jsxs(m,{variant:"caption",sx:{display:"block"},children:[V," ",u,p&&e.jsx(m,{variant:"caption",color:"error",sx:{display:"inline"},children:" 18+"})]}),B&&e.jsx(m,{variant:"caption",sx:{display:"block"},children:b})]}),t&&e.jsx(R,{title:s("settings.title"),children:e.jsx(P,{onClick:A,color:"inherit",children:e.jsx(Le,{})})}),e.jsx(F,{variant:"outlined",sx:{color:M===Qe.OBSOLETE?"red":"inherit",flexShrink:0},onClick:()=>Y(),children:s($e[M])})]})})}function gt({extensionId:o,closeDialog:s}){const{t:r}=L(),d=de(),{data:u,loading:t,error:a,refetch:n}=f.useGetSourceList({notifyOnNetworkStatusChange:!0});if(a)return e.jsx(Ee,{open:!!o,onClose:s});const h=c.useMemo(()=>o?u==null?void 0:u.sources.nodes.filter(l=>l.extension.pkgName===o):[],[u==null?void 0:u.sources.nodes,o]);return e.jsxs(Ee,{open:!!o,onClose:s,maxWidth:"md",fullWidth:!0,children:[e.jsx(De,{children:r("extension.settings.dialog.title")}),e.jsxs(Ge,{children:[t&&e.jsx(Q,{}),a&&e.jsx(H,{message:r("global.error.label.failed_to_load_data"),messageExtra:C(a),retry:()=>n().catch(N())}),!t&&!a&&e.jsx(U,{children:h==null?void 0:h.map(l=>e.jsx(he,{sx:{px:0},children:e.jsx(q,{children:e.jsxs(X,{sx:{display:"flex",alignItems:"center",gap:1,p:1.5,"&:last-child":{paddingBottom:1.5}},children:[e.jsx(m,{variant:"h6",component:"h3",sx:{flexGrow:1},children:z(O.getLanguage(l))}),l.isConfigurable&&e.jsx(R,{title:r("settings.title"),children:e.jsx(P,{onClick:()=>d(k.sources.childRoutes.configure.path(l.id)),color:"inherit",children:e.jsx(Le,{})})})]})})},l.id))})]})]})}const mt=0,ft=1,jt=({groupName:o,isFirstItem:s,groupExtensionIds:r,isUpdateGroup:d,updatingExtensionIds:u,setUpdatingExtensionIds:t,handleExtensionUpdate:a})=>{const{t:n}=L();return e.jsxs(at,{isFirstItem:s,sx:{flexDirection:"row",justifyContent:"space-between",alignItems:"center",pr:1},children:[e.jsx(m,{variant:"h5",component:"h2",children:z(o)}),d&&e.jsx(F,{disabled:!!u.length,variant:"contained",onClick:()=>{t(r),f.updateExtensions(r,{update:!0}).response.then(()=>a()).catch(h=>T(n(ke[w.UPDATE],{count:r.length}),"error",C(h))).finally(()=>t([]))},children:n("extension.action.label.update_all")})]},o)};function St({tabsMenuHeight:o}){var je,Se;const{t:s}=L(),{setAction:r}=$(),d=de(),{pathname:u,search:t,state:a}=Fe(),n=a==null?void 0:a.selectedExtensionPkg,{data:h,loading:l,error:p,refetch:b}=f.useGetServerSettings({notifyOnNetworkStatusChange:!0}),[x,{data:A,loading:B,error:S}]=f.useExtensionListFetch(),{settings:{extensionLanguages:E,showNsfw:v}}=ce(),M=we(i=>T(s("global.error.label.failed_to_save_changes"),"error",C(i))),[V]=Te("query",Ae),[D,Y]=c.useState([]),[_,J]=c.useState({}),Z=l||B,W=p!=null?p:S,Ne=!!(h!=null&&h.settings.extensionRepos.length),Me=((je=h==null?void 0:h.settings.extensionRepos.length)!=null?je:0)>1,j=(Se=A==null?void 0:A.fetchExtensions)==null?void 0:Se.extensions,xe=c.useMemo(()=>Ze(j!=null?j:[]),[j]),pe=c.useMemo(()=>et(j!=null?j:[],E,v,V),[j,E,E,V]),I=c.useMemo(()=>tt(pe),[pe]),ge=c.useMemo(()=>I.map(i=>i[ft].length),[I]),ee=c.useMemo(()=>I.map(([,i])=>i).flat(1),[I]),Oe=ot.useCreateGroupedComputeItemKey(ge,c.useCallback(i=>I[i][mt],[I]),c.useCallback(i=>ee[i].pkgName,[ee])),te=c.useCallback(()=>J({}),[]),me=i=>{d(u+t,{replace:!0,state:{selectedExtensionPkg:i}})},fe=i=>{if(!i.name.toLowerCase().endsWith("apk")){T(s("global.error.label.invalid_file_type"),"error");return}T(s("extension.label.installing_file"),"info"),f.installExternalExtension(i).response.then(()=>{te(),T(s("extension.label.installed_successfully"),"success")}).catch(g=>T(s("extension.label.installation_failed"),"error",C(g)))};return c.useEffect(()=>{x()},[_]),c.useLayoutEffect(()=>(r(e.jsxs(e.Fragment,{children:[e.jsx(Xe,{}),e.jsx(R,{title:s("extension.action.label.install_external"),children:e.jsx(P,{onClick:()=>{const i=document.createElement("input");i.style.display="none",i.type="file",i.onchange=()=>{var y;const g=(y=i.files)==null?void 0:y[0];g&&fe(g)},document.documentElement.appendChild(i),i.click(),document.documentElement.removeChild(i)},color:"inherit",children:e.jsx(He,{})})}),e.jsx(_e,{selectedLanguages:E,setSelectedLanguages:i=>M("extensionLanguages",i),languages:xe})]})),()=>{r(null)}),[s,E,xe]),c.useEffect(()=>{const i=async y=>{y.preventDefault();const se=await nt(y);fe(se[0])},g=y=>{y.preventDefault()};return document.addEventListener("drop",i),document.addEventListener("dragover",g),()=>{document.removeEventListener("drop",i),document.removeEventListener("dragover",g)}},[]),Z?e.jsx(Q,{}):W?e.jsx(H,{message:s("global.error.label.failed_to_load_data"),messageExtra:C(W),retry:()=>{p&&b().catch(N()),S&&x().catch(N())}}):!(j!=null&&j.length)&&!Ne?e.jsxs(le,{sx:{alignItems:"center",justifyContent:"center",rowGap:"10px",paddingTop:"20px"},children:[e.jsx(m,{children:s("extension.label.add_repository_info")}),e.jsx(F,{component:G,variant:"contained",to:k.browse.path,children:s("settings.title")})]}):e.jsxs(e.Fragment,{children:[e.jsx(rt,{heightToSubtract:o,overscan:window.innerHeight*.5,groupCounts:ge,groupContent:i=>{const[g,y]=I[i],se=g===st.UPDATE_PENDING;return e.jsx(jt,{groupName:g,isFirstItem:i===0,groupExtensionIds:y.map(Ue=>Ue.pkgName),isUpdateGroup:se,updatingExtensionIds:D,setUpdatingExtensionIds:Y,handleExtensionUpdate:te})},computeItemKey:Oe,itemContent:i=>{const g=ee[i];return e.jsx(he,{children:e.jsx(pt,{extension:g,handleUpdate:te,showSourceRepo:Me,forcedState:D.includes(g.pkgName)?Ie.UPDATING:void 0,showOptions:()=>me(g.pkgName)})})}}),e.jsx(gt,{extensionId:n,closeDialog:()=>me(void 0)})]})}const bt=ae(e.jsx("path",{d:"M14.94 4.66h-4.72l2.36-2.36zm-4.69 14.71h4.66l-2.33 2.33zM6.1 6.27 1.6 17.73h1.84l.92-2.45h5.11l.92 2.45h1.84L7.74 6.27zm-1.13 7.37 1.94-5.18 1.94 5.18zm10.76 2.5h6.12v1.59h-8.53v-1.29l5.92-8.56h-5.88v-1.6h8.3v1.26z"})),Et=ae(e.jsx("path",{d:"M20 10V8h-4V4h-2v4h-4V4H8v4H4v2h4v4H4v2h4v4h2v-4h4v4h2v-4h4v-2h-4v-4zm-6 4h-4v-4h4z"})),vt=({id:o,name:s,lang:r,iconUrl:d,mangaCount:u})=>{const{t}=L(),n=Number(o)===0?t("source.local_source.title"):s;return e.jsx(q,{children:e.jsx(Ce,{component:G,to:k.migrate.path(o),children:e.jsxs(X,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",p:1.5},children:[e.jsxs(U,{sx:{display:"flex"},children:[e.jsx(ue,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",mr:1,background:"transparent"},children:e.jsx(ie,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:n,src:f.getValidImgUrlFor(d)})}),e.jsxs(U,{sx:{display:"flex",flexDirection:"column",justifyContent:"center"},children:[e.jsx(m,{variant:"h6",component:"h3",children:n}),e.jsx(m,{variant:"caption",sx:{display:"block"},children:z(r)})]})]}),e.jsx(dt,{sx:{borderRadius:1},size:"small",label:u})]})})})},yt=(o,{sortBy:s,sortOrder:r})=>{if(!o)return[];const d={};o.forEach(({sourceId:t,source:a})=>{var h;const n=(h=d[t])!=null?h:{id:t,name:t,lang:"unknown",iconUrl:null,mangaCount:0,...a};d[t]={...n,mangaCount:n.mangaCount+1}});const u=Object.values(d).toSorted((t,a)=>{switch(s){case ve.SOURCE_NAME:return t.name.localeCompare(a.name);case ve.MANGA_COUNT:return t.mangaCount-a.mangaCount;default:throw new Error('Unexpected "sortBy" "'.concat(s,'"'))}});switch(r){case ye.ASC:return u;case ye.DESC:return u.toReversed();default:throw new Error('Unexpected "sortOrder" "'.concat(r,'"'))}},Ct=({tabsMenuHeight:o})=>{const{t:s}=L(),{appBarHeight:r}=$(),{settings:{migrateSortSettings:d}}=ce(),u=we(x=>T(s("global.error.label.failed_to_save_changes"),"error",C(x))),{sortBy:t,sortOrder:a}=d,{data:n,loading:h,error:l,refetch:p}=f.useGetMigratableSources({notifyOnNetworkStatusChange:!0}),b=c.useMemo(()=>yt(n==null?void 0:n.mangas.nodes,d),[n==null?void 0:n.mangas.nodes,d]);return h?e.jsx(Q,{}):l?e.jsx(H,{message:s("global.error.label.failed_to_load_data"),messageExtra:C(l),retry:()=>p().catch(N())}):e.jsxs(e.Fragment,{children:[e.jsxs(le,{sx:{position:"sticky",top:"".concat(r+o,"px"),flexDirection:"row",justifyContent:"end",alignItems:"center",gap:1,p:1,backgroundColor:"background.default",zIndex:1},children:[e.jsx(R,{title:s(ze[t]),children:e.jsx(P,{color:"inherit",onClick:()=>u("migrateSortSettings",{sortBy:(t+1)%2,sortOrder:a}),children:t?e.jsx(Et,{}):e.jsx(bt,{})})}),e.jsx(R,{title:s(Ve[a]),children:e.jsx(P,{color:"inherit",onClick:()=>u("migrateSortSettings",{sortBy:t,sortOrder:(a+1)%2}),children:a?e.jsx(lt,{}):e.jsx(ct,{})})})]}),e.jsx(We,{sx:{p:0},children:b.map(x=>e.jsx(he,{children:e.jsx(vt,{...x})},x.id))})]})};function Zt(){const{t:o}=L(),{setTitle:s}=$();c.useLayoutEffect(()=>{s(o("global.label.browse"))},[o]);const r=c.useRef(null),[d,u]=c.useState(0);Ke(r,c.useCallback(()=>u(r.current.offsetHeight),[r.current]));const[t,a]=Te("tab",Ae,{}),n=t!=null?t:"source";return t||a(n,"replaceIn"),e.jsxs(it,{children:[e.jsxs(qe,{ref:r,variant:"fullWidth",value:n,onChange:(h,l)=>a(l,"replaceIn"),children:[e.jsx(ne,{value:"source",sx:{textTransform:"none"},label:o("source.title_one")}),e.jsx(ne,{value:"extensions",sx:{textTransform:"none"},label:o("extension.title_other")}),e.jsx(ne,{value:"migrate",sx:{textTransform:"none"},label:o("migrate.title")})]}),e.jsx(oe,{index:"source",currentIndex:n,children:e.jsx(xt,{})}),e.jsx(oe,{index:"extensions",currentIndex:n,children:e.jsx(St,{tabsMenuHeight:d})}),e.jsx(oe,{index:"migrate",currentIndex:n,children:e.jsx(Ct,{tabsMenuHeight:d})})]})}export{Zt as Browse};
