import{c as re,j as e,u as C,M as Ue,A as N,L as P,r as g,S as q,T as x,B,a as Re,s as Pe,b as ae,d as p,e as ie,C as O,I as U,f as K,g as b,h as I,i as Ce,m as L,D as fe,k as Be,l as Ge,n as oe,o as De,p as ve,q as Fe,t as ze,v as He,w as Ve,x as je,y as Se,z as We,G as qe}from"./index-CBxbdOZa.js";import{u as Te,S as Le,A as Ke}from"./AppbarSearch-DDqDFRU_.js";import{SourceContentType as te}from"./SourceMangas-BDROJYOJ.js";import{t as D,L as we,g as W,I as Xe,a as $e,E as _e,b as T,c as Qe,d as Ye,e as Ae,f as Ze,h as Je,i as et,j as tt}from"./LanguageSelect-D96QFEAj.js";import{M as Ee}from"./MUI.util-Bs9Vl2GD.js";import{S as M}from"./Sources-3VCFbudu.js";import{L as ce}from"./ListCardAvatar-Olf2Zaaj.js";import{L as X}from"./ListCardContent-DPbnp6xG.js";import{C as $}from"./Card-BbGJVXOW.js";import{C as ye}from"./CardActionArea-Dl3PGSnS.js";import{E as G}from"./EmptyViewAbsoluteCentered-DCgg8ff9.js";import{u as Ne}from"./useAppAction-mbKoUHfz.js";import{f as st}from"./file-selector-DlHkLoY8.js";import{A as nt}from"./Add-BMjR09-I.js";import{S as le,V as ot,a as rt,b as at}from"./Virtuoso.util-CtTergbz.js";import{u as be}from"./use-window-event-BNPYW1ld.js";import{T as se,a as ne}from"./Tabs-Dh2MNhFT.js";import{T as it}from"./TabsWrapper-GgZTmZfl.js";import{T as ct}from"./TabsMenu-vbORML4f.js";import{A as lt,a as ut}from"./SortRadioInput-C0KOM6aU.js";import{C as dt}from"./Chip-BeTPtnoR.js";import{u as pt}from"./useAppTitle-BmkqDPsV.js";import"./ChaptersDownloadActionMenuItems-BVTXZK2z.js";import"./Trackers-D4pSmk7a.js";import"./Avatar-CczBYppx.js";import"./TextField-DuGJKvvj.js";import"./useFormControl-EdH_WGd-.js";import"./formControlState-Dq1zat_P.js";import"./InputAdornment-PGzZQUDk.js";import"./CheckCircle-BNV6sksU.js";import"./Link-CO7UWlYn.js";import"./useManageMangaLibraryState-DEU-P4Qb.js";import"./ThreeStateCheckboxInput-wiEnqza-.js";import"./Checkbox-D5Y8DhmM.js";import"./SwitchBase-Bt1MmkrC.js";import"./CheckboxInput-0NO2rdo0.js";import"./FormGroup-BzOyOVHv.js";import"./ListPreference-CfCfOuBQ.js";import"./NumberSetting-CFmaU-S2.js";import"./Slider-yvhelXje.js";import"./useMobilePicker-Dq_KXUip.js";import"./SelectSetting-BMUn1mO-.js";import"./Select-DcTUCpv6.js";import"./Favorite-C1IjVGUp.js";import"./FilterList-DX5t4YRj.js";import"./GridLayouts-DHVdgnJy.js";import"./Delete-CPYpmXa7.js";import"./ExpandMore-Al-iG_6o.js";import"./useDebounce-Cy8G1E5s.js";import"./StyledFab-tc657Z86.js";import"./BaseMangaGrid-B507VjY3.js";import"./MangaGrid-BdnTyJHa.js";import"./Download-Dvr2tlzK.js";import"./Sync-QsScqzp8.js";import"./use-merged-ref-BIpNM0cx.js";import"./PlayArrow-Bu-WWWUu.js";import"./useAppTitleAndAction-D4rw2KWz.js";import"./Switch-Bv3Q3BvN.js";const ht=re(e.jsx("path",{d:"M19.3 16.9c.4-.7.7-1.5.7-2.4 0-2.5-2-4.5-4.5-4.5S11 12 11 14.5s2 4.5 4.5 4.5c.9 0 1.7-.3 2.4-.7l3.2 3.2 1.4-1.4zm-3.8.1c-1.4 0-2.5-1.1-2.5-2.5s1.1-2.5 2.5-2.5 2.5 1.1 2.5 2.5-1.1 2.5-2.5 2.5M12 20v2C6.48 22 2 17.52 2 12S6.48 2 12 2c4.84 0 8.87 3.44 9.8 8h-2.07c-.64-2.46-2.4-4.47-4.73-5.41V5c0 1.1-.9 2-2 2h-2v2c0 .55-.45 1-1 1H8v2h2v3H9l-4.79-4.79C4.08 10.79 4 11.38 4 12c0 4.41 3.59 8 8 8"})),xt=a=>{const{t}=C(),l=Ue.useIsMobileWidth(),{source:u,showSourceRepo:c}=a,{id:s,name:o,lang:n,iconUrl:i,supportsLatest:d,isNsfw:E,extension:{repo:f}}=u,h=M.isLocalSource(u)?t("source.local_source.title"):o;return e.jsx($,{sx:{margin:1,marginTop:0},children:e.jsx(ye,{component:P,to:N.sources.childRoutes.browse.path(s),state:{contentType:te.POPULAR,clearCache:!0},children:e.jsxs(X,{children:[e.jsx(ce,{iconUrl:g.getValidImgUrlFor(i),alt:h}),e.jsxs(q,{sx:{justifyContent:"center",flexGrow:1,flexShrink:1,wordBreak:"break-word"},children:[e.jsx(x,{variant:"h6",component:"h3",children:h}),e.jsxs(x,{variant:"caption",children:[D(n),E&&e.jsx(x,{variant:"caption",color:"error",children:" 18+"})]}),c&&e.jsx(x,{variant:"caption",children:f})]}),d&&e.jsx(B,{...Ee.preventRippleProp(),variant:"outlined",component:P,to:N.sources.childRoutes.browse.path(s),state:{contentType:te.LATEST,clearCache:!0},children:t("global.button.latest")}),!l&&e.jsx(B,{...Ee.preventRippleProp(),variant:"outlined",component:P,to:N.sources.childRoutes.browse.path(s),state:{contentType:te.POPULAR,clearCache:!0},children:t("global.button.popular")})]})})})};function mt(){const{t:a}=C(),[t,l]=Re("shownSourceLangs",Pe()),{settings:{showNsfw:u}}=ae(),{data:c,loading:s,error:o,refetch:n}=g.useGetSourceList({notifyOnNetworkStatusChange:!0}),i=c==null?void 0:c.sources.nodes,d=p.useMemo(()=>M.filter(i!=null?i:[],{showNsfw:u,languages:t,keepLocalSource:!0}),[i,t]),E=p.useMemo(()=>Object.entries(M.groupByLanguage(d)),[d]),f=p.useMemo(()=>M.getLanguages(i!=null?i:[]),[i]),h=p.useMemo(()=>M.areFromMultipleRepos(d),[d]),R=ie();return Ne(e.jsxs(e.Fragment,{children:[e.jsx(O,{title:a("search.title.global_search"),children:e.jsx(U,{onClick:()=>R(N.sources.childRoutes.searchAll.path),color:"inherit",children:e.jsx(ht,{})})}),e.jsx(we,{selectedLanguages:t,setSelectedLanguages:l,languages:f})]}),[a,t,f]),s?e.jsx(K,{}):o?e.jsx(G,{message:a("global.error.label.failed_to_load_data"),messageExtra:b(o),retry:()=>n().catch(I())}):(i==null?void 0:i.length)===0?e.jsx(G,{message:a("source.error.label.no_sources_found")}):e.jsx(e.Fragment,{children:E.map(([v,S])=>e.jsxs(p.Fragment,{children:[e.jsx(x,{variant:"h5",component:"h2",sx:{paddingLeft:3,paddingTop:1,paddingBottom:2,fontWeight:"bold"},children:D(v)},v),S.map(w=>e.jsx(xt,{source:w,showSourceRepo:h},w.id))]},v))})}function gt(a){const{t}=C(),{extension:{name:l,lang:u,versionName:c,isInstalled:s,hasUpdate:o,isObsolete:n,pkgName:i,iconUrl:d,isNsfw:E,repo:f},handleUpdate:h,showOptions:R,showSourceRepo:v,forcedState:S}=a,[w,k]=p.useState(W(s,n,o)),_=S!=null?S:w;p.useEffect(()=>{k(W(s,n,o))},[W(s,n,o)]);const F=u==="all"?t("extension.language.all"):u.toUpperCase(),z=async A=>{const Y=Ye[A],H=Qe[A];try{switch(k(H),A){case T.INSTALL:await g.updateExtension(i,{install:!0,isObsolete:n}).response;break;case T.UNINSTALL:await g.updateExtension(i,{uninstall:!0,isObsolete:n}).response;break;case T.UPDATE:await g.updateExtension(i,{update:!0,isObsolete:n}).response;break;default:throw new Error('Unexpected ExtensionAction "'.concat(A,'"'))}k(Y),h()}catch(Z){k(W(s,n,o)),L(t(Ae[A],{count:1}),"error",b(Z))}};function Q(){switch(_){case T.INSTALL:case T.UPDATE:case T.UNINSTALL:z(_).catch(I());break;case _e.OBSOLETE:z(T.UNINSTALL).catch(I());break}}return e.jsx($,{children:e.jsxs(X,{children:[e.jsx(ce,{iconUrl:g.getValidImgUrlFor(d),alt:l}),e.jsxs(q,{sx:{justifyContent:"center",flexGrow:1,flexShrink:1,wordBreak:"break-word"},children:[e.jsx(x,{variant:"h6",component:"h3",children:l}),e.jsxs(x,{variant:"caption",children:[F," ",c,E&&e.jsx(x,{variant:"caption",color:"error",children:" 18+"})]}),v&&e.jsx(x,{variant:"caption",children:f})]}),s&&e.jsx(O,{title:t("settings.title"),children:e.jsx(U,{onClick:R,color:"inherit",children:e.jsx(Ce,{})})}),e.jsx(B,{variant:"outlined",sx:{color:_===$e.OBSOLETE?"red":"inherit",flexShrink:0},onClick:()=>Q(),children:t(Xe[_])})]})})}function ft({extensionId:a,closeDialog:t}){const{t:l}=C(),u=ie(),{data:c,loading:s,error:o,refetch:n}=g.useGetSourceList({notifyOnNetworkStatusChange:!0});if(o)return e.jsx(fe,{open:!!a,onClose:t});const i=p.useMemo(()=>a?c==null?void 0:c.sources.nodes.filter(d=>d.extension.pkgName===a):[],[c==null?void 0:c.sources.nodes,a]);return e.jsxs(fe,{open:!!a,onClose:t,maxWidth:"md",fullWidth:!0,children:[e.jsx(Be,{children:l("extension.settings.dialog.title")}),e.jsxs(Ge,{children:[s&&e.jsx(K,{}),o&&e.jsx(G,{message:l("global.error.label.failed_to_load_data"),messageExtra:b(o),retry:()=>n().catch(I())}),!s&&!o&&e.jsx(oe,{children:i==null?void 0:i.map(d=>e.jsx(le,{sx:{px:0},children:e.jsx($,{children:e.jsxs(X,{children:[e.jsx(x,{variant:"h6",component:"h3",sx:{flexGrow:1},children:D(M.getLanguage(d))}),d.isConfigurable&&e.jsx(O,{title:l("settings.title"),children:e.jsx(U,{onClick:()=>u(N.sources.childRoutes.configure.path(d.id)),color:"inherit",children:e.jsx(Ce,{})})})]})})},d.id))})]})]})}const jt=0,St=1,Et=({groupName:a,isFirstItem:t,groupExtensionIds:l,isUpdateGroup:u,updatingExtensionIds:c,setUpdatingExtensionIds:s,handleExtensionUpdate:o})=>{const{t:n}=C();return e.jsxs(at,{isFirstItem:t,sx:{flexDirection:"row",justifyContent:"space-between",alignItems:"center",pr:1},children:[e.jsx(x,{variant:"h5",component:"h2",children:D(a)}),u&&e.jsx(B,{disabled:!!c.length,variant:"contained",onClick:()=>{s(l),g.updateExtensions(l,{update:!0}).response.then(()=>o()).catch(i=>L(n(Ae[T.UPDATE],{count:l.length}),"error",b(i))).finally(()=>s([]))},children:n("extension.action.label.update_all")})]},a)};function bt({tabsMenuHeight:a}){var me,ge;const{t}=C(),l=ie(),{pathname:u,search:c,state:s}=De(),o=s==null?void 0:s.selectedExtensionPkg,{data:n,loading:i,error:d,refetch:E}=g.useGetServerSettings({notifyOnNetworkStatusChange:!0}),[f,{data:h,loading:R,error:v}]=g.useExtensionListFetch(),{settings:{extensionLanguages:S,showNsfw:w}}=ae(),k=ve(r=>L(t("global.error.label.failed_to_save_changes"),"error",b(r))),[_]=Te("query",Le),[F,z]=p.useState([]),[Q,A]=p.useState({}),Y=i||R,H=d!=null?d:v,Z=!!(n!=null&&n.settings.extensionRepos.length),Ie=((me=n==null?void 0:n.settings.extensionRepos.length)!=null?me:0)>1,j=(ge=h==null?void 0:h.fetchExtensions)==null?void 0:ge.extensions,ue=p.useMemo(()=>Ze(j!=null?j:[]),[j]),de=p.useMemo(()=>Je(j!=null?j:[],{selectedLanguages:S,showNsfw:w,query:_}),[j,S,w,_]),y=p.useMemo(()=>et(de),[de]),pe=p.useMemo(()=>y.map(r=>r[St].length),[y]),J=p.useMemo(()=>y.map(([,r])=>r).flat(1),[y]),ke=ot.useCreateGroupedComputeItemKey(pe,p.useCallback(r=>y[r][jt],[y]),p.useCallback(r=>J[r].pkgName,[J])),ee=p.useCallback(()=>A({}),[]),he=r=>{l(u+c,{replace:!0,state:{selectedExtensionPkg:r}})},xe=r=>{if(!r.name.toLowerCase().endsWith("apk")){L(t("global.error.label.invalid_file_type"),"error");return}L(t("extension.label.installing_file"),"info"),g.installExternalExtension(r).response.then(()=>{ee(),L(t("extension.label.installed_successfully"),"success")}).catch(m=>L(t("extension.label.installation_failed"),"error",b(m)))};return p.useEffect(()=>{f()},[Q]),Ne(e.jsxs(e.Fragment,{children:[e.jsx(Ke,{}),e.jsx(O,{title:t("extension.action.label.install_external"),children:e.jsx(U,{onClick:()=>{const r=document.createElement("input");r.style.display="none",r.type="file",r.onchange=()=>{var V;const m=(V=r.files)==null?void 0:V[0];m&&xe(m)},document.documentElement.appendChild(r),r.click(),document.documentElement.removeChild(r)},color:"inherit",children:e.jsx(nt,{})})}),e.jsx(we,{selectedLanguages:S,setSelectedLanguages:r=>k("extensionLanguages",r),languages:ue})]}),[t,S,ue]),be("drop",async r=>{r.preventDefault();const m=await st(r);xe(m[0])}),be("dragover",r=>{r.preventDefault()}),Y?e.jsx(K,{}):H?e.jsx(G,{message:t("global.error.label.failed_to_load_data"),messageExtra:b(H),retry:()=>{d&&E().catch(I()),v&&f().catch(I())}}):!(j!=null&&j.length)&&!Z?e.jsxs(q,{sx:{alignItems:"center",justifyContent:"center",rowGap:"10px",paddingTop:"20px"},children:[e.jsx(x,{children:t("extension.label.add_repository_info")}),e.jsx(B,{component:P,variant:"contained",to:N.settings.childRoutes.browse.path,children:t("settings.title")})]}):e.jsxs(e.Fragment,{children:[e.jsx(rt,{heightToSubtract:a,overscan:window.innerHeight*.5,groupCounts:pe,groupContent:r=>{const[m,V]=y[r],Me=m===tt.UPDATE_PENDING;return e.jsx(Et,{groupName:m,isFirstItem:r===0,groupExtensionIds:V.map(Oe=>Oe.pkgName),isUpdateGroup:Me,updatingExtensionIds:F,setUpdatingExtensionIds:z,handleExtensionUpdate:ee})},computeItemKey:ke,itemContent:r=>{const m=J[r];return e.jsx(le,{children:e.jsx(gt,{extension:m,handleUpdate:ee,showSourceRepo:Ie,forcedState:F.includes(m.pkgName)?_e.UPDATING:void 0,showOptions:()=>he(m.pkgName)})})}}),e.jsx(ft,{extensionId:o,closeDialog:()=>he(void 0)})]})}const Ct=re(e.jsx("path",{d:"M14.94 4.66h-4.72l2.36-2.36zm-4.69 14.71h4.66l-2.33 2.33zM6.1 6.27 1.6 17.73h1.84l.92-2.45h5.11l.92 2.45h1.84L7.74 6.27zm-1.13 7.37 1.94-5.18 1.94 5.18zm10.76 2.5h6.12v1.59h-8.53v-1.29l5.92-8.56h-5.88v-1.6h8.3v1.26z"})),vt=re(e.jsx("path",{d:"M20 10V8h-4V4h-2v4h-4V4H8v4H4v2h4v4H4v2h4v4h2v-4h4v4h2v-4h4v-2h-4v-4zm-6 4h-4v-4h4z"})),Tt=({id:a,name:t,lang:l,iconUrl:u,mangaCount:c})=>{const{t:s}=C(),n=Number(a)===0?s("source.local_source.title"):t;return e.jsx($,{children:e.jsx(ye,{component:P,to:N.migrate.path(a),children:e.jsxs(X,{sx:{justifyContent:"space-between"},children:[e.jsxs(oe,{sx:{display:"flex",gap:1},children:[e.jsx(ce,{iconUrl:g.getValidImgUrlFor(u),alt:n}),e.jsxs(oe,{sx:{display:"flex",flexDirection:"column",justifyContent:"center"},children:[e.jsx(x,{variant:"h6",component:"h3",children:n}),e.jsx(x,{variant:"caption",sx:{display:"block"},children:D(l)})]})]}),e.jsx(dt,{sx:{borderRadius:1},size:"small",label:c})]})})})},Lt=(a,{sortBy:t,sortOrder:l})=>{if(!a)return[];const u={};a.forEach(({sourceId:s,source:o})=>{var i;const n=(i=u[s])!=null?i:{id:s,name:s,lang:"unknown",iconUrl:null,mangaCount:0,...o};u[s]={...n,mangaCount:n.mangaCount+1}});const c=Object.values(u).toSorted((s,o)=>{switch(t){case je.SOURCE_NAME:return s.name.localeCompare(o.name);case je.MANGA_COUNT:return s.mangaCount-o.mangaCount;default:throw new Error('Unexpected "sortBy" "'.concat(t,'"'))}});switch(l){case Se.ASC:return c;case Se.DESC:return c.toReversed();default:throw new Error('Unexpected "sortOrder" "'.concat(l,'"'))}},wt=({tabsMenuHeight:a})=>{const{t}=C(),{appBarHeight:l}=Fe(),{settings:{migrateSortSettings:u}}=ae(),c=ve(h=>L(t("global.error.label.failed_to_save_changes"),"error",b(h))),{sortBy:s,sortOrder:o}=u,{data:n,loading:i,error:d,refetch:E}=g.useGetMigratableSources({notifyOnNetworkStatusChange:!0}),f=p.useMemo(()=>Lt(n==null?void 0:n.mangas.nodes,u),[n==null?void 0:n.mangas.nodes,u]);return i?e.jsx(K,{}):d?e.jsx(G,{message:t("global.error.label.failed_to_load_data"),messageExtra:b(d),retry:()=>E().catch(I())}):e.jsxs(e.Fragment,{children:[e.jsxs(q,{sx:{position:"sticky",top:"".concat(l+a,"px"),flexDirection:"row",justifyContent:"end",alignItems:"center",gap:1,p:1,backgroundColor:"background.default",zIndex:1},children:[e.jsx(O,{title:t(ze[s]),children:e.jsx(U,{color:"inherit",onClick:()=>c("migrateSortSettings",{sortBy:(s+1)%2,sortOrder:o}),children:s?e.jsx(vt,{}):e.jsx(Ct,{})})}),e.jsx(O,{title:t(He[o]),children:e.jsx(U,{color:"inherit",onClick:()=>c("migrateSortSettings",{sortBy:s,sortOrder:(o+1)%2}),children:o?e.jsx(lt,{}):e.jsx(ut,{})})})]}),e.jsx(Ve,{sx:{p:0},children:f.map(h=>e.jsx(le,{children:e.jsx(Tt,{...h})},h.id))})]})};function ks(){const{t:a}=C();pt(a("global.label.browse"));const t=p.useRef(null),[l,u]=p.useState(0);We(t,p.useCallback(()=>u(t.current.offsetHeight),[t.current]));const[c,s]=Te("tab",Le,{}),o=c!=null?c:"source";return c||s(o,"replaceIn"),e.jsxs(it,{children:[e.jsxs(ct,{ref:t,sx:{zIndex:qe},variant:"fullWidth",value:o,onChange:(n,i)=>s(i,"replaceIn"),children:[e.jsx(se,{value:"source",sx:{textTransform:"none"},label:a("source.title_one")}),e.jsx(se,{value:"extensions",sx:{textTransform:"none"},label:a("extension.title_other")}),e.jsx(se,{value:"migrate",sx:{textTransform:"none"},label:a("migrate.title")})]}),e.jsx(ne,{index:"source",currentIndex:o,children:e.jsx(mt,{})}),e.jsx(ne,{index:"extensions",currentIndex:o,children:e.jsx(bt,{tabsMenuHeight:l})}),e.jsx(ne,{index:"migrate",currentIndex:o,children:e.jsx(wt,{tabsMenuHeight:l})})]})}export{ks as Browse};
