import{r as ee,i as te,j as e,u as N,M as Pe,C as se,a as we,L as R,A as I,b as ne,B as M,S as re,c as S,T as m,d as oe,e as U,f as l,N as ae,g as G,h as Fe,k as H,I as z,l as ie,E as $,m as A,n as _,o as Ge,p as He,q as ze,s as $e,t as qe,v as Ve,w as ve,x as Ee,y as We,z as Ke,D as Xe,F as Y,G as J}from"./index-DHLtiJ0j.js";import{u as Te,S as Ce,A as Qe}from"./AppbarSearch-KmuCuPzm.js";import{s as be,l as _e,D as q,a as Ye,e as Je}from"./Languages-D_YnVw1h.js";import{SourceContentType as Z}from"./SourceMangas-Cx1IPdae.js";import{t as V,L as Ne,g as F,I as Ze,a as et,E as Ie,b as T,c as Ae,d as tt,e as st,f as nt,i as rt,h as ot}from"./LangSelect-DzrhsUCe.js";import{A as le}from"./Avatar-C8_cx_tI.js";import{f as at}from"./file-selector-DltLnd9h.js";import{V as it,S as lt,a as ct,b as Oe}from"./Virtuoso.util-DzDBCyeE.js";import{T as ut}from"./TabsWrapper-C2fSyhaL.js";import{d as dt,a as ht}from"./SortRadioInput-BAV4Wjcg.js";import{C as xt}from"./Chip-B4C8tWoL.js";import"./useManageMangaLibraryState-CRtqSfNP.js";import"./Trackers-D4pSmk7a.js";import"./CheckCircle-CnNx9X8n.js";import"./Mangas-DI8_YpP1.js";import"./ListPreference-CCvGONa0.js";import"./NumberSetting-P9re5MVD.js";import"./useMobilePicker-rk0A1j_6.js";import"./SelectSetting-9tLytkqs.js";import"./ThreeStateCheckboxInput-rbUvS-f_.js";import"./ExpandMore-DFTaTP_9.js";import"./FilterList-CybhqNBC.js";import"./GridLayouts-BjBJ7u_Z.js";import"./useDebounce-sgZ1O82Y.js";import"./StyledFab-DoBQ-ajE.js";import"./BaseMangaGrid-CzBzMb2G.js";import"./MangaGrid-DAG-q0oC.js";import"./Sync-CAY5-RiT.js";import"./PlayArrow-Ddm6shGJ.js";import"./cloneObject-DrOPTG0J.js";import"./Switch-DFGDUzJ7.js";var ce={},pt=te;Object.defineProperty(ce,"__esModule",{value:!0});var ke=ce.default=void 0,ft=pt(ee()),gt=e;ke=ce.default=(0,ft.default)((0,gt.jsx)("path",{d:"M19.3 16.9c.4-.7.7-1.5.7-2.4 0-2.5-2-4.5-4.5-4.5S11 12 11 14.5s2 4.5 4.5 4.5c.9 0 1.7-.3 2.4-.7l3.2 3.2 1.4-1.4zm-3.8.1c-1.4 0-2.5-1.1-2.5-2.5s1.1-2.5 2.5-2.5 2.5 1.1 2.5 2.5-1.1 2.5-2.5 2.5M12 20v2C6.48 22 2 17.52 2 12S6.48 2 12 2c4.84 0 8.87 3.44 9.8 8h-2.07c-.64-2.46-2.4-4.47-4.73-5.41V5c0 1.1-.9 2-2 2h-2v2c0 .55-.45 1-1 1H8v2h2v3H9l-4.79-4.79C4.08 10.79 4 11.38 4 12c0 4.41 3.59 8 8 8"}),"TravelExplore");const mt=c=>{const{t}=N(),n=Pe.useIsMobileWidth(),{source:{id:r,name:u,lang:s,iconUrl:h,supportsLatest:o,isNsfw:p,extension:{repo:a}},showSourceRepo:j}=c,d=Number(r)===0?t("source.local_source.title"):u;return e.jsx(se,{sx:{margin:1,marginTop:0},children:e.jsx(we,{component:R,to:I.sources.childRoutes.browse.path(r),state:{contentType:Z.POPULAR,clearCache:!0},children:e.jsxs(ne,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:1.5},children:[e.jsxs(M,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(le,{variant:"rounded",alt:d,sx:{width:56,height:56,flex:"0 0 auto",mr:1,background:"transparent"},children:e.jsx(re,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:d,src:S.getValidImgUrlFor(h)})}),e.jsxs(M,{sx:{display:"flex",flexDirection:"column",justifyContent:"center"},children:[e.jsx(m,{variant:"h6",component:"h3",children:d}),e.jsxs(m,{variant:"caption",sx:{display:"block"},children:[V(s),p&&e.jsx(m,{variant:"caption",color:"error",sx:{display:"inline"},children:" 18+"}),j&&e.jsx(m,{variant:"caption",sx:{display:"block"},children:a})]})]})]}),e.jsxs(oe,{sx:{flexDirection:"row",gap:1},children:[o&&e.jsx(U,{variant:"outlined",component:R,to:I.sources.childRoutes.browse.path(r),state:{contentType:Z.LATEST,clearCache:!0},children:t("global.button.latest")}),!n&&e.jsx(U,{variant:"outlined",component:R,to:I.sources.childRoutes.browse.path(r),state:{contentType:Z.POPULAR,clearCache:!0},children:t("global.button.popular")})]})]})})})};function jt(c){const t=new Set;return c.forEach(n=>{const u=Number(n.id)===0?q.OTHER:n.lang;t.add(u)}),[...t].sort(_e)}function St(c){const t={};return c.forEach(n=>{var s;const u=Number(n.id)===0?q.OTHER:n.lang;(s=t[u])!=null||(t[u]=[]),t[u].push(n)}),Object.values(t).forEach(n=>n.sort((r,u)=>r.name.localeCompare(u.name))),t}function vt(){const{t:c}=N(),{setAction:t}=l.useContext(ae),[n,r]=G("shownSourceLangs",Ye()),[u]=G("showNsfw",!0),{data:s,loading:h,error:o,refetch:p}=S.useGetSourceList({notifyOnNetworkStatusChange:!0}),a=s==null?void 0:s.sources.nodes,j=l.useMemo(()=>{if(!a||a!=null&&a.length)return!1;const{repo:d}=a[0].extension;return a.some(g=>g.extension.repo!==d)},[a]),L=Fe();return l.useEffect(()=>{be().forEach(d=>{let g=!1;n.forEach(x=>{x===d&&(g=!0)}),g||r(x=>(x.push(d),x))})},[]),l.useLayoutEffect(()=>(t(e.jsxs(e.Fragment,{children:[e.jsx(H,{title:c("search.title.global_search"),children:e.jsx(z,{onClick:()=>L(I.sources.childRoutes.searchAll.path),size:"large",color:"inherit",children:e.jsx(ke,{})})}),e.jsx(Ne,{shownLangs:n,setShownLangs:r,allLangs:jt(a!=null?a:[]),forcedLangs:be()})]})),()=>{t(null)}),[c,n,a]),h?e.jsx(ie,{}):o?e.jsx($,{message:c("global.error.label.failed_to_load_data"),messageExtra:o.message,retry:()=>p().catch(A())}):(a==null?void 0:a.length)===0?e.jsx($,{message:c("source.error.label.no_sources_found")}):e.jsx(e.Fragment,{children:Object.entries(St(a!=null?a:[])).sort((d,g)=>_e(d[0],g[0])).map(([d,g])=>(d===q.OTHER||n.includes(d))&&e.jsxs(l.Fragment,{children:[e.jsx(m,{variant:"h5",component:"h2",sx:{paddingLeft:3,paddingTop:1,paddingBottom:2,fontWeight:"bold"},children:V(d)},d),g.filter(x=>{if(d===q.OTHER){const v=Number(x.id)===0;if(!(n.includes(d)||v))return!1}return u||!x.isNsfw}).map(x=>e.jsx(mt,{source:x,showSourceRepo:j},x.id))]},d))})}function Et(c){const{t}=N(),{extension:{name:n,lang:r,versionName:u,isInstalled:s,hasUpdate:h,isObsolete:o,pkgName:p,iconUrl:a,isNsfw:j,repo:L},handleUpdate:d,showSourceRepo:g,forcedState:x}=c,[D,v]=l.useState(F(s,o,h)),E=x!=null?x:D;l.useEffect(()=>{v(F(s,o,h))},[F(s,o,h)]);const B=r==="all"?t("extension.language.all"):r.toUpperCase(),O=async w=>{const P=tt[w],k=st[w];try{switch(v(k),w){case T.INSTALL:await S.updateExtension(p,{install:!0,isObsolete:o}).response;break;case T.UNINSTALL:await S.updateExtension(p,{uninstall:!0,isObsolete:o}).response;break;case T.UPDATE:await S.updateExtension(p,{update:!0,isObsolete:o}).response;break;default:throw new Error('Unexpected ExtensionAction "'.concat(w,'"'))}v(P),d()}catch(W){v(F(s,o,h)),_(t(Ae[w],{count:1}),"error")}};function b(){switch(E){case T.INSTALL:case T.UPDATE:case T.UNINSTALL:O(E).catch(A());break;case Ie.OBSOLETE:O(T.UNINSTALL).catch(A());break}}return e.jsx(se,{children:e.jsxs(ne,{sx:{display:"flex",alignItems:"center",gap:1,p:1.5,"&:last-child":{paddingBottom:1.5}},children:[e.jsx(le,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",background:"transparent"},alt:n,children:e.jsx(re,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:n,src:S.getValidImgUrlFor(a)})}),e.jsxs(M,{sx:{display:"flex",flexDirection:"column",flexGrow:1,flexShrink:1,wordBreak:"break-word",justifyContent:"center"},children:[e.jsx(m,{variant:"h6",component:"h3",children:n}),e.jsxs(m,{variant:"caption",sx:{display:"block"},children:[B," ",u,j&&e.jsx(m,{variant:"caption",color:"error",sx:{display:"inline"},children:" 18+"})]}),g&&e.jsx(m,{variant:"caption",sx:{display:"block"},children:L})]}),e.jsx(U,{variant:"outlined",sx:{color:E===Ze.OBSOLETE?"red":"inherit",flexShrink:0},onClick:()=>b(),children:t(et[E])})]})})}const ye=0,Le=1;function bt({tabsMenuHeight:c}){var me,je;const{t}=N(),{setAction:n}=l.useContext(ae),{data:r,loading:u,error:s,refetch:h}=S.useGetServerSettings({notifyOnNetworkStatusChange:!0}),o=!!(r!=null&&r.settings.extensionRepos.length),p=((me=r==null?void 0:r.settings.extensionRepos.length)!=null?me:0)>1,a=l.useRef(null),[j,L]=G("shownExtensionLangs",Je()),[d]=G("showNsfw",!0),[g]=Te("query",Ce),[x,D]=l.useState({}),[v,{data:E,loading:B,error:O}]=S.useExtensionListFetch(),b=(je=E==null?void 0:E.fetchExtensions)==null?void 0:je.extensions,[w,P]=l.useState([]),k=l.useCallback(()=>D({}),[]);l.useEffect(()=>{v()},[x]);const W=l.useMemo(()=>(b!=null?b:[]).filter(i=>{const f=d||!i.isNsfw;return g?f&&i.name.toLowerCase().includes(g.toLowerCase()):f}),[b,d,g]),{allLangs:he,groupedExtensions:K}=l.useMemo(()=>nt(W),[W]),C=l.useMemo(()=>K.filter(i=>i[Le].length>0).filter(i=>rt(i[ye])||j.includes(i[ye])),[j,K]),xe=l.useMemo(()=>C.map(i=>i[Le].length),[C]),X=l.useMemo(()=>C.map(([,i])=>i).flat(1),[C]),Ue=it.useCreateGroupedComputeItemKey(xe,l.useCallback(i=>C[i][0],[C]),l.useCallback(i=>X[i].pkgName,[X])),pe=i=>{i.name.toLowerCase().endsWith("apk")?(a.current&&(a.current.value=""),_(t("extension.label.installing_file"),"info"),S.installExternalExtension(i).response.then(()=>{k(),_(t("extension.label.installed_successfully"),"success")}).catch(()=>_(t("extension.label.installation_failed"),"error"))):_(t("global.error.label.invalid_file_type"),"error")};l.useLayoutEffect(()=>(n(e.jsxs(e.Fragment,{children:[e.jsx(Qe,{}),e.jsx(H,{title:t("extension.action.label.install_external"),children:e.jsx(z,{onClick:()=>{var i;return(i=a.current)==null?void 0:i.click()},size:"large",color:"inherit",children:e.jsx(Ge,{})})}),e.jsx(Ne,{shownLangs:j,setShownLangs:L,allLangs:he})]})),()=>{n(null)}),[t,j,he]),l.useEffect(()=>{const i=async y=>{y.preventDefault();const Q=await at(y);pe(Q[0])},f=y=>{y.preventDefault()};return document.addEventListener("drop",i),document.addEventListener("dragover",f),()=>{document.removeEventListener("drop",i),document.removeEventListener("dragover",f)}},[]);const fe=l.useMemo(()=>e.jsx("input",{type:"file",style:{display:"none"},ref:a,onChange:i=>{var y;const f=(y=i.target.files)==null?void 0:y[0];f&&pe(f)}}),[]),De=u||B,ge=s!=null?s:O;return De?e.jsx(ie,{}):ge?e.jsx($,{message:t("global.error.label.failed_to_load_data"),messageExtra:ge.message,retry:()=>{s&&h().catch(A()),O&&v().catch(A())}}):!(b!=null&&b.length)&&!o?e.jsxs(e.Fragment,{children:[fe,e.jsxs(oe,{sx:{alignItems:"center",justifyContent:"center",rowGap:"10px",paddingTop:"20px"},children:[e.jsx(m,{children:t("extension.label.add_repository_info")}),e.jsx(U,{component:R,variant:"contained",to:I.browse.path,children:t("settings.title")})]})]}):e.jsxs(e.Fragment,{children:[fe,e.jsx(lt,{heightToSubtract:c,overscan:window.innerHeight*.5,groupCounts:xe,groupContent:i=>{const[f,y]=C[i],Q=f===ot.UPDATE_PENDING;return e.jsxs(ct,{isFirstItem:i===0,sx:{flexDirection:"row",justifyContent:"space-between",alignItems:"center",pr:1},children:[e.jsx(m,{variant:"h5",component:"h2",children:V(f)}),Q&&e.jsx(U,{disabled:!!w.length,variant:"contained",onClick:()=>{const Se=y.map(Be=>Be.pkgName);P(Se),S.updateExtensions(Se,{update:!0}).response.then(()=>k()).catch(()=>_(t(Ae[T.UPDATE],{count:K.length}))).finally(()=>P([]))},children:t("extension.action.label.update_all")})]},f)},computeItemKey:Ue,itemContent:i=>{const f=X[i];return e.jsx(Oe,{children:e.jsx(Et,{extension:f,handleUpdate:k,showSourceRepo:p,forcedState:w.includes(f.pkgName)?Ie.UPDATING:void 0})})}})]})}var ue={},yt=te;Object.defineProperty(ue,"__esModule",{value:!0});var Re=ue.default=void 0,Lt=yt(ee()),wt=e;Re=ue.default=(0,Lt.default)((0,wt.jsx)("path",{d:"M14.94 4.66h-4.72l2.36-2.36zm-4.69 14.71h4.66l-2.33 2.33zM6.1 6.27 1.6 17.73h1.84l.92-2.45h5.11l.92 2.45h1.84L7.74 6.27zm-1.13 7.37 1.94-5.18 1.94 5.18zm10.76 2.5h6.12v1.59h-8.53v-1.29l5.92-8.56h-5.88v-1.6h8.3v1.26z"}),"SortByAlpha");var de={},Tt=te;Object.defineProperty(de,"__esModule",{value:!0});var Me=de.default=void 0,Ct=Tt(ee()),_t=e;Me=de.default=(0,Ct.default)((0,_t.jsx)("path",{d:"M20 10V8h-4V4h-2v4h-4V4H8v4H4v2h4v4H4v2h4v4h2v-4h4v4h2v-4h4v-2h-4v-4zm-6 4h-4v-4h4z"}),"Tag");const Nt=({id:c,name:t,lang:n,iconUrl:r,mangaCount:u})=>{const{t:s}=N(),o=Number(c)===0?s("source.local_source.title"):t;return e.jsx(se,{children:e.jsx(we,{component:R,to:I.migrate.path(c),children:e.jsxs(ne,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",p:1.5},children:[e.jsxs(M,{sx:{display:"flex"},children:[e.jsx(le,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",mr:1,background:"transparent"},children:e.jsx(re,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:o,src:S.getValidImgUrlFor(r)})}),e.jsxs(M,{sx:{display:"flex",flexDirection:"column",justifyContent:"center"},children:[e.jsx(m,{variant:"h6",component:"h3",children:o}),e.jsx(m,{variant:"caption",sx:{display:"block"},children:V(n)})]})]}),e.jsx(xt,{sx:{borderRadius:1},size:"small",label:u})]})})})},It=(c,{sortBy:t,sortOrder:n})=>{if(!c)return[];const r={};c.forEach(({sourceId:s,source:h})=>{var p;const o=(p=r[s])!=null?p:{id:s,name:s,lang:"unknown",iconUrl:null,mangaCount:0,...h};r[s]={...o,mangaCount:o.mangaCount+1}});const u=Object.values(r).toSorted((s,h)=>{switch(t){case ve.SOURCE_NAME:return s.name.localeCompare(h.name);case ve.MANGA_COUNT:return s.mangaCount-h.mangaCount;default:throw new Error('Unexpected "sortBy" "'.concat(t,'"'))}});switch(n){case Ee.ASC:return u;case Ee.DESC:return u.toReversed();default:throw new Error('Unexpected "sortOrder" "'.concat(n,'"'))}},At=({tabsMenuHeight:c})=>{const{t}=N(),{appBarHeight:n}=He(),{settings:{migrateSortSettings:r}}=ze(),u=We(()=>_(t("global.error.label.failed_to_save_changes"),"error")),{sortBy:s,sortOrder:h}=r,{data:o,loading:p,error:a,refetch:j}=S.useGetMigratableSources({notifyOnNetworkStatusChange:!0}),L=l.useMemo(()=>It(o==null?void 0:o.mangas.nodes,r),[o==null?void 0:o.mangas.nodes,r]);return p?e.jsx(ie,{}):a?e.jsx($,{message:t("global.error.label.failed_to_load_data"),messageExtra:a.message,retry:()=>j().catch(A())}):e.jsxs(e.Fragment,{children:[e.jsxs(oe,{sx:{position:"sticky",top:"".concat(n+c,"px"),flexDirection:"row",justifyContent:"end",alignItems:"center",gap:1,p:1,backgroundColor:"background.default",zIndex:1},children:[e.jsx(H,{title:t($e[s]),children:e.jsx(z,{size:"large",color:"inherit",onClick:()=>u("migrateSortSettings",{sortBy:(s+1)%2,sortOrder:h}),children:s?e.jsx(Me,{}):e.jsx(Re,{})})}),e.jsx(H,{title:t(qe[h]),children:e.jsx(z,{size:"large",color:"inherit",onClick:()=>u("migrateSortSettings",{sortBy:s,sortOrder:(h+1)%2}),children:h?e.jsx(dt,{}):e.jsx(ht,{})})})]}),e.jsx(Ve,{sx:{p:0},children:L.map(d=>e.jsx(Oe,{children:e.jsx(Nt,{...d})},d.id))})]})};function us(){const{t:c}=N(),{setTitle:t}=l.useContext(ae);l.useLayoutEffect(()=>{t(c("global.label.browse"))},[c]);const n=l.useRef(null),[r,u]=l.useState(0);Ke(n,l.useCallback(()=>u(n.current.offsetHeight),[n.current]));const[s,h]=Te("tab",Ce,{}),o=s!=null?s:"source";return s||h(o,"replaceIn"),e.jsxs(ut,{children:[e.jsxs(Xe,{ref:n,variant:"fullWidth",value:o,onChange:(p,a)=>h(a,"replaceIn"),children:[e.jsx(Y,{value:"source",sx:{textTransform:"none"},label:c("source.title_one")}),e.jsx(Y,{value:"extensions",sx:{textTransform:"none"},label:c("extension.title_other")}),e.jsx(Y,{value:"migrate",sx:{textTransform:"none"},label:c("migrate.title")})]}),e.jsx(J,{index:"source",currentIndex:o,children:e.jsx(vt,{})}),e.jsx(J,{index:"extensions",currentIndex:o,children:e.jsx(bt,{tabsMenuHeight:r})}),e.jsx(J,{index:"migrate",currentIndex:o,children:e.jsx(At,{tabsMenuHeight:r})})]})}export{us as Browse};
