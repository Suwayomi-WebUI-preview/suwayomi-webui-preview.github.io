import{c as r,l as Ee,j as t,B as z,a as V,aj as q,r as ce,i as le,x as ot,ak as Et,al as Pt,am as Lt,an as St,ao as Ke,s as de,u as it,v as Dt,e as ct,ap as lt,aq as jt,ar as Tt,f as ne,I as ae,T as kt,as as _t,_ as Nt,at as Ot,Y as Ue,au as At,$ as It,av as $t,aw as Ge,p as Ye,N as Wt,m as Ze,h as K,M as Mt,a1 as Bt,E as Qe,ax as zt,ay as Ft}from"./index-DrMaLApM.js";import{b as U,C as _}from"./Chapters-zQI3XOpW.js";import{P as ge,i as Ht,R as qt,u as Vt,g as Je,c as Xt}from"./ReaderSettingsOptions-BqSZLjMl.js";import{S as et}from"./SpinnerImage-BGVImmaP.js";import{S as tt}from"./Select-BPexeUAg.js";import{C as Kt}from"./CustomIconButton-Dj6FouJV.js";import{C as Ut}from"./Collapse-DZyVCVdY.js";import{a as rt}from"./TextField-aIlb05nB.js";import{u as Gt}from"./useDebounce-3jclh9aT.js";import"./NumberSetting-CMsxWZno.js";import"./Info-BytbeKyX.js";import"./InputAdornment-B2WSPuJe.js";import"./Switch-O3WcZxr7.js";import"./SwitchBase-NTpreOjo.js";const Yt=a=>{for(let n=0;n<a.children.length;n++){const s=a.children.item(n);if(s){const{left:f,right:l}=s.getBoundingClientRect();if(f<=window.innerWidth/2&&l>window.innerWidth/2)return n}}return-1},Zt=5,Qt=()=>window.innerWidth+window.scrollX>=document.body.scrollWidth-Zt,Jt=()=>window.scrollX<=0;function er(a){const{pages:n,curPage:s,initialPage:f,settings:l,setCurPage:i,prevChapter:w,nextChapter:g}=a,p=r.useRef(f),d=r.useRef(null),m=r.useRef([]);function P(){var h;s<n.length-1?((h=m.current[s+1])==null||h.scrollIntoView({inline:"center"}),i(e=>e+1)):l.loadNextOnEnding&&g()}function u(){var h;s>0?((h=m.current[s-1])==null||h.scrollIntoView({inline:"center"}),i(s-1)):s===0&&w()}function E(){l.readerType==="ContinuesHorizontalLTR"?u():P()}function S(){l.readerType==="ContinuesHorizontalLTR"?P():u()}const b=r.useRef(0);function c(h){window.scrollBy(b.current-h.pageX,0)}function o(h){var e;b.current=h.pageX,(e=d.current)==null||e.addEventListener("mousemove",c)}function C(){var h;(h=d.current)==null||h.removeEventListener("mousemove",c)}function D(h){h.clientX>=window.innerWidth*.85?S():h.clientX<=window.innerWidth*.15&&E()}const j=()=>{l.readerType==="ContinuesHorizontalLTR"?window.scrollX+window.innerWidth>=document.body.scrollWidth&&g():l.readerType==="ContinuesHorizontalRTL"&&window.scrollX<=window.innerWidth&&g()};return Ee(m.current[f],r.useCallback((h,e)=>{const x=m.current[f];x!=null&&x.offsetHeight&&(x.scrollIntoView({inline:"center"}),e.disconnect())},[m.current[f],f])),r.useEffect(()=>{var h,e;return(h=d.current)==null||h.addEventListener("mousedown",o),(e=d.current)==null||e.addEventListener("mouseup",C),()=>{var x,O;(x=d.current)==null||x.removeEventListener("mousedown",o),(O=d.current)==null||O.removeEventListener("mouseup",C)}},[d]),r.useEffect(()=>(l.loadNextOnEnding&&document.addEventListener("scroll",j),()=>{document.removeEventListener("scroll",j)}),[d,s,w,g]),r.useEffect(()=>{const h=()=>{if(!d.current)return;const e=Yt(d.current);e!==p.current&&(p.current=e,i(e)),(l.readerType==="ContinuesHorizontalLTR"?Qt():Jt())&&(p.current=n.length-1,i(p.current))};return window.addEventListener("scroll",h),()=>window.removeEventListener("scroll",h)},[l.readerType]),t.jsx(z,{ref:d,sx:{display:"flex",flexDirection:l.readerType==="ContinuesHorizontalLTR"?"row":"row-reverse",justifyContent:l.readerType==="ContinuesHorizontalLTR"?"flex-start":"flex-end",width:"auto",height:"auto",overflowX:"visible",userSelect:"none"},onClick:D,children:n.map(h=>t.jsx(ge,{index:h.index,src:h.src,onImageLoad:()=>{},settings:l,ref:e=>{m.current[h.index]=e}},h.index))})}function tr(a){const{settings:n,curPage:s,pageCount:f}=a;return t.jsx(z,{sx:{display:n.showPageNumber?"block":"none",position:"fixed",bottom:"50px",padding:"2px",paddingLeft:"4px",paddingRight:"4px",textAlign:"center",backgroundColor:"rgba(0, 0, 0, 0.3)",borderRadius:"10px"},children:"".concat(s+1," / ").concat(f)})}function rr(a){const{pages:n,settings:s,setCurPage:f,initialPage:l,curPage:i,nextChapter:w,prevChapter:g,chapter:p}=a,d=r.useRef(null);r.useEffect(()=>{const o=n.map(C=>{const D=V.requestImage(C.src);return D.response.catch(()=>{}),D});return()=>{o.forEach(C=>C.abortRequest(new Error("PagedPager::preload: chapter changed")))}},[p.id]);const m=o=>{f(o),window.scroll({top:0})};function P(){i<n.length-1?m(i+1):s.loadNextOnEnding&&w()}function u(){i>0?m(i-1):g()}function E(){s.readerType==="SingleLTR"?u():s.readerType==="SingleRTL"&&P()}function S(){s.readerType==="SingleLTR"?P():s.readerType==="SingleRTL"&&u()}function b(o){switch(o.key){case"Space":o.preventDefault(),P();break;case"ArrowRight":S();break;case"ArrowLeft":E();break}}function c(o){o.clientX>window.innerWidth/2?S():E()}return r.useEffect(()=>(document.addEventListener("keydown",b),()=>{document.removeEventListener("keydown",b)}),[d,i,s.readerType,g,w]),r.useEffect(()=>{setTimeout(()=>{m(l)},0)},[l]),t.jsx(z,{ref:d,sx:{display:"flex",flexDirection:"column",justifyContent:"center",width:"auto",height:"auto"},onClick:c,children:t.jsx(ge,{index:i,onImageLoad:()=>{},src:n[i].src,settings:s},i)})}const nr=r.forwardRef((a,n)=>{const{image1src:s,image2src:f,index:l,onImageLoad:i,settings:w}=a,g=Ht(w),p={...g,width:w.fitPageToWindow?g.width:"calc(".concat(g.width," * 0.5)"),minWidth:w.fitPageToWindow&&w.scalePage?"calc(".concat(g.minWidth," * 0.5)"):g.minWidth,maxWidth:w.fitPageToWindow?"calc(".concat(g.maxWidth," * 0.5)"):g.maxWidth},d={...p,height:"100vh",width:"50%",backgroundColor:"#525252"};return t.jsxs(z,{ref:n,sx:{display:"flex",flexDirection:w.readerType==="DoubleLTR"?"row":"row-reverse",justifyContent:"center",width:"100%"},children:[t.jsx(et,{src:s,onImageLoad:i,alt:"Page #".concat(l),spinnerStyle:d,imgStyle:{...p,objectPosition:w.readerType==="DoubleLTR"?q("right","left"):q("left","right")}}),t.jsx(et,{src:f,onImageLoad:i,alt:"Page #".concat(l+1),spinnerStyle:{...d,width:"calc(50% - 5px)",marginLeft:"5px"},imgStyle:{...p,objectPosition:w.readerType==="DoubleLTR"?q("left","right"):q("right","left")}})]})}),ar=a=>a.height/a.width<1,be=(a,n,s)=>{if(n[a]||n[a+1]||a===n.length-1)return!0;const f=n.lastIndexOf(!0,a-1),l=a-(f+1);return s?l%2===0:l%2===1};function sr(a){const{pages:n,settings:s,setCurPage:f,initialPage:l,curPage:i,chapter:w,nextChapter:g,prevChapter:p}=a,d=r.useRef(null),[m,P]=r.useState(Array(n.length).fill(!1)),[u,E]=r.useState(Array(n.length).fill(!1));function S(){let e=1;if(i<n.length&&u[i]&&(e=1,m[i]))return e;if(i+1<n.length&&u[i+1]){if(be(i,m,s.offsetFirstPage))return e;e=2}return e}function b(){return be(i-2,m,s.offsetFirstPage)?1:2}function c(){if(i<n.length-1){const e=i+S();f(e>=n.length?n.length-1:e)}else s.loadNextOnEnding&&g()}function o(){if(i>0){const e=i-b();f(e<0?0:e)}else p()}function C(){s.readerType==="DoubleLTR"?o():c()}function D(){s.readerType==="DoubleLTR"?c():o()}function j(e){switch(e.key){case"Space":e.preventDefault(),c();break;case"ArrowRight":D();break;case"ArrowLeft":C();break}}function h(e){e.clientX>window.innerWidth/2?D():C()}return r.useEffect(()=>(document.addEventListener("keydown",j),()=>{document.removeEventListener("keydown",j)}),[d,i,s.readerType,p,g,u,m]),r.useEffect(()=>{f(l)},[l]),r.useEffect(()=>{s.offsetFirstPage?S()===2&&f(i+1):i>0&&!be(i-1,m,s.offsetFirstPage)&&f(i-1)},[s.offsetFirstPage]),r.useEffect(()=>{const e=n.map(x=>[x.index,V.requestImage(x.src)]);return e.forEach(async([x,O])=>{try{const B=await O.response,A=new Image;A.onload=()=>{URL.revokeObjectURL(B),E(I=>I.toSpliced(x,1,!0)),P(I=>I.toSpliced(x,1,ar(A)))},A.src=B}catch(B){}}),()=>{e.forEach(([x,O])=>O.abortRequest(new Error("DoublePagedPager::preload(".concat(x,"): chapter changed"))))}},[w.id]),t.jsx(z,{ref:d,onClick:h,children:t.jsx(z,{id:"display",sx:{display:"flex",flexDirection:s.readerType==="DoubleLTR"?"row":"row-reverse",justifyContent:"center",width:"auto",height:"auto"},children:S()===2?t.jsx(nr,{index:i,image1src:n[i].src,image2src:n[i+1].src,settings:s},i):t.jsx(ge,{index:i,src:n[i].src,onImageLoad:()=>{},settings:s},i)})})}const or=a=>{for(let n=0;n<a.children.length;n++){const s=a.children.item(n);if(s){const{top:f,bottom:l}=s.getBoundingClientRect();if(f<=window.innerHeight&&l>1)return n}}return-1},ir=5,cr=.95,nt=.25,lr="smooth",at=()=>window.innerHeight+window.scrollY>=document.body.offsetHeight-ir,dr=()=>window.scrollY<=0;function st(a){const{pages:n,settings:s,setCurPage:f,initialPage:l,nextChapter:i,prevChapter:w}=a,g=r.useRef(l),p=r.useRef(null),d=r.useRef([]);r.useEffect(()=>{let c=!1;const o=()=>{if(p.current)if(at()){if(c)return;c=!0,g.current=n.length-1,f(g.current),s.loadNextOnEnding&&i()}else{c=!1;const C=or(p.current);C!==g.current&&(g.current=C,f(C))}};return window.addEventListener("scroll",o),()=>{window.removeEventListener("scroll",o)}},[s.loadNextOnEnding,i]);const m=r.useRef(0),P=r.useRef(!1);function u(c){P.current=!0,window.scrollBy(0,m.current-c.pageY)}function E(c){var o;m.current=c.pageY,(o=p.current)==null||o.addEventListener("mousemove",u)}function S(){var c;(c=p.current)==null||c.removeEventListener("mousemove",u)}r.useEffect(()=>{var c,o;return(c=p.current)==null||c.addEventListener("mousedown",E),(o=p.current)==null||o.addEventListener("mouseup",S),()=>{var C,D;(C=p.current)==null||C.removeEventListener("mousedown",E),(D=p.current)==null||D.removeEventListener("mouseup",S)}},[p]);const b=r.useCallback((c,o=cr)=>{if(c==="down"&&at()){i();return}if(c==="up"&&dr()){w();return}window.scroll({top:window.scrollY+window.innerHeight*o*(c==="up"?-1:1),behavior:lr})},[i,w]);return r.useEffect(()=>{const c=o=>{switch(o.key){case"Space":o.preventDefault(),b(o.shiftKey?"up":"down");break;case"ArrowDown":o.preventDefault(),b(o.shiftKey?"up":"down",nt);break;case"ArrowRight":o.preventDefault(),b(o.shiftKey?"up":"down");break;case"ArrowUp":o.preventDefault(),b(o.shiftKey?"down":"up",nt);break;case"ArrowLeft":o.preventDefault(),b(o.shiftKey?"down":"up");break}};return document.addEventListener("keydown",c,!1),()=>{document.removeEventListener("keydown",c)}},[b]),Ee(d.current[l],r.useCallback((c,o)=>{const C=d.current[l];C!=null&&C.offsetHeight&&(C.scrollIntoView(),o.disconnect())},[d.current[l],l])),t.jsx(z,{ref:p,sx:{display:"flex",flexDirection:"column",justifyContent:"center",width:"auto",height:"auto",userSelect:"none"},onClick:c=>{if(P.current){P.current=!1;return}b(c.clientX>window.innerWidth/2?"down":"up")},children:n.map(c=>t.jsx(ge,{index:c.index,src:c.src,onImageLoad:()=>{},settings:s,ref:o=>{d.current[c.index]=o}},c.index))})}var Pe={},ur=le;Object.defineProperty(Pe,"__esModule",{value:!0});var dt=Pe.default=void 0,fr=ur(ce()),pr=t;dt=Pe.default=(0,fr.default)((0,pr.jsx)("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Close");var Le={},gr=le;Object.defineProperty(Le,"__esModule",{value:!0});var oe=Le.default=void 0,hr=gr(ce()),xr=t;oe=Le.default=(0,hr.default)((0,xr.jsx)("path",{d:"M15.41 16.59 10.83 12l4.58-4.59L14 6l-6 6 6 6z"}),"KeyboardArrowLeft");var Se={},mr=le;Object.defineProperty(Se,"__esModule",{value:!0});var ie=Se.default=void 0,Cr=mr(ce()),vr=t;ie=Se.default=(0,Cr.default)((0,vr.jsx)("path",{d:"M8.59 16.59 13.17 12 8.59 7.41 10 6l6 6-6 6z"}),"KeyboardArrowRight");var De={},wr=le;Object.defineProperty(De,"__esModule",{value:!0});var ut=De.default=void 0,Rr=wr(ce()),yr=t;ut=De.default=(0,Rr.default)((0,yr.jsx)("path",{d:"M7.41 8.59 12 13.17l4.59-4.58L18 10l-6 6-6-6z"}),"KeyboardArrowDown");var je={},br=le;Object.defineProperty(je,"__esModule",{value:!0});var ft=je.default=void 0,Er=br(ce()),Pr=t;ft=je.default=(0,Er.default)((0,Pr.jsx)("path",{d:"M7.41 15.41 12 10.83l4.59 4.58L18 14l-6-6-6 6z"}),"KeyboardArrowUp");const Lr={entering:{transform:"none"},entered:{transform:"none"}},Sr=r.forwardRef(function(n,s){const f=ot(),l={enter:f.transitions.duration.enteringScreen,exit:f.transitions.duration.leavingScreen},{addEndListener:i,appear:w=!0,children:g,easing:p,in:d,onEnter:m,onEntered:P,onEntering:u,onExit:E,onExited:S,onExiting:b,style:c,timeout:o=l,TransitionComponent:C=Lt,...D}=n,j=r.useRef(null),h=Et(j,Pt(g),s),e=v=>T=>{if(v){const $=j.current;T===void 0?v($):v($,T)}},x=e(u),O=e((v,T)=>{St(v);const $=Ke({style:c,timeout:o,easing:p},{mode:"enter"});v.style.webkitTransition=f.transitions.create("transform",$),v.style.transition=f.transitions.create("transform",$),m&&m(v,T)}),B=e(P),A=e(b),I=e(v=>{const T=Ke({style:c,timeout:o,easing:p},{mode:"exit"});v.style.webkitTransition=f.transitions.create("transform",T),v.style.transition=f.transitions.create("transform",T),E&&E(v)}),F=e(S),te=v=>{i&&i(j.current,v)};return t.jsx(C,{appear:w,in:d,nodeRef:j,onEnter:O,onEntered:B,onEntering:x,onExit:I,onExited:F,onExiting:A,addEndListener:te,timeout:o,...D,children:(v,T)=>r.cloneElement(g,{style:{transform:"scale(0)",visibility:v==="exited"&&!d?"hidden":void 0,...Lr[v],...c,...g.props.style},ref:h,...T})})}),Dr=de("div")({zIndex:10}),jr=de("div")(({theme:a})=>({position:"fixed",top:0,left:0,minWidth:"240px",maxWidth:"400px",height:"100vh",overflowY:"auto",backgroundColor:a.palette.background.default,"& header":{backgroundColor:a.palette.action.hover,display:"flex",alignItems:"center",padding:"".concat(a.spacing(1)," ").concat(a.spacing(3)),transition:"left 2s ease"}})),Tr=de("div")(({theme:a})=>({margin:"0 ".concat(a.spacing(2))})),kr=de("div")({display:"flex",flexWrap:"wrap",alignContent:"center",alignItems:"center",justifyContent:"center"}),_r=de("div")(({theme:a})=>({display:"grid",gridTemplateRows:"auto auto auto",gridTemplateColumns:"0fr 1fr 0fr",gridTemplateAreas:'"pre current next"',gridColumnGap:a.spacing(.5),margin:"".concat(a.spacing(1)," 0"),"& a":{textDecoration:"none",color:"inherit",display:"flex",flexWrap:"wrap",alignContent:"center"}}));function Nr(a){var G;const{t:n}=it(),{setReaderNavBarWidth:s}=Dt(),f=ot(),l=ct(),i=lt(),{prevDrawerOpen:w,prevSettingsCollapseOpen:g}=(G=i.state)!=null?G:{},p=r.useRef(null);Ee(p,r.useCallback(()=>{var y;((y=p.current)==null?void 0:y.offsetWidth)!==void 0&&s(p.current.offsetWidth)},[p.current])),r.useLayoutEffect(()=>()=>s(0),[p]);const{settings:d,setSettingValue:m,manga:P,chapter:u,chapters:E,curPage:S,scrollToPage:b,openNextChapter:c,retrievingNextChapter:o}=a,C=jt(),D=r.useMemo(()=>new Set(E.map(({scanlator:y})=>y)).size>1,[E]),[j,h]=r.useState(d.staticNav||w),[e,x]=r.useState(!0),[O,B]=r.useState(d.staticNav||w),[A,I]=r.useState(0),[F,te]=r.useState(g!=null?g:!0),v=o,T=(y,N,Y)=>{x(y!=="staticNav"),m(y,N,Y)},$=y=>{h(y),B(y)},H=()=>{const y=window.pageYOffset;Math.abs(y-A)>20&&(B(y>A),I(y))};return r.useEffect(()=>{e&&$(d.staticNav)},[d.staticNav]),r.useEffect(()=>{window.addEventListener("scroll",H);const y=document.querySelector("#root"),N=document.querySelector("#appMainContainer");return y.style.display="flex",y.style.flexDirection="column",N.style.display="none",()=>{y.style.display="block",N.style.display="block",window.removeEventListener("scroll",H)}},[H]),t.jsxs(Dr,{children:[t.jsx(Tt,{direction:q("right","left"),in:j,timeout:200,appear:!1,mountOnEnter:!0,unmountOnExit:!0,children:t.jsxs(jr,{ref:p,children:[t.jsxs("header",{children:[!d.staticNav&&t.jsx(ne,{title:n("reader.button.close_menu"),children:t.jsx(ae,{edge:"start",color:"inherit","aria-label":"menu",onClick:()=>$(!1),size:"large",children:q(t.jsx(oe,{}),t.jsx(ie,{}))})}),t.jsx(kt,{variant:"h6",component:"h1",sx:{textOverflow:"ellipsis",overflow:"hidden",py:1,flexGrow:1},children:u.name}),t.jsx(ne,{title:n("reader.button.exit"),children:t.jsx(ae,{edge:"start",color:"inherit","aria-label":"menu",onClick:C,size:"large",sx:{mr:-1},children:t.jsx(dt,{})})})]}),t.jsxs(_t,{ContainerComponent:"div",sx:{"& span":{fontWeight:"bold"}},children:[t.jsx(Nt,{primary:n("reader.settings.title.reader_settings")}),t.jsxs(ae,{edge:"start",color:"inherit","aria-label":"menu",disableRipple:!0,disableFocusRipple:!0,onClick:()=>te(!F),size:"large",children:[F&&t.jsx(ft,{}),!F&&t.jsx(ut,{})]})]}),t.jsx(Ut,{in:F,timeout:"auto",unmountOnExit:!0,children:t.jsx(qt,{setSettingValue:T,staticNav:d.staticNav,showPageNumber:d.showPageNumber,loadNextOnEnding:d.loadNextOnEnding,skipDupChapters:d.skipDupChapters,fitPageToWindow:d.fitPageToWindow,scalePage:d.scalePage,readerType:d.readerType,offsetFirstPage:d.offsetFirstPage,readerWidth:d.readerWidth})}),t.jsx(Ot,{sx:{my:1,mx:2}}),t.jsxs(Tr,{children:[t.jsxs(kr,{children:[t.jsx("span",{children:n("reader.page_info.label.currently_on_page")}),t.jsx(rt,{size:"small",sx:{mx:.5},disabled:v||u.pageCount===-1,children:t.jsx(tt,{value:u.pageCount>-1?"".concat(S):"",displayEmpty:!0,onChange:({target:{value:y}})=>{b(Number(y))},children:Array(Math.max(0,u.pageCount)).fill(1).map((y,N)=>t.jsx(Ue,{value:N,children:N+1},"Page#".concat(N)))})}),t.jsx("span",{children:n("reader.page_info.label.of_max_pages",{maxPages:u.pageCount})})]}),t.jsxs(_r,{children:[t.jsx(ne,{title:n("reader.button.previous_chapter"),children:t.jsx(ae,{sx:{gridArea:"pre"},disabled:v||u.sourceOrder<=1,onClick:()=>c(U.PREV),children:q(t.jsx(oe,{}),t.jsx(ie,{}))})}),t.jsx(rt,{sx:{gridArea:"current"},size:"small",disabled:v||u.sourceOrder<1,children:t.jsx(tt,{value:u.sourceOrder>=1?"".concat(u.sourceOrder):"",displayEmpty:!0,onChange:({target:{value:y}})=>{l("/manga/".concat(P.id,"/chapter/").concat(y),{replace:!0,state:{prevDrawerOpen:j,prevSettingsCollapseOpen:F}})},children:E.map(({id:y,sourceOrder:N,name:Y,chapterNumber:he,scanlator:re})=>t.jsx(Ue,{value:N,children:"#".concat(he).concat(D&&re!=null?" (".concat(re,")"):""," | ").concat(Y)},y))})}),t.jsx(ne,{title:n("reader.button.next_chapter"),children:t.jsx(ae,{sx:{gridArea:"next"},disabled:v||u.sourceOrder<1||u.sourceOrder>=P.chapters.totalCount,onClick:()=>c(U.NEXT),children:q(t.jsx(ie,{}),t.jsx(oe,{}))})})]})]})]})}),t.jsx(Sr,{in:!j,children:t.jsx(At,{in:!O,children:t.jsx(ne,{title:n("reader.button.open_menu"),children:t.jsx(Kt,{sx:{position:"fixed",top:20,left:20,backgroundColor:"rgba(255, 255, 255, 0.75);",color:"black",...f.applyStyles("dark",{backgroundColor:"rgba(0, 0, 0, 0.75);",color:"white"})},size:"large",variant:"contained",onClick:()=>$(!0),children:q(t.jsx(ie,{}),t.jsx(oe,{}))})})})})]})}const se=a=>_.getFromCache(a,zt,"CHAPTER_READER_FIELDS"),Or=a=>{switch(a){case"ContinuesVertical":case"Webtoon":return st;case"SingleVertical":case"SingleRTL":case"SingleLTR":return rr;case"DoubleVertical":case"DoubleRTL":case"DoubleLTR":return sr;case"ContinuesHorizontalLTR":case"ContinuesHorizontalRTL":return er;default:return st}},Ar=a=>Array.from({length:a},(n,s)=>s),ee={pageCount:-1,sourceOrder:-1,chapterCount:0,lastPageRead:0,name:"Loading...",manga:{id:-1}};function Zr(){var We,Me,Be,ze,Fe,He,qe,Ve;const{t:a}=it(),n=ct(),s=lt(),{chapterIndex:f,mangaId:l}=It(),i=r.useMemo(()=>({id:+l,title:"",thumbnailUrl:"",genre:[],inLibraryAt:0,lastReadAt:0,chapters:{totalCount:0},trackRecords:{totalCount:0}}),[l]),{data:w,loading:g,error:p,refetch:d}=V.useGetManga($t,l),m=r.useRef(null),P=Number(l)===((We=m.current)==null?void 0:We.mangaId)&&Number(f)===((Me=m.current)==null?void 0:Me.sourceOrder)&&((Be=m.current)==null?void 0:Be.pageCount)!==-1,u=(ze=w==null?void 0:w.manga)!=null?ze:i,{data:E,loading:S,error:b,refetch:c}=V.useGetChapters(Ge,{condition:{mangaId:Number(l),sourceOrder:Number(f)}},{notifyOnNetworkStatusChange:!0}),o=E==null?void 0:E.chapters.nodes[0],C=r.useRef(!1),{settings:{downloadAheadLimit:D}}=Ye(),j=!!D,h=()=>{var M;return m.current&&P?o&&((M=m.current)==null?void 0:M.pageCount)!==o.pageCount?o:m.current:(C.current=!1,o||null)};m.current=h();const e=(Fe=m.current)!=null?Fe:ee,x=r.useRef(ee);x.current===ee&&(x.current=e),e.mangaId!==((He=x.current)==null?void 0:He.mangaId)&&(x.current=ee);const[O,{loading:B,error:A}]=V.useGetChapterPagesFetch(e.id),I=()=>{S||O().then(()=>{C.current=!0}).catch(K())};r.useEffect(()=>{I()},[e.id]);const[F,te]=r.useState(!1),[v,T]=r.useState(0),$=v===e.pageCount-1,H=Gt(v,$?0:1e3),[G,y]=r.useState(void 0),{setOverride:N,setTitle:Y,readerNavBarWidth:he}=r.useContext(Wt),[re,Te]=r.useState(!1),{data:xe,loading:pt,error:ke,refetch:gt}=V.useGetMangaChapters(Ge,l,{nextFetchPolicy:"standby"}),R=xe==null?void 0:xe.chapters.nodes,me=g||S||pt||B||!C.current&&!b&&!A,_e=(Ve=(qe=p!=null?p:b)!=null?qe:ke)!=null?Ve:A,{settings:Ce,loading:Ne}=Vt(),[L,Oe]=r.useState(Je(u,Ce)),{settings:ue}=Ye(),Ae=r.useMemo(()=>L.skipDupChapters?_.removeDuplicates(x.current,R!=null?R:[]):R!=null?R:[],[x.current,R,L.skipDupChapters]),ht=r.useMemo(()=>_.getNextChapters(e,R!=null?R:[],{offset:U.PREV,skipDupe:L.skipDupChapters,skipDupeChapter:x.current}),[e,x.current,R,L.skipDupChapters]),xt=r.useMemo(()=>_.getNextChapters(e,R!=null?R:[],{skipDupe:L.skipDupChapters,skipDupeChapter:x.current}),[e,x.current,R,L.skipDupChapters]),fe=r.useMemo(()=>_.getNextChapter(e,R!=null?R:[],{offset:U.PREV,skipDupe:L.skipDupChapters,skipDupeChapter:x.current}),[e,x.current,R,L.skipDupChapters]),Z=r.useMemo(()=>_.getNextChapter(e,R!=null?R:[],{skipDupe:L.skipDupChapters,skipDupeChapter:x.current}),[e,x.current,R,L.skipDupChapters]),Ie=k=>{if(e===ee)return;const W=()=>{if(!(!!k.isRead&&!!ue.deleteChaptersWhileReading)||!R)return[];const J=[e,...ht][ue.deleteChaptersWhileReading-1];if(!J)return[];const we=se(J.id);return we.isRead&&_.isDeletable(we,ue.deleteChaptersWithBookmark)?L.skipDupChapters?_.getIds(_.addDuplicates([J],R)):_.getIds([J]):[]};(()=>{var Re;const pe=se(e.id),J=((Re=k.lastPageRead)!=null?Re:0)/e.pageCount>.25;if(j&&u.inLibrary&&!!(pe!=null&&pe.isDownloaded)&&J){const ye=Z?se(Z.id):null;if(!(ye!=null&&ye.isDownloaded))return;const Xe=_.getNonRead(xt).map(X=>se(X.id)).slice(-D).filter(X=>!X.isDownloaded).map(X=>X.id).filter(X=>!_.isDownloading(X));if(!Xe.length)return;_.download(Xe).catch(K())}})();const ve=L.skipDupChapters?_.getIds(_.addDuplicates([e],R!=null?R:[e])):[e.id];V.updateChapters(ve,{...k,chapterIdsToDelete:W(),trackProgressMangaId:ue.updateProgressAfterReading&&k.isRead&&u.trackRecords.totalCount?u.id:void 0},{errorPolicy:"all"}).response.catch(K())},mt=(k,W,M=!0)=>{Oe({...L,[k]:W}),M&&Ft(u,[[k,W]]).catch(()=>Ze(a("reader.settings.error.label.failed_to_save_settings"),"warning"))},Q=r.useCallback(k=>{const W=k===U.NEXT,M=W?Z:fe;if(!M){Ze(a(W?"reader.error.label.next_chapter_does_not_exist":"reader.error.label.prev_chapter_does_not_exist"),"error");return}Te(!0),T(0),n("/manga/".concat(u.id,"/chapter/").concat(M.sourceOrder),{replace:!0,state:s.state}),Te(!1)},[u.id,fe==null?void 0:fe.id,Z==null?void 0:Z.id]);r.useEffect(()=>{if(me||!e){T(0);return}te(!0),e.lastPageRead===e.pageCount-1?T(0):T(e.lastPageRead)},[e,me]),r.useEffect(()=>{!(u!=null&&u.title)||e.name===a("global.label.loading")?Y(a("reader.title")):Y("".concat(u.title,": ").concat(e.name))},[a,u,e]),r.useEffect(()=>{!Ne&&!g&&(Xt(u,"manga",Ce).catch(K()),Oe(Je(u,Ce)))},[Ne,g]),r.useEffect(()=>(N({status:!0,value:t.jsx(Nr,{settings:L,setSettingValue:mt,manga:u,chapter:e,chapters:Ae,curPage:v,scrollToPage:y,openNextChapter:Q,retrievingNextChapter:re})}),()=>N({status:!1,value:t.jsx("div",{})})),[u,e,L,v,f,re,Q,Ae]),r.useEffect(()=>{if(!F||e===ee)return;const k=se(e.id);if(H===(k==null?void 0:k.lastPageRead))return;const W=H!==-1,M=H===e.pageCount-1;(W||M)&&Ie({lastPageRead:W?H:void 0,isRead:M?!0:void 0})},[H,j]);const Ct=r.useCallback(()=>{Ie({lastPageRead:e.pageCount-1,isRead:!0}),Q(U.NEXT)},[e.pageCount,Q,e,u]),vt=r.useCallback(()=>{Q(U.PREV)},[Q]),wt=Mt.useGetScrollbarSize("height");if(me)return t.jsx(z,{sx:{height:"100vh",width:"100vw",display:"grid",placeItems:"center"},children:t.jsx(Bt,{thickness:5})});if(_e)return t.jsx(Qe,{message:a("global.error.label.failed_to_load_data"),messageExtra:_e.message,retry:()=>{p&&d().catch(K()),b&&c().catch(K()),ke&&gt().catch(K()),A&&I()}});if(!e.pageCount)return t.jsx(Qe,{message:a("reader.error.label.no_pages_found"),retry:I});const Rt=Ar(e.pageCount).map(k=>({index:k,src:V.getChapterPageUrl(l,f,k)})),yt=Or(L.readerType),bt=G!=null?G:e.lastPageRead===e.pageCount-1?0:e.lastPageRead,$e=L.staticNav?he:0;return t.jsxs(z,{sx:{display:"flex",flexDirection:"column",alignContent:"center",alignItems:"center",justifyContent:"center",minWidth:"calc((100vw - (100vw - 100%)) - ".concat($e,"px)"),minHeight:"calc(100vh - ".concat(wt,"px)"),marginLeft:"".concat($e,"px")},children:[t.jsx(tr,{settings:L,curPage:v,pageCount:e.pageCount}),t.jsx(z,{sx:{alignSelf:"stretch"},children:t.jsx(yt,{pages:Rt,pageCount:e.pageCount,setCurPage:T,initialPage:bt,curPage:v,settings:L,manga:u,chapter:e,nextChapter:Ct,prevChapter:vt},e.id)})]})}export{Zr as Reader};
