import{ay as I,u as T,f as o,r as q,j as s,C as O,a as Q,L as V,A as W,T as A,aI as z,l as F,m as k,N as J,aJ as K,g as B,k as U,E as X,B as v}from"./index-CquUQo3v.js";import{u as Y,A as Z,S as ee}from"./AppbarSearch-D3-cZ5U7.js";import{s as _,l as se,a as re}from"./Languages-BFJCCJs-.js";import{t as te,L as ae}from"./LangSelect-BNGDyiPS.js";import{u as P}from"./useDebounce-CDZsOQ67.js";import{B as oe}from"./BaseMangaGrid-CYBnAP2F.js";import"./useManageMangaLibraryState-Byufb9k2.js";import"./Trackers-D4pSmk7a.js";import"./Avatar-TgFmp6V5.js";import"./Info-Bq7fkH3-.js";import"./TextField-C2-uV8Pc.js";import"./InputAdornment-DRquAD5l.js";import"./CheckCircle-BNeUiL1l.js";import"./ListPreference-t27jsc4B.js";import"./NumberSetting-CNC_MFCS.js";import"./useMobilePicker-BUxHVmtG.js";import"./Chip-C5pB5WJV.js";import"./SelectSetting-CNMa1zpP.js";import"./Mangas-UHUIhH1v.js";import"./ThreeStateCheckboxInput-pzVu-ZqW.js";import"./FilterList-Bec-nunb.js";import"./cloneObject-DrOPTG0J.js";import"./Switch-0QBm7Jmi.js";import"./MangaGrid-CaI0wp3g.js";import"./Sync-DPTVKbYs.js";import"./PlayArrow-CCbzoVWE.js";import"./StyledFab-BbyRMH-m.js";function ne(r){const t=[];return r.forEach(e=>{t.indexOf(e.lang)===-1&&t.push(e.lang)}),t.sort(se),t}const ie=(r,t)=>r.displayName<t.displayName?-1:r.displayName>t.displayName?1:0,ce=(r,t,e)=>{var d,S,n,c;const f=!((d=e.get(r.id))!=null&&d.isLoading),i=!((S=e.get(t.id))!=null&&S.isLoading);if(f&&!i)return-1;if(!f&&i)return 1;if(!f&&!i)return 0;const l=!((n=e.get(r.id))!=null&&n.hasResults),m=!((c=e.get(t.id))!=null&&c.hasResults);return l&&!m?1:m&&!l?-1:0},ue=1e3,le=I.memo(({source:r,onSearchRequestFinished:t,searchString:e,emptyQuery:f,mode:i})=>{var w,R;const{t:l}=T(),{id:m,displayName:d,lang:S}=r,n=o.useRef(e),c=o.useRef(()=>{});n.current!==e&&(n.current=e,c.current(new Error("SourceSearchPreview(".concat(m,", ").concat(d,"): search string changed"))));const[p,j]=q.useSourceSearch(m,e!=null?e:"",void 0,1,{skipRequest:!e,addAbortSignal:!0}),{data:y,isLoading:h,error:u,abortRequest:M}=j[0];c.current=M;const E=(R=(w=y==null?void 0:y.fetchSourceManga)==null?void 0:w.mangas)!=null?R:[],L=!u&&!h&&!E.length;o.useEffect(()=>{t(r,h,!L,!e)},[h,L,e]);let g;return u?g=l("search.error.label.source_search_failed"):L&&(g=l("manga.error.label.no_mangas_found")),!h&&!e||f?null:s.jsxs(s.Fragment,{children:[s.jsx(O,{sx:{mb:1},children:s.jsxs(Q,{component:V,to:"".concat(W.sources.childRoutes.browse.path(m),"?query=").concat(e),sx:{p:3},children:[s.jsx(A,{variant:"h5",children:d}),s.jsx(A,{variant:"caption",children:te(S)})]})}),g?s.jsx(z,{sx:{alignItems:"start",height:void 0},noFaces:!0,message:g,messageExtra:F(u),retry:u?()=>p(1).catch(k("SourceSearchPreview(".concat(r.id,")::refetch"))):void 0}):s.jsx(oe,{gridWrapperProps:{sx:{px:0}},mangas:E,isLoading:h,hasNextPage:!1,loadMore:()=>{},horizontal:!0,noFaces:!0,message:g,inLibraryIndicator:!0,mode:i})]})}),De=()=>{const{t:r}=T(),{setTitle:t,setAction:e}=o.useContext(J),{pathname:f,state:i}=K(),l=f.startsWith("/migrate/source"),m=i==null?void 0:i.mangaTitle,[d]=Y("query",ee),S=P(d,ue),[n,c]=B("shownSourceLangs",re()),[b]=B("showNsfw",!0),{data:p,loading:j,error:y,refetch:h}=q.useGetSourceList({notifyOnNetworkStatusChange:!0}),u=o.useMemo(()=>{var a;return(a=p==null?void 0:p.sources.nodes)!=null?a:[]},[p==null?void 0:p.sources.nodes]),[M,E]=o.useState(new Map),L=P(M,500),g=o.useMemo(()=>[...u].sort(ie),[u]),w=o.useMemo(()=>g.filter(a=>n.includes(a.lang)),[g,n]),R=o.useMemo(()=>w.filter(a=>b||!a.isNsfw),[w,b]),N=o.useMemo(()=>[...R].sort((a,x)=>ce(a,x,L)),[R,L]),D=o.useCallback(({id:a},x,$,G)=>{E(H=>{const C=new Map(H);return C.set(a,{isLoading:x,hasResults:$,emptySearch:G}),C})},[E]);return o.useLayoutEffect(()=>(t(r(l?"migrate.search.title":"search.title.global_search",{title:m})),e(s.jsxs(s.Fragment,{children:[s.jsx(Z,{isClosable:!1}),s.jsx(ae,{shownLangs:n,setShownLangs:c,allLangs:ne(u),forcedLangs:_()})]})),()=>{t(""),e(null)}),[r,n,c,u]),o.useEffect(()=>{const a=_().filter(x=>!n.includes(x));c([...n,...a])},[]),j?s.jsx(U,{}):y?s.jsx(X,{message:r("global.error.label.failed_to_load_data"),messageExtra:F(y),retry:()=>h().catch(k())}):s.jsx(v,{sx:{p:1},children:N.map((a,x)=>s.jsx(v,{sx:{pb:x+1!==N.length?2:0},children:s.jsx(le,{source:a,onSearchRequestFinished:D,searchString:S,emptyQuery:!d,mode:l?"migrate.select":"source"})},a.id))})};export{De as SearchAll};
