import{c as t,j as e,B as F,a as B,r as ee,i as te,k as ot,Q as it,a3 as lt,_ as ge,a4 as ct,a5 as dt,a6 as Ne,s as U,I as K,u as qe,e as Xe,a7 as Ke,a8 as ut,A as ft,a9 as gt,aa as Y,f as Z,T as pt,ab as ht,y as mt,ac as xt,ad as vt,z as Ct,N as wt,m as Ae,h as se,C as Rt,E as bt}from"./index-Zl59rTnr.js";import{b as V,C as T}from"./Chapters-BDtuZBKt.js";import{P as oe,i as yt,R as Pt,u as Et,g as Ie,c as Lt}from"./ReaderSettingsOptions-BRuWAwo2.js";import{r as St}from"./metadata-3dsaWhfv.js";import{S as $e}from"./SpinnerImage-DiQGN4Ou.js";import{S as We}from"./Select-BndaAxxl.js";import{C as jt}from"./Collapse-NT65VyrV.js";import{a as Me}from"./TextField-lew-bJf8.js";import{M as Fe}from"./MenuItem-DWrnvo_k.js";import{u as Tt}from"./useDebounce-jELv4YlT.js";import{u as ze}from"./metadataServerSettings-Bu9SBxLq.js";import"./NumberSetting-D95Za2Yx.js";import"./Info-CBdRtVcr.js";import"./InputAdornment-C6brfzM8.js";import"./Switch-Dz039eWF.js";import"./SwitchBase-B5dQFXOZ.js";const Dt=c=>{for(let n=0;n<c.children.length;n++){const s=c.children.item(n);if(s){const{left:x,right:d}=s.getBoundingClientRect();if(x<=window.innerWidth/2&&d>window.innerWidth/2)return n}}return-1},kt=5,_t=()=>window.innerWidth+window.scrollX>=document.body.scrollWidth-kt,Ot=()=>window.scrollX<=0;function Nt(c){const{pages:n,curPage:s,initialPage:x,settings:d,setCurPage:a,prevChapter:f,nextChapter:v}=c,u=t.useRef(x),g=t.useRef(null),h=t.useRef([]);function w(){var p;s<n.length-1?((p=h.current[s+1])==null||p.scrollIntoView({inline:"center"}),a(l=>l+1)):d.loadNextOnEnding&&v()}function E(){var p;s>0?((p=h.current[s-1])==null||p.scrollIntoView({inline:"center"}),a(s-1)):s===0&&f()}function L(){d.readerType==="ContinuesHorizontalLTR"?E():w()}function D(){d.readerType==="ContinuesHorizontalLTR"?w():E()}const R=t.useRef(0);function i(p){window.scrollBy(R.current-p.pageX,0)}function o(p){var l;R.current=p.pageX,(l=g.current)==null||l.addEventListener("mousemove",i)}function b(){var p;(p=g.current)==null||p.removeEventListener("mousemove",i)}function r(p){p.clientX>=window.innerWidth*.85?D():p.clientX<=window.innerWidth*.15&&L()}const k=()=>{d.readerType==="ContinuesHorizontalLTR"?window.scrollX+window.innerWidth>=document.body.scrollWidth&&v():d.readerType==="ContinuesHorizontalRTL"&&window.scrollX<=window.innerWidth&&v()};return t.useLayoutEffect(()=>{const p=h.current[x];if(!p)return()=>{};const l=new ResizeObserver(()=>{p.offsetHeight&&(p.scrollIntoView({inline:"center"}),l.disconnect())});return l.observe(p),()=>l.disconnect()},[x]),t.useEffect(()=>{var p,l;return(p=g.current)==null||p.addEventListener("mousedown",o),(l=g.current)==null||l.addEventListener("mouseup",b),()=>{var y,_;(y=g.current)==null||y.removeEventListener("mousedown",o),(_=g.current)==null||_.removeEventListener("mouseup",b)}},[g]),t.useEffect(()=>(d.loadNextOnEnding&&document.addEventListener("scroll",k),()=>{document.removeEventListener("scroll",k)}),[g,s,f,v]),t.useEffect(()=>{const p=()=>{if(!g.current)return;const l=Dt(g.current);l!==u.current&&(u.current=l,a(l)),(d.readerType==="ContinuesHorizontalLTR"?_t():Ot())&&(u.current=n.length-1,a(u.current))};return window.addEventListener("scroll",p),()=>window.removeEventListener("scroll",p)},[d.readerType]),e.jsx(F,{ref:g,sx:{display:"flex",flexDirection:d.readerType==="ContinuesHorizontalLTR"?"row":"row-reverse",justifyContent:d.readerType==="ContinuesHorizontalLTR"?"flex-start":"flex-end",width:"auto",height:"auto",overflowX:"visible",userSelect:"none"},onClick:r,children:n.map(p=>e.jsx(oe,{index:p.index,src:p.src,onImageLoad:()=>{},settings:d,ref:l=>{h.current[p.index]=l}},p.index))})}function At(c){const{settings:n,curPage:s,pageCount:x}=c;return e.jsx(F,{sx:{display:n.showPageNumber?"block":"none",position:"fixed",bottom:"50px",padding:"2px",paddingLeft:"4px",paddingRight:"4px",textAlign:"center",backgroundColor:"rgba(0, 0, 0, 0.3)",borderRadius:"10px"},children:"".concat(s+1," / ").concat(x)})}function It(c){const{pages:n,settings:s,setCurPage:x,initialPage:d,curPage:a,nextChapter:f,prevChapter:v,chapter:u}=c,g=t.useRef(null);t.useEffect(()=>{const o=n.map(b=>{const r=B.requestImage(b.src);return r.response.catch(()=>{}),r});return()=>{o.forEach(b=>b.abortRequest(new Error("PagedPager::preload: chapter changed")))}},[u.id]);const h=o=>{x(o),window.scroll({top:0})};function w(){a<n.length-1?h(a+1):s.loadNextOnEnding&&f()}function E(){a>0?h(a-1):v()}function L(){s.readerType==="SingleLTR"?E():s.readerType==="SingleRTL"&&w()}function D(){s.readerType==="SingleLTR"?w():s.readerType==="SingleRTL"&&E()}function R(o){switch(o.key){case"Space":o.preventDefault(),w();break;case"ArrowRight":D();break;case"ArrowLeft":L();break}}function i(o){o.clientX>window.innerWidth/2?D():L()}return t.useEffect(()=>(document.addEventListener("keydown",R),()=>{document.removeEventListener("keydown",R)}),[g,a,s.readerType,v,f]),t.useEffect(()=>{setTimeout(()=>{h(d)},0)},[d]),e.jsx(F,{ref:g,sx:{display:"flex",flexDirection:"column",justifyContent:"center",width:"auto",height:"auto"},onClick:i,children:e.jsx(oe,{index:a,onImageLoad:()=>{},src:n[a].src,settings:s},a)})}const $t=t.forwardRef((c,n)=>{const{image1src:s,image2src:x,index:d,onImageLoad:a,settings:f}=c,v=yt(f),u={...v,width:f.fitPageToWindow?v.width:"calc(".concat(v.width," * 0.5)"),minWidth:f.fitPageToWindow&&f.scalePage?"calc(".concat(v.minWidth," * 0.5)"):v.minWidth,maxWidth:f.fitPageToWindow?"calc(".concat(v.maxWidth," * 0.5)"):v.maxWidth},g={...u,height:"100vh",width:"50%",backgroundColor:"#525252"};return e.jsxs(F,{ref:n,sx:{display:"flex",flexDirection:f.readerType==="DoubleLTR"?"row":"row-reverse",justifyContent:"center",width:"100%"},children:[e.jsx($e,{src:s,onImageLoad:a,alt:"Page #".concat(d),spinnerStyle:g,imgStyle:{...u,objectPosition:f.readerType==="DoubleLTR"?"right":"left"}}),e.jsx($e,{src:x,onImageLoad:a,alt:"Page #".concat(d+1),spinnerStyle:{...g,width:"calc(50% - 5px)",marginLeft:"5px"},imgStyle:{...u,objectPosition:f.readerType==="DoubleLTR"?"left":"right"}})]})}),Wt=c=>c.height/c.width<1,pe=(c,n,s)=>{if(n[c]||n[c+1]||c===n.length-1)return!0;const x=n.lastIndexOf(!0,c-1),d=c-(x+1);return s?d%2===0:d%2===1};function Mt(c){const{pages:n,settings:s,setCurPage:x,initialPage:d,curPage:a,chapter:f,nextChapter:v,prevChapter:u}=c,g=t.useRef(null),[h,w]=t.useState(Array(n.length).fill(!1)),[E,L]=t.useState(Array(n.length).fill(!1));function D(){let l=1;if(a<n.length&&E[a]&&(l=1,h[a]))return l;if(a+1<n.length&&E[a+1]){if(pe(a,h,s.offsetFirstPage))return l;l=2}return l}function R(){return pe(a-2,h,s.offsetFirstPage)?1:2}function i(){if(a<n.length-1){const l=a+D();x(l>=n.length?n.length-1:l)}else s.loadNextOnEnding&&v()}function o(){if(a>0){const l=a-R();x(l<0?0:l)}else u()}function b(){s.readerType==="DoubleLTR"?o():i()}function r(){s.readerType==="DoubleLTR"?i():o()}function k(l){switch(l.key){case"Space":l.preventDefault(),i();break;case"ArrowRight":r();break;case"ArrowLeft":b();break}}function p(l){l.clientX>window.innerWidth/2?r():b()}return t.useEffect(()=>(document.addEventListener("keydown",k),()=>{document.removeEventListener("keydown",k)}),[g,a,s.readerType,u,v,E,h]),t.useEffect(()=>{x(d)},[d]),t.useEffect(()=>{s.offsetFirstPage?D()===2&&x(a+1):a>0&&!pe(a-1,h,s.offsetFirstPage)&&x(a-1)},[s.offsetFirstPage]),t.useEffect(()=>{const l=n.map(y=>[y.index,B.requestImage(y.src)]);return l.forEach(async([y,_])=>{try{const O=await _.response,z=new Image;z.onload=()=>{URL.revokeObjectURL(O),L(A=>A.toSpliced(y,1,!0)),w(A=>A.toSpliced(y,1,Wt(z)))},z.src=O}catch(O){}}),()=>{l.forEach(([y,_])=>_.abortRequest(new Error("DoublePagedPager::preload(".concat(y,"): chapter changed"))))}},[f.id]),e.jsx(F,{ref:g,onClick:p,children:e.jsx(F,{id:"display",sx:{display:"flex",flexDirection:s.readerType==="DoubleLTR"?"row":"row-reverse",justifyContent:"center",width:"auto",height:"auto"},children:D()===2?e.jsx($t,{index:a,image1src:n[a].src,image2src:n[a+1].src,settings:s},a):e.jsx(oe,{index:a,src:n[a].src,onImageLoad:()=>{},settings:s},a)})})}const Ft=c=>{for(let n=0;n<c.children.length;n++){const s=c.children.item(n);if(s){const{top:x,bottom:d}=s.getBoundingClientRect();if(x<=window.innerHeight&&d>1)return n}}return-1},zt=5,Bt=.95,Be=.25,Ht="smooth",He=()=>window.innerHeight+window.scrollY>=document.body.offsetHeight-zt,Vt=()=>window.scrollY<=0;function Ve(c){const{pages:n,settings:s,setCurPage:x,initialPage:d,nextChapter:a,prevChapter:f}=c,v=t.useRef(d),u=t.useRef(null),g=t.useRef([]);t.useEffect(()=>{let i=!1;const o=()=>{if(u.current)if(He()){if(i)return;i=!0,v.current=n.length-1,x(v.current),s.loadNextOnEnding&&a()}else{i=!1;const b=Ft(u.current);b!==v.current&&(v.current=b,x(b))}};return window.addEventListener("scroll",o),()=>{window.removeEventListener("scroll",o)}},[s.loadNextOnEnding,a]);const h=t.useRef(0),w=t.useRef(!1);function E(i){w.current=!0,window.scrollBy(0,h.current-i.pageY)}function L(i){var o;h.current=i.pageY,(o=u.current)==null||o.addEventListener("mousemove",E)}function D(){var i;(i=u.current)==null||i.removeEventListener("mousemove",E)}t.useEffect(()=>{var i,o;return(i=u.current)==null||i.addEventListener("mousedown",L),(o=u.current)==null||o.addEventListener("mouseup",D),()=>{var b,r;(b=u.current)==null||b.removeEventListener("mousedown",L),(r=u.current)==null||r.removeEventListener("mouseup",D)}},[u]);const R=t.useCallback((i,o=Bt)=>{if(i==="down"&&He()){a();return}if(i==="up"&&Vt()){f();return}window.scroll({top:window.scrollY+window.innerHeight*o*(i==="up"?-1:1),behavior:Ht})},[a,f]);return t.useEffect(()=>{const i=o=>{switch(o.key){case"Space":o.preventDefault(),R(o.shiftKey?"up":"down");break;case"ArrowDown":o.preventDefault(),R(o.shiftKey?"up":"down",Be);break;case"ArrowRight":o.preventDefault(),R(o.shiftKey?"up":"down");break;case"ArrowUp":o.preventDefault(),R(o.shiftKey?"down":"up",Be);break;case"ArrowLeft":o.preventDefault(),R(o.shiftKey?"down":"up");break}};return document.addEventListener("keydown",i,!1),()=>{document.removeEventListener("keydown",i)}},[R]),t.useLayoutEffect(()=>{const i=g.current[d];if(!i)return()=>{};const o=new ResizeObserver(()=>{i.offsetHeight&&(i.scrollIntoView(),o.disconnect())});return o.observe(i),()=>o.disconnect()},[d]),e.jsx(F,{ref:u,sx:{display:"flex",flexDirection:"column",justifyContent:"center",width:"auto",height:"auto",userSelect:"none"},onClick:i=>{if(w.current){w.current=!1;return}R(i.clientX>window.innerWidth/2?"down":"up")},children:n.map(i=>e.jsx(oe,{index:i.index,src:i.src,onImageLoad:()=>{},settings:s,ref:o=>{g.current[i.index]=o}},i.index))})}var me={},qt=te;Object.defineProperty(me,"__esModule",{value:!0});var Ue=me.default=void 0,Xt=qt(ee()),Kt=e;Ue=me.default=(0,Xt.default)((0,Kt.jsx)("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Close");var xe={},Ut=te;Object.defineProperty(xe,"__esModule",{value:!0});var Q=xe.default=void 0,Gt=Ut(ee()),Yt=e;Q=xe.default=(0,Gt.default)((0,Yt.jsx)("path",{d:"M15.41 16.59 10.83 12l4.58-4.59L14 6l-6 6 6 6z"}),"KeyboardArrowLeft");var ve={},Zt=te;Object.defineProperty(ve,"__esModule",{value:!0});var J=ve.default=void 0,Qt=Zt(ee()),Jt=e;J=ve.default=(0,Qt.default)((0,Jt.jsx)("path",{d:"M8.59 16.59 13.17 12 8.59 7.41 10 6l6 6-6 6z"}),"KeyboardArrowRight");var Ce={},en=te;Object.defineProperty(Ce,"__esModule",{value:!0});var Ge=Ce.default=void 0,tn=en(ee()),nn=e;Ge=Ce.default=(0,tn.default)((0,nn.jsx)("path",{d:"M7.41 8.59 12 13.17l4.59-4.58L18 10l-6 6-6-6z"}),"KeyboardArrowDown");var we={},rn=te;Object.defineProperty(we,"__esModule",{value:!0});var Ye=we.default=void 0,an=rn(ee()),sn=e;Ye=we.default=(0,an.default)((0,sn.jsx)("path",{d:"M7.41 15.41 12 10.83l4.59 4.58L18 14l-6-6-6 6z"}),"KeyboardArrowUp");const on=["addEndListener","appear","children","easing","in","onEnter","onEntered","onEntering","onExit","onExited","onExiting","style","timeout","TransitionComponent"],ln={entering:{transform:"none"},entered:{transform:"none"}},cn=t.forwardRef(function(n,s){const x=ot(),d={enter:x.transitions.duration.enteringScreen,exit:x.transitions.duration.leavingScreen},{addEndListener:a,appear:f=!0,children:v,easing:u,in:g,onEnter:h,onEntered:w,onEntering:E,onExit:L,onExited:D,onExiting:R,style:i,timeout:o=d,TransitionComponent:b=ct}=n,r=it(n,on),k=t.useRef(null),p=lt(k,v.ref,s),l=m=>C=>{if(m){const I=k.current;C===void 0?m(I):m(I,C)}},y=l(E),_=l((m,C)=>{dt(m);const I=Ne({style:i,timeout:o,easing:u},{mode:"enter"});m.style.webkitTransition=x.transitions.create("transform",I),m.style.transition=x.transitions.create("transform",I),h&&h(m,C)}),O=l(w),z=l(R),A=l(m=>{const C=Ne({style:i,timeout:o,easing:u},{mode:"exit"});m.style.webkitTransition=x.transitions.create("transform",C),m.style.transition=x.transitions.create("transform",C),L&&L(m)}),N=l(D),M=m=>{a&&a(k.current,m)};return e.jsx(b,ge({appear:f,in:g,nodeRef:k,onEnter:_,onEntered:O,onEntering:y,onExit:A,onExited:N,onExiting:z,addEndListener:M,timeout:o},r,{children:(m,C)=>t.cloneElement(v,ge({style:ge({transform:"scale(0)",visibility:m==="exited"&&!g?"hidden":void 0},ln[m],i,v.props.style),ref:p},C))}))}),dn=cn,un=U("div")({zIndex:10}),fn=U("div")(({theme:c})=>({top:0,left:0,width:"300px",minWidth:"300px",height:"100vh",overflowY:"auto",backgroundColor:c.palette.background.default,"& header":{backgroundColor:c.palette.action.hover,display:"flex",alignItems:"center",minHeight:"64px",paddingLeft:"24px",paddingRight:"24px",transition:"left 2s ease","& button":{flexGrow:0,flexShrink:0},"& button:nth-child(1)":{marginRight:"16px"},"& h1":{fontSize:"1.25rem",flexGrow:1}}})),gn=U("div")({margin:"0 16px","& > span:nth-child(1)":{textAlign:"center",display:"block",marginTop:"16px"}}),pn=U("div")({display:"flex",flexWrap:"wrap",alignContent:"center",alignItems:"center",justifyContent:"center"}),hn=U("div")({display:"grid",gridTemplateRows:"auto auto auto",gridTemplateColumns:"0fr 1fr 0fr",gridTemplateAreas:'"pre current next"',gridColumnGap:"5px",margin:"10px 0","& a":{textDecoration:"none",color:"inherit",display:"flex",flexWrap:"wrap",alignContent:"center"}}),mn=U(K)(({theme:c})=>({position:"fixed",top:20,left:30,height:"40px",width:"40px",borderRadius:5,backgroundColor:c.palette.custom.main,"&:hover":{backgroundColor:c.palette.custom.light}}));function xn(c){var M;const{t:n}=qe(),s=Xe(),x=Ke(),{prevDrawerOpen:d,prevSettingsCollapseOpen:a}=(M=x.state)!=null?M:{},{settings:f,setSettingValue:v,manga:u,chapter:g,curPage:h,scrollToPage:w,openNextChapter:E,retrievingNextChapter:L}=c,D=ut();ft("/manga/".concat(u.id));const[R,i]=t.useState(f.staticNav||d),[o,b]=t.useState(!0),[r,k]=t.useState(f.staticNav||d),[p,l]=t.useState(0),[y,_]=t.useState(a!=null?a:!0),O=L,z=(m,C,I)=>{b(m!=="staticNav"),v(m,C,I)},A=m=>{i(m),k(m)},N=()=>{const m=window.pageYOffset;Math.abs(m-p)>20&&(k(m>p),l(m))};return t.useEffect(()=>{o&&A(f.staticNav)},[f.staticNav]),t.useEffect(()=>{window.addEventListener("scroll",N);const m=document.querySelector("#root"),C=document.querySelector("#appMainContainer");return m.style.display="flex",m.style.flexDirection="column",C.style.display="none",()=>{m.style.display="block",C.style.display="block",window.removeEventListener("scroll",N)}},[N]),e.jsxs(un,{children:[e.jsx(gt,{direction:Y("right","left"),in:R,timeout:200,appear:!1,mountOnEnter:!0,unmountOnExit:!0,children:e.jsxs(fn,{sx:{position:"fixed"},children:[e.jsxs("header",{children:[!f.staticNav&&e.jsx(Z,{title:n("reader.button.close_menu"),children:e.jsx(K,{edge:"start",color:"inherit","aria-label":"menu",disableRipple:!0,onClick:()=>A(!1),size:"large",children:Y(e.jsx(Q,{}),e.jsx(J,{}))})}),e.jsx(pt,{variant:"h1",textOverflow:"ellipsis",overflow:"hidden",sx:{py:1},children:g.name}),e.jsx(Z,{title:n("reader.button.exit"),children:e.jsx(K,{edge:"start",color:"inherit","aria-label":"menu",disableRipple:!0,onClick:D,size:"large",sx:{mr:-1},children:e.jsx(Ue,{})})})]}),e.jsxs(ht,{ContainerComponent:"div",sx:{"& span":{fontWeight:"bold"}},children:[e.jsx(mt,{primary:n("reader.settings.title.reader_settings")}),e.jsxs(K,{edge:"start",color:"inherit","aria-label":"menu",disableRipple:!0,disableFocusRipple:!0,onClick:()=>_(!y),size:"large",children:[y&&e.jsx(Ye,{}),!y&&e.jsx(Ge,{})]})]}),e.jsx(jt,{in:y,timeout:"auto",unmountOnExit:!0,children:e.jsx(Pt,{setSettingValue:z,staticNav:f.staticNav,showPageNumber:f.showPageNumber,loadNextOnEnding:f.loadNextOnEnding,skipDupChapters:f.skipDupChapters,fitPageToWindow:f.fitPageToWindow,scalePage:f.scalePage,readerType:f.readerType,offsetFirstPage:f.offsetFirstPage,readerWidth:f.readerWidth})}),e.jsx(xt,{sx:{my:1,mx:2}}),e.jsxs(gn,{children:[e.jsxs(pn,{children:[e.jsx("span",{children:n("reader.page_info.label.currently_on_page")}),e.jsx(Me,{size:"small",sx:{margin:"0 5px"},disabled:O||g.pageCount===-1,children:e.jsx(We,{value:g.pageCount>-1?"".concat(h):"",displayEmpty:!0,onChange:({target:{value:m}})=>{w(Number(m))},children:Array(Math.max(0,g.pageCount)).fill(1).map((m,C)=>e.jsx(Fe,{value:C,children:C+1},"Page#".concat(C)))})}),e.jsx("span",{children:n("reader.page_info.label.of_max_pages",{maxPages:g.pageCount})})]}),e.jsxs(hn,{children:[e.jsx(Z,{title:n("reader.button.previous_chapter"),children:e.jsx(K,{sx:{gridArea:"pre"},disabled:O||g.sourceOrder<=1,onClick:()=>E(V.PREV),children:Y(e.jsx(Q,{}),e.jsx(J,{}))})}),e.jsx(Me,{sx:{gridArea:"current"},size:"small",disabled:O||g.sourceOrder<1,children:e.jsx(We,{value:g.sourceOrder>=1?"".concat(g.sourceOrder):"",displayEmpty:!0,onChange:({target:{value:m}})=>{s("/manga/".concat(u.id,"/chapter/").concat(m),{replace:!0,state:{prevDrawerOpen:R,prevSettingsCollapseOpen:y}})},children:Array(Math.max(0,u.chapters.totalCount)).fill(1).map((m,C)=>e.jsx(Fe,{value:C+1,children:"".concat(n("chapter.title")," ").concat(C+1)},"Chapter#".concat(C+1)))})}),e.jsx(Z,{title:n("reader.button.next_chapter"),children:e.jsx(K,{sx:{gridArea:"next"},disabled:O||g.sourceOrder<1||g.sourceOrder>=u.chapters.totalCount,onClick:()=>E(V.NEXT),children:Y(e.jsx(J,{}),e.jsx(Q,{}))})})]})]})]})}),e.jsx(dn,{in:!R,children:e.jsx(vt,{in:!r,children:e.jsx(Z,{title:n("reader.button.open_menu"),children:e.jsx(mn,{edge:"start","aria-label":"menu",disableRipple:!0,disableFocusRipple:!0,onClick:()=>A(!0),size:"large",children:Y(e.jsx(J,{}),e.jsx(Q,{}))})})})})]})}const vn=c=>{switch(c){case"ContinuesVertical":case"Webtoon":return Ve;case"SingleVertical":case"SingleRTL":case"SingleLTR":return It;case"DoubleVertical":case"DoubleRTL":case"DoubleLTR":return Mt;case"ContinuesHorizontalLTR":case"ContinuesHorizontalRTL":return Nt;default:return Ve}},Cn=c=>Array.from({length:c},(n,s)=>s),he={pageCount:-1,sourceOrder:-1,chapterCount:0,lastPageRead:0,name:"Loading..."};function $n(){var je,Te,De,ke,_e;const{t:c}=qe(),n=Xe(),s=Ke(),{chapterIndex:x,mangaId:d}=Ct(),a=t.useMemo(()=>({id:+d,title:"",thumbnailUrl:"",genre:[],inLibraryAt:0,lastReadAt:0,chapters:{totalCount:0}}),[d]),{data:f,loading:v}=B.useGetManga(d),u=t.useRef(null),g=Number(d)===((je=u.current)==null?void 0:je.manga.id)&&Number(x)===((Te=u.current)==null?void 0:Te.sourceOrder)&&((De=u.current)==null?void 0:De.pageCount)!==-1,h=(ke=f==null?void 0:f.manga)!=null?ke:a,{data:w,loading:E,error:L,refetch:D}=B.useGetMangaChapter(d,x,{notifyOnNetworkStatusChange:!0}),R=t.useRef(!1),{settings:{downloadAheadLimit:i}}=ze(),o=!!i,b=()=>{var W;return u.current&&g?(w==null?void 0:w.chapter)&&((W=u.current)==null?void 0:W.pageCount)!==w.chapter.pageCount?w.chapter:u.current:(R.current=!1,w!=null&&w.chapter?w.chapter:null)};u.current=b();const r=(_e=u.current)!=null?_e:he,[k,{loading:p,error:l}]=B.useGetChapterPagesFetch(r.id),y=()=>{!E&&!r.isDownloaded?k().then(()=>{R.current=!0}).catch(se()):R.current=!0};t.useEffect(()=>{y()},[r.id]);const _=E||p||!R.current&&!L&&!l,O=L!=null?L:l,[z,A]=t.useState(!1),[N,M]=t.useState(0),m=N===r.pageCount-1,C=Tt(N,m?0:1e3),[I,Ze]=t.useState(void 0),{setOverride:Re,setTitle:be}=t.useContext(wt),[ye,Pe]=t.useState(!1),{data:ie}=B.useGetMangaChapters(d,{nextFetchPolicy:"standby"}),P=ie==null?void 0:ie.chapters.nodes,{settings:le,loading:Ee}=Et(),[S,Le]=t.useState(Ie(h,le)),{settings:ne}=ze(),Qe=t.useMemo(()=>T.getNextChapters(r,P!=null?P:[],{offset:V.PREV,skipDupe:S.skipDupChapters}),[r,P,S.skipDupChapters]),Je=t.useMemo(()=>T.getNextChapters(r,P!=null?P:[],{skipDupe:S.skipDupChapters}),[r,P,S.skipDupChapters]),re=t.useMemo(()=>T.getNextChapter(r,P!=null?P:[],{offset:V.PREV,skipDupe:S.skipDupChapters}),[r,P,S.skipDupChapters]),q=t.useMemo(()=>T.getNextChapter(r,P!=null?P:[],{skipDupe:S.skipDupChapters}),[r,P,S.skipDupChapters]),Se=j=>{if(r===he)return;const $=()=>{if(!(!!j.isRead&&!!ne.deleteChaptersWhileReading)||!P)return[];const X=[r,...Qe][ne.deleteChaptersWhileReading-1];if(!X)return[];const de=T.getFromCache(X.id);return de.isRead&&T.isDeletable(de,ne.deleteChaptersWithBookmark)?S.skipDupChapters?T.getIds(T.addDuplicates([X],P)):T.getIds([X]):[]};(()=>{var ue;const ae=T.getFromCache(r.id),X=((ue=j.lastPageRead)!=null?ue:0)/r.pageCount>.25;if(o&&r.manga.inLibrary&&!!(ae!=null&&ae.isDownloaded)&&X){const fe=q?T.getFromCache(q.id):null;if(!(fe!=null&&fe.isDownloaded))return;const Oe=T.getNonRead(Je).map(H=>T.getFromCache(H.id)).slice(-i).filter(H=>!H.isDownloaded).map(H=>H.id).filter(H=>!T.isDownloading(H));if(!Oe.length)return;T.download(Oe).catch(se())}})();const ce=S.skipDupChapters?T.getIds(T.addDuplicates([r],P!=null?P:[r])):[r.id];B.updateChapters(ce,{...j,chapterIdsToDelete:$(),trackProgressMangaId:ne.updateProgressAfterReading&&j.isRead&&h.trackRecords.totalCount?h.id:void 0}).response.catch()},et=(j,$,W=!0)=>{Le({...S,[j]:$}),W&&St(h,[[j,$]]).catch(()=>Ae(c("reader.settings.error.label.failed_to_save_settings"),"warning"))},G=t.useCallback(j=>{const $=j===V.NEXT,W=$?q:re;if(!W){Ae(c($?"reader.error.label.next_chapter_does_not_exist":"reader.error.label.prev_chapter_does_not_exist"),"error");return}Pe(!0),M(0),n("/manga/".concat(h.id,"/chapter/").concat(W.sourceOrder),{replace:!0,state:s.state}),Pe(!1)},[h.id,re==null?void 0:re.id,q==null?void 0:q.id]);t.useEffect(()=>{if(_||!r){M(0);return}A(!0),r.lastPageRead===r.pageCount-1?M(0):M(r.lastPageRead)},[r,_]),t.useEffect(()=>{!(h!=null&&h.title)||r.name===c("global.label.loading")?be(c("reader.title")):be("".concat(h.title,": ").concat(r.name))},[c,h,r]),t.useEffect(()=>{!Ee&&!v&&(Lt(h,"manga",le).catch(se()),Le(Ie(h,le)))},[Ee,v]),t.useEffect(()=>(Re({status:!0,value:e.jsx(xn,{settings:S,setSettingValue:et,manga:h,chapter:r,curPage:N,scrollToPage:Ze,openNextChapter:G,retrievingNextChapter:ye})}),()=>Re({status:!1,value:e.jsx("div",{})})),[h,r,S,N,x,ye]),t.useEffect(()=>{if(!z||r===he)return;const j=T.getFromCache(r.id);if(C===(j==null?void 0:j.lastPageRead))return;const $=C!==-1,W=C===r.pageCount-1;($||W)&&Se({lastPageRead:$?C:void 0,isRead:W?!0:void 0})},[C,o]);const tt=t.useCallback(()=>{Se({lastPageRead:r.pageCount-1,isRead:!0}),G(V.NEXT)},[r.pageCount,G]),nt=t.useCallback(()=>{G(V.PREV)},[G]);if(_)return e.jsx(F,{sx:{height:"100vh",width:"100vw",display:"grid",placeItems:"center"},children:e.jsx(Rt,{thickness:5})});if(O)return e.jsx(bt,{message:c("global.error.label.failed_to_load_data"),messageExtra:O.message,retry:()=>{L&&D().catch(se()),l&&y()}});const rt=Cn(r.pageCount).map(j=>({index:j,src:B.getChapterPageUrl(d,x,j)})),at=vn(S.readerType),st=I!=null?I:r.lastPageRead===r.pageCount-1?0:r.lastPageRead;return e.jsxs(F,{sx:{display:"flex",flexDirection:"column",alignContent:"center",alignItems:"center",justifyContent:"center",minWidth:S.staticNav?"calc((100vw - (100vw - 100%)) - 300px)":"calc(100vw - (100vw - 100%))",minHeight:"100vh",marginLeft:S.staticNav?"300px":"unset"},children:[e.jsx(At,{settings:S,curPage:N,pageCount:r.pageCount}),e.jsx(F,{sx:{alignSelf:"stretch"},children:e.jsx(at,{pages:rt,pageCount:r.pageCount,setCurPage:M,initialPage:st,curPage:N,settings:S,manga:h,chapter:r,nextChapter:tt,prevChapter:nt},r.id)})]})}export{$n as Reader};
