import{u as b,a as i,c as g,h as u,j as r,f as C,b4 as x,I as J,H as T,m as h}from"./index-CrbHiwnJ.js";import{P as j}from"./Progress-DXKOFpC2.js";const U=e=>{if(!e)return 0;const o=e.failedJobs.mangas.totalCount+e.completeJobs.mangas.totalCount,n=o+e.pendingJobs.mangas.totalCount+e.runningJobs.mangas.totalCount,s=100*(o/n);return Number.isNaN(s)?0:s};let t=!1;function _({handleFinishedUpdate:e}){const{t:o}=b(),{data:n,refetch:s}=i.useGetLastGlobalUpdateTimestamp(),c=n==null?void 0:n.lastUpdateTimestamp.timestamp,{data:l}=i.useGetGlobalUpdateSummary(),a=l==null?void 0:l.updateStatus,m=!!(a!=null&&a.isRunning),p=g.useMemo(()=>U(a),[a==null?void 0:a.failedJobs.mangas.totalCount,a==null?void 0:a.completeJobs.mangas.totalCount,a==null?void 0:a.pendingJobs.mangas.totalCount,a==null?void 0:a.runningJobs.mangas.totalCount]);g.useEffect(()=>{!t&&(a!=null&&a.isRunning)&&(t=!0),t&&p===100&&(t=!1,e==null||e(),s().catch(u()))},[a==null?void 0:a.isRunning]);const d=async()=>{try{t=!0,await i.startGlobalUpdate().response,s().catch(u("UpdateChecker::reFetchLastTimestamp"))}catch(f){t=!1,h(o("global.error.label.update_failed"),"error")}};return r.jsx(C,{title:o("library.settings.global_update.label.last_update_tooltip",{date:c?x.format(+c):"-"}),children:r.jsx(J,{onClick:d,disabled:m,children:m?r.jsx(j,{progress:p}):r.jsx(T,{})})})}export{_ as U};
