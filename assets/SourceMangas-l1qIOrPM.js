import{at as fe,a0 as Se,j as e,c as Ne,ay as E,T as be,aA as Be,bc as je,bd as Ce,be as He,G as L,b2 as ve,v as ye,au as Ee,b as H,f as j,bf as Ve,bg as qe,bh as k,aT as We,u as Te,B as M,a8 as Ke,C as B,I as Z,a7 as ze,o as Qe,ao as Ye,p as Je,q as Xe,b6 as Ze,w as et,bi as tt,k as ee,H as st,aD as at,bj as rt,h as nt,aE as ge,e as ot,y as it,E as he,bk as N,r as _,bl as lt,a as ct,d as ut,$ as dt,x as pt,A as mt,aK as gt,a4 as te,bm as ht,g as xe,z as xt,S as ft,bn as St,m as bt}from"./index-D8Oh_qVq.js";import{I as jt,F as Ct}from"./IconWebView-Cmgxr3Gn.js";import{F as Fe}from"./FilterList-bH7lNTcw.js";import{G as vt}from"./GridLayouts-BZxWcYkG.js";import{S as yt,A as Et}from"./AppbarSearch-BuATHsZ5.js";import{D as Tt}from"./Delete-qK5fizcQ.js";import{S as Ft,O as It}from"./SortRadioInput-FDYNxGVv.js";import{C as Lt}from"./CheckboxInput-CXyhhW3l.js";import{a as Ie,E as Le}from"./ExpandMore-CdiEFaIb.js";import{u as kt}from"./useDebounce-BrqvWlu7.js";import{T as _t}from"./ThreeStateCheckboxInput-Dbiv8Xcy.js";import{S as Pt}from"./StyledFab-OrSpimpy.js";import{C as wt}from"./Chip-D4IYlxIt.js";import{B as At}from"./BaseMangaGrid-ZpaQK0UV.js";import{b as Ot}from"./MangaGrid-DbSpksrP.js";import{E as Mt}from"./EmptyViewAbsoluteCentered-31nAN-mp.js";import{u as $t}from"./useAppTitleAndAction-DuDnxgfr.js";import{V as Rt}from"./Virtuoso.util-Wg6phW9x.js";import{L as Dt}from"./Link-DBB8E49F.js";import"./Checkbox-Dx_Xcwmq.js";import"./SwitchBase-Bp_PtR-Q.js";import"./ListPreference-qZ5BSP_5.js";import"./FormGroup-CoALbpTZ.js";import"./ContinueReadingTooltip-B8QgUclj.js";import"./Trackers-Bgo8y--2.js";import"./AvatarSpinner-BlIN0nU8.js";import"./SpinnerImage-BV3qyVLf.js";import"./Refresh-DvhQbzDR.js";import"./Image-0CLmpHMJ.js";import"./Card-CevtIbQM.js";import"./ListCardContent-BDE_NyXZ.js";import"./CheckCircle-BgSl_iOR.js";import"./Metadata-BaxnTPn1.js";import"./Mangas-I67dDp1L.js";import"./Chapters-CVttOoOw.js";import"./DateHelper-DOQBqbbu.js";import"./Asserts-mFxccwFC.js";import"./MUI.util-CEodEA2f.js";import"./CardActionArea-D_sERIbd.js";import"./useManageMangaLibraryState-CSdxGv0o.js";import"./NumberSetting-y3kz1zEK.js";import"./Slider-Dlmh94m5.js";import"./useMobilePicker-C6pX9DvI.js";import"./SelectSetting-ZmBgvVuL.js";import"./Select-CeEAyCPy.js";import"./Download-Bo6m7nbS.js";import"./Sync-EQIah2Xt.js";import"./use-merged-ref-blPtmSgO.js";import"./ListCardAvatar-DSsBH-Bj.js";import"./PlayArrow-D3ihUPWR.js";import"./index-Cu-MLobN.js";import"./useAppTitle-LfOXXKjx.js";import"./useAppAction-BL9SevjS.js";function Ut(){const[t,n]=fe("source-grid-layout",Se.Compact);return e.jsx(vt,{gridLayout:t,onChange:n})}const Gt=Ne(e.jsx("path",{d:"M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3m3-10H5V5h10z"})),Nt=t=>{const{state:n,name:a,position:o,group:s,updateFilterValue:c,update:r}=t,[u,l]=E.useState(n),x=d=>{l(d.target.checked);const g=r.filter(S=>!(o===S.position&&s===S.group));c([...g,{type:"checkBoxState",position:o,state:d.target.checked,group:s}])};return n!==void 0?e.jsx(Lt,{label:a,checked:u,onChange:x}):null},Bt=({name:t})=>e.jsx(be,{sx:{mt:2},variant:"subtitle2",children:t},t);function Ht(t,n,a,o,s,c,r){const[u,l]=E.useState(a);if(t){const x=g=>{const S=t.indexOf("".concat(g.target.value));l(S);const p=c.filter(m=>!(o===m.position&&r===m.group));s([...p,{type:"selectState",position:o,state:S,group:r}])},d=t.map(g=>e.jsx(Be,{value:g,children:g},"".concat(n," ").concat(g)));return e.jsxs(je,{sx:{my:1},variant:"standard",children:[e.jsx(Ce,{children:n}),e.jsx(He,{name:n,value:t[u],label:n,onChange:x,children:d})]})}return null}const Vt=({values:t,name:n,state:a,position:o,updateFilterValue:s,update:c,group:r})=>Ht(t,n,a,o,s,c,r),qt=t=>{const{values:n,name:a,state:o,position:s,group:c,updateFilterValue:r,update:u}=t,[l,x]=E.useState(o),[d,g]=E.useState(!1),S=()=>{g(!d)};if(n){const p=m=>{const h=l;h.index===m?h.ascending=!h.ascending:h.ascending=!0,h.index=m,x(h);const v=u.filter(f=>!(s===f.position&&c===f.group));r([...v,{type:"sortState",position:s,state:h,group:c}])};return e.jsxs(L,{sx:{mx:-2},children:[e.jsxs(ve,{onClick:S,children:[e.jsx(ye,{primary:a}),d?e.jsx(Ie,{}):e.jsx(Le,{})]}),e.jsx(Ee,{in:d,children:e.jsx(H,{sx:{mx:4},children:n.map((m,h)=>e.jsx(Ft,{label:m,checked:l.index===h,sortDescending:!l.ascending,onClick:()=>p(h)},"".concat(a," ").concat(m)))})})]})}return null},Wt=t=>{const{state:n,name:a,position:o,group:s,updateFilterValue:c,update:r}=t,[u,l]=E.useState(n||""),x=kt(u,500);return j.useEffect(()=>{const d=r.filter(g=>!(o===g.position&&s===g.group));c([...d,{type:"textState",position:o,state:x,group:s}])},[x]),n!==void 0?e.jsxs(je,{sx:{my:1},variant:"standard",children:[e.jsx(Ce,{children:a}),e.jsx(Ve,{name:a,value:u,onChange:({target:{value:d}})=>l(d),endAdornment:e.jsx(qe,{position:"end",children:e.jsx(yt,{})})})]}):null},Kt=t=>{switch(t){case k.Ignore:return 0;case k.Include:return 1;case k.Exclude:return 2;default:throw new Error("Unexpected TriState ".concat(t))}},zt=t=>{switch(t){case 0:return k.Ignore;case 1:return k.Include;case 2:return k.Exclude;default:throw new Error("Unexpected state number ".concat(t))}},Qt=t=>{const{state:n,name:a,position:o,group:s,updateFilterValue:c,update:r}=t,[u,l]=E.useState(Kt(n)),x=d=>{const g=d===void 0?0:d?1:2;l(g);const S=r.filter(p=>!(o===p.position&&s===p.group));c([...S,{type:"triState",position:o,state:zt(g),group:s}])};return n!==void 0?e.jsx(_t,{label:a,checked:[void 0,!0,!1][u],onChange:d=>x(d)}):null},Yt=t=>{const{state:n,name:a,position:o,updateFilterValue:s,update:c}=t,[r,u]=E.useState(!1);return e.jsxs(L,{sx:{mx:-2},children:[e.jsxs(ve,{onClick:()=>u(!r),children:[e.jsx(ye,{primary:a}),r?e.jsx(Ie,{}):e.jsx(Le,{})]}),e.jsx(Ee,{in:r,children:e.jsx(H,{sx:{mx:4},children:e.jsx(ke,{sourceFilter:n,group:o,updateFilterValue:s,update:c})})})]})},Jt=({name:t})=>e.jsx(We,{sx:{my:1},textAlign:"center",children:t},t);function ke({sourceFilter:t,group:n,updateFilterValue:a,update:o}){return e.jsx(H,{children:t.map((s,c)=>{var u,l;let r=o.find(x=>x.group===n&&x.position===c);switch(r=r&&r.state,s.type){case"CheckBoxFilter":return e.jsx(Nt,{name:s.name,state:r!=null?r:s.CheckBoxFilterDefault,position:c,group:n,updateFilterValue:a,update:o},"filters ".concat(s.name));case"GroupFilter":return e.jsx(Yt,{name:s.name,state:s.filters,position:c,updateFilterValue:a,update:o},"filters ".concat(s.name));case"HeaderFilter":return e.jsx(Bt,{name:s.name},"filters ".concat(s.name));case"SelectFilter":return e.jsx(Vt,{name:s.name,values:s.values,state:r!=null?parseInt(r,10):s.SelectFilterDefault,position:c,group:n,updateFilterValue:a,update:o},"filters ".concat(s.name));case"SeparatorFilter":return e.jsx(Jt,{name:s.name},"filters ".concat(s.name));case"SortFilter":return e.jsx(qt,{name:s.name,values:s.values,state:r!=null?r:{ascending:(u=s.SortFilterDefault)==null?void 0:u.ascending,index:(l=s.SortFilterDefault)==null?void 0:l.index},position:c,group:n,updateFilterValue:a,update:o},"filters ".concat(s.name));case"TextFilter":return e.jsx(Wt,{name:s.name,state:r!=null?r:s.TextFilterDefault,position:c,group:n,updateFilterValue:a,update:o},"filters ".concat(s.name));case"TriStateFilter":return e.jsx(Qt,{name:s.name,state:r!=null?r:s.TriStateFilterDefault,position:c,group:n,updateFilterValue:a,update:o},"filters ".concat(s.name));default:throw new Error('Unknown source filter "'.concat(s,'"'))}})},"filters ".concat(n))}function Xt({savedSearches:t={},selectSavedSearch:n,updateSavedSearches:a,sourceFilter:o,updateFilterValue:s,resetFilterValue:c,setTriggerUpdate:r,update:u}){const{t:l}=Te(),[x,d]=j.useState(!1),[g,S]=j.useState(""),p=Object.keys(t),m=!!p.length;function h(){c(0),d(!1)}function v(){r(0),d(!1)}return e.jsxs(e.Fragment,{children:[e.jsxs(Pt,{onClick:()=>d(!x),variant:"extended",color:"primary",children:[e.jsx(Fe,{}),l("global.button.filter")]}),e.jsxs(It,{open:x,onClose:()=>d(!1),children:[e.jsxs(L,{sx:{p:2,pb:m?void 0:0},children:[e.jsxs(L,{sx:{display:"flex",pb:1},children:[e.jsx(M,{onClick:h,children:l("global.button.reset")}),e.jsx(Ke,{variant:"dialog",popupId:"source-browse-save-search",children:f=>e.jsxs(e.Fragment,{children:[e.jsx(B,{title:l("source.filter.save_search.label.save"),children:e.jsx(Z,{sx:{marginLeft:"auto"},...ze(f),children:e.jsx(Gt,{})})}),e.jsxs(Qe,{...Ye(f),maxWidth:"xs",fullWidth:!0,children:[e.jsx(Je,{children:l("source.filter.save_search.dialog.label.title")}),e.jsx(Xe,{children:e.jsx(Ze,{sx:{width:"100%"},value:g,onChange:y=>S(y.target.value),slotProps:{htmlInput:{maxLength:50}}})}),e.jsxs(et,{children:[e.jsx(M,{onClick:()=>{S(""),f.close()},children:l("global.button.cancel")}),e.jsx(M,{onClick:()=>{a(g,"create"),S(""),f.close()},children:l("global.button.ok")})]})]})]})}),e.jsx(M,{variant:"contained",onClick:v,children:l("global.button.submit")})]}),m&&e.jsxs(e.Fragment,{children:[e.jsx(be,{sx:{pb:1},children:"Saved searches"}),e.jsx(H,{sx:{flexDirection:"row"},children:p.map(f=>e.jsx(wt,{label:f,onClick:()=>{d(!1),n(f)},onDelete:()=>{tt.show({title:l("global.label.are_you_sure"),message:l("source.filter.save_search.dialog.label.delete",{name:f}),actions:{confirm:{title:l("global.button.delete")}}}).then(()=>a(f,"delete")).catch(ee())},deleteIcon:e.jsx(B,{title:l("source.filter.save_search.label.delete"),children:e.jsx(Tt,{})}),variant:"outlined"}))})]})]}),e.jsx(L,{sx:{pb:2,mx:2},children:e.jsx(ke,{sourceFilter:o,updateFilterValue:s,group:void 0,update:u})})]})]})}const Zt={id:"-1"},es=te("div")(({theme:t})=>({display:"flex",position:"sticky",width:"100%",zIndex:1,padding:t.spacing(1),gap:t.spacing(1),backgroundColor:t.palette.background.default})),X=te(M)(()=>({})),ts=te(L)(()=>({minHeight:"100%",position:"relative"}));var ss=(t=>(t[t.POPULAR=0]="POPULAR",t[t.LATEST=1]="LATEST",t[t.SEARCH=2]="SEARCH",t))(ss||{});const as={0:"manga.error.label.no_mangas_found",1:"manga.error.label.no_mangas_found",2:"manga.error.label.no_matches"},rs=t=>{const n={},a=[];return t.forEach(o=>{!!n[o.id]||(n[o.id]=o,a.push(o))}),a},ns=(t,n,a,o,s,c)=>{var p;let r;switch(n){case 0:r=_.useGetSourcePopularMangas(t,s);break;case 1:r=_.useGetSourceLatestMangas(t,s);break;case 2:r=_.useSourceSearch(t,a!=null?a:"",o.map(m=>{const{position:h,state:v,group:f}=m;return f!==void 0?{position:f,groupChange:{position:h,[m.type]:v}}:{position:h,[m.type]:v}}),s);break;default:throw new Error('Unknown ContentType "'.concat(n,'"'))}const u=r[1],l=u.findLastIndex(m=>{var h;return!!((h=m.data)!=null&&h.fetchSourceManga)}),x=u[l],d=u.slice(-1)[0].isLoading;let g=!d;const S=j.useMemo(()=>{let m=[];return u.forEach((h,v)=>{var w,C,$;const f=($=(C=(w=h.data)==null?void 0:w.fetchSourceManga)==null?void 0:C.mangas)!=null?$:[],y=f.filter(V=>!c||!V.inLibrary),P=rs([...m,...y]);g=!d&&u.length===v+1&&!y.length&&!!f.length,m=P}),m},[u,c]);return l===-1?[r[0],{...r[1][r[1].length-1],filteredOutAllItemsOfFetchedPage:g}]:[r[0],{...u[u.length-1],data:{...x.data,fetchSourceManga:{...x.data.fetchSourceManga,hasNextPage:u.length>l+1?!1:!!((p=x.data.fetchSourceManga)!=null&&p.hasNextPage),mangas:S}},filteredOutAllItemsOfFetchedPage:g}]};function la(){var ie,le,ce,ue,de,pe;const{t}=Te(),{appBarHeight:n}=st(),{sourceId:a}=at(),[o,s]=rt(),c=nt(),r=ge(),{key:u,state:l}=r,{contentType:x=0,clearCache:d=!1}=(ie=ge().state)!=null?ie:{},{settings:{hideLibraryEntries:g}}=ot(),[S]=fe("source-grid-layout",Se.Compact),[p]=it(he.QUERY,xt),[m,h]=N("source-mangas-".concat(a,"-filters"),[]),[v,f]=N("source-mangas-location-".concat(u,"-").concat(a,"-filters"),m!=null?m:[]),[y,P]=j.useState(v),[se,w]=N("source-mangas-".concat(a,"-content-type"),x),[C,$]=N("source-mangas-location-".concat(u,"-").concat(a,"-content-type"),p?2:se),{key:V,deleteState:_e}=Rt.usePersistState(Ot),R=j.useCallback(()=>{_e(),window.scrollTo(0,0)},[V]),ae=j.useRef(p),re=j.useRef(()=>{});ae.current!==p&&C===2&&(ae.current=p,re.current(new Error("SourceMangas(".concat(a,"): search string changed"))),R()),j.useEffect(()=>()=>{h(void 0),w(void 0)},[a]);const q=b=>{h(b),f(b),R()},ne=b=>{w(b),$(b)},Pe="".concat(C).concat(JSON.stringify(v)).concat(p),[W,{data:T,error:D,isLoading:K,size:U,abortRequest:we,filteredOutAllItemsOfFetchedPage:z}]=ns(a,C,p,v,1,g);re.current=we;const Q=(ce=(le=T==null?void 0:T.fetchSourceManga)==null?void 0:le.mangas)!=null?ce:[],A=!!((ue=T==null?void 0:T.fetchSourceManga)!=null&&ue.hasNextPage),Y=K||z&&A,{data:J}=_.useGetSource(lt,a),i=J==null?void 0:J.source,Ae=(de=i==null?void 0:i.filters)!=null?de:[],{savedSearches:F={}}=ct(i!=null?i:Zt),oe=ut(i!=null?i:{id:"-1"},b=>bt(t("global.error.label.failed_to_save_changes"),"error",xe(b))),Oe=j.useCallback(b=>{const{query:I,filters:O}=F[b];O&&(P(O),q(O)),I&&(o.set(he.QUERY,I),s(o))},[F,l]),Me=j.useCallback((b,I)=>{if(I==="delete"){const me={...F};delete me[b],oe("savedSearches",me);return}const O={...F,[b]:{query:p!=null?p:void 0,filters:y}};oe("savedSearches",O)},[F,p,y]),$e=Y?void 0:t(as[C]),Re=a===ft.LOCAL_SOURCE_ID?e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:[t("source.local_source.label.checkout")," "]}),e.jsx(Dt,{href:"https://github.com/Suwayomi/Suwayomi-Server/wiki/Local-Source",target:"_blank",rel:"noreferrer",children:t("source.local_source.label.guide")})]}):void 0,G=j.useCallback((b,I)=>{ne(b),R(),p&&!I&&c({pathname:""},{state:{...l,contentType:b}})},[ne,p,R]);!!p&&C!==2&&G(2,p);const De=j.useCallback(()=>{A&&W(U+1)},[U,A,C]),Ue=()=>{P([]),q([])};j.useEffect(()=>{dt("lastUsedSourceId",a).catch(ee())},[a]),j.useEffect(()=>{z&&A&&!K&&W(U+1)},[z,K]),j.useEffect(()=>{!d||!St.REVALIDATION_UNSUPPORTED.includes(a)||_.clearBrowseCacheFor(a)},[d]),$t((pe=i==null?void 0:i.displayName)!=null?pe:t("source.title_one"),e.jsxs(e.Fragment,{children:[e.jsx(Et,{}),e.jsx(Ut,{}),e.jsx(B,{title:t("global.button.open_webview"),disabled:!(i!=null&&i.baseUrl),children:e.jsx(Z,{disabled:!(i!=null&&i.baseUrl),href:i!=null&&i.baseUrl?_.getWebviewUrl(i==null?void 0:i.baseUrl):"",rel:"noreferrer",target:"_blank",color:"inherit",children:e.jsx(jt,{})})}),(i==null?void 0:i.isConfigurable)&&e.jsx(B,{title:t("settings.title"),children:e.jsx(Z,{onClick:()=>c(mt.sources.childRoutes.configure.path(a)),"aria-label":"display more actions",edge:"end",color:"inherit",children:e.jsx(pt,{})})})]}),[i]);const Ge=Q.length?gt:Mt;return e.jsxs(ts,{children:[e.jsxs(es,{sx:{top:"".concat(n,"px")},children:[e.jsx(X,{variant:C===0?"contained":"outlined",startIcon:e.jsx(Ct,{}),onClick:()=>G(0),children:t("global.button.popular")}),(i==null?void 0:i.supportsLatest)===void 0||i.supportsLatest?e.jsx(X,{disabled:!(i!=null&&i.supportsLatest),variant:C===1?"contained":"outlined",startIcon:e.jsx(ht,{}),onClick:()=>G(1),children:t("global.button.latest")}):null,e.jsx(X,{variant:C===2?"contained":"outlined",startIcon:e.jsx(Fe,{}),onClick:()=>G(2,p),children:t("global.button.filter")})]}),(Y||!D||!!D&&!!Q.length)&&e.jsx(At,{gridWrapperProps:{sx:{px:1,pb:1}},mangas:Q,hasNextPage:A,loadMore:De,message:$e,messageExtra:Re,isLoading:Y,gridLayout:S,mode:"source",inLibraryIndicator:!0},Pe),D&&e.jsx(Ge,{message:t("global.error.label.failed_to_load_data"),messageExtra:xe(D),retry:()=>W(U).catch(ee())}),C===2&&e.jsx(Xt,{savedSearches:F,selectSavedSearch:Oe,updateSavedSearches:Me,sourceFilter:Ae,updateFilterValue:P,setTriggerUpdate:()=>{q(y)},resetFilterValue:Ue,update:y})]})}export{ss as SourceContentType,la as SourceMangas};
