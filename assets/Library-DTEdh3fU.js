import{u as w,r as R,P as ye,Q as he,q as P,j as t,U as T,W as Se,X as je,Y as j,Z as O,_ as ke,y as _e,n as le,l as oe,f as p,$ as z,i as ge,I as Te,a0 as Me,a1 as U,a2 as Fe,a3 as Le,a4 as Ae,a5 as Ie,m as D,a6 as we,N as Be,E as ne,k as Oe,D as Re,F as ve,G as Ee}from"./index-CquUQo3v.js";import{u as ue,S as De,A as Ne,N as Ge}from"./AppbarSearch-D3-cZ5U7.js";import{F as Ue}from"./FilterList-Bec-nunb.js";import{S as Pe,R as N}from"./SortRadioInput-D83sqQZj.js";import{T as M}from"./ThreeStateCheckboxInput-pzVu-ZqW.js";import{O as ze,S as We,a as Ye}from"./SelectionFAB-DZjS7cie.js";import{T as Ke}from"./Trackers-D4pSmk7a.js";import{R as He}from"./ListPreference-t27jsc4B.js";import{M as Ve,a as Qe}from"./MangaGrid-CaI0wp3g.js";import{C as Xe,U as Ze}from"./UpdateChecker-BrjLYvkf.js";import{u as $e}from"./useManageMangaLibraryState-Byufb9k2.js";import{T as Je}from"./TabsWrapper-BB3RRyyc.js";import{M as qe}from"./Mangas-UHUIhH1v.js";import{C as et}from"./Chip-C5pB5WJV.js";import"./StyledFab-BbyRMH-m.js";import"./Sync-DPTVKbYs.js";import"./Avatar-TgFmp6V5.js";import"./PlayArrow-CCbzoVWE.js";import"./Progress-CJqmg3t2.js";import"./Info-Bq7fkH3-.js";import"./TextField-C2-uV8Pc.js";import"./InputAdornment-DRquAD5l.js";import"./CheckCircle-BNeUiL1l.js";import"./NumberSetting-CNC_MFCS.js";import"./useMobilePicker-BUxHVmtG.js";import"./SelectSetting-CNMa1zpP.js";const tt={filter:"global.label.filter",sort:"global.label.sort",display:"global.label.display"},at=[["unreadChapters","library.option.sort.label.by_unread_chapters"],["totalChapters","library.option.sort.label.by_total_chapters"],["alphabetically","library.option.sort.label.alphabetically"],["dateAdded","library.option.sort.label.by_date_added"],["lastRead","library.option.sort.label.by_last_read"],["latestFetchedChapter","library.option.sort.label.by_latest_fetched_chapter"],["latestUploadedChapter","library.option.sort.label.by_latest_uploaded_chapter"]],st=({category:a,open:r,onClose:i})=>{var x,C;const{t:e}=w(),o=R.useGetTrackerList(ye),n=Ke.getLoggedIn((C=(x=o.data)==null?void 0:x.trackers.nodes)!=null?C:[]),l=he(a),c=ke(a,u=>le(e("global.error.label.failed_to_save_changes"),"error",oe(u))),{settings:{showTabSize:b}}=P(),k=_e(u=>le(e("search.error.label.failed_to_save_settings"),"error",oe(u)));return t.jsx(ze,{open:r,onClose:i,tabs:["filter","sort","display"],tabTitle:u=>e(tt[u]),tabContent:u=>{if(u==="filter")return t.jsxs(t.Fragment,{children:[t.jsx(M,{label:e("global.filter.label.unread"),checked:l.hasUnreadChapters,onChange:s=>c("hasUnreadChapters",s)}),t.jsx(M,{label:e("global.filter.label.downloaded"),checked:l.hasDownloadedChapters,onChange:s=>c("hasDownloadedChapters",s)}),t.jsx(M,{label:e("global.filter.label.bookmarked"),checked:l.hasBookmarkedChapters,onChange:s=>c("hasBookmarkedChapters",s)}),t.jsx(M,{label:e("global.filter.label.duplicate_chapters"),checked:l.hasDuplicateChapters,onChange:s=>c("hasDuplicateChapters",s)}),t.jsx(T,{sx:{mt:2},children:e("manga.label.status")}),Object.values(Se).map(s=>t.jsx(M,{label:e(je[s]),checked:l.hasStatus[s],onChange:g=>c("hasStatus",{...l.hasStatus,[s]:g})},s)),t.jsx(T,{sx:{mt:2},children:e("global.filter.label.tracked")}),n.map(s=>t.jsx(M,{label:s.name,checked:l.hasTrackerBinding[s.id],onChange:g=>c("hasTrackerBinding",{...l.hasTrackerBinding,[s.id]:g})},s.id))]});if(u==="sort")return at.map(([s,g])=>t.jsx(Pe,{label:e(g),checked:l.sortBy===s,sortDescending:l.sortDesc,onClick:()=>s!==l.sortBy?c("sortBy",s):c("sortDesc",!l.sortDesc)},s));if(u==="display"){const{gridLayout:s,showContinueReadingButton:g,showDownloadBadge:h,showUnreadBadge:A}=l;return t.jsxs(t.Fragment,{children:[t.jsx(T,{children:e("global.grid_layout.title")}),t.jsxs(He,{onChange:B=>c("gridLayout",Number(B.target.value)),value:s,children:[t.jsx(N,{label:e("global.grid_layout.label.compact_grid"),value:j.Compact,checked:s==null||s===j.Compact}),t.jsx(N,{label:e("global.grid_layout.label.comfortable_grid"),value:j.Comfortable,checked:s===j.Comfortable}),t.jsx(N,{label:e("global.grid_layout.label.list"),value:j.List,checked:s===j.List})]}),t.jsx(T,{sx:{mt:2},children:e("library.option.display.badge.title")}),t.jsx(O,{label:e("library.option.display.badge.label.unread_badges"),checked:A,onChange:()=>c("showUnreadBadge",!A)}),t.jsx(O,{label:e("library.option.display.badge.label.download_badges"),checked:h,onChange:()=>c("showDownloadBadge",!h)}),t.jsx(T,{sx:{mt:2},children:e("library.option.display.tab.title")}),t.jsx(O,{label:e("library.option.display.tab.label.show_number_of_items"),checked:b,onChange:()=>k("showTabSize",!b)}),t.jsx(T,{sx:{mt:2},children:e("global.label.other")}),t.jsx(O,{label:e("library.option.display.other.label.show_continue_reading_button"),checked:g,onChange:()=>c("showContinueReadingButton",!g)})]})}return null}})},rt=({category:a})=>{const{t:r}=w(),[i,e]=p.useState(!1),{options:o}=z(),n=o.hasDownloadedChapters!=null||o.hasUnreadChapters!=null||o.hasBookmarkedChapters!=null||o.hasDuplicateChapters!=null||Object.values(o.hasStatus).some(l=>l!=null)||Object.values(o.hasTrackerBinding).some(l=>l!=null);return t.jsxs(t.Fragment,{children:[t.jsx(ge,{title:r("settings.title"),children:t.jsx(Te,{onClick:()=>e(!i),color:n?"warning":"inherit",children:t.jsx(Ue,{})})}),t.jsx(st,{category:a,open:i,onClose:()=>e(!1)})]})},ie=({showFilteredOutMessage:a,message:r,messageExtra:i,...e})=>{const{t:o}=w(),{options:n}=z();return p.useLayoutEffect(()=>(document.body.style.overflowY=n.gridLayout===j.List?"auto":"scroll",()=>{document.body.style.overflowY="auto"}),[]),t.jsx(Ve,{gridWrapperProps:{sx:{p:1}},...e,hasNextPage:!1,loadMore:()=>{},message:a?o("library.error.label.no_matches"):r,messageExtra:a?void 0:i,gridLayout:n.gridLayout})},lt=({isActive:a,areAllItemsSelected:r,areNoItemsSelected:i,onSelectAll:e,onModeChange:o})=>{const{t:n}=w();return t.jsxs(t.Fragment,{children:[a&&t.jsx(We,{areAllItemsSelected:r,areNoItemsSelected:i,onChange:e}),t.jsx(ge,{title:n(a?"global.button.cancel":"global.button.select_all"),children:t.jsx(Me,{checkedIcon:t.jsx(Xe,{}),sx:{padding:"8px",color:"inherit","&.Mui-checked":{color:"inherit"}},checked:a,onChange:(l,c)=>o(c)})})]})},W=(a,r,i)=>{switch(a){case!0:return r();case!1:return i();default:return!0}},G=(a,r)=>W(a,()=>!!r&&r>=1,()=>r===0),pe=(a,r)=>W(a,()=>!!r,()=>!r),F=(a,r)=>{const i=a==null?void 0:a.filter(l=>l!=null),e=r==null?void 0:r.filter(l=>l!=null);if(!(i!=null&&i.length))return!0;const o=i.map(U),n=e.map(U).join(", ");return o.every(l=>n.includes(l))},ot=(a,{title:r,genre:i,description:e,artist:o,author:n,source:l})=>F([a],[r])||F(a==null?void 0:a.split(","),i.map(c=>U(c)))||F([a],[e])||F([a],[o])||F([a],[n])||F([a],[l==null?void 0:l.displayName]),nt=(a,r)=>Object.entries(a).map(([i,e])=>{const o=r.trackRecords.nodes.some(n=>n.trackerId===Number(i));return W(e,()=>o,()=>!o)}).every(Boolean),it=(a,r)=>Object.entries(a).map(([i,e])=>pe(e,i===r.status)).every(Boolean),ct=(a,{hasDownloadedChapters:r,hasUnreadChapters:i,hasBookmarkedChapters:e,hasDuplicateChapters:o,hasTrackerBinding:n,hasStatus:l})=>G(r,a.downloadCount)&&G(i,a.unreadCount)&&G(e,a.bookmarkCount)&&pe(o,a.hasDuplicateChapters)&&nt(n,a)&&it(l,a),dt=(a,r,i)=>{const e=i.ignoreFilters&&(r==null?void 0:r.length);return a.filter(o=>{const n=ot(r,o),l=e||ct(o,i);return n&&l})},L=(a=0,r=0)=>Number(a)-Number(r),ht=(a,r)=>a.localeCompare(r),gt=(a,r,i)=>{const e=[...a];switch(r){case"alphabetically":e.sort((o,n)=>ht(o.title,n.title));break;case"dateAdded":e.sort((o,n)=>L(o.inLibraryAt,n.inLibraryAt));break;case"unreadChapters":e.sort((o,n)=>L(o.unreadCount,n.unreadCount));break;case"lastRead":e.sort((o,n)=>{var l,c;return L((l=o.lastReadChapter)==null?void 0:l.lastReadAt,(c=n.lastReadChapter)==null?void 0:c.lastReadAt)});break;case"latestUploadedChapter":e.sort((o,n)=>{var l,c;return L((l=o.latestUploadedChapter)==null?void 0:l.uploadDate,(c=n.latestUploadedChapter)==null?void 0:c.uploadDate)});break;case"latestFetchedChapter":e.sort((o,n)=>{var l,c;return L((l=o.latestFetchedChapter)==null?void 0:l.fetchedAt,(c=n.latestFetchedChapter)==null?void 0:c.fetchedAt)});break;case"totalChapters":e.sort((o,n)=>L(o.chapters.totalCount,n.chapters.totalCount));break}return i&&e.reverse(),e},ut={id:-1},pt=(a,r)=>{const[i]=ue("query",De),e=he(r!=null?r:ut),{hasUnreadChapters:o,hasDownloadedChapters:n,hasBookmarkedChapters:l,hasTrackerBinding:c,hasDuplicateChapters:b,hasStatus:k}=e,{settings:x}=P(),C=p.useMemo(()=>dt(a,i,{...e,ignoreFilters:x.ignoreFilters}),[a,i,o,n,l,c,b,k,x.ignoreFilters]),u=p.useMemo(()=>gt(C,e.sortBy,e.sortDesc),[C,e.sortBy,e.sortDesc]),s=Object.values(e.hasTrackerBinding).some(h=>h!=null),g=(o!=null||n!=null||l!=null||!!i||s)&&C.length===0&&a.length>0;return{visibleMangas:u,showFilteredOutMessage:g}},ce=Fe("span")({display:"flex",alignItems:"center"}),de=({sx:a,...r})=>t.jsx(et,{...r,size:"small",sx:{...a,marginLeft:"5px"}});function Pt(){var q,ee,te,ae,se,re;const{t:a}=w(),{settings:{showTabSize:r}}=P(),{data:i,error:e,loading:o,refetch:n}=R.useGetCategories(Le,{notifyOnNetworkStatusChange:!0}),l=i==null?void 0:i.categories.nodes.filter(d=>d.id!==0||d.id===0&&d.mangas.totalCount),c=l!=null?l:[],b=R.useGetMangas(Ae,{}),k=(ee=(q=b.data)==null?void 0:q.mangas.totalCount)!=null?ee:0,[x,C]=ue("tab",Ge),{setOptions:u}=z(),s=(te=c.find(d=>d.order===x))!=null?te:c[0];p.useLayoutEffect(()=>{u(Ie(s!=null?s:{id:-1}))},[s]);const{data:g,error:h,loading:A,refetch:B}=R.useGetCategoryMangas(s==null?void 0:s.id,{skip:!s,notifyOnNetworkStatusChange:!0}),be=(ae=g==null?void 0:g.mangas.nodes)!=null?ae:[],{visibleMangas:m,showFilteredOutMessage:Y}=pt(be,s),K=p.useCallback(()=>B().catch(D()),[B,s]),me=p.useMemo(()=>m.map(d=>d.id),[m]),[f,v]=p.useState(!1),{areNoItemsForKeySelected:H,areAllItemsForKeySelected:V,selectedItemIds:y,handleSelectAll:E,handleSelection:Ce,clearSelection:xe}=$e(m.length,{itemIds:me,currentKey:s==null?void 0:s.id.toString()}),Q=(d,S,_)=>{v(!!(y.length+(S?1:-1))),Ce(d,S,_)},X=p.useMemo(()=>y.map(d=>qe.getFromCache(d,we,"MANGA_CHAPTER_STAT_FIELDS")).filter(d=>!!d),[y.length,m]),Z=p.useMemo(()=>f?t.jsx(Ye,{selectedItemsCount:y.length,title:"manga.title",children:(d,S)=>t.jsx(Qe,{selectedMangas:X,onClose:()=>{d(),v(!1),xe()},setHideMenu:S})}):null,[f,X]),{setTitle:$,setAction:J}=p.useContext(Be);p.useLayoutEffect(()=>{const d=a("library.title");return $(t.jsxs(ce,{children:[d,r&&t.jsx(de,{sx:{color:"inherit"},label:k})]}),d),J(t.jsxs(t.Fragment,{children:[!f&&s&&t.jsxs(t.Fragment,{children:[t.jsx(Ne,{}),t.jsx(rt,{category:s}),t.jsx(Ze,{categoryId:s==null?void 0:s.id})]}),t.jsx(lt,{isActive:f,areAllItemsSelected:V,areNoItemsSelected:H,onSelectAll:_=>E(_,[...new Set(m.map(I=>I.id))]),onModeChange:_=>{v(_),_?E(!0,[...new Set(m.map(I=>I.id))]):c.forEach(I=>E(!1,[],I.id.toString()))}})]})),()=>{$(""),J(null)}},[a,k,o,f,H,V,y.length,m.length,s,r]);const fe=d=>{C(d)};return e!=null||b.error?t.jsx(ne,{message:a("global.error.label.failed_to_load_data"),messageExtra:(re=e==null?void 0:e.message)!=null?re:(se=b.error)==null?void 0:se.message,retry:()=>{e&&n().catch(D()),b.error&&b.refetch().catch(D())}}):o||b.loading?t.jsx(Oe,{}):c.length===0?t.jsx(ne,{message:a("library.error.label.empty")}):c.length===1?t.jsxs(t.Fragment,{children:[t.jsx(ie,{mangas:m,message:a(h?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:h==null?void 0:h.message,isLoading:A,selectedMangaIds:y,isSelectModeActive:f,handleSelection:Q,showFilteredOutMessage:!h&&Y,retry:h&&K}),Z]}):t.jsxs(Je,{children:[t.jsx(Re,{value:s.order,onChange:(d,S)=>fe(S),children:c.map(d=>t.jsx(ve,{sx:{flexGrow:1,maxWidth:"unset"},label:t.jsxs(ce,{children:[d.name,r?t.jsx(de,{label:d.mangas.totalCount}):null]}),value:d.order},d.id))}),c.map(d=>t.jsx(Ee,{index:d.order,currentIndex:s.order,children:d===s&&t.jsx(ie,{mangas:m,message:a(h?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:h==null?void 0:h.message,isLoading:A,selectedMangaIds:y,isSelectModeActive:f,handleSelection:Q,showFilteredOutMessage:!h&&Y,retry:h&&K})},d.order)),Z]})}export{Pt as Library};
