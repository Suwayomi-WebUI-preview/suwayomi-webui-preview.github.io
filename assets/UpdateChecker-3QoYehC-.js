import{c as U,j as a,u as _,M as J,h as u,r as c,n as C,ad as R,k as I,I as E,ae as G,R as P,d as L,bC as N,ag as S,ah as w,aB as j,o as y,m as v}from"./index-D1T6UDnO.js";import{P as F}from"./Progress-CrqgVkz2.js";const H=U(a.jsx("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Clear"),B=s=>{if(!s)return 0;const r=s.failedJobs.mangas.totalCount+s.completeJobs.mangas.totalCount,t=r+s.pendingJobs.mangas.totalCount+s.runningJobs.mangas.totalCount,i=100*(r/t);return Number.isNaN(i)?0:i};let n=!1;function Q({categoryId:s,handleFinishedUpdate:r}){const{t}=_(),i=J.useIsTouchDevice(),[g,b]=u.useState(!1),{data:d,refetch:h}=c.useGetLastGlobalUpdateTimestamp(),f=d==null?void 0:d.lastUpdateTimestamp.timestamp,{data:p}=c.useGetGlobalUpdateSummary(),e=p==null?void 0:p.updateStatus,l=!!(e!=null&&e.isRunning),x=u.useMemo(()=>B(e),[e==null?void 0:e.failedJobs.mangas.totalCount,e==null?void 0:e.completeJobs.mangas.totalCount,e==null?void 0:e.pendingJobs.mangas.totalCount,e==null?void 0:e.runningJobs.mangas.totalCount]);u.useEffect(()=>{!n&&(e!=null&&e.isRunning)&&(n=!0),n&&x===100&&(n=!1,r==null||r(),h().catch(C()))},[e==null?void 0:e.isRunning]);const M=async o=>{try{n=!0,await c.startGlobalUpdate(o!==void 0?[o]:void 0).response,h().catch(C("UpdateChecker::reFetchLastTimestamp"))}catch(k){n=!1,y(t("global.error.label.update_failed"),"error",v(k))}},T=async()=>{try{await c.resetGlobalUpdate()}catch(o){y(t("library.error.label.stop_global_update"),"error",v(o))}},m=async o=>{l?T():M(o)};return a.jsx(R,{variant:"popover",popupId:"library-update-checker-menu",children:o=>a.jsxs(a.Fragment,{children:[a.jsx(I,{title:l?t("library.action.label.stop_update"):t("library.settings.global_update.label.last_update_tooltip",{date:f?N.format(+f):"-"}),children:a.jsx(E,{sx:{position:"relative"},...s!==void 0&&!l?G(o):{onClick:()=>m()},onMouseEnter:()=>b(!0),onMouseLeave:()=>b(!1),color:"inherit",children:l?a.jsxs(a.Fragment,{children:[a.jsx(H,{sx:{opacity:Number(i||g)}}),a.jsx(L,{sx:{position:"absolute"},children:a.jsx(F,{progress:x,showText:!i&&!g,progressProps:{color:"inherit"}})})]}):a.jsx(P,{})})}),a.jsxs(S,{...w(o),children:[a.jsx(j,{onClick:()=>{o.close(),m()},children:t("library.action.label.update_library")}),a.jsx(j,{onClick:()=>{o.close(),m(s)},children:t("library.action.label.update_category")})]})]})})}export{H as C,Q as U};
