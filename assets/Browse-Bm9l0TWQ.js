import{c as oe,j as e,u as _,A as R,L as V,r as S,S as W,T as m,B as q,C as U,I as M,m as T,g as C,a as Oe,b as Re,d as re,e as d,D as Pe,f as ae,h as K,i as O,k as Ce,l as ge,n as Be,o as De,p as ne,q as Ge,s as ve,t as Fe,v as ze,w as He,x as Ve,y as fe,z as je,E as We,G as qe}from"./index-OpXW1KW0.js";import{u as Le,S as Te,A as Ke}from"./AppbarSearch-CFQGYxWV.js";import{P as Xe}from"./PushPin-9V57I3Na.js";import{P as $e}from"./PushPinOutlined-Rj16CmdH.js";import{SourceContentType as Se}from"./SourceMangas-BeaQ69Zr.js";import{t as B,L as _e,g as H,I as Ye,a as Qe,E as we,b as w,c as Ze,d as Je,e as Ae,f as et,h as tt,i as st,j as nt}from"./LanguageSelect-DkoHwHZQ.js";import{M as Ee}from"./MUI.util-rvLc9bdt.js";import{u as ot,S as k,c as rt}from"./Sources-CD5UPGxq.js";import{L as ie}from"./ListCardAvatar-1xUOE694.js";import{L as X}from"./ListCardContent-BEEGxLcU.js";import{C as $}from"./Card-Brvj1qfN.js";import{C as ye}from"./CardActionArea-DO1JcQ7n.js";import{E as P}from"./EmptyViewAbsoluteCentered-BTKX45Or.js";import{u as Ie}from"./useAppAction-CXhc5cSH.js";import{f as at}from"./file-selector-DlHkLoY8.js";import{A as it}from"./Add-BS4n26wX.js";import{S as ce,V as ct,a as lt,b as ut}from"./Virtuoso.util-CSfZDELe.js";import{u as be}from"./use-window-event-EaGlakGX.js";import{T as te,a as se}from"./Tabs-CQ2Alpk4.js";import{T as dt}from"./TabsWrapper-BPDHnGYx.js";import{T as pt}from"./TabsMenu-BSQKkmx6.js";import{A as ht,a as xt}from"./SortRadioInput-CyiSnMrS.js";import{C as mt}from"./Chip-CwtKs_KY.js";import{u as gt}from"./useAppTitle-D3Pm6mqC.js";import"./ChaptersDownloadActionMenuItems-Dy91_VfM.js";import"./Trackers-D4pSmk7a.js";import"./Avatar-CxpQvqv7.js";import"./TextField-2rHtzMO4.js";import"./useFormControl-D6myaixV.js";import"./formControlState-Dq1zat_P.js";import"./InputAdornment-CVcTZIZd.js";import"./CheckCircle-BqRR8Teq.js";import"./Link-fOMPJgma.js";import"./useManageMangaLibraryState-DLzwx4oQ.js";import"./ThreeStateCheckboxInput-C3MnIQoe.js";import"./Checkbox-gQYD7q2P.js";import"./SwitchBase-DKhsKq_S.js";import"./CheckboxInput-C-lZzSB5.js";import"./FormGroup-Ue8E6mQI.js";import"./ListPreference-CzyMMXUh.js";import"./NumberSetting-DOWQUF9x.js";import"./Slider-BnKse4pz.js";import"./useMobilePicker-CBGjUjZ1.js";import"./SelectSetting-B5tQNLNv.js";import"./Select-Cw_HmK_h.js";import"./Favorite-DJT2B4KB.js";import"./FilterList-CD7Bl_Nc.js";import"./GridLayouts-Mk4GyO6v.js";import"./Delete-BiOOirdi.js";import"./ExpandMore-XNJvUCjT.js";import"./useDebounce-B9LlptDJ.js";import"./StyledFab-7e1tJPep.js";import"./BaseMangaGrid-CriSyofC.js";import"./MangaGrid-BWagROn7.js";import"./Download-BuLWcurX.js";import"./Sync-ChotsWgG.js";import"./use-merged-ref-C32hQvsh.js";import"./PlayArrow-D0_S3vcB.js";import"./useAppTitleAndAction-DEDczPo0.js";import"./Switch-DQaAdjP-.js";const ft=oe(e.jsx("path",{d:"M19.3 16.9c.4-.7.7-1.5.7-2.4 0-2.5-2-4.5-4.5-4.5S11 12 11 14.5s2 4.5 4.5 4.5c.9 0 1.7-.3 2.4-.7l3.2 3.2 1.4-1.4zm-3.8.1c-1.4 0-2.5-1.1-2.5-2.5s1.1-2.5 2.5-2.5 2.5 1.1 2.5 2.5-1.1 2.5-2.5 2.5M12 20v2C6.48 22 2 17.52 2 12S6.48 2 12 2c4.84 0 8.87 3.44 9.8 8h-2.07c-.64-2.46-2.4-4.47-4.73-5.41V5c0 1.1-.9 2-2 2h-2v2c0 .55-.45 1-1 1H8v2h2v3H9l-4.79-4.79C4.08 10.79 4 11.38 4 12c0 4.41 3.59 8 8 8"})),jt=a=>{const{t}=_(),{source:l,showSourceRepo:u}=a,{id:i,name:s,lang:o,iconUrl:n,supportsLatest:p,isNsfw:c,extension:{repo:g}}=l,{isPinned:f}=ot(l),h=k.isLocalSource(l)?t("source.local_source.title"):s,A=rt(l,b=>T(t("global.error.label.failed_to_save_changes"),"error",C(b)));return e.jsx($,{sx:{margin:1,marginTop:0},children:e.jsx(ye,{component:V,to:R.sources.childRoutes.browse.path(i),state:{contentType:Se.POPULAR,clearCache:!0},children:e.jsxs(X,{children:[e.jsx(ie,{iconUrl:S.getValidImgUrlFor(n),alt:h}),e.jsxs(W,{sx:{justifyContent:"center",flexGrow:1,flexShrink:1,wordBreak:"break-word"},children:[e.jsx(m,{variant:"h6",component:"h3",children:h}),e.jsxs(m,{variant:"caption",children:[B(o),c&&e.jsx(m,{variant:"caption",color:"error",children:" 18+"})]}),u&&e.jsx(m,{variant:"caption",children:g})]}),p&&e.jsx(q,{...Ee.preventRippleProp(),variant:"outlined",component:V,to:R.sources.childRoutes.browse.path(i),state:{contentType:Se.LATEST,clearCache:!0},children:t("global.button.latest")}),e.jsx(U,{title:t(f?"source.pin.remove":"source.pin.add"),children:e.jsx(M,{...Ee.preventRippleProp(),onClick:b=>{b.preventDefault(),A("isPinned",!f)},color:f?"primary":"inherit",children:f?e.jsx(Xe,{}):e.jsx($e,{})})})]})})})};function St(){const{t:a}=_(),[t,l]=Oe("shownSourceLangs",Re()),{settings:{showNsfw:u,lastUsedSourceId:i}}=re(),{data:s,loading:o,error:n,refetch:p}=S.useGetSourceList({notifyOnNetworkStatusChange:!0}),c=s==null?void 0:s.sources.nodes,g=d.useMemo(()=>k.filter(c!=null?c:[],{showNsfw:u,languages:t,keepLocalSource:!0}),[c,t]),f=d.useMemo(()=>{const x=k.getLastUsedSource(i,g),v=Object.entries(k.groupByLanguage(g));return x?[[Pe.LAST_USED_SOURCE,[x]],...v]:v},[g]),h=d.useMemo(()=>k.getLanguages(c!=null?c:[]),[c]),A=d.useMemo(()=>k.areFromMultipleRepos(g),[g]),b=ae();return Ie(e.jsxs(e.Fragment,{children:[e.jsx(U,{title:a("search.title.global_search"),children:e.jsx(M,{onClick:()=>b(R.sources.childRoutes.searchAll.path()),color:"inherit",children:e.jsx(ft,{})})}),e.jsx(_e,{selectedLanguages:t,setSelectedLanguages:l,languages:h})]}),[a,t,h]),o?e.jsx(K,{}):n?e.jsx(P,{message:a("global.error.label.failed_to_load_data"),messageExtra:C(n),retry:()=>p().catch(O())}):(c==null?void 0:c.length)===0?e.jsx(P,{message:a("source.error.label.no_sources_found")}):e.jsx(e.Fragment,{children:f.map(([x,v])=>e.jsxs(d.Fragment,{children:[e.jsx(m,{variant:"h5",component:"h2",sx:{paddingLeft:3,paddingTop:1,paddingBottom:2,fontWeight:"bold"},children:B(x)},x),v.map(L=>e.jsx(jt,{source:L,showSourceRepo:A},L.id))]},x))})}function Et(a){const{t}=_(),{extension:{name:l,lang:u,versionName:i,isInstalled:s,hasUpdate:o,isObsolete:n,pkgName:p,iconUrl:c,isNsfw:g,repo:f},handleUpdate:h,showOptions:A,showSourceRepo:b,forcedState:x}=a,[v,L]=d.useState(H(s,n,o)),y=x!=null?x:v;d.useEffect(()=>{L(H(s,n,o))},[H(s,n,o)]);const D=u==="all"?t("extension.language.all"):u.toUpperCase(),G=async I=>{const Q=Je[I],F=Ze[I];try{switch(L(F),I){case w.INSTALL:await S.updateExtension(p,{install:!0,isObsolete:n}).response;break;case w.UNINSTALL:await S.updateExtension(p,{uninstall:!0,isObsolete:n}).response;break;case w.UPDATE:await S.updateExtension(p,{update:!0,isObsolete:n}).response;break;default:throw new Error('Unexpected ExtensionAction "'.concat(I,'"'))}L(Q),h()}catch(Z){L(H(s,n,o)),T(t(Ae[I],{count:1}),"error",C(Z))}};function Y(){switch(y){case w.INSTALL:case w.UPDATE:case w.UNINSTALL:G(y).catch(O());break;case we.OBSOLETE:G(w.UNINSTALL).catch(O());break}}return e.jsx($,{children:e.jsxs(X,{children:[e.jsx(ie,{iconUrl:S.getValidImgUrlFor(c),alt:l}),e.jsxs(W,{sx:{justifyContent:"center",flexGrow:1,flexShrink:1,wordBreak:"break-word"},children:[e.jsx(m,{variant:"h6",component:"h3",children:l}),e.jsxs(m,{variant:"caption",children:[D," ",i,g&&e.jsx(m,{variant:"caption",color:"error",children:" 18+"})]}),b&&e.jsx(m,{variant:"caption",children:f})]}),s&&e.jsx(U,{title:t("settings.title"),children:e.jsx(M,{onClick:A,color:"inherit",children:e.jsx(Ce,{})})}),e.jsx(q,{variant:"outlined",sx:{color:y===Qe.OBSOLETE?"red":"inherit",flexShrink:0},onClick:()=>Y(),children:t(Ye[y])})]})})}function bt({extensionId:a,closeDialog:t}){const{t:l}=_(),u=ae(),{data:i,loading:s,error:o,refetch:n}=S.useGetSourceList({notifyOnNetworkStatusChange:!0});if(o)return e.jsx(ge,{open:!!a,onClose:t});const p=d.useMemo(()=>a?i==null?void 0:i.sources.nodes.filter(c=>c.extension.pkgName===a):[],[i==null?void 0:i.sources.nodes,a]);return e.jsxs(ge,{open:!!a,onClose:t,maxWidth:"md",fullWidth:!0,children:[e.jsx(Be,{children:l("extension.settings.dialog.title")}),e.jsxs(De,{children:[s&&e.jsx(K,{}),o&&e.jsx(P,{message:l("global.error.label.failed_to_load_data"),messageExtra:C(o),retry:()=>n().catch(O())}),!s&&!o&&e.jsx(ne,{children:p==null?void 0:p.map(c=>e.jsx(ce,{sx:{px:0},children:e.jsx($,{children:e.jsxs(X,{children:[e.jsx(m,{variant:"h6",component:"h3",sx:{flexGrow:1},children:B(k.getLanguage(c))}),c.isConfigurable&&e.jsx(U,{title:l("settings.title"),children:e.jsx(M,{onClick:()=>u(R.sources.childRoutes.configure.path(c.id)),color:"inherit",children:e.jsx(Ce,{})})})]})})},c.id))})]})]})}const Ct=0,vt=1,Lt=({groupName:a,isFirstItem:t,groupExtensionIds:l,isUpdateGroup:u,updatingExtensionIds:i,setUpdatingExtensionIds:s,handleExtensionUpdate:o})=>{const{t:n}=_();return e.jsxs(ut,{isFirstItem:t,sx:{flexDirection:"row",justifyContent:"space-between",alignItems:"center",pr:1},children:[e.jsx(m,{variant:"h5",component:"h2",children:B(a)}),u&&e.jsx(q,{disabled:!!i.length,variant:"contained",onClick:()=>{s(l),S.updateExtensions(l,{update:!0}).response.then(()=>o()).catch(p=>T(n(Ae[w.UPDATE],{count:l.length}),"error",C(p))).finally(()=>s([]))},children:n("extension.action.label.update_all")})]},a)};function Tt({tabsMenuHeight:a}){var xe,me;const{t}=_(),l=ae(),{pathname:u,search:i,state:s}=Ge(),o=s==null?void 0:s.selectedExtensionPkg,{data:n,loading:p,error:c,refetch:g}=S.useGetServerSettings({notifyOnNetworkStatusChange:!0}),[f,{data:h,loading:A,error:b}]=S.useExtensionListFetch(),{settings:{extensionLanguages:x,showNsfw:v}}=re(),L=ve(r=>T(t("global.error.label.failed_to_save_changes"),"error",C(r))),[y]=Le("query",Te),[D,G]=d.useState([]),[Y,I]=d.useState({}),Q=p||A,F=c!=null?c:b,Z=!!(n!=null&&n.settings.extensionRepos.length),Ne=((xe=n==null?void 0:n.settings.extensionRepos.length)!=null?xe:0)>1,E=(me=h==null?void 0:h.fetchExtensions)==null?void 0:me.extensions,le=d.useMemo(()=>et(E!=null?E:[]),[E]),ue=d.useMemo(()=>tt(E!=null?E:[],{selectedLanguages:x,showNsfw:v,query:y}),[E,x,v,y]),N=d.useMemo(()=>st(ue),[ue]),de=d.useMemo(()=>N.map(r=>r[vt].length),[N]),J=d.useMemo(()=>N.map(([,r])=>r).flat(1),[N]),ke=ct.useCreateGroupedComputeItemKey(de,d.useCallback(r=>N[r][Ct],[N]),d.useCallback(r=>J[r].pkgName,[J])),ee=d.useCallback(()=>I({}),[]),pe=r=>{l(u+i,{replace:!0,state:{selectedExtensionPkg:r}})},he=r=>{if(!r.name.toLowerCase().endsWith("apk")){T(t("global.error.label.invalid_file_type"),"error");return}T(t("extension.label.installing_file"),"info"),S.installExternalExtension(r).response.then(()=>{ee(),T(t("extension.label.installed_successfully"),"success")}).catch(j=>T(t("extension.label.installation_failed"),"error",C(j)))};return d.useEffect(()=>{f()},[Y]),Ie(e.jsxs(e.Fragment,{children:[e.jsx(Ke,{}),e.jsx(U,{title:t("extension.action.label.install_external"),children:e.jsx(M,{onClick:()=>{const r=document.createElement("input");r.style.display="none",r.type="file",r.onchange=()=>{var z;const j=(z=r.files)==null?void 0:z[0];j&&he(j)},document.documentElement.appendChild(r),r.click(),document.documentElement.removeChild(r)},color:"inherit",children:e.jsx(it,{})})}),e.jsx(_e,{selectedLanguages:x,setSelectedLanguages:r=>L("extensionLanguages",r),languages:le})]}),[t,x,le]),be("drop",async r=>{r.preventDefault();const j=await at(r);he(j[0])}),be("dragover",r=>{r.preventDefault()}),Q?e.jsx(K,{}):F?e.jsx(P,{message:t("global.error.label.failed_to_load_data"),messageExtra:C(F),retry:()=>{c&&g().catch(O()),b&&f().catch(O())}}):!(E!=null&&E.length)&&!Z?e.jsxs(W,{sx:{alignItems:"center",justifyContent:"center",rowGap:"10px",paddingTop:"20px"},children:[e.jsx(m,{children:t("extension.label.add_repository_info")}),e.jsx(q,{component:V,variant:"contained",to:R.settings.childRoutes.browse.path,children:t("settings.title")})]}):e.jsxs(e.Fragment,{children:[e.jsx(lt,{heightToSubtract:a,overscan:window.innerHeight*.5,groupCounts:de,groupContent:r=>{const[j,z]=N[r],Ue=j===nt.UPDATE_PENDING;return e.jsx(Lt,{groupName:j,isFirstItem:r===0,groupExtensionIds:z.map(Me=>Me.pkgName),isUpdateGroup:Ue,updatingExtensionIds:D,setUpdatingExtensionIds:G,handleExtensionUpdate:ee})},computeItemKey:ke,itemContent:r=>{const j=J[r];return e.jsx(ce,{children:e.jsx(Et,{extension:j,handleUpdate:ee,showSourceRepo:Ne,forcedState:D.includes(j.pkgName)?we.UPDATING:void 0,showOptions:()=>pe(j.pkgName)})})}}),e.jsx(bt,{extensionId:o,closeDialog:()=>pe(void 0)})]})}const _t=oe(e.jsx("path",{d:"M14.94 4.66h-4.72l2.36-2.36zm-4.69 14.71h4.66l-2.33 2.33zM6.1 6.27 1.6 17.73h1.84l.92-2.45h5.11l.92 2.45h1.84L7.74 6.27zm-1.13 7.37 1.94-5.18 1.94 5.18zm10.76 2.5h6.12v1.59h-8.53v-1.29l5.92-8.56h-5.88v-1.6h8.3v1.26z"})),wt=oe(e.jsx("path",{d:"M20 10V8h-4V4h-2v4h-4V4H8v4H4v2h4v4H4v2h4v4h2v-4h4v4h2v-4h4v-2h-4v-4zm-6 4h-4v-4h4z"})),At=({id:a,name:t,lang:l,iconUrl:u,mangaCount:i})=>{const{t:s}=_(),n=Number(a)===0?s("source.local_source.title"):t;return e.jsx($,{children:e.jsx(ye,{component:V,to:R.migrate.path(a),children:e.jsxs(X,{sx:{justifyContent:"space-between"},children:[e.jsxs(ne,{sx:{display:"flex",gap:1},children:[e.jsx(ie,{iconUrl:S.getValidImgUrlFor(u),alt:n}),e.jsxs(ne,{sx:{display:"flex",flexDirection:"column",justifyContent:"center"},children:[e.jsx(m,{variant:"h6",component:"h3",children:n}),e.jsx(m,{variant:"caption",sx:{display:"block"},children:B(l)})]})]}),e.jsx(mt,{sx:{borderRadius:1},size:"small",label:i})]})})})},yt=(a,{sortBy:t,sortOrder:l})=>{if(!a)return[];const u={};a.forEach(({sourceId:s,source:o})=>{var p;const n=(p=u[s])!=null?p:{id:s,name:s,lang:"unknown",iconUrl:null,mangaCount:0,...o};u[s]={...n,mangaCount:n.mangaCount+1}});const i=Object.values(u).toSorted((s,o)=>{switch(t){case fe.SOURCE_NAME:return s.name.localeCompare(o.name);case fe.MANGA_COUNT:return s.mangaCount-o.mangaCount;default:throw new Error('Unexpected "sortBy" "'.concat(t,'"'))}});switch(l){case je.ASC:return i;case je.DESC:return i.toReversed();default:throw new Error('Unexpected "sortOrder" "'.concat(l,'"'))}},It=({tabsMenuHeight:a})=>{const{t}=_(),{appBarHeight:l}=Fe(),{settings:{migrateSortSettings:u}}=re(),i=ve(h=>T(t("global.error.label.failed_to_save_changes"),"error",C(h))),{sortBy:s,sortOrder:o}=u,{data:n,loading:p,error:c,refetch:g}=S.useGetMigratableSources({notifyOnNetworkStatusChange:!0}),f=d.useMemo(()=>yt(n==null?void 0:n.mangas.nodes,u),[n==null?void 0:n.mangas.nodes,u]);return p?e.jsx(K,{}):c?e.jsx(P,{message:t("global.error.label.failed_to_load_data"),messageExtra:C(c),retry:()=>g().catch(O())}):e.jsxs(e.Fragment,{children:[e.jsxs(W,{sx:{position:"sticky",top:"".concat(l+a,"px"),flexDirection:"row",justifyContent:"end",alignItems:"center",gap:1,p:1,backgroundColor:"background.default",zIndex:1},children:[e.jsx(U,{title:t(ze[s]),children:e.jsx(M,{color:"inherit",onClick:()=>i("migrateSortSettings",{sortBy:(s+1)%2,sortOrder:o}),children:s?e.jsx(wt,{}):e.jsx(_t,{})})}),e.jsx(U,{title:t(He[o]),children:e.jsx(M,{color:"inherit",onClick:()=>i("migrateSortSettings",{sortBy:s,sortOrder:(o+1)%2}),children:o?e.jsx(ht,{}):e.jsx(xt,{})})})]}),e.jsx(Ve,{sx:{p:0},children:f.map(h=>e.jsx(ce,{children:e.jsx(At,{...h})},h.id))})]})};function Bs(){const{t:a}=_();gt(a("global.label.browse"));const t=d.useRef(null),[l,u]=d.useState(0);We(t,d.useCallback(()=>u(t.current.offsetHeight),[t.current]));const[i,s]=Le("tab",Te,{}),o=i!=null?i:"source";return i||s(o,"replaceIn"),e.jsxs(dt,{children:[e.jsxs(pt,{ref:t,sx:{zIndex:qe},variant:"fullWidth",value:o,onChange:(n,p)=>s(p,"replaceIn"),children:[e.jsx(te,{value:"source",sx:{textTransform:"none"},label:a("source.title_one")}),e.jsx(te,{value:"extensions",sx:{textTransform:"none"},label:a("extension.title_other")}),e.jsx(te,{value:"migrate",sx:{textTransform:"none"},label:a("migrate.title")})]}),e.jsx(se,{index:"source",currentIndex:o,children:e.jsx(St,{})}),e.jsx(se,{index:"extensions",currentIndex:o,children:e.jsx(Tt,{tabsMenuHeight:l})}),e.jsx(se,{index:"migrate",currentIndex:o,children:e.jsx(It,{tabsMenuHeight:l})})]})}export{Bs as Browse};
