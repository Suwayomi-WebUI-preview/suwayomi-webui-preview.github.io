import{u as w,r as m,f as k,j as e,a8 as y,aQ as P,a7 as A,v as L,bZ as M,o as E,ao as F,p as R,q as U,b7 as D,b_ as N,w as O,B as I,m as T,g as h,e as $,Y as q,k as _,i as B,M as v,s as S,F as G}from"./index-DxgalVhl.js";import{E as W}from"./EmptyViewAbsoluteCentered-CiljhVsh.js";import{T as g}from"./Trackers-Bgo8y--2.js";import{A as Q}from"./AvatarSpinner-DQrPuyJo.js";import{L as V}from"./ListItemAvatar-WT013XUZ.js";import{C as H}from"./Chip-9U4e8vhu.js";import{u as J}from"./useAppTitle-CAGOJfWZ.js";import{S as C}from"./Switch-B_TucHfS.js";import{L as K}from"./ListSubheader-DckEPLZ4.js";import"./SpinnerImage-CbDNXD3A.js";import"./Refresh-B0M8Zv3W.js";import"./SwitchBase-lxmYe8oS.js";const Y=({tracker:a})=>{const{t}=w(),[p,{loading:x}]=m.useLoginToTrackerCredentials(),[i]=m.useLogoutFromTracker(),[d,c]=k.useState(""),[o,b]=k.useState(""),n=!a.isLoggedIn&&!!a.authUrl,f=async()=>{try{await i({variables:{trackerId:a.id}})}catch(s){T(t("tracking.action.logout.label.failure",{name:a.name}),"error",h(s))}},u=async()=>{if(n){const s={redirectUrl:"".concat(window.location.origin,"/tracker/login/oauth"),clientName:"Suwayomi-WebUI",trackerId:a.id,trackerName:a.name};window.open("".concat(a.authUrl,"&state=").concat(JSON.stringify(s)),"_self");return}try{await p({variables:{input:{trackerId:a.id,username:d,password:o}}})}catch(s){T(t("tracking.action.login.label.failure",{name:a.name}),"error",h(s))}},j=s=>{if(!n){s();return}u()};return e.jsx(y,{variant:"popover",popupId:"tracker-dialog",children:s=>e.jsxs(e.Fragment,{children:[e.jsxs(P,{...A(s),onClick:()=>j(s.open),children:[e.jsx(V,{sx:{paddingRight:"20px"},children:e.jsx(Q,{alt:"".concat(a.name),iconUrl:m.getValidImgUrlFor(a.icon),slots:{avatarProps:{variant:"rounded",sx:{width:64,height:64}},spinnerImageProps:{ignoreQueue:!0}}})}),e.jsx(L,{primary:a.name}),g.isLoggedIn(a)&&e.jsx(M,{children:e.jsx(H,{label:t("global.label.logged_in"),color:"success"})})]}),e.jsxs(E,{...F(s),open:(g.isLoggedIn(a)||!a.authUrl)&&s.isOpen,disableRestoreFocus:!0,children:[e.jsx(R,{children:t(g.isLoggedIn(a)?"tracking.settings.dialog.title.log_out":"tracking.settings.dialog.title.log_in",{name:a.name})}),!n&&!a.isLoggedIn&&e.jsxs(U,{children:[e.jsx(D,{autoFocus:!0,margin:"dense",id:"username",name:"username",label:t("global.label.username"),type:"text",fullWidth:!0,variant:"standard",onChange:l=>c(l.target.value)}),e.jsx(N,{margin:"dense",fullWidth:!0,variant:"standard",onChange:l=>b(l.target.value)})]}),e.jsxs(O,{children:[e.jsx(I,{onClick:s.close,children:t("global.button.cancel")}),e.jsx(I,{variant:"contained",disabled:!n&&!a.isLoggedIn&&(x||!d.length||!o.length),onClick:()=>g.isLoggedIn(a)?f():u(),children:t(g.isLoggedIn(a)?"global.button.log_out":"global.button.log_in")})]})]})]})})},ge=()=>{var l;const{t:a}=w();J(a("tracking.title"));const{settings:{updateProgressAfterReading:t,updateProgressManualMarkRead:p},loading:x,request:{error:i,refetch:d}}=$(),c=G(r=>T(a("global.error.label.failed_to_save_changes"),"error",h(r))),{data:o,loading:b,error:n,refetch:f}=m.useGetTrackerList(q,{notifyOnNetworkStatusChange:!0}),u=(l=o==null?void 0:o.trackers.nodes)!=null?l:[],j=x||b,s=i!=null?i:n;return s?e.jsx(W,{message:a("global.error.label.failed_to_load_data"),messageExtra:h(s),retry:()=>{i&&d().catch(_()),n&&f().catch(_())}}):j?e.jsx(B,{}):e.jsxs(e.Fragment,{children:[e.jsxs(v,{sx:{pt:0},children:[e.jsxs(S,{children:[e.jsx(L,{primary:a("tracking.settings.label.update_progress_reading")}),e.jsx(C,{edge:"end",checked:t,onChange:r=>c("updateProgressAfterReading",r.target.checked)})]}),e.jsxs(S,{children:[e.jsx(L,{primary:a("tracking.settings.label.update_progress_manual"),secondary:a("tracking.settings.label.update_progress_reading_description")}),e.jsx(C,{edge:"end",checked:p,onChange:r=>c("updateProgressManualMarkRead",r.target.checked)})]})]}),e.jsx(v,{subheader:e.jsx(K,{component:"div",id:"tracking-trackers",children:a("tracking.settings.title.trackers")}),children:u.map(r=>e.jsx(Y,{tracker:r},r.id))})]})};export{ge as TrackingSettings};
