import{c as r,v as ye,j as t,B as F,aq as he,r as ce,i as le,J as nt,ar as Rt,as as Pt,at as yt,au as Et,av as Xe,C as de,u as at,k as bt,aw as Lt,e as st,ax as ot,ay as St,az as Dt,f as ne,I as ae,T as kt,aA as jt,a5 as Tt,aB as _t,a3 as Ue,aC as Ot,a6 as Nt,a as J,aD as At,aE as Ke,l as qe,N as It,m as Ye,M as $t,a8 as Mt,h as Q,aF as Ht,aG as Wt}from"./index-BAST9t1l.js";import{P as xe,R as zt,u as Bt,g as Ft}from"./ReaderSettingsOptions-aBJthYq2.js";import{S as Ze}from"./Select-C909GtU8.js";import{C as Vt}from"./CustomIconButton-B3MNOkCq.js";import{D as K,C as N}from"./Chapters-CxSG4Cn8.js";import{C as Gt}from"./Collapse-D5n6_q_K.js";import{a as Je}from"./TextField-DfOjhWY6.js";import{u as Xt}from"./useDebounce-DM99K4oZ.js";import{E as Qe}from"./EmptyViewAbsoluteCentered-eTvuLJZu.js";import"./NumberSetting-Caz9YUw5.js";import"./Info-A0LJOkLU.js";import"./InputAdornment-DrrbepB3.js";import"./SpinnerImage-B9jRXCFC.js";import"./Refresh--xs3oAbD.js";import"./Switch-D62vfRcd.js";import"./SwitchBase-6VUl4sRg.js";const Ut=s=>{for(let c=0;c<s.children.length;c++){const o=s.children.item(c);if(o){const{left:f,right:l}=o.getBoundingClientRect();if(f<=window.innerWidth/2&&l>window.innerWidth/2)return c}}return-1},Kt=5,qt=()=>window.innerWidth+window.scrollX>=document.body.scrollWidth-Kt,Yt=()=>window.scrollX<=0;function Zt(s){const{pages:c,curPage:o,initialPage:f,settings:l,setCurPage:p,prevChapter:L,nextChapter:y}=s,R=r.useRef(f),i=r.useRef(null),a=r.useRef([]);function _(){var e;o<c.length-1?((e=a.current[o+1])==null||e.scrollIntoView({inline:"center"}),p(u=>u+1)):l.loadNextOnEnding&&y()}function h(){var e;o>0?((e=a.current[o-1])==null||e.scrollIntoView({inline:"center"}),p(o-1)):o===0&&L()}function C(){l.readerType==="ContinuesHorizontalLTR"?h():_()}function k(){l.readerType==="ContinuesHorizontalLTR"?_():h()}const S=r.useRef(0);function x(e){window.scrollBy(S.current-e.pageX,0)}function n(e){var u;S.current=e.pageX,(u=i.current)==null||u.addEventListener("mousemove",x)}function d(){var e;(e=i.current)==null||e.removeEventListener("mousemove",x)}function E(e){e.clientX>=window.innerWidth*.85?k():e.clientX<=window.innerWidth*.15&&C()}function O(e){window.scrollBy({left:l.readerType==="ContinuesHorizontalLTR"?e.deltaY:e.deltaY*-1})}const m=()=>{l.readerType==="ContinuesHorizontalLTR"?window.scrollX+window.innerWidth>=document.body.scrollWidth&&y():l.readerType==="ContinuesHorizontalRTL"&&window.scrollX<=window.innerWidth&&y()};return ye(a.current[f],r.useCallback((e,u)=>{const P=a.current[f];P!=null&&P.offsetHeight&&(P.scrollIntoView({inline:"center"}),u.disconnect())},[a.current[f],f])),r.useEffect(()=>{var e,u;return(e=i.current)==null||e.addEventListener("mousedown",n),(u=i.current)==null||u.addEventListener("mouseup",d),()=>{var P,A;(P=i.current)==null||P.removeEventListener("mousedown",n),(A=i.current)==null||A.removeEventListener("mouseup",d)}},[i]),r.useEffect(()=>(l.loadNextOnEnding&&document.addEventListener("scroll",m),()=>{document.removeEventListener("scroll",m)}),[i,o,L,y]),r.useEffect(()=>{const e=()=>{if(!i.current)return;const u=Ut(i.current);u!==R.current&&(R.current=u,p(u)),(l.readerType==="ContinuesHorizontalLTR"?qt():Yt())&&(R.current=c.length-1,p(R.current))};return window.addEventListener("scroll",e),()=>window.removeEventListener("scroll",e)},[l.readerType]),t.jsx(F,{ref:i,sx:{display:"flex",flexDirection:l.readerType==="ContinuesHorizontalLTR"?"row":"row-reverse",justifyContent:l.readerType==="ContinuesHorizontalLTR"?"flex-start":"flex-end",width:"auto",height:"auto",overflowX:"visible",userSelect:"none"},onClick:E,onWheel:O,children:c.map(e=>t.jsx(xe,{index:e.index,src:e.src,onImageLoad:()=>{},settings:l,ref:u=>{a.current[e.index]=u},priority:e.index===o?he.HIGH:void 0},e.index))})}function Jt(s){const{settings:c,curPage:o,pageCount:f}=s;return t.jsx(F,{sx:{display:c.showPageNumber?"block":"none",position:"fixed",bottom:"50px",padding:"2px",paddingLeft:"4px",paddingRight:"4px",textAlign:"center",backgroundColor:"rgba(0, 0, 0, 0.3)",borderRadius:"10px"},children:"".concat(o+1," / ").concat(f)})}function Qt(s){const{pages:c,settings:o,setCurPage:f,initialPage:l,curPage:p,nextChapter:L,prevChapter:y}=s,R=r.useRef(null),i=x=>{f(x),window.scroll({top:0})};function a(){p<c.length-1?i(p+1):o.loadNextOnEnding&&L()}function _(){p>0?i(p-1):y()}function h(){o.readerType==="SingleLTR"?_():o.readerType==="SingleRTL"&&a()}function C(){o.readerType==="SingleLTR"?a():o.readerType==="SingleRTL"&&_()}function k(x){switch(x.key){case"Space":x.preventDefault(),a();break;case"ArrowRight":C();break;case"ArrowLeft":h();break}}function S(x){x.clientX>window.innerWidth/2?C():h()}return r.useEffect(()=>(document.addEventListener("keydown",k),()=>{document.removeEventListener("keydown",k)}),[R,p,o.readerType,y,L]),r.useEffect(()=>{setTimeout(()=>{i(l)},0)},[l]),t.jsx(F,{ref:R,sx:{display:"flex",flexDirection:"column",justifyContent:"center",width:"auto",height:"auto"},onClick:S,children:c.map(({index:x,src:n})=>t.jsx(xe,{index:x,onImageLoad:()=>{},src:n,settings:o,display:x===p,priority:x===p?he.HIGH:void 0},n))})}const er=s=>s.height/s.width<1;function tr(s){const{pages:c,settings:o,setCurPage:f,initialPage:l,curPage:p,nextChapter:L,prevChapter:y}=s,R=r.useRef(null),i=r.useRef([]),[a,_]=r.useState(Array(c.length).fill(!1)),[h,C]=r.useState(Array(c.length).fill(!1)),k=r.useMemo(()=>a.map((m,e)=>e+a.slice(0,e).filter(Boolean).length),[a]);function S(){const m=P=>f(P===-1?c.length-1:P);if(i.current[c.length-1]&&o.loadNextOnEnding){p===c.length-1||m(c.length-1),L();return}const u=i.current.findIndex((P,A)=>!P&&A>p);m(u)}function x(){const m=P=>f(Math.max(P,0));if(i.current[0]){!p||m(0),y();return}const u=[...i.current].slice(0,p).findLastIndex(P=>!P);m(u)}function n(){o.readerType==="DoubleLTR"?x():S()}function d(){o.readerType==="DoubleLTR"?S():x()}function E(m){switch(m.key){case"Space":m.preventDefault(),S();break;case"ArrowRight":d();break;case"ArrowLeft":n();break}}function O(m){m.clientX>window.innerWidth/2?d():n()}return r.useEffect(()=>(document.addEventListener("keydown",E),()=>{document.removeEventListener("keydown",E)}),[R,p,o.readerType,y,L,h,a]),r.useEffect(()=>{f(l)},[l]),t.jsx(F,{ref:R,onClick:O,children:t.jsx(F,{id:"display",sx:{display:"flex",flexDirection:o.readerType==="DoubleLTR"?"row":"row-reverse",justifyContent:"center",width:"auto",height:"auto"},children:c.map(({index:m,src:e})=>{const P=!(k[p]%2),A=(()=>{const g=o.offsetFirstPage?-1:1;return(P?1:-1)*g})(),I=p+A,B=p===0,X=m===p,$=m===I,v=a[p],b=a[I],M=v||b,H=B&&o.offsetFirstPage,G=X||$&&!M&&!H;return i.current[m]=G,t.jsx(xe,{index:m,src:e,onImageLoad:()=>{const g=new Image;g.onload=()=>{C(j=>j.toSpliced(m,1,!0)),_(j=>j.toSpliced(m,1,er(g)))},g.src=e},settings:o,display:G,priority:G?he.HIGH:void 0},e)})})})}const rr=s=>{for(let c=0;c<s.children.length;c++){const o=s.children.item(c);if(o){const{top:f,bottom:l}=o.getBoundingClientRect();if(f<=window.innerHeight&&l>1)return c}}return-1},nr=5,ar=.95,et=.25,sr="smooth",tt=()=>window.innerHeight+window.scrollY>=document.body.offsetHeight-nr,or=()=>window.scrollY<=0;function rt(s){const{curPage:c,pages:o,settings:f,setCurPage:l,initialPage:p,nextChapter:L,prevChapter:y}=s,R=r.useRef(p),i=r.useRef(null),a=r.useRef([]);r.useEffect(()=>{let n=!1;const d=()=>{if(i.current)if(tt()){if(n)return;n=!0,R.current=o.length-1,l(R.current),f.loadNextOnEnding&&L()}else{n=!1;const E=rr(i.current);E!==R.current&&(R.current=E,l(E))}};return window.addEventListener("scroll",d),()=>{window.removeEventListener("scroll",d)}},[f.loadNextOnEnding,L]);const _=r.useRef(0),h=r.useRef(!1);function C(n){h.current=!0,window.scrollBy(0,_.current-n.pageY)}function k(n){var d;_.current=n.pageY,(d=i.current)==null||d.addEventListener("mousemove",C)}function S(){var n;(n=i.current)==null||n.removeEventListener("mousemove",C)}r.useEffect(()=>{var n,d;return(n=i.current)==null||n.addEventListener("mousedown",k),(d=i.current)==null||d.addEventListener("mouseup",S),()=>{var E,O;(E=i.current)==null||E.removeEventListener("mousedown",k),(O=i.current)==null||O.removeEventListener("mouseup",S)}},[i]);const x=r.useCallback((n,d=ar)=>{if(n==="down"&&tt()){L();return}if(n==="up"&&or()){y();return}window.scroll({top:window.scrollY+window.innerHeight*d*(n==="up"?-1:1),behavior:sr})},[L,y]);return r.useEffect(()=>{const n=d=>{switch(d.key){case"Space":d.preventDefault(),x(d.shiftKey?"up":"down");break;case"ArrowDown":d.preventDefault(),x(d.shiftKey?"up":"down",et);break;case"ArrowRight":d.preventDefault(),x(d.shiftKey?"up":"down");break;case"ArrowUp":d.preventDefault(),x(d.shiftKey?"down":"up",et);break;case"ArrowLeft":d.preventDefault(),x(d.shiftKey?"down":"up");break}};return document.addEventListener("keydown",n,!1),()=>{document.removeEventListener("keydown",n)}},[x]),ye(a.current[p],r.useCallback((n,d)=>{const E=a.current[p];E!=null&&E.offsetHeight&&(E.scrollIntoView(),d.disconnect())},[a.current[p],p])),t.jsx(F,{ref:i,sx:{display:"flex",flexDirection:"column",justifyContent:"center",width:"auto",height:"auto",userSelect:"none"},onClick:n=>{if(h.current){h.current=!1;return}x(n.clientX>window.innerWidth/2?"down":"up")},children:o.map(n=>t.jsx(xe,{index:n.index,src:n.src,onImageLoad:()=>{},settings:f,ref:d=>{a.current[n.index]=d},priority:n.index===c?he.HIGH:void 0},n.index))})}var Ee={},ir=le;Object.defineProperty(Ee,"__esModule",{value:!0});var it=Ee.default=void 0,cr=ir(ce()),lr=t;it=Ee.default=(0,cr.default)((0,lr.jsx)("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Close");var be={},dr=le;Object.defineProperty(be,"__esModule",{value:!0});var oe=be.default=void 0,ur=dr(ce()),pr=t;oe=be.default=(0,ur.default)((0,pr.jsx)("path",{d:"M15.41 16.59 10.83 12l4.58-4.59L14 6l-6 6 6 6z"}),"KeyboardArrowLeft");var Le={},fr=le;Object.defineProperty(Le,"__esModule",{value:!0});var ie=Le.default=void 0,gr=fr(ce()),hr=t;ie=Le.default=(0,gr.default)((0,hr.jsx)("path",{d:"M8.59 16.59 13.17 12 8.59 7.41 10 6l6 6-6 6z"}),"KeyboardArrowRight");var Se={},xr=le;Object.defineProperty(Se,"__esModule",{value:!0});var ct=Se.default=void 0,mr=xr(ce()),Cr=t;ct=Se.default=(0,mr.default)((0,Cr.jsx)("path",{d:"M7.41 8.59 12 13.17l4.59-4.58L18 10l-6 6-6-6z"}),"KeyboardArrowDown");var De={},vr=le;Object.defineProperty(De,"__esModule",{value:!0});var lt=De.default=void 0,wr=vr(ce()),Rr=t;lt=De.default=(0,wr.default)((0,Rr.jsx)("path",{d:"M7.41 15.41 12 10.83l4.59 4.58L18 14l-6-6-6 6z"}),"KeyboardArrowUp");const Pr={entering:{transform:"none"},entered:{transform:"none"}},yr=r.forwardRef(function(c,o){const f=nt(),l={enter:f.transitions.duration.enteringScreen,exit:f.transitions.duration.leavingScreen},{addEndListener:p,appear:L=!0,children:y,easing:R,in:i,onEnter:a,onEntered:_,onEntering:h,onExit:C,onExited:k,onExiting:S,style:x,timeout:n=l,TransitionComponent:d=yt,...E}=c,O=r.useRef(null),m=Rt(O,Pt(y),o),e=v=>b=>{if(v){const M=O.current;b===void 0?v(M):v(M,b)}},u=e(h),P=e((v,b)=>{Et(v);const M=Xe({style:x,timeout:n,easing:R},{mode:"enter"});v.style.webkitTransition=f.transitions.create("transform",M),v.style.transition=f.transitions.create("transform",M),a&&a(v,b)}),A=e(_),I=e(S),B=e(v=>{const b=Xe({style:x,timeout:n,easing:R},{mode:"exit"});v.style.webkitTransition=f.transitions.create("transform",b),v.style.transition=f.transitions.create("transform",b),C&&C(v)}),X=e(k),$=v=>{p&&p(O.current,v)};return t.jsx(d,{appear:L,in:i,nodeRef:O,onEnter:P,onEntered:A,onEntering:u,onExit:B,onExited:X,onExiting:I,addEndListener:$,timeout:n,...E,children:(v,b)=>r.cloneElement(y,{style:{transform:"scale(0)",visibility:v==="exited"&&!i?"hidden":void 0,...Pr[v],...x,...y.props.style},ref:m,...b})})}),Er=de("div")({zIndex:10}),br=de("div")(({theme:s})=>({position:"fixed",top:0,left:0,minWidth:"240px",maxWidth:"400px",height:"100vh",overflowY:"auto",backgroundColor:s.palette.background.default,"& header":{backgroundColor:s.palette.action.hover,display:"flex",alignItems:"center",padding:"".concat(s.spacing(1)," ").concat(s.spacing(3)),transition:"left 2s ease"}})),Lr=de("div")(({theme:s})=>({margin:"0 ".concat(s.spacing(2))})),Sr=de("div")({display:"flex",flexWrap:"wrap",alignContent:"center",alignItems:"center",justifyContent:"center"}),Dr=de("div")(({theme:s})=>({display:"grid",gridTemplateRows:"auto auto auto",gridTemplateColumns:"0fr 1fr 0fr",gridTemplateAreas:'"pre current next"',gridColumnGap:s.spacing(.5),margin:"".concat(s.spacing(1)," 0"),"& a":{textDecoration:"none",color:"inherit",display:"flex",flexWrap:"wrap",alignContent:"center"}}));function kr(s){var G;const{t:c}=at(),{setReaderNavBarWidth:o}=bt(),f=nt(),l=Lt(),p=st(),L=ot(),{prevDrawerOpen:y,prevSettingsCollapseOpen:R}=(G=L.state)!=null?G:{},i=r.useRef(null);ye(i,r.useCallback(()=>{var g;((g=i.current)==null?void 0:g.offsetWidth)!==void 0&&o(i.current.offsetWidth)},[i.current])),r.useLayoutEffect(()=>()=>o(0),[i]);const{settings:a,setSettingValue:_,manga:h,chapter:C,chapters:k,curPage:S,scrollToPage:x,openNextChapter:n,retrievingNextChapter:d}=s,E=St(),O=r.useMemo(()=>new Set(k.map(({scanlator:g})=>g)).size>1,[k]),[m,e]=r.useState(a.staticNav||y),[u,P]=r.useState(!0),[A,I]=r.useState(a.staticNav||y),[B,X]=r.useState(0),[$,v]=r.useState(R!=null?R:!0),b=d,M=(g,j,te)=>{P(g!=="staticNav"),_(g,j,te)},H=g=>{e(g),I(g)},V=()=>{const g=window.pageYOffset;Math.abs(g-B)>20&&(I(g>B),X(g))};return r.useEffect(()=>{u&&H(a.staticNav)},[a.staticNav]),r.useEffect(()=>{window.addEventListener("scroll",V);const g=document.querySelector("#root"),j=document.querySelector("#appMainContainer");return g.style.display="flex",g.style.flexDirection="column",j.style.display="none",()=>{g.style.display="block",j.style.display="block",window.removeEventListener("scroll",V)}},[V]),t.jsxs(Er,{children:[t.jsx(Dt,{direction:l("right","left"),in:m,timeout:200,appear:!1,mountOnEnter:!0,unmountOnExit:!0,children:t.jsxs(br,{ref:i,children:[t.jsxs("header",{children:[!a.staticNav&&t.jsx(ne,{title:c("reader.button.close_menu"),children:t.jsx(ae,{edge:"start",color:"inherit","aria-label":"menu",onClick:()=>H(!1),size:"large",children:l(t.jsx(oe,{}),t.jsx(ie,{}))})}),t.jsx(kt,{variant:"h6",component:"h1",sx:{textOverflow:"ellipsis",overflow:"hidden",py:1,flexGrow:1},children:C.name}),t.jsx(ne,{title:c("reader.button.exit"),children:t.jsx(ae,{edge:"start",color:"inherit","aria-label":"menu",onClick:E,size:"large",sx:{mr:-1},children:t.jsx(it,{})})})]}),t.jsxs(jt,{ContainerComponent:"div",sx:{"& span":{fontWeight:"bold"}},children:[t.jsx(Tt,{primary:c("reader.settings.title.reader_settings")}),t.jsxs(ae,{edge:"start",color:"inherit","aria-label":"menu",disableRipple:!0,disableFocusRipple:!0,onClick:()=>v(!$),size:"large",children:[$&&t.jsx(lt,{}),!$&&t.jsx(ct,{})]})]}),t.jsx(Gt,{in:$,timeout:"auto",unmountOnExit:!0,children:t.jsx(zt,{setSettingValue:M,staticNav:a.staticNav,showPageNumber:a.showPageNumber,loadNextOnEnding:a.loadNextOnEnding,skipDupChapters:a.skipDupChapters,fitPageToWindow:a.fitPageToWindow,scalePage:a.scalePage,readerType:a.readerType,offsetFirstPage:a.offsetFirstPage,readerWidth:a.readerWidth})}),t.jsx(_t,{sx:{my:1,mx:2}}),t.jsxs(Lr,{children:[t.jsxs(Sr,{children:[t.jsx("span",{children:c("reader.page_info.label.currently_on_page")}),t.jsx(Je,{size:"small",sx:{mx:.5},disabled:b||C.pageCount===-1,children:t.jsx(Ze,{value:C.pageCount>-1?"".concat(S):"",displayEmpty:!0,onChange:({target:{value:g}})=>{x(Number(g))},children:Array(Math.max(0,C.pageCount)).fill(1).map((g,j)=>t.jsx(Ue,{value:j,children:j+1},"Page#".concat(j)))})}),t.jsx("span",{children:c("reader.page_info.label.of_max_pages",{maxPages:C.pageCount})})]}),t.jsxs(Dr,{children:[t.jsx(ne,{title:c("reader.button.previous_chapter"),children:t.jsx(ae,{sx:{gridArea:"pre"},disabled:b||C.sourceOrder<=1,onClick:()=>n(K.PREVIOUS),children:l(t.jsx(oe,{}),t.jsx(ie,{}))})}),t.jsx(Je,{sx:{gridArea:"current"},size:"small",disabled:b||C.sourceOrder<1,children:t.jsx(Ze,{value:C.sourceOrder>=1?"".concat(C.sourceOrder):"",displayEmpty:!0,onChange:({target:{value:g}})=>{p("/manga/".concat(h.id,"/chapter/").concat(g),{replace:!0,state:{prevDrawerOpen:m,prevSettingsCollapseOpen:$}})},children:k.map(({id:g,sourceOrder:j,name:te,chapterNumber:ue,scanlator:re})=>t.jsx(Ue,{value:j,children:"#".concat(ue).concat(O&&re!=null?" (".concat(re,")"):""," | ").concat(te)},g))})}),t.jsx(ne,{title:c("reader.button.next_chapter"),children:t.jsx(ae,{sx:{gridArea:"next"},disabled:b||C.sourceOrder<1||C.sourceOrder>=h.chapters.totalCount,onClick:()=>n(K.NEXT),children:l(t.jsx(ie,{}),t.jsx(oe,{}))})})]})]})]})}),t.jsx(yr,{in:!m,children:t.jsx(Ot,{in:!A,children:t.jsx(ne,{title:c("reader.button.open_menu"),children:t.jsx(Vt,{sx:{position:"fixed",top:20,left:20,backgroundColor:"rgba(255, 255, 255, 0.75);",color:"black",...f.applyStyles("dark",{backgroundColor:"rgba(0, 0, 0, 0.75);",color:"white"})},size:"large",variant:"contained",onClick:()=>H(!0),children:l(t.jsx(ie,{}),t.jsx(oe,{}))})})})})]})}const se=s=>N.getFromCache(s,Ht,"CHAPTER_READER_FIELDS"),jr=s=>{switch(s){case"ContinuesVertical":case"Webtoon":return rt;case"SingleVertical":case"SingleRTL":case"SingleLTR":return Qt;case"DoubleVertical":case"DoubleRTL":case"DoubleLTR":return tr;case"ContinuesHorizontalLTR":case"ContinuesHorizontalRTL":return Zt;default:return rt}},Tr=s=>Array.from({length:s},(c,o)=>o),ee={pageCount:-1,sourceOrder:-1,chapterCount:0,lastPageRead:0,name:"Loading...",manga:{id:-1}};function qr(){var $e,Me,He,We,ze,Be,Fe,Ve;const{t:s}=at(),c=st(),o=ot(),{chapterIndex:f,mangaId:l}=Nt(),p=r.useMemo(()=>({id:+l,title:"",thumbnailUrl:"",genre:[],inLibraryAt:0,lastReadAt:0,chapters:{totalCount:0},trackRecords:{totalCount:0}}),[l]),{data:L,loading:y,error:R,refetch:i}=J.useGetManga(At,l),a=r.useRef(null),_=Number(l)===(($e=a.current)==null?void 0:$e.mangaId)&&Number(f)===((Me=a.current)==null?void 0:Me.sourceOrder)&&((He=a.current)==null?void 0:He.pageCount)!==-1,h=(We=L==null?void 0:L.manga)!=null?We:p,{data:C,loading:k,error:S,refetch:x}=J.useGetChapters(Ke,{condition:{mangaId:Number(l),sourceOrder:Number(f)}},{notifyOnNetworkStatusChange:!0}),n=C==null?void 0:C.chapters.nodes[0],d=r.useRef(!1),{settings:{downloadAheadLimit:E}}=qe(),O=!!E,m=()=>{var z;return a.current&&_?n&&((z=a.current)==null?void 0:z.pageCount)!==n.pageCount?n:a.current:(d.current=!1,n||null)};a.current=m();const e=(ze=a.current)!=null?ze:ee,u=r.useRef(ee);u.current===ee&&(u.current=e),e.mangaId!==((Be=u.current)==null?void 0:Be.mangaId)&&(u.current=ee);const[P,{loading:A,error:I}]=J.useGetChapterPagesFetch(e.id),B=()=>{k||P().then(()=>{d.current=!0}).catch(Q())};r.useEffect(()=>{B()},[e.id]);const[X,$]=r.useState(!1),[v,b]=r.useState(0),M=v===e.pageCount-1,H=Xt(v,M?0:1e3),[V,G]=r.useState(void 0),{setOverride:g,setTitle:j,readerNavBarWidth:te}=r.useContext(It),[ue,re]=r.useState(!1),{data:me,loading:dt,error:ke,refetch:ut}=J.useGetMangaChapters(Ke,l,{nextFetchPolicy:"standby"}),w=me==null?void 0:me.chapters.nodes,Ce=y||k||dt||A||!d.current&&!S&&!I,je=(Ve=(Fe=R!=null?R:S)!=null?Fe:ke)!=null?Ve:I,{settings:Te,loading:_e}=Bt(),[D,Oe]=r.useState(Te),{settings:pe}=qe(),Ne=r.useMemo(()=>D.skipDupChapters?N.removeDuplicates(u.current,w!=null?w:[]):w!=null?w:[],[u.current,w,D.skipDupChapters]),pt=r.useMemo(()=>N.getNextChapters(e,w!=null?w:[],{offset:K.PREVIOUS,skipDupe:D.skipDupChapters,skipDupeChapter:u.current}),[e,u.current,w,D.skipDupChapters]),ft=r.useMemo(()=>N.getNextChapters(e,w!=null?w:[],{skipDupe:D.skipDupChapters,skipDupeChapter:u.current}),[e,u.current,w,D.skipDupChapters]),fe=r.useMemo(()=>N.getNextChapter(e,w!=null?w:[],{offset:K.PREVIOUS,skipDupe:D.skipDupChapters,skipDupeChapter:u.current}),[e,u.current,w,D.skipDupChapters]),q=r.useMemo(()=>N.getNextChapter(e,w!=null?w:[],{skipDupe:D.skipDupChapters,skipDupeChapter:u.current}),[e,u.current,w,D.skipDupChapters]),Ae=T=>{if(e===ee)return;const W=()=>{if(!(!!T.isRead&&!!pe.deleteChaptersWhileReading)||!w)return[];const Z=[e,...pt][pe.deleteChaptersWhileReading-1];if(!Z)return[];const we=se(Z.id);return we.isRead&&N.isDeletable(we,pe.deleteChaptersWithBookmark)?D.skipDupChapters?N.getIds(N.addDuplicates([Z],w)):N.getIds([Z]):[]};(()=>{var Re;const ge=se(e.id),Z=((Re=T.lastPageRead)!=null?Re:0)/e.pageCount>.25;if(O&&h.inLibrary&&!!(ge!=null&&ge.isDownloaded)&&Z){const Pe=q?se(q.id):null;if(!(Pe!=null&&Pe.isDownloaded))return;const Ge=N.getNonRead(ft).map(U=>se(U.id)).slice(-E).filter(U=>!U.isDownloaded).map(U=>U.id).filter(U=>!N.isDownloading(U));if(!Ge.length)return;N.download(Ge).catch(Q())}})();const ve=D.skipDupChapters?N.getIds(N.addDuplicates([e],w!=null?w:[e])):[e.id];J.updateChapters(ve,{...T,chapterIdsToDelete:W(),trackProgressMangaId:pe.updateProgressAfterReading&&T.isRead&&h.trackRecords.totalCount?h.id:void 0},{errorPolicy:"all"}).response.catch(Q())},gt=(T,W,z=!0)=>{Oe({...D,[T]:W}),z&&Wt(h,[[T,W]]).catch(()=>Ye(s("reader.settings.error.label.failed_to_save_settings"),"warning"))},Y=r.useCallback(T=>{const W=T===K.NEXT,z=W?q:fe;if(!z){Ye(s(W?"reader.error.label.next_chapter_does_not_exist":"reader.error.label.prev_chapter_does_not_exist"),"error");return}re(!0),b(0),c("/manga/".concat(h.id,"/chapter/").concat(z.sourceOrder),{replace:!0,state:o.state}),re(!1)},[h.id,fe==null?void 0:fe.id,q==null?void 0:q.id]);r.useEffect(()=>{if(Ce||!e){b(0);return}$(!0),e.lastPageRead===e.pageCount-1?b(0):b(e.lastPageRead)},[e,Ce]),r.useLayoutEffect(()=>{!(h!=null&&h.title)||e.name===s("global.label.loading")?j(s("reader.title")):j("".concat(h.title,": ").concat(e.name))},[s,h,e]),r.useEffect(()=>{!_e&&!y&&Oe(Ft(h,Te))},[_e,y]),r.useLayoutEffect(()=>(g({status:!0,value:t.jsx(kr,{settings:D,setSettingValue:gt,manga:h,chapter:e,chapters:Ne,curPage:v,scrollToPage:G,openNextChapter:Y,retrievingNextChapter:ue})}),()=>g({status:!1,value:t.jsx("div",{})})),[h,e,D,v,f,ue,Y,Ne]),r.useEffect(()=>{if(!X||e===ee)return;const T=se(e.id);if(H===(T==null?void 0:T.lastPageRead))return;const W=H!==-1,z=H===e.pageCount-1;(W||z)&&Ae({lastPageRead:W?H:void 0,isRead:z?!0:void 0})},[H,O]);const ht=r.useCallback(()=>{Ae({lastPageRead:e.pageCount-1,isRead:!0}),Y(K.NEXT)},[e.pageCount,Y,e,h]),xt=r.useCallback(()=>{Y(K.PREVIOUS)},[Y]),mt=$t.useGetScrollbarSize("height");if(Ce)return t.jsx(F,{sx:{height:"100vh",width:"100vw",display:"grid",placeItems:"center"},children:t.jsx(Mt,{thickness:5})});if(je)return t.jsx(Qe,{message:s("global.error.label.failed_to_load_data"),messageExtra:je.message,retry:()=>{R&&i().catch(Q()),S&&x().catch(Q()),ke&&ut().catch(Q()),I&&B()}});if(!e.pageCount)return t.jsx(Qe,{message:s("reader.error.label.no_pages_found"),retry:B});const Ct=Tr(e.pageCount).map(T=>({index:T,src:J.getChapterPageUrl(l,f,T)})),vt=jr(D.readerType),wt=V!=null?V:e.lastPageRead===e.pageCount-1?0:e.lastPageRead,Ie=D.staticNav?te:0;return t.jsxs(F,{sx:{display:"flex",flexDirection:"column",alignContent:"center",alignItems:"center",justifyContent:"center",minWidth:"calc((100vw - (100vw - 100%)) - ".concat(Ie,"px)"),minHeight:"calc(100vh - ".concat(mt,"px)"),marginLeft:"".concat(Ie,"px")},children:[t.jsx(Jt,{settings:D,curPage:v,pageCount:e.pageCount}),t.jsx(F,{sx:{alignSelf:"stretch"},children:t.jsx(vt,{pages:Ct,pageCount:e.pageCount,setCurPage:b,initialPage:wt,curPage:v,settings:D,manga:h,chapter:e,nextChapter:ht,prevChapter:xt},e.id)})]})}export{qr as Reader};
