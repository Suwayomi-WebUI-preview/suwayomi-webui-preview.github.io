import{c as A,j as e,f as j,u as E,R as y,U as u,r as s,m as q,g as v,k as z,G as _,A as B,L as F,I as C,C as b,i as K}from"./index-LuRfpAul.js";import{P as G}from"./PlayArrow-YllcmED0.js";import{D as W,a as N,b as J,c as X,S as Y,v as Z,d as $,e as ee}from"./DragHandle-BhH3nQcY.js";import{E as M}from"./EmptyViewAbsoluteCentered-CG8OzJNr.js";import{D as te}from"./Delete-C39Fxflk.js";import{C as oe}from"./ChapterDownloadRetryButton-BxZDL7Ro.js";import{C as re,D as se}from"./ChapterCardMetadata-D7k-4mLD.js";import{M as P}from"./MUI.util-CEodEA2f.js";import{L as ae}from"./ListCardContent-BNA9FzJm.js";import{C as ne}from"./Card-Cn142Txi.js";import{C as ie}from"./CardActionArea-CfK54VWb.js";import{u as le}from"./useAppTitle-BLkwhwB5.js";import{u as de}from"./useAppAction-DDskQL_S.js";import{V as ce}from"./VirtuosoPersisted-C_94Q6OJ.js";import{u as pe}from"./use-window-event-XQM-znuG.js";import"./Refresh-D4vYYVyG.js";import"./Chapters-BRAm19f6.js";import"./DateHelper-BCdsAYO-.js";import"./Asserts-DNMCi6ar.js";import"./index-DSrzPTbQ.js";import"./Virtuoso.util-BNN2EJ6V.js";import"./use-merged-ref-DTm_2N0b.js";const ue=A(e.jsx("path",{d:"M6 19h4V5H6zm8-14v14h4V5z"})),me=A(e.jsx("path",{d:"M15 16h4v2h-4zm0-8h7v2h-7zm0 4h6v2h-6zM3 18c0 1.1.9 2 2 2h6c1.1 0 2-.9 2-2V8H3zM14 5h-3l-1-1H6L5 5H2v2h12z"})),R=j.memo(({item:o,status:m})=>{const{t:h}=E(),c=y.usePreventMobileContextMenu(),w=j.useCallback(async a=>{const x=m===u.Started;try{x&&await s.stopDownloads().response,await Promise.all([s.removeChapterFromDownloadQueue(a.id).response,s.deleteDownloadedChapter(a.id).response])}catch(n){q(h("download.queue.error.label.failed_to_remove"),"error",v(n))}x&&s.startDownloads().response.catch(z())},[m]);return e.jsx(_,{sx:{p:1,pb:0},children:e.jsx(ne,{children:e.jsx(ie,{component:F,to:B.manga.path(o.manga.id),onContextMenu:c,sx:y.preventMobileContextMenuSx(),children:e.jsxs(ae,{children:[e.jsx(C,{...P.preventRippleProp(),sx:{pointerEvents:"none"},children:e.jsx(W,{})}),e.jsx(re,{title:o.manga.title,secondaryText:o.chapter.name}),e.jsx(se,{chapterId:o.chapter.id}),e.jsx(oe,{chapterId:o.chapter.id}),e.jsx(b,{title:h("chapter.action.download.delete.label.action"),children:e.jsx(C,{...P.preventRippleProp(),onClick:a=>{a.preventDefault(),a.stopPropagation(),w(o.chapter)},children:e.jsx(te,{})})})]})})})})}),Le=()=>{var S,I;const{t:o}=E();le(o("download.title.queue"));const[m,{reset:h}]=s.useReorderChapterInDownloadQueue(),{data:c,loading:w,error:a,refetch:x}=s.useGetDownloadStatus({notifyOnNetworkStatusChange:!0}),n=c==null?void 0:c.downloadStatus,r=(S=n==null?void 0:n.queue)!=null?S:[],d=(I=n==null?void 0:n.state)!=null?I:u.Started,g=!r.length,k=j.useMemo(()=>r.map(t=>t.chapter),[r]),L=N.useSensorsForDevice(),[p,f]=j.useState(null),Q=async()=>{try{await s.clearDownloads().response}catch(t){q(o("download.queue.error.label.failed_delete_all"),"error",v(t))}},H=()=>{d===u.Stopped?s.startDownloads():s.stopDownloads()},V=(t,i,l)=>{i!==l&&m({variables:{input:{chapterId:t[i].chapter.id,to:l}}}).catch(()=>{h()})},T=t=>{const{active:i,over:l}=t;if(f(null),!l||i.id===l.id)return;const O=r.findIndex(D=>D.chapter.id===i.id),U=r.findIndex(D=>D.chapter.id===l.id);V(r,O,U)};return de(e.jsxs(e.Fragment,{children:[e.jsx(b,{title:o("download.queue.label.delete_all"),children:e.jsx(C,{onClick:Q,color:"inherit",children:e.jsx(me,{})})}),e.jsx(b,{title:o(d===u.Started?"global.button.stop":"global.button.start"),disabled:g,children:e.jsx(C,{onClick:H,disabled:g,color:"inherit",children:d===u.Stopped?e.jsx(G,{}):e.jsx(ue,{})})})]}),[d,g]),pe("error",t=>{(t.message==="ResizeObserver loop completed with undelivered notifications."||t.message==="ResizeObserver loop limit exceeded")&&t.stopImmediatePropagation()}),w?e.jsx(K,{}):a?e.jsx(M,{message:o("global.error.label.failed_to_load_data"),messageExtra:v(a),retry:()=>x().catch(z())}):g?e.jsx(M,{message:o("download.queue.label.no_downloads")}):e.jsx(_,{sx:{pb:1},children:e.jsxs(J,{sensors:L,collisionDetection:X,onDragStart:t=>{var i;return f((i=r.find(l=>l.chapter.id===t.active.id))!=null?i:null)},onDragEnd:T,onDragCancel:()=>f(null),onDragAbort:()=>f(null),children:[e.jsx(Y,{items:k,strategy:Z,children:e.jsx(ce,{persistKey:"download-queue",useWindowScroll:!0,overscan:window.innerHeight*.5,totalCount:r.length,computeItemKey:t=>r[t].chapter.id,itemContent:t=>e.jsx($,{id:r[t].chapter.id,isDragging:r[t].chapter.id===(p==null?void 0:p.chapter.id),children:e.jsx(R,{item:r[t],status:d})})})}),e.jsx(ee,{isActive:!!p,children:e.jsx(R,{item:p,status:d})})]})})};export{Le as DownloadQueue};
