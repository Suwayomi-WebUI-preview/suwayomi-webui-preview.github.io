import{cY as B,cZ as _,c_ as R,c$ as de,bP as q,cF as je,d0 as $,d1 as K,cG as P,d2 as z,u as v,a6 as ce,j as s,b as S,aC as y,d3 as U,C as ue,I as me,au as Ce,T as pe,B as G,aw as W,f as Y,aY as be,aq as De,ar as Me,d4 as Ae,ap as Pe,d5 as ye,r as ne,i as Ue,g as se,k as Ge,d6 as ve,m as we}from"./index-BgB0VFLg.js";import{E as Oe}from"./EmptyViewAbsoluteCentered-Vg9lU-2R.js";import{a as Ne}from"./Asserts-xItX73wb.js";import{u as Le}from"./useAppTitle-qbL2AfZs.js";import{D as xe}from"./Delete-FxAMWtod.js";import{S as Re}from"./Select-DZqntND_.js";import{u as ke}from"./use-resize-observer-D5570bJF.js";let _e=0;const b=e=>e.replace(R,""),k=e=>b(e.toLowerCase().trim())===B,ge=(e,t,n)=>{var i;return(i=n==null?void 0:n.slice(0,t).some(({name:l})=>l===e))!=null?i:!1},ie=e=>{var t;return(t=e==null?void 0:e.some((n,i)=>ge(n.name,i,e)))!=null?t:!1},he=(e,t,n)=>n.slice(0,t).some(i=>i.mimeType===e),w=e=>e!==""&&!!e.match(/^https?:\/\/.+/),Z=(e,t,n)=>e==null||e>=t&&e<=n,Se=e=>Z(e?P(e).seconds.inWholeSeconds:null,K.min,K.max),Te=e=>Z(e?P(e).seconds.inWholeSeconds:null,z.min,z.max),Ie=e=>Z(e,$.min,$.max),Ve=(e,t)=>e===""&&t==="",Fe=(e,t,n)=>k(n)&&!e?!1:t===_.URL&&!w(e),$e=e=>e.some(({mimeType:t,compressionLevel:n,target:i,callTimeout:l,connectTimeout:o,headers:c,searchParams:u,mode:r},d)=>Ve(t,i)||Fe(i,r,t)||!Ie(n)||!Se(l)||!Te(o)||he(t,d,e)||ie(c)||ie(u)),Ke=e=>{const t=b(e);return t===de?_.DISABLED:w(t)?_.URL:_.IMAGE},ze=e=>{var n;const t=q.asUrl(e);return[...((n=t==null?void 0:t.searchParams)!=null?n:[]).entries()].map(([i,l])=>{var o;return{name:String(i),value:(o=je(l))!=null?o:l}})},L=e=>e.map(t=>{var n;return{id:(n=t.id)!=null?n:_e++,...t}}),V=e=>e.map(t=>{var n;return{id:(n=t.id)!=null?n:_e++,...t,mode:Ke(b(t.target)),headers:t.headers?L(t.headers):null,searchParams:L(ze(t.target))}}),We=(e,t)=>{var o,c;const n=q.asUrl(e),l=[...(c=(o=n==null?void 0:n.searchParams)==null?void 0:o.entries())!=null?c:[]].map(([u,r])=>({name:u,value:r})).map(u=>{const r=t==null?void 0:t.find(({name:d})=>d===u.name);return{id:r==null?void 0:r.id,...u}});return L(l)},le=e=>e.map(t=>({...t,mimeType:b(t.mimeType),target:b(t.target)})),Ye=e=>k(e)?B:"".concat(R).concat(e),Be=e=>e.filter(({mimeType:t,target:n})=>!!t&&!!n).map(({id:t,mode:n,searchParams:i,...l})=>{var o,c;return{...l,mimeType:Ye(l.mimeType),target:w(l.target)?l.target:"".concat(R).concat(l.target),headers:(c=(o=l.headers)==null?void 0:o.map(({id:u,...r})=>r))!=null?c:null}}),F=e=>[...e.some(({mimeType:n})=>k(n))?[]:[{id:-1,mode:_.IMAGE,mimeType:B,target:"",compressionLevel:null,headers:null,callTimeout:null,connectTimeout:null}],...e],ae=e=>e==null?void 0:e.filter(({name:t})=>t!==""),qe=(e,t)=>e.length!==t.length?!0:e.some(({mimeType:n,target:i,compressionLevel:l,callTimeout:o,connectTimeout:c,headers:u},r)=>{var E,j;const d=t[r],p=ae(u),a=ae(d.headers);return b(n)!==d.mimeType||b(i)!==d.target||l!==d.compressionLevel||o!==d.callTimeout||c!==d.connectTimeout||((E=p==null?void 0:p.length)!=null?E:0)!==((j=a==null?void 0:a.length)!=null?j:0)||!!(p!=null&&p.some((D,C)=>{var h,T;return D.name!==((h=a==null?void 0:a[C])==null?void 0:h.name)||D.value!==((T=a==null?void 0:a[C])==null?void 0:T.value)}))}),Ze=({id:e,name:t,value:n,onChange:i,isDuplicate:l})=>{const{i18n:o,_:c}=v(),u=ce();return s.jsxs(S,{sx:{gap:1,flexDirection:"row",flexWrap:"nowrap",alignItems:"center"},children:[s.jsxs(S,{sx:{flexDirection:"row",gap:2,[u.breakpoints.down("md")]:{flexDirection:"column",width:"100%"}},children:[s.jsx(y,{autoFocus:!0,sx:{width:U},label:o._({id:"6YtxFj"}),value:t,error:l,helperText:l&&o._({id:"UeOiKl"}),onChange:r=>i({id:e,name:r.target.value,value:n})}),s.jsx(y,{sx:{width:U},label:o._({id:"wMHvYH"}),value:n,onChange:r=>i({id:e,name:t,value:r.target.value})})]}),s.jsx(ue,{disabled:!1,title:o._({id:"cnGeoo"}),children:s.jsx(me,{onClick:()=>{i(null)},children:s.jsx(xe,{})})})]})},oe=({title:e,open:t,items:n,onChange:i})=>{const{i18n:l,_:o}=v();return s.jsx(Ce,{in:t,children:s.jsxs(S,{sx:{justifyContent:"start",gap:2,pt:2},children:[s.jsx(pe,{children:e}),n==null?void 0:n.map((c,u)=>s.jsx(Ze,{...c,isDuplicate:ge(c.name,u,n),onChange:r=>{if(r==null){i(n==null?void 0:n.toSpliced(u,1));return}i((n!=null?n:[]).toSpliced(u,1,r))}},c.id)),s.jsx(G,{onClick:()=>i([...n!=null?n:[],...L([{name:"",value:""}])]),variant:"contained",sx:{width:"fit-content"},children:l._({id:"m16xKo"})})]})})},re=({shouldAutoFocus:e,isDefault:t,isDuplicate:n,label:i,value:l,onUpdate:o,mode:c})=>{const{i18n:u,_:r}=v(),d=c===_.IMAGE,p=!l.length||w(l),a=!n&&(d||p);return s.jsx(y,{sx:{width:U},autoFocus:e,label:i,value:l,disabled:t,error:!a,helperText:!a&&u._({id:"UeOiKl"}),slotProps:{input:{startAdornment:s.jsx(W,{position:"start",children:d?R:null})}},onChange:E=>o(E.target.value.trim())})},Xe=({conversion:e,conversion:{mode:t,mimeType:n,target:i,compressionLevel:l,headers:o,searchParams:c,callTimeout:u,connectTimeout:r},onChange:d,isDuplicate:p})=>{const{i18n:a,_:E}=v(),j=ce(),{ref:D,height:C}=ke(),[h,T]=Y.useState(!0),[x,I]=Y.useState(!0),M=t===_.DISABLED,O=t===_.IMAGE,f=t===_.URL,N=Se(u),X=Te(r),Q=Ie(l),J=k(n)&&!p,H=J&&!i&&l==null;return s.jsxs(S,{children:[s.jsxs(S,{sx:{gap:1,flexDirection:"row",flexWrap:"nowrap",alignItems:"center",pt:1},children:[s.jsxs(S,{sx:{gap:1,flexDirection:"row",alignItems:"baseline",flexWrap:"wrap",[j.breakpoints.down("md")]:{flexDirection:"column",width:"100%"}},children:[s.jsx(re,{mode:_.IMAGE,shouldAutoFocus:!0,isDefault:J,isDuplicate:p,label:a._({id:"nM8r7D"}),value:n,onUpdate:m=>{d({...e,mimeType:m})}}),s.jsx(be,{sx:{[j.breakpoints.up("md")]:{mx:1}},children:"â†’"}),s.jsxs(De,{sx:{minWidth:"100px"},children:[s.jsx(Me,{id:"image-conversion-target-mode-label",children:a._({id:"mGEsqp"})}),s.jsx(Re,{ref:D,id:"image-conversion-target-mode",labelId:"image-conversion-target-mode-label",label:a._({id:"mGEsqp"}),value:t,onChange:m=>{f||(T(!0),I(!0)),d({...e,mode:m.target.value,target:m.target.value===_.DISABLED?de:"",headers:f?o:null,searchParams:f?c:null})},children:Ae.map(([m,{text:A}])=>s.jsx(Pe,{value:m,children:a._(A)},m))})]}),!M&&s.jsx(re,{mode:t,shouldAutoFocus:!1,isDefault:!1,isDuplicate:!1,label:a._({id:"ti+Zcg"}),value:i,onUpdate:m=>{d({...e,target:m,searchParams:O?null:We(m,c)})}}),(()=>{var m,A;return M?null:O?s.jsx(y,{sx:{width:U},label:a._({id:"Latl0z"}),value:l!=null?l:"",type:"number",error:!Q,helperText:Q?"":a._({id:"UeOiKl"}),slotProps:{input:{inputProps:$}},onChange:g=>{d({...e,compressionLevel:g.target.value?Number(g.target.value):null})}}):s.jsxs(s.Fragment,{children:[s.jsx(y,{sx:{width:U},label:a._({id:"TtozhQ"}),value:u?P(u).seconds.inWholeSeconds:"",type:"number",error:!N,helperText:N?"":a._({id:"UeOiKl"}),slotProps:{input:{inputProps:K,endAdornment:s.jsx(W,{position:"end",children:a._({id:"ku//5b"})})}},onChange:g=>{d({...e,callTimeout:g.target.value?P(Number(g.target.value)).seconds.toISOString():null})}}),s.jsx(y,{sx:{width:U},label:a._({id:"FfbL/S"}),value:r?P(r).seconds.inWholeSeconds:"",type:"number",error:!X,helperText:X?"":a._({id:"UeOiKl"}),slotProps:{input:{inputProps:z,endAdornment:s.jsx(W,{position:"end",children:a._({id:"ku//5b"})})}},onChange:g=>{d({...e,connectTimeout:g.target.value?P(Number(g.target.value)).seconds.toISOString():null})}}),s.jsx(G,{disabled:!w(i),onClick:()=>T(!h),variant:h?"outlined":"contained",sx:{height:C},children:a._({id:"fvcqzg",values:{0:(m=c==null?void 0:c.length)!=null?m:0}})}),s.jsx(G,{onClick:()=>I(!x),variant:x?"outlined":"contained",sx:{height:C},children:a._({id:"fFttez",values:{0:(A=o==null?void 0:o.length)!=null?A:0}})})]})})()]}),s.jsx(ue,{disabled:H,title:a._({id:"cnGeoo"}),children:s.jsx(me,{disabled:H,onClick:()=>{d(null)},children:s.jsx(xe,{})})})]}),s.jsx(oe,{title:a._({id:"NP8rZC"}),open:f&&!h,items:c,onChange:m=>{var ee,te;const A=(ee=i==null?void 0:i.split("?")[0])!=null?ee:"",g=Object.fromEntries((te=m==null?void 0:m.map(({name:fe,value:Ee})=>[fe,Ee]))!=null?te:[]);d({...e,target:q.addParams(A,g),searchParams:m})}}),s.jsx(oe,{title:a._({id:"ZIgY2y"}),open:f&&!x,items:o,onChange:m=>d({...e,headers:m})})]})},it=({type:e})=>{var h,T;const{i18n:t,_:n}=v();Le(t._(ye[e]));const{data:i,loading:l,error:o,refetch:c}=ne.useGetServerSettings({notifyOnNetworkStatusChange:!0}),[u]=ne.useUpdateServerSettings();if(l)return s.jsx(Ue,{});if(o)return s.jsx(Oe,{message:t._({id:"6m5aox"}),messageExtra:se(o),retry:()=>c().catch(Ge("ImageProcessingSetting::refetch"))});const r=ve[e];Ne((h=i==null?void 0:i.settings)==null?void 0:h[r]);const d=(T=i==null?void 0:i.settings)==null?void 0:T[r],[p,a]=Y.useState(le(F(V(d)))),E=$e(p),j=qe(le(F(V(d))),p),D=x=>{const I=u({variables:{input:{settings:{[r]:x}}}});return I.catch(M=>we(t._({id:"cBoXe4"}),"error",se(M))),I},C=async()=>{try{await D(Be(p))}catch(x){}};return s.jsxs(S,{sx:{p:2,gap:5},children:[s.jsx(pe,{children:t._({id:"xbZI3U"})}),s.jsx(S,{sx:{flexDirection:"column",gap:5},children:p.map((x,I)=>{const{mimeType:M}=x,O=he(M,I,p);return s.jsx(Xe,{conversion:x,isDuplicate:O,onChange:f=>{a(N=>F(N.toSpliced(I,1,...f?[f]:[])))}},x.id)})}),s.jsxs(S,{direction:"row",sx:{gap:1},children:[s.jsx(G,{variant:"outlined",onClick:()=>{a(x=>[...x,...V([{mimeType:"",target:"",compressionLevel:null,headers:null,callTimeout:null,connectTimeout:null}])])},children:t._({id:"m16xKo"})}),s.jsx(G,{variant:"contained",disabled:E||!j,onClick:C,children:t._({id:"tfDRzk"})})]})]})};export{it as ImageProcessingSetting};
