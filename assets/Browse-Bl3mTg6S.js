import{c as Q,j as e,u as y,A as N,L as U,r as T,S as z,T as S,l as xe,B as V,C as O,I as R,m as w,g as I,a as ye,b as Ae,d as Z,e as l,D as Ne,f as ke,h as J,i as P,k as Me,n as fe,o as pe,p as Ue,s as Oe,q as Re,t as Pe,v as de,w as me,x as Be,G as Ge}from"./index-B9sXdsff.js";import{u as Se,S as je,A as De}from"./AppbarSearch-C8NH9atv.js";import{P as He}from"./PushPin-BjWqwdPT.js";import{P as Fe}from"./PushPinOutlined-CJnGXnIj.js";import{SourceContentType as he}from"./SourceMangas-CRLD0Sb5.js";import{M as Y}from"./MUI.util-CYBuX_Wz.js";import{u as ze,S as M,c as Ve}from"./Sources-Btd4kaKE.js";import{L as ee}from"./ListCardAvatar-CjrqL715.js";import{L as te}from"./ListCardContent-B7hvkgHx.js";import{C as se}from"./Card-DbJySDoj.js";import{C as ne}from"./CardActionArea-DMEvphnQ.js";import{L as be}from"./LanguageSelect-DnJiJWXR.js";import{E as F}from"./EmptyViewAbsoluteCentered-Bt5j7wSo.js";import{i as Ke,t as oe,g as H,I as $e,a as qe,E as Ce,b as G,c as Xe,u as We,d as Ye,e as Qe,f as Ze,h as Je,j as et,k as tt}from"./Extensions.utils-LCqRyAeT.js";import{u as ve}from"./useAppAction-DLir27iw.js";import{S as Ee,a as Le}from"./StyledGroupHeader-hATxwdZS.js";import{V as Te}from"./Virtuoso.util-BKiqqNun.js";import{S as re}from"./StyledGroupItemWrapper-B7dtnHRT.js";import{f as st}from"./file-selector-DlHkLoY8.js";import{A as nt}from"./Add-CbVr3wBZ.js";import{u as ge}from"./use-window-event-C6RaIPsP.js";import{T as X,a as W}from"./Tabs-C7Ejmrhi.js";import{T as ot}from"./TabsWrapper-CaK9XGPi.js";import{T as rt}from"./TabsMenu-DXjvUJs1.js";import{A as at,a as it}from"./SortRadioInput-MzWhSjrJ.js";import{C as ct}from"./Chip-B3wcQm6N.js";import{u as lt}from"./useAppTitle-DSyYosGS.js";import"./ChaptersDownloadActionMenuItems-Cf_rb7pK.js";import"./Trackers-COtG7wmP.js";import"./Avatar-BQ4KlAHq.js";import"./TextField-syre69i-.js";import"./useFormControl-DktQh-yB.js";import"./formControlState-Dq1zat_P.js";import"./InputAdornment-DtSjeSvy.js";import"./CheckCircle-U6zAnUBW.js";import"./Metadata-CHXI9Ipx.js";import"./Link-B5ijOrpF.js";import"./useManageMangaLibraryState-DThiVL2r.js";import"./ThreeStateCheckboxInput-kT5QDhvg.js";import"./Checkbox-CplIld-b.js";import"./SwitchBase-CNV_Zt6H.js";import"./CheckboxInput-nGAGiIlk.js";import"./FormGroup-CfHB8UxR.js";import"./ListPreference-DTyvDrL5.js";import"./NumberSetting-NzOj-zwR.js";import"./Slider-Dw34jcFb.js";import"./useMobilePicker-Dw1ct5r-.js";import"./SelectSetting-s95c1gQI.js";import"./Select-mBzvVLN6.js";import"./Favorite-9JqW9PDM.js";import"./FilterList-Cj2XPyls.js";import"./GridLayouts-OqZ8h15d.js";import"./Delete-CcMybldr.js";import"./ExpandMore-Bd5JFhiW.js";import"./useDebounce-D7BKn258.js";import"./StyledFab-tSHcntjY.js";import"./BaseMangaGrid-DjkoUzj2.js";import"./MangaGrid-B5cUxDaX.js";import"./Download-B2ss5cI2.js";import"./Sync-CYvcIWmb.js";import"./use-merged-ref-CyP4J_9T.js";import"./PlayArrow-DIerWG-6.js";import"./index-DPIX3ULs.js";import"./useAppTitleAndAction-DjJOzoVd.js";import"./Switch-DIPp-SWP.js";const ut=Q(e.jsx("path",{d:"M19.3 16.9c.4-.7.7-1.5.7-2.4 0-2.5-2-4.5-4.5-4.5S11 12 11 14.5s2 4.5 4.5 4.5c.9 0 1.7-.3 2.4-.7l3.2 3.2 1.4-1.4zm-3.8.1c-1.4 0-2.5-1.1-2.5-2.5s1.1-2.5 2.5-2.5 2.5 1.1 2.5 2.5-1.1 2.5-2.5 2.5M12 20v2C6.48 22 2 17.52 2 12S6.48 2 12 2c4.84 0 8.87 3.44 9.8 8h-2.07c-.64-2.46-2.4-4.47-4.73-5.41V5c0 1.1-.9 2-2 2h-2v2c0 .55-.45 1-1 1H8v2h2v3H9l-4.79-4.79C4.08 10.79 4 11.38 4 12c0 4.41 3.59 8 8 8"})),pt=i=>{const{t}=y(),{source:s,showSourceRepo:d,showLanguage:c}=i,{id:n,name:o,lang:a,iconUrl:h,supportsLatest:b,isNsfw:p,extension:{repo:x}}=s,{isPinned:u}=ze(s),v=M.isLocalSource(s)?t("source.local_source.title"):o,E=Ve(s,C=>w(t("global.error.label.failed_to_save_changes"),"error",I(C)));return e.jsx(se,{children:e.jsx(ne,{component:U,to:N.sources.childRoutes.browse.path(n),state:{contentType:he.POPULAR,clearCache:!0},children:e.jsxs(te,{children:[e.jsx(ee,{iconUrl:T.getValidImgUrlFor(h),alt:v}),e.jsxs(z,{sx:{justifyContent:"center",flexGrow:1,flexShrink:1,wordBreak:"break-word"},children:[e.jsx(S,{variant:"h6",component:"h3",children:v}),e.jsxs(S,{variant:"caption",children:[c&&xe(a),p&&e.jsx(S,{variant:"caption",color:"error",children:" 18+"})]}),d&&e.jsx(S,{variant:"caption",children:x})]}),b&&e.jsx(V,{...Y.preventRippleProp(),variant:"outlined",component:U,to:N.sources.childRoutes.browse.path(n),state:{contentType:he.LATEST,clearCache:!0},children:t("global.button.latest")}),e.jsx(O,{title:t(u?"source.pin.remove":"source.pin.add"),children:e.jsx(R,{...Y.preventRippleProp(),onClick:C=>{C.preventDefault(),E("isPinned",!u)},color:u?"primary":"inherit",children:u?e.jsx(He,{}):e.jsx(Fe,{})})})]})})})};function dt({tabsMenuHeight:i}){const{t}=y(),[s,d]=ye("shownSourceLangs",Ae()),{settings:{showNsfw:c,lastUsedSourceId:n}}=Z(),{data:o,loading:a,error:h,refetch:b}=T.useGetSourceList({notifyOnNetworkStatusChange:!0}),p=o==null?void 0:o.sources.nodes,x=l.useMemo(()=>M.filter(p!=null?p:[],{showNsfw:c,languages:s,keepLocalSource:!0,enabled:!0}),[p,s]),u=l.useMemo(()=>{const m=M.getLastUsedSource(n,x),f=Object.entries(M.groupByLanguage(x));return m?[[Ne.LAST_USED_SOURCE,[m]],...f]:f},[x]),v=l.useMemo(()=>M.getLanguages(p!=null?p:[]),[p]),E=l.useMemo(()=>M.areFromMultipleRepos(x),[x]),C=l.useMemo(()=>u.map(([,m])=>m).flat(1),[u]),L=l.useMemo(()=>u.map(m=>m[1].length),[u]),_=Te.useCreateGroupedComputeItemKey(L,l.useCallback(m=>u[m][0],[u]),l.useCallback((m,f)=>"".concat(u[f][0],"_").concat(C[m].id),[C])),k=ke();return ve(e.jsxs(e.Fragment,{children:[e.jsx(O,{title:t("search.title.global_search"),children:e.jsx(R,{onClick:()=>k(N.sources.childRoutes.searchAll.path()),color:"inherit",children:e.jsx(ut,{})})}),e.jsx(be,{selectedLanguages:s,setSelectedLanguages:d,languages:v})]}),[t,s,v]),a?e.jsx(J,{}):h?e.jsx(F,{message:t("global.error.label.failed_to_load_data"),messageExtra:I(h),retry:()=>b().catch(P())}):(p==null?void 0:p.length)===0?e.jsx(F,{message:t("source.error.label.no_sources_found")}):e.jsx(Ee,{persistKey:"sources",heightToSubtract:i,overscan:window.innerHeight*.5,groupCounts:L,computeItemKey:_,groupContent:m=>{const[f]=u[m];return e.jsx(Le,{isFirstItem:!m,children:e.jsx(S,{variant:"h5",component:"h2",children:oe(f)})})},itemContent:(m,f)=>{const B=u[f][0],g=C[m];return e.jsx(re,{children:e.jsx(pt,{source:g,showSourceRepo:E,showLanguage:Ke(B)})})}})}const mt=({disabled:i,children:t,...s})=>i?t:e.jsx(ne,{component:U,...s,children:t});function ht(i){const{t}=y(),{extension:{name:s,lang:d,versionName:c,isInstalled:n,hasUpdate:o,isObsolete:a,pkgName:h,iconUrl:b,isNsfw:p,repo:x},handleUpdate:u,showSourceRepo:v,forcedState:E}=i,[C,L]=l.useState(H(n,a,o)),_=E!=null?E:C;l.useEffect(()=>{L(H(n,a,o))},[H(n,a,o)]);const k=async f=>{const B=Ye[f],g=Xe[f];try{L(g),await We(h,a,f),L(B),u()}catch(K){L(H(n,a,o))}};function m(){switch(_){case G.INSTALL:case G.UPDATE:case G.UNINSTALL:k(_).catch(P());break;case Ce.OBSOLETE:k(G.UNINSTALL).catch(P());break}}return e.jsx(se,{children:e.jsx(mt,{disabled:!n,to:N.extension.childRoutes.info.path(h),children:e.jsxs(te,{children:[e.jsx(ee,{iconUrl:T.getValidImgUrlFor(b),alt:s}),e.jsxs(z,{sx:{justifyContent:"center",flexGrow:1,flexShrink:1,wordBreak:"break-word"},children:[e.jsx(S,{variant:"h6",component:"h3",children:s}),e.jsxs(S,{variant:"caption",children:[n?"".concat(xe(d)," "):"",c,p&&e.jsx(S,{variant:"caption",color:"error",children:" 18+"})]}),v&&e.jsx(S,{variant:"caption",children:x})]}),n&&e.jsx(O,{title:t("settings.title"),children:e.jsx(R,{component:U,to:N.extension.childRoutes.info.path(h),color:"inherit",...Y.preventRippleProp(),children:e.jsx(Me,{})})}),e.jsx(V,{variant:"outlined",sx:{color:_===qe.OBSOLETE?"red":"inherit",flexShrink:0},onClick:()=>m(),children:t($e[_])})]})})})}const gt=0,xt=1,ft=({groupName:i,isFirstItem:t,groupExtensionIds:s,isUpdateGroup:d,updatingExtensionIds:c,setUpdatingExtensionIds:n,handleExtensionUpdate:o})=>{const{t:a}=y();return e.jsxs(Le,{isFirstItem:t,sx:{flexDirection:"row",justifyContent:"space-between",alignItems:"center",pr:1},children:[e.jsx(S,{variant:"h5",component:"h2",children:oe(i)}),d&&e.jsx(V,{disabled:!!c.length,variant:"contained",onClick:()=>{n(s),T.updateExtensions(s,{update:!0}).response.then(()=>o()).catch(h=>w(a(tt[G.UPDATE],{count:s.length}),"error",I(h))).finally(()=>n([]))},children:a("extension.action.label.update_all")})]},i)};function St({tabsMenuHeight:i}){var le,ue;const{t}=y(),{data:s,loading:d,error:c,refetch:n}=T.useGetServerSettings({notifyOnNetworkStatusChange:!0}),[o,{data:a,loading:h,error:b}]=T.useExtensionListFetch(),{settings:{extensionLanguages:p,showNsfw:x}}=Z(),u=fe(r=>w(t("global.error.label.failed_to_save_changes"),"error",I(r))),[v]=Se("query",je),[E,C]=l.useState([]),[L,_]=l.useState({}),k=d||h,m=c!=null?c:b,f=!!(s!=null&&s.settings.extensionRepos.length),B=((le=s==null?void 0:s.settings.extensionRepos.length)!=null?le:0)>1,g=(ue=a==null?void 0:a.fetchExtensions)==null?void 0:ue.extensions,K=l.useMemo(()=>Qe(g!=null?g:[]),[g]),ae=l.useMemo(()=>Ze(g!=null?g:[],{selectedLanguages:p,showNsfw:x,query:v}),[g,p,x,v]),A=l.useMemo(()=>Je(ae),[ae]),ie=l.useMemo(()=>A.map(r=>r[xt].length),[A]),$=l.useMemo(()=>A.map(([,r])=>r).flat(1),[A]),_e=Te.useCreateGroupedComputeItemKey(ie,l.useCallback(r=>A[r][gt],[A]),l.useCallback(r=>$[r].pkgName,[$])),q=l.useCallback(()=>_({}),[]),ce=r=>{if(!r.name.toLowerCase().endsWith("apk")){w(t("global.error.label.invalid_file_type"),"error");return}w(t("extension.label.installing_file"),"info"),T.installExternalExtension(r).response.then(()=>{q(),w(t("extension.label.installed_successfully"),"success")}).catch(j=>w(t("extension.label.installation_failed"),"error",I(j)))};return l.useEffect(()=>{o()},[L]),ve(e.jsxs(e.Fragment,{children:[e.jsx(De,{}),e.jsx(O,{title:t("extension.action.label.install_external"),children:e.jsx(R,{onClick:()=>{const r=document.createElement("input");r.style.display="none",r.type="file",r.onchange=()=>{var D;const j=(D=r.files)==null?void 0:D[0];j&&ce(j)},document.documentElement.appendChild(r),r.click(),document.documentElement.removeChild(r)},color:"inherit",children:e.jsx(nt,{})})}),e.jsx(be,{selectedLanguages:p,setSelectedLanguages:r=>u("extensionLanguages",r),languages:K})]}),[t,p,K]),ge("drop",async r=>{r.preventDefault();const j=await st(r);ce(j[0])}),ge("dragover",r=>{r.preventDefault()}),k?e.jsx(J,{}):m?e.jsx(F,{message:t("global.error.label.failed_to_load_data"),messageExtra:I(m),retry:()=>{c&&n().catch(P()),b&&o().catch(P())}}):!(g!=null&&g.length)&&!f?e.jsxs(z,{sx:{alignItems:"center",justifyContent:"center",rowGap:"10px",paddingTop:"20px"},children:[e.jsx(S,{children:t("extension.label.add_repository_info")}),e.jsx(V,{component:U,variant:"contained",to:N.settings.childRoutes.browse.path,children:t("settings.title")})]}):e.jsx(Ee,{persistKey:"extensions",heightToSubtract:i,overscan:window.innerHeight*.5,groupCounts:ie,groupContent:r=>{const[j,D]=A[r],we=j===et.UPDATE_PENDING;return e.jsx(ft,{groupName:j,isFirstItem:r===0,groupExtensionIds:D.map(Ie=>Ie.pkgName),isUpdateGroup:we,updatingExtensionIds:E,setUpdatingExtensionIds:C,handleExtensionUpdate:q})},computeItemKey:_e,itemContent:r=>{const j=$[r];return e.jsx(re,{children:e.jsx(ht,{extension:j,handleUpdate:q,showSourceRepo:B,forcedState:E.includes(j.pkgName)?Ce.UPDATING:void 0})})}})}const jt=Q(e.jsx("path",{d:"M14.94 4.66h-4.72l2.36-2.36zm-4.69 14.71h4.66l-2.33 2.33zM6.1 6.27 1.6 17.73h1.84l.92-2.45h5.11l.92 2.45h1.84L7.74 6.27zm-1.13 7.37 1.94-5.18 1.94 5.18zm10.76 2.5h6.12v1.59h-8.53v-1.29l5.92-8.56h-5.88v-1.6h8.3v1.26z"})),bt=Q(e.jsx("path",{d:"M20 10V8h-4V4h-2v4h-4V4H8v4H4v2h4v4H4v2h4v4h2v-4h4v4h2v-4h4v-2h-4v-4zm-6 4h-4v-4h4z"})),Ct=({id:i,name:t,lang:s,iconUrl:d,mangaCount:c})=>{const{t:n}=y(),a=Number(i)===0?n("source.local_source.title"):t;return e.jsx(se,{children:e.jsx(ne,{component:U,to:N.migrate.path(i),children:e.jsxs(te,{sx:{justifyContent:"space-between"},children:[e.jsxs(pe,{sx:{display:"flex",gap:1},children:[e.jsx(ee,{iconUrl:T.getValidImgUrlFor(d),alt:a}),e.jsxs(pe,{sx:{display:"flex",flexDirection:"column",justifyContent:"center"},children:[e.jsx(S,{variant:"h6",component:"h3",children:a}),e.jsx(S,{variant:"caption",sx:{display:"block"},children:oe(s)})]})]}),e.jsx(ct,{sx:{borderRadius:1},size:"small",label:c})]})})})},vt=(i,{sortBy:t,sortOrder:s})=>{if(!i)return[];const d={};i.forEach(({sourceId:n,source:o})=>{var h;const a=(h=d[n])!=null?h:{id:n,name:n,lang:"unknown",iconUrl:null,mangaCount:0,...o};d[n]={...a,mangaCount:a.mangaCount+1}});const c=Object.values(d).toSorted((n,o)=>{switch(t){case de.SOURCE_NAME:return n.name.localeCompare(o.name);case de.MANGA_COUNT:return n.mangaCount-o.mangaCount;default:throw new Error('Unexpected "sortBy" "'.concat(t,'"'))}});switch(s){case me.ASC:return c;case me.DESC:return c.toReversed();default:throw new Error('Unexpected "sortOrder" "'.concat(s,'"'))}},Et=({tabsMenuHeight:i})=>{const{t}=y(),{appBarHeight:s}=Ue(),{settings:{migrateSortSettings:d}}=Z(),c=fe(u=>w(t("global.error.label.failed_to_save_changes"),"error",I(u))),{sortBy:n,sortOrder:o}=d,{data:a,loading:h,error:b,refetch:p}=T.useGetMigratableSources({notifyOnNetworkStatusChange:!0}),x=l.useMemo(()=>vt(a==null?void 0:a.mangas.nodes,d),[a==null?void 0:a.mangas.nodes,d]);return h?e.jsx(J,{}):b?e.jsx(F,{message:t("global.error.label.failed_to_load_data"),messageExtra:I(b),retry:()=>p().catch(P())}):e.jsxs(e.Fragment,{children:[e.jsxs(z,{sx:{position:"sticky",top:"".concat(s+i,"px"),flexDirection:"row",justifyContent:"end",alignItems:"center",gap:1,p:1,backgroundColor:"background.default",zIndex:1},children:[e.jsx(O,{title:t(Oe[n]),children:e.jsx(R,{color:"inherit",onClick:()=>c("migrateSortSettings",{sortBy:(n+1)%2,sortOrder:o}),children:n?e.jsx(bt,{}):e.jsx(jt,{})})}),e.jsx(O,{title:t(Re[o]),children:e.jsx(R,{color:"inherit",onClick:()=>c("migrateSortSettings",{sortBy:n,sortOrder:(o+1)%2}),children:o?e.jsx(at,{}):e.jsx(it,{})})})]}),e.jsx(Pe,{sx:{p:0},children:x.map(u=>e.jsx(re,{children:e.jsx(Ct,{...u})},u.id))})]})};function Rs(){const{t:i}=y();lt(i("global.label.browse"));const t=l.useRef(null),[s,d]=l.useState(0);Be(t,l.useCallback(()=>d(t.current.offsetHeight),[t.current]));const[c,n]=Se("tab",je,{}),o=c!=null?c:"source";return c||n(o,"replaceIn"),e.jsxs(ot,{children:[e.jsxs(rt,{ref:t,sx:{zIndex:Ge},variant:"fullWidth",value:o,onChange:(a,h)=>n(h,"replaceIn"),children:[e.jsx(X,{value:"source",sx:{textTransform:"none"},label:i("source.title_one")}),e.jsx(X,{value:"extensions",sx:{textTransform:"none"},label:i("extension.title_other")}),e.jsx(X,{value:"migrate",sx:{textTransform:"none"},label:i("migrate.title")})]}),e.jsx(W,{index:"source",currentIndex:o,children:e.jsx(dt,{tabsMenuHeight:s})}),e.jsx(W,{index:"extensions",currentIndex:o,children:e.jsx(St,{tabsMenuHeight:s})}),e.jsx(W,{index:"migrate",currentIndex:o,children:e.jsx(Et,{tabsMenuHeight:s})})]})}export{Rs as Browse};
