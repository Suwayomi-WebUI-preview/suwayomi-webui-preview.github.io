import{a as ge,R as he,j as e,c as De,an as F,T as xe,aq as Ge,p as k,aL as fe,as as Se,al as je,S as B,e as b,ba as _,aQ as Ne,u as be,B as M,a2 as Ue,C as J,I as Ce,a3 as Be,l as qe,ab as He,n as Ve,o as ze,aH as Qe,bb as We,i as Z,t as Ke,at as Ye,bc as Je,f as Ze,q as pe,d as Xe,ax as U,bd as et,r as O,be as tt,Q as st,k as at,A as rt,az as nt,Z as X,bf as ot,g as me,bg as it,m as lt}from"./index-C-cAphVV.js";import{a as ct,u as ut,A as dt,S as pt}from"./AppbarSearch-tPTdQPBV.js";import{F as mt}from"./Favorite-COlkRn6O.js";import{F as ve}from"./FilterList-DhwN6XUq.js";import{G as gt}from"./GridLayouts-DMgRTjW9.js";import{D as ht}from"./Delete-DNIYRj0K.js";import{S as xt,O as ft}from"./SortRadioInput-BllVP2dY.js";import{C as St}from"./CheckboxInput-BjNqkP6k.js";import{a as ye,I as Fe,S as jt,b as bt,T as Ct}from"./TextField-CZwUEeA7.js";import{a as Ie,E as Le}from"./ExpandMore-Dp1mz1du.js";import{u as vt}from"./useDebounce-7JaGXnNj.js";import{I as yt}from"./InputAdornment-DdDyCkpo.js";import{T as Ft}from"./ThreeStateCheckboxInput-ClWHoKge.js";import{S as It}from"./StyledFab-Cr9jA65V.js";import{C as Lt}from"./Chip-DZlwzh74.js";import{B as Tt}from"./BaseMangaGrid-CUxOS-86.js";import{g as Et}from"./MangaGrid-Bfy65xwN.js";import{u as kt,c as _t,S as At}from"./Sources-B4IWYOv9.js";import{E as Pt}from"./EmptyViewAbsoluteCentered-BQpkxOJY.js";import{u as wt}from"./useAppTitleAndAction-CX9lB7WZ.js";import{L as Mt}from"./Link-D_2hs_pj.js";import"./ChaptersDownloadActionMenuItems-D-E6CQFv.js";import"./Trackers-D4pSmk7a.js";import"./Card-zFIT7wCh.js";import"./ListCardContent-Bj6PNODS.js";import"./Avatar-CRN5WhAO.js";import"./CheckCircle-DDWXYKGf.js";import"./MUI.util-CABFVdyN.js";import"./CardActionArea-B_fg-Ksw.js";import"./useManageMangaLibraryState-Bwkneo6H.js";import"./FormGroup-v52M7kXC.js";import"./useFormControl-Y62hwEC_.js";import"./formControlState-Dq1zat_P.js";import"./ListPreference-D_7pyo9C.js";import"./Checkbox-BG37Jl2y.js";import"./SwitchBase-DliFqtWM.js";import"./NumberSetting-D7pHf4SF.js";import"./Slider-CBI0dWly.js";import"./useMobilePicker-DhM9BXz4.js";import"./SelectSetting-B_EgBRCY.js";import"./Select-2pYSA1n5.js";import"./Download-DqdBI_V6.js";import"./Sync--MhoTzfI.js";import"./use-merged-ref-CLhd_cWn.js";import"./ListCardAvatar-B2qm6dV6.js";import"./PlayArrow-CXjie5IJ.js";import"./useAppTitle-Cd10jtvK.js";import"./useAppAction-CHyVej5i.js";function Ot(){const[t,n]=ge("source-grid-layout",he.Compact);return e.jsx(gt,{gridLayout:t,onChange:n})}const $t=De(e.jsx("path",{d:"M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3m3-10H5V5h10z"})),Rt=t=>{const{state:n,name:r,position:o,group:s,updateFilterValue:c,update:a}=t,[l,i]=F.useState(n),x=u=>{i(u.target.checked);const m=a.filter(S=>!(o===S.position&&s===S.group));c([...m,{type:"checkBoxState",position:o,state:u.target.checked,group:s}])};return n!==void 0?e.jsx(St,{label:r,checked:l,onChange:x}):null},Dt=({name:t})=>e.jsx(xe,{sx:{mt:2},variant:"subtitle2",children:t},t);function Gt(t,n,r,o,s,c,a){const[l,i]=F.useState(r);if(t){const x=m=>{const S=t.indexOf("".concat(m.target.value));i(S);const d=c.filter(p=>!(o===p.position&&a===p.group));s([...d,{type:"selectState",position:o,state:S,group:a}])},u=t.map(m=>e.jsx(Ge,{value:m,children:m},"".concat(n," ").concat(m)));return e.jsxs(ye,{sx:{my:1},variant:"standard",children:[e.jsx(Fe,{children:n}),e.jsx(jt,{name:n,value:t[l],label:n,onChange:x,children:u})]})}return null}const Nt=({values:t,name:n,state:r,position:o,updateFilterValue:s,update:c,group:a})=>Gt(t,n,r,o,s,c,a),Ut=t=>{const{values:n,name:r,state:o,position:s,group:c,updateFilterValue:a,update:l}=t,[i,x]=F.useState(o),[u,m]=F.useState(!1),S=()=>{m(!u)};if(n){const d=p=>{const g=i;g.index===p?g.ascending=!g.ascending:g.ascending=!0,g.index=p,x(g);const v=l.filter(f=>!(s===f.position&&c===f.group));a([...v,{type:"sortState",position:s,state:g,group:c}])};return e.jsxs(k,{sx:{mx:-2},children:[e.jsxs(fe,{onClick:S,children:[e.jsx(Se,{primary:r}),u?e.jsx(Ie,{}):e.jsx(Le,{})]}),e.jsx(je,{in:u,children:e.jsx(B,{sx:{mx:4},children:n.map((p,g)=>e.jsx(xt,{label:p,checked:i.index===g,sortDescending:!i.ascending,onClick:()=>d(g)},"".concat(r," ").concat(p)))})})]})}return null},Bt=t=>{const{state:n,name:r,position:o,group:s,updateFilterValue:c,update:a}=t,[l,i]=F.useState(n||""),x=vt(l,500);return b.useEffect(()=>{const u=a.filter(m=>!(o===m.position&&s===m.group));c([...u,{type:"textState",position:o,state:x,group:s}])},[x]),n!==void 0?e.jsxs(ye,{sx:{my:1},variant:"standard",children:[e.jsx(Fe,{children:r}),e.jsx(bt,{name:r,value:l,onChange:({target:{value:u}})=>i(u),endAdornment:e.jsx(yt,{position:"end",children:e.jsx(ct,{})})})]}):null},qt=t=>{switch(t){case _.Ignore:return 0;case _.Include:return 1;case _.Exclude:return 2;default:throw new Error("Unexpected TriState ".concat(t))}},Ht=t=>{switch(t){case 0:return _.Ignore;case 1:return _.Include;case 2:return _.Exclude;default:throw new Error("Unexpected state number ".concat(t))}},Vt=t=>{const{state:n,name:r,position:o,group:s,updateFilterValue:c,update:a}=t,[l,i]=F.useState(qt(n)),x=u=>{const m=u===void 0?0:u?1:2;i(m);const S=a.filter(d=>!(o===d.position&&s===d.group));c([...S,{type:"triState",position:o,state:Ht(m),group:s}])};return n!==void 0?e.jsx(Ft,{label:r,checked:[void 0,!0,!1][l],onChange:u=>x(u)}):null},zt=t=>{const{state:n,name:r,position:o,updateFilterValue:s,update:c}=t,[a,l]=F.useState(!1);return e.jsxs(k,{sx:{mx:-2},children:[e.jsxs(fe,{onClick:()=>l(!a),children:[e.jsx(Se,{primary:r}),a?e.jsx(Ie,{}):e.jsx(Le,{})]}),e.jsx(je,{in:a,children:e.jsx(B,{sx:{mx:4},children:e.jsx(Te,{sourceFilter:n,group:o,updateFilterValue:s,update:c})})})]})},Qt=({name:t})=>e.jsx(Ne,{sx:{my:1},textAlign:"center",children:t},t);function Te({sourceFilter:t,group:n,updateFilterValue:r,update:o}){return e.jsx(B,{children:t.map((s,c)=>{var l,i;let a=o.find(x=>x.group===n&&x.position===c);switch(a=a&&a.state,s.type){case"CheckBoxFilter":return e.jsx(Rt,{name:s.name,state:a!=null?a:s.CheckBoxFilterDefault,position:c,group:n,updateFilterValue:r,update:o},"filters ".concat(s.name));case"GroupFilter":return e.jsx(zt,{name:s.name,state:s.filters,position:c,updateFilterValue:r,update:o},"filters ".concat(s.name));case"HeaderFilter":return e.jsx(Dt,{name:s.name},"filters ".concat(s.name));case"SelectFilter":return e.jsx(Nt,{name:s.name,values:s.values,state:a!=null?parseInt(a,10):s.SelectFilterDefault,position:c,group:n,updateFilterValue:r,update:o},"filters ".concat(s.name));case"SeparatorFilter":return e.jsx(Qt,{name:s.name},"filters ".concat(s.name));case"SortFilter":return e.jsx(Ut,{name:s.name,values:s.values,state:a!=null?a:{ascending:(l=s.SortFilterDefault)==null?void 0:l.ascending,index:(i=s.SortFilterDefault)==null?void 0:i.index},position:c,group:n,updateFilterValue:r,update:o},"filters ".concat(s.name));case"TextFilter":return e.jsx(Bt,{name:s.name,state:a!=null?a:s.TextFilterDefault,position:c,group:n,updateFilterValue:r,update:o},"filters ".concat(s.name));case"TriStateFilter":return e.jsx(Vt,{name:s.name,state:a!=null?a:s.TriStateFilterDefault,position:c,group:n,updateFilterValue:r,update:o},"filters ".concat(s.name));default:throw new Error('Unknown source filter "'.concat(s,'"'))}})},"filters ".concat(n))}function Wt({savedSearches:t={},selectSavedSearch:n,updateSavedSearches:r,sourceFilter:o,updateFilterValue:s,resetFilterValue:c,setTriggerUpdate:a,update:l}){const{t:i}=be(),[x,u]=b.useState(!1),[m,S]=b.useState(""),d=Object.keys(t),p=!!d.length;function g(){c(0),u(!1)}function v(){a(0),u(!1)}return e.jsxs(e.Fragment,{children:[e.jsxs(It,{onClick:()=>u(!x),variant:"extended",color:"primary",children:[e.jsx(ve,{}),i("global.button.filter")]}),e.jsxs(ft,{open:x,onClose:()=>u(!1),children:[e.jsxs(k,{sx:{p:2,pb:p?void 0:0},children:[e.jsxs(k,{sx:{display:"flex",pb:1},children:[e.jsx(M,{onClick:g,children:i("global.button.reset")}),e.jsx(Ue,{variant:"dialog",popupId:"source-browse-save-search",children:f=>e.jsxs(e.Fragment,{children:[e.jsx(J,{title:i("source.filter.save_search.label.save"),children:e.jsx(Ce,{sx:{marginLeft:"auto"},...Be(f),children:e.jsx($t,{})})}),e.jsxs(qe,{...He(f),maxWidth:"xs",fullWidth:!0,children:[e.jsx(Ve,{children:i("source.filter.save_search.dialog.label.title")}),e.jsx(ze,{children:e.jsx(Ct,{sx:{width:"100%"},value:m,onChange:y=>S(y.target.value),slotProps:{htmlInput:{maxLength:50}}})}),e.jsxs(Qe,{children:[e.jsx(M,{onClick:()=>{S(""),f.close()},children:i("global.button.cancel")}),e.jsx(M,{onClick:()=>{r(m,"create"),S(""),f.close()},children:i("global.button.ok")})]})]})]})}),e.jsx(M,{variant:"contained",onClick:v,children:i("global.button.submit")})]}),p&&e.jsxs(e.Fragment,{children:[e.jsx(xe,{sx:{pb:1},children:"Saved searches"}),e.jsx(B,{sx:{flexDirection:"row"},children:d.map(f=>e.jsx(Lt,{label:f,onClick:()=>{u(!1),n(f)},onDelete:()=>{We({title:i("global.label.are_you_sure"),message:i("source.filter.save_search.dialog.label.delete",{name:f}),actions:{confirm:{title:i("global.button.delete")}}}).then(()=>r(f,"delete")).catch(Z())},deleteIcon:e.jsx(J,{title:i("source.filter.save_search.label.delete"),children:e.jsx(ht,{})}),variant:"outlined"}))})]})]}),e.jsx(k,{sx:{pb:2,mx:2},children:e.jsx(Te,{sourceFilter:o,updateFilterValue:s,group:void 0,update:l})})]})]})}const Kt={id:"-1"},Yt=X("div")(({theme:t})=>({display:"flex",position:"sticky",width:"100%",zIndex:1,padding:t.spacing(1),gap:t.spacing(1),backgroundColor:t.palette.background.default})),Y=X(M)(()=>({})),Jt=X(k)(()=>({minHeight:"100%",position:"relative"}));var Zt=(t=>(t[t.POPULAR=0]="POPULAR",t[t.LATEST=1]="LATEST",t[t.SEARCH=2]="SEARCH",t))(Zt||{});const Xt={0:"manga.error.label.no_mangas_found",1:"manga.error.label.no_mangas_found",2:"manga.error.label.no_matches"},es=t=>{const n={},r=[];return t.forEach(o=>{!!n[o.id]||(n[o.id]=o,r.push(o))}),r},ts=(t,n,r,o,s,c)=>{var d;let a;switch(n){case 0:a=O.useGetSourcePopularMangas(t,s);break;case 1:a=O.useGetSourceLatestMangas(t,s);break;case 2:a=O.useSourceSearch(t,r!=null?r:"",o.map(p=>{const{position:g,state:v,group:f}=p;return f!==void 0?{position:f,groupChange:{position:g,[p.type]:v}}:{position:g,[p.type]:v}}),s);break;default:throw new Error('Unknown ContentType "'.concat(n,'"'))}const l=a[1],i=l.findLastIndex(p=>{var g;return!!((g=p.data)!=null&&g.fetchSourceManga)}),x=l[i],u=l.slice(-1)[0].isLoading;let m=!u;const S=b.useMemo(()=>{let p=[];return l.forEach((g,v)=>{var P,C,$;const f=($=(C=(P=g.data)==null?void 0:P.fetchSourceManga)==null?void 0:C.mangas)!=null?$:[],y=f.filter(I=>!c||!I.inLibrary),A=es([...p,...y]);m=!u&&l.length===v+1&&!y.length&&!!f.length,p=A}),p},[l,c]);return i===-1?[a[0],{...a[1][a[1].length-1],filteredOutAllItemsOfFetchedPage:m}]:[a[0],{...l[l.length-1],data:{...x.data,fetchSourceManga:{...x.data.fetchSourceManga,hasNextPage:l.length>i+1?!1:!!((d=x.data.fetchSourceManga)!=null&&d.hasNextPage),mangas:S}},filteredOutAllItemsOfFetchedPage:m}]};function Xs(){var ne,oe,ie,le,ce,ue;const{t}=be(),{appBarHeight:n}=Ke(),{sourceId:r}=Ye(),[o,s]=Je(),c=Ze(),a=pe(),{key:l,state:i}=a,{contentType:x=0,clearCache:u=!1}=(ne=pe().state)!=null?ne:{},{settings:{hideLibraryEntries:m}}=Xe(),[S]=ge("source-grid-layout",he.Compact),[d]=ut("query",pt),[p,g]=U("source-mangas-".concat(r,"-filters"),[]),[v,f]=U("source-mangas-location-".concat(l,"-").concat(r,"-filters"),p!=null?p:[]),[y,A]=b.useState(v),[ee,P]=U("source-mangas-".concat(r,"-content-type"),x),[C,$]=U("source-mangas-location-".concat(l,"-").concat(r,"-content-type"),d?2:ee),I=b.useCallback(()=>{et.session.setItem(Et(a),void 0,!1),window.scrollTo(0,0)},[l]),te=b.useRef(d),se=b.useRef(()=>{});te.current!==d&&C===2&&(te.current=d,se.current(new Error("SourceMangas(".concat(r,"): search string changed"))),I()),b.useEffect(()=>()=>{g(void 0),P(void 0)},[r]);const q=j=>{g(j),f(j),I()},ae=j=>{P(j),$(j)},Ee="".concat(C).concat(JSON.stringify(v)).concat(d),[H,{data:L,error:R,isLoading:V,size:D,abortRequest:ke,filteredOutAllItemsOfFetchedPage:z}]=ts(r,C,d,v,1,m);se.current=ke;const Q=V||z,W=(ie=(oe=L==null?void 0:L.fetchSourceManga)==null?void 0:oe.mangas)!=null?ie:[],G=!!((le=L==null?void 0:L.fetchSourceManga)!=null&&le.hasNextPage),{data:K}=O.useGetSource(tt,r),h=K==null?void 0:K.source,_e=(ce=h==null?void 0:h.filters)!=null?ce:[],{savedSearches:T={}}=kt(h!=null?h:Kt),re=_t(h!=null?h:{id:"-1"},j=>lt(t("global.error.label.failed_to_save_changes"),"error",me(j))),Ae=b.useCallback(j=>{const{query:E,filters:w}=T[j];w&&(A(w),q(w)),E&&(o.set("query",E),s(o))},[T,i]),Pe=b.useCallback((j,E)=>{if(E==="delete"){const de={...T};delete de[j],re("savedSearches",de);return}const w={...T,[j]:{query:d!=null?d:void 0,filters:y}};re("savedSearches",w)},[T,d,y]),we=Q?void 0:t(Xt[C]),Me=r===At.LOCAL_SOURCE_ID?e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:[t("source.local_source.label.checkout")," "]}),e.jsx(Mt,{href:"https://github.com/Suwayomi/Suwayomi-Server/wiki/Local-Source",target:"_blank",rel:"noreferrer",children:t("source.local_source.label.guide")})]}):void 0,N=b.useCallback((j,E)=>{ae(j),I(),d&&!E&&c({pathname:""},{state:{...i,contentType:j}})},[ae,d,I]);!!d&&C!==2&&N(2,d);const Oe=b.useCallback(()=>{G&&H(D+1)},[D,G,C]),$e=()=>{A([]),q([])};b.useEffect(()=>{st("lastUsedSourceId",r).catch(Z())},[r]),b.useEffect(()=>{z&&G&&!V&&H(D+1)},[z,V]),b.useEffect(()=>{!u||!it.REVALIDATION.includes(r)||O.clearBrowseCacheFor(r)},[u]),wt((ue=h==null?void 0:h.displayName)!=null?ue:t("source.title_one"),e.jsxs(e.Fragment,{children:[e.jsx(dt,{}),e.jsx(Ot,{}),(h==null?void 0:h.isConfigurable)&&e.jsx(J,{title:t("settings.title"),children:e.jsx(Ce,{onClick:()=>c(rt.sources.childRoutes.configure.path(r)),"aria-label":"display more actions",edge:"end",color:"inherit",children:e.jsx(at,{})})})]}),[h]);const Re=W.length?nt:Pt;return e.jsxs(Jt,{children:[e.jsxs(Yt,{sx:{top:"".concat(n,"px")},children:[e.jsx(Y,{variant:C===0?"contained":"outlined",startIcon:e.jsx(mt,{}),onClick:()=>N(0),children:t("global.button.popular")}),(h==null?void 0:h.supportsLatest)===void 0||h.supportsLatest?e.jsx(Y,{disabled:!(h!=null&&h.supportsLatest),variant:C===1?"contained":"outlined",startIcon:e.jsx(ot,{}),onClick:()=>N(1),children:t("global.button.latest")}):null,e.jsx(Y,{variant:C===2?"contained":"outlined",startIcon:e.jsx(ve,{}),onClick:()=>N(2,d),children:t("global.button.filter")})]}),(Q||!R||!!R&&!!W.length)&&e.jsx(Tt,{gridWrapperProps:{sx:{px:1,pb:1}},mangas:W,hasNextPage:G,loadMore:Oe,message:we,messageExtra:Me,isLoading:Q,gridLayout:S,mode:"source",inLibraryIndicator:!0},Ee),R&&e.jsx(Re,{message:t("global.error.label.failed_to_load_data"),messageExtra:me(R),retry:()=>H(D).catch(Z())}),C===2&&e.jsx(Wt,{savedSearches:T,selectSavedSearch:Ae,updateSavedSearches:Pe,sourceFilter:_e,updateFilterValue:A,setTriggerUpdate:()=>{q(y)},resetFilterValue:$e,update:y})]})}export{Zt as SourceContentType,Xs as SourceMangas};
