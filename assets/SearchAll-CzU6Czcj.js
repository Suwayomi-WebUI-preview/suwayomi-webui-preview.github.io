import{Y as H,u as F,a as T,c as n,j as t,L as I,T as v,aB as O,h as P,N as Q,ar as V,d as B,g as z,E as W}from"./index-aRdpybDP.js";import{u as Y,A as J,S as K}from"./AppbarSearch-B03vuL1W.js";import{s as _,l as U,a as X}from"./language-B4ilPs9t.js";import{t as Z,L as ee}from"./LangSelect-DiTpAZDi.js";import{u as A}from"./useDebounce-BGsWgzFQ.js";import{B as te}from"./BaseMangaGrid-CCl9xvi5.js";import{C as se}from"./CardContent-D1Dp0n3h.js";import{C as re}from"./index-DsS6TrSK.js";import"./useManageMangaLibraryState-BW2WFnvP.js";import"./Trackers-D4pSmk7a.js";import"./Avatar-CJ9wqF4h.js";import"./Info-Dj2Lixue.js";import"./TextField-DfS5boU6.js";import"./InputAdornment-CALBSqkc.js";import"./SpinnerImage-c3XjFys8.js";import"./TypographyMaxLines-BDCzE731.js";import"./Collapse-CdRNzg6L.js";import"./Link-Cs1KyJcr.js";import"./ListPreference-AzBShjVc.js";import"./Checkbox-DITc9wrS.js";import"./SwitchBase-DFtR10K2.js";import"./NumberSetting-tbcxM65U.js";import"./useMobilePicker-CfXLf0Rz.js";import"./Chip-CHdcBjyC.js";import"./SelectSetting-CCia1R9z.js";import"./Select-BUmRC8yt.js";import"./CheckboxInput-DHYzS8d7.js";import"./Mangas-BOW8RIyZ.js";import"./Chapters-DxvYXbnp.js";import"./ThreeStateCheckboxInput-BbgrBGOX.js";import"./FilterList-Y2-Sc-Ed.js";import"./cloneObject-DrOPTG0J.js";import"./Switch-CT8Kf14X.js";import"./MangaGrid-DmxvSwmR.js";import"./Delete-O6q18e_o.js";import"./Sync-1e-a-E2E.js";import"./PlayArrow-DMfA4sks.js";import"./StyledFab-Bj1Ar6Ir.js";function ae(s){const r=[];return s.forEach(e=>{r.indexOf(e.lang)===-1&&r.push(e.lang)}),r.sort(U),r}const oe=(s,r)=>s.displayName<r.displayName?-1:s.displayName>r.displayName?1:0,ne=(s,r,e)=>{var l,h,o,p;const g=!((l=e.get(s.id))!=null&&l.isLoading),i=!((h=e.get(r.id))!=null&&h.isLoading);if(g&&!i)return-1;if(!g&&i)return 1;if(!g&&!i)return 0;const u=!((o=e.get(s.id))!=null&&o.hasResults),m=!((p=e.get(r.id))!=null&&p.hasResults);return u&&!m?1:m&&!u?-1:0},ie=1e3,ce=H.memo(({source:s,onSearchRequestFinished:r,searchString:e,emptyQuery:g,mode:i})=>{var L,y;const{t:u}=F(),{id:m,displayName:l,lang:h}=s,[o,p]=T.useSourceSearch(m,e!=null?e:"",void 0,1,{skipRequest:!e,addAbortSignal:!0}),{data:S,isLoading:c,error:x,abortRequest:w}=p[0],j=(y=(L=S==null?void 0:S.fetchSourceManga)==null?void 0:L.mangas)!=null?y:[],d=!c&&!j.length;n.useEffect(()=>{r(s,c,!d,!e)},[c,d,e]);let f;return x?f=u("search.error.label.source_search_failed"):d&&(f=u("manga.error.label.no_mangas_found")),n.useEffect(()=>()=>{w(new Error("SourceSearchPreview(".concat(m,", ").concat(l,"): search string changed")))},[e]),!c&&!e||g?null:t.jsxs(t.Fragment,{children:[t.jsx(se,{sx:{margin:"10px"},children:t.jsxs(re,{component:I,to:"/sources/".concat(m,"?query=").concat(e),sx:{p:3},children:[t.jsx(v,{variant:"h5",children:l}),t.jsx(v,{variant:"caption",children:Z(h)})]})}),f?t.jsx(O,{sx:{alignItems:"start",height:void 0},noFaces:!0,message:f,messageExtra:x&&x.message,retry:x?()=>o(1).catch(P("SourceSearchPreview(".concat(s.id,")::refetch"))):void 0}):t.jsx(te,{mangas:j,isLoading:c,hasNextPage:!1,loadMore:()=>{},horizontal:!0,noFaces:!0,message:f,inLibraryIndicator:!0,mode:i})]})}),We=()=>{var R;const{t:s}=F(),{setTitle:r,setAction:e}=n.useContext(Q),{pathname:g,state:i}=V(),u=g.startsWith("/migrate/source"),m=i==null?void 0:i.mangaTitle,[l]=Y("query",K),h=A(l,ie),[o,p]=B("shownSourceLangs",X()),[S]=B("showNsfw",!0),{data:c,loading:x,error:w,refetch:j}=T.useGetSourceList({notifyOnNetworkStatusChange:!0}),d=(R=c==null?void 0:c.sources.nodes)!=null?R:[],[f,L]=n.useState(new Map),y=A(f,500),N=n.useMemo(()=>[...d].sort(oe),[d]),b=n.useMemo(()=>N.filter(a=>o.includes(a.lang)),[N,o]),M=n.useMemo(()=>b.filter(a=>S||!a.isNsfw),[b,S]),q=n.useMemo(()=>[...M].sort((a,E)=>ne(a,E,y)),[M,y]),D=n.useCallback(({id:a},E,$,k)=>{L(G=>{const C=new Map(G);return C.set(a,{isLoading:E,hasResults:$,emptySearch:k}),C})},[L]);return n.useEffect(()=>(r(s(u?"migrate.search.title":"search.title.global_search",{title:m})),e(t.jsxs(t.Fragment,{children:[t.jsx(J,{isClosable:!1}),t.jsx(ee,{shownLangs:o,setShownLangs:p,allLangs:ae(d),forcedLangs:_()})]})),()=>{r(""),e(null)}),[s,o,p,d]),n.useEffect(()=>{const a=_().filter(E=>!o.includes(E));p([...o,...a])},[]),x?t.jsx(z,{}):w?t.jsx(W,{message:s("global.error.label.failed_to_load_data"),messageExtra:w.message,retry:()=>j().catch(P())}):t.jsx(t.Fragment,{children:q.map(a=>t.jsx(ce,{source:a,onSearchRequestFinished:D,searchString:h,emptyQuery:!l,mode:u?"migrate.select":"source"},a.id))})};export{We as SearchAll};
