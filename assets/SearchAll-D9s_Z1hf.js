import{av as H,u as P,f as o,c as T,j as s,C as I,a as O,L as Q,T as v,aF as V,m as q,N as W,aG as z,g as B,l as J,E as K,B as A}from"./index-BqfOIPl3.js";import{u as U,A as X,S as Y}from"./AppbarSearch-DXn0uf61.js";import{s as _,l as Z,a as ee}from"./Languages-D1Basbdg.js";import{t as se,L as re}from"./LangSelect-BZEBix6U.js";import{u as F}from"./useDebounce-Bmzkw3pT.js";import{B as te}from"./BaseMangaGrid-B9PATJ1E.js";import"./useManageMangaLibraryState-Cdmgg8eI.js";import"./Trackers-D4pSmk7a.js";import"./Avatar-D30mYUuf.js";import"./CheckCircle-B13X21_l.js";import"./Mangas-BWA4Hfs9.js";import"./ListPreference-C9KIXsXp.js";import"./NumberSetting-C13ap4r2.js";import"./useMobilePicker-CSEmecje.js";import"./Chip-D-hCknsk.js";import"./SelectSetting-CHUrozR2.js";import"./ThreeStateCheckboxInput-DHsFs-fd.js";import"./FilterList-D3FWzKZG.js";import"./cloneObject-DrOPTG0J.js";import"./Switch-BocleEkq.js";import"./MangaGrid-Dq1nOQoE.js";import"./Sync-CRef-nH0.js";import"./PlayArrow-CePlc-CD.js";import"./StyledFab-Dk9nRTo3.js";function ae(r){const t=[];return r.forEach(e=>{t.indexOf(e.lang)===-1&&t.push(e.lang)}),t.sort(Z),t}const oe=(r,t)=>r.displayName<t.displayName?-1:r.displayName>t.displayName?1:0,ne=(r,t,e)=>{var d,S,n,u;const f=!((d=e.get(r.id))!=null&&d.isLoading),c=!((S=e.get(t.id))!=null&&S.isLoading);if(f&&!c)return-1;if(!f&&c)return 1;if(!f&&!c)return 0;const l=!((n=e.get(r.id))!=null&&n.hasResults),m=!((u=e.get(t.id))!=null&&u.hasResults);return l&&!m?1:m&&!l?-1:0},ie=1e3,ce=H.memo(({source:r,onSearchRequestFinished:t,searchString:e,emptyQuery:f,mode:c})=>{var w,b;const{t:l}=P(),{id:m,displayName:d,lang:S}=r,n=o.useRef(e),u=o.useRef(()=>{});n.current!==e&&(n.current=e,u.current(new Error("SourceSearchPreview(".concat(m,", ").concat(d,"): search string changed"))));const[g,R]=T.useSourceSearch(m,e!=null?e:"",void 0,1,{skipRequest:!e,addAbortSignal:!0}),{data:L,isLoading:h,error:i,abortRequest:M}=R[0];u.current=M;const E=(b=(w=L==null?void 0:L.fetchSourceManga)==null?void 0:w.mangas)!=null?b:[],y=!i&&!h&&!E.length;o.useEffect(()=>{t(r,h,!y,!e)},[h,y,e]);let p;return i?p=l("search.error.label.source_search_failed"):y&&(p=l("manga.error.label.no_mangas_found")),!h&&!e||f?null:s.jsxs(s.Fragment,{children:[s.jsx(I,{sx:{mb:1},children:s.jsxs(O,{component:Q,to:"/sources/".concat(m,"?query=").concat(e),sx:{p:3},children:[s.jsx(v,{variant:"h5",children:d}),s.jsx(v,{variant:"caption",children:se(S)})]})}),p?s.jsx(V,{sx:{alignItems:"start",height:void 0},noFaces:!0,message:p,messageExtra:i&&i.message,retry:i?()=>g(1).catch(q("SourceSearchPreview(".concat(r.id,")::refetch"))):void 0}):s.jsx(te,{gridWrapperProps:{sx:{px:0}},mangas:E,isLoading:h,hasNextPage:!1,loadMore:()=>{},horizontal:!0,noFaces:!0,message:p,inLibraryIndicator:!0,mode:c})]})}),Fe=()=>{const{t:r}=P(),{setTitle:t,setAction:e}=o.useContext(W),{pathname:f,state:c}=z(),l=f.startsWith("/migrate/source"),m=c==null?void 0:c.mangaTitle,[d]=U("query",Y),S=F(d,ie),[n,u]=B("shownSourceLangs",ee()),[j]=B("showNsfw",!0),{data:g,loading:R,error:L,refetch:h}=T.useGetSourceList({notifyOnNetworkStatusChange:!0}),i=o.useMemo(()=>{var a;return(a=g==null?void 0:g.sources.nodes)!=null?a:[]},[g==null?void 0:g.sources.nodes]),[M,E]=o.useState(new Map),y=F(M,500),p=o.useMemo(()=>[...i].sort(oe),[i]),w=o.useMemo(()=>p.filter(a=>n.includes(a.lang)),[p,n]),b=o.useMemo(()=>w.filter(a=>j||!a.isNsfw),[w,j]),N=o.useMemo(()=>[...b].sort((a,x)=>ne(a,x,y)),[b,y]),D=o.useCallback(({id:a},x,G,$)=>{E(k=>{const C=new Map(k);return C.set(a,{isLoading:x,hasResults:G,emptySearch:$}),C})},[E]);return o.useLayoutEffect(()=>(t(r(l?"migrate.search.title":"search.title.global_search",{title:m})),e(s.jsxs(s.Fragment,{children:[s.jsx(X,{isClosable:!1}),s.jsx(re,{shownLangs:n,setShownLangs:u,allLangs:ae(i),forcedLangs:_()})]})),()=>{t(""),e(null)}),[r,n,u,i]),o.useEffect(()=>{const a=_().filter(x=>!n.includes(x));u([...n,...a])},[]),R?s.jsx(J,{}):L?s.jsx(K,{message:r("global.error.label.failed_to_load_data"),messageExtra:L.message,retry:()=>h().catch(q())}):s.jsx(A,{sx:{p:1},children:N.map((a,x)=>s.jsx(A,{sx:{pb:x+1!==N.length?2:0},children:s.jsx(ce,{source:a,onSearchRequestFinished:D,searchString:S,emptyQuery:!d,mode:l?"migrate.select":"source"})},a.id))})};export{Fe as SearchAll};
