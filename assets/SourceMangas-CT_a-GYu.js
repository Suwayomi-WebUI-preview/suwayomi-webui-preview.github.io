import{d as ge,z as me,j as e,r as De,i as Re,a4 as T,T as he,a5 as Ge,B as I,aP as fe,a7 as xe,S as H,c as S,be as M,aD as qe,u as Se,b as w,P as Ue,f as X,I as be,R as Ne,_ as Be,$ as ze,aJ as He,aK as Ve,aL as We,h as z,bb as Qe,ba as Je,bf as Ke,bg as Ye,E as Z,N as Xe,a8 as Ze,e as et,az as pe,l as tt,bh as B,bi as at,a as D,bj as st,bk as rt,bl as nt,bm as ot,m as it}from"./index-G18IN795.js";import{d as lt,u as ct,A as ut,S as dt}from"./AppbarSearch-DfQmMKVj.js";import{b as je,a as ve,d as pt}from"./ExpandMore-D9jyfM8g.js";import{d as Ce}from"./FilterList-DwS30TWe.js";import{G as gt}from"./GridLayouts-C2EZYG2-.js";import{d as mt}from"./Delete-DVT59Tyv.js";import{S as ht,O as ft}from"./SortRadioInput-p_JcNxWy.js";import{C as xt}from"./CheckboxInput-Z-_HgYvB.js";import{a as ye,I as Te,S as St,b as bt,T as jt}from"./TextField-Bws0qK-H.js";import{C as _e}from"./Collapse-xJLzclEC.js";import{u as vt}from"./useDebounce-Bp3CcvVD.js";import{I as Ct}from"./InputAdornment-Be-wuiYS.js";import{T as yt}from"./ThreeStateCheckboxInput-Z37WI6oh.js";import{S as Tt}from"./StyledFab-BRQd5m1b.js";import{o as _t}from"./useManageMangaLibraryState-TRhv5jbt.js";import{C as Ft}from"./Chip-5gnAzm2l.js";import{B as Et}from"./BaseMangaGrid-Jr7pC-ID.js";import{g as Lt}from"./MangaGrid-CwNcWk2X.js";import{E as kt,a as It}from"./EmptyViewAbsoluteCentered-BYw38H0A.js";import{L as Mt}from"./Link-COiAf_Ie.js";import"./Checkbox-D4S952Xx.js";import"./SwitchBase-Bw-7GSmT.js";import"./ListPreference-DxuT2Euq.js";import"./Trackers-D4pSmk7a.js";import"./Card-BuKIIboA.js";import"./CardContent-5o4qcQ3_.js";import"./Avatar-CmQ0qMBk.js";import"./Info-B4mhTGOz.js";import"./CheckCircle-BL8HOtNV.js";import"./SpinnerImage-Bt-_wxc3.js";import"./Refresh-DbpC5PTI.js";import"./TypographyMaxLines-B6UUi4xn.js";import"./Mangas-D4rvQAR7.js";import"./Chapters-_zzpCI-k.js";import"./CardActionArea-DvFKKWYE.js";import"./NumberSetting-CHkyDFFa.js";import"./useMobilePicker-B22eqTb9.js";import"./SelectSetting-yfJQ6hxN.js";import"./Select-DszgPRW6.js";import"./index-CfHvLnxp.js";import"./Download-C4l022Ez.js";import"./Sync-WhRUvYtE.js";import"./PlayArrow-Cl8hR9f2.js";function $t(){const[t,s]=ge("source-grid-layout",me.Compact);return e.jsx(gt,{gridLayout:t,onChange:s})}var ee={},At=Re;Object.defineProperty(ee,"__esModule",{value:!0});var Fe=ee.default=void 0,Pt=At(De()),Ot=e;Fe=ee.default=(0,Pt.default)((0,Ot.jsx)("path",{d:"M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3m3-10H5V5h10z"}),"Save");const wt=t=>{const{state:s,name:n,position:o,group:a,updateFilterValue:l,update:r}=t,[c,i]=T.useState(s),f=u=>{i(u.target.checked);const g=r.filter(b=>!(o===b.position&&a===b.group));l([...g,{type:"checkBoxState",position:o,state:u.target.checked,group:a}])};return s!==void 0?e.jsx(xt,{label:n,checked:c,onChange:f}):null},Dt=({name:t})=>e.jsx(he,{sx:{mt:2},variant:"subtitle2",children:t},t);function Rt(t,s,n,o,a,l,r){const[c,i]=T.useState(n);if(t){const f=g=>{const b=t.indexOf("".concat(g.target.value));i(b);const d=l.filter(p=>!(o===p.position&&r===p.group));a([...d,{type:"selectState",position:o,state:b,group:r}])},u=t.map(g=>e.jsx(Ge,{value:g,children:g},"".concat(s," ").concat(g)));return e.jsxs(ye,{sx:{my:1},variant:"standard",children:[e.jsx(Te,{children:s}),e.jsx(St,{name:s,value:t[c],label:s,onChange:f,children:u})]})}return null}const Gt=({values:t,name:s,state:n,position:o,updateFilterValue:a,update:l,group:r})=>Rt(t,s,n,o,a,l,r),qt=t=>{const{values:s,name:n,state:o,position:a,group:l,updateFilterValue:r,update:c}=t,[i,f]=T.useState(o),[u,g]=T.useState(!1),b=()=>{g(!u)};if(s){const d=p=>{const m=i;m.index===p?m.ascending=!m.ascending:m.ascending=!0,m.index=p,f(m);const v=c.filter(x=>!(a===x.position&&l===x.group));r([...v,{type:"sortState",position:a,state:m,group:l}])};return e.jsxs(I,{sx:{mx:-2},children:[e.jsxs(fe,{onClick:b,children:[e.jsx(xe,{primary:n}),u?e.jsx(je,{}):e.jsx(ve,{})]}),e.jsx(_e,{in:u,children:e.jsx(H,{sx:{mx:4},children:s.map((p,m)=>e.jsx(ht,{label:p,checked:i.index===m,sortDescending:!i.ascending,onClick:()=>d(m)},"".concat(n," ").concat(p)))})})]})}return null},Ut=t=>{const{state:s,name:n,position:o,group:a,updateFilterValue:l,update:r}=t,[c,i]=T.useState(s||""),f=vt(c,500);return S.useEffect(()=>{const u=r.filter(g=>!(o===g.position&&a===g.group));l([...u,{type:"textState",position:o,state:f,group:a}])},[f]),s!==void 0?e.jsxs(ye,{sx:{my:1},variant:"standard",children:[e.jsx(Te,{children:n}),e.jsx(bt,{name:n,value:c,onChange:({target:{value:u}})=>i(u),endAdornment:e.jsx(Ct,{position:"end",children:e.jsx(lt,{})})})]}):null},Nt=t=>{switch(t){case M.Ignore:return 0;case M.Include:return 1;case M.Exclude:return 2;default:throw new Error("Unexpected TriState ".concat(t))}},Bt=t=>{switch(t){case 0:return M.Ignore;case 1:return M.Include;case 2:return M.Exclude;default:throw new Error("Unexpected state number ".concat(t))}},zt=t=>{const{state:s,name:n,position:o,group:a,updateFilterValue:l,update:r}=t,[c,i]=T.useState(Nt(s)),f=u=>{const g=u===void 0?0:u?1:2;i(g);const b=r.filter(d=>!(o===d.position&&a===d.group));l([...b,{type:"triState",position:o,state:Bt(g),group:a}])};return s!==void 0?e.jsx(yt,{label:n,checked:[void 0,!0,!1][c],onChange:u=>f(u)}):null},Ht=t=>{const{state:s,name:n,position:o,updateFilterValue:a,update:l}=t,[r,c]=T.useState(!1);return e.jsxs(I,{sx:{mx:-2},children:[e.jsxs(fe,{onClick:()=>c(!r),children:[e.jsx(xe,{primary:n}),r?e.jsx(je,{}):e.jsx(ve,{})]}),e.jsx(_e,{in:r,children:e.jsx(H,{sx:{mx:4},children:e.jsx(Ee,{sourceFilter:s,group:o,updateFilterValue:a,update:l})})})]})},Vt=({name:t})=>e.jsx(qe,{sx:{my:1},textAlign:"center",children:t},t);function Ee({sourceFilter:t,group:s,updateFilterValue:n,update:o}){return e.jsx(H,{children:t.map((a,l)=>{var c,i;let r=o.find(f=>f.group===s&&f.position===l);switch(r=r&&r.state,a.type){case"CheckBoxFilter":return e.jsx(wt,{name:a.name,state:r!=null?r:a.CheckBoxFilterDefault,position:l,group:s,updateFilterValue:n,update:o},"filters ".concat(a.name));case"GroupFilter":return e.jsx(Ht,{name:a.name,state:a.filters,position:l,updateFilterValue:n,update:o},"filters ".concat(a.name));case"HeaderFilter":return e.jsx(Dt,{name:a.name},"filters ".concat(a.name));case"SelectFilter":return e.jsx(Gt,{name:a.name,values:a.values,state:r!=null?parseInt(r,10):a.SelectFilterDefault,position:l,group:s,updateFilterValue:n,update:o},"filters ".concat(a.name));case"SeparatorFilter":return e.jsx(Vt,{name:a.name},"filters ".concat(a.name));case"SortFilter":return e.jsx(qt,{name:a.name,values:a.values,state:r!=null?r:{ascending:(c=a.SortFilterDefault)==null?void 0:c.ascending,index:(i=a.SortFilterDefault)==null?void 0:i.index},position:l,group:s,updateFilterValue:n,update:o},"filters ".concat(a.name));case"TextFilter":return e.jsx(Ut,{name:a.name,state:r!=null?r:a.TextFilterDefault,position:l,group:s,updateFilterValue:n,update:o},"filters ".concat(a.name));case"TriStateFilter":return e.jsx(zt,{name:a.name,state:r!=null?r:a.TriStateFilterDefault,position:l,group:s,updateFilterValue:n,update:o},"filters ".concat(a.name));default:throw new Error('Unknown source filter "'.concat(a,'"'))}})},"filters ".concat(s))}function Wt({savedSearches:t={},selectSavedSearch:s,updateSavedSearches:n,sourceFilter:o,updateFilterValue:a,resetFilterValue:l,setTriggerUpdate:r,update:c}){const{t:i}=Se(),[f,u]=S.useState(!1),[g,b]=S.useState(""),d=Object.keys(t),p=!!d.length;function m(){l(0),u(!1)}function v(){r(0),u(!1)}return e.jsxs(e.Fragment,{children:[e.jsxs(Tt,{onClick:()=>u(!f),variant:"extended",color:"primary",children:[e.jsx(Ce,{}),i("global.button.filter")]}),e.jsxs(ft,{open:f,onClose:()=>u(!1),children:[e.jsxs(I,{sx:{p:2,pb:p?void 0:0},children:[e.jsxs(I,{sx:{display:"flex",pb:1},children:[e.jsx(w,{onClick:m,children:i("global.button.reset")}),e.jsx(Ue,{variant:"dialog",popupId:"source-browse-save-search",children:x=>e.jsxs(e.Fragment,{children:[e.jsx(X,{title:i("source.filter.save_search.label.save"),children:e.jsx(be,{sx:{marginLeft:"auto"},...Ne(x),children:e.jsx(Fe,{})})}),e.jsxs(Be,{...ze(x),maxWidth:"xs",fullWidth:!0,children:[e.jsx(He,{children:i("source.filter.save_search.dialog.label.title")}),e.jsx(Ve,{children:e.jsx(jt,{sx:{width:"100%"},value:g,onChange:y=>b(y.target.value),slotProps:{htmlInput:{maxLength:50}}})}),e.jsxs(We,{children:[e.jsx(w,{onClick:()=>{b(""),x.close()},children:i("global.button.cancel")}),e.jsx(w,{onClick:()=>{n(g,"create"),b(""),x.close()},children:i("global.button.ok")})]})]})]})}),e.jsx(w,{variant:"contained",onClick:v,children:i("global.button.submit")})]}),p&&e.jsxs(e.Fragment,{children:[e.jsx(he,{sx:{pb:1},children:"Saved searches"}),e.jsx(H,{sx:{flexDirection:"row"},children:d.map(x=>e.jsx(Ft,{label:x,onClick:()=>{u(!1),s(x)},onDelete:()=>{_t({title:i("global.label.are_you_sure"),message:i("source.filter.save_search.dialog.label.delete",{name:x}),actions:{confirm:{title:i("global.button.delete")}}}).then(()=>n(x,"delete")).catch(z())},deleteIcon:e.jsx(X,{title:i("source.filter.save_search.label.delete"),children:e.jsx(mt,{})}),variant:"outlined"}))})]})]}),e.jsx(I,{sx:{pb:2,mx:2},children:e.jsx(Ee,{sourceFilter:o,updateFilterValue:a,group:void 0,update:c})})]})]})}const Qt={savedSearches:void 0},Le=t=>({...t,savedSearches:t.savedSearches?JSON.stringify(t.savedSearches):void 0}),Jt=t=>{var s;return{...t,savedSearches:(s=Ke(t.savedSearches))!=null?s:void 0}},Kt=(t,s)=>Jt(Qe("source",{...t,meta:Je(t.meta)},Le(Qt),!0,s)),Yt=t=>{const s=Kt(t,S.useEffect);return S.useMemo(()=>s,[t])},Xt=async(t,s,n)=>Ye(t,[[s,Le({[s]:n})[s]]]),Zt=(t,s=z())=>(n,o)=>Xt(t,n,o).catch(s),ea={id:"-1"},ta=Z("div")(({theme:t})=>({display:"flex",position:"sticky",width:"100%",zIndex:1,padding:t.spacing(1),gap:t.spacing(1),backgroundColor:t.palette.background.default})),Y=Z(w)(()=>({})),aa=Z(I)(()=>({minHeight:"100%",position:"relative"}));var sa=(t=>(t[t.POPULAR=0]="POPULAR",t[t.LATEST=1]="LATEST",t[t.SEARCH=2]="SEARCH",t))(sa||{});const ra={0:"manga.error.label.no_mangas_found",1:"manga.error.label.no_mangas_found",2:"manga.error.label.no_matches"},na=t=>{const s={},n=[];return t.forEach(o=>{!!s[o.id]||(s[o.id]=o,n.push(o))}),n},oa=(t,s,n,o,a,l)=>{var d;let r;switch(s){case 0:r=D.useGetSourcePopularMangas(t,a);break;case 1:r=D.useGetSourceLatestMangas(t,a);break;case 2:r=D.useSourceSearch(t,n!=null?n:"",o.map(p=>{const{position:m,state:v,group:x}=p;return x!==void 0?{position:x,groupChange:{position:m,[p.type]:v}}:{position:m,[p.type]:v}}),a);break;default:throw new Error('Unknown ContentType "'.concat(s,'"'))}const c=r[1],i=c.findLastIndex(p=>{var m;return!!((m=p.data)!=null&&m.fetchSourceManga)}),f=c[i],u=c.slice(-1)[0].isLoading;let g=!u;const b=S.useMemo(()=>{let p=[];return c.forEach((m,v)=>{var A,C,R;const x=(R=(C=(A=m.data)==null?void 0:A.fetchSourceManga)==null?void 0:C.mangas)!=null?R:[],y=x.filter(_=>!l||!_.inLibrary),$=na([...p,...y]);g=!u&&c.length===v+1&&!y.length&&!!x.length,p=$}),p},[c,l]);return i===-1?[r[0],{...r[1][r[1].length-1],filteredOutAllItemsOfFetchedPage:g}]:[r[0],{...c[c.length-1],data:{...f.data,fetchSourceManga:{...f.data.fetchSourceManga,hasNextPage:c.length>i+1?!1:!!((d=f.data.fetchSourceManga)!=null&&d.hasNextPage),mangas:b}},filteredOutAllItemsOfFetchedPage:g}]};function Za(){var oe,ie,le,ce,ue;const{t}=Se(),{setTitle:s,setAction:n,appBarHeight:o}=S.useContext(Xe),{sourceId:a}=Ze(),l=et(),r=pe(),{key:c,state:i}=r,{contentType:f=0,clearCache:u=!1}=(oe=pe().state)!=null?oe:{},{settings:{hideLibraryEntries:g}}=tt(),[b]=ge("source-grid-layout",me.Compact),[d]=ct("query",dt),[p,m]=B("source-mangas-".concat(a,"-filters"),[]),[v,x]=B("source-mangas-location-".concat(c,"-").concat(a,"-filters"),p!=null?p:[]),[y,$]=S.useState(v),[te,A]=B("source-mangas-".concat(a,"-content-type"),f),[C,R]=B("source-mangas-location-".concat(c,"-").concat(a,"-content-type"),d?2:te),_=S.useCallback(()=>{at.session.setItem(Lt(r),void 0,!1),window.scrollTo(0,0)},[c]),ae=S.useRef(d),se=S.useRef(()=>{});ae.current!==d&&C===2&&(ae.current=d,se.current(new Error("SourceMangas(".concat(a,"): search string changed"))),_()),S.useEffect(()=>()=>{m(void 0),A(void 0)},[a]);const V=j=>{m(j),x(j),_()},re=j=>{A(j),R(j)},[G,{data:F,error:E,isLoading:W,size:P,abortRequest:ke,filteredOutAllItemsOfFetchedPage:Q}]=oa(a,C,d,v,1,g);se.current=ke;const J=W||Q,q=(le=(ie=F==null?void 0:F.fetchSourceManga)==null?void 0:ie.mangas)!=null?le:[],U=!!((ce=F==null?void 0:F.fetchSourceManga)!=null&&ce.hasNextPage),{data:K}=D.useGetSource(st,a),h=K==null?void 0:K.source,Ie=(ue=h==null?void 0:h.filters)!=null?ue:[],{savedSearches:L={}}=Yt(h!=null?h:ea),ne=Zt(h!=null?h:{id:"-1"},()=>it(t("global.error.label.failed_to_save_changes"),"error")),Me=S.useCallback(j=>{const{query:k,filters:O}=L[j];O&&($(O),V(O)),l({pathname:"",search:k?"query=".concat(k):void 0},{state:{...i,contentType:2}})},[L,i]),$e=S.useCallback((j,k)=>{if(k==="delete"){const de={...L};delete de[j],ne("savedSearches",de);return}const O={...L,[j]:{query:d!=null?d:void 0,filters:v}};ne("savedSearches",O)},[L,d,v]),Ae=J?void 0:t(ra[C]),Pe=a==="0"?e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:[t("source.local_source.label.checkout")," "]}),e.jsx(Mt,{href:"https://github.com/Suwayomi/Suwayomi-Server/wiki/Local-Source",target:"_blank",rel:"noreferrer",children:t("source.local_source.label.guide")})]}):void 0,N=S.useCallback((j,k)=>{re(j),_(),d&&!k&&l({pathname:""},{state:{...i,contentType:j}})},[re,d,_]);!!d&&C!==2&&N(2,d);const Oe=S.useCallback(()=>{U&&G(P+1)},[P,U,C]),we=()=>{$([]),V([])};return S.useEffect(()=>{Q&&U&&!W&&G(P+1)},[Q,W]),S.useEffect(()=>{!u||!ot.REVALIDATION.includes(a)||D.clearBrowseCacheFor(a)},[u]),S.useLayoutEffect(()=>{var j;return s((j=h==null?void 0:h.displayName)!=null?j:t("source.title_one")),n(e.jsxs(e.Fragment,{children:[e.jsx(ut,{}),e.jsx($t,{}),(h==null?void 0:h.isConfigurable)&&e.jsx(X,{title:t("settings.title"),children:e.jsx(be,{onClick:()=>l("/sources/".concat(a,"/configure/")),"aria-label":"display more actions",edge:"end",color:"inherit",size:"large",children:e.jsx(rt,{})})})]})),()=>{s(""),n(null)}},[t,h]),e.jsxs(aa,{children:[e.jsxs(ta,{sx:{top:"".concat(o,"px")},children:[e.jsx(Y,{variant:C===0?"contained":"outlined",startIcon:e.jsx(pt,{}),onClick:()=>N(0),children:t("global.button.popular")}),(h==null?void 0:h.supportsLatest)===void 0||h.supportsLatest?e.jsx(Y,{disabled:!(h!=null&&h.supportsLatest),variant:C===1?"contained":"outlined",startIcon:e.jsx(nt,{}),onClick:()=>N(1),children:t("global.button.latest")}):null,e.jsx(Y,{variant:C===2?"contained":"outlined",startIcon:e.jsx(Ce,{}),onClick:()=>N(2,d),children:t("global.button.filter")})]}),(J||!E||!!E&&!!q.length)&&e.jsx(Et,{gridWrapperProps:{sx:{px:1,pb:1}},mangas:q,hasNextPage:U,loadMore:Oe,message:Ae,messageExtra:Pe,isLoading:J,gridLayout:b,mode:"source",inLibraryIndicator:!0},C),E&&!q.length&&e.jsx(kt,{message:t("global.error.label.failed_to_load_data"),messageExtra:E.message,retry:()=>G(P).catch(z())}),E&&!!q.length&&e.jsx(It,{message:t("global.error.label.failed_to_load_data"),messageExtra:E.message,retry:()=>G(P).catch(z())}),C===2&&e.jsx(Wt,{savedSearches:L,selectSavedSearch:Me,updateSavedSearches:$e,sourceFilter:Ie,updateFilterValue:$,setTriggerUpdate:()=>{V(y)},resetFilterValue:we,update:y})]})}export{sa as SourceContentType,Za as SourceMangas};
