import{c as r,v as Re,j as t,B as V,r as ce,i as le,J as rt,aq as wt,ar as Pt,as as Rt,at as yt,au as Xe,C as de,u as nt,k as Et,av as bt,e as at,aw as st,ax as Lt,ay as St,f as ne,I as ae,T as Dt,az as kt,a5 as jt,aA as Tt,a3 as Ue,aB as _t,a6 as Ot,a as J,aC as Nt,aD as Ke,l as qe,N as At,m as Ge,M as It,a8 as $t,h as Q,aE as Mt,aF as Wt}from"./index-C4qwXpmq.js";import{P as he,R as zt,u as Ft,g as Bt}from"./ReaderSettingsOptions-CrbD-DOV.js";import{S as Ye}from"./Select-DPwqeTtk.js";import{C as Ht}from"./CustomIconButton-CkgtKqX9.js";import{D as q,C as _}from"./Chapters-C1Oi359V.js";import{C as Vt}from"./Collapse-Bo46tBQs.js";import{a as Ze}from"./TextField-BNsfONQP.js";import{u as Xt}from"./useDebounce-D4a1r6K7.js";import{E as Je}from"./EmptyViewAbsoluteCentered-B72QzW5m.js";import"./NumberSetting-CJzMbVkK.js";import"./Info-B1nwnUwY.js";import"./InputAdornment-CXJi4Hxk.js";import"./SpinnerImage-CjUcgnVH.js";import"./Refresh-8ASZ8-V5.js";import"./Switch-D4ja6VhN.js";import"./SwitchBase-B0snjHZd.js";const Ut=s=>{for(let i=0;i<s.children.length;i++){const o=s.children.item(i);if(o){const{left:f,right:c}=o.getBoundingClientRect();if(f<=window.innerWidth/2&&c>window.innerWidth/2)return i}}return-1},Kt=5,qt=()=>window.innerWidth+window.scrollX>=document.body.scrollWidth-Kt,Gt=()=>window.scrollX<=0;function Yt(s){const{pages:i,curPage:o,initialPage:f,settings:c,setCurPage:u,prevChapter:D,nextChapter:R}=s,g=r.useRef(f),p=r.useRef(null),l=r.useRef([]);function S(){var e;o<i.length-1?((e=l.current[o+1])==null||e.scrollIntoView({inline:"center"}),u(d=>d+1)):c.loadNextOnEnding&&R()}function h(){var e;o>0?((e=l.current[o-1])==null||e.scrollIntoView({inline:"center"}),u(o-1)):o===0&&D()}function m(){c.readerType==="ContinuesHorizontalLTR"?h():S()}function j(){c.readerType==="ContinuesHorizontalLTR"?S():h()}const E=r.useRef(0);function n(e){window.scrollBy(E.current-e.pageX,0)}function a(e){var d;E.current=e.pageX,(d=p.current)==null||d.addEventListener("mousemove",n)}function y(){var e;(e=p.current)==null||e.removeEventListener("mousemove",n)}function O(e){e.clientX>=window.innerWidth*.85?j():e.clientX<=window.innerWidth*.15&&m()}function N(e){window.scrollBy({left:c.readerType==="ContinuesHorizontalLTR"?e.deltaY:e.deltaY*-1})}const v=()=>{c.readerType==="ContinuesHorizontalLTR"?window.scrollX+window.innerWidth>=document.body.scrollWidth&&R():c.readerType==="ContinuesHorizontalRTL"&&window.scrollX<=window.innerWidth&&R()};return Re(l.current[f],r.useCallback((e,d)=>{const P=l.current[f];P!=null&&P.offsetHeight&&(P.scrollIntoView({inline:"center"}),d.disconnect())},[l.current[f],f])),r.useEffect(()=>{var e,d;return(e=p.current)==null||e.addEventListener("mousedown",a),(d=p.current)==null||d.addEventListener("mouseup",y),()=>{var P,A;(P=p.current)==null||P.removeEventListener("mousedown",a),(A=p.current)==null||A.removeEventListener("mouseup",y)}},[p]),r.useEffect(()=>(c.loadNextOnEnding&&document.addEventListener("scroll",v),()=>{document.removeEventListener("scroll",v)}),[p,o,D,R]),r.useEffect(()=>{const e=()=>{if(!p.current)return;const d=Ut(p.current);d!==g.current&&(g.current=d,u(d)),(c.readerType==="ContinuesHorizontalLTR"?qt():Gt())&&(g.current=i.length-1,u(g.current))};return window.addEventListener("scroll",e),()=>window.removeEventListener("scroll",e)},[c.readerType]),t.jsx(V,{ref:p,sx:{display:"flex",flexDirection:c.readerType==="ContinuesHorizontalLTR"?"row":"row-reverse",justifyContent:c.readerType==="ContinuesHorizontalLTR"?"flex-start":"flex-end",width:"auto",height:"auto",overflowX:"visible",userSelect:"none"},onClick:O,onWheel:N,children:i.map(e=>t.jsx(he,{index:e.index,src:e.src,onImageLoad:()=>{},settings:c,ref:d=>{l.current[e.index]=d}},e.index))})}function Zt(s){const{settings:i,curPage:o,pageCount:f}=s;return t.jsx(V,{sx:{display:i.showPageNumber?"block":"none",position:"fixed",bottom:"50px",padding:"2px",paddingLeft:"4px",paddingRight:"4px",textAlign:"center",backgroundColor:"rgba(0, 0, 0, 0.3)",borderRadius:"10px"},children:"".concat(o+1," / ").concat(f)})}function Jt(s){const{pages:i,settings:o,setCurPage:f,initialPage:c,curPage:u,nextChapter:D,prevChapter:R}=s,g=r.useRef(null),p=n=>{f(n),window.scroll({top:0})};function l(){u<i.length-1?p(u+1):o.loadNextOnEnding&&D()}function S(){u>0?p(u-1):R()}function h(){o.readerType==="SingleLTR"?S():o.readerType==="SingleRTL"&&l()}function m(){o.readerType==="SingleLTR"?l():o.readerType==="SingleRTL"&&S()}function j(n){switch(n.key){case"Space":n.preventDefault(),l();break;case"ArrowRight":m();break;case"ArrowLeft":h();break}}function E(n){n.clientX>window.innerWidth/2?m():h()}return r.useEffect(()=>(document.addEventListener("keydown",j),()=>{document.removeEventListener("keydown",j)}),[g,u,o.readerType,R,D]),r.useEffect(()=>{setTimeout(()=>{p(c)},0)},[c]),t.jsx(V,{ref:g,sx:{display:"flex",flexDirection:"column",justifyContent:"center",width:"auto",height:"auto"},onClick:E,children:i.map(({index:n,src:a})=>t.jsx(he,{index:n,onImageLoad:()=>{},src:a,settings:o,display:n===u},a))})}const Qt=s=>s.height/s.width<1;function er(s){const{pages:i,settings:o,setCurPage:f,initialPage:c,curPage:u,nextChapter:D,prevChapter:R}=s,g=r.useRef(null),p=r.useRef([]),l=r.useRef([]),[S,h]=r.useState(Array(i.length).fill(!1)),[m,j]=r.useState(Array(i.length).fill(!1));function E(){const v=P=>f(P===-1?i.length-1:P);if(p.current[i.length-1]&&o.loadNextOnEnding){u===i.length-1||v(i.length-1),D();return}const d=p.current.findIndex((P,A)=>!P&&A>u);v(d)}function n(){const v=P=>f(Math.max(P,0));if(p.current[0]){!u||v(0),R();return}const d=[...p.current].slice(0,u).findLastIndex(P=>!P);v(d)}function a(){o.readerType==="DoubleLTR"?n():E()}function y(){o.readerType==="DoubleLTR"?E():n()}function O(v){switch(v.key){case"Space":v.preventDefault(),E();break;case"ArrowRight":y();break;case"ArrowLeft":a();break}}function N(v){v.clientX>window.innerWidth/2?y():a()}return r.useEffect(()=>(document.addEventListener("keydown",O),()=>{document.removeEventListener("keydown",O)}),[g,u,o.readerType,R,D,m,S]),r.useEffect(()=>{f(c)},[c]),t.jsx(V,{ref:g,onClick:N,children:t.jsx(V,{id:"display",sx:{display:"flex",flexDirection:o.readerType==="DoubleLTR"?"row":"row-reverse",justifyContent:"center",width:"auto",height:"auto"},children:i.map(({index:v,src:e})=>{const d=(()=>{let b=l.current[u];return b===void 0&&(b=Math.max(S.lastIndexOf(!0,u),0),m.slice(0,u).every(Boolean)&&(l.current[u]=b)),b>0?b+1:b})(),P=u-d,A=u===0,F=Number(o.offsetFirstPage)+Number(o.offsetFirstPage&&!P&&!A),U=!((P-F)%2),I=u+(U?1:-1),C=v===u,L=v===I,$=S[u],M=S[I],x=C||L&&!($||M);return p.current[v]=x,t.jsx(he,{index:v,src:e,onImageLoad:()=>{const b=new Image;b.onload=()=>{j(B=>B.toSpliced(v,1,!0)),h(B=>B.toSpliced(v,1,Qt(b)))},b.src=e},settings:o,display:x},e)})})})}const tr=s=>{for(let i=0;i<s.children.length;i++){const o=s.children.item(i);if(o){const{top:f,bottom:c}=o.getBoundingClientRect();if(f<=window.innerHeight&&c>1)return i}}return-1},rr=5,nr=.95,Qe=.25,ar="smooth",et=()=>window.innerHeight+window.scrollY>=document.body.offsetHeight-rr,sr=()=>window.scrollY<=0;function tt(s){const{pages:i,settings:o,setCurPage:f,initialPage:c,nextChapter:u,prevChapter:D}=s,R=r.useRef(c),g=r.useRef(null),p=r.useRef([]);r.useEffect(()=>{let n=!1;const a=()=>{if(g.current)if(et()){if(n)return;n=!0,R.current=i.length-1,f(R.current),o.loadNextOnEnding&&u()}else{n=!1;const y=tr(g.current);y!==R.current&&(R.current=y,f(y))}};return window.addEventListener("scroll",a),()=>{window.removeEventListener("scroll",a)}},[o.loadNextOnEnding,u]);const l=r.useRef(0),S=r.useRef(!1);function h(n){S.current=!0,window.scrollBy(0,l.current-n.pageY)}function m(n){var a;l.current=n.pageY,(a=g.current)==null||a.addEventListener("mousemove",h)}function j(){var n;(n=g.current)==null||n.removeEventListener("mousemove",h)}r.useEffect(()=>{var n,a;return(n=g.current)==null||n.addEventListener("mousedown",m),(a=g.current)==null||a.addEventListener("mouseup",j),()=>{var y,O;(y=g.current)==null||y.removeEventListener("mousedown",m),(O=g.current)==null||O.removeEventListener("mouseup",j)}},[g]);const E=r.useCallback((n,a=nr)=>{if(n==="down"&&et()){u();return}if(n==="up"&&sr()){D();return}window.scroll({top:window.scrollY+window.innerHeight*a*(n==="up"?-1:1),behavior:ar})},[u,D]);return r.useEffect(()=>{const n=a=>{switch(a.key){case"Space":a.preventDefault(),E(a.shiftKey?"up":"down");break;case"ArrowDown":a.preventDefault(),E(a.shiftKey?"up":"down",Qe);break;case"ArrowRight":a.preventDefault(),E(a.shiftKey?"up":"down");break;case"ArrowUp":a.preventDefault(),E(a.shiftKey?"down":"up",Qe);break;case"ArrowLeft":a.preventDefault(),E(a.shiftKey?"down":"up");break}};return document.addEventListener("keydown",n,!1),()=>{document.removeEventListener("keydown",n)}},[E]),Re(p.current[c],r.useCallback((n,a)=>{const y=p.current[c];y!=null&&y.offsetHeight&&(y.scrollIntoView(),a.disconnect())},[p.current[c],c])),t.jsx(V,{ref:g,sx:{display:"flex",flexDirection:"column",justifyContent:"center",width:"auto",height:"auto",userSelect:"none"},onClick:n=>{if(S.current){S.current=!1;return}E(n.clientX>window.innerWidth/2?"down":"up")},children:i.map(n=>t.jsx(he,{index:n.index,src:n.src,onImageLoad:()=>{},settings:o,ref:a=>{p.current[n.index]=a}},n.index))})}var ye={},or=le;Object.defineProperty(ye,"__esModule",{value:!0});var ot=ye.default=void 0,ir=or(ce()),cr=t;ot=ye.default=(0,ir.default)((0,cr.jsx)("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Close");var Ee={},lr=le;Object.defineProperty(Ee,"__esModule",{value:!0});var oe=Ee.default=void 0,dr=lr(ce()),ur=t;oe=Ee.default=(0,dr.default)((0,ur.jsx)("path",{d:"M15.41 16.59 10.83 12l4.58-4.59L14 6l-6 6 6 6z"}),"KeyboardArrowLeft");var be={},pr=le;Object.defineProperty(be,"__esModule",{value:!0});var ie=be.default=void 0,fr=pr(ce()),gr=t;ie=be.default=(0,fr.default)((0,gr.jsx)("path",{d:"M8.59 16.59 13.17 12 8.59 7.41 10 6l6 6-6 6z"}),"KeyboardArrowRight");var Le={},hr=le;Object.defineProperty(Le,"__esModule",{value:!0});var it=Le.default=void 0,xr=hr(ce()),mr=t;it=Le.default=(0,xr.default)((0,mr.jsx)("path",{d:"M7.41 8.59 12 13.17l4.59-4.58L18 10l-6 6-6-6z"}),"KeyboardArrowDown");var Se={},vr=le;Object.defineProperty(Se,"__esModule",{value:!0});var ct=Se.default=void 0,Cr=vr(ce()),wr=t;ct=Se.default=(0,Cr.default)((0,wr.jsx)("path",{d:"M7.41 15.41 12 10.83l4.59 4.58L18 14l-6-6-6 6z"}),"KeyboardArrowUp");const Pr={entering:{transform:"none"},entered:{transform:"none"}},Rr=r.forwardRef(function(i,o){const f=rt(),c={enter:f.transitions.duration.enteringScreen,exit:f.transitions.duration.leavingScreen},{addEndListener:u,appear:D=!0,children:R,easing:g,in:p,onEnter:l,onEntered:S,onEntering:h,onExit:m,onExited:j,onExiting:E,style:n,timeout:a=c,TransitionComponent:y=Rt,...O}=i,N=r.useRef(null),v=wt(N,Pt(R),o),e=C=>L=>{if(C){const $=N.current;L===void 0?C($):C($,L)}},d=e(h),P=e((C,L)=>{yt(C);const $=Xe({style:n,timeout:a,easing:g},{mode:"enter"});C.style.webkitTransition=f.transitions.create("transform",$),C.style.transition=f.transitions.create("transform",$),l&&l(C,L)}),A=e(S),F=e(E),H=e(C=>{const L=Xe({style:n,timeout:a,easing:g},{mode:"exit"});C.style.webkitTransition=f.transitions.create("transform",L),C.style.transition=f.transitions.create("transform",L),m&&m(C)}),U=e(j),I=C=>{u&&u(N.current,C)};return t.jsx(y,{appear:D,in:p,nodeRef:N,onEnter:P,onEntered:A,onEntering:d,onExit:H,onExited:U,onExiting:F,addEndListener:I,timeout:a,...O,children:(C,L)=>r.cloneElement(R,{style:{transform:"scale(0)",visibility:C==="exited"&&!p?"hidden":void 0,...Pr[C],...n,...R.props.style},ref:v,...L})})}),yr=de("div")({zIndex:10}),Er=de("div")(({theme:s})=>({position:"fixed",top:0,left:0,minWidth:"240px",maxWidth:"400px",height:"100vh",overflowY:"auto",backgroundColor:s.palette.background.default,"& header":{backgroundColor:s.palette.action.hover,display:"flex",alignItems:"center",padding:"".concat(s.spacing(1)," ").concat(s.spacing(3)),transition:"left 2s ease"}})),br=de("div")(({theme:s})=>({margin:"0 ".concat(s.spacing(2))})),Lr=de("div")({display:"flex",flexWrap:"wrap",alignContent:"center",alignItems:"center",justifyContent:"center"}),Sr=de("div")(({theme:s})=>({display:"grid",gridTemplateRows:"auto auto auto",gridTemplateColumns:"0fr 1fr 0fr",gridTemplateAreas:'"pre current next"',gridColumnGap:s.spacing(.5),margin:"".concat(s.spacing(1)," 0"),"& a":{textDecoration:"none",color:"inherit",display:"flex",flexWrap:"wrap",alignContent:"center"}}));function Dr(s){var te;const{t:i}=nt(),{setReaderNavBarWidth:o}=Et(),f=rt(),c=bt(),u=at(),D=st(),{prevDrawerOpen:R,prevSettingsCollapseOpen:g}=(te=D.state)!=null?te:{},p=r.useRef(null);Re(p,r.useCallback(()=>{var x;((x=p.current)==null?void 0:x.offsetWidth)!==void 0&&o(p.current.offsetWidth)},[p.current])),r.useLayoutEffect(()=>()=>o(0),[p]);const{settings:l,setSettingValue:S,manga:h,chapter:m,chapters:j,curPage:E,scrollToPage:n,openNextChapter:a,retrievingNextChapter:y}=s,O=Lt(),N=r.useMemo(()=>new Set(j.map(({scanlator:x})=>x)).size>1,[j]),[v,e]=r.useState(l.staticNav||R),[d,P]=r.useState(!0),[A,F]=r.useState(l.staticNav||R),[H,U]=r.useState(0),[I,C]=r.useState(g!=null?g:!0),L=y,$=(x,b,B)=>{P(x!=="staticNav"),S(x,b,B)},M=x=>{e(x),F(x)},X=()=>{const x=window.pageYOffset;Math.abs(x-H)>20&&(F(x>H),U(x))};return r.useEffect(()=>{d&&M(l.staticNav)},[l.staticNav]),r.useEffect(()=>{window.addEventListener("scroll",X);const x=document.querySelector("#root"),b=document.querySelector("#appMainContainer");return x.style.display="flex",x.style.flexDirection="column",b.style.display="none",()=>{x.style.display="block",b.style.display="block",window.removeEventListener("scroll",X)}},[X]),t.jsxs(yr,{children:[t.jsx(St,{direction:c("right","left"),in:v,timeout:200,appear:!1,mountOnEnter:!0,unmountOnExit:!0,children:t.jsxs(Er,{ref:p,children:[t.jsxs("header",{children:[!l.staticNav&&t.jsx(ne,{title:i("reader.button.close_menu"),children:t.jsx(ae,{edge:"start",color:"inherit","aria-label":"menu",onClick:()=>M(!1),size:"large",children:c(t.jsx(oe,{}),t.jsx(ie,{}))})}),t.jsx(Dt,{variant:"h6",component:"h1",sx:{textOverflow:"ellipsis",overflow:"hidden",py:1,flexGrow:1},children:m.name}),t.jsx(ne,{title:i("reader.button.exit"),children:t.jsx(ae,{edge:"start",color:"inherit","aria-label":"menu",onClick:O,size:"large",sx:{mr:-1},children:t.jsx(ot,{})})})]}),t.jsxs(kt,{ContainerComponent:"div",sx:{"& span":{fontWeight:"bold"}},children:[t.jsx(jt,{primary:i("reader.settings.title.reader_settings")}),t.jsxs(ae,{edge:"start",color:"inherit","aria-label":"menu",disableRipple:!0,disableFocusRipple:!0,onClick:()=>C(!I),size:"large",children:[I&&t.jsx(ct,{}),!I&&t.jsx(it,{})]})]}),t.jsx(Vt,{in:I,timeout:"auto",unmountOnExit:!0,children:t.jsx(zt,{setSettingValue:$,staticNav:l.staticNav,showPageNumber:l.showPageNumber,loadNextOnEnding:l.loadNextOnEnding,skipDupChapters:l.skipDupChapters,fitPageToWindow:l.fitPageToWindow,scalePage:l.scalePage,readerType:l.readerType,offsetFirstPage:l.offsetFirstPage,readerWidth:l.readerWidth})}),t.jsx(Tt,{sx:{my:1,mx:2}}),t.jsxs(br,{children:[t.jsxs(Lr,{children:[t.jsx("span",{children:i("reader.page_info.label.currently_on_page")}),t.jsx(Ze,{size:"small",sx:{mx:.5},disabled:L||m.pageCount===-1,children:t.jsx(Ye,{value:m.pageCount>-1?"".concat(E):"",displayEmpty:!0,onChange:({target:{value:x}})=>{n(Number(x))},children:Array(Math.max(0,m.pageCount)).fill(1).map((x,b)=>t.jsx(Ue,{value:b,children:b+1},"Page#".concat(b)))})}),t.jsx("span",{children:i("reader.page_info.label.of_max_pages",{maxPages:m.pageCount})})]}),t.jsxs(Sr,{children:[t.jsx(ne,{title:i("reader.button.previous_chapter"),children:t.jsx(ae,{sx:{gridArea:"pre"},disabled:L||m.sourceOrder<=1,onClick:()=>a(q.PREVIOUS),children:c(t.jsx(oe,{}),t.jsx(ie,{}))})}),t.jsx(Ze,{sx:{gridArea:"current"},size:"small",disabled:L||m.sourceOrder<1,children:t.jsx(Ye,{value:m.sourceOrder>=1?"".concat(m.sourceOrder):"",displayEmpty:!0,onChange:({target:{value:x}})=>{u("/manga/".concat(h.id,"/chapter/").concat(x),{replace:!0,state:{prevDrawerOpen:v,prevSettingsCollapseOpen:I}})},children:j.map(({id:x,sourceOrder:b,name:B,chapterNumber:ue,scanlator:re})=>t.jsx(Ue,{value:b,children:"#".concat(ue).concat(N&&re!=null?" (".concat(re,")"):""," | ").concat(B)},x))})}),t.jsx(ne,{title:i("reader.button.next_chapter"),children:t.jsx(ae,{sx:{gridArea:"next"},disabled:L||m.sourceOrder<1||m.sourceOrder>=h.chapters.totalCount,onClick:()=>a(q.NEXT),children:c(t.jsx(ie,{}),t.jsx(oe,{}))})})]})]})]})}),t.jsx(Rr,{in:!v,children:t.jsx(_t,{in:!A,children:t.jsx(ne,{title:i("reader.button.open_menu"),children:t.jsx(Ht,{sx:{position:"fixed",top:20,left:20,backgroundColor:"rgba(255, 255, 255, 0.75);",color:"black",...f.applyStyles("dark",{backgroundColor:"rgba(0, 0, 0, 0.75);",color:"white"})},size:"large",variant:"contained",onClick:()=>M(!0),children:c(t.jsx(ie,{}),t.jsx(oe,{}))})})})})]})}const se=s=>_.getFromCache(s,Mt,"CHAPTER_READER_FIELDS"),kr=s=>{switch(s){case"ContinuesVertical":case"Webtoon":return tt;case"SingleVertical":case"SingleRTL":case"SingleLTR":return Jt;case"DoubleVertical":case"DoubleRTL":case"DoubleLTR":return er;case"ContinuesHorizontalLTR":case"ContinuesHorizontalRTL":return Yt;default:return tt}},jr=s=>Array.from({length:s},(i,o)=>o),ee={pageCount:-1,sourceOrder:-1,chapterCount:0,lastPageRead:0,name:"Loading...",manga:{id:-1}};function qr(){var Ie,$e,Me,We,ze,Fe,Be,He;const{t:s}=nt(),i=at(),o=st(),{chapterIndex:f,mangaId:c}=Ot(),u=r.useMemo(()=>({id:+c,title:"",thumbnailUrl:"",genre:[],inLibraryAt:0,lastReadAt:0,chapters:{totalCount:0},trackRecords:{totalCount:0}}),[c]),{data:D,loading:R,error:g,refetch:p}=J.useGetManga(Nt,c),l=r.useRef(null),S=Number(c)===((Ie=l.current)==null?void 0:Ie.mangaId)&&Number(f)===(($e=l.current)==null?void 0:$e.sourceOrder)&&((Me=l.current)==null?void 0:Me.pageCount)!==-1,h=(We=D==null?void 0:D.manga)!=null?We:u,{data:m,loading:j,error:E,refetch:n}=J.useGetChapters(Ke,{condition:{mangaId:Number(c),sourceOrder:Number(f)}},{notifyOnNetworkStatusChange:!0}),a=m==null?void 0:m.chapters.nodes[0],y=r.useRef(!1),{settings:{downloadAheadLimit:O}}=qe(),N=!!O,v=()=>{var z;return l.current&&S?a&&((z=l.current)==null?void 0:z.pageCount)!==a.pageCount?a:l.current:(y.current=!1,a||null)};l.current=v();const e=(ze=l.current)!=null?ze:ee,d=r.useRef(ee);d.current===ee&&(d.current=e),e.mangaId!==((Fe=d.current)==null?void 0:Fe.mangaId)&&(d.current=ee);const[P,{loading:A,error:F}]=J.useGetChapterPagesFetch(e.id),H=()=>{j||P().then(()=>{y.current=!0}).catch(Q())};r.useEffect(()=>{H()},[e.id]);const[U,I]=r.useState(!1),[C,L]=r.useState(0),$=C===e.pageCount-1,M=Xt(C,$?0:1e3),[X,te]=r.useState(void 0),{setOverride:x,setTitle:b,readerNavBarWidth:B}=r.useContext(At),[ue,re]=r.useState(!1),{data:xe,loading:lt,error:De,refetch:dt}=J.useGetMangaChapters(Ke,c,{nextFetchPolicy:"standby"}),w=xe==null?void 0:xe.chapters.nodes,me=R||j||lt||A||!y.current&&!E&&!F,ke=(He=(Be=g!=null?g:E)!=null?Be:De)!=null?He:F,{settings:je,loading:Te}=Ft(),[k,_e]=r.useState(je),{settings:pe}=qe(),Oe=r.useMemo(()=>k.skipDupChapters?_.removeDuplicates(d.current,w!=null?w:[]):w!=null?w:[],[d.current,w,k.skipDupChapters]),ut=r.useMemo(()=>_.getNextChapters(e,w!=null?w:[],{offset:q.PREVIOUS,skipDupe:k.skipDupChapters,skipDupeChapter:d.current}),[e,d.current,w,k.skipDupChapters]),pt=r.useMemo(()=>_.getNextChapters(e,w!=null?w:[],{skipDupe:k.skipDupChapters,skipDupeChapter:d.current}),[e,d.current,w,k.skipDupChapters]),fe=r.useMemo(()=>_.getNextChapter(e,w!=null?w:[],{offset:q.PREVIOUS,skipDupe:k.skipDupChapters,skipDupeChapter:d.current}),[e,d.current,w,k.skipDupChapters]),G=r.useMemo(()=>_.getNextChapter(e,w!=null?w:[],{skipDupe:k.skipDupChapters,skipDupeChapter:d.current}),[e,d.current,w,k.skipDupChapters]),Ne=T=>{if(e===ee)return;const W=()=>{if(!(!!T.isRead&&!!pe.deleteChaptersWhileReading)||!w)return[];const Z=[e,...ut][pe.deleteChaptersWhileReading-1];if(!Z)return[];const Ce=se(Z.id);return Ce.isRead&&_.isDeletable(Ce,pe.deleteChaptersWithBookmark)?k.skipDupChapters?_.getIds(_.addDuplicates([Z],w)):_.getIds([Z]):[]};(()=>{var we;const ge=se(e.id),Z=((we=T.lastPageRead)!=null?we:0)/e.pageCount>.25;if(N&&h.inLibrary&&!!(ge!=null&&ge.isDownloaded)&&Z){const Pe=G?se(G.id):null;if(!(Pe!=null&&Pe.isDownloaded))return;const Ve=_.getNonRead(pt).map(K=>se(K.id)).slice(-O).filter(K=>!K.isDownloaded).map(K=>K.id).filter(K=>!_.isDownloading(K));if(!Ve.length)return;_.download(Ve).catch(Q())}})();const ve=k.skipDupChapters?_.getIds(_.addDuplicates([e],w!=null?w:[e])):[e.id];J.updateChapters(ve,{...T,chapterIdsToDelete:W(),trackProgressMangaId:pe.updateProgressAfterReading&&T.isRead&&h.trackRecords.totalCount?h.id:void 0},{errorPolicy:"all"}).response.catch(Q())},ft=(T,W,z=!0)=>{_e({...k,[T]:W}),z&&Wt(h,[[T,W]]).catch(()=>Ge(s("reader.settings.error.label.failed_to_save_settings"),"warning"))},Y=r.useCallback(T=>{const W=T===q.NEXT,z=W?G:fe;if(!z){Ge(s(W?"reader.error.label.next_chapter_does_not_exist":"reader.error.label.prev_chapter_does_not_exist"),"error");return}re(!0),L(0),i("/manga/".concat(h.id,"/chapter/").concat(z.sourceOrder),{replace:!0,state:o.state}),re(!1)},[h.id,fe==null?void 0:fe.id,G==null?void 0:G.id]);r.useEffect(()=>{if(me||!e){L(0);return}I(!0),e.lastPageRead===e.pageCount-1?L(0):L(e.lastPageRead)},[e,me]),r.useLayoutEffect(()=>{!(h!=null&&h.title)||e.name===s("global.label.loading")?b(s("reader.title")):b("".concat(h.title,": ").concat(e.name))},[s,h,e]),r.useEffect(()=>{!Te&&!R&&_e(Bt(h,je))},[Te,R]),r.useLayoutEffect(()=>(x({status:!0,value:t.jsx(Dr,{settings:k,setSettingValue:ft,manga:h,chapter:e,chapters:Oe,curPage:C,scrollToPage:te,openNextChapter:Y,retrievingNextChapter:ue})}),()=>x({status:!1,value:t.jsx("div",{})})),[h,e,k,C,f,ue,Y,Oe]),r.useEffect(()=>{if(!U||e===ee)return;const T=se(e.id);if(M===(T==null?void 0:T.lastPageRead))return;const W=M!==-1,z=M===e.pageCount-1;(W||z)&&Ne({lastPageRead:W?M:void 0,isRead:z?!0:void 0})},[M,N]);const gt=r.useCallback(()=>{Ne({lastPageRead:e.pageCount-1,isRead:!0}),Y(q.NEXT)},[e.pageCount,Y,e,h]),ht=r.useCallback(()=>{Y(q.PREVIOUS)},[Y]),xt=It.useGetScrollbarSize("height");if(me)return t.jsx(V,{sx:{height:"100vh",width:"100vw",display:"grid",placeItems:"center"},children:t.jsx($t,{thickness:5})});if(ke)return t.jsx(Je,{message:s("global.error.label.failed_to_load_data"),messageExtra:ke.message,retry:()=>{g&&p().catch(Q()),E&&n().catch(Q()),De&&dt().catch(Q()),F&&H()}});if(!e.pageCount)return t.jsx(Je,{message:s("reader.error.label.no_pages_found"),retry:H});const mt=jr(e.pageCount).map(T=>({index:T,src:J.getChapterPageUrl(c,f,T)})),vt=kr(k.readerType),Ct=X!=null?X:e.lastPageRead===e.pageCount-1?0:e.lastPageRead,Ae=k.staticNav?B:0;return t.jsxs(V,{sx:{display:"flex",flexDirection:"column",alignContent:"center",alignItems:"center",justifyContent:"center",minWidth:"calc((100vw - (100vw - 100%)) - ".concat(Ae,"px)"),minHeight:"calc(100vh - ".concat(xt,"px)"),marginLeft:"".concat(Ae,"px")},children:[t.jsx(Zt,{settings:k,curPage:C,pageCount:e.pageCount}),t.jsx(V,{sx:{alignSelf:"stretch"},children:t.jsx(vt,{pages:mt,pageCount:e.pageCount,setCurPage:L,initialPage:Ct,curPage:C,settings:k,manga:h,chapter:e,nextChapter:gt,prevChapter:ht},e.id)})]})}export{qr as Reader};
