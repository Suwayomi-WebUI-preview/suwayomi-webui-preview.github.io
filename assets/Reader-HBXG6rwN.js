import{c as r,n as be,j as t,B as z,a as V,am as F,r as oe,i as ie,y as yt,ab as bt,an as Pt,a9 as Ee,ao as Lt,ap as St,aq as Ue,s as ce,u as it,w as Dt,e as ct,ar as lt,as as jt,at as Tt,f as te,I as re,T as kt,au as _t,a0 as Nt,av as Ot,_ as Ge,aw as At,a1 as It,ax as $t,ay as Ye,q as Ze,N as Wt,m as Je,h as K,a3 as Mt,E as Qe,az as Bt,aA as zt}from"./index-CkjnowZ5.js";import{b as U,C as N}from"./Chapters-bz-c3F-B.js";import{P as ge,i as Ft,R as Ht,u as qt,g as et,c as Vt}from"./ReaderSettingsOptions-DrWcLL1k.js";import{S as tt}from"./SpinnerImage-Bf7RqXFe.js";import{S as rt}from"./Select-Bvz65aY1.js";import{C as Xt}from"./CustomIconButton-moaH6fvl.js";import{C as Kt}from"./Collapse-BSRT7jVv.js";import{a as nt}from"./TextField-CJnfilCU.js";import{u as Ut}from"./useDebounce-C8ay9WkD.js";import"./NumberSetting-C3bwLpe2.js";import"./Info-nz9elGvL.js";import"./InputAdornment-BVJgoBQ7.js";import"./Switch-Cq57Y6wI.js";import"./SwitchBase-FvMIbsQX.js";const Gt=a=>{for(let n=0;n<a.children.length;n++){const s=a.children.item(n);if(s){const{left:u,right:l}=s.getBoundingClientRect();if(u<=window.innerWidth/2&&l>window.innerWidth/2)return n}}return-1},Yt=5,Zt=()=>window.innerWidth+window.scrollX>=document.body.scrollWidth-Yt,Jt=()=>window.scrollX<=0;function Qt(a){const{pages:n,curPage:s,initialPage:u,settings:l,setCurPage:o,prevChapter:C,nextChapter:f}=a,c=r.useRef(u),m=r.useRef(null),h=r.useRef([]);function R(){var g;s<n.length-1?((g=h.current[s+1])==null||g.scrollIntoView({inline:"center"}),o(e=>e+1)):l.loadNextOnEnding&&f()}function p(){var g;s>0?((g=h.current[s-1])==null||g.scrollIntoView({inline:"center"}),o(s-1)):s===0&&C()}function D(){l.readerType==="ContinuesHorizontalLTR"?p():R()}function j(){l.readerType==="ContinuesHorizontalLTR"?R():p()}const b=r.useRef(0);function d(g){window.scrollBy(b.current-g.pageX,0)}function i(g){var e;b.current=g.pageX,(e=m.current)==null||e.addEventListener("mousemove",d)}function v(){var g;(g=m.current)==null||g.removeEventListener("mousemove",d)}function P(g){g.clientX>=window.innerWidth*.85?j():g.clientX<=window.innerWidth*.15&&D()}const k=()=>{l.readerType==="ContinuesHorizontalLTR"?window.scrollX+window.innerWidth>=document.body.scrollWidth&&f():l.readerType==="ContinuesHorizontalRTL"&&window.scrollX<=window.innerWidth&&f()};return be(h.current[u],r.useCallback((g,e)=>{const x=h.current[u];x!=null&&x.offsetHeight&&(x.scrollIntoView({inline:"center"}),e.disconnect())},[h.current[u],u])),r.useEffect(()=>{var g,e;return(g=m.current)==null||g.addEventListener("mousedown",i),(e=m.current)==null||e.addEventListener("mouseup",v),()=>{var x,O;(x=m.current)==null||x.removeEventListener("mousedown",i),(O=m.current)==null||O.removeEventListener("mouseup",v)}},[m]),r.useEffect(()=>(l.loadNextOnEnding&&document.addEventListener("scroll",k),()=>{document.removeEventListener("scroll",k)}),[m,s,C,f]),r.useEffect(()=>{const g=()=>{if(!m.current)return;const e=Gt(m.current);e!==c.current&&(c.current=e,o(e)),(l.readerType==="ContinuesHorizontalLTR"?Zt():Jt())&&(c.current=n.length-1,o(c.current))};return window.addEventListener("scroll",g),()=>window.removeEventListener("scroll",g)},[l.readerType]),t.jsx(z,{ref:m,sx:{display:"flex",flexDirection:l.readerType==="ContinuesHorizontalLTR"?"row":"row-reverse",justifyContent:l.readerType==="ContinuesHorizontalLTR"?"flex-start":"flex-end",width:"auto",height:"auto",overflowX:"visible",userSelect:"none"},onClick:P,children:n.map(g=>t.jsx(ge,{index:g.index,src:g.src,onImageLoad:()=>{},settings:l,ref:e=>{h.current[g.index]=e}},g.index))})}function er(a){const{settings:n,curPage:s,pageCount:u}=a;return t.jsx(z,{sx:{display:n.showPageNumber?"block":"none",position:"fixed",bottom:"50px",padding:"2px",paddingLeft:"4px",paddingRight:"4px",textAlign:"center",backgroundColor:"rgba(0, 0, 0, 0.3)",borderRadius:"10px"},children:"".concat(s+1," / ").concat(u)})}function tr(a){const{pages:n,settings:s,setCurPage:u,initialPage:l,curPage:o,nextChapter:C,prevChapter:f,chapter:c}=a,m=r.useRef(null);r.useEffect(()=>{const i=n.map(v=>{const P=V.requestImage(v.src);return P.response.catch(()=>{}),P});return()=>{i.forEach(v=>v.abortRequest(new Error("PagedPager::preload: chapter changed")))}},[c.id]);const h=i=>{u(i),window.scroll({top:0})};function R(){o<n.length-1?h(o+1):s.loadNextOnEnding&&C()}function p(){o>0?h(o-1):f()}function D(){s.readerType==="SingleLTR"?p():s.readerType==="SingleRTL"&&R()}function j(){s.readerType==="SingleLTR"?R():s.readerType==="SingleRTL"&&p()}function b(i){switch(i.key){case"Space":i.preventDefault(),R();break;case"ArrowRight":j();break;case"ArrowLeft":D();break}}function d(i){i.clientX>window.innerWidth/2?j():D()}return r.useEffect(()=>(document.addEventListener("keydown",b),()=>{document.removeEventListener("keydown",b)}),[m,o,s.readerType,f,C]),r.useEffect(()=>{setTimeout(()=>{h(l)},0)},[l]),t.jsx(z,{ref:m,sx:{display:"flex",flexDirection:"column",justifyContent:"center",width:"auto",height:"auto"},onClick:d,children:t.jsx(ge,{index:o,onImageLoad:()=>{},src:n[o].src,settings:s},o)})}const rr=r.forwardRef((a,n)=>{const{image1src:s,image2src:u,index:l,onImageLoad:o,settings:C}=a,f=Ft(C),c={...f,width:C.fitPageToWindow?f.width:"calc(".concat(f.width," * 0.5)"),minWidth:C.fitPageToWindow&&C.scalePage?"calc(".concat(f.minWidth," * 0.5)"):f.minWidth,maxWidth:C.fitPageToWindow?"calc(".concat(f.maxWidth," * 0.5)"):f.maxWidth},m={...c,height:"100vh",width:"50%",backgroundColor:"#525252"};return t.jsxs(z,{ref:n,sx:{display:"flex",flexDirection:C.readerType==="DoubleLTR"?"row":"row-reverse",justifyContent:"center",width:"100%"},children:[t.jsx(tt,{src:s,onImageLoad:o,alt:"Page #".concat(l),spinnerStyle:m,imgStyle:{...c,objectPosition:C.readerType==="DoubleLTR"?F("right","left"):F("left","right")}}),t.jsx(tt,{src:u,onImageLoad:o,alt:"Page #".concat(l+1),spinnerStyle:{...m,width:"calc(50% - 5px)",marginLeft:"5px"},imgStyle:{...c,objectPosition:C.readerType==="DoubleLTR"?F("left","right"):F("right","left")}})]})}),nr=a=>a.height/a.width<1,ye=(a,n,s)=>{if(n[a]||n[a+1]||a===n.length-1)return!0;const u=n.lastIndexOf(!0,a-1),l=a-(u+1);return s?l%2===0:l%2===1};function ar(a){const{pages:n,settings:s,setCurPage:u,initialPage:l,curPage:o,chapter:C,nextChapter:f,prevChapter:c}=a,m=r.useRef(null),[h,R]=r.useState(Array(n.length).fill(!1)),[p,D]=r.useState(Array(n.length).fill(!1));function j(){let e=1;if(o<n.length&&p[o]&&(e=1,h[o]))return e;if(o+1<n.length&&p[o+1]){if(ye(o,h,s.offsetFirstPage))return e;e=2}return e}function b(){return ye(o-2,h,s.offsetFirstPage)?1:2}function d(){if(o<n.length-1){const e=o+j();u(e>=n.length?n.length-1:e)}else s.loadNextOnEnding&&f()}function i(){if(o>0){const e=o-b();u(e<0?0:e)}else c()}function v(){s.readerType==="DoubleLTR"?i():d()}function P(){s.readerType==="DoubleLTR"?d():i()}function k(e){switch(e.key){case"Space":e.preventDefault(),d();break;case"ArrowRight":P();break;case"ArrowLeft":v();break}}function g(e){e.clientX>window.innerWidth/2?P():v()}return r.useEffect(()=>(document.addEventListener("keydown",k),()=>{document.removeEventListener("keydown",k)}),[m,o,s.readerType,c,f,p,h]),r.useEffect(()=>{u(l)},[l]),r.useEffect(()=>{s.offsetFirstPage?j()===2&&u(o+1):o>0&&!ye(o-1,h,s.offsetFirstPage)&&u(o-1)},[s.offsetFirstPage]),r.useEffect(()=>{const e=n.map(x=>[x.index,V.requestImage(x.src)]);return e.forEach(async([x,O])=>{try{const B=await O.response,I=new Image;I.onload=()=>{URL.revokeObjectURL(B),D(_=>_.toSpliced(x,1,!0)),R(_=>_.toSpliced(x,1,nr(I)))},I.src=B}catch(B){}}),()=>{e.forEach(([x,O])=>O.abortRequest(new Error("DoublePagedPager::preload(".concat(x,"): chapter changed"))))}},[C.id]),t.jsx(z,{ref:m,onClick:g,children:t.jsx(z,{id:"display",sx:{display:"flex",flexDirection:s.readerType==="DoubleLTR"?"row":"row-reverse",justifyContent:"center",width:"auto",height:"auto"},children:j()===2?t.jsx(rr,{index:o,image1src:n[o].src,image2src:n[o+1].src,settings:s},o):t.jsx(ge,{index:o,src:n[o].src,onImageLoad:()=>{},settings:s},o)})})}const sr=a=>{for(let n=0;n<a.children.length;n++){const s=a.children.item(n);if(s){const{top:u,bottom:l}=s.getBoundingClientRect();if(u<=window.innerHeight&&l>1)return n}}return-1},or=5,ir=.95,at=.25,cr="smooth",st=()=>window.innerHeight+window.scrollY>=document.body.offsetHeight-or,lr=()=>window.scrollY<=0;function ot(a){const{pages:n,settings:s,setCurPage:u,initialPage:l,nextChapter:o,prevChapter:C}=a,f=r.useRef(l),c=r.useRef(null),m=r.useRef([]);r.useEffect(()=>{let d=!1;const i=()=>{if(c.current)if(st()){if(d)return;d=!0,f.current=n.length-1,u(f.current),s.loadNextOnEnding&&o()}else{d=!1;const v=sr(c.current);v!==f.current&&(f.current=v,u(v))}};return window.addEventListener("scroll",i),()=>{window.removeEventListener("scroll",i)}},[s.loadNextOnEnding,o]);const h=r.useRef(0),R=r.useRef(!1);function p(d){R.current=!0,window.scrollBy(0,h.current-d.pageY)}function D(d){var i;h.current=d.pageY,(i=c.current)==null||i.addEventListener("mousemove",p)}function j(){var d;(d=c.current)==null||d.removeEventListener("mousemove",p)}r.useEffect(()=>{var d,i;return(d=c.current)==null||d.addEventListener("mousedown",D),(i=c.current)==null||i.addEventListener("mouseup",j),()=>{var v,P;(v=c.current)==null||v.removeEventListener("mousedown",D),(P=c.current)==null||P.removeEventListener("mouseup",j)}},[c]);const b=r.useCallback((d,i=ir)=>{if(d==="down"&&st()){o();return}if(d==="up"&&lr()){C();return}window.scroll({top:window.scrollY+window.innerHeight*i*(d==="up"?-1:1),behavior:cr})},[o,C]);return r.useEffect(()=>{const d=i=>{switch(i.key){case"Space":i.preventDefault(),b(i.shiftKey?"up":"down");break;case"ArrowDown":i.preventDefault(),b(i.shiftKey?"up":"down",at);break;case"ArrowRight":i.preventDefault(),b(i.shiftKey?"up":"down");break;case"ArrowUp":i.preventDefault(),b(i.shiftKey?"down":"up",at);break;case"ArrowLeft":i.preventDefault(),b(i.shiftKey?"down":"up");break}};return document.addEventListener("keydown",d,!1),()=>{document.removeEventListener("keydown",d)}},[b]),be(m.current[l],r.useCallback((d,i)=>{const v=m.current[l];v!=null&&v.offsetHeight&&(v.scrollIntoView(),i.disconnect())},[m.current[l],l])),t.jsx(z,{ref:c,sx:{display:"flex",flexDirection:"column",justifyContent:"center",width:"auto",height:"auto",userSelect:"none"},onClick:d=>{if(R.current){R.current=!1;return}b(d.clientX>window.innerWidth/2?"down":"up")},children:n.map(d=>t.jsx(ge,{index:d.index,src:d.src,onImageLoad:()=>{},settings:s,ref:i=>{m.current[d.index]=i}},d.index))})}var Pe={},dr=ie;Object.defineProperty(Pe,"__esModule",{value:!0});var dt=Pe.default=void 0,ur=dr(oe()),fr=t;dt=Pe.default=(0,ur.default)((0,fr.jsx)("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Close");var Le={},pr=ie;Object.defineProperty(Le,"__esModule",{value:!0});var ae=Le.default=void 0,gr=pr(oe()),hr=t;ae=Le.default=(0,gr.default)((0,hr.jsx)("path",{d:"M15.41 16.59 10.83 12l4.58-4.59L14 6l-6 6 6 6z"}),"KeyboardArrowLeft");var Se={},xr=ie;Object.defineProperty(Se,"__esModule",{value:!0});var se=Se.default=void 0,mr=xr(oe()),Cr=t;se=Se.default=(0,mr.default)((0,Cr.jsx)("path",{d:"M8.59 16.59 13.17 12 8.59 7.41 10 6l6 6-6 6z"}),"KeyboardArrowRight");var De={},vr=ie;Object.defineProperty(De,"__esModule",{value:!0});var ut=De.default=void 0,wr=vr(oe()),Rr=t;ut=De.default=(0,wr.default)((0,Rr.jsx)("path",{d:"M7.41 8.59 12 13.17l4.59-4.58L18 10l-6 6-6-6z"}),"KeyboardArrowDown");var je={},Er=ie;Object.defineProperty(je,"__esModule",{value:!0});var ft=je.default=void 0,yr=Er(oe()),br=t;ft=je.default=(0,yr.default)((0,br.jsx)("path",{d:"M7.41 15.41 12 10.83l4.59 4.58L18 14l-6-6-6 6z"}),"KeyboardArrowUp");const Pr=["addEndListener","appear","children","easing","in","onEnter","onEntered","onEntering","onExit","onExited","onExiting","style","timeout","TransitionComponent"],Lr={entering:{transform:"none"},entered:{transform:"none"}},Sr=r.forwardRef(function(n,s){const u=yt(),l={enter:u.transitions.duration.enteringScreen,exit:u.transitions.duration.leavingScreen},{addEndListener:o,appear:C=!0,children:f,easing:c,in:m,onEnter:h,onEntered:R,onEntering:p,onExit:D,onExited:j,onExiting:b,style:d,timeout:i=l,TransitionComponent:v=Lt}=n,P=bt(n,Pr),k=r.useRef(null),g=Pt(k,f.ref,s),e=y=>L=>{if(y){const $=k.current;L===void 0?y($):y($,L)}},x=e(p),O=e((y,L)=>{St(y);const $=Ue({style:d,timeout:i,easing:c},{mode:"enter"});y.style.webkitTransition=u.transitions.create("transform",$),y.style.transition=u.transitions.create("transform",$),h&&h(y,L)}),B=e(R),I=e(b),_=e(y=>{const L=Ue({style:d,timeout:i,easing:c},{mode:"exit"});y.style.webkitTransition=u.transitions.create("transform",L),y.style.transition=u.transitions.create("transform",L),D&&D(y)}),ee=e(j),H=y=>{o&&o(k.current,y)};return t.jsx(v,Ee({appear:C,in:m,nodeRef:k,onEnter:O,onEntered:B,onEntering:x,onExit:_,onExited:ee,onExiting:I,addEndListener:H,timeout:i},P,{children:(y,L)=>r.cloneElement(f,Ee({style:Ee({transform:"scale(0)",visibility:y==="exited"&&!m?"hidden":void 0},Lr[y],d,f.props.style),ref:g},L))}))}),Dr=Sr,jr=ce("div")({zIndex:10}),Tr=ce("div")(({theme:a})=>({position:"fixed",top:0,left:0,minWidth:"240px",maxWidth:"400px",height:"100vh",overflowY:"auto",backgroundColor:a.palette.background.default,"& header":{backgroundColor:a.palette.action.hover,display:"flex",alignItems:"center",padding:"".concat(a.spacing(1)," ").concat(a.spacing(3)),transition:"left 2s ease"}})),kr=ce("div")(({theme:a})=>({margin:"0 ".concat(a.spacing(2))})),_r=ce("div")({display:"flex",flexWrap:"wrap",alignContent:"center",alignItems:"center",justifyContent:"center"}),Nr=ce("div")(({theme:a})=>({display:"grid",gridTemplateRows:"auto auto auto",gridTemplateColumns:"0fr 1fr 0fr",gridTemplateAreas:'"pre current next"',gridColumnGap:a.spacing(.5),margin:"".concat(a.spacing(1)," 0"),"& a":{textDecoration:"none",color:"inherit",display:"flex",flexWrap:"wrap",alignContent:"center"}}));function Or(a){var q;const{t:n}=it(),{setReaderNavBarWidth:s}=Dt(),u=ct(),l=lt(),{prevDrawerOpen:o,prevSettingsCollapseOpen:C}=(q=l.state)!=null?q:{},f=r.useRef(null);be(f,r.useCallback(()=>{var w;((w=f.current)==null?void 0:w.offsetWidth)!==void 0&&s(f.current.offsetWidth)},[f.current])),r.useLayoutEffect(()=>()=>s(0),[f]);const{settings:c,setSettingValue:m,manga:h,chapter:R,chapters:p,curPage:D,scrollToPage:j,openNextChapter:b,retrievingNextChapter:d}=a,i=jt(),v=r.useMemo(()=>new Set(p.map(({scanlator:w})=>w)).size>1,[p]),[P,k]=r.useState(c.staticNav||o),[g,e]=r.useState(!0),[x,O]=r.useState(c.staticNav||o),[B,I]=r.useState(0),[_,ee]=r.useState(C!=null?C:!0),H=d,y=(w,A,G)=>{e(w!=="staticNav"),m(w,A,G)},L=w=>{k(w),O(w)},$=()=>{const w=window.pageYOffset;Math.abs(w-B)>20&&(O(w>B),I(w))};return r.useEffect(()=>{g&&L(c.staticNav)},[c.staticNav]),r.useEffect(()=>{window.addEventListener("scroll",$);const w=document.querySelector("#root"),A=document.querySelector("#appMainContainer");return w.style.display="flex",w.style.flexDirection="column",A.style.display="none",()=>{w.style.display="block",A.style.display="block",window.removeEventListener("scroll",$)}},[$]),t.jsxs(jr,{children:[t.jsx(Tt,{direction:F("right","left"),in:P,timeout:200,appear:!1,mountOnEnter:!0,unmountOnExit:!0,children:t.jsxs(Tr,{ref:f,children:[t.jsxs("header",{children:[!c.staticNav&&t.jsx(te,{title:n("reader.button.close_menu"),children:t.jsx(re,{edge:"start",color:"inherit","aria-label":"menu",onClick:()=>L(!1),size:"large",children:F(t.jsx(ae,{}),t.jsx(se,{}))})}),t.jsx(kt,{variant:"h6",component:"h1",textOverflow:"ellipsis",overflow:"hidden",sx:{py:1,flexGrow:1},children:R.name}),t.jsx(te,{title:n("reader.button.exit"),children:t.jsx(re,{edge:"start",color:"inherit","aria-label":"menu",onClick:i,size:"large",sx:{mr:-1},children:t.jsx(dt,{})})})]}),t.jsxs(_t,{ContainerComponent:"div",sx:{"& span":{fontWeight:"bold"}},children:[t.jsx(Nt,{primary:n("reader.settings.title.reader_settings")}),t.jsxs(re,{edge:"start",color:"inherit","aria-label":"menu",disableRipple:!0,disableFocusRipple:!0,onClick:()=>ee(!_),size:"large",children:[_&&t.jsx(ft,{}),!_&&t.jsx(ut,{})]})]}),t.jsx(Kt,{in:_,timeout:"auto",unmountOnExit:!0,children:t.jsx(Ht,{setSettingValue:y,staticNav:c.staticNav,showPageNumber:c.showPageNumber,loadNextOnEnding:c.loadNextOnEnding,skipDupChapters:c.skipDupChapters,fitPageToWindow:c.fitPageToWindow,scalePage:c.scalePage,readerType:c.readerType,offsetFirstPage:c.offsetFirstPage,readerWidth:c.readerWidth})}),t.jsx(Ot,{sx:{my:1,mx:2}}),t.jsxs(kr,{children:[t.jsxs(_r,{children:[t.jsx("span",{children:n("reader.page_info.label.currently_on_page")}),t.jsx(nt,{size:"small",sx:{mx:.5},disabled:H||R.pageCount===-1,children:t.jsx(rt,{value:R.pageCount>-1?"".concat(D):"",displayEmpty:!0,onChange:({target:{value:w}})=>{j(Number(w))},children:Array(Math.max(0,R.pageCount)).fill(1).map((w,A)=>t.jsx(Ge,{value:A,children:A+1},"Page#".concat(A)))})}),t.jsx("span",{children:n("reader.page_info.label.of_max_pages",{maxPages:R.pageCount})})]}),t.jsxs(Nr,{children:[t.jsx(te,{title:n("reader.button.previous_chapter"),children:t.jsx(re,{sx:{gridArea:"pre"},disabled:H||R.sourceOrder<=1,onClick:()=>b(U.PREV),children:F(t.jsx(ae,{}),t.jsx(se,{}))})}),t.jsx(nt,{sx:{gridArea:"current"},size:"small",disabled:H||R.sourceOrder<1,children:t.jsx(rt,{value:R.sourceOrder>=1?"".concat(R.sourceOrder):"",displayEmpty:!0,onChange:({target:{value:w}})=>{u("/manga/".concat(h.id,"/chapter/").concat(w),{replace:!0,state:{prevDrawerOpen:P,prevSettingsCollapseOpen:_}})},children:p.map(({id:w,sourceOrder:A,name:G,chapterNumber:le,scanlator:de})=>t.jsx(Ge,{value:A,children:"#".concat(le).concat(v&&de!=null?" (".concat(de,")"):""," | ").concat(G)},w))})}),t.jsx(te,{title:n("reader.button.next_chapter"),children:t.jsx(re,{sx:{gridArea:"next"},disabled:H||R.sourceOrder<1||R.sourceOrder>=h.chapters.totalCount,onClick:()=>b(U.NEXT),children:F(t.jsx(se,{}),t.jsx(ae,{}))})})]})]})]})}),t.jsx(Dr,{in:!P,children:t.jsx(At,{in:!x,children:t.jsx(te,{title:n("reader.button.open_menu"),children:t.jsx(Xt,{sx:{position:"fixed",top:20,left:20},size:"large",variant:"contained",onClick:()=>L(!0),children:F(t.jsx(se,{}),t.jsx(ae,{}))})})})})]})}const ne=a=>N.getFromCache(a,Bt,"CHAPTER_READER_FIELDS"),Ar=a=>{switch(a){case"ContinuesVertical":case"Webtoon":return ot;case"SingleVertical":case"SingleRTL":case"SingleLTR":return tr;case"DoubleVertical":case"DoubleRTL":case"DoubleLTR":return ar;case"ContinuesHorizontalLTR":case"ContinuesHorizontalRTL":return Qt;default:return ot}},Ir=a=>Array.from({length:a},(n,s)=>s),Q={pageCount:-1,sourceOrder:-1,chapterCount:0,lastPageRead:0,name:"Loading...",manga:{id:-1}};function Jr(){var Me,Be,ze,Fe,He,qe,Ve,Xe;const{t:a}=it(),n=ct(),s=lt(),{chapterIndex:u,mangaId:l}=It(),o=r.useMemo(()=>({id:+l,title:"",thumbnailUrl:"",genre:[],inLibraryAt:0,lastReadAt:0,chapters:{totalCount:0},trackRecords:{totalCount:0}}),[l]),{data:C,loading:f,error:c,refetch:m}=V.useGetManga($t,l),h=r.useRef(null),R=Number(l)===((Me=h.current)==null?void 0:Me.mangaId)&&Number(u)===((Be=h.current)==null?void 0:Be.sourceOrder)&&((ze=h.current)==null?void 0:ze.pageCount)!==-1,p=(Fe=C==null?void 0:C.manga)!=null?Fe:o,{data:D,loading:j,error:b,refetch:d}=V.useGetChapters(Ye,{condition:{mangaId:Number(l),sourceOrder:Number(u)}},{notifyOnNetworkStatusChange:!0}),i=D==null?void 0:D.chapters.nodes[0],v=r.useRef(!1),{settings:{downloadAheadLimit:P}}=Ze(),k=!!P,g=()=>{var M;return h.current&&R?i&&((M=h.current)==null?void 0:M.pageCount)!==i.pageCount?i:h.current:(v.current=!1,i||null)};h.current=g();const e=(He=h.current)!=null?He:Q,x=r.useRef(Q);x.current===Q&&(x.current=e),e.mangaId!==((qe=x.current)==null?void 0:qe.mangaId)&&(x.current=Q);const[O,{loading:B,error:I}]=V.useGetChapterPagesFetch(e.id),_=()=>{j||O().then(()=>{v.current=!0}).catch(K())};r.useEffect(()=>{_()},[e.id]);const[ee,H]=r.useState(!1),[y,L]=r.useState(0),$=y===e.pageCount-1,q=Ut(y,$?0:1e3),[w,A]=r.useState(void 0),{setOverride:G,setTitle:le,readerNavBarWidth:de}=r.useContext(Wt),[Te,ke]=r.useState(!1),{data:he,loading:pt,error:_e,refetch:gt}=V.useGetMangaChapters(Ye,l,{nextFetchPolicy:"standby"}),E=he==null?void 0:he.chapters.nodes,xe=f||j||pt||B||!v.current&&!b&&!I,Ne=(Xe=(Ve=c!=null?c:b)!=null?Ve:_e)!=null?Xe:I,{settings:me,loading:Oe}=qt(),[S,Ae]=r.useState(et(p,me)),{settings:ue}=Ze(),Ie=r.useMemo(()=>S.skipDupChapters?N.removeDuplicates(x.current,E!=null?E:[]):E!=null?E:[],[x.current,E,S.skipDupChapters]),ht=r.useMemo(()=>N.getNextChapters(e,E!=null?E:[],{offset:U.PREV,skipDupe:S.skipDupChapters,skipDupeChapter:x.current}),[e,x.current,E,S.skipDupChapters]),xt=r.useMemo(()=>N.getNextChapters(e,E!=null?E:[],{skipDupe:S.skipDupChapters,skipDupeChapter:x.current}),[e,x.current,E,S.skipDupChapters]),fe=r.useMemo(()=>N.getNextChapter(e,E!=null?E:[],{offset:U.PREV,skipDupe:S.skipDupChapters,skipDupeChapter:x.current}),[e,x.current,E,S.skipDupChapters]),Y=r.useMemo(()=>N.getNextChapter(e,E!=null?E:[],{skipDupe:S.skipDupChapters,skipDupeChapter:x.current}),[e,x.current,E,S.skipDupChapters]),$e=T=>{if(e===Q)return;const W=()=>{if(!(!!T.isRead&&!!ue.deleteChaptersWhileReading)||!E)return[];const J=[e,...ht][ue.deleteChaptersWhileReading-1];if(!J)return[];const ve=ne(J.id);return ve.isRead&&N.isDeletable(ve,ue.deleteChaptersWithBookmark)?S.skipDupChapters?N.getIds(N.addDuplicates([J],E)):N.getIds([J]):[]};(()=>{var we;const pe=ne(e.id),J=((we=T.lastPageRead)!=null?we:0)/e.pageCount>.25;if(k&&p.inLibrary&&!!(pe!=null&&pe.isDownloaded)&&J){const Re=Y?ne(Y.id):null;if(!(Re!=null&&Re.isDownloaded))return;const Ke=N.getNonRead(xt).map(X=>ne(X.id)).slice(-P).filter(X=>!X.isDownloaded).map(X=>X.id).filter(X=>!N.isDownloading(X));if(!Ke.length)return;N.download(Ke).catch(K())}})();const Ce=S.skipDupChapters?N.getIds(N.addDuplicates([e],E!=null?E:[e])):[e.id];V.updateChapters(Ce,{...T,chapterIdsToDelete:W(),trackProgressMangaId:ue.updateProgressAfterReading&&T.isRead&&p.trackRecords.totalCount?p.id:void 0},{errorPolicy:"all"}).response.catch(K())},mt=(T,W,M=!0)=>{Ae({...S,[T]:W}),M&&zt(p,[[T,W]]).catch(()=>Je(a("reader.settings.error.label.failed_to_save_settings"),"warning"))},Z=r.useCallback(T=>{const W=T===U.NEXT,M=W?Y:fe;if(!M){Je(a(W?"reader.error.label.next_chapter_does_not_exist":"reader.error.label.prev_chapter_does_not_exist"),"error");return}ke(!0),L(0),n("/manga/".concat(p.id,"/chapter/").concat(M.sourceOrder),{replace:!0,state:s.state}),ke(!1)},[p.id,fe==null?void 0:fe.id,Y==null?void 0:Y.id]);r.useEffect(()=>{if(xe||!e){L(0);return}H(!0),e.lastPageRead===e.pageCount-1?L(0):L(e.lastPageRead)},[e,xe]),r.useEffect(()=>{!(p!=null&&p.title)||e.name===a("global.label.loading")?le(a("reader.title")):le("".concat(p.title,": ").concat(e.name))},[a,p,e]),r.useEffect(()=>{!Oe&&!f&&(Vt(p,"manga",me).catch(K()),Ae(et(p,me)))},[Oe,f]),r.useEffect(()=>(G({status:!0,value:t.jsx(Or,{settings:S,setSettingValue:mt,manga:p,chapter:e,chapters:Ie,curPage:y,scrollToPage:A,openNextChapter:Z,retrievingNextChapter:Te})}),()=>G({status:!1,value:t.jsx("div",{})})),[p,e,S,y,u,Te,Z,Ie]),r.useEffect(()=>{if(!ee||e===Q)return;const T=ne(e.id);if(q===(T==null?void 0:T.lastPageRead))return;const W=q!==-1,M=q===e.pageCount-1;(W||M)&&$e({lastPageRead:W?q:void 0,isRead:M?!0:void 0})},[q,k]);const Ct=r.useCallback(()=>{$e({lastPageRead:e.pageCount-1,isRead:!0}),Z(U.NEXT)},[e.pageCount,Z,e,p]),vt=r.useCallback(()=>{Z(U.PREV)},[Z]);if(xe)return t.jsx(z,{sx:{height:"100vh",width:"100vw",display:"grid",placeItems:"center"},children:t.jsx(Mt,{thickness:5})});if(Ne)return t.jsx(Qe,{message:a("global.error.label.failed_to_load_data"),messageExtra:Ne.message,retry:()=>{c&&m().catch(K()),b&&d().catch(K()),_e&&gt().catch(K()),I&&_()}});if(!e.pageCount)return t.jsx(Qe,{message:a("reader.error.label.no_pages_found"),retry:_});const wt=Ir(e.pageCount).map(T=>({index:T,src:V.getChapterPageUrl(l,u,T)})),Rt=Ar(S.readerType),Et=w!=null?w:e.lastPageRead===e.pageCount-1?0:e.lastPageRead,We=S.staticNav?de:0;return t.jsxs(z,{sx:{display:"flex",flexDirection:"column",alignContent:"center",alignItems:"center",justifyContent:"center",minWidth:"calc((100vw - (100vw - 100%)) - ".concat(We,"px)"),minHeight:"100vh",marginLeft:"".concat(We,"px")},children:[t.jsx(er,{settings:S,curPage:y,pageCount:e.pageCount}),t.jsx(z,{sx:{alignSelf:"stretch"},children:t.jsx(Rt,{pages:wt,pageCount:e.pageCount,setCurPage:L,initialPage:Et,curPage:y,settings:S,manga:p,chapter:e,nextChapter:Ct,prevChapter:vt},e.id)})]})}export{Jr as Reader};
