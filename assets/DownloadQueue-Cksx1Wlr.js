import{c as P,j as e,b as j,u as R,K as m,r as s,m as M,g as v,f as q,w as z,A as O,L as B,I as w,C as b,e as F}from"./index-C31zer8j.js";import{P as U}from"./PlayArrow-DnrLN0ks.js";import{D as W,a as G,b as N,c as J,S as X,v as Y,d as Z,e as $}from"./DragHandle-BVpjISlZ.js";import{E as y}from"./EmptyViewAbsoluteCentered-GJB1YAkB.js";import{D as ee}from"./Delete-2CZcT_te.js";import{C as te}from"./ChapterDownloadRetryButton-ufIqpIgx.js";import{C as oe,D as re}from"./ChapterCardMetadata-xCKDGki6.js";import{M as A}from"./MUI.util-CYBuX_Wz.js";import{L as se}from"./ListCardContent-BkPEg8Vm.js";import{C as ae}from"./Card-BenBk-DW.js";import{C as ne}from"./CardActionArea-BPlyyjeT.js";import{u as ie}from"./useAppTitle-C_unTVVZ.js";import{u as le}from"./useAppAction-D7Ig7-31.js";import{V as de}from"./VirtuosoPersisted-B7DjmRuw.js";import{u as ce}from"./use-window-event-D40OcCNE.js";import"./index-CDwXGP0c.js";import"./Virtuoso.util-B0Rk8p_I.js";import"./use-merged-ref-UB_jC9JN.js";const pe=P(e.jsx("path",{d:"M6 19h4V5H6zm8-14v14h4V5z"})),ue=P(e.jsx("path",{d:"M15 16h4v2h-4zm0-8h7v2h-7zm0 4h6v2h-6zM3 18c0 1.1.9 2 2 2h6c1.1 0 2-.9 2-2V8H3zM14 5h-3l-1-1H6L5 5H2v2h12z"})),E=j.memo(({item:o,status:h})=>{const{t:x}=R(),c=j.useCallback(async i=>{const p=h===m.Started;try{p&&await s.stopDownloads().response,await Promise.all([s.removeChapterFromDownloadQueue(i.id).response,s.deleteDownloadedChapter(i.id).response])}catch(D){M(x("download.queue.error.label.failed_to_remove"),"error",v(D))}p&&s.startDownloads().response.catch(q())},[h]);return e.jsx(z,{sx:{p:1,pb:0},children:e.jsx(ae,{children:e.jsx(ne,{component:B,to:O.manga.path(o.manga.id),children:e.jsxs(se,{children:[e.jsx(w,{...A.preventRippleProp(),sx:{pointerEvents:"none"},children:e.jsx(W,{})}),e.jsx(oe,{title:o.manga.title,secondaryText:o.chapter.name}),e.jsx(re,{chapterId:o.chapter.id}),e.jsx(te,{chapterId:o.chapter.id}),e.jsx(b,{title:x("chapter.action.download.delete.label.action"),children:e.jsx(w,{...A.preventRippleProp(),onClick:i=>{i.preventDefault(),i.stopPropagation(),c(o.chapter)},children:e.jsx(ee,{})})})]})})})})}),Me=()=>{var I,S;const{t:o}=R();ie(o("download.title.queue"));const[h,{reset:x}]=s.useReorderChapterInDownloadQueue(),{data:c,loading:i,error:p,refetch:D}=s.useGetDownloadStatus({notifyOnNetworkStatusChange:!0}),l=c==null?void 0:c.downloadStatus,r=(I=l==null?void 0:l.queue)!=null?I:[],d=(S=l==null?void 0:l.state)!=null?S:m.Started,g=!r.length,_=j.useMemo(()=>r.map(t=>t.chapter),[r]),L=G.useSensorsForDevice(),[u,f]=j.useState(null),k=async()=>{try{await s.clearDownloads().response}catch(t){M(o("download.queue.error.label.failed_delete_all"),"error",v(t))}},H=()=>{d===m.Stopped?s.startDownloads():s.stopDownloads()},Q=(t,a,n)=>{a!==n&&h({variables:{input:{chapterId:t[a].chapter.id,to:n}}}).catch(()=>{x()})},V=t=>{const{active:a,over:n}=t;if(f(null),!n||a.id===n.id)return;const T=r.findIndex(C=>C.chapter.id===a.id),K=r.findIndex(C=>C.chapter.id===n.id);Q(r,T,K)};return le(e.jsxs(e.Fragment,{children:[e.jsx(b,{title:o("download.queue.label.delete_all"),children:e.jsx(w,{onClick:k,color:"inherit",children:e.jsx(ue,{})})}),e.jsx(b,{title:o(d===m.Started?"global.button.start":"global.button.stop"),disabled:g,children:e.jsx(w,{onClick:H,disabled:g,color:"inherit",children:d===m.Stopped?e.jsx(U,{}):e.jsx(pe,{})})})]}),[d,g]),ce("error",t=>{(t.message==="ResizeObserver loop completed with undelivered notifications."||t.message==="ResizeObserver loop limit exceeded")&&t.stopImmediatePropagation()}),i?e.jsx(F,{}):p?e.jsx(y,{message:o("global.error.label.failed_to_load_data"),messageExtra:v(p),retry:()=>D().catch(q())}):g?e.jsx(y,{message:o("download.queue.label.no_downloads")}):e.jsx(z,{sx:{pb:1},children:e.jsxs(N,{sensors:L,collisionDetection:J,onDragStart:t=>{var a;return f((a=r.find(n=>n.chapter.id===t.active.id))!=null?a:null)},onDragEnd:V,onDragCancel:()=>f(null),onDragAbort:()=>f(null),children:[e.jsx(X,{items:_,strategy:Y,children:e.jsx(de,{persistKey:"download-queue",useWindowScroll:!0,overscan:window.innerHeight*.5,totalCount:r.length,computeItemKey:t=>r[t].chapter.id,itemContent:t=>e.jsx(Z,{id:r[t].chapter.id,isDragging:r[t].chapter.id===(u==null?void 0:u.chapter.id),children:e.jsx(E,{item:r[t],status:d})})})}),e.jsx($,{isActive:!!u,children:e.jsx(E,{item:u,status:d})})]})})};export{Me as DownloadQueue};
