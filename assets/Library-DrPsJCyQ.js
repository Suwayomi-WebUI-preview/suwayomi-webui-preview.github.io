import{H as se,e as C,J as xe,K as ye,M as je,i as O,u as B,r as N,N as ke,d as D,j as s,O as Te,P as Me,Q as L,R as M,s as _e,m as re,g as oe,C as de,I as Ae,U,V as Fe,W as ve,X as Be,Y as Ie,Z as Le,h as we}from"./index-Cfd-5nyg.js";import{u as he,S as Re,A as Oe,N as Ne}from"./AppbarSearch-TAMqPebA.js";import{E as le}from"./EmptyViewAbsoluteCentered-8D4RyaYH.js";import{T as De,a as Ee}from"./Tabs-MUgFTopA.js";import{F as Ge}from"./FilterList-CBDgtYj2.js";import{C as w}from"./CheckboxInput-c5h5Hxvq.js";import{S as Ue,R as G}from"./SortRadioInput-DmTNG_kj.js";import{T as k}from"./ThreeStateCheckboxInput-SRKZKj89.js";import{O as Pe,S as ze,a as We}from"./SelectionFAB-AyaKRVFm.js";import{T as Ye}from"./Trackers-D4pSmk7a.js";import{F}from"./TextField-Rw_QvELF.js";import{R as Ke}from"./ListPreference-D7dpQk6w.js";import{M as Ve,a as Je}from"./MangaGrid-LFD8BtSM.js";import{C as He,U as Qe}from"./UpdateChecker-jaVZgK2I.js";import{u as $e}from"./useManageMangaLibraryState-BpdbUfZ1.js";import{C as Xe}from"./Checkbox-DCwwhdBB.js";import{T as Ze}from"./TabsMenu-CEYgoN1W.js";import{T as qe}from"./TabsWrapper-Bn-zP_YG.js";import{u as et}from"./useAppTitle-JdwpcA6x.js";import{u as tt}from"./useAppAction-Bzq_gFUG.js";import{C as at}from"./Chip-BDkoBUoe.js";import"./ChaptersDownloadActionMenuItems-xNH-5wQn.js";import"./Card-DurreyfO.js";import"./ListCardContent-DRcDFweV.js";import"./Avatar-nWTNkZKd.js";import"./InputAdornment-utNmnW-6.js";import"./useFormControl-D7IcDija.js";import"./CheckCircle-DCGciNq7.js";import"./MUI.util-wQL_FHN6.js";import"./CardActionArea-B_IdJQPR.js";import"./Link-BOIFR8Id.js";import"./NumberSetting-CQ3rnPU5.js";import"./Slider-Bd1m61Uf.js";import"./useMobilePicker-D4c0SndU.js";import"./SelectSetting-DlLz_9BF.js";import"./Select-Do7H45IH.js";import"./FormGroup-DkqWHukv.js";import"./formControlState-Dq1zat_P.js";import"./StyledFab-f1J7mABk.js";import"./SwitchBase-DJ3Ol6Xe.js";import"./Delete-BwouD7Nu.js";import"./Download-COVBx23C.js";import"./Sync-B8t0T68v.js";import"./use-merged-ref-DW0WJiHJ.js";import"./ListCardAvatar-Bdn-XAtT.js";import"./PlayArrow-DFPnPo2j.js";import"./Progress-bHJqESiC.js";const st={sortDesc:void 0,sortBy:void 0,hasDownloadedChapters:void 0,hasBookmarkedChapters:void 0,hasUnreadChapters:void 0,hasReadChapters:void 0,hasDuplicateChapters:void 0,hasTrackerBinding:{},hasStatus:{}},pe=e=>({...e,hasTrackerBinding:e.hasTrackerBinding?JSON.stringify(e.hasTrackerBinding):void 0,hasStatus:e.hasStatus?JSON.stringify(e.hasStatus):void 0}),rt=e=>{var a,r;return{...e,hasTrackerBinding:(a=se(e.hasTrackerBinding))!=null?a:void 0,hasStatus:(r=se(e.hasStatus))!=null?r:void 0}},ot=(e,a=st,r)=>rt(ye("category",e,pe(a),void 0,r)),ge=(e,a,r)=>ot({...e,meta:xe(e.meta)},a,r),lt=(e,a)=>ge(e,a),ue=(e,a)=>{const r=ge(e,a,C.useEffect);return C.useMemo(()=>r,[e,a])},nt=async(e,a,r)=>je(e,[[a,pe({[a]:r})[a]]]),it=(e,a=O())=>(r,t)=>nt(e,r,t).catch(a),ct={filter:"global.label.filter",sort:"global.label.sort",display:"global.label.display"},dt=[["unreadChapters","library.option.sort.label.by_unread_chapters"],["totalChapters","library.option.sort.label.by_total_chapters"],["alphabetically","library.option.sort.label.alphabetically"],["dateAdded","library.option.sort.label.by_date_added"],["lastRead","library.option.sort.label.by_last_read"],["latestFetchedChapter","library.option.sort.label.by_latest_fetched_chapter"],["latestUploadedChapter","library.option.sort.label.by_latest_uploaded_chapter"]],ht=({category:e,open:a,onClose:r})=>{var p,y;const{t}=B(),l=N.useGetTrackerList(ke),n=Ye.getLoggedIn((y=(p=l.data)==null?void 0:p.trackers.nodes)!=null?y:[]),o=ue(e),i=it(e,g=>re(t("global.error.label.failed_to_save_changes"),"error",oe(g))),{settings:{showTabSize:b,showContinueReadingButton:S,showDownloadBadge:_,showUnreadBadge:f,gridLayout:d}}=D(),x=_e(g=>re(t("search.error.label.failed_to_save_settings"),"error",oe(g)));return s.jsx(Pe,{open:a,onClose:r,tabs:["filter","sort","display"],tabTitle:g=>t(ct[g]),tabContent:g=>g==="filter"?s.jsxs(s.Fragment,{children:[s.jsx(k,{label:t("global.filter.label.unread"),checked:o.hasUnreadChapters,onChange:h=>i("hasUnreadChapters",h)}),s.jsx(k,{label:t("global.filter.label.started"),checked:o.hasReadChapters,onChange:h=>i("hasReadChapters",h)}),s.jsx(k,{label:t("global.filter.label.downloaded"),checked:o.hasDownloadedChapters,onChange:h=>i("hasDownloadedChapters",h)}),s.jsx(k,{label:t("global.filter.label.bookmarked"),checked:o.hasBookmarkedChapters,onChange:h=>i("hasBookmarkedChapters",h)}),s.jsx(k,{label:t("global.filter.label.duplicate_chapters"),checked:o.hasDuplicateChapters,onChange:h=>i("hasDuplicateChapters",h)}),s.jsx(F,{sx:{mt:2},children:t("manga.label.status")}),Object.values(Te).map(h=>s.jsx(k,{label:t(Me[h]),checked:o.hasStatus[h],onChange:u=>i("hasStatus",{...o.hasStatus,[h]:u})},h)),s.jsx(F,{sx:{mt:2},children:t("global.filter.label.tracked")}),n.map(h=>s.jsx(k,{label:h.name,checked:o.hasTrackerBinding[h.id],onChange:u=>i("hasTrackerBinding",{...o.hasTrackerBinding,[h.id]:u})},h.id))]}):g==="sort"?dt.map(([h,u])=>s.jsx(Ue,{label:t(u),checked:o.sortBy===h,sortDescending:o.sortDesc,onClick:()=>h!==o.sortBy?i("sortBy",h):i("sortDesc",!o.sortDesc)},h)):g==="display"?s.jsxs(s.Fragment,{children:[s.jsx(F,{children:t("global.grid_layout.title")}),s.jsxs(Ke,{onChange:h=>L("gridLayout",Number(h.target.value)),value:d,children:[s.jsx(G,{label:t("global.grid_layout.label.compact_grid"),value:M.Compact,checked:d==null||d===M.Compact}),s.jsx(G,{label:t("global.grid_layout.label.comfortable_grid"),value:M.Comfortable,checked:d===M.Comfortable}),s.jsx(G,{label:t("global.grid_layout.label.list"),value:M.List,checked:d===M.List})]}),s.jsx(F,{sx:{mt:2},children:t("library.option.display.badge.title")}),s.jsx(w,{label:t("library.option.display.badge.label.unread_badges"),checked:f,onChange:()=>L("showUnreadBadge",!f)}),s.jsx(w,{label:t("library.option.display.badge.label.download_badges"),checked:_,onChange:()=>L("showDownloadBadge",!_)}),s.jsx(F,{sx:{mt:2},children:t("library.option.display.tab.title")}),s.jsx(w,{label:t("library.option.display.tab.label.show_number_of_items"),checked:b,onChange:()=>x("showTabSize",!b)}),s.jsx(F,{sx:{mt:2},children:t("global.label.other")}),s.jsx(w,{label:t("library.option.display.other.label.show_continue_reading_button"),checked:S,onChange:()=>L("showContinueReadingButton",!S)})]}):null})},pt=({category:e})=>{const{t:a}=B(),[r,t]=C.useState(!1),l=lt(e),n=l.hasDownloadedChapters!=null||l.hasUnreadChapters!=null||l.hasReadChapters!=null||l.hasBookmarkedChapters!=null||l.hasDuplicateChapters!=null||Object.values(l.hasStatus).some(o=>o!=null)||Object.values(l.hasTrackerBinding).some(o=>o!=null);return s.jsxs(s.Fragment,{children:[s.jsx(de,{title:a("settings.title"),children:s.jsx(Ae,{onClick:()=>t(!r),color:n?"warning":"inherit",children:s.jsx(Ge,{})})}),s.jsx(ht,{category:e,open:r,onClose:()=>t(!1)})]})},gt=()=>{},ne=({showFilteredOutMessage:e,message:a,messageExtra:r,...t})=>{const{t:l}=B(),{settings:{gridLayout:n}}=D();return C.useLayoutEffect(()=>(document.body.style.overflowY=n===M.List?"auto":"scroll",()=>{document.body.style.overflowY="auto"}),[]),s.jsx(Ve,{gridWrapperProps:{sx:{p:1}},...t,hasNextPage:!1,loadMore:gt,message:e?l("library.error.label.no_matches"):a,messageExtra:e?void 0:r,gridLayout:n})},ut=({isActive:e,areAllItemsSelected:a,areNoItemsSelected:r,onSelectAll:t,onModeChange:l})=>{const{t:n}=B();return s.jsxs(s.Fragment,{children:[e&&s.jsx(ze,{areAllItemsSelected:a,areNoItemsSelected:r,onChange:t}),s.jsx(de,{title:n(e?"global.button.cancel":"global.button.select_all"),children:s.jsx(Xe,{checkedIcon:s.jsx(He,{}),sx:{padding:"8px",color:"inherit","&.Mui-checked":{color:"inherit"}},checked:e,onChange:(o,i)=>l(i)})})]})},P=(e,a,r)=>{switch(e){case!0:return a();case!1:return r();default:return!0}},R=(e,a)=>P(e,()=>!!a&&a>=1,()=>a===0),be=(e,a)=>P(e,()=>!!a,()=>!a),T=(e,a)=>{const r=e==null?void 0:e.filter(o=>o!=null),t=a==null?void 0:a.filter(o=>o!=null);if(!(r!=null&&r.length))return!0;const l=r.map(U),n=t.map(U).join(", ");return l.every(o=>n.includes(o))},bt=(e,{title:a,genre:r,description:t,artist:l,author:n,source:o,sourceId:i})=>T([e],[a])||T(e==null?void 0:e.split(","),r.map(b=>U(b)))||T([e],[t])||T([e],[l])||T([e],[n])||T([e],[o==null?void 0:o.displayName])||T([e],[i]),mt=(e,a)=>Object.entries(e).map(([r,t])=>{const l=a.trackRecords.nodes.some(n=>n.trackerId===Number(r));return P(t,()=>l,()=>!l)}).every(Boolean),Ct=(e,a)=>Object.entries(e).map(([r,t])=>be(t,r===a.status)).every(Boolean),ft=(e,{hasDownloadedChapters:a,hasUnreadChapters:r,hasReadChapters:t,hasBookmarkedChapters:l,hasDuplicateChapters:n,hasTrackerBinding:o,hasStatus:i})=>R(a,e.downloadCount)&&R(r,e.unreadCount)&&R(t,e.chapters.totalCount-e.unreadCount)&&R(l,e.bookmarkCount)&&be(n,e.hasDuplicateChapters)&&mt(o,e)&&Ct(i,e),St=(e,a,r)=>{const t=r.ignoreFilters&&(a==null?void 0:a.length);return e.filter(l=>{const n=bt(a,l),o=t||ft(l,r);return n&&o})},v=(e=0,a=0)=>Number(e)-Number(a),xt=(e,a)=>e.localeCompare(a),yt=(e,a,r)=>{const t=[...e];switch(a){case"alphabetically":t.sort((l,n)=>xt(l.title,n.title));break;case"dateAdded":t.sort((l,n)=>v(l.inLibraryAt,n.inLibraryAt));break;case"unreadChapters":t.sort((l,n)=>v(l.unreadCount,n.unreadCount));break;case"lastRead":t.sort((l,n)=>{var o,i;return v((o=l.lastReadChapter)==null?void 0:o.lastReadAt,(i=n.lastReadChapter)==null?void 0:i.lastReadAt)});break;case"latestUploadedChapter":t.sort((l,n)=>{var o,i;return v((o=l.latestUploadedChapter)==null?void 0:o.uploadDate,(i=n.latestUploadedChapter)==null?void 0:i.uploadDate)});break;case"latestFetchedChapter":t.sort((l,n)=>{var o,i;return v((o=l.latestFetchedChapter)==null?void 0:o.fetchedAt,(i=n.latestFetchedChapter)==null?void 0:i.fetchedAt)});break;case"totalChapters":t.sort((l,n)=>v(l.chapters.totalCount,n.chapters.totalCount));break}return r&&t.reverse(),t},jt={id:-1},kt=(e,a)=>{const[r]=he("query",Re),t=ue(a!=null?a:jt),{hasUnreadChapters:l,hasReadChapters:n,hasDownloadedChapters:o,hasBookmarkedChapters:i,hasTrackerBinding:b,hasDuplicateChapters:S,hasStatus:_}=t,{settings:f}=D(),d=C.useMemo(()=>St(e,r,{...t,ignoreFilters:f.ignoreFilters}),[e,r,l,n,o,i,b,S,_,f.ignoreFilters]),x=C.useMemo(()=>yt(d,t.sortBy,t.sortDesc),[d,t.sortBy,t.sortDesc]),p=Object.values(t.hasTrackerBinding).some(g=>g!=null),y=(l!=null||n!=null||o!=null||i!=null||!!r||p)&&d.length===0&&e.length>0;return{visibleMangas:x,showFilteredOutMessage:y,filterKey:"".concat(JSON.stringify(t)).concat(f.ignoreFilters)}},ie=Le("span")({display:"flex",alignItems:"center"}),ce=({sx:e,...a})=>s.jsx(at,{...a,size:"small",sx:{...e,marginLeft:"5px"}});function Ca(){var X,Z,q,ee,te,ae;const{t:e}=B(),{settings:{showTabSize:a}}=D(),{data:r,error:t,loading:l,refetch:n}=N.useGetCategories(Fe,{notifyOnNetworkStatusChange:!0}),o=r==null?void 0:r.categories.nodes.filter(c=>c.id!==0||c.id===0&&c.mangas.totalCount),i=o!=null?o:[],b=N.useGetMangas(ve,{}),S=(Z=(X=b.data)==null?void 0:X.mangas.totalCount)!=null?Z:0,[_,f]=he("tab",Ne),d=(q=i.find(c=>c.id===_))!=null?q:i[0],{data:x,error:p,loading:y,refetch:g}=N.useGetCategoryMangas(d==null?void 0:d.id,{skip:!d,notifyOnNetworkStatusChange:!0}),h=(ee=x==null?void 0:x.mangas.nodes)!=null?ee:[],{visibleMangas:u,showFilteredOutMessage:z,filterKey:W}=kt(h,d),Y=C.useCallback(()=>g().catch(O()),[g,d]),me=C.useMemo(()=>u.map(c=>c.id),[u]),[j,I]=C.useState(!1),{areNoItemsForKeySelected:K,areAllItemsForKeySelected:V,selectedItemIds:A,handleSelectAll:E,handleSelection:J,clearSelection:Ce}=$e(u.length,{itemIds:me,currentKey:d==null?void 0:d.id.toString()}),H=C.useCallback((c,m,Se)=>{I(!!(A.length+(m?1:-1))),J(c,m,Se)},[I,J]),Q=C.useMemo(()=>A.map(c=>Be.getFromCache(c,Ie,"MANGA_CHAPTER_STAT_FIELDS")).filter(c=>!!c),[A.length,u]),$=C.useMemo(()=>j?s.jsx(We,{selectedItemsCount:A.length,title:"manga.title",children:(c,m)=>s.jsx(Je,{selectedMangas:Q,onClose:()=>{c(),I(!1),Ce()},setHideMenu:m})}):null,[j,Q]);et(s.jsxs(ie,{children:[e("library.title"),a&&s.jsx(ce,{sx:{color:"inherit"},label:S})]}),e("library.title"),[e,a,S]),tt(s.jsxs(s.Fragment,{children:[!j&&d&&s.jsxs(s.Fragment,{children:[s.jsx(Oe,{}),s.jsx(pt,{category:d}),s.jsx(Qe,{categoryId:d==null?void 0:d.id})]}),s.jsx(ut,{isActive:j,areAllItemsSelected:V,areNoItemsSelected:K,onSelectAll:c=>E(c,[...new Set(u.map(m=>m.id))]),onModeChange:c=>{I(c),c?E(!0,[...new Set(u.map(m=>m.id))]):i.forEach(m=>E(!1,[],m.id.toString()))}})]}),[j,K,V,d]);const fe=c=>{f(c)};return t!=null||b.error?s.jsx(le,{message:e("global.error.label.failed_to_load_data"),messageExtra:(ae=t==null?void 0:t.message)!=null?ae:(te=b.error)==null?void 0:te.message,retry:()=>{t&&n().catch(O()),b.error&&b.refetch().catch(O())}}):l||b.loading?s.jsx(we,{}):i.length===0?s.jsx(le,{message:e("library.error.label.empty")}):i.length===1?s.jsxs(s.Fragment,{children:[s.jsx(ne,{mangas:u,message:e(p?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:p==null?void 0:p.message,isLoading:y,selectedMangaIds:A,isSelectModeActive:j,handleSelection:H,showFilteredOutMessage:!p&&z,retry:p&&Y},W),$]}):s.jsxs(qe,{children:[s.jsx(Ze,{value:d.id,onChange:(c,m)=>fe(m),children:i.map(c=>s.jsx(De,{sx:{flexGrow:1,maxWidth:"unset"},label:s.jsxs(ie,{children:[c.name,a?s.jsx(ce,{label:c.mangas.totalCount}):null]}),value:c.id},c.id))}),i.map(c=>s.jsx(Ee,{index:c.order,currentIndex:d.order,children:c===d&&s.jsx(ne,{mangas:u,message:e(p?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:p==null?void 0:p.message,isLoading:y,selectedMangaIds:A,isSelectModeActive:j,handleSelection:H,showFilteredOutMessage:!p&&z,retry:p&&Y},W)},c.order)),$]})}export{Ca as Library};
