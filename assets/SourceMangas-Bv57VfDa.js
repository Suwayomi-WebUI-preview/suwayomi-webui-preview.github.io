import{g as xe,Y as me,j as e,r as Be,i as Ne,ax as F,Z as He,T as Se,ay as Ve,bi as be,bj as je,bk as ze,B as k,aQ as ve,aA as ye,d as N,f as S,bl as Qe,bm as M,aX as We,u as Ce,e as O,af as Ye,k as X,I as Te,ag as Je,ao as Ke,ap as Xe,aJ as Ze,aK as et,aM as tt,bn as st,m as Z,Q as at,bo as nt,bp as rt,bq as ot,br as it,a2 as ee,N as lt,aB as ct,h as ut,aI as he,s as dt,bs as B,bt as pt,D as gt,c as w,bu as ht,aq as ft,A as xt,bv as mt,aH as St,E as bt,bw as jt,o as fe,bx as vt,n as yt}from"./index-C-NRbn2J.js";import{d as Ct,u as Tt,A as Ft,S as Et}from"./AppbarSearch-XMK7xCaS.js";import{b as Fe,a as Ee,d as _t}from"./ExpandMore-BEFouOIJ.js";import{d as _e}from"./FilterList-D8TvEhcA.js";import{G as Lt}from"./GridLayouts--siKAgtq.js";import{S as kt,O as Mt}from"./SortRadioInput-BTQxd8x0.js";import{b as Le}from"./useManageMangaLibraryState-Bu52EvVG.js";import{u as It}from"./useDebounce-DnwxG5aR.js";import{I as At}from"./InputAdornment-Ba1B_yfN.js";import{T as $t}from"./ThreeStateCheckboxInput-DU2px-ZJ.js";import{S as Ot}from"./StyledFab-CZM_ncxT.js";import{T as wt}from"./TextField-DbGGHPPy.js";import{C as Pt}from"./Chip-DwgYzjwM.js";import{B as Rt}from"./BaseMangaGrid-Bv2x7axm.js";import{g as Dt}from"./MangaGrid-BSwC3wE7.js";import"./ListPreference-h7iT6dUa.js";import"./Trackers-D4pSmk7a.js";import"./Avatar-CYWTEGlm.js";import"./Info-s1022MQE.js";import"./CheckCircle-Di2xQ0qU.js";import"./Mangas-BPXmRPR1.js";import"./NumberSetting-CWXMAhoj.js";import"./useMobilePicker-Bc_5vyUD.js";import"./SelectSetting-2MSXG0Ui.js";import"./Sync-D6ciS1Ub.js";import"./PlayArrow-B7NCVHVC.js";function Gt(){const[t,a]=xe("source-grid-layout",me.Compact);return e.jsx(Lt,{gridLayout:t,onChange:a})}var te={},qt=Ne;Object.defineProperty(te,"__esModule",{value:!0});var ke=te.default=void 0,Ut=qt(Be()),Bt=e;ke=te.default=(0,Ut.default)((0,Bt.jsx)("path",{d:"M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3m3-10H5V5h10z"}),"Save");const Nt=t=>{const{state:a,name:r,position:o,group:s,updateFilterValue:l,update:n}=t,[c,i]=F.useState(a),x=u=>{i(u.target.checked);const g=n.filter(j=>!(o===j.position&&s===j.group));l([...g,{type:"checkBoxState",position:o,state:u.target.checked,group:s}])};return a!==void 0?e.jsx(He,{label:r,checked:c,onChange:x}):null},Ht=({name:t})=>e.jsx(Se,{sx:{mt:2},variant:"subtitle2",children:t},t);function Vt(t,a,r,o,s,l,n){const[c,i]=F.useState(r);if(t){const x=g=>{const j=t.indexOf("".concat(g.target.value));i(j);const d=l.filter(p=>!(o===p.position&&n===p.group));s([...d,{type:"selectState",position:o,state:j,group:n}])},u=t.map(g=>e.jsx(Ve,{value:g,children:g},"".concat(a," ").concat(g)));return e.jsxs(be,{sx:{my:1},variant:"standard",children:[e.jsx(je,{children:a}),e.jsx(ze,{name:a,value:t[c],label:a,onChange:x,children:u})]})}return null}const zt=({values:t,name:a,state:r,position:o,updateFilterValue:s,update:l,group:n})=>Vt(t,a,r,o,s,l,n),Qt=t=>{const{values:a,name:r,state:o,position:s,group:l,updateFilterValue:n,update:c}=t,[i,x]=F.useState(o),[u,g]=F.useState(!1),j=()=>{g(!u)};if(a){const d=p=>{const h=i;h.index===p?h.ascending=!h.ascending:h.ascending=!0,h.index=p,x(h);const y=c.filter(b=>!(s===b.position&&l===b.group));n([...y,{type:"sortState",position:s,state:h,group:l}])};return e.jsxs(k,{sx:{mx:-2},children:[e.jsxs(ve,{onClick:j,children:[e.jsx(ye,{primary:r}),u?e.jsx(Fe,{}):e.jsx(Ee,{})]}),e.jsx(Le,{in:u,children:e.jsx(N,{sx:{mx:4},children:a.map((p,h)=>e.jsx(kt,{label:p,checked:i.index===h,sortDescending:!i.ascending,onClick:()=>d(h)},"".concat(r," ").concat(p)))})})]})}return null},Wt=t=>{const{state:a,name:r,position:o,group:s,updateFilterValue:l,update:n}=t,[c,i]=F.useState(a||""),x=It(c,500);return S.useEffect(()=>{const u=n.filter(g=>!(o===g.position&&s===g.group));l([...u,{type:"textState",position:o,state:x,group:s}])},[x]),a!==void 0?e.jsxs(be,{sx:{my:1},variant:"standard",children:[e.jsx(je,{children:r}),e.jsx(Qe,{name:r,value:c,onChange:({target:{value:u}})=>i(u),endAdornment:e.jsx(At,{position:"end",children:e.jsx(Ct,{})})})]}):null},Yt=t=>{switch(t){case M.Ignore:return 0;case M.Include:return 1;case M.Exclude:return 2;default:throw new Error("Unexpected TriState ".concat(t))}},Jt=t=>{switch(t){case 0:return M.Ignore;case 1:return M.Include;case 2:return M.Exclude;default:throw new Error("Unexpected state number ".concat(t))}},Kt=t=>{const{state:a,name:r,position:o,group:s,updateFilterValue:l,update:n}=t,[c,i]=F.useState(Yt(a)),x=u=>{const g=u===void 0?0:u?1:2;i(g);const j=n.filter(d=>!(o===d.position&&s===d.group));l([...j,{type:"triState",position:o,state:Jt(g),group:s}])};return a!==void 0?e.jsx($t,{label:r,checked:[void 0,!0,!1][c],onChange:u=>x(u)}):null},Xt=t=>{const{state:a,name:r,position:o,updateFilterValue:s,update:l}=t,[n,c]=F.useState(!1);return e.jsxs(k,{sx:{mx:-2},children:[e.jsxs(ve,{onClick:()=>c(!n),children:[e.jsx(ye,{primary:r}),n?e.jsx(Fe,{}):e.jsx(Ee,{})]}),e.jsx(Le,{in:n,children:e.jsx(N,{sx:{mx:4},children:e.jsx(Me,{sourceFilter:a,group:o,updateFilterValue:s,update:l})})})]})},Zt=({name:t})=>e.jsx(We,{sx:{my:1},textAlign:"center",children:t},t);function Me({sourceFilter:t,group:a,updateFilterValue:r,update:o}){return e.jsx(N,{children:t.map((s,l)=>{var c,i;let n=o.find(x=>x.group===a&&x.position===l);switch(n=n&&n.state,s.type){case"CheckBoxFilter":return e.jsx(Nt,{name:s.name,state:n!=null?n:s.CheckBoxFilterDefault,position:l,group:a,updateFilterValue:r,update:o},"filters ".concat(s.name));case"GroupFilter":return e.jsx(Xt,{name:s.name,state:s.filters,position:l,updateFilterValue:r,update:o},"filters ".concat(s.name));case"HeaderFilter":return e.jsx(Ht,{name:s.name},"filters ".concat(s.name));case"SelectFilter":return e.jsx(zt,{name:s.name,values:s.values,state:n!=null?parseInt(n,10):s.SelectFilterDefault,position:l,group:a,updateFilterValue:r,update:o},"filters ".concat(s.name));case"SeparatorFilter":return e.jsx(Zt,{name:s.name},"filters ".concat(s.name));case"SortFilter":return e.jsx(Qt,{name:s.name,values:s.values,state:n!=null?n:{ascending:(c=s.SortFilterDefault)==null?void 0:c.ascending,index:(i=s.SortFilterDefault)==null?void 0:i.index},position:l,group:a,updateFilterValue:r,update:o},"filters ".concat(s.name));case"TextFilter":return e.jsx(Wt,{name:s.name,state:n!=null?n:s.TextFilterDefault,position:l,group:a,updateFilterValue:r,update:o},"filters ".concat(s.name));case"TriStateFilter":return e.jsx(Kt,{name:s.name,state:n!=null?n:s.TriStateFilterDefault,position:l,group:a,updateFilterValue:r,update:o},"filters ".concat(s.name));default:throw new Error('Unknown source filter "'.concat(s,'"'))}})},"filters ".concat(a))}function es({savedSearches:t={},selectSavedSearch:a,updateSavedSearches:r,sourceFilter:o,updateFilterValue:s,resetFilterValue:l,setTriggerUpdate:n,update:c}){const{t:i}=Ce(),[x,u]=S.useState(!1),[g,j]=S.useState(""),d=Object.keys(t),p=!!d.length;function h(){l(0),u(!1)}function y(){n(0),u(!1)}return e.jsxs(e.Fragment,{children:[e.jsxs(Ot,{onClick:()=>u(!x),variant:"extended",color:"primary",children:[e.jsx(_e,{}),i("global.button.filter")]}),e.jsxs(Mt,{open:x,onClose:()=>u(!1),children:[e.jsxs(k,{sx:{p:2,pb:p?void 0:0},children:[e.jsxs(k,{sx:{display:"flex",pb:1},children:[e.jsx(O,{onClick:h,children:i("global.button.reset")}),e.jsx(Ye,{variant:"dialog",popupId:"source-browse-save-search",children:b=>e.jsxs(e.Fragment,{children:[e.jsx(X,{title:i("source.filter.save_search.label.save"),children:e.jsx(Te,{sx:{marginLeft:"auto"},...Je(b),children:e.jsx(ke,{})})}),e.jsxs(Ke,{...Xe(b),maxWidth:"xs",fullWidth:!0,children:[e.jsx(Ze,{children:i("source.filter.save_search.dialog.label.title")}),e.jsx(et,{children:e.jsx(wt,{sx:{width:"100%"},value:g,onChange:C=>j(C.target.value),slotProps:{htmlInput:{maxLength:50}}})}),e.jsxs(tt,{children:[e.jsx(O,{onClick:()=>{j(""),b.close()},children:i("global.button.cancel")}),e.jsx(O,{onClick:()=>{r(g,"create"),j(""),b.close()},children:i("global.button.ok")})]})]})]})}),e.jsx(O,{variant:"contained",onClick:y,children:i("global.button.submit")})]}),p&&e.jsxs(e.Fragment,{children:[e.jsx(Se,{sx:{pb:1},children:"Saved searches"}),e.jsx(N,{sx:{flexDirection:"row"},children:d.map(b=>e.jsx(Pt,{label:b,onClick:()=>{u(!1),a(b)},onDelete:()=>{st({title:i("global.label.are_you_sure"),message:i("source.filter.save_search.dialog.label.delete",{name:b}),actions:{confirm:{title:i("global.button.delete")}}}).then(()=>r(b,"delete")).catch(Z())},deleteIcon:e.jsx(X,{title:i("source.filter.save_search.label.delete"),children:e.jsx(at,{})}),variant:"outlined"}))})]})]}),e.jsx(k,{sx:{pb:2,mx:2},children:e.jsx(Me,{sourceFilter:o,updateFilterValue:s,group:void 0,update:c})})]})]})}const ts={savedSearches:void 0},Ie=t=>({...t,savedSearches:t.savedSearches?JSON.stringify(t.savedSearches):void 0}),ss=t=>{var a;return{...t,savedSearches:(a=ot(t.savedSearches))!=null?a:void 0}},as=(t,a)=>ss(nt("source",{...t,meta:rt(t.meta)},Ie(ts),void 0,!0,a)),ns=t=>{const a=as(t,S.useEffect);return S.useMemo(()=>a,[t])},rs=async(t,a,r)=>it(t,[[a,Ie({[a]:r})[a]]]),os=(t,a=Z())=>(r,o)=>rs(t,r,o).catch(a),is={id:"-1"},ls=ee("div")(({theme:t})=>({display:"flex",position:"sticky",width:"100%",zIndex:1,padding:t.spacing(1),gap:t.spacing(1),backgroundColor:t.palette.background.default})),K=ee(O)(()=>({})),cs=ee(k)(()=>({minHeight:"100%",position:"relative"}));var us=(t=>(t[t.POPULAR=0]="POPULAR",t[t.LATEST=1]="LATEST",t[t.SEARCH=2]="SEARCH",t))(us||{});const ds={0:"manga.error.label.no_mangas_found",1:"manga.error.label.no_mangas_found",2:"manga.error.label.no_matches"},ps=t=>{const a={},r=[];return t.forEach(o=>{!!a[o.id]||(a[o.id]=o,r.push(o))}),r},gs=(t,a,r,o,s,l)=>{var d;let n;switch(a){case 0:n=w.useGetSourcePopularMangas(t,s);break;case 1:n=w.useGetSourceLatestMangas(t,s);break;case 2:n=w.useSourceSearch(t,r!=null?r:"",o.map(p=>{const{position:h,state:y,group:b}=p;return b!==void 0?{position:b,groupChange:{position:h,[p.type]:y}}:{position:h,[p.type]:y}}),s);break;default:throw new Error('Unknown ContentType "'.concat(a,'"'))}const c=n[1],i=c.findLastIndex(p=>{var h;return!!((h=p.data)!=null&&h.fetchSourceManga)}),x=c[i],u=c.slice(-1)[0].isLoading;let g=!u;const j=S.useMemo(()=>{let p=[];return c.forEach((h,y)=>{var A,v,P;const b=(P=(v=(A=h.data)==null?void 0:A.fetchSourceManga)==null?void 0:v.mangas)!=null?P:[],C=b.filter(E=>!l||!E.inLibrary),I=ps([...p,...C]);g=!u&&c.length===y+1&&!C.length&&!!b.length,p=I}),p},[c,l]);return i===-1?[n[0],{...n[1][n[1].length-1],filteredOutAllItemsOfFetchedPage:g}]:[n[0],{...c[c.length-1],data:{...x.data,fetchSourceManga:{...x.data.fetchSourceManga,hasNextPage:c.length>i+1?!1:!!((d=x.data.fetchSourceManga)!=null&&d.hasNextPage),mangas:j}},filteredOutAllItemsOfFetchedPage:g}]};function Ns(){var le,ce,ue,de,pe;const{t}=Ce(),{setTitle:a,setAction:r,appBarHeight:o}=S.useContext(lt),{sourceId:s}=ct(),l=ut(),n=he(),{key:c,state:i}=n,{contentType:x=0,clearCache:u=!1}=(le=he().state)!=null?le:{},{settings:{hideLibraryEntries:g}}=dt(),[j]=xe("source-grid-layout",me.Compact),[d]=Tt("query",Et),[p,h]=B("source-mangas-".concat(s,"-filters"),[]),[y,b]=B("source-mangas-location-".concat(c,"-").concat(s,"-filters"),p!=null?p:[]),[C,I]=S.useState(y),[se,A]=B("source-mangas-".concat(s,"-content-type"),x),[v,P]=B("source-mangas-location-".concat(c,"-").concat(s,"-content-type"),d?2:se),E=S.useCallback(()=>{pt.session.setItem(Dt(n),void 0,!1),window.scrollTo(0,0)},[c]),ae=S.useRef(d),ne=S.useRef(()=>{}),R=S.useRef(null),[re,Ae]=S.useState(0);gt(R,S.useCallback(()=>{var m,T;return Ae((T=(m=R.current)==null?void 0:m.clientHeight)!=null?T:0)},[R])),ae.current!==d&&v===2&&(ae.current=d,ne.current(new Error("SourceMangas(".concat(s,"): search string changed"))),E()),S.useEffect(()=>()=>{h(void 0),A(void 0)},[s]);const H=m=>{h(m),b(m),E()},oe=m=>{A(m),P(m)},[V,{data:_,error:D,isLoading:z,size:G,abortRequest:$e,filteredOutAllItemsOfFetchedPage:Q}]=gs(s,v,d,y,1,g);ne.current=$e;const W=z||Q,Y=(ue=(ce=_==null?void 0:_.fetchSourceManga)==null?void 0:ce.mangas)!=null?ue:[],q=!!((de=_==null?void 0:_.fetchSourceManga)!=null&&de.hasNextPage),{data:J}=w.useGetSource(ht,s),f=J==null?void 0:J.source,Oe=(pe=f==null?void 0:f.filters)!=null?pe:[],{savedSearches:L={}}=ns(f!=null?f:is),ie=os(f!=null?f:{id:"-1"},m=>yt(t("global.error.label.failed_to_save_changes"),"error",fe(m))),we=S.useCallback(m=>{const{query:T,filters:$}=L[m];$&&(I($),H($)),l({pathname:"",search:T?"query=".concat(T):void 0},{state:{...i,contentType:2}})},[L,i]),Pe=S.useCallback((m,T)=>{if(T==="delete"){const ge={...L};delete ge[m],ie("savedSearches",ge);return}const $={...L,[m]:{query:d!=null?d:void 0,filters:C}};ie("savedSearches",$)},[L,d,C]),Re=W?void 0:t(ds[v]),De=s==="0"?e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:[t("source.local_source.label.checkout")," "]}),e.jsx(ft,{href:"https://github.com/Suwayomi/Suwayomi-Server/wiki/Local-Source",target:"_blank",rel:"noreferrer",children:t("source.local_source.label.guide")})]}):void 0,U=S.useCallback((m,T)=>{oe(m),E(),d&&!T&&l({pathname:""},{state:{...i,contentType:m}})},[oe,d,E]);!!d&&v!==2&&U(2,d);const Ge=S.useCallback(()=>{q&&V(G+1)},[G,q,v]),qe=()=>{I([]),H([])};S.useEffect(()=>{Q&&q&&!z&&V(G+1)},[Q,z]),S.useEffect(()=>{!u||!vt.REVALIDATION.includes(s)||w.clearBrowseCacheFor(s)},[u]),S.useLayoutEffect(()=>{var m;return a((m=f==null?void 0:f.displayName)!=null?m:t("source.title_one")),r(e.jsxs(e.Fragment,{children:[e.jsx(Ft,{}),e.jsx(Gt,{}),(f==null?void 0:f.isConfigurable)&&e.jsx(X,{title:t("settings.title"),children:e.jsx(Te,{onClick:()=>l(xt.sources.childRoutes.configure.path(s)),"aria-label":"display more actions",edge:"end",color:"inherit",size:"large",children:e.jsx(mt,{})})})]})),()=>{a(""),r(null)}},[t,f]);const Ue=Y.length?St:bt;return e.jsxs(cs,{children:[e.jsxs(ls,{ref:R,sx:{top:"".concat(o,"px")},children:[e.jsx(K,{variant:v===0?"contained":"outlined",startIcon:e.jsx(_t,{}),onClick:()=>U(0),children:t("global.button.popular")}),(f==null?void 0:f.supportsLatest)===void 0||f.supportsLatest?e.jsx(K,{disabled:!(f!=null&&f.supportsLatest),variant:v===1?"contained":"outlined",startIcon:e.jsx(jt,{}),onClick:()=>U(1),children:t("global.button.latest")}):null,e.jsx(K,{variant:v===2?"contained":"outlined",startIcon:e.jsx(_e,{}),onClick:()=>U(2,d),children:t("global.button.filter")})]}),(W||!D||!!D&&!!Y.length)&&e.jsx(Rt,{gridWrapperProps:{sx:{px:1,pb:1}},mangas:Y,hasNextPage:q,loadMore:Ge,message:Re,messageExtra:De,topOffset:re,isLoading:W,gridLayout:j,mode:"source",inLibraryIndicator:!0},v),D&&e.jsx(Ue,{message:t("global.error.label.failed_to_load_data"),messageExtra:fe(D),retry:()=>V(G).catch(Z()),topOffset:re}),v===2&&e.jsx(es,{savedSearches:L,selectSavedSearch:we,updateSavedSearches:Pe,sourceFilter:Oe,updateFilterValue:I,setTriggerUpdate:()=>{H(C)},resetFilterValue:qe,update:C})]})}export{us as SourceContentType,Ns as SourceMangas};
