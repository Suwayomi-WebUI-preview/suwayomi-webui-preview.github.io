import{_ as N,ej as M,r as u,dB as _,by as v,dL as I,bj as U,av as T,m as S,g as G,d7 as L}from"./index-ogzEquCo.js";import{c as B,b as W,C as g}from"./Chapters-CUpm7Bks.js";import{a as P}from"./Asserts-DuTQWu6A.js";var n=(A=>(A[A.MANGA=0]="MANGA",A[A.COMIC=1]="COMIC",A[A.WEBTOON=2]="WEBTOON",A[A.MANHWA=3]="MANHWA",A[A.MANHUA=4]="MANHUA",A))(n||{});const Y={id:-1},V={id:-2},z="1 / 1.5",K={[N.Cancelled]:"manga.status.cancelled",[N.Completed]:"manga.status.completed",[N.Licensed]:"manga.status.licensed",[N.Ongoing]:"manga.status.ongoing",[N.OnHiatus]:"manga.status.hiatus",[N.PublishingFinished]:"manga.status.publishing_finished",[N.Unknown]:"manga.status.unknown"},F={...B,remove_from_library:{always:!0,bulkAction:!0},change_categories:{always:!1,bulkAction:!1},migrate:{always:!1,bulkAction:!1},track:{always:!1,bulkAction:!1}},R={...W,remove_from_library:{action:{single:"manga.action.library.remove.label.action",selected:"manga.action.library.remove.button.selected"},confirmation:"manga.action.library.remove.label.confirmation",success:"manga.action.library.remove.label.success",error:"manga.action.library.remove.label.error"},change_categories:{action:{single:"manga.action.category.label.action",selected:"manga.action.category.button.selected"},confirmation:"manga.action.category.label.confirmation",success:"manga.action.category.label.success",error:"manga.action.category.label.error"},migrate:{action:{single:"global.button.migrate",selected:"global.button.migrate"},success:"manga.action.migrate.label.success",error:"manga.action.migrate.label.error"},track:{action:{single:"manga.action.track.add.label.action",selected:"manga.action.track.add.label.action"},success:"manga.action.track.add.label.success",error:"manga.action.track.add.label.error"}},H={[n.MANGA]:[],[n.COMIC]:["8muses","allporncomic","ciayo comics","comicextra","comicpunch","cyanide","dilbert","eggporncomics","existential comics","hiveworks comics","milftoon","myhentaicomics","myhentaigallery","gunnerkrigg","oglaf","patch friday","porncomix","questionable content","readcomiconline","read comics online","swords comic","teabeer comics","xkcd"],[n.WEBTOON]:["mangatoon","manmanga","toomics","webcomics","webtoons","webtoon"],[n.MANHWA]:["hiperdex","hmanhwa","instamanhwa","manhwa18","manhwa68","manhwa365","manhwahentaime","manhwamanga","manhwatop","manhwa","manytoon","manwha","readmanhwa","skymanga","toonily","webtoonxyz"],[n.MANHUA]:["1st kiss manhua","hero manhua","manhuabox","manhuaus","manhuas","manhuas","readmanhua","wuxiaworld","manhua"]},x={[n.MANGA]:["manga.type.manga"],[n.COMIC]:["manga.type.comic"],[n.WEBTOON]:["manga.type.webtoon","manga.type.long_strip"],[n.MANHWA]:["manga.type.manhwa","manga.type.long_strip"],[n.MANHUA]:["manga.type.manhua","manga.type.long_strip"]},D=/\s*[,|ã€]\s*/;class r{static getIds(e){return e.map(t=>t.id)}static getFromCache(e,t=M,a="MANGA_BASE_FIELDS"){return u.graphQLClient.client.cache.readFragment({id:u.graphQLClient.client.cache.identify({__typename:"MangaType",id:e}),fragment:t,fragmentName:a})}static isNotDownloaded({downloadCount:e}){return e===0}static getNotDownloaded(e){return e.filter(r.isNotDownloaded)}static isFullyDownloaded({downloadCount:e,chapters:{totalCount:t}}){return e===t}static getFullyDownloaded(e){return e.filter(r.isFullyDownloaded)}static isPartiallyDownloaded(e){return!r.isNotDownloaded(e)&&!r.isFullyDownloaded(e)}static getPartiallyDownloaded(e){return e.filter(r.isPartiallyDownloaded)}static isUnread({unreadCount:e,chapters:{totalCount:t}}){return e===t}static getUnread(e){return e.filter(r.isUnread)}static isFullyRead({unreadCount:e}){return e===0}static getFullyRead(e){return e.filter(r.isFullyRead)}static isPartiallyRead(e){return!r.isUnread(e)&&!r.isFullyRead(e)}static getPartiallyRead(e){return e.filter(r.isPartiallyRead)}static getThumbnailUrl(e){var a;const t=_.addParams((a=e.thumbnailUrl)!=null?a:"",{fetchedAt:e.thumbnailUrlLastFetched,sourceId:e.sourceId});return u.getValidImgUrlFor(t)}static getDuplicateLibraryMangas(e){return u.getMangas(v,{condition:{inLibrary:!0},filter:{title:{likeInsensitive:e}}})}static async getChapterIdsWithState(e,t){const{data:a}=await u.getMangasChapterIdsWithState(e,t).response;return a.chapters.nodes}static async downloadChapters(e,{size:t,onlyUnread:a,downloadAhead:i=!1}={},o){const[c,l]=await Promise.all([r.getChapterIdsWithState(e,{isRead:a?!1:void 0,isDownloaded:!1}),i?r.getChapterIdsWithState(e,{isRead:!1,isDownloaded:!0}):[]]),m=e.map(h=>[String(h),t]),d=Object.groupBy(c,({mangaId:h})=>h),s=Object.groupBy(l,({mangaId:h})=>h),b=Object.entries(s).map(([h,f=[]])=>{const w=Math.max(0,(t!=null?t:f.length)-f.length);return[h,i?w:t]}),y=Object.entries(Object.fromEntries([...m,...b])).map(([h,f])=>{var E;const w=(E=d[Number(h)])!=null?E:[];if(!w.length)return[];if(f===void 0)return w;const C=g.removeDuplicates(w[0],w).slice(0,f);return g.addDuplicates(C,w)}).flat();return y.length?g.download(g.getIds(y),o):Promise.resolve()}static async deleteChapters(e,t){const a=await r.getChapterIdsWithState(e,{isDownloaded:!0});return g.delete(g.getIds(a),t)}static async markAsRead(e,t=!1,a){const i=await r.getChapterIdsWithState(e,{isRead:!1});return g.markAsRead(i,t,e.length===1?e[0]:void 0,a)}static async markAsUnread(e,t){const a=await r.getChapterIdsWithState(e,{isRead:!0});return g.markAsUnread(g.getIds(a),t)}static async removeFromLibrary(e,t){const{removeMangaFromCategories:a}=await I();return r.executeAction("remove_from_library",e.length,()=>u.updateMangas(e,{updateMangas:{inLibrary:!1},updateMangasCategories:a?{clearCategories:!0}:void 0}).response,t)}static async changeCategories(e,t,a){return r.executeAction("change_categories",e.length,()=>u.updateMangasCategories(e,t).response,a)}static migrateChapters(e,t,a,i){var s,b;if(!t.chapters||!((s=a.fetchChapters)!=null&&s.chapters))throw new Error("Chapters are missing");const o=t.chapters.nodes,c=(b=a.fetchChapters)==null?void 0:b.chapters,l=g.getMatchingChapterNumberChapters(o,c),m=[],d=[];return l.forEach(([p,y])=>{const{isRead:h,isBookmarked:f}=p;h&&m.push(y.id),f&&d.push(y.id)}),{copy:()=>[m.length&&u.updateChapters(m,{isRead:!0}).response,d.length&&u.updateChapters(d,{isBookmarked:!0}).response].filter(p=>!!p),cleanup:()=>{var p,y;return e==="migrate"?[i?u.deleteDownloadedChapters(g.getIds(g.getDownloaded((y=(p=t.chapters)==null?void 0:p.nodes)!=null?y:[]))).response:Promise.resolve()]:[]}}}static migrateTracking(e,t,a){if(!t.trackRecords)throw new Error("TrackRecords of manga to migrate are missing");if(!a.trackRecords)throw new Error("TrackRecords of manga to migrate to are missing");const i=t.trackRecords.nodes.filter(o=>{var c;return(c=a.trackRecords)==null?void 0:c.nodes.every(l=>o.remoteId!==l.remoteId)});return{copy:()=>i.map(o=>u.bindTracker(a.id,o.trackerId,o.remoteId,o.private).response),cleanup:()=>{var o,c;return e==="migrate"?(c=(o=t.trackRecords)==null?void 0:o.nodes.map(l=>u.unbindTracker(l.id).response))!=null?c:[]:[]}}}static migrateManga(e,t,a,i,o){if(i&&!(t!=null&&t.categories))throw new Error("Categories are missing");return{copy:()=>{var c;return[u.updateManga(a.id,{updateManga:{inLibrary:!0},updateMangaCategories:i?{addToCategories:(c=t.categories)==null?void 0:c.nodes.map(l=>l.id)}:void 0}).response]},cleanup:()=>e==="migrate"?[u.updateManga(t.id,{updateManga:{inLibrary:!1},updateMangaCategories:o?{clearCategories:!0}:void 0}).response]:[]}}static async migrate(e,t,{mode:a,migrateChapters:i,migrateCategories:o,migrateTracking:c,deleteChapters:l},m){return r.executeAction("migrate",1,async()=>{var h,f;const[{data:d},{data:s},{removeMangaFromCategories:b}]=await Promise.all([u.getMangaToMigrate(e,{migrateChapters:i,migrateCategories:o,migrateTracking:c,deleteChapters:l}).response,u.getMangaToMigrateToFetch(t,{migrateChapters:i,migrateCategories:o,migrateTracking:c,apolloOptions:{errorPolicy:"all"}}).response,I()]);if(!d.manga||!((h=s==null?void 0:s.fetchManga)!=null&&h.manga))throw new Error("Mangas::migrate: missing manga data");if(i&&!d.manga.chapters)throw new Error("Mangas::migrate: missing chapters data");(f=s.fetchChapters)!=null&&f.chapters||(s.fetchChapters={chapters:[]});const p=async(w,...O)=>Promise.all(O.map(k=>k[w]()).flat());await(async(...w)=>{const O=["copy","cleanup"],k=w.filter(([C])=>C).map(([,C])=>C());for(const C of O)await p(C,...k)})([i,()=>r.migrateChapters(a,d.manga,s,!!l)],[c,()=>r.migrateTracking(a,d.manga,s.fetchManga.manga)],[!0,()=>r.migrateManga(a,d.manga,s.fetchManga.manga,!!o,b)])},m)}static async executeAction(e,t,a,i){const{always:o,bulkAction:c,bulkActionCountForce:l}=F[e],m=!i&&(o||c&&t>1||l&&t>=l),d=R[e].confirmation;try{if(m){P(d);try{await U.show({title:T("global.label.are_you_sure"),message:T(d,{count:t}),actions:{confirm:{title:T("global.button.ok")}}})}catch(s){return}}await a(),S(T(R[e].success,{count:t}),"success")}catch(s){throw S(T(R[e].error,{count:t}),"error",G(s)),s}}static async performAction(e,t,{wasManuallyMarkedAsRead:a,changeCategoriesPatch:i,mangaIdToMigrateTo:o,downloadAhead:c,onlyUnread:l,size:m,...d},s){switch(e){case"download":return r.downloadChapters(t,{downloadAhead:c,onlyUnread:l,size:m},s);case"delete":return r.deleteChapters(t,s);case"mark_as_read":return r.markAsRead(t,a,s);case"mark_as_unread":return r.markAsUnread(t,s);case"remove_from_library":return r.removeFromLibrary(t,s);case"change_categories":return r.changeCategories(t,i,s);case"migrate":return r.migrate(t[0],o,d,s);default:throw new Error('Mangas::performAction: unknown action "'.concat(e,'"'))}}static getType(e){return r.isType(e,n.MANGA)?n.MANGA:r.isType(e,n.COMIC)?n.COMIC:r.isType(e,n.WEBTOON)?n.WEBTOON:r.isType(e,n.MANHWA)?n.MANHWA:r.isType(e,n.MANHUA)?n.MANHUA:n.MANGA}static isType(e,t){var l,m;const a=Object.entries(x).map(([d,s])=>{var b;return[d,["en",L.language,(b=e.source)==null?void 0:b.lang].filter(p=>!!p).flatMap(p=>s.flatMap(y=>T(y,{lng:p})))]}),i=Object.fromEntries(a),o=e.genre.some(d=>i[t].some(s=>d.toLowerCase().includes(s.toLowerCase()))),c=H[t].includes((m=(l=e.source)==null?void 0:l.name.toLowerCase())!=null?m:"");return o||c}static isLongStripType(e){return r.isType(e,n.WEBTOON)||r.isType(e,n.MANHWA)||r.isType(e,n.MANHUA)}static getArtists(e){var t;return(t=e.artist)==null?void 0:t.split(D)}static getAuthors(e){var t;return(t=e.author)==null?void 0:t.split(D)}static createLocationState(e,t){return{mangaTitle:e.title,mode:t}}}export{Y as F,V as G,K as M,r as a,z as b,R as c};
