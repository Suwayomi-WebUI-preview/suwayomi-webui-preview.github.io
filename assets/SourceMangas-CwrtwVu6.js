import{d as me,y as ge,j as e,r as Ae,i as Ge,a1 as T,T as he,a2 as De,B as I,aL as fe,a4 as xe,S as V,c as x,bb as M,az as Re,u as Se,b as O,P as qe,f as ee,I as be,K as Ne,X as Be,Y as Ue,aF as He,aG as Ve,aH as ze,h as H,b8 as We,b7 as Ye,bc as Ke,bd as Qe,C as te,N as Je,a5 as Xe,e as Ze,av as pe,l as et,be as U,bf as tt,a as A,bg as at,bh as st,bi as rt,bj as nt,m as ot}from"./index-9T0dGC6a.js";import{d as it,u as lt,A as ct,S as ut}from"./AppbarSearch-CaP6chi5.js";import{b as je,a as ve,d as dt}from"./ExpandMore-DdLBPBQj.js";import{d as ye}from"./FilterList-CiWmfWOE.js";import{G as pt}from"./GridLayouts-9c99p38e.js";import{d as mt}from"./Delete-CJUXWdMZ.js";import{S as gt,O as ht}from"./SortRadioInput-BHPIsWnA.js";import{C as ft}from"./CheckboxInput-C2U5EzLT.js";import{a as Ce,I as Te,S as xt,b as St,T as bt}from"./TextField-YGJYPG8k.js";import{C as Fe}from"./Collapse-CnqAxXWX.js";import{u as jt}from"./useDebounce-BwyELCHH.js";import{I as vt}from"./InputAdornment-HmS6Hwo3.js";import{T as yt}from"./ThreeStateCheckboxInput-BGSVgUlo.js";import{S as Ct}from"./StyledFab-Ck5C-VTM.js";import{o as Tt}from"./useManageMangaLibraryState-C2keb8qW.js";import{C as Ft}from"./Chip-B183RkoD.js";import{B as _t}from"./BaseMangaGrid-DUHbdjUi.js";import{g as Lt}from"./MangaGrid-DVUSi8D6.js";import{E as Et,a as kt}from"./EmptyViewAbsoluteCentered-CUXYThCZ.js";import{L as It}from"./Link-i4OjAvbS.js";import"./Checkbox-i1cxnMOo.js";import"./SwitchBase-CoxLhW8K.js";import"./ListPreference-vBKgCxBP.js";import"./Trackers-D4pSmk7a.js";import"./Card-CjmyazBt.js";import"./CardContent-BHmsb10w.js";import"./Avatar-D16w86hT.js";import"./Info-3t5z6fXJ.js";import"./CheckCircle-OMx21FoH.js";import"./SpinnerImage-DRLiPxEQ.js";import"./Refresh-DuVXKLkt.js";import"./TypographyMaxLines-DZX_2562.js";import"./CardActionArea-AfDFJKyi.js";import"./NumberSetting-CPFqlTCz.js";import"./useMobilePicker-D6ikC4S5.js";import"./SelectSetting-CcYk0I8V.js";import"./Select-Dl88ef0d.js";import"./Mangas-8SNM_FSc.js";import"./Chapters-hp9rJTIS.js";import"./index-C34neuq_.js";import"./Download-CAY5ZDZL.js";import"./Sync-7uFrlBk2.js";import"./PlayArrow-CsKqjTw_.js";function Mt(){const[t,s]=me("source-grid-layout",ge.Compact);return e.jsx(pt,{gridLayout:t,onChange:s})}var ae={},$t=Ge;Object.defineProperty(ae,"__esModule",{value:!0});var _e=ae.default=void 0,Pt=$t(Ae()),wt=e;_e=ae.default=(0,Pt.default)((0,wt.jsx)("path",{d:"M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3m3-10H5V5h10z"}),"Save");const Ot=t=>{const{state:s,name:n,position:o,group:a,updateFilterValue:c,update:r}=t,[u,i]=T.useState(s),h=d=>{i(d.target.checked);const m=r.filter(S=>!(o===S.position&&a===S.group));c([...m,{type:"checkBoxState",position:o,state:d.target.checked,group:a}])};return s!==void 0?e.jsx(ft,{label:n,checked:u,onChange:h}):null},At=({name:t})=>e.jsx(he,{sx:{mt:2},variant:"subtitle2",children:t},t);function Gt(t,s,n,o,a,c,r){const[u,i]=T.useState(n);if(t){const h=m=>{const S=t.indexOf("".concat(m.target.value));i(S);const j=c.filter(g=>!(o===g.position&&r===g.group));a([...j,{type:"selectState",position:o,state:S,group:r}])},d=t.map(m=>e.jsx(De,{value:m,children:m},"".concat(s," ").concat(m)));return e.jsxs(Ce,{sx:{my:1},variant:"standard",children:[e.jsx(Te,{children:s}),e.jsx(xt,{name:s,value:t[u],label:s,onChange:h,children:d})]})}return null}const Dt=({values:t,name:s,state:n,position:o,updateFilterValue:a,update:c,group:r})=>Gt(t,s,n,o,a,c,r),Rt=t=>{const{values:s,name:n,state:o,position:a,group:c,updateFilterValue:r,update:u}=t,[i,h]=T.useState(o),[d,m]=T.useState(!1),S=()=>{m(!d)};if(s){const j=g=>{const l=i;l.index===g?l.ascending=!l.ascending:l.ascending=!0,l.index=g,h(l);const v=u.filter(f=>!(a===f.position&&c===f.group));r([...v,{type:"sortState",position:a,state:l,group:c}])};return e.jsxs(I,{sx:{mx:-2},children:[e.jsxs(fe,{onClick:S,children:[e.jsx(xe,{primary:n}),d?e.jsx(je,{}):e.jsx(ve,{})]}),e.jsx(Fe,{in:d,children:e.jsx(V,{sx:{mx:4},children:s.map((g,l)=>e.jsx(gt,{label:g,checked:i.index===l,sortDescending:!i.ascending,onClick:()=>j(l)},"".concat(n," ").concat(g)))})})]})}return null},qt=t=>{const{state:s,name:n,position:o,group:a,updateFilterValue:c,update:r}=t,[u,i]=T.useState(s||""),h=jt(u,500);return x.useEffect(()=>{const d=r.filter(m=>!(o===m.position&&a===m.group));c([...d,{type:"textState",position:o,state:h,group:a}])},[h]),s!==void 0?e.jsxs(Ce,{sx:{my:1},variant:"standard",children:[e.jsx(Te,{children:n}),e.jsx(St,{name:n,value:u,onChange:({target:{value:d}})=>i(d),endAdornment:e.jsx(vt,{position:"end",children:e.jsx(it,{})})})]}):null},Nt=t=>{switch(t){case M.Ignore:return 0;case M.Include:return 1;case M.Exclude:return 2;default:throw new Error("Unexpected TriState ".concat(t))}},Bt=t=>{switch(t){case 0:return M.Ignore;case 1:return M.Include;case 2:return M.Exclude;default:throw new Error("Unexpected state number ".concat(t))}},Ut=t=>{const{state:s,name:n,position:o,group:a,updateFilterValue:c,update:r}=t,[u,i]=T.useState(Nt(s)),h=d=>{const m=d===void 0?0:d?1:2;i(m);const S=r.filter(j=>!(o===j.position&&a===j.group));c([...S,{type:"triState",position:o,state:Bt(m),group:a}])};return s!==void 0?e.jsx(yt,{label:n,checked:[void 0,!0,!1][u],onChange:d=>h(d)}):null},Ht=t=>{const{state:s,name:n,position:o,updateFilterValue:a,update:c}=t,[r,u]=T.useState(!1);return e.jsxs(I,{sx:{mx:-2},children:[e.jsxs(fe,{onClick:()=>u(!r),children:[e.jsx(xe,{primary:n}),r?e.jsx(je,{}):e.jsx(ve,{})]}),e.jsx(Fe,{in:r,children:e.jsx(V,{sx:{mx:4},children:e.jsx(Le,{sourceFilter:s,group:o,updateFilterValue:a,update:c})})})]})},Vt=({name:t})=>e.jsx(Re,{sx:{my:1},textAlign:"center",children:t},t);function Le({sourceFilter:t,group:s,updateFilterValue:n,update:o}){return e.jsx(V,{children:t.map((a,c)=>{var u,i;let r=o.find(h=>h.group===s&&h.position===c);switch(r=r&&r.state,a.type){case"CheckBoxFilter":return e.jsx(Ot,{name:a.name,state:r!=null?r:a.CheckBoxFilterDefault,position:c,group:s,updateFilterValue:n,update:o},"filters ".concat(a.name));case"GroupFilter":return e.jsx(Ht,{name:a.name,state:a.filters,position:c,updateFilterValue:n,update:o},"filters ".concat(a.name));case"HeaderFilter":return e.jsx(At,{name:a.name},"filters ".concat(a.name));case"SelectFilter":return e.jsx(Dt,{name:a.name,values:a.values,state:r!=null?parseInt(r,10):a.SelectFilterDefault,position:c,group:s,updateFilterValue:n,update:o},"filters ".concat(a.name));case"SeparatorFilter":return e.jsx(Vt,{name:a.name},"filters ".concat(a.name));case"SortFilter":return e.jsx(Rt,{name:a.name,values:a.values,state:r!=null?r:{ascending:(u=a.SortFilterDefault)==null?void 0:u.ascending,index:(i=a.SortFilterDefault)==null?void 0:i.index},position:c,group:s,updateFilterValue:n,update:o},"filters ".concat(a.name));case"TextFilter":return e.jsx(qt,{name:a.name,state:r!=null?r:a.TextFilterDefault,position:c,group:s,updateFilterValue:n,update:o},"filters ".concat(a.name));case"TriStateFilter":return e.jsx(Ut,{name:a.name,state:r!=null?r:a.TriStateFilterDefault,position:c,group:s,updateFilterValue:n,update:o},"filters ".concat(a.name));default:throw new Error('Unknown source filter "'.concat(a,'"'))}})},"filters ".concat(s))}function zt({savedSearches:t={},selectSavedSearch:s,updateSavedSearches:n,sourceFilter:o,updateFilterValue:a,resetFilterValue:c,setTriggerUpdate:r,update:u}){const{t:i}=Se(),[h,d]=x.useState(!1),[m,S]=x.useState(""),j=Object.keys(t),g=!!j.length;function l(){c(0),d(!1)}function v(){r(0),d(!1)}return e.jsxs(e.Fragment,{children:[e.jsxs(Ct,{onClick:()=>d(!h),variant:"extended",color:"primary",children:[e.jsx(ye,{}),i("global.button.filter")]}),e.jsxs(ht,{open:h,onClose:()=>d(!1),children:[e.jsxs(I,{sx:{p:2,pb:g?void 0:0},children:[e.jsxs(I,{sx:{display:"flex",pb:1},children:[e.jsx(O,{onClick:l,children:i("global.button.reset")}),e.jsx(qe,{variant:"dialog",popupId:"source-browse-save-search",children:f=>e.jsxs(e.Fragment,{children:[e.jsx(ee,{title:i("source.filter.save_search.label.save"),children:e.jsx(be,{sx:{marginLeft:"auto"},...Ne(f),children:e.jsx(_e,{})})}),e.jsxs(Be,{...Ue(f),maxWidth:"xs",fullWidth:!0,children:[e.jsx(He,{children:i("source.filter.save_search.dialog.label.title")}),e.jsx(Ve,{children:e.jsx(bt,{sx:{width:"100%"},value:m,onChange:C=>S(C.target.value),slotProps:{htmlInput:{maxLength:50}}})}),e.jsxs(ze,{children:[e.jsx(O,{onClick:()=>{S(""),f.close()},children:i("global.button.cancel")}),e.jsx(O,{onClick:()=>{n(m,"create"),S(""),f.close()},children:i("global.button.ok")})]})]})]})}),e.jsx(O,{variant:"contained",onClick:v,children:i("global.button.submit")})]}),g&&e.jsxs(e.Fragment,{children:[e.jsx(he,{sx:{pb:1},children:"Saved searches"}),e.jsx(V,{sx:{flexDirection:"row"},children:j.map(f=>e.jsx(Ft,{label:f,onClick:()=>{d(!1),s(f)},onDelete:()=>{Tt({title:i("global.label.are_you_sure"),message:i("source.filter.save_search.dialog.label.delete",{name:f}),actions:{confirm:{title:i("global.button.delete")}}}).then(()=>n(f,"delete")).catch(H())},deleteIcon:e.jsx(ee,{title:i("source.filter.save_search.label.delete"),children:e.jsx(mt,{})}),variant:"outlined"}))})]})]}),e.jsx(I,{sx:{pb:2,mx:2},children:e.jsx(Le,{sourceFilter:o,updateFilterValue:a,group:void 0,update:u})})]})]})}const Wt=t=>({...t,savedSearches:t.savedSearches?JSON.stringify(t.savedSearches):void 0}),Yt=t=>{var s;return{...t,savedSearches:(s=Ke(t.savedSearches))!=null?s:void 0}},Kt=({meta:t}={},s)=>Yt(We({meta:Ye(t)},{savedSearches:void 0},s)),Qt=async(t,s,n)=>Qe(t,[[s,Wt({[s]:n})[s]]]),Jt=(t,s=H())=>(n,o)=>Qt(t,n,o).catch(s),Xt=te("div")(({theme:t})=>({display:"flex",position:"sticky",width:"100%",zIndex:1,padding:t.spacing(1),gap:t.spacing(1),backgroundColor:t.palette.background.default})),Z=te(O)(()=>({})),Zt=te(I)(()=>({minHeight:"100%",position:"relative"}));var ea=(t=>(t[t.POPULAR=0]="POPULAR",t[t.LATEST=1]="LATEST",t[t.SEARCH=2]="SEARCH",t))(ea||{});const ta={0:"manga.error.label.no_mangas_found",1:"manga.error.label.no_mangas_found",2:"manga.error.label.no_matches"},aa=t=>{const s={},n=[];return t.forEach(o=>{!!s[o.id]||(s[o.id]=o,n.push(o))}),n},sa=(t,s,n,o,a,c)=>{var j;let r;switch(s){case 0:r=A.useGetSourcePopularMangas(t,a);break;case 1:r=A.useGetSourceLatestMangas(t,a);break;case 2:r=A.useSourceSearch(t,n!=null?n:"",o.map(g=>{const{position:l,state:v,group:f}=g;return f!==void 0?{position:f,groupChange:{position:l,[g.type]:v}}:{position:l,[g.type]:v}}),a);break;default:throw new Error('Unknown ContentType "'.concat(s,'"'))}const u=r[1],i=u.findLastIndex(g=>{var l;return!!((l=g.data)!=null&&l.fetchSourceManga)}),h=u[i],d=u.slice(-1)[0].isLoading;let m=!d;const S=x.useMemo(()=>{let g=[];return u.forEach((l,v)=>{var F,G,$;const f=($=(G=(F=l.data)==null?void 0:F.fetchSourceManga)==null?void 0:G.mangas)!=null?$:[],C=f.filter(y=>!c||!y.inLibrary),z=aa([...g,...C]);m=!d&&u.length===v+1&&!C.length&&!!f.length,g=z}),g},[u,c]);return i===-1?[r[0],{...r[1][r[1].length-1],filteredOutAllItemsOfFetchedPage:m}]:[r[0],{...u[u.length-1],data:{...h.data,fetchSourceManga:{...h.data.fetchSourceManga,hasNextPage:u.length>i+1?!1:!!((j=h.data.fetchSourceManga)!=null&&j.hasNextPage),mangas:S}},filteredOutAllItemsOfFetchedPage:m}]};function Ka(){var oe,ie,le,ce,ue;const{t}=Se(),{setTitle:s,setAction:n,appBarHeight:o}=x.useContext(Je),{sourceId:a}=Xe(),c=Ze(),r=pe(),{key:u,state:i}=r,{contentType:h=0,clearCache:d=!1}=(oe=pe().state)!=null?oe:{},[m,S]=x.useState(!0);x.useEffect(()=>{S(!1)},[]);const{settings:{hideLibraryEntries:j}}=et(),[g]=me("source-grid-layout",ge.Compact),[l]=lt("query",ut),[v,f]=U("source-mangas-".concat(a,"-filters"),[]),[C,z]=U("source-mangas-location-".concat(u,"-").concat(a,"-filters"),v!=null?v:[]),[W,F]=x.useState(C),[G,$]=U("source-mangas-".concat(a,"-content-type"),h),[y,Ee]=U("source-mangas-location-".concat(u,"-").concat(a,"-content-type"),l?2:G);x.useEffect(()=>()=>{f(void 0),$(void 0)},[a]);const D=x.useCallback(()=>{tt.session.setItem(Lt(r),void 0,!1),window.scrollTo(0,0)},[u]),Y=b=>{f(b),z(b),D()},se=b=>{$(b),Ee(b)},[R,{data:_,error:L,isLoading:K,size:P,abortRequest:re,filteredOutAllItemsOfFetchedPage:Q}]=sa(a,y,l,C,1,j),J=K||Q,q=(le=(ie=_==null?void 0:_.fetchSourceManga)==null?void 0:ie.mangas)!=null?le:[],N=!!((ce=_==null?void 0:_.fetchSourceManga)!=null&&ce.hasNextPage),{data:X}=A.useGetSource(at,a),p=X==null?void 0:X.source,ke=(ue=p==null?void 0:p.filters)!=null?ue:[],{savedSearches:E={}}=x.useMemo(()=>Kt(p),[p,p==null?void 0:p.meta]),ne=Jt(p!=null?p:{id:a},()=>ot(t("global.error.label.failed_to_save_changes"),"error")),Ie=x.useCallback(b=>{const{query:k,filters:w}=E[b];w&&(F(w),Y(w)),c({pathname:"",search:k?"query=".concat(k):void 0},{state:{...i,contentType:2}})},[E,i]),Me=x.useCallback((b,k)=>{if(k==="delete"){const de={...E};delete de[b],ne("savedSearches",de);return}const w={...E,[b]:{query:l!=null?l:void 0,filters:C}};ne("savedSearches",w)},[E,l,C]),$e=J?void 0:t(ta[y]),Pe=a==="0"?e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:[t("source.local_source.label.checkout")," "]}),e.jsx(It,{href:"https://github.com/Suwayomi/Suwayomi-Server/wiki/Local-Source",target:"_blank",rel:"noreferrer",children:t("source.local_source.label.guide")})]}):void 0,B=x.useCallback((b,k)=>{se(b),D(),l&&!k&&c({pathname:""},{state:{...i,contentType:b}})},[se,l,D]);!!l&&y!==2&&B(2,l);const we=x.useCallback(()=>{N&&R(P+1)},[P,N,y]),Oe=()=>{F([]),Y([])};return x.useEffect(()=>{Q&&N&&!K&&R(P+1)},[Q,K]),x.useEffect(()=>{!d||!nt.REVALIDATION.includes(a)||A.clearBrowseCacheFor(a)},[d]),x.useEffect(()=>()=>{y!==2||m||(re(new Error("SourceMangas(".concat(a,"): search string changed"))),D())},[l,re]),x.useLayoutEffect(()=>{var b;return s((b=p==null?void 0:p.displayName)!=null?b:t("source.title_one")),n(e.jsxs(e.Fragment,{children:[e.jsx(ct,{}),e.jsx(Mt,{}),(p==null?void 0:p.isConfigurable)&&e.jsx(ee,{title:t("settings.title"),children:e.jsx(be,{onClick:()=>c("/sources/".concat(a,"/configure/")),"aria-label":"display more actions",edge:"end",color:"inherit",size:"large",children:e.jsx(st,{})})})]})),()=>{s(""),n(null)}},[t,p]),e.jsxs(Zt,{children:[e.jsxs(Xt,{sx:{top:"".concat(o,"px")},children:[e.jsx(Z,{variant:y===0?"contained":"outlined",startIcon:e.jsx(dt,{}),onClick:()=>B(0),children:t("global.button.popular")}),(p==null?void 0:p.supportsLatest)===void 0||p.supportsLatest?e.jsx(Z,{disabled:!(p!=null&&p.supportsLatest),variant:y===1?"contained":"outlined",startIcon:e.jsx(rt,{}),onClick:()=>B(1),children:t("global.button.latest")}):null,e.jsx(Z,{variant:y===2?"contained":"outlined",startIcon:e.jsx(ye,{}),onClick:()=>B(2,l),children:t("global.button.filter")})]}),(J||!L||!!L&&!!q.length)&&e.jsx(_t,{gridWrapperProps:{sx:{px:1,pb:1}},mangas:q,hasNextPage:N,loadMore:we,message:$e,messageExtra:Pe,isLoading:J,gridLayout:g,mode:"source",inLibraryIndicator:!0},y),L&&!q.length&&e.jsx(Et,{message:t("global.error.label.failed_to_load_data"),messageExtra:L.message,retry:()=>R(P).catch(H())}),L&&!!q.length&&e.jsx(kt,{message:t("global.error.label.failed_to_load_data"),messageExtra:L.message,retry:()=>R(P).catch(H())}),y===2&&e.jsx(zt,{savedSearches:E,selectSavedSearch:Ie,updateSavedSearches:Me,sourceFilter:ke,updateFilterValue:F,setTriggerUpdate:()=>{Y(W)},resetFilterValue:Oe,update:W})]})}export{ea as SourceContentType,Ka as SourceMangas};
