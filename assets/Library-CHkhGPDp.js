import{u as A,o as I,a as D,G as he,j as e,p as ue,q as j,c as b,f as se,I as pe,s as be,t as me,v as ge,h as q,w as fe,N as xe,E as ee,g as Ce}from"./index-lMCVQ9L9.js";import{u as P,S as oe,A as ye,N as Se}from"./AppbarSearch-BBKHdNgu.js";import{T as je,a as ke}from"./Tabs-6K_UfliD.js";import{d as Te}from"./FilterList-yFGWFTnN.js";import{C as R}from"./CheckboxInput-BhngQPDD.js";import{S as _e,R as O}from"./SortRadioInput-CH37YE8G.js";import{T}from"./ThreeStateCheckboxInput-BjlzpdWs.js";import{O as Me,S as we,a as Le}from"./SelectionFAB-C6PeL0ju.js";import{T as Fe}from"./Trackers-D4pSmk7a.js";import{s as Ae,M as Ie}from"./Mangas-D4OyKiQf.js";import{F as _}from"./TextField-CxRf_Sst.js";import{R as Re}from"./ListPreference-BzwrhVrO.js";import{M as ve,a as Ee}from"./MangaGrid-CAGpsp_6.js";import{d as Ne,U as Oe}from"./UpdateChecker-ZMMRRykq.js";import{u as Be}from"./useManageMangaLibraryState-DYObCqFJ.js";import{C as De}from"./Checkbox-CwiZv_lI.js";import{e as G}from"./Strings-CWt9sr6N.js";import{T as Ge,a as Pe}from"./TabsMenu-CbhxqSah.js";import{C as Ue}from"./Chip-Bac0XVLr.js";import"./StyledFab-eFyMIcRv.js";import"./Chapters-CVHYugbV.js";import"./SwitchBase-D3WmpHnl.js";import"./index-B1r9d62L.js";import"./Delete-CHiSYjmX.js";import"./Sync-CED_Sl0u.js";import"./SpinnerImage-OBJTi3Fi.js";import"./TypographyMaxLines-CPYBNV-B.js";import"./Link-CbsvXed9.js";import"./Card-B05Yk5W-.js";import"./CardActionArea-BQPImZqt.js";import"./CardContent-CeTwftS6.js";import"./Avatar-BwtVw6nO.js";import"./PlayArrow-CCDk066v.js";import"./Progress-5KWIoN4T.js";import"./Info-Dk8WxbOa.js";import"./InputAdornment-Dm1Za2iv.js";import"./CheckCircle-CariqKTD.js";import"./Collapse-DEDLByZu.js";import"./NumberSetting-JPZ_AFwO.js";import"./useMobilePicker-alskPrt7.js";import"./SelectSetting-BQ7oVxtS.js";import"./Select-BMAzkNZu.js";const ze={filter:"global.label.filter",sort:"global.label.sort",display:"global.label.display"},Ke=[["sortToRead","library.option.sort.label.by_unread_chapters"],["sortTotalChapters","library.option.sort.label.by_total_chapters"],["sortAlph","library.option.sort.label.alphabetically"],["sortDateAdded","library.option.sort.label.by_date_added"],["sortLastRead","library.option.sort.label.by_last_read"],["sortLatestFetchedChapter","library.option.sort.label.by_latest_fetched_chapter"],["sortLatestUploadedChapter","library.option.sort.label.by_latest_uploaded_chapter"]],We=({open:t,onClose:r})=>{var g,x;const{t:a}=A(),{options:s,setOptions:n}=I(),i=D.useGetTrackerList(he),c=Fe.getLoggedIn((x=(g=i.data)==null?void 0:g.trackers.nodes)!=null?x:[]),l=(p,o)=>{n(u=>({...u,[p]:o}))};return e.jsx(Me,{open:t,onClose:r,tabs:["filter","sort","display"],tabTitle:p=>a(ze[p]),tabContent:p=>{if(p==="filter")return e.jsxs(e.Fragment,{children:[e.jsx(T,{label:a("global.filter.label.unread"),checked:s.unread,onChange:o=>l("unread",o)}),e.jsx(T,{label:a("global.filter.label.downloaded"),checked:s.downloaded,onChange:o=>l("downloaded",o)}),e.jsx(T,{label:a("global.filter.label.bookmarked"),checked:s.bookmarked,onChange:o=>l("bookmarked",o)}),e.jsx(T,{label:a("global.filter.label.duplicate_chapters"),checked:s.hasDuplicateChapters,onChange:o=>l("hasDuplicateChapters",o)}),e.jsx(_,{sx:{mt:2},children:a("manga.label.status")}),Object.values(ue).map(o=>e.jsx(T,{label:a(Ae[o]),checked:s.status[o],onChange:u=>l("status",{...s.status,[o]:u})})),e.jsx(_,{sx:{mt:2},children:a("global.filter.label.tracked")}),c.map(o=>e.jsx(T,{label:o.name,checked:s.tracker[o.id],onChange:u=>l("tracker",{...s.tracker,[o.id]:u})},o.id))]});if(p==="sort")return Ke.map(([o,u])=>e.jsx(_e,{label:a(u),checked:s.sorts===o,sortDescending:s.sortDesc,onClick:()=>o!==s.sorts?l("sorts",o):l("sortDesc",!s.sortDesc)},o));if(p==="display"){const{gridLayout:o,showContinueReadingButton:u,showDownloadBadge:h,showUnreadBadge:C,showTabSize:L}=s;return e.jsxs(e.Fragment,{children:[e.jsx(_,{children:a("global.grid_layout.title")}),e.jsxs(Re,{onChange:v=>l("gridLayout",Number(v.target.value)),value:o,children:[e.jsx(O,{label:a("global.grid_layout.label.compact_grid"),value:j.Compact,checked:o==null||o===j.Compact}),e.jsx(O,{label:a("global.grid_layout.label.comfortable_grid"),value:j.Comfortable,checked:o===j.Comfortable}),e.jsx(O,{label:a("global.grid_layout.label.list"),value:j.List,checked:o===j.List})]}),e.jsx(_,{sx:{mt:2},children:a("library.option.display.badge.title")}),e.jsx(R,{label:a("library.option.display.badge.label.unread_badges"),checked:C,onChange:()=>l("showUnreadBadge",!C)}),e.jsx(R,{label:a("library.option.display.badge.label.download_badges"),checked:h,onChange:()=>l("showDownloadBadge",!h)}),e.jsx(_,{sx:{mt:2},children:a("library.option.display.tab.title")}),e.jsx(R,{label:a("library.option.display.tab.label.show_number_of_items"),checked:L,onChange:()=>l("showTabSize",!L)}),e.jsx(_,{sx:{mt:2},children:a("global.label.other")}),e.jsx(R,{label:a("library.option.display.other.label.show_continue_reading_button"),checked:u,onChange:()=>l("showContinueReadingButton",!u)})]})}return null}})},He=()=>{const{t}=A(),[r,a]=b.useState(!1),{options:s}=I(),n=s.downloaded!=null||s.unread!=null||Object.values(s.tracker).some(i=>i!=null);return e.jsxs(e.Fragment,{children:[e.jsx(se,{title:t("settings.title"),children:e.jsx(pe,{onClick:()=>a(!r),color:n?"warning":"inherit",children:e.jsx(Te,{})})}),e.jsx(We,{open:r,onClose:()=>a(!1)})]})},te=({showFilteredOutMessage:t,message:r,messageExtra:a,...s})=>{const{t:n}=A(),[i]=P("query",oe),{options:c}=I(),{unread:l,downloaded:g}=c;return b.useEffect(()=>{window.scrollTo(0,0)},[i,l,g]),b.useLayoutEffect(()=>(document.body.style.overflowY=c.gridLayout===j.List?"auto":"scroll",()=>{document.body.style.overflowY="auto"}),[]),e.jsx(ve,{gridWrapperProps:{sx:{p:1}},...s,hasNextPage:!1,loadMore:()=>{},message:t?n("library.error.label.no_matches"):r,messageExtra:t?void 0:a,gridLayout:c.gridLayout})},Ye=({isActive:t,areAllItemsSelected:r,areNoItemsSelected:a,onSelectAll:s,onModeChange:n})=>{const{t:i}=A();return e.jsxs(e.Fragment,{children:[t&&e.jsx(we,{areAllItemsSelected:r,areNoItemsSelected:a,onChange:s}),e.jsx(se,{title:i(t?"global.button.cancel":"global.button.select_all"),children:e.jsx(De,{checkedIcon:e.jsx(Ne,{}),sx:{padding:"8px",color:"inherit","&.Mui-checked":{color:"inherit"}},checked:t,onChange:(c,l)=>n(l)})})]})},U=(t,r,a)=>{switch(t){case!0:return r();case!1:return a();default:return!0}},B=(t,r)=>U(t,()=>!!r&&r>=1,()=>r===0),le=(t,r)=>U(t,()=>!!r,()=>!r),M=(t,r)=>{const a=t==null?void 0:t.filter(c=>c!=null),s=r==null?void 0:r.filter(c=>c!=null);if(!(a!=null&&a.length))return!0;const n=a.map(G),i=s.map(G).join(", ");return n.every(c=>i.includes(c))},Ve=(t,{title:r,genre:a,description:s,artist:n,author:i,source:c})=>M([t],[r])||M(t==null?void 0:t.split(","),a.map(l=>G(l)))||M([t],[s])||M([t],[n])||M([t],[i])||M([t],[c==null?void 0:c.displayName]),Qe=(t,r)=>Object.entries(t).map(([a,s])=>{const n=r.trackRecords.nodes.some(i=>i.trackerId===Number(a));return U(s,()=>n,()=>!n)}).every(Boolean),$e=(t,r)=>Object.entries(t).map(([a,s])=>le(s,a===r.status)).every(Boolean),Je=(t,{unread:r,downloaded:a,bookmarked:s,hasDuplicateChapters:n,tracker:i,status:c})=>B(a,t.downloadCount)&&B(r,t.unreadCount)&&B(s,t.bookmarkCount)&&le(n,t.hasDuplicateChapters)&&Qe(i,t)&&$e(c,t),Xe=(t,r,a)=>{const s=a.ignoreFilters&&(r==null?void 0:r.length);return t.filter(n=>{const i=Ve(r,n),c=s||Je(n,a);return i&&c})},w=(t=0,r=0)=>Number(t)-Number(r),Ze=(t,r)=>t.localeCompare(r),qe=(t,r,a)=>{const s=[...t];switch(r){case"sortAlph":s.sort((n,i)=>Ze(n.title,i.title));break;case"sortDateAdded":s.sort((n,i)=>w(n.inLibraryAt,i.inLibraryAt));break;case"sortToRead":s.sort((n,i)=>w(n.unreadCount,i.unreadCount));break;case"sortLastRead":s.sort((n,i)=>{var c,l;return w((c=n.lastReadChapter)==null?void 0:c.lastReadAt,(l=i.lastReadChapter)==null?void 0:l.lastReadAt)});break;case"sortLatestUploadedChapter":s.sort((n,i)=>{var c,l;return w((c=n.latestUploadedChapter)==null?void 0:c.uploadDate,(l=i.latestUploadedChapter)==null?void 0:l.uploadDate)});break;case"sortLatestFetchedChapter":s.sort((n,i)=>{var c,l;return w((c=n.latestFetchedChapter)==null?void 0:c.fetchedAt,(l=i.latestFetchedChapter)==null?void 0:l.fetchedAt)});break;case"sortTotalChapters":s.sort((n,i)=>w(n.chapters.totalCount,i.chapters.totalCount));break}return a&&s.reverse(),s},et=t=>{const[r]=P("query",oe),{options:a}=I(),{unread:s,downloaded:n,bookmarked:i,tracker:c,hasDuplicateChapters:l,status:g}=a,{settings:x}=be(),p=b.useMemo(()=>Xe(t,r,{unread:s,downloaded:n,bookmarked:i,hasDuplicateChapters:l,tracker:c,status:g,ignoreFilters:x.ignoreFilters}),[t,r,s,n,i,l,c,x.ignoreFilters]),o=b.useMemo(()=>qe(p,a.sorts,a.sortDesc),[p,a.sorts,a.sortDesc]),u=Object.values(a.tracker).some(C=>C!=null),h=(s!=null||n!=null||i!=null||!!r||u)&&p.length===0&&t.length>0;return{visibleMangas:o,showFilteredOutMessage:h}},ae=me("span")({display:"flex",alignItems:"center"}),re=({sx:t,...r})=>e.jsx(Ue,{...r,size:"small",sx:{...t,marginLeft:"5px"}});function Kt(){var X,Z;const{t}=A(),{options:r}=I(),{data:a,error:s,loading:n,refetch:i}=D.useGetCategories(ge,{notifyOnNetworkStatusChange:!0}),c=a==null?void 0:a.categories.nodes.filter(d=>d.id!==0||d.id===0&&d.mangas.totalCount),l=c!=null?c:[],g=b.useMemo(()=>l.map(d=>d.mangas.totalCount).reduce((d,m)=>d+m,0),[l]),[x,p]=P("tab",Se),o=(X=l.find(d=>d.order===x))!=null?X:l[0],{data:u,error:h,loading:C,refetch:L}=D.useGetCategoryMangas(o==null?void 0:o.id,{skip:!o,notifyOnNetworkStatusChange:!0}),v=(Z=u==null?void 0:u.mangas.nodes)!=null?Z:[],{visibleMangas:f,showFilteredOutMessage:z}=et(v),K=b.useCallback(()=>L().catch(q()),[L,o]),ne=b.useMemo(()=>f.map(d=>d.id),[f]),[y,E]=b.useState(!1),{areNoItemsForKeySelected:W,areAllItemsForKeySelected:H,selectedItemIds:S,handleSelectAll:N,handleSelection:ie,clearSelection:ce}=Be(f.length,{itemIds:ne,currentKey:o==null?void 0:o.id.toString()}),Y=(d,m,k)=>{E(!!(S.length+(m?1:-1))),ie(d,m,k)},V=b.useMemo(()=>S.map(d=>Ie.getFromCache(d,fe,"MANGA_CHAPTER_STAT_FIELDS")).filter(d=>!!d),[S.length,f]),Q=b.useMemo(()=>y?e.jsx(Le,{selectedItemsCount:S.length,title:"manga.title",children:(d,m)=>e.jsx(Ee,{selectedMangas:V,onClose:()=>{d(),E(!1),ce()},setHideMenu:m})}):null,[y,V]),{setTitle:$,setAction:J}=b.useContext(xe);b.useEffect(()=>{const d=t("library.title"),m=e.jsxs(ae,{children:[d,r.showTabSize&&e.jsx(re,{sx:{color:"inherit"},label:g})]});return $(m,d),J(e.jsxs(e.Fragment,{children:[!y&&e.jsxs(e.Fragment,{children:[e.jsx(ye,{}),e.jsx(He,{}),e.jsx(Oe,{categoryId:o==null?void 0:o.id})]}),e.jsx(Ye,{isActive:y,areAllItemsSelected:H,areNoItemsSelected:W,onSelectAll:k=>N(k,[...new Set(f.map(F=>F.id))]),onModeChange:k=>{E(k),k?N(!0,[...new Set(f.map(F=>F.id))]):l.forEach(F=>N(!1,[],F.id.toString()))}})]})),()=>{$(""),J(null)}},[t,g,n,r,y,W,H,S.length,f.length,o]);const de=d=>{p(d)};return s!=null?e.jsx(ee,{message:t("category.error.label.request_failure"),messageExtra:s.message,retry:()=>i().catch(q())}):n?e.jsx(Ce,{}):l.length===0?e.jsx(ee,{message:t("library.error.label.empty")}):l.length===1?e.jsxs(e.Fragment,{children:[e.jsx(te,{mangas:f,message:t(h?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:h==null?void 0:h.message,isLoading:C,selectedMangaIds:S,isSelectModeActive:y,handleSelection:Y,showFilteredOutMessage:!h&&z,retry:h&&K}),Q]}):e.jsxs(Ge,{children:[e.jsx(Pe,{value:o.order,onChange:(d,m)=>de(m),tabsCount:l.length,children:l.map(d=>e.jsx(je,{sx:{display:"flex"},label:e.jsxs(ae,{children:[d.name,r.showTabSize?e.jsx(re,{label:d.mangas.totalCount}):null]}),value:d.order},d.id))}),l.map(d=>e.jsx(ke,{index:d.order,currentIndex:o.order,children:d===o&&e.jsx(te,{mangas:f,message:t(h?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:h==null?void 0:h.message,isLoading:C,selectedMangaIds:S,isSelectModeActive:y,handleSelection:Y,showFilteredOutMessage:!h&&z,retry:h&&K})},d.order)),Q]})}export{Kt as Library};
