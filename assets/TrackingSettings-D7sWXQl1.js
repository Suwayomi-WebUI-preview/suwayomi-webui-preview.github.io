import{u as T,j as t,b2 as I,r as x,v as b,c8 as C,b8 as v,m as c,g as l,e as E,Y as M,k as S,i as A,M as j,s as k,F as P}from"./index-D8Oh_qVq.js";import{E as R}from"./EmptyViewAbsoluteCentered-31nAN-mp.js";import{T as f}from"./Trackers-Bgo8y--2.js";import{A as U}from"./AvatarSpinner-BlIN0nU8.js";import{C as N}from"./LoginDialog-CabNqqVQ.js";import{L as $}from"./ListItemAvatar-RrtHyJk4.js";import{C as O}from"./Chip-D4IYlxIt.js";import{u as F}from"./useAppTitle-LfOXXKjx.js";import{S as w}from"./Switch-DoyrbDvL.js";import{L as G}from"./ListSubheader-DQMHcHM8.js";import"./SpinnerImage-BV3qyVLf.js";import"./Refresh-DvhQbzDR.js";import"./Image-0CLmpHMJ.js";import"./SwitchBase-Bp_PtR-Q.js";const Y=({tracker:e})=>{const{t:r}=T(),m=!e.isLoggedIn&&!!e.authUrl,L=async()=>{try{await x.logoutFromTracker(e.id).response}catch(s){c(r("tracking.action.logout.label.failure",{name:e.name}),"error",l(s))}},g=async(s,n)=>{if(m){const a={redirectUrl:"".concat(window.location.origin,"/tracker/login/oauth"),clientName:"Suwayomi-WebUI",trackerId:e.id,trackerName:e.name};window.open("".concat(e.authUrl,"&state=").concat(JSON.stringify(a)),"_self");return}try{await x.loginTrackerCredentials(e.id,s,n).response}catch(a){c(r("tracking.action.login.label.failure",{name:e.name}),"error",l(a))}},u=async(s,n)=>{if(m){const o={redirectUrl:"".concat(window.location.origin,"/tracker/login/oauth"),clientName:"Suwayomi-WebUI",trackerId:e.id,trackerName:e.name};window.open("".concat(e.authUrl,"&state=").concat(JSON.stringify(o)),"_self");return}const a=N.showControlled({title:r(f.isLoggedIn(e)?"tracking.settings.dialog.title.log_out":"tracking.settings.dialog.title.log_in",{name:e.name}),isLoading:!1,isLoggedIn:f.isLoggedIn(e),username:s,password:n,loginLogout:async(o,p)=>{if(a.update({isLoading:!0,loginLogout:v}),f.isLoggedIn(e)){try{await L(),a.submit()}catch(d){c(r("tracking.action.logout.label.failure",{name:e.name}),"error",l(d))}return}try{await g(o,p),a.submit()}catch(d){c(r("tracking.action.login.label.failure",{name:e.name}),"error",l(d));const h="__retry__";await Promise.race([a.promise,Promise.resolve(h)])===h&&u(o,p)}}},{id:"tracker-login-dialog"});await a.promise};return t.jsxs(I,{onClick:()=>u(),children:[t.jsx($,{sx:{paddingRight:"20px"},children:t.jsx(U,{alt:"".concat(e.name),iconUrl:x.getValidImgUrlFor(e.icon),slots:{avatarProps:{variant:"rounded",sx:{width:64,height:64}},spinnerImageProps:{ignoreQueue:!0}}})}),t.jsx(b,{primary:e.name}),f.isLoggedIn(e)&&t.jsx(C,{children:t.jsx(O,{label:r("global.label.logged_in"),color:"success"})})]})},ae=()=>{var y;const{t:e}=T();F(e("tracking.title"));const{settings:{updateProgressAfterReading:r,updateProgressManualMarkRead:m},loading:L,request:{error:g,refetch:u}}=E(),s=P(i=>c(e("global.error.label.failed_to_save_changes"),"error",l(i))),{data:n,loading:a,error:o,refetch:p}=x.useGetTrackerList(M,{notifyOnNetworkStatusChange:!0}),d=(y=n==null?void 0:n.trackers.nodes)!=null?y:[],h=L||a,_=g!=null?g:o;return _?t.jsx(R,{message:e("global.error.label.failed_to_load_data"),messageExtra:l(_),retry:()=>{g&&u().catch(S()),o&&p().catch(S())}}):h?t.jsx(A,{}):t.jsxs(t.Fragment,{children:[t.jsxs(j,{sx:{pt:0},children:[t.jsxs(k,{children:[t.jsx(b,{primary:e("tracking.settings.label.update_progress_reading")}),t.jsx(w,{edge:"end",checked:r,onChange:i=>s("updateProgressAfterReading",i.target.checked)})]}),t.jsxs(k,{children:[t.jsx(b,{primary:e("tracking.settings.label.update_progress_manual"),secondary:e("tracking.settings.label.update_progress_reading_description")}),t.jsx(w,{edge:"end",checked:m,onChange:i=>s("updateProgressManualMarkRead",i.target.checked)})]})]}),t.jsx(j,{subheader:t.jsx(G,{component:"div",id:"tracking-trackers",children:e("tracking.settings.title.trackers")}),children:d.map(i=>t.jsx(Y,{tracker:i},i.id))})]})};export{ae as TrackingSettings};
