import{a1 as H,u as T,a as F,c as n,j as s,L as I,T as v,h as q,N as O,av as Q,d as B,g as V,B as A}from"./index-9T0dGC6a.js";import{u as W,A as z,S as J}from"./AppbarSearch-CaP6chi5.js";import{s as _,l as K,a as U}from"./Languages-Bqt9fFQ5.js";import{t as X,L as Y}from"./LangSelect-Cd-6Gi82.js";import{u as P}from"./useDebounce-BwyELCHH.js";import{a as Z,E as ee}from"./EmptyViewAbsoluteCentered-CUXYThCZ.js";import{B as se}from"./BaseMangaGrid-DUHbdjUi.js";import{C as re}from"./Card-CjmyazBt.js";import{C as te}from"./CardActionArea-AfDFJKyi.js";import"./useManageMangaLibraryState-C2keb8qW.js";import"./Trackers-D4pSmk7a.js";import"./CardContent-BHmsb10w.js";import"./Avatar-D16w86hT.js";import"./Info-3t5z6fXJ.js";import"./TextField-YGJYPG8k.js";import"./InputAdornment-HmS6Hwo3.js";import"./CheckCircle-OMx21FoH.js";import"./SpinnerImage-DRLiPxEQ.js";import"./Refresh-DuVXKLkt.js";import"./TypographyMaxLines-DZX_2562.js";import"./Collapse-CnqAxXWX.js";import"./Link-i4OjAvbS.js";import"./ListPreference-vBKgCxBP.js";import"./Checkbox-i1cxnMOo.js";import"./SwitchBase-CoxLhW8K.js";import"./NumberSetting-CPFqlTCz.js";import"./useMobilePicker-D6ikC4S5.js";import"./Chip-B183RkoD.js";import"./SelectSetting-CcYk0I8V.js";import"./Select-Dl88ef0d.js";import"./CheckboxInput-C2U5EzLT.js";import"./Mangas-8SNM_FSc.js";import"./Chapters-hp9rJTIS.js";import"./ThreeStateCheckboxInput-BGSVgUlo.js";import"./FilterList-CiWmfWOE.js";import"./cloneObject-DrOPTG0J.js";import"./Switch-CWpTGQq8.js";import"./MangaGrid-DVUSi8D6.js";import"./index-C34neuq_.js";import"./Delete-CJUXWdMZ.js";import"./Download-CAY5ZDZL.js";import"./Sync-7uFrlBk2.js";import"./PlayArrow-CsKqjTw_.js";import"./StyledFab-Ck5C-VTM.js";function oe(r){const t=[];return r.forEach(e=>{t.indexOf(e.lang)===-1&&t.push(e.lang)}),t.sort(K),t}const ae=(r,t)=>r.displayName<t.displayName?-1:r.displayName>t.displayName?1:0,ne=(r,t,e)=>{var p,S,i,m;const g=!((p=e.get(r.id))!=null&&p.isLoading),c=!((S=e.get(t.id))!=null&&S.isLoading);if(g&&!c)return-1;if(!g&&c)return 1;if(!g&&!c)return 0;const u=!((i=e.get(r.id))!=null&&i.hasResults),l=!((m=e.get(t.id))!=null&&m.hasResults);return u&&!l?1:l&&!u?-1:0},ie=1e3,ce=H.memo(({source:r,onSearchRequestFinished:t,searchString:e,emptyQuery:g,mode:c})=>{var E,w;const{t:u}=T(),{id:l,displayName:p,lang:S}=r,[i,m]=F.useSourceSearch(l,e!=null?e:"",void 0,1,{skipRequest:!e,addAbortSignal:!0});console.log("SearchAll",r.displayName,m);const{data:y,isLoading:a,error:f,abortRequest:L}=m[0],j=(w=(E=y==null?void 0:y.fetchSourceManga)==null?void 0:E.mangas)!=null?w:[],d=!f&&!a&&!j.length;n.useEffect(()=>{t(r,a,!d,!e)},[a,d,e]);let h;return f?h=u("search.error.label.source_search_failed"):d&&(h=u("manga.error.label.no_mangas_found")),n.useEffect(()=>()=>{L(new Error("SourceSearchPreview(".concat(l,", ").concat(p,"): search string changed")))},[e,L]),!a&&!e||g?null:s.jsxs(s.Fragment,{children:[s.jsx(re,{sx:{mb:1},children:s.jsxs(te,{component:I,to:"/sources/".concat(l,"?query=").concat(e),sx:{p:3},children:[s.jsx(v,{variant:"h5",children:p}),s.jsx(v,{variant:"caption",children:X(S)})]})}),h?s.jsx(Z,{sx:{alignItems:"start",height:void 0},noFaces:!0,message:h,messageExtra:f&&f.message,retry:f?()=>i(1).catch(q("SourceSearchPreview(".concat(r.id,")::refetch"))):void 0}):s.jsx(se,{gridWrapperProps:{sx:{px:0}},mangas:j,isLoading:a,hasNextPage:!1,loadMore:()=>{},horizontal:!0,noFaces:!0,message:h,inLibraryIndicator:!0,mode:c})]})}),Ze=()=>{const{t:r}=T(),{setTitle:t,setAction:e}=n.useContext(O),{pathname:g,state:c}=Q(),u=g.startsWith("/migrate/source"),l=c==null?void 0:c.mangaTitle,[p]=W("query",J),S=P(p,ie),[i,m]=B("shownSourceLangs",U()),[y]=B("showNsfw",!0),{data:a,loading:f,error:L,refetch:j}=F.useGetSourceList({notifyOnNetworkStatusChange:!0}),d=n.useMemo(()=>{var o;return(o=a==null?void 0:a.sources.nodes)!=null?o:[]},[a==null?void 0:a.sources.nodes]),[h,E]=n.useState(new Map),w=P(h,500),b=n.useMemo(()=>[...d].sort(ae),[d]),N=n.useMemo(()=>b.filter(o=>i.includes(o.lang)),[b,i]),M=n.useMemo(()=>N.filter(o=>y||!o.isNsfw),[N,y]),R=n.useMemo(()=>[...M].sort((o,x)=>ne(o,x,w)),[M,w]),D=n.useCallback(({id:o},x,$,k)=>{E(G=>{const C=new Map(G);return C.set(o,{isLoading:x,hasResults:$,emptySearch:k}),C})},[E]);return n.useLayoutEffect(()=>(t(r(u?"migrate.search.title":"search.title.global_search",{title:l})),e(s.jsxs(s.Fragment,{children:[s.jsx(z,{isClosable:!1}),s.jsx(Y,{shownLangs:i,setShownLangs:m,allLangs:oe(d),forcedLangs:_()})]})),()=>{t(""),e(null)}),[r,i,m,d]),n.useEffect(()=>{const o=_().filter(x=>!i.includes(x));m([...i,...o])},[]),f?s.jsx(V,{}):L?s.jsx(ee,{message:r("global.error.label.failed_to_load_data"),messageExtra:L.message,retry:()=>j().catch(q())}):s.jsx(A,{sx:{p:1},children:R.map((o,x)=>s.jsx(A,{sx:{pb:x+1!==R.length?2:0},children:s.jsx(ce,{source:o,onSearchRequestFinished:D,searchString:S,emptyQuery:!p,mode:u?"migrate.select":"source"})},o.id))})};export{Ze as SearchAll};
