import{r as Z,i as ee,j as e,u as N,M as Be,L as k,B as M,a as j,T as g,S as te,b as R,c as l,N as ne,d as F,e as Pe,f as $,I as H,g as se,h as I,m as w,k as Fe,l as $e,s as He,n as Ge,o as ze,p as je,q as ve,t as qe,v as Ve}from"./index-bzZBvN07.js";import{u as ye,S as Ce,A as We}from"./AppbarSearch-BqQqK7yi.js";import{s as Ee,l as Te,D as G,a as Ke,e as Xe}from"./Languages-DJGvl_0L.js";import{SourceContentType as Q}from"./SourceMangas-bSmqR4Vq.js";import{S as re}from"./SpinnerImage-BX3EiImH.js";import{t as q,L as _e,g as P,I as Qe,a as Ye,E as we,b as T,c as Ne,d as Je,e as Ze,f as et,i as tt,h as nt}from"./LangSelect-CjYPFOIt.js";import{C as oe}from"./Card-Dd85qRHA.js";import{C as Ie}from"./CardActionArea-BUdip0WP.js";import{C as ae}from"./CardContent-BIA4SeJ6.js";import{A as ie}from"./Avatar-j2hQLz-D.js";import{E as z}from"./EmptyViewAbsoluteCentered-aKEOBFkM.js";import{f as st}from"./file-selector-g2cjt69E.js";import{d as rt}from"./Add-Bh-fGX7T.js";import{V as ot,S as at,a as it,b as Ae}from"./Virtuoso.util-GB0M6qUm.js";import{T as Y,a as J}from"./Tabs-7U2IRw6C.js";import{T as lt,a as ct}from"./TabsMenu-BxdopJvd.js";import{d as ut,a as dt}from"./SortRadioInput-BNBK57de.js";import{C as pt}from"./Chip-BubEFm7F.js";import"./useManageMangaLibraryState-C2ym-Xtq.js";import"./Trackers-D4pSmk7a.js";import"./Info-EL8IofpS.js";import"./TextField-bUrPaMer.js";import"./InputAdornment-CIgb_nrR.js";import"./CheckCircle-yG-XN818.js";import"./TypographyMaxLines-U1MTw-ZS.js";import"./Mangas-HDM524Df.js";import"./Chapters-BfJKimYN.js";import"./Collapse-ALulIn13.js";import"./Link-C0yb8LE4.js";import"./ListPreference-DY8Zhp04.js";import"./Checkbox-BwOZcAsx.js";import"./SwitchBase-zTg1Vf7G.js";import"./NumberSetting-Cu8QmNKC.js";import"./useMobilePicker-CeTJrUBs.js";import"./SelectSetting-DBSj5lhb.js";import"./Select-CUJbL-F7.js";import"./CheckboxInput-DMcTsHI0.js";import"./ThreeStateCheckboxInput-DqlBxRZX.js";import"./ExpandMore-gnFq5mcy.js";import"./FilterList-D2of7WDx.js";import"./GridLayouts-CvIUZsxU.js";import"./Delete-B0wIUTi1.js";import"./useDebounce-BI8tg3sb.js";import"./StyledFab-DY_4pfpP.js";import"./BaseMangaGrid-Pn9yJgx1.js";import"./MangaGrid-C8xXKcpV.js";import"./index-Ck80SusL.js";import"./Download-CrW6wtf_.js";import"./Sync--qWA70Xa.js";import"./PlayArrow-DMJXiRlY.js";import"./Refresh-BO6PZrid.js";import"./cloneObject-DrOPTG0J.js";import"./Switch-V-JMeDM4.js";var le={},xt=ee;Object.defineProperty(le,"__esModule",{value:!0});var Oe=le.default=void 0,ht=xt(Z()),mt=e;Oe=le.default=(0,ht.default)((0,mt.jsx)("path",{d:"M19.3 16.9c.4-.7.7-1.5.7-2.4 0-2.5-2-4.5-4.5-4.5S11 12 11 14.5s2 4.5 4.5 4.5c.9 0 1.7-.3 2.4-.7l3.2 3.2 1.4-1.4zm-3.8.1c-1.4 0-2.5-1.1-2.5-2.5s1.1-2.5 2.5-2.5 2.5 1.1 2.5 2.5-1.1 2.5-2.5 2.5M12 20v2C6.48 22 2 17.52 2 12S6.48 2 12 2c4.84 0 8.87 3.44 9.8 8h-2.07c-.64-2.46-2.4-4.47-4.73-5.41V5c0 1.1-.9 2-2 2h-2v2c0 .55-.45 1-1 1H8v2h2v3H9l-4.79-4.79C4.08 10.79 4 11.38 4 12c0 4.41 3.59 8 8 8"}),"TravelExplore");const ft=c=>{const{t}=N(),s=Be.useIsMobileWidth(),{source:{id:r,name:u,lang:n,iconUrl:p,supportsLatest:o,isNsfw:h,extension:{repo:a}},showSourceRepo:S}=c,d=Number(r)===0?t("source.local_source.title"):u;return e.jsx(oe,{sx:{margin:1,marginTop:0},children:e.jsx(Ie,{component:k,to:"/sources/".concat(r),state:{contentType:Q.POPULAR,clearCache:!0},children:e.jsxs(ae,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:1.5},children:[e.jsxs(M,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(ie,{variant:"rounded",alt:d,sx:{width:56,height:56,flex:"0 0 auto",mr:1,background:"transparent"},children:e.jsx(re,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:d,src:j.getValidImgUrlFor(p)})}),e.jsxs(M,{sx:{display:"flex",flexDirection:"column",justifyContent:"center"},children:[e.jsx(g,{variant:"h6",component:"h3",children:d}),e.jsxs(g,{variant:"caption",sx:{display:"block"},children:[q(n),h&&e.jsx(g,{variant:"caption",color:"error",sx:{display:"inline"},children:" 18+"}),S&&e.jsx(g,{variant:"caption",sx:{display:"block"},children:a})]})]})]}),e.jsxs(te,{sx:{flexDirection:"row",gap:1},children:[o&&e.jsx(R,{variant:"outlined",component:k,to:"/sources/".concat(r),state:{contentType:Q.LATEST,clearCache:!0},children:t("global.button.latest")}),!s&&e.jsx(R,{variant:"outlined",component:k,to:"/sources/".concat(r),state:{contentType:Q.POPULAR,clearCache:!0},children:t("global.button.popular")})]})]})})})};function gt(c){const t=new Set;return c.forEach(s=>{const u=Number(s.id)===0?G.OTHER:s.lang;t.add(u)}),[...t].sort(Te)}function St(c){const t={};return c.forEach(s=>{var n;const u=Number(s.id)===0?G.OTHER:s.lang;(n=t[u])!=null||(t[u]=[]),t[u].push(s)}),Object.values(t).forEach(s=>s.sort((r,u)=>r.name.localeCompare(u.name))),t}function jt(){const{t:c}=N(),{setAction:t}=l.useContext(ne),[s,r]=F("shownSourceLangs",Ke()),[u]=F("showNsfw",!0),{data:n,loading:p,error:o,refetch:h}=j.useGetSourceList({notifyOnNetworkStatusChange:!0}),a=n==null?void 0:n.sources.nodes,S=l.useMemo(()=>{if(!a||a!=null&&a.length)return!1;const{repo:d}=a[0].extension;return a.some(f=>f.extension.repo!==d)},[a]),y=Pe();return l.useEffect(()=>{Ee().forEach(d=>{let f=!1;s.forEach(x=>{x===d&&(f=!0)}),f||r(x=>(x.push(d),x))})},[]),l.useLayoutEffect(()=>(t(e.jsxs(e.Fragment,{children:[e.jsx($,{title:c("search.title.global_search"),children:e.jsx(H,{onClick:()=>y("/sources/all/search/"),size:"large",color:"inherit",children:e.jsx(Oe,{})})}),e.jsx(_e,{shownLangs:s,setShownLangs:r,allLangs:gt(a!=null?a:[]),forcedLangs:Ee()})]})),()=>{t(null)}),[c,s,a]),p?e.jsx(se,{}):o?e.jsx(z,{message:c("global.error.label.failed_to_load_data"),messageExtra:o.message,retry:()=>h().catch(I())}):(a==null?void 0:a.length)===0?e.jsx(z,{message:c("source.error.label.no_sources_found")}):e.jsx(e.Fragment,{children:Object.entries(St(a!=null?a:[])).sort((d,f)=>Te(d[0],f[0])).map(([d,f])=>(d===G.OTHER||s.includes(d))&&e.jsxs(l.Fragment,{children:[e.jsx(g,{variant:"h5",component:"h2",sx:{paddingLeft:3,paddingTop:1,paddingBottom:2,fontWeight:"bold"},children:q(d)},d),f.filter(x=>{if(d===G.OTHER){const v=Number(x.id)===0;if(!(s.includes(d)||v))return!1}return u||!x.isNsfw}).map(x=>e.jsx(ft,{source:x,showSourceRepo:S},x.id))]},d))})}function vt(c){const{t}=N(),{extension:{name:s,lang:r,versionName:u,isInstalled:n,hasUpdate:p,isObsolete:o,pkgName:h,iconUrl:a,isNsfw:S,repo:y},handleUpdate:d,showSourceRepo:f,forcedState:x}=c,[U,v]=l.useState(P(n,o,p)),E=x!=null?x:U;l.useEffect(()=>{v(P(n,o,p))},[P(n,o,p)]);const D=r==="all"?t("extension.language.all"):r.toUpperCase(),A=async C=>{const B=Je[C],O=Ze[C];try{switch(v(O),C){case T.INSTALL:await j.updateExtension(h,{install:!0,isObsolete:o}).response;break;case T.UNINSTALL:await j.updateExtension(h,{uninstall:!0,isObsolete:o}).response;break;case T.UPDATE:await j.updateExtension(h,{update:!0,isObsolete:o}).response;break;default:throw new Error('Unexpected ExtensionAction "'.concat(C,'"'))}v(B),d()}catch(V){v(P(n,o,p)),w(t(Ne[C],{count:1}),"error")}};function b(){switch(E){case T.INSTALL:case T.UPDATE:case T.UNINSTALL:A(E).catch(I());break;case we.OBSOLETE:A(T.UNINSTALL).catch(I());break}}return e.jsx(oe,{children:e.jsxs(ae,{sx:{display:"flex",alignItems:"center",gap:1,p:1.5,"&:last-child":{paddingBottom:1.5}},children:[e.jsx(ie,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",background:"transparent"},alt:s,children:e.jsx(re,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:s,src:j.getValidImgUrlFor(a)})}),e.jsxs(M,{sx:{display:"flex",flexDirection:"column",flexGrow:1,flexShrink:1,wordBreak:"break-word",justifyContent:"center"},children:[e.jsx(g,{variant:"h6",component:"h3",children:s}),e.jsxs(g,{variant:"caption",sx:{display:"block"},children:[D," ",u,S&&e.jsx(g,{variant:"caption",color:"error",sx:{display:"inline"},children:" 18+"})]}),f&&e.jsx(g,{variant:"caption",sx:{display:"block"},children:y})]}),e.jsx(R,{variant:"outlined",sx:{color:E===Qe.OBSOLETE?"red":"inherit",flexShrink:0},onClick:()=>b(),children:t(Ye[E])})]})})}const be=0,Le=1;function Et({tabsMenuHeight:c}){var fe,ge;const{t}=N(),{setAction:s}=l.useContext(ne),{data:r,loading:u,error:n,refetch:p}=j.useGetServerSettings({notifyOnNetworkStatusChange:!0}),o=!!(r!=null&&r.settings.extensionRepos.length),h=((fe=r==null?void 0:r.settings.extensionRepos.length)!=null?fe:0)>1,a=l.useRef(null),[S,y]=F("shownExtensionLangs",Xe()),[d]=F("showNsfw",!0),[f]=ye("query",Ce),[x,U]=l.useState({}),[v,{data:E,loading:D,error:A}]=j.useExtensionListFetch(),b=(ge=E==null?void 0:E.fetchExtensions)==null?void 0:ge.extensions,[C,B]=l.useState([]),O=l.useCallback(()=>U({}),[]);l.useEffect(()=>{v()},[x]);const V=l.useMemo(()=>(b!=null?b:[]).filter(i=>{const m=d||!i.isNsfw;return f?m&&i.name.toLowerCase().includes(f.toLowerCase()):m}),[b,d,f]),{allLangs:de,groupedExtensions:W}=l.useMemo(()=>et(V),[V]),_=l.useMemo(()=>W.filter(i=>i[Le].length>0).filter(i=>tt(i[be])||S.includes(i[be])),[S,W]),pe=l.useMemo(()=>_.map(i=>i[Le].length),[_]),K=l.useMemo(()=>_.map(([,i])=>i).flat(1),[_]),Re=ot.useCreateGroupedComputeItemKey(pe,l.useCallback(i=>_[i][0],[_]),l.useCallback(i=>K[i].pkgName,[K])),xe=i=>{i.name.toLowerCase().endsWith("apk")?(a.current&&(a.current.value=""),w(t("extension.label.installing_file"),"info"),j.installExternalExtension(i).response.then(()=>{O(),w(t("extension.label.installed_successfully"),"success")}).catch(()=>w(t("extension.label.installation_failed"),"error"))):w(t("global.error.label.invalid_file_type"),"error")};l.useLayoutEffect(()=>(s(e.jsxs(e.Fragment,{children:[e.jsx(We,{}),e.jsx($,{title:t("extension.action.label.install_external"),children:e.jsx(H,{onClick:()=>{var i;return(i=a.current)==null?void 0:i.click()},size:"large",color:"inherit",children:e.jsx(rt,{})})}),e.jsx(_e,{shownLangs:S,setShownLangs:y,allLangs:de})]})),()=>{s(null)}),[t,S,de]),l.useEffect(()=>{const i=async L=>{L.preventDefault();const X=await st(L);xe(X[0])},m=L=>{L.preventDefault()};return document.addEventListener("drop",i),document.addEventListener("dragover",m),()=>{document.removeEventListener("drop",i),document.removeEventListener("dragover",m)}},[]);const he=l.useMemo(()=>e.jsx("input",{type:"file",style:{display:"none"},ref:a,onChange:i=>{var L;const m=(L=i.target.files)==null?void 0:L[0];m&&xe(m)}}),[]),Ue=u||D,me=n!=null?n:A;return Ue?e.jsx(se,{}):me?e.jsx(z,{message:t("global.error.label.failed_to_load_data"),messageExtra:me.message,retry:()=>{n&&p().catch(I()),A&&v().catch(I())}}):!(b!=null&&b.length)&&!o?e.jsxs(e.Fragment,{children:[he,e.jsxs(te,{sx:{alignItems:"center",justifyContent:"center",rowGap:"10px",paddingTop:"20px"},children:[e.jsx(g,{children:t("extension.label.add_repository_info")}),e.jsx(R,{component:k,variant:"contained",to:"/settings/browseSettings",children:t("settings.title")})]})]}):e.jsxs(e.Fragment,{children:[he,e.jsx(at,{heightToSubtract:c,overscan:window.innerHeight*.5,groupCounts:pe,groupContent:i=>{const[m,L]=_[i],X=m===nt.UPDATE_PENDING;return e.jsxs(it,{isFirstItem:i===0,sx:{flexDirection:"row",justifyContent:"space-between",alignItems:"center",pr:1},children:[e.jsx(g,{variant:"h5",component:"h2",children:q(m)}),X&&e.jsx(R,{disabled:!!C.length,variant:"contained",onClick:()=>{const Se=L.map(De=>De.pkgName);B(Se),j.updateExtensions(Se,{update:!0}).response.then(()=>O()).catch(()=>w(t(Ne[T.UPDATE],{count:W.length}))).finally(()=>B([]))},children:t("extension.action.label.update_all")})]},m)},computeItemKey:Re,itemContent:i=>{const m=K[i];return e.jsx(Ae,{children:e.jsx(vt,{extension:m,handleUpdate:O,showSourceRepo:h,forcedState:C.includes(m.pkgName)?we.UPDATING:void 0})})}})]})}var ce={},bt=ee;Object.defineProperty(ce,"__esModule",{value:!0});var ke=ce.default=void 0,Lt=bt(Z()),yt=e;ke=ce.default=(0,Lt.default)((0,yt.jsx)("path",{d:"M14.94 4.66h-4.72l2.36-2.36zm-4.69 14.71h4.66l-2.33 2.33zM6.1 6.27 1.6 17.73h1.84l.92-2.45h5.11l.92 2.45h1.84L7.74 6.27zm-1.13 7.37 1.94-5.18 1.94 5.18zm10.76 2.5h6.12v1.59h-8.53v-1.29l5.92-8.56h-5.88v-1.6h8.3v1.26z"}),"SortByAlpha");var ue={},Ct=ee;Object.defineProperty(ue,"__esModule",{value:!0});var Me=ue.default=void 0,Tt=Ct(Z()),_t=e;Me=ue.default=(0,Tt.default)((0,_t.jsx)("path",{d:"M20 10V8h-4V4h-2v4h-4V4H8v4H4v2h4v4H4v2h4v4h2v-4h4v4h2v-4h4v-2h-4v-4zm-6 4h-4v-4h4z"}),"Tag");const wt=({id:c,name:t,lang:s,iconUrl:r,mangaCount:u})=>{const{t:n}=N(),o=Number(c)===0?n("source.local_source.title"):t;return e.jsx(oe,{children:e.jsx(Ie,{component:k,to:"/migrate/source/".concat(c,"/"),children:e.jsxs(ae,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",p:1.5},children:[e.jsxs(M,{sx:{display:"flex"},children:[e.jsx(ie,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",mr:1,background:"transparent"},children:e.jsx(re,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:o,src:j.getValidImgUrlFor(r)})}),e.jsxs(M,{sx:{display:"flex",flexDirection:"column",justifyContent:"center"},children:[e.jsx(g,{variant:"h6",component:"h3",children:o}),e.jsx(g,{variant:"caption",sx:{display:"block"},children:q(s)})]})]}),e.jsx(pt,{sx:{borderRadius:1},size:"small",label:u})]})})})},Nt=(c,{sortBy:t,sortOrder:s})=>{if(!c)return[];const r={};c.forEach(({sourceId:n,source:p})=>{var h;const o=(h=r[n])!=null?h:{id:n,name:n,lang:"unknown",iconUrl:null,mangaCount:0,...p};r[n]={...o,mangaCount:o.mangaCount+1}});const u=Object.values(r).toSorted((n,p)=>{switch(t){case je.SOURCE_NAME:return n.name.localeCompare(p.name);case je.MANGA_COUNT:return n.mangaCount-p.mangaCount;default:throw new Error('Unexpected "sortBy" "'.concat(t,'"'))}});switch(s){case ve.ASC:return u;case ve.DESC:return u.toReversed();default:throw new Error('Unexpected "sortOrder" "'.concat(s,'"'))}},It=({tabsMenuHeight:c})=>{const{t}=N(),{appBarHeight:s}=Fe(),{settings:{migrateSortSettings:r}}=$e(),u=qe(()=>w(t("global.error.label.failed_to_save_changes"),"error")),{sortBy:n,sortOrder:p}=r,{data:o,loading:h,error:a,refetch:S}=j.useGetMigratableSources({notifyOnNetworkStatusChange:!0}),y=l.useMemo(()=>Nt(o==null?void 0:o.mangas.nodes,r),[o==null?void 0:o.mangas.nodes,r]);return h?e.jsx(se,{}):a?e.jsx(z,{message:t("global.error.label.failed_to_load_data"),messageExtra:a.message,retry:()=>S().catch(I())}):e.jsxs(e.Fragment,{children:[e.jsxs(te,{sx:{position:"sticky",top:"".concat(s+c,"px"),flexDirection:"row",justifyContent:"end",alignItems:"center",gap:1,p:1,backgroundColor:"background.default",zIndex:1},children:[e.jsx($,{title:t(He[n]),children:e.jsx(H,{size:"large",color:"inherit",onClick:()=>u("migrateSortSettings",{sortBy:(n+1)%2,sortOrder:p}),children:n?e.jsx(Me,{}):e.jsx(ke,{})})}),e.jsx($,{title:t(Ge[p]),children:e.jsx(H,{size:"large",color:"inherit",onClick:()=>u("migrateSortSettings",{sortBy:n,sortOrder:(p+1)%2}),children:p?e.jsx(ut,{}):e.jsx(dt,{})})})]}),e.jsx(ze,{sx:{p:0},children:y.map(d=>e.jsx(Ae,{children:e.jsx(wt,{...d})},d.id))})]})};function On(){const{t:c}=N(),{setTitle:t}=l.useContext(ne);l.useLayoutEffect(()=>{t(c("global.label.browse"))},[c]);const s=l.useRef(null),[r,u]=l.useState(0);Ve(s,l.useCallback(()=>u(s.current.offsetHeight),[s.current]));const[n,p]=ye("tab",Ce,{}),o=n!=null?n:"source";return n||p(o,"replaceIn"),e.jsxs(lt,{children:[e.jsxs(ct,{ref:s,variant:"fullWidth",value:o,onChange:(h,a)=>p(a,"replaceIn"),children:[e.jsx(Y,{value:"source",sx:{textTransform:"none"},label:c("source.title_one")}),e.jsx(Y,{value:"extensions",sx:{textTransform:"none"},label:c("extension.title_other")}),e.jsx(Y,{value:"migrate",sx:{textTransform:"none"},label:c("migrate.title")})]}),e.jsx(J,{index:"source",currentIndex:o,children:e.jsx(jt,{})}),e.jsx(J,{index:"extensions",currentIndex:o,children:e.jsx(Et,{tabsMenuHeight:r})}),e.jsx(J,{index:"migrate",currentIndex:o,children:e.jsx(It,{tabsMenuHeight:r})})]})}export{On as Browse};
