import{u as J,j as e,M as g,aQ as $,v as o,bD as Y,bE as Q,bF as V,b9 as Z,m as A,g as L,r as P,e as ee,f as se,bG as te,s as d,F as re,i as ae,k as z,bH as K,b6 as l,bI as ne,bJ as T,bK as I,aL as w,bL as H,bM as q,av as G,bN as W}from"./index-BhVokvKL.js";import{N as p}from"./NumberSetting-CE4uwxbp.js";import{S as x}from"./SelectSetting-DJU-Y50P.js";import{E as le}from"./EmptyViewAbsoluteCentered-BJq-Oigr.js";import{u as ie}from"./useAppTitle-4Spvx_L_.js";import{C as oe}from"./LoginDialog-DBmxYlb8.js";import{a as de}from"./Asserts-DN5kdVdo.js";import{L as h}from"./ListSubheader-D7CzYQAm.js";import{S as c}from"./Switch-gdRcorsN.js";import{T as ce}from"./Trans-Btqax2RH.js";import{L as ge}from"./Link-Dzv9EhHt.js";import"./Slider-Bm_bN-y5.js";import"./Select-CNA59qEM.js";import"./SwitchBase-Cckwl4GK.js";const he=({settings:{koreaderSyncPercentageTolerance:t,koreaderSyncStrategyBackward:N,koreaderSyncStrategyForward:M,koreaderSyncChecksumMethod:y},serverAddress:_,username:f,isLoggedIn:m,updateSetting:S})=>{const{t:n}=J(),R=async()=>{const{data:a}=await P.koSyncLogout().response;if(a!=null&&a.logoutKoSyncAccount.status.isLoggedIn)throw new Error(n("tracking.action.logout.label.failure",{name:n("settings.server.koreader.sync.title")}))},D=async(a,v,U)=>{var r;const{data:i}=await P.koSyncLogin(a,v,U).response;if(!(i!=null&&i.connectKoSyncAccount.status.isLoggedIn))throw new Error((r=i==null?void 0:i.connectKoSyncAccount.message)!=null?r:n("global.label.unknown"))},u=async(a="https://sync.koreader.rocks/",v,U)=>{const i=oe.showControlled({title:n(m?"settings.server.koreader.sync.connection.disconnect":"settings.server.koreader.sync.connection.connect",{name:n("settings.server.koreader.sync.title")}),description:m?n("settings.server.koreader.sync.connection.connected",{username:v,serverAddress:a}):void 0,isLoading:!1,isLoggedIn:m,withServerAddress:!0,username:v,password:U,serverAddress:a,loginLogout:async(r,j,E)=>{if(i.update({isLoading:!0,loginLogout:Z}),m){try{await R(),i.submit()}catch(b){A(n("settings.server.koreader.sync.connection.message.disconnect_error"),"error",L(b))}return}try{de(E),await D(E,r,j),i.submit()}catch(b){A(n("settings.server.koreader.sync.connection.message.connect_error"),"error",L(b));const C="__retry__";await Promise.race([i.promise,Promise.resolve(C)])===C&&u(E,r,j)}}},{id:"koreader-sync-login-logout"})};return e.jsxs(g,{subheader:e.jsx(h,{component:"div",id:"koreader-sync-settings",children:n("settings.server.koreader.sync.title")}),children:[e.jsx($,{onClick:()=>u(_!=null?_:void 0,f!=null?f:void 0),children:e.jsx(o,{primary:n("settings.server.koreader.sync.connection.status"),secondary:m?n("settings.server.koreader.sync.connection.connected",{username:f,serverAddress:_}):n("settings.server.koreader.sync.connection.disconnected")})}),e.jsx(x,{settingName:n("settings.server.koreader.sync.strategy.forward_title"),value:M,values:Y,handleChange:a=>S("koreaderSyncStrategyForward",a)}),e.jsx(x,{settingName:n("settings.server.koreader.sync.strategy.backward_title"),value:N,values:Y,handleChange:a=>S("koreaderSyncStrategyBackward",a)}),e.jsx(x,{settingName:n("settings.server.koreader.sync.check_sum_method.title"),value:y,values:Q,handleChange:a=>S("koreaderSyncChecksumMethod",a)}),e.jsx(p,{settingTitle:n("settings.server.koreader.sync.tolerance.title"),dialogDescription:n("settings.server.koreader.sync.tolerance.description"),settingValue:t.toString(),value:t,defaultValue:V.default,minValue:V.min,maxValue:V.max,stepSize:V.step,valueUnit:"",handleUpdate:a=>S("koreaderSyncPercentageTolerance",a)})]})},ue=t=>t===0?G("global.label.never"):G("settings.server.misc.log_files.file_cleanup.value",{days:t,count:t}),Te=()=>{var C,F,B;const{t}=J();ie(t("settings.server.title.server"));const{settings:{serverInformAvailableUpdate:N},loading:M,request:{error:y,refetch:_}}=ee(),f=re(s=>A(t("global.error.label.failed_to_save_changes"),"error",L(s))),{data:m,loading:S,error:n,refetch:R}=P.useGetServerSettings({notifyOnNetworkStatusChange:!0}),[D]=P.useUpdateServerSettings(),u=P.useKoSyncStatus(),a=async(s,O,k)=>{try{await D({variables:{input:{settings:{[s]:O}}}}),k==null||k(!0)}catch(X){A(t("global.error.label.failed_to_save_changes"),"error",L(X)),k==null||k(!1)}},v=se.useMemo(()=>e.jsxs(g,{subheader:e.jsx(h,{component:"div",id:"server-settings-client",children:t("global.label.client")}),children:[e.jsx(te,{}),e.jsxs(d,{children:[e.jsx(o,{primary:t("global.update.settings.inform.label.title"),secondary:t("global.update.settings.inform.label.description")}),e.jsx(c,{edge:"end",checked:N,onChange:s=>f("serverInformAvailableUpdate",s.target.checked)})]})]}),[N]);if(M||S||u.loading)return e.jsxs(e.Fragment,{children:[v,e.jsx(ae,{})]});const i=(C=y!=null?y:n)!=null?C:u.error;if(i)return e.jsxs(e.Fragment,{children:[v,e.jsx(le,{message:t("global.error.label.failed_to_load_data"),messageExtra:L(i),retry:()=>{y&&_().catch(z()),n&&R().catch(z()),u.error&&u.refetch().catch(z())}})]});const r=m.settings,j=u.data.koSyncStatus,E=!((F=r.authUsername)!=null&&F.trim())||!((B=r.authPassword)!=null&&B.trim()),b=r.databaseType===K.H2;return e.jsxs(g,{sx:{pt:0},children:[v,e.jsxs(g,{subheader:e.jsx(h,{component:"div",id:"server-settings-server-address",children:t("settings.server.address.server.title")}),children:[e.jsx(l,{settingName:t("settings.server.address.server.label.ip"),handleChange:s=>a("ip",s),value:r.ip,placeholder:"0.0.0.0"}),e.jsx(p,{settingTitle:t("settings.server.address.server.label.port"),settingValue:r.port.toString(),handleUpdate:s=>a("port",s),value:r.port,defaultValue:4567,valueUnit:t("settings.server.address.server.label.port")})]}),e.jsxs(g,{subheader:e.jsx(h,{component:"div",id:"server-settings-socks-proxy",children:t("settings.server.socks_proxy.title")}),children:[e.jsxs(d,{children:[e.jsx(o,{primary:t("settings.server.socks_proxy.label.enable")}),e.jsx(c,{edge:"end",checked:r.socksProxyEnabled,onChange:s=>a("socksProxyEnabled",s.target.checked)})]}),e.jsx(x,{settingName:t("settings.server.socks_proxy.label.version"),value:r.socksProxyVersion,values:[[4,{text:"4"}],[5,{text:"5"}]],handleChange:s=>a("socksProxyVersion",s)}),e.jsx(l,{settingName:t("settings.server.socks_proxy.label.host"),value:r.socksProxyHost,handleChange:s=>a("socksProxyHost",s)}),e.jsx(l,{settingName:t("settings.server.socks_proxy.label.port"),value:r.socksProxyPort,handleChange:s=>a("socksProxyPort",s)}),e.jsx(l,{settingName:t("settings.server.socks_proxy.label.username"),value:r.socksProxyUsername,handleChange:s=>a("socksProxyUsername",s)}),e.jsx(l,{settingName:t("settings.server.socks_proxy.label.password"),value:r.socksProxyPassword,handleChange:s=>a("socksProxyPassword",s),isPassword:!0})]}),e.jsxs(g,{subheader:e.jsx(h,{component:"div",id:"server-settings-auth",children:t("settings.server.auth.title")}),children:[e.jsx(x,{settingName:t("settings.server.auth.label.title"),value:r.authMode,values:ne,handleChange:s=>{a("authMode",s,O=>{O&&(s!==T.UiLogin&&W.removeTokens(),W.setAuthRequired(s===T.UiLogin))})},disabled:E}),e.jsx(l,{settingName:t("settings.server.auth.label.username"),value:r.authUsername,validate:s=>r.authMode===T.None||!!s.trim(),handleChange:s=>a("authUsername",s)}),e.jsx(l,{settingName:t("settings.server.auth.label.password"),value:r.authPassword,isPassword:!0,validate:s=>r.authMode===T.None||!!s.trim(),handleChange:s=>a("authPassword",s)}),r.authMode===T.UiLogin&&e.jsxs(e.Fragment,{children:[e.jsx(l,{settingName:t("settings.server.auth.jwt.audience"),value:r.jwtAudience,handleChange:s=>a("jwtAudience",s)}),e.jsx(p,{settingTitle:t("settings.server.auth.jwt.access_token_expiry"),settingValue:w(r.jwtTokenExpiry).minutes.humanize(),value:w(r.jwtTokenExpiry).minutes.inWholeMinutes,valueUnit:t("global.time.minutes.minute_other"),defaultValue:I.default,minValue:I.min,maxValue:I.max,handleUpdate:s=>a("jwtTokenExpiry",w(s).minutes.toISOString()),showSlider:!0}),e.jsx(p,{settingTitle:t("settings.server.auth.jwt.refresh_token_expiry"),settingValue:w(r.jwtRefreshExpiry).days.humanize(),value:w(r.jwtRefreshExpiry).days.inWholeDays,valueUnit:t("global.time.days.day_other"),defaultValue:H.default,minValue:H.min,maxValue:H.max,handleUpdate:s=>a("jwtRefreshExpiry",w(s).days.toISOString()),showSlider:!0})]})]}),e.jsxs(g,{subheader:e.jsx(h,{component:"div",id:"server-settings-clouadflare-bypass",children:t("settings.server.cloudflare.title")}),children:[e.jsxs(d,{children:[e.jsx(o,{primary:t("settings.server.cloudflare.flaresolverr.enabled.label.title"),secondary:e.jsxs(ce,{i18nKey:"settings.server.cloudflare.flaresolverr.enabled.label.description",children:["See"," ",e.jsx(ge,{href:"https://github.com/FlareSolverr/FlareSolverr?tab=readme-ov-file#installation",target:"_blank",rel:"noreferrer",children:"FlareSolverr"})," ","for information on how to set it up"]})}),e.jsx(c,{edge:"end",checked:r.flareSolverrEnabled,onChange:s=>a("flareSolverrEnabled",s.target.checked)})]}),e.jsx(l,{settingName:t("settings.server.cloudflare.flaresolverr.url.label.title"),dialogDescription:t("settings.server.cloudflare.flaresolverr.url.label.description"),value:r.flareSolverrUrl,handleChange:s=>a("flareSolverrUrl",s)}),e.jsx(p,{settingTitle:t("settings.server.cloudflare.flaresolverr.timeout.label.title"),settingValue:t("global.time.seconds.value",{count:r.flareSolverrTimeout}),dialogDescription:t("settings.server.cloudflare.flaresolverr.timeout.label.description"),value:r.flareSolverrTimeout,defaultValue:60,minValue:20,maxValue:60*5,stepSize:1,showSlider:!0,valueUnit:t("global.time.seconds.second_other"),handleUpdate:s=>a("flareSolverrTimeout",s)}),e.jsx(l,{settingName:t("settings.server.cloudflare.flaresolverr.session.name.label.title"),value:r.flareSolverrSessionName,handleChange:s=>a("flareSolverrSessionName",s)}),e.jsx(p,{settingTitle:t("settings.server.cloudflare.flaresolverr.session.ttl.label.title"),settingValue:t("global.time.minutes.value",{count:r.flareSolverrSessionTtl}),dialogDescription:t("settings.server.cloudflare.flaresolverr.session.ttl.label.description"),value:r.flareSolverrSessionTtl,defaultValue:15,minValue:1,maxValue:60,stepSize:1,showSlider:!0,valueUnit:t("global.time.minutes.minute_other"),handleUpdate:s=>a("flareSolverrSessionTtl",s)}),e.jsxs(d,{children:[e.jsx(o,{primary:t("settings.server.cloudflare.flaresolverr.response_fallback.label.title"),secondary:t("settings.server.cloudflare.flaresolverr.response_fallback.label.description")}),e.jsx(c,{edge:"end",checked:r.flareSolverrAsResponseFallback,onChange:s=>a("flareSolverrAsResponseFallback",s.target.checked)})]})]}),e.jsxs(g,{subheader:e.jsx(h,{component:"div",id:"server-settings-opds",children:t("settings.server.opds.title")}),children:[e.jsxs(d,{children:[e.jsx(o,{primary:t("settings.server.opds.binary_file_sizes.label.title"),secondary:t("settings.server.opds.binary_file_sizes.label.description")}),e.jsx(c,{edge:"end",checked:r.opdsUseBinaryFileSizes,onChange:s=>a("opdsUseBinaryFileSizes",s.target.checked)})]}),e.jsx(p,{settingTitle:t("settings.server.opds.items_per_page.label.title"),settingValue:r.opdsItemsPerPage.toString(),dialogDescription:t("settings.server.opds.items_per_page.label.description"),value:r.opdsItemsPerPage,defaultValue:50,minValue:10,maxValue:5e3,stepSize:10,showSlider:!0,valueUnit:t("settings.server.opds.items_per_page.label.unit_other"),handleUpdate:s=>a("opdsItemsPerPage",s)}),e.jsxs(d,{children:[e.jsx(o,{primary:t("settings.server.opds.enable_page_read_progress.label.title"),secondary:t("settings.server.opds.enable_page_read_progress.label.description")}),e.jsx(c,{edge:"end",checked:r.opdsEnablePageReadProgress,onChange:s=>a("opdsEnablePageReadProgress",s.target.checked)})]}),e.jsxs(d,{children:[e.jsx(o,{primary:t("settings.server.opds.mark_as_read_on_download.label.title"),secondary:t("settings.server.opds.mark_as_read_on_download.label.description")}),e.jsx(c,{edge:"end",checked:r.opdsMarkAsReadOnDownload,onChange:s=>a("opdsMarkAsReadOnDownload",s.target.checked)})]}),e.jsxs(d,{children:[e.jsx(o,{primary:t("settings.server.opds.show_only_unread_chapters.label.title"),secondary:t("settings.server.opds.show_only_unread_chapters.label.description")}),e.jsx(c,{edge:"end",checked:r.opdsShowOnlyUnreadChapters,onChange:s=>a("opdsShowOnlyUnreadChapters",s.target.checked)})]}),e.jsxs(d,{children:[e.jsx(o,{primary:t("settings.server.opds.show_only_downloaded_chapters.label.title"),secondary:t("settings.server.opds.show_only_downloaded_chapters.label.description")}),e.jsx(c,{edge:"end",checked:r.opdsShowOnlyDownloadedChapters,onChange:s=>a("opdsShowOnlyDownloadedChapters",s.target.checked)})]}),e.jsx(x,{settingName:t("settings.server.opds.chapter_sort_order.label.title"),dialogDescription:t("settings.server.opds.chapter_sort_order.label.description"),value:r.opdsChapterSortOrder,values:[[q.Asc,{text:t("global.sort.label.asc")}],[q.Desc,{text:t("global.sort.label.desc")}]],handleChange:s=>a("opdsChapterSortOrder",s)})]}),e.jsx(he,{settings:r,serverAddress:j.serverAddress,username:j.username,isLoggedIn:j.isLoggedIn,updateSetting:a}),e.jsxs(g,{subheader:e.jsx(h,{component:"div",id:"server-settings-database",children:t("settings.server.database.title")}),children:[e.jsx(x,{settingName:t("settings.server.database.type.title"),value:r.databaseType,values:[[K.H2,{text:t("settings.server.database.type.h2")}],[K.Postgresql,{text:t("settings.server.database.type.postgresql")}]],handleChange:s=>a("databaseType",s)}),e.jsx(l,{settingName:t("settings.server.database.address"),handleChange:s=>a("databaseUrl",s),value:r.databaseUrl,placeholder:"postgresql://localhost:5432/suwayomi",disabled:b}),e.jsx(l,{settingName:t("settings.server.database.username"),value:r.databaseUsername,handleChange:s=>a("databaseUsername",s),disabled:b}),e.jsx(l,{settingName:t("settings.server.database.password"),value:r.databasePassword,handleChange:s=>a("databasePassword",s),disabled:b,isPassword:!0})]}),e.jsxs(g,{subheader:e.jsx(h,{component:"div",id:"server-settings-misc",children:t("settings.server.misc.title")}),children:[e.jsxs(d,{children:[e.jsx(o,{primary:t("settings.server.misc.log_level.label.server")}),e.jsx(c,{edge:"end",checked:r.debugLogsEnabled,onChange:s=>a("debugLogsEnabled",s.target.checked)})]}),e.jsxs(d,{children:[e.jsx(o,{primary:t("settings.server.misc.tray_icon.label.title"),secondary:t("settings.server.misc.tray_icon.label.description")}),e.jsx(c,{edge:"end",checked:r.systemTrayEnabled,onChange:s=>a("systemTrayEnabled",s.target.checked)})]}),e.jsx(p,{settingTitle:t("settings.server.misc.log_files.file_cleanup.title"),settingValue:ue(r.maxLogFiles),value:r.maxLogFiles,valueUnit:t("global.date.label.day_one"),handleUpdate:s=>a("maxLogFiles",s)}),e.jsx(l,{settingName:t("settings.server.misc.log_files.file_size.title"),value:r.maxLogFileSize,dialogDescription:t("settings.server.misc.log_files.file_size.description"),validate:s=>!!s.match(/^[0-9]+(|kb|KB|mb|MB|gb|GB)$/g),handleChange:s=>a("maxLogFileSize",s)}),e.jsx(l,{settingName:t("settings.server.misc.log_files.total_size.title"),value:r.maxLogFolderSize,dialogDescription:t("settings.server.misc.log_files.total_size.description"),validate:s=>!!s.match(/^[0-9]+(|kb|KB|mb|MB|gb|GB)$/g),handleChange:s=>a("maxLogFolderSize",s)})]})]})};export{Te as ServerSettings};
