import{d as o,j as e,_ as y,A as G,L as k,n as S,u as _,q as P,r as f,g as A,h as O,T as b,G as M,bi as H,f as v}from"./index-CBxbdOZa.js";import{E as j}from"./EmptyViewAbsoluteCentered-DCgg8ff9.js";import{U as B}from"./UpdateChecker-_q13jvf7.js";import{V as d,a as F,S as N,b as V}from"./Virtuoso.util-CtTergbz.js";import{C as D,D as q}from"./ChapterCardMetadata-CAy174W3.js";import{C as K,a as z}from"./ChapterDownloadButton-D861A8BF.js";import{C as W}from"./ChapterDownloadRetryButton-ChvbfVks.js";import{L as X}from"./ListCardContent-DPbnp6xG.js";import{C as Z}from"./Card-BbGJVXOW.js";import{C as J}from"./CardActionArea-Dl3PGSnS.js";import{u as Q}from"./useAppTitleAndAction-D4rw2KWz.js";import"./Progress-D2irP_JT.js";import"./MUI.util-Bs9Vl2GD.js";import"./ListCardAvatar-Olf2Zaaj.js";import"./Avatar-CczBYppx.js";import"./Download-Dvr2tlzK.js";import"./useAppTitle-BmkqDPsV.js";import"./useAppAction-mbKoUHfz.js";const Y=o.memo(({chapter:t})=>{const{manga:r}=t;return e.jsx(Z,{children:e.jsx(J,{component:k,to:G.reader.path(t.manga.id,t.sourceOrder),state:y.getReaderOpenChapterLocationState(t),sx:{color:s=>s.palette.text[t.isRead?"disabled":"primary"]},children:e.jsxs(X,{sx:{justifyContent:"space-between"},children:[e.jsxs(S,{sx:{display:"flex",flexGrow:1,gap:1},children:[e.jsx(K,{mangaId:r.id,mangaTitle:r.title,thumbnailUrl:r.thumbnailUrl,thumbnailUrlLastFetched:r.thumbnailUrlLastFetched}),e.jsx(D,{title:r.title,secondaryText:t.name})]}),e.jsx(q,{chapterId:t.id}),e.jsx(W,{chapterId:t.id}),e.jsx(z,{chapterId:t.id,isDownloaded:t.isDownloaded})]})})})}),Ce=()=>{var x;const{t}=_(),{appBarHeight:r}=P(),{data:s,loading:m,error:u,fetchMore:T,refetch:I}=f.useGetRecentlyUpdatedChapters(void 0,{fetchPolicy:"cache-and-network",notifyOnNetworkStatusChange:!0}),c=!!(s!=null&&s.chapters.pageInfo.hasNextPage),U=s==null?void 0:s.chapters.pageInfo.endCursor,n=(x=s==null?void 0:s.chapters.nodes)!=null?x:[],i=o.useMemo(()=>Object.entries(y.groupByDate(n,"fetchedAt")),[n]),h=o.useMemo(()=>i.map(a=>a[d.ITEMS].length),[i]),L=d.useCreateGroupedComputeItemKey(h,o.useCallback(a=>i[a][d.GROUP],[i]),o.useCallback(a=>n[a].id,[n])),l=o.useRef(null),[R,w]=o.useState(0);o.useLayoutEffect(()=>{var a,C;w((C=(a=l.current)==null?void 0:a.clientHeight)!=null?C:0)},[l.current]);const{data:p}=f.useGetLastGlobalUpdateTimestamp({fetchPolicy:"cache-only"}),g=p==null?void 0:p.lastUpdateTimestamp.timestamp;Q(t("updates.title"),e.jsx(B,{}));const E=o.useCallback(()=>{c&&T({variables:{offset:n.length}})},[c,U]);return u?e.jsx(j,{message:t("global.error.label.failed_to_load_data"),messageExtra:A(u),retry:()=>I().catch(O())}):!m&&n.length===0?e.jsx(j,{message:t("updates.error.label.no_updates_available")}):e.jsxs(e.Fragment,{children:[e.jsx(b,{ref:l,sx:{position:"sticky",top:r,zIndex:M,backgroundColor:"background.default",marginLeft:"10px",paddingTop:a=>({[a.breakpoints.up("sm")]:{paddingTop:"6px"}})},children:t("library.settings.global_update.label.last_update",{date:g?H.format(+g):"-"})}),e.jsx(F,{heightToSubtract:R,components:{Footer:()=>m?e.jsx(v,{usePadding:!0}):null},overscan:window.innerHeight*.5,endReached:E,groupCounts:h,groupContent:a=>e.jsx(V,{isFirstItem:a===0,children:e.jsx(b,{variant:"h5",component:"h2",children:i[a][d.GROUP]})}),computeItemKey:L,itemContent:a=>e.jsx(N,{children:e.jsx(Y,{chapter:n[a]})})})]})};export{Ce as Updates};
