import{e as s,j as e,_ as U,A as _,L as P,o as O,u as M,a as j,r as y,h as A,i as H,T,G as v,bk as B,g as F}from"./index-DWz4TNtd.js";import{E as I}from"./EmptyViewAbsoluteCentered-DPrnddnF.js";import{U as N}from"./UpdateChecker-CvrdlEcf.js";import{V as l,a as V,S as D,b as K}from"./Virtuoso.util-zkXm-8Xh.js";import{C as q,D as z}from"./ChapterCardMetadata-CVgQm7ae.js";import{C as W,a as X}from"./ChapterDownloadButton-Bl4yXpX3.js";import{C as Z}from"./ChapterDownloadRetryButton-BmiRI-Cp.js";import{L as J}from"./ListCardContent-D0gc0Fug.js";import{C as Q}from"./Card-8Hlh2tNY.js";import{C as Y}from"./CardActionArea-DZr1-Ien.js";import"./Progress-CRYkx6IF.js";import"./MUI.util-BHb8I4Fi.js";import"./ListCardAvatar-DBmIeoJi.js";import"./Avatar-aJufYokf.js";import"./Download-BNw0zcIk.js";import"./CardContent-CJ5i7b3K.js";const $=s.memo(({chapter:t})=>{const{manga:r}=t;return e.jsx(Q,{children:e.jsx(Y,{component:P,to:_.reader.path(t.manga.id,t.sourceOrder),state:U.getReaderOpenChapterLocationState(t),sx:{color:d=>d.palette.text[t.isRead?"disabled":"primary"]},children:e.jsxs(J,{sx:{justifyContent:"space-between"},children:[e.jsxs(O,{sx:{display:"flex",flexGrow:1,gap:1},children:[e.jsx(W,{mangaId:r.id,mangaTitle:r.title,thumbnailUrl:r.thumbnailUrl,thumbnailUrlLastFetched:r.thumbnailUrlLastFetched}),e.jsx(q,{title:r.title,secondaryText:t.name})]}),e.jsx(z,{chapterId:t.id}),e.jsx(Z,{chapterId:t.id}),e.jsx(X,{chapterId:t.id,isDownloaded:t.isDownloaded})]})})})}),xe=()=>{var f;const{t}=M(),{appBarHeight:r}=j(),{setTitle:d,setAction:c}=j(),{data:o,loading:h,error:g,fetchMore:L,refetch:E}=y.useGetRecentlyUpdatedChapters(void 0,{fetchPolicy:"cache-and-network",notifyOnNetworkStatusChange:!0}),x=!!(o!=null&&o.chapters.pageInfo.hasNextPage),R=o==null?void 0:o.chapters.pageInfo.endCursor,n=(f=o==null?void 0:o.chapters.nodes)!=null?f:[],i=s.useMemo(()=>Object.entries(U.groupByDate(n,"fetchedAt")),[n]),C=s.useMemo(()=>i.map(a=>a[l.ITEMS].length),[i]),k=l.useCreateGroupedComputeItemKey(C,s.useCallback(a=>i[a][l.GROUP],[i]),s.useCallback(a=>n[a].id,[n])),p=s.useRef(null),[w,G]=s.useState(0);s.useLayoutEffect(()=>{var a,b;G((b=(a=p.current)==null?void 0:a.clientHeight)!=null?b:0)},[p.current]);const{data:m}=y.useGetLastGlobalUpdateTimestamp({fetchPolicy:"cache-only"}),u=m==null?void 0:m.lastUpdateTimestamp.timestamp;s.useLayoutEffect(()=>(d(t("updates.title")),c(e.jsx(N,{})),()=>{d(""),c(null)}),[t,u]);const S=s.useCallback(()=>{x&&L({variables:{offset:n.length}})},[x,R]);return g?e.jsx(I,{message:t("global.error.label.failed_to_load_data"),messageExtra:A(g),retry:()=>E().catch(H())}):!h&&n.length===0?e.jsx(I,{message:t("updates.error.label.no_updates_available")}):e.jsxs(e.Fragment,{children:[e.jsx(T,{ref:p,sx:{position:"sticky",top:r,zIndex:v,backgroundColor:"background.default",marginLeft:"10px",paddingTop:a=>({[a.breakpoints.up("sm")]:{paddingTop:"6px"}})},children:t("library.settings.global_update.label.last_update",{date:u?B.format(+u):"-"})}),e.jsx(V,{heightToSubtract:w,components:{Footer:()=>h?e.jsx(F,{usePadding:!0}):null},overscan:window.innerHeight*.5,endReached:S,groupCounts:C,groupContent:a=>e.jsx(K,{isFirstItem:a===0,children:e.jsx(T,{variant:"h5",component:"h2",children:i[a][l.GROUP]})}),computeItemKey:k,itemContent:a=>e.jsx(D,{children:e.jsx($,{chapter:n[a]})})})]})};export{xe as Updates};
