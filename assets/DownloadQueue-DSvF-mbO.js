import{c as R,j as e,d as j,u as M,E as h,r as a,m as P,g as v,h as z,n as _,A as V,L as B,I as f,C as b,f as F}from"./index-CBxbdOZa.js";import{P as U}from"./PlayArrow-Bu-WWWUu.js";import{M as y,K as W}from"./MUI.util-Bs9Vl2GD.js";import{D as G,a as N,b as J,c as X,S as Y,v as Z,d as $,e as ee}from"./DragHandle-BkRBEjIV.js";import{E}from"./EmptyViewAbsoluteCentered-DCgg8ff9.js";import{D as te}from"./Delete-CPYpmXa7.js";import{C as oe}from"./ChapterDownloadRetryButton-ChvbfVks.js";import{C as re,D as ae}from"./ChapterCardMetadata-CAy174W3.js";import{L as se}from"./ListCardContent-DPbnp6xG.js";import{C as ne}from"./Card-BbGJVXOW.js";import{C as ie}from"./CardActionArea-Dl3PGSnS.js";import{u as le}from"./useAppTitle-BmkqDPsV.js";import{u as de}from"./useAppAction-mbKoUHfz.js";import{u as ce}from"./use-window-event-BNPYW1ld.js";const pe=R(e.jsx("path",{d:"M6 19h4V5H6zm8-14v14h4V5z"})),ue=R(e.jsx("path",{d:"M15 16h4v2h-4zm0-8h7v2h-7zm0 4h6v2h-6zM3 18c0 1.1.9 2 2 2h6c1.1 0 2-.9 2-2V8H3zM14 5h-3l-1-1H6L5 5H2v2h12z"})),A=j.memo(({item:o,status:m})=>{const{t:x}=M(),d=j.useCallback(async i=>{const c=m===h.Started;try{c&&await a.stopDownloads().response,await Promise.all([a.removeChapterFromDownloadQueue(i.id).response,a.deleteDownloadedChapter(i.id).response])}catch(w){P(x("download.queue.error.label.failed_to_remove"),"error",v(w))}c&&a.startDownloads().response.catch(z())},[m]);return e.jsx(_,{sx:{p:1,pb:0},children:e.jsx(ne,{children:e.jsx(ie,{component:B,to:V.manga.path(o.manga.id),children:e.jsxs(se,{children:[e.jsx(f,{...y.preventRippleProp(),sx:{pointerEvents:"none"},children:e.jsx(G,{})}),e.jsx(re,{title:o.manga.title,secondaryText:o.chapter.name}),e.jsx(ae,{chapterId:o.chapter.id}),e.jsx(oe,{chapterId:o.chapter.id}),e.jsx(b,{title:x("chapter.action.download.delete.label.action"),children:e.jsx(f,{...y.preventRippleProp(),onClick:i=>{i.preventDefault(),i.stopPropagation(),d(o.chapter)},children:e.jsx(te,{})})})]})})})})}),Ee=()=>{var I,S;const{t:o}=M();le(o("download.queue.title"));const[m,{reset:x}]=a.useReorderChapterInDownloadQueue(),{data:d,loading:i,error:c,refetch:w}=a.useGetDownloadStatus({notifyOnNetworkStatusChange:!0}),l=d==null?void 0:d.downloadStatus,r=(I=l==null?void 0:l.queue)!=null?I:[],p=(S=l==null?void 0:l.state)!=null?S:h.Started,D=!r.length,q=j.useMemo(()=>r.map(t=>t.chapter),[r]),L=N.useSensorsForDevice(),[u,g]=j.useState(null),k=async()=>{try{await a.clearDownloads().response}catch(t){P(o("download.queue.error.label.failed_delete_all"),"error",v(t))}},H=()=>{p===h.Stopped?a.startDownloads():a.stopDownloads()},Q=(t,s,n)=>{s!==n&&m({variables:{input:{chapterId:t[s].chapter.id,to:n}}}).catch(()=>{x()})},T=t=>{const{active:s,over:n}=t;if(g(null),!n||s.id===n.id)return;const K=r.findIndex(C=>C.chapter.id===s.id),O=r.findIndex(C=>C.chapter.id===n.id);Q(r,K,O)};return de(e.jsxs(e.Fragment,{children:[e.jsx(b,{title:o("download.queue.label.delete_all"),children:e.jsx(f,{onClick:k,color:"inherit",children:e.jsx(ue,{})})}),e.jsx(b,{title:o(p===h.Started?"global.button.start":"global.button.stop"),disabled:D,children:e.jsx(f,{onClick:H,disabled:D,color:"inherit",children:p===h.Stopped?e.jsx(U,{}):e.jsx(pe,{})})})]})),ce("error",t=>{(t.message==="ResizeObserver loop completed with undelivered notifications."||t.message==="ResizeObserver loop limit exceeded")&&t.stopImmediatePropagation()}),i?e.jsx(F,{}):c?e.jsx(E,{message:o("global.error.label.failed_to_load_data"),messageExtra:v(c),retry:()=>w().catch(z())}):D?e.jsx(E,{message:o("download.queue.label.no_downloads")}):e.jsx(_,{sx:{pb:1},children:e.jsxs(J,{sensors:L,collisionDetection:X,onDragStart:t=>{var s;return g((s=r.find(n=>n.chapter.id===t.active.id))!=null?s:null)},onDragEnd:T,onDragCancel:()=>g(null),onDragAbort:()=>g(null),children:[e.jsx(Y,{items:q,strategy:Z,children:e.jsx(W,{useWindowScroll:!0,overscan:window.innerHeight*.5,totalCount:r.length,computeItemKey:t=>r[t].chapter.id,itemContent:t=>e.jsx($,{id:r[t].chapter.id,isDragging:r[t].chapter.id===(u==null?void 0:u.chapter.id),children:e.jsx(A,{item:r[t],status:p})})})}),e.jsx(ee,{isActive:!!u,children:e.jsx(A,{item:u,status:p})})]})})};export{Ee as DownloadQueue};
