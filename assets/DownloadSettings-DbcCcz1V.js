import{u as j,j as t,M as D,s as w,v as m,bz as f,$ as K,m as V,g as k,f as L,aQ as Q,o as J,p as Z,q as ee,bb as te,b as T,w as ae,B as M,bA as oe,b7 as G,bB as F,C as se,I as ne,bh as le,r as N,b8 as ie,e as re,i as de,k as U,b6 as ce,F as he}from"./index-DxgalVhl.js";import{N as H}from"./NumberSetting-Ba59CIML.js";import{u as ue,g as pe}from"./usePersistedValue-8lnNW0zp.js";import{S as b}from"./Switch-B_TucHfS.js";import{S as ge}from"./SelectSetting-CohI9pNv.js";import{a as me}from"./CategoriesInclusionSetting-C8mUdi3Z.js";import{E as xe}from"./EmptyViewAbsoluteCentered-CiljhVsh.js";import{u as we}from"./useAppTitle-CAGOJfWZ.js";import{D as be}from"./Delete-3pX8dK8F.js";import{L as P}from"./ListSubheader-DckEPLZ4.js";import"./Slider-CDAC3y_f.js";import"./SwitchBase-lxmYe8oS.js";import"./Select-ClwEEQrU.js";import"./ThreeStateCheckboxInput-C9R8vv7d.js";import"./Checkbox-BJZDgsc1.js";const _e=({downloadAheadLimit:e})=>{const{t:a}=j(),s=!!e,[n,h]=ue("lastDownloadAheadLimit",f.default,e,pe),i=r=>{h(r===0?n:r),K("downloadAheadLimit",r).catch(p=>V(a("global.error.label.failed_to_save_changes"),"error",k(p)))},d=r=>{i(r?n:0)};return t.jsxs(D,{children:[t.jsxs(w,{children:[t.jsx(m,{primary:a("download.settings.download_ahead.label.while_reading")}),t.jsx(b,{edge:"end",checked:s,onChange:r=>d(r.target.checked)})]}),t.jsx(H,{settingTitle:a("download.settings.download_ahead.label.unread_chapters_to_download"),settingValue:a("download.settings.download_ahead.label.value",{chapters:n,count:n}),value:n,minValue:f.min,maxValue:f.max,defaultValue:f.default,stepSize:f.step,showSlider:!0,dialogDescription:a("download.settings.download_ahead.label.description"),dialogDisclaimer:a("download.settings.download_ahead.label.disclaimer"),valueUnit:a("chapter.title_one"),handleUpdate:i,disabled:!s})]})},Ce=[0,1,2,3,4,5],je={0:{text:"global.label.disabled"},1:{text:"download.settings.delete_chapters.while_reading.option.label.first"},2:{text:"download.settings.delete_chapters.while_reading.option.label.second"},3:{text:"download.settings.delete_chapters.while_reading.option.label.third"},4:{text:"download.settings.delete_chapters.while_reading.option.label.fourth"},5:{text:"download.settings.delete_chapters.while_reading.option.label.fifth"}},fe=Ce.map(e=>[e,je[e]]),De=e=>typeof e=="boolean"?Number(e):e,Te=({chapterToDelete:e,handleChange:a})=>{const{t:s}=j(),n=De(e);return t.jsx(ge,{settingName:s("download.settings.delete_chapters.while_reading.label.title"),value:n,values:fe,handleChange:a})},R="default",A="image/",z=-1,v=e=>e.replace(A,""),W=e=>v(e.toLowerCase().trim())===R,q=(e,a,s)=>s.slice(0,a).some(n=>n.mimeType===e),Y=e=>e==null||e>=F.min&&e<=F.max,ve=e=>e.some(({mimeType:a,compressionLevel:s},n)=>!Y(s)||q(a,n,e)),O=e=>e.map(a=>({...a,mimeType:v(a.mimeType),target:v(a.target)})),ye=e=>W(e)?R:"".concat(A).concat(e),$=e=>e.filter(({mimeType:a,target:s})=>!!a&&!!s).map(a=>({...a,mimeType:ye(a.mimeType),target:"".concat(A).concat(a.target)})),E=e=>[...e.some(({mimeType:s})=>W(s))?[]:[{mimeType:R,target:"",compressionLevel:null}],...e],Se=(e,a)=>e.length!==a.length?!0:e.some(({mimeType:s,target:n,compressionLevel:h},i)=>{const d=a[i];return v(s)!==d.mimeType||v(n)!==d.target||h!==d.compressionLevel}),B=({shouldAutoFocus:e,isDefault:a,isDuplicate:s,label:n,value:h,onUpdate:i})=>{const{t:d}=j();return t.jsx(G,{sx:{maxWidth:150},autoFocus:e,label:n,value:h,disabled:a,error:s,helperText:s&&d("global.error.label.invalid_input"),slotProps:{input:{startAdornment:t.jsx(le,{position:"start",children:A})}},onChange:r=>i(r.target.value.trim())})},Ee=({shouldAutoFocusMimeTypeTextField:e,conversion:{mimeType:a,target:s,compressionLevel:n},setFocusMimeTypeTextField:h,onChange:i,isDuplicate:d})=>{const{t:r}=j(),p=Y(n),x=W(a)&&!d,o=x&&!s&&n==null;return t.jsxs(T,{sx:{gap:1,flexDirection:"row",flexWrap:"nowrap",alignItems:"center",pt:1},children:[t.jsxs(T,{sx:{gap:1,flexDirection:"row",alignItems:"baseline",flexWrap:"wrap"},children:[t.jsx(B,{shouldAutoFocus:e,isDefault:x,isDuplicate:d,label:r("download.settings.conversion.mime_type"),value:a,onUpdate:c=>{h(!0),i({mimeType:c,target:s,compressionLevel:n})}}),t.jsx(oe,{sx:{mx:1},children:"→"}),t.jsx(B,{shouldAutoFocus:!1,isDefault:!1,isDuplicate:!1,label:r("download.settings.conversion.target"),value:s,onUpdate:c=>i({mimeType:a,target:c,compressionLevel:n})}),t.jsx(G,{label:r("download.settings.conversion.compression_level"),value:n!=null?n:"",type:"number",error:!p,helperText:p?"":r("global.error.label.invalid_input"),slotProps:{input:{inputProps:F}},onChange:c=>{i({mimeType:a,target:s,compressionLevel:c.target.value?Number(c.target.value):void 0})}})]}),t.jsx(se,{disabled:o,title:r("chapter.action.download.delete.label.action"),children:t.jsx(ne,{disabled:o,onClick:()=>{h(!1),i(null)},children:t.jsx(be,{})})})]})},ke=({conversions:e,updateSetting:a})=>{const{t:s}=j(),[n,h]=L.useState(!1),[i,d]=L.useState(O(E(e))),[r,p]=L.useState(z),x=ve(i),o=Se(O(E(e)),i),c=(u=e)=>{d(O(E(u))),h(!1)},_=()=>{c(e)},y=async()=>{try{await a($(i)),c($(i))}catch(u){}};return t.jsxs(t.Fragment,{children:[t.jsx(Q,{disabled:!1,onClick:()=>h(!0),children:t.jsx(m,{primary:s("download.settings.conversion.title"),secondary:e.map(u=>"".concat(u.mimeType," → ").concat(u.target)).join("; "),secondaryTypographyProps:{style:{display:"flex",flexDirection:"column"}}})}),t.jsxs(J,{open:n,onClose:_,children:[t.jsx(Z,{children:s("download.settings.conversion.title")}),t.jsxs(ee,{children:[t.jsx(te,{sx:{mb:2,whiteSpace:"pre-line"},children:s("download.settings.conversion.description",{value:"none"})}),t.jsx(T,{sx:{flexDirection:"column",gap:3},children:i.map((u,g)=>{const{mimeType:l}=u,I=q(l,g,i),S=g===r;return t.jsx(Ee,{conversion:u,isDuplicate:I,setFocusMimeTypeTextField:C=>p(C?g:z),shouldAutoFocusMimeTypeTextField:S,onChange:C=>{d(X=>E(X.toSpliced(g,1,...C?[C]:[])))}},"".concat(l,"-").concat(g))})})]}),t.jsx(ae,{children:t.jsxs(T,{direction:"row",sx:{justifyContent:"space-between",width:"100%"},children:[t.jsx(M,{variant:"outlined",onClick:()=>{d(u=>[...u,{mimeType:"",target:"",compressionLevel:null}])},children:s("global.button.add")}),t.jsxs(T,{direction:"row",children:[t.jsx(M,{onClick:_,children:s("global.button.cancel")}),t.jsx(M,{disabled:x||!o,onClick:y,children:s("global.button.ok")})]})]})})]})]})},Ge=()=>{var y,u,g;const{t:e}=j();we(e("download.title.download"));const a=N.useGetCategories(ie),s=N.useGetServerSettings({notifyOnNetworkStatusChange:!0}),[n]=N.useUpdateServerSettings(),{settings:h,loading:i,request:{error:d,refetch:r}}=re();if(s.loading||i||a.loading)return t.jsx(de,{});const x=(u=(y=s.error)!=null?y:d)!=null?u:a.error;if(x)return t.jsx(xe,{message:e("global.error.label.failed_to_load_data"),messageExtra:k(x),retry:()=>{s.error&&s.refetch().catch(U()),d&&r().catch(U()),a.error&&a.refetch().catch(U())}});const o=s.data.settings,c=(l,I)=>{const S=n({variables:{input:{settings:{[l]:I}}}});return S.catch(C=>V(e("global.error.label.failed_to_save_changes"),"error",k(C))),S},_=he(l=>V(e("global.error.label.failed_to_save_changes"),"error",k(l)));return t.jsxs(D,{sx:{pt:0},children:[t.jsx(ce,{settingName:e("download.settings.download_path.label.title"),dialogDescription:e("download.settings.download_path.label.description"),value:o==null?void 0:o.downloadsPath,settingDescription:o!=null&&o.downloadsPath.length?o.downloadsPath:e("global.label.default"),handleChange:l=>c("downloadsPath",l)}),t.jsxs(w,{children:[t.jsx(m,{primary:e("download.settings.file_type.label.cbz")}),t.jsx(b,{edge:"end",checked:!!(o!=null&&o.downloadAsCbz),onChange:l=>c("downloadAsCbz",l.target.checked)})]}),t.jsx(ke,{conversions:o==null?void 0:o.downloadConversions,updateSetting:l=>c("downloadConversions",l)}),t.jsxs(D,{subheader:t.jsx(P,{component:"div",id:"download-settings-auto-delete-downloads",children:e("download.settings.delete_chapters.title")}),children:[t.jsxs(w,{children:[t.jsx(m,{primary:e("download.settings.delete_chapters.label.manually_marked_as_read")}),t.jsx(b,{edge:"end",checked:h.deleteChaptersManuallyMarkedRead,onChange:l=>_("deleteChaptersManuallyMarkedRead",l.target.checked)})]}),t.jsx(Te,{chapterToDelete:h.deleteChaptersWhileReading,handleChange:l=>_("deleteChaptersWhileReading",l)}),t.jsxs(w,{children:[t.jsx(m,{primary:e("download.settings.delete_chapters.label.allow_deletion_of_bookmarked")}),t.jsx(b,{edge:"end",checked:h.deleteChaptersWithBookmark,onChange:l=>_("deleteChaptersWithBookmark",l.target.checked)})]})]}),t.jsxs(D,{subheader:t.jsx(P,{component:"div",id:"download-settings-auto-download",children:e("download.settings.auto_download.title")}),children:[t.jsxs(w,{children:[t.jsx(m,{primary:e("download.settings.auto_download.label.new_chapters")}),t.jsx(b,{edge:"end",checked:!!(o!=null&&o.autoDownloadNewChapters),onChange:l=>c("autoDownloadNewChapters",l.target.checked)})]}),t.jsx(H,{disabled:!(o!=null&&o.autoDownloadNewChapters),settingTitle:e("download.settings.auto_download.download_limit.label.title"),dialogDescription:e("download.settings.auto_download.download_limit.label.description"),value:(g=o==null?void 0:o.autoDownloadNewChaptersLimit)!=null?g:0,settingValue:o.autoDownloadNewChaptersLimit?e("download.settings.download_ahead.label.value",{chapters:o.autoDownloadNewChaptersLimit,count:o.autoDownloadNewChaptersLimit}):e("global.label.none"),defaultValue:0,minValue:0,maxValue:20,showSlider:!0,valueUnit:e("chapter.title_one"),handleUpdate:l=>c("autoDownloadNewChaptersLimit",l)}),t.jsxs(w,{children:[t.jsx(m,{primary:e("download.settings.auto_download.label.ignore_with_unread_chapters")}),t.jsx(b,{edge:"end",checked:!!(o!=null&&o.excludeEntryWithUnreadChapters),onChange:l=>c("excludeEntryWithUnreadChapters",l.target.checked),disabled:!(o!=null&&o.autoDownloadNewChapters)})]}),t.jsxs(w,{children:[t.jsx(m,{primary:e("download.settings.auto_download.label.ignore_re_uploads")}),t.jsx(b,{edge:"end",checked:!!(o!=null&&o.autoDownloadIgnoreReUploads),onChange:l=>c("autoDownloadIgnoreReUploads",l.target.checked),disabled:!(o!=null&&o.autoDownloadNewChapters)})]}),t.jsx(me,{categories:a.data.categories.nodes,includeField:"includeInDownload",dialogText:e("download.settings.auto_download.categories.label.include_in_download")})]}),t.jsx(D,{subheader:t.jsx(P,{component:"div",id:"download-settings-download-ahead",children:e("download.settings.download_ahead.title")}),children:t.jsx(_e,{downloadAheadLimit:h.downloadAheadLimit})})]})};export{Ge as DownloadSettings};
