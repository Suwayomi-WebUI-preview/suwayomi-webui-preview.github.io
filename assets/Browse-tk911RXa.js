import{r as Z,i as ee,j as e,u as N,M as Be,C as te,a as Le,L as k,b as ne,B as M,S as se,c as S,T as m,d as re,e as R,f as l,N as oe,g as F,h as Pe,k as $,I as H,l as ae,E as G,m as I,n as _,o as Fe,p as $e,q as He,s as Ge,t as ze,v as qe,w as Se,x as ve,y as Ve,z as We,A as Ke,D as Q,F as Y}from"./index-DXzmj8RR.js";import{u as Te,S as we,A as Xe}from"./AppbarSearch-yc6znFTL.js";import{s as Ee,l as Ce,D as z,a as Qe,e as Ye}from"./Languages-Dej0jElu.js";import{SourceContentType as J}from"./SourceMangas-DQAXijBi.js";import{t as q,L as _e,g as P,I as Je,a as Ze,E as Ne,b as w,c as Ie,d as et,e as tt,f as nt,i as st,h as rt}from"./LangSelect-CoqjNgG9.js";import{A as ie}from"./Avatar-BBbIXDMI.js";import{f as ot}from"./file-selector-DdG2Ck3c.js";import{V as at,S as it,a as lt,b as Ae}from"./Virtuoso.util-UUmCGfoj.js";import{T as ct}from"./TabsWrapper-lq6XeGH_.js";import{d as ut,a as dt}from"./SortRadioInput-DBf_-SGJ.js";import{C as xt}from"./Chip-mEMs_3Vv.js";import"./useManageMangaLibraryState-CN2Bf_l4.js";import"./Trackers-D4pSmk7a.js";import"./CheckCircle-DuWjbNT0.js";import"./Mangas-BCq0pXp7.js";import"./ListPreference-BX0RKtdE.js";import"./NumberSetting-D62XJE2w.js";import"./useMobilePicker-BjOyGQzM.js";import"./SelectSetting-BWhpIAa8.js";import"./ThreeStateCheckboxInput-sP3ACbAp.js";import"./ExpandMore-DCyVhLQu.js";import"./FilterList-_WIcoJH-.js";import"./GridLayouts-D02W7dMD.js";import"./useDebounce-Cb3R2rZV.js";import"./StyledFab-BW69adB0.js";import"./BaseMangaGrid-WLfvtU_f.js";import"./MangaGrid-Cs8Cza_g.js";import"./Sync-JkWVyJ41.js";import"./PlayArrow-DqcL2iDV.js";import"./cloneObject-DrOPTG0J.js";import"./Switch-DvqlkVje.js";var le={},ht=ee;Object.defineProperty(le,"__esModule",{value:!0});var Oe=le.default=void 0,pt=ht(Z()),gt=e;Oe=le.default=(0,pt.default)((0,gt.jsx)("path",{d:"M19.3 16.9c.4-.7.7-1.5.7-2.4 0-2.5-2-4.5-4.5-4.5S11 12 11 14.5s2 4.5 4.5 4.5c.9 0 1.7-.3 2.4-.7l3.2 3.2 1.4-1.4zm-3.8.1c-1.4 0-2.5-1.1-2.5-2.5s1.1-2.5 2.5-2.5 2.5 1.1 2.5 2.5-1.1 2.5-2.5 2.5M12 20v2C6.48 22 2 17.52 2 12S6.48 2 12 2c4.84 0 8.87 3.44 9.8 8h-2.07c-.64-2.46-2.4-4.47-4.73-5.41V5c0 1.1-.9 2-2 2h-2v2c0 .55-.45 1-1 1H8v2h2v3H9l-4.79-4.79C4.08 10.79 4 11.38 4 12c0 4.41 3.59 8 8 8"}),"TravelExplore");const ft=c=>{const{t}=N(),s=Be.useIsMobileWidth(),{source:{id:r,name:u,lang:n,iconUrl:x,supportsLatest:o,isNsfw:p,extension:{repo:a}},showSourceRepo:j}=c,d=Number(r)===0?t("source.local_source.title"):u;return e.jsx(te,{sx:{margin:1,marginTop:0},children:e.jsx(Le,{component:k,to:"/sources/".concat(r),state:{contentType:J.POPULAR,clearCache:!0},children:e.jsxs(ne,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:1.5},children:[e.jsxs(M,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(ie,{variant:"rounded",alt:d,sx:{width:56,height:56,flex:"0 0 auto",mr:1,background:"transparent"},children:e.jsx(se,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:d,src:S.getValidImgUrlFor(x)})}),e.jsxs(M,{sx:{display:"flex",flexDirection:"column",justifyContent:"center"},children:[e.jsx(m,{variant:"h6",component:"h3",children:d}),e.jsxs(m,{variant:"caption",sx:{display:"block"},children:[q(n),p&&e.jsx(m,{variant:"caption",color:"error",sx:{display:"inline"},children:" 18+"}),j&&e.jsx(m,{variant:"caption",sx:{display:"block"},children:a})]})]})]}),e.jsxs(re,{sx:{flexDirection:"row",gap:1},children:[o&&e.jsx(R,{variant:"outlined",component:k,to:"/sources/".concat(r),state:{contentType:J.LATEST,clearCache:!0},children:t("global.button.latest")}),!s&&e.jsx(R,{variant:"outlined",component:k,to:"/sources/".concat(r),state:{contentType:J.POPULAR,clearCache:!0},children:t("global.button.popular")})]})]})})})};function mt(c){const t=new Set;return c.forEach(s=>{const u=Number(s.id)===0?z.OTHER:s.lang;t.add(u)}),[...t].sort(Ce)}function jt(c){const t={};return c.forEach(s=>{var n;const u=Number(s.id)===0?z.OTHER:s.lang;(n=t[u])!=null||(t[u]=[]),t[u].push(s)}),Object.values(t).forEach(s=>s.sort((r,u)=>r.name.localeCompare(u.name))),t}function St(){const{t:c}=N(),{setAction:t}=l.useContext(oe),[s,r]=F("shownSourceLangs",Qe()),[u]=F("showNsfw",!0),{data:n,loading:x,error:o,refetch:p}=S.useGetSourceList({notifyOnNetworkStatusChange:!0}),a=n==null?void 0:n.sources.nodes,j=l.useMemo(()=>{if(!a||a!=null&&a.length)return!1;const{repo:d}=a[0].extension;return a.some(f=>f.extension.repo!==d)},[a]),L=Pe();return l.useEffect(()=>{Ee().forEach(d=>{let f=!1;s.forEach(h=>{h===d&&(f=!0)}),f||r(h=>(h.push(d),h))})},[]),l.useLayoutEffect(()=>(t(e.jsxs(e.Fragment,{children:[e.jsx($,{title:c("search.title.global_search"),children:e.jsx(H,{onClick:()=>L("/sources/all/search/"),size:"large",color:"inherit",children:e.jsx(Oe,{})})}),e.jsx(_e,{shownLangs:s,setShownLangs:r,allLangs:mt(a!=null?a:[]),forcedLangs:Ee()})]})),()=>{t(null)}),[c,s,a]),x?e.jsx(ae,{}):o?e.jsx(G,{message:c("global.error.label.failed_to_load_data"),messageExtra:o.message,retry:()=>p().catch(I())}):(a==null?void 0:a.length)===0?e.jsx(G,{message:c("source.error.label.no_sources_found")}):e.jsx(e.Fragment,{children:Object.entries(jt(a!=null?a:[])).sort((d,f)=>Ce(d[0],f[0])).map(([d,f])=>(d===z.OTHER||s.includes(d))&&e.jsxs(l.Fragment,{children:[e.jsx(m,{variant:"h5",component:"h2",sx:{paddingLeft:3,paddingTop:1,paddingBottom:2,fontWeight:"bold"},children:q(d)},d),f.filter(h=>{if(d===z.OTHER){const v=Number(h.id)===0;if(!(s.includes(d)||v))return!1}return u||!h.isNsfw}).map(h=>e.jsx(ft,{source:h,showSourceRepo:j},h.id))]},d))})}function vt(c){const{t}=N(),{extension:{name:s,lang:r,versionName:u,isInstalled:n,hasUpdate:x,isObsolete:o,pkgName:p,iconUrl:a,isNsfw:j,repo:L},handleUpdate:d,showSourceRepo:f,forcedState:h}=c,[U,v]=l.useState(P(n,o,x)),E=h!=null?h:U;l.useEffect(()=>{v(P(n,o,x))},[P(n,o,x)]);const D=r==="all"?t("extension.language.all"):r.toUpperCase(),A=async T=>{const B=et[T],O=tt[T];try{switch(v(O),T){case w.INSTALL:await S.updateExtension(p,{install:!0,isObsolete:o}).response;break;case w.UNINSTALL:await S.updateExtension(p,{uninstall:!0,isObsolete:o}).response;break;case w.UPDATE:await S.updateExtension(p,{update:!0,isObsolete:o}).response;break;default:throw new Error('Unexpected ExtensionAction "'.concat(T,'"'))}v(B),d()}catch(V){v(P(n,o,x)),_(t(Ie[T],{count:1}),"error")}};function b(){switch(E){case w.INSTALL:case w.UPDATE:case w.UNINSTALL:A(E).catch(I());break;case Ne.OBSOLETE:A(w.UNINSTALL).catch(I());break}}return e.jsx(te,{children:e.jsxs(ne,{sx:{display:"flex",alignItems:"center",gap:1,p:1.5,"&:last-child":{paddingBottom:1.5}},children:[e.jsx(ie,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",background:"transparent"},alt:s,children:e.jsx(se,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:s,src:S.getValidImgUrlFor(a)})}),e.jsxs(M,{sx:{display:"flex",flexDirection:"column",flexGrow:1,flexShrink:1,wordBreak:"break-word",justifyContent:"center"},children:[e.jsx(m,{variant:"h6",component:"h3",children:s}),e.jsxs(m,{variant:"caption",sx:{display:"block"},children:[D," ",u,j&&e.jsx(m,{variant:"caption",color:"error",sx:{display:"inline"},children:" 18+"})]}),f&&e.jsx(m,{variant:"caption",sx:{display:"block"},children:L})]}),e.jsx(R,{variant:"outlined",sx:{color:E===Je.OBSOLETE?"red":"inherit",flexShrink:0},onClick:()=>b(),children:t(Ze[E])})]})})}const be=0,ye=1;function Et({tabsMenuHeight:c}){var fe,me;const{t}=N(),{setAction:s}=l.useContext(oe),{data:r,loading:u,error:n,refetch:x}=S.useGetServerSettings({notifyOnNetworkStatusChange:!0}),o=!!(r!=null&&r.settings.extensionRepos.length),p=((fe=r==null?void 0:r.settings.extensionRepos.length)!=null?fe:0)>1,a=l.useRef(null),[j,L]=F("shownExtensionLangs",Ye()),[d]=F("showNsfw",!0),[f]=Te("query",we),[h,U]=l.useState({}),[v,{data:E,loading:D,error:A}]=S.useExtensionListFetch(),b=(me=E==null?void 0:E.fetchExtensions)==null?void 0:me.extensions,[T,B]=l.useState([]),O=l.useCallback(()=>U({}),[]);l.useEffect(()=>{v()},[h]);const V=l.useMemo(()=>(b!=null?b:[]).filter(i=>{const g=d||!i.isNsfw;return f?g&&i.name.toLowerCase().includes(f.toLowerCase()):g}),[b,d,f]),{allLangs:de,groupedExtensions:W}=l.useMemo(()=>nt(V),[V]),C=l.useMemo(()=>W.filter(i=>i[ye].length>0).filter(i=>st(i[be])||j.includes(i[be])),[j,W]),xe=l.useMemo(()=>C.map(i=>i[ye].length),[C]),K=l.useMemo(()=>C.map(([,i])=>i).flat(1),[C]),Re=at.useCreateGroupedComputeItemKey(xe,l.useCallback(i=>C[i][0],[C]),l.useCallback(i=>K[i].pkgName,[K])),he=i=>{i.name.toLowerCase().endsWith("apk")?(a.current&&(a.current.value=""),_(t("extension.label.installing_file"),"info"),S.installExternalExtension(i).response.then(()=>{O(),_(t("extension.label.installed_successfully"),"success")}).catch(()=>_(t("extension.label.installation_failed"),"error"))):_(t("global.error.label.invalid_file_type"),"error")};l.useLayoutEffect(()=>(s(e.jsxs(e.Fragment,{children:[e.jsx(Xe,{}),e.jsx($,{title:t("extension.action.label.install_external"),children:e.jsx(H,{onClick:()=>{var i;return(i=a.current)==null?void 0:i.click()},size:"large",color:"inherit",children:e.jsx(Fe,{})})}),e.jsx(_e,{shownLangs:j,setShownLangs:L,allLangs:de})]})),()=>{s(null)}),[t,j,de]),l.useEffect(()=>{const i=async y=>{y.preventDefault();const X=await ot(y);he(X[0])},g=y=>{y.preventDefault()};return document.addEventListener("drop",i),document.addEventListener("dragover",g),()=>{document.removeEventListener("drop",i),document.removeEventListener("dragover",g)}},[]);const pe=l.useMemo(()=>e.jsx("input",{type:"file",style:{display:"none"},ref:a,onChange:i=>{var y;const g=(y=i.target.files)==null?void 0:y[0];g&&he(g)}}),[]),Ue=u||D,ge=n!=null?n:A;return Ue?e.jsx(ae,{}):ge?e.jsx(G,{message:t("global.error.label.failed_to_load_data"),messageExtra:ge.message,retry:()=>{n&&x().catch(I()),A&&v().catch(I())}}):!(b!=null&&b.length)&&!o?e.jsxs(e.Fragment,{children:[pe,e.jsxs(re,{sx:{alignItems:"center",justifyContent:"center",rowGap:"10px",paddingTop:"20px"},children:[e.jsx(m,{children:t("extension.label.add_repository_info")}),e.jsx(R,{component:k,variant:"contained",to:"/settings/browseSettings",children:t("settings.title")})]})]}):e.jsxs(e.Fragment,{children:[pe,e.jsx(it,{heightToSubtract:c,overscan:window.innerHeight*.5,groupCounts:xe,groupContent:i=>{const[g,y]=C[i],X=g===rt.UPDATE_PENDING;return e.jsxs(lt,{isFirstItem:i===0,sx:{flexDirection:"row",justifyContent:"space-between",alignItems:"center",pr:1},children:[e.jsx(m,{variant:"h5",component:"h2",children:q(g)}),X&&e.jsx(R,{disabled:!!T.length,variant:"contained",onClick:()=>{const je=y.map(De=>De.pkgName);B(je),S.updateExtensions(je,{update:!0}).response.then(()=>O()).catch(()=>_(t(Ie[w.UPDATE],{count:W.length}))).finally(()=>B([]))},children:t("extension.action.label.update_all")})]},g)},computeItemKey:Re,itemContent:i=>{const g=K[i];return e.jsx(Ae,{children:e.jsx(vt,{extension:g,handleUpdate:O,showSourceRepo:p,forcedState:T.includes(g.pkgName)?Ne.UPDATING:void 0})})}})]})}var ce={},bt=ee;Object.defineProperty(ce,"__esModule",{value:!0});var ke=ce.default=void 0,yt=bt(Z()),Lt=e;ke=ce.default=(0,yt.default)((0,Lt.jsx)("path",{d:"M14.94 4.66h-4.72l2.36-2.36zm-4.69 14.71h4.66l-2.33 2.33zM6.1 6.27 1.6 17.73h1.84l.92-2.45h5.11l.92 2.45h1.84L7.74 6.27zm-1.13 7.37 1.94-5.18 1.94 5.18zm10.76 2.5h6.12v1.59h-8.53v-1.29l5.92-8.56h-5.88v-1.6h8.3v1.26z"}),"SortByAlpha");var ue={},Tt=ee;Object.defineProperty(ue,"__esModule",{value:!0});var Me=ue.default=void 0,wt=Tt(Z()),Ct=e;Me=ue.default=(0,wt.default)((0,Ct.jsx)("path",{d:"M20 10V8h-4V4h-2v4h-4V4H8v4H4v2h4v4H4v2h4v4h2v-4h4v4h2v-4h4v-2h-4v-4zm-6 4h-4v-4h4z"}),"Tag");const _t=({id:c,name:t,lang:s,iconUrl:r,mangaCount:u})=>{const{t:n}=N(),o=Number(c)===0?n("source.local_source.title"):t;return e.jsx(te,{children:e.jsx(Le,{component:k,to:"/migrate/source/".concat(c,"/"),children:e.jsxs(ne,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",p:1.5},children:[e.jsxs(M,{sx:{display:"flex"},children:[e.jsx(ie,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",mr:1,background:"transparent"},children:e.jsx(se,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:o,src:S.getValidImgUrlFor(r)})}),e.jsxs(M,{sx:{display:"flex",flexDirection:"column",justifyContent:"center"},children:[e.jsx(m,{variant:"h6",component:"h3",children:o}),e.jsx(m,{variant:"caption",sx:{display:"block"},children:q(s)})]})]}),e.jsx(xt,{sx:{borderRadius:1},size:"small",label:u})]})})})},Nt=(c,{sortBy:t,sortOrder:s})=>{if(!c)return[];const r={};c.forEach(({sourceId:n,source:x})=>{var p;const o=(p=r[n])!=null?p:{id:n,name:n,lang:"unknown",iconUrl:null,mangaCount:0,...x};r[n]={...o,mangaCount:o.mangaCount+1}});const u=Object.values(r).toSorted((n,x)=>{switch(t){case Se.SOURCE_NAME:return n.name.localeCompare(x.name);case Se.MANGA_COUNT:return n.mangaCount-x.mangaCount;default:throw new Error('Unexpected "sortBy" "'.concat(t,'"'))}});switch(s){case ve.ASC:return u;case ve.DESC:return u.toReversed();default:throw new Error('Unexpected "sortOrder" "'.concat(s,'"'))}},It=({tabsMenuHeight:c})=>{const{t}=N(),{appBarHeight:s}=$e(),{settings:{migrateSortSettings:r}}=He(),u=Ve(()=>_(t("global.error.label.failed_to_save_changes"),"error")),{sortBy:n,sortOrder:x}=r,{data:o,loading:p,error:a,refetch:j}=S.useGetMigratableSources({notifyOnNetworkStatusChange:!0}),L=l.useMemo(()=>Nt(o==null?void 0:o.mangas.nodes,r),[o==null?void 0:o.mangas.nodes,r]);return p?e.jsx(ae,{}):a?e.jsx(G,{message:t("global.error.label.failed_to_load_data"),messageExtra:a.message,retry:()=>j().catch(I())}):e.jsxs(e.Fragment,{children:[e.jsxs(re,{sx:{position:"sticky",top:"".concat(s+c,"px"),flexDirection:"row",justifyContent:"end",alignItems:"center",gap:1,p:1,backgroundColor:"background.default",zIndex:1},children:[e.jsx($,{title:t(Ge[n]),children:e.jsx(H,{size:"large",color:"inherit",onClick:()=>u("migrateSortSettings",{sortBy:(n+1)%2,sortOrder:x}),children:n?e.jsx(Me,{}):e.jsx(ke,{})})}),e.jsx($,{title:t(ze[x]),children:e.jsx(H,{size:"large",color:"inherit",onClick:()=>u("migrateSortSettings",{sortBy:n,sortOrder:(x+1)%2}),children:x?e.jsx(ut,{}):e.jsx(dt,{})})})]}),e.jsx(qe,{sx:{p:0},children:L.map(d=>e.jsx(Ae,{children:e.jsx(_t,{...d})},d.id))})]})};function un(){const{t:c}=N(),{setTitle:t}=l.useContext(oe);l.useLayoutEffect(()=>{t(c("global.label.browse"))},[c]);const s=l.useRef(null),[r,u]=l.useState(0);We(s,l.useCallback(()=>u(s.current.offsetHeight),[s.current]));const[n,x]=Te("tab",we,{}),o=n!=null?n:"source";return n||x(o,"replaceIn"),e.jsxs(ct,{children:[e.jsxs(Ke,{ref:s,variant:"fullWidth",value:o,onChange:(p,a)=>x(a,"replaceIn"),children:[e.jsx(Q,{value:"source",sx:{textTransform:"none"},label:c("source.title_one")}),e.jsx(Q,{value:"extensions",sx:{textTransform:"none"},label:c("extension.title_other")}),e.jsx(Q,{value:"migrate",sx:{textTransform:"none"},label:c("migrate.title")})]}),e.jsx(Y,{index:"source",currentIndex:o,children:e.jsx(St,{})}),e.jsx(Y,{index:"extensions",currentIndex:o,children:e.jsx(Et,{tabsMenuHeight:r})}),e.jsx(Y,{index:"migrate",currentIndex:o,children:e.jsx(It,{tabsMenuHeight:r})})]})}export{un as Browse};
