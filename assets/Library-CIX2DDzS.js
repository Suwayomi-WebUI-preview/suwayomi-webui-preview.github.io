import{u as R,r as N,O as Se,P as ge,q as G,j as t,Q as I,U as je,W as ke,X as v,Y as M,Z as E,_ as _e,y as Te,o as ne,m as ie,h as b,$ as pe,k as be,I as Me,a0 as Fe,a1 as W,a2 as Ae,a3 as Le,a4 as Ie,a5 as we,n as P,a6 as Be,a7 as Re,f as Oe,E as ce,l as ve,D as Ee,F as De,G as Ne}from"./index-pZOsleFD.js";import{u as me,S as Ge,A as Ue,N as Pe}from"./AppbarSearch-BD7nnss8.js";import{F as ze}from"./FilterList-vST5xFYN.js";import{S as We,R as z}from"./SortRadioInput-BGOswPAJ.js";import{T as _}from"./ThreeStateCheckboxInput-CNXDrHdC.js";import{O as Ye,S as Ke,a as He}from"./SelectionFAB-BwlS4uMi.js";import{T as Ve}from"./Trackers-D4pSmk7a.js";import{R as Qe}from"./ListPreference-yNyiYJii.js";import{M as Xe,a as Ze}from"./MangaGrid-CFQEq3vS.js";import{C as $e,U as Je}from"./UpdateChecker-DokywBOL.js";import{u as qe}from"./useManageMangaLibraryState-jpLyKW-O.js";import{T as ea}from"./TabsWrapper-DZjlQLPY.js";import{C as aa}from"./Chip-C-PGrBJx.js";import"./StyledFab-81mxjccY.js";import"./Sync-Bos9Jt6C.js";import"./Avatar-y5t_AR_o.js";import"./PlayArrow-BI6DCOBx.js";import"./Progress-BL3j1uWP.js";import"./Info-BTR5oOZn.js";import"./CheckCircle-Bjg5jWGY.js";import"./NumberSetting-Cy1v4OOU.js";import"./useMobilePicker-BvHiv8NU.js";import"./SelectSetting-BTVtB3UZ.js";const ta={filter:"global.label.filter",sort:"global.label.sort",display:"global.label.display"},sa=[["unreadChapters","library.option.sort.label.by_unread_chapters"],["totalChapters","library.option.sort.label.by_total_chapters"],["alphabetically","library.option.sort.label.alphabetically"],["dateAdded","library.option.sort.label.by_date_added"],["lastRead","library.option.sort.label.by_last_read"],["latestFetchedChapter","library.option.sort.label.by_latest_fetched_chapter"],["latestUploadedChapter","library.option.sort.label.by_latest_uploaded_chapter"]],ra=({category:e,open:s,onClose:n})=>{var x,u;const{t:a}=R(),l=N.useGetTrackerList(Se),o=Ve.getLoggedIn((u=(x=l.data)==null?void 0:x.trackers.nodes)!=null?u:[]),r=ge(e),i=_e(e,g=>ne(a("global.error.label.failed_to_save_changes"),"error",ie(g))),{settings:{showTabSize:p,showContinueReadingButton:f,showDownloadBadge:F,showUnreadBadge:y,gridLayout:m}}=G(),h=Te(g=>ne(a("search.error.label.failed_to_save_settings"),"error",ie(g)));return t.jsx(Ye,{open:s,onClose:n,tabs:["filter","sort","display"],tabTitle:g=>a(ta[g]),tabContent:g=>g==="filter"?t.jsxs(t.Fragment,{children:[t.jsx(_,{label:a("global.filter.label.unread"),checked:r.hasUnreadChapters,onChange:d=>i("hasUnreadChapters",d)}),t.jsx(_,{label:a("global.filter.label.started"),checked:r.hasReadChapters,onChange:d=>i("hasReadChapters",d)}),t.jsx(_,{label:a("global.filter.label.downloaded"),checked:r.hasDownloadedChapters,onChange:d=>i("hasDownloadedChapters",d)}),t.jsx(_,{label:a("global.filter.label.bookmarked"),checked:r.hasBookmarkedChapters,onChange:d=>i("hasBookmarkedChapters",d)}),t.jsx(_,{label:a("global.filter.label.duplicate_chapters"),checked:r.hasDuplicateChapters,onChange:d=>i("hasDuplicateChapters",d)}),t.jsx(I,{sx:{mt:2},children:a("manga.label.status")}),Object.values(je).map(d=>t.jsx(_,{label:a(ke[d]),checked:r.hasStatus[d],onChange:S=>i("hasStatus",{...r.hasStatus,[d]:S})},d)),t.jsx(I,{sx:{mt:2},children:a("global.filter.label.tracked")}),o.map(d=>t.jsx(_,{label:d.name,checked:r.hasTrackerBinding[d.id],onChange:S=>i("hasTrackerBinding",{...r.hasTrackerBinding,[d.id]:S})},d.id))]}):g==="sort"?sa.map(([d,S])=>t.jsx(We,{label:a(S),checked:r.sortBy===d,sortDescending:r.sortDesc,onClick:()=>d!==r.sortBy?i("sortBy",d):i("sortDesc",!r.sortDesc)},d)):g==="display"?t.jsxs(t.Fragment,{children:[t.jsx(I,{children:a("global.grid_layout.title")}),t.jsxs(Qe,{onChange:d=>v("gridLayout",Number(d.target.value)),value:m,children:[t.jsx(z,{label:a("global.grid_layout.label.compact_grid"),value:M.Compact,checked:m==null||m===M.Compact}),t.jsx(z,{label:a("global.grid_layout.label.comfortable_grid"),value:M.Comfortable,checked:m===M.Comfortable}),t.jsx(z,{label:a("global.grid_layout.label.list"),value:M.List,checked:m===M.List})]}),t.jsx(I,{sx:{mt:2},children:a("library.option.display.badge.title")}),t.jsx(E,{label:a("library.option.display.badge.label.unread_badges"),checked:y,onChange:()=>v("showUnreadBadge",!y)}),t.jsx(E,{label:a("library.option.display.badge.label.download_badges"),checked:F,onChange:()=>v("showDownloadBadge",!F)}),t.jsx(I,{sx:{mt:2},children:a("library.option.display.tab.title")}),t.jsx(E,{label:a("library.option.display.tab.label.show_number_of_items"),checked:p,onChange:()=>h("showTabSize",!p)}),t.jsx(I,{sx:{mt:2},children:a("global.label.other")}),t.jsx(E,{label:a("library.option.display.other.label.show_continue_reading_button"),checked:f,onChange:()=>v("showContinueReadingButton",!f)})]}):null})},la=({category:e})=>{const{t:s}=R(),[n,a]=b.useState(!1),{options:l}=pe(),o=l.hasDownloadedChapters!=null||l.hasUnreadChapters!=null||l.hasReadChapters!=null||l.hasBookmarkedChapters!=null||l.hasDuplicateChapters!=null||Object.values(l.hasStatus).some(r=>r!=null)||Object.values(l.hasTrackerBinding).some(r=>r!=null);return t.jsxs(t.Fragment,{children:[t.jsx(be,{title:s("settings.title"),children:t.jsx(Me,{onClick:()=>a(!n),color:o?"warning":"inherit",children:t.jsx(ze,{})})}),t.jsx(ra,{category:e,open:n,onClose:()=>a(!1)})]})},oa=()=>{},de=({showFilteredOutMessage:e,message:s,messageExtra:n,...a})=>{const{t:l}=R(),{settings:{gridLayout:o}}=G();return b.useLayoutEffect(()=>(document.body.style.overflowY=o===M.List?"auto":"scroll",()=>{document.body.style.overflowY="auto"}),[]),t.jsx(Xe,{gridWrapperProps:{sx:{p:1}},...a,hasNextPage:!1,loadMore:oa,message:e?l("library.error.label.no_matches"):s,messageExtra:e?void 0:n,gridLayout:o})},na=({isActive:e,areAllItemsSelected:s,areNoItemsSelected:n,onSelectAll:a,onModeChange:l})=>{const{t:o}=R();return t.jsxs(t.Fragment,{children:[e&&t.jsx(Ke,{areAllItemsSelected:s,areNoItemsSelected:n,onChange:a}),t.jsx(be,{title:o(e?"global.button.cancel":"global.button.select_all"),children:t.jsx(Fe,{checkedIcon:t.jsx($e,{}),sx:{padding:"8px",color:"inherit","&.Mui-checked":{color:"inherit"}},checked:e,onChange:(r,i)=>l(i)})})]})},Y=(e,s,n)=>{switch(e){case!0:return s();case!1:return n();default:return!0}},D=(e,s)=>Y(e,()=>!!s&&s>=1,()=>s===0),Ce=(e,s)=>Y(e,()=>!!s,()=>!s),T=(e,s)=>{const n=e==null?void 0:e.filter(r=>r!=null),a=s==null?void 0:s.filter(r=>r!=null);if(!(n!=null&&n.length))return!0;const l=n.map(W),o=a.map(W).join(", ");return l.every(r=>o.includes(r))},ia=(e,{title:s,genre:n,description:a,artist:l,author:o,source:r,sourceId:i})=>T([e],[s])||T(e==null?void 0:e.split(","),n.map(p=>W(p)))||T([e],[a])||T([e],[l])||T([e],[o])||T([e],[r==null?void 0:r.displayName])||T([e],[i]),ca=(e,s)=>Object.entries(e).map(([n,a])=>{const l=s.trackRecords.nodes.some(o=>o.trackerId===Number(n));return Y(a,()=>l,()=>!l)}).every(Boolean),da=(e,s)=>Object.entries(e).map(([n,a])=>Ce(a,n===s.status)).every(Boolean),ha=(e,{hasDownloadedChapters:s,hasUnreadChapters:n,hasReadChapters:a,hasBookmarkedChapters:l,hasDuplicateChapters:o,hasTrackerBinding:r,hasStatus:i})=>D(s,e.downloadCount)&&D(n,e.unreadCount)&&D(a,e.chapters.totalCount-e.unreadCount)&&D(l,e.bookmarkCount)&&Ce(o,e.hasDuplicateChapters)&&ca(r,e)&&da(i,e),ua=(e,s,n)=>{const a=n.ignoreFilters&&(s==null?void 0:s.length);return e.filter(l=>{const o=ia(s,l),r=a||ha(l,n);return o&&r})},w=(e=0,s=0)=>Number(e)-Number(s),ga=(e,s)=>e.localeCompare(s),pa=(e,s,n)=>{const a=[...e];switch(s){case"alphabetically":a.sort((l,o)=>ga(l.title,o.title));break;case"dateAdded":a.sort((l,o)=>w(l.inLibraryAt,o.inLibraryAt));break;case"unreadChapters":a.sort((l,o)=>w(l.unreadCount,o.unreadCount));break;case"lastRead":a.sort((l,o)=>{var r,i;return w((r=l.lastReadChapter)==null?void 0:r.lastReadAt,(i=o.lastReadChapter)==null?void 0:i.lastReadAt)});break;case"latestUploadedChapter":a.sort((l,o)=>{var r,i;return w((r=l.latestUploadedChapter)==null?void 0:r.uploadDate,(i=o.latestUploadedChapter)==null?void 0:i.uploadDate)});break;case"latestFetchedChapter":a.sort((l,o)=>{var r,i;return w((r=l.latestFetchedChapter)==null?void 0:r.fetchedAt,(i=o.latestFetchedChapter)==null?void 0:i.fetchedAt)});break;case"totalChapters":a.sort((l,o)=>w(l.chapters.totalCount,o.chapters.totalCount));break}return n&&a.reverse(),a},ba={id:-1},ma=(e,s)=>{const[n]=me("query",Ge),a=ge(s!=null?s:ba),{hasUnreadChapters:l,hasReadChapters:o,hasDownloadedChapters:r,hasBookmarkedChapters:i,hasTrackerBinding:p,hasDuplicateChapters:f,hasStatus:F}=a,{settings:y}=G(),m=b.useMemo(()=>ua(e,n,{...a,ignoreFilters:y.ignoreFilters}),[e,n,l,o,r,i,p,f,F,y.ignoreFilters]),h=b.useMemo(()=>pa(m,a.sortBy,a.sortDesc),[m,a.sortBy,a.sortDesc]),x=Object.values(a.hasTrackerBinding).some(g=>g!=null),u=(l!=null||o!=null||r!=null||i!=null||!!n||x)&&m.length===0&&e.length>0;return{visibleMangas:h,showFilteredOutMessage:u}},he=Ae("span")({display:"flex",alignItems:"center"}),ue=({sx:e,...s})=>t.jsx(aa,{...s,size:"small",sx:{...e,marginLeft:"5px"}});function Ua(){var ae,te,se,re,le,oe;const{t:e}=R(),{settings:{showTabSize:s}}=G(),{data:n,error:a,loading:l,refetch:o}=N.useGetCategories(Le,{notifyOnNetworkStatusChange:!0}),r=n==null?void 0:n.categories.nodes.filter(c=>c.id!==0||c.id===0&&c.mangas.totalCount),i=r!=null?r:[],p=N.useGetMangas(Ie,{}),f=(te=(ae=p.data)==null?void 0:ae.mangas.totalCount)!=null?te:0,[F,y]=me("tab",Pe),{setOptions:m}=pe(),h=(se=i.find(c=>c.order===F))!=null?se:i[0];b.useLayoutEffect(()=>{m(we(h!=null?h:{id:-1}))},[h]);const{data:x,error:u,loading:g,refetch:d}=N.useGetCategoryMangas(h==null?void 0:h.id,{skip:!h,notifyOnNetworkStatusChange:!0}),S=(re=x==null?void 0:x.mangas.nodes)!=null?re:[],{visibleMangas:C,showFilteredOutMessage:K}=ma(S,h),H=b.useCallback(()=>d().catch(P()),[d,h]),xe=b.useMemo(()=>C.map(c=>c.id),[C]),[j,O]=b.useState(!1),{areNoItemsForKeySelected:V,areAllItemsForKeySelected:Q,selectedItemIds:A,handleSelectAll:U,handleSelection:X,clearSelection:fe}=qe(C.length,{itemIds:xe,currentKey:h==null?void 0:h.id.toString()}),Z=b.useCallback((c,k,L)=>{O(!!(A.length+(k?1:-1))),X(c,k,L)},[O,X]),$=b.useMemo(()=>A.map(c=>Be.getFromCache(c,Re,"MANGA_CHAPTER_STAT_FIELDS")).filter(c=>!!c),[A.length,C]),J=b.useMemo(()=>j?t.jsx(He,{selectedItemsCount:A.length,title:"manga.title",children:(c,k)=>t.jsx(Ze,{selectedMangas:$,onClose:()=>{c(),O(!1),fe()},setHideMenu:k})}):null,[j,$]),{setTitle:q,setAction:ee}=Oe();b.useLayoutEffect(()=>{const c=e("library.title");return q(t.jsxs(he,{children:[c,s&&t.jsx(ue,{sx:{color:"inherit"},label:f})]}),c),ee(t.jsxs(t.Fragment,{children:[!j&&h&&t.jsxs(t.Fragment,{children:[t.jsx(Ue,{}),t.jsx(la,{category:h}),t.jsx(Je,{categoryId:h==null?void 0:h.id})]}),t.jsx(na,{isActive:j,areAllItemsSelected:Q,areNoItemsSelected:V,onSelectAll:L=>U(L,[...new Set(C.map(B=>B.id))]),onModeChange:L=>{O(L),L?U(!0,[...new Set(C.map(B=>B.id))]):i.forEach(B=>U(!1,[],B.id.toString()))}})]})),()=>{q(""),ee(null)}},[e,f,l,j,V,Q,C.length,h,s]);const ye=c=>{y(c)};return a!=null||p.error?t.jsx(ce,{message:e("global.error.label.failed_to_load_data"),messageExtra:(oe=a==null?void 0:a.message)!=null?oe:(le=p.error)==null?void 0:le.message,retry:()=>{a&&o().catch(P()),p.error&&p.refetch().catch(P())}}):l||p.loading?t.jsx(ve,{}):i.length===0?t.jsx(ce,{message:e("library.error.label.empty")}):i.length===1?t.jsxs(t.Fragment,{children:[t.jsx(de,{mangas:C,message:e(u?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:u==null?void 0:u.message,isLoading:g,selectedMangaIds:A,isSelectModeActive:j,handleSelection:Z,showFilteredOutMessage:!u&&K,retry:u&&H}),J]}):t.jsxs(ea,{children:[t.jsx(Ee,{value:h.order,onChange:(c,k)=>ye(k),children:i.map(c=>t.jsx(De,{sx:{flexGrow:1,maxWidth:"unset"},label:t.jsxs(he,{children:[c.name,s?t.jsx(ue,{label:c.mangas.totalCount}):null]}),value:c.order},c.id))}),i.map(c=>t.jsx(Ne,{index:c.order,currentIndex:h.order,children:c===h&&t.jsx(de,{mangas:C,message:e(u?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:u==null?void 0:u.message,isLoading:g,selectedMangaIds:A,isSelectModeActive:j,handleSelection:Z,showFilteredOutMessage:!u&&K,retry:u&&H})},c.order)),J]})}export{Ua as Library};
