import{u as V,az as $,c as n,N as z,a as u,j as e,h as Q,T as k,bq as K,g as W,L as v,B as _,w as J,f as I,I as E,Q as X,br as Y,m as L}from"./index-DCLtpUvd.js";import{d as Z}from"./Download-DJF8ST8_.js";import{d as ee}from"./Refresh-BvluAULJ.js";import{E as M}from"./EmptyViewAbsoluteCentered-CW_zNQ4R.js";import{D as te}from"./DownloadStateIndicator-DYkbVZHR.js";import{U as ae}from"./UpdateChecker-Bq6vNQMO.js";import{V as oe,S as re,a as se,b as ne}from"./Virtuoso.util-C7XHtCc5.js";import{M as ie}from"./Mangas-Cxp4_B5b.js";import{S as le}from"./SpinnerImage-pue1bji5.js";import{T as G}from"./TypographyMaxLines-CDFbxbWf.js";import{C as de}from"./Card-C0ry1gLE.js";import{C as ce}from"./CardActionArea-BZXNbXAI.js";import{C as pe}from"./CardContent-DvoLRTUo.js";import{A as me}from"./Avatar-fZt4MSW-.js";import"./Progress-COQCUKnq.js";import"./index-CUtiZdHq.js";import"./Chapters-CHk8tH3E.js";const ue=o=>{if(!o.length)return[];const d=new Map;return o.forEach(h=>{var r;const c=X(Y(Number(h.fetchedAt)));d.set(c,((r=d.get(c))!=null?r:0)+1)}),[...d.entries()]},Me=()=>{var T,S;const{t:o}=V(),d=$(),{setTitle:h,setAction:c}=n.useContext(z),{data:r,loading:C,error:b,fetchMore:P,refetch:R}=u.useGetRecentlyUpdatedChapters(void 0,{fetchPolicy:"cache-and-network",notifyOnNetworkStatusChange:!0}),j=!!(r!=null&&r.chapters.pageInfo.hasNextPage),A=r==null?void 0:r.chapters.pageInfo.endCursor,i=(T=r==null?void 0:r.chapters.nodes)!=null?T:[],p=n.useMemo(()=>ue(i),[i]),w=n.useMemo(()=>p.map(t=>t[1]),[p]),{data:g}=u.useGetDownloadStatus(),D=(S=g==null?void 0:g.downloadStatus.queue)!=null?S:[],U=oe.useCreateGroupedComputeItemKey(w,n.useCallback(t=>p[t][0],[p]),n.useCallback(t=>i[t].id,[i])),f=n.useRef(null),[B,F]=n.useState(0);n.useLayoutEffect(()=>{var t,a;F((a=(t=f.current)==null?void 0:t.clientHeight)!=null?a:0)},[f.current]);const{data:x}=u.useGetLastGlobalUpdateTimestamp({fetchPolicy:"cache-only"}),y=x==null?void 0:x.lastUpdateTimestamp.timestamp;n.useLayoutEffect(()=>(h(o("updates.title")),c(e.jsx(ae,{})),()=>{h(""),c(null)}),[o,y]);const H=t=>{const{sourceOrder:a,mangaId:m}=t;return D.find(s=>a===s.chapter.sourceOrder&&m===s.manga.id)},N=async t=>{try{await u.addChapterToDownloadQueue(t.id).response}catch(a){L(o("download.queue.error.label.failed_to_remove"),"error")}},q=t=>{u.addChapterToDownloadQueue(t.id).response.catch(()=>L(o("global.error.label.failed_to_save_changes"),"error"))},O=n.useCallback(()=>{j&&P({variables:{offset:i.length}})},[j,A]);return b?e.jsx(M,{message:o("global.error.label.failed_to_load_data"),messageExtra:b.message,retry:()=>R().catch(Q())}):!C&&i.length===0?e.jsx(M,{message:o("updates.error.label.no_updates_available")}):e.jsxs(e.Fragment,{children:[e.jsx(k,{ref:f,sx:{marginLeft:"10px",paddingTop:t=>({[t.breakpoints.up("sm")]:{paddingTop:"6px"}})},children:o("library.settings.global_update.label.last_update",{date:y?K.format(+y):"-"})}),e.jsx(re,{heightToSubtract:B,style:{height:"undefined"},components:{Footer:()=>C?e.jsx(W,{usePadding:!0}):null},overscan:window.innerHeight*.5,endReached:O,groupCounts:w,groupContent:t=>e.jsx(se,{sx:{pt:t===0?void 0:0,pb:0},isFirstItem:t===0,children:e.jsx(k,{variant:"h5",component:"h2",children:p[t][0]})}),computeItemKey:U,itemContent:t=>{const a=i[t],{manga:m}=a,s=H(a);return e.jsx(ne,{children:e.jsx(de,{children:e.jsx(ce,{component:v,to:"/manga/".concat(a.manga.id,"/chapter/").concat(a.sourceOrder),state:d.state,sx:{color:l=>l.palette.text[a.isRead?"disabled":"primary"]},children:e.jsxs(pe,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:1.5},children:[e.jsxs(_,{sx:{display:"flex"},children:[e.jsx(v,{to:"/manga/".concat(a.manga.id),style:{textDecoration:"none"},children:e.jsx(me,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",marginRight:1,background:"transparent"},children:e.jsx(le,{imgStyle:{objectFit:"cover",width:"100%",height:"100%",imageRendering:"pixelated"},spinnerStyle:{small:!0},alt:m.title,src:ie.getThumbnailUrl(m)})})}),e.jsxs(_,{sx:{display:"flex",flexDirection:"column",justifyContent:"center",flexGrow:1,flexShrink:1,wordBreak:"break-word"},children:[e.jsx(G,{variant:"h6",component:"h3",children:m.title}),e.jsx(G,{variant:"caption",display:"block",lines:1,children:a.name})]})]}),s&&e.jsx(te,{download:s}),(s==null?void 0:s.state)===J.Error&&e.jsx(I,{title:o("global.button.retry"),children:e.jsx(E,{onClick:l=>{l.preventDefault(),l.stopPropagation(),N(s.chapter)},size:"large",children:e.jsx(ee,{})})}),s==null&&!a.isDownloaded&&e.jsx(I,{title:o("chapter.action.download.add.label.action"),children:e.jsx(E,{onClick:l=>{l.stopPropagation(),l.preventDefault(),q(a)},size:"large",children:e.jsx(Z,{})})})]})})})})}})]})};export{Me as Updates};
