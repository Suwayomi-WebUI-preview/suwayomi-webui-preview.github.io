import{u as P,g as D,x as I,h as O,s as Q,i as V,r as q,k as t,j as s,n as W,E as z,o as T,p as k,B as v,aR as J,C as K,a as U,A as X,L as Y,T as B,b1 as Z}from"./index-FX96rGzE.js";import{u as ee,A as se,S as re}from"./AppbarSearch-CvTdGwff.js";import{L as te,t as ae}from"./LanguageSelect-CLpsh2VP.js";import{u as _}from"./useDebounce-BSM2W4i3.js";import{B as oe}from"./BaseMangaGrid-BLWyfCNT.js";import{S as N}from"./Sources-wBHCBenc.js";import"./ChaptersDownloadActionMenuItems-Z9ODZZYD.js";import"./Trackers-D4pSmk7a.js";import"./Avatar-BAZliP1c.js";import"./CheckCircle-QwLDNfSw.js";import"./ListPreference-DKcRPY0h.js";import"./NumberSetting-CDzCgP1z.js";import"./useMobilePicker-Cv_9HfI3.js";import"./Chip-MOmFd805.js";import"./SelectSetting-Dulz7ePw.js";import"./FilterList-qHf6XsUZ.js";import"./MangaGrid-B-yKksxd.js";import"./Sync-0XJKHOyf.js";import"./PlayArrow-ClZyigNT.js";import"./StyledFab-DB55LD-B.js";const ne=(r,n)=>r.displayName.localeCompare(n.displayName),ce=(r,n,e)=>{var m,f,a,g;const h=!((m=e.get(r.id))!=null&&m.isLoading),c=!((f=e.get(n.id))!=null&&f.isLoading);if(h&&!c)return-1;if(!h&&c)return 1;if(!h&&!c)return 0;const u=!((a=e.get(r.id))!=null&&a.hasResults),l=!((g=e.get(n.id))!=null&&g.hasResults);return u&&!l?1:l&&!u?-1:0},ie=1e3,ue=J.memo(({source:r,onSearchRequestFinished:n,searchString:e,emptyQuery:h,mode:c})=>{var R,j;const{t:u}=P(),{id:l,displayName:m,lang:f}=r,a=t.useRef(e),g=t.useRef(()=>{});a.current!==e&&(a.current=e,g.current(new Error("SourceSearchPreview(".concat(l,", ").concat(m,"): search string changed"))));const[d,M]=q.useSourceSearch(l,e!=null?e:"",void 0,1,{skipRequest:!e,addAbortSignal:!0}),{data:x,isLoading:S,error:o,abortRequest:E}=M[0];g.current=E;const L=(j=(R=x==null?void 0:x.fetchSourceManga)==null?void 0:R.mangas)!=null?j:[],y=!o&&!S&&!L.length;t.useEffect(()=>{n(r,S,!y,!e)},[S,y,e]);let p;return o?p=u("search.error.label.source_search_failed"):y&&(p=u("manga.error.label.no_mangas_found")),!S&&!e||h?null:s.jsxs(s.Fragment,{children:[s.jsx(K,{sx:{mb:1},children:s.jsxs(U,{component:Y,to:"".concat(X.sources.childRoutes.browse.path(l),"?query=").concat(e),sx:{p:3},children:[s.jsx(B,{variant:"h5",children:m}),s.jsx(B,{variant:"caption",children:ae(f)})]})}),p?s.jsx(Z,{sx:{alignItems:"start",height:void 0},noFaces:!0,message:p,messageExtra:T(o),retry:o?()=>d(1).catch(k("SourceSearchPreview(".concat(r.id,")::refetch"))):void 0}):s.jsx(oe,{gridWrapperProps:{sx:{px:0}},mangas:L,isLoading:S,hasNextPage:!1,loadMore:()=>{},horizontal:!0,noFaces:!0,message:p,inLibraryIndicator:!0,mode:c})]})}),Be=()=>{const{t:r}=P(),{setTitle:n,setAction:e}=D(),{pathname:h,state:c}=I(),u=h.startsWith("/migrate/source"),l=c==null?void 0:c.mangaTitle,[m]=ee("query",re),f=_(m,ie),[a,g]=O("shownSourceLangs",Q()),{settings:{showNsfw:w}}=V(),{data:d,loading:M,error:x,refetch:S}=q.useGetSourceList({notifyOnNetworkStatusChange:!0}),o=t.useMemo(()=>{var i;return(i=d==null?void 0:d.sources.nodes)!=null?i:[]},[d==null?void 0:d.sources.nodes]),E=t.useMemo(()=>N.filter(o,{showNsfw:w,languages:a,keepLocalSource:!0}),[o,a]),L=t.useMemo(()=>[...E].toSorted(ne),[E]),[y,p]=t.useState(new Map),R=_(y,500),j=t.useMemo(()=>N.getLanguages(o),[o]),A=t.useMemo(()=>[...L].sort((i,b)=>ce(i,b,R)),[L,R]),F=t.useCallback(({id:i},b,$,G)=>{p(H=>{const C=new Map(H);return C.set(i,{isLoading:b,hasResults:$,emptySearch:G}),C})},[p]);return t.useLayoutEffect(()=>(n(r(u?"migrate.search.title":"search.title.global_search",{title:l})),e(s.jsxs(s.Fragment,{children:[s.jsx(se,{isClosable:!1}),s.jsx(te,{selectedLanguages:a,setSelectedLanguages:g,languages:j})]})),()=>{n(""),e(null)}),[r,a,g,o]),M?s.jsx(W,{}):x?s.jsx(z,{message:r("global.error.label.failed_to_load_data"),messageExtra:T(x),retry:()=>S().catch(k())}):s.jsx(v,{sx:{p:1},children:A.map((i,b)=>s.jsx(v,{sx:{pb:b+1!==A.length?2:0},children:s.jsx(ue,{source:i,onSearchRequestFinished:F,searchString:f,emptyQuery:!m,mode:u?"migrate.select":"source"})},i.id))})};export{Be as SearchAll};
