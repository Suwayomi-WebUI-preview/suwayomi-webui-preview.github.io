import{u as B,a as N,G as ge,c as u,o as G,p as P,j as t,q as me,s as j,t as be,v as Ce,m as te,w as z,f as ne,I as fe,x as xe,y as ye,h as ae,z as Se,N as je,E as re,g as ke}from"./index-CcCQevVR.js";import{u as ie,S as _e,A as Te,N as Me}from"./AppbarSearch-D7gDCYWr.js";import{T as Fe,a as we}from"./Tabs-DBHcilIZ.js";import{d as Le}from"./FilterList-BC87Z4iI.js";import{C as I}from"./CheckboxInput-CNl7YvaR.js";import{S as Ae,R}from"./SortRadioInput-BwWO_3uw.js";import{T as _}from"./ThreeStateCheckboxInput-BmQaFU8x.js";import{O as Be,S as Ie,a as ve}from"./SelectionFAB-Bxe8xxXS.js";import{T as Oe}from"./Trackers-D4pSmk7a.js";import{s as Ee,M as Re}from"./Mangas-wfnNHRMu.js";import{F as T}from"./TextField-DlsyrlB4.js";import{R as De}from"./ListPreference-CCb4APVb.js";import{M as Ne,a as Ue}from"./MangaGrid-ClMRK0R1.js";import{d as Ge,U as Pe}from"./UpdateChecker-_rMMYGKH.js";import{u as ze}from"./useManageMangaLibraryState-C5vILkCH.js";import{C as Ke}from"./Checkbox-DtM-KzVx.js";import{e as U}from"./Strings-CWt9sr6N.js";import{T as We,a as He}from"./TabsMenu-CiUlFNZc.js";import{C as Ve}from"./Chip-CUbj1W1O.js";import"./StyledFab-BH96DFxM.js";import"./Chapters-DdxNJrI9.js";import"./SwitchBase-BQJu54st.js";import"./index-CNhL_dkv.js";import"./Delete-CXLsKRjh.js";import"./Sync-ciHWfXmx.js";import"./SpinnerImage-Bxy4Mp8Z.js";import"./TypographyMaxLines-CCTwEuv5.js";import"./Link-fNnv42xw.js";import"./Card-CTCbNoj-.js";import"./CardActionArea-BO43c0rN.js";import"./CardContent-D-dG0MuI.js";import"./Avatar-xts1Wbj1.js";import"./PlayArrow-CybGthf7.js";import"./Progress-BKc9XaLp.js";import"./Info-CkxmG1sK.js";import"./InputAdornment-BLbDYZqi.js";import"./CheckCircle-BmyebNpo.js";import"./Collapse-C4h6KI5S.js";import"./NumberSetting-CON6kMdW.js";import"./useMobilePicker-wPl_pciy.js";import"./SelectSetting-VO8p7lUZ.js";import"./Select-BKCPXu5E.js";const Ye={filter:"global.label.filter",sort:"global.label.sort",display:"global.label.display"},Qe=[["unreadChapters","library.option.sort.label.by_unread_chapters"],["totalChapters","library.option.sort.label.by_total_chapters"],["alphabetically","library.option.sort.label.alphabetically"],["dateAdded","library.option.sort.label.by_date_added"],["lastRead","library.option.sort.label.by_last_read"],["latestFetchedChapter","library.option.sort.label.by_latest_fetched_chapter"],["latestUploadedChapter","library.option.sort.label.by_latest_uploaded_chapter"]],$e=({category:e,open:s,onClose:i})=>{var f,b;const{t:a}=B(),o=N.useGetTrackerList(ge),n=Oe.getLoggedIn((b=(f=o.data)==null?void 0:f.trackers.nodes)!=null?b:[]),r=u.useMemo(()=>G(e),[e]),l=be(e,()=>te(a("global.error.label.failed_to_save_changes","error"))),{settings:{showTabSize:C}}=P(),w=Ce(()=>te(a("search.error.label.failed_to_save_settings"),"warning"));return t.jsx(Be,{open:s,onClose:i,tabs:["filter","sort","display"],tabTitle:h=>a(Ye[h]),tabContent:h=>{if(h==="filter")return t.jsxs(t.Fragment,{children:[t.jsx(_,{label:a("global.filter.label.unread"),checked:r.hasUnreadChapters,onChange:c=>l("hasUnreadChapters",c)}),t.jsx(_,{label:a("global.filter.label.downloaded"),checked:r.hasDownloadedChapters,onChange:c=>l("hasDownloadedChapters",c)}),t.jsx(_,{label:a("global.filter.label.bookmarked"),checked:r.hasBookmarkedChapters,onChange:c=>l("hasBookmarkedChapters",c)}),t.jsx(_,{label:a("global.filter.label.duplicate_chapters"),checked:r.hasDuplicateChapters,onChange:c=>l("hasDuplicateChapters",c)}),t.jsx(T,{sx:{mt:2},children:a("manga.label.status")}),Object.values(me).map(c=>t.jsx(_,{label:a(Ee[c]),checked:r.hasStatus[c],onChange:p=>l("hasStatus",{...r.hasStatus,[c]:p})},c)),t.jsx(T,{sx:{mt:2},children:a("global.filter.label.tracked")}),n.map(c=>t.jsx(_,{label:c.name,checked:r.hasTrackerBinding[c.id],onChange:p=>l("hasTrackerBinding",{...r.hasTrackerBinding,[c.id]:p})},c.id))]});if(h==="sort")return Qe.map(([c,p])=>t.jsx(Ae,{label:a(p),checked:r.sortBy===c,sortDescending:r.sortDesc,onClick:()=>c!==r.sortBy?l("sortBy",c):l("sortDesc",!r.sortDesc)},c));if(h==="display"){const{gridLayout:c,showContinueReadingButton:p,showDownloadBadge:x,showUnreadBadge:L}=r;return t.jsxs(t.Fragment,{children:[t.jsx(T,{children:a("global.grid_layout.title")}),t.jsxs(De,{onChange:v=>l("gridLayout",Number(v.target.value)),value:c,children:[t.jsx(R,{label:a("global.grid_layout.label.compact_grid"),value:j.Compact,checked:c==null||c===j.Compact}),t.jsx(R,{label:a("global.grid_layout.label.comfortable_grid"),value:j.Comfortable,checked:c===j.Comfortable}),t.jsx(R,{label:a("global.grid_layout.label.list"),value:j.List,checked:c===j.List})]}),t.jsx(T,{sx:{mt:2},children:a("library.option.display.badge.title")}),t.jsx(I,{label:a("library.option.display.badge.label.unread_badges"),checked:L,onChange:()=>l("showUnreadBadge",!L)}),t.jsx(I,{label:a("library.option.display.badge.label.download_badges"),checked:x,onChange:()=>l("showDownloadBadge",!x)}),t.jsx(T,{sx:{mt:2},children:a("library.option.display.tab.title")}),t.jsx(I,{label:a("library.option.display.tab.label.show_number_of_items"),checked:C,onChange:()=>w("showTabSize",!C)}),t.jsx(T,{sx:{mt:2},children:a("global.label.other")}),t.jsx(I,{label:a("library.option.display.other.label.show_continue_reading_button"),checked:p,onChange:()=>l("showContinueReadingButton",!p)})]})}return null}})},Je=({category:e})=>{const{t:s}=B(),[i,a]=u.useState(!1),{options:o}=z(),n=o.hasDownloadedChapters!=null||o.hasUnreadChapters!=null||o.hasBookmarkedChapters!=null||o.hasDuplicateChapters!=null||Object.values(o.hasStatus).some(r=>r!=null)||Object.values(o.hasTrackerBinding).some(r=>r!=null);return t.jsxs(t.Fragment,{children:[t.jsx(ne,{title:s("settings.title"),children:t.jsx(fe,{onClick:()=>a(!i),color:n?"warning":"inherit",children:t.jsx(Le,{})})}),t.jsx($e,{category:e,open:i,onClose:()=>a(!1)})]})},se=({showFilteredOutMessage:e,message:s,messageExtra:i,...a})=>{const{t:o}=B(),{options:n}=z();return u.useLayoutEffect(()=>(document.body.style.overflowY=n.gridLayout===j.List?"auto":"scroll",()=>{document.body.style.overflowY="auto"}),[]),t.jsx(Ne,{gridWrapperProps:{sx:{p:1}},...a,hasNextPage:!1,loadMore:()=>{},message:e?o("library.error.label.no_matches"):s,messageExtra:e?void 0:i,gridLayout:n.gridLayout})},Xe=({isActive:e,areAllItemsSelected:s,areNoItemsSelected:i,onSelectAll:a,onModeChange:o})=>{const{t:n}=B();return t.jsxs(t.Fragment,{children:[e&&t.jsx(Ie,{areAllItemsSelected:s,areNoItemsSelected:i,onChange:a}),t.jsx(ne,{title:n(e?"global.button.cancel":"global.button.select_all"),children:t.jsx(Ke,{checkedIcon:t.jsx(Ge,{}),sx:{padding:"8px",color:"inherit","&.Mui-checked":{color:"inherit"}},checked:e,onChange:(r,l)=>o(l)})})]})},K=(e,s,i)=>{switch(e){case!0:return s();case!1:return i();default:return!0}},D=(e,s)=>K(e,()=>!!s&&s>=1,()=>s===0),ce=(e,s)=>K(e,()=>!!s,()=>!s),M=(e,s)=>{const i=e==null?void 0:e.filter(r=>r!=null),a=s==null?void 0:s.filter(r=>r!=null);if(!(i!=null&&i.length))return!0;const o=i.map(U),n=a.map(U).join(", ");return o.every(r=>n.includes(r))},Ze=(e,{title:s,genre:i,description:a,artist:o,author:n,source:r})=>M([e],[s])||M(e==null?void 0:e.split(","),i.map(l=>U(l)))||M([e],[a])||M([e],[o])||M([e],[n])||M([e],[r==null?void 0:r.displayName]),qe=(e,s)=>Object.entries(e).map(([i,a])=>{const o=s.trackRecords.nodes.some(n=>n.trackerId===Number(i));return K(a,()=>o,()=>!o)}).every(Boolean),et=(e,s)=>Object.entries(e).map(([i,a])=>ce(a,i===s.status)).every(Boolean),tt=(e,{hasDownloadedChapters:s,hasUnreadChapters:i,hasBookmarkedChapters:a,hasDuplicateChapters:o,hasTrackerBinding:n,hasStatus:r})=>D(s,e.downloadCount)&&D(i,e.unreadCount)&&D(a,e.bookmarkCount)&&ce(o,e.hasDuplicateChapters)&&qe(n,e)&&et(r,e),at=(e,s,i)=>{const a=i.ignoreFilters&&(s==null?void 0:s.length);return e.filter(o=>{const n=Ze(s,o),r=a||tt(o,i);return n&&r})},F=(e=0,s=0)=>Number(e)-Number(s),rt=(e,s)=>e.localeCompare(s),st=(e,s,i)=>{const a=[...e];switch(s){case"alphabetically":a.sort((o,n)=>rt(o.title,n.title));break;case"dateAdded":a.sort((o,n)=>F(o.inLibraryAt,n.inLibraryAt));break;case"unreadChapters":a.sort((o,n)=>F(o.unreadCount,n.unreadCount));break;case"lastRead":a.sort((o,n)=>{var r,l;return F((r=o.lastReadChapter)==null?void 0:r.lastReadAt,(l=n.lastReadChapter)==null?void 0:l.lastReadAt)});break;case"latestUploadedChapter":a.sort((o,n)=>{var r,l;return F((r=o.latestUploadedChapter)==null?void 0:r.uploadDate,(l=n.latestUploadedChapter)==null?void 0:l.uploadDate)});break;case"latestFetchedChapter":a.sort((o,n)=>{var r,l;return F((r=o.latestFetchedChapter)==null?void 0:r.fetchedAt,(l=n.latestFetchedChapter)==null?void 0:l.fetchedAt)});break;case"totalChapters":a.sort((o,n)=>F(o.chapters.totalCount,n.chapters.totalCount));break}return i&&a.reverse(),a},ot=(e,s)=>{const[i]=ie("query",_e),a=G(s),{hasUnreadChapters:o,hasDownloadedChapters:n,hasBookmarkedChapters:r,hasTrackerBinding:l,hasDuplicateChapters:C,hasStatus:w}=a,{settings:f}=P(),b=u.useMemo(()=>at(e,i,{...a,ignoreFilters:f.ignoreFilters}),[e,i,o,n,r,l,C,w,f.ignoreFilters]),h=u.useMemo(()=>st(b,a.sortBy,a.sortDesc),[b,a.sortBy,a.sortDesc]),c=Object.values(a.hasTrackerBinding).some(x=>x!=null),p=(o!=null||n!=null||r!=null||!!i||c)&&b.length===0&&e.length>0;return{visibleMangas:h,showFilteredOutMessage:p}},oe=xe("span")({display:"flex",alignItems:"center"}),le=({sx:e,...s})=>t.jsx(Ve,{...s,size:"small",sx:{...e,marginLeft:"5px"}});function Qt(){var q,ee;const{t:e}=B(),{settings:{showTabSize:s}}=P(),{data:i,error:a,loading:o,refetch:n}=N.useGetCategories(ye,{notifyOnNetworkStatusChange:!0}),r=i==null?void 0:i.categories.nodes.filter(d=>d.id!==0||d.id===0&&d.mangas.totalCount),l=r!=null?r:[],C=u.useMemo(()=>l.map(d=>d.mangas.totalCount).reduce((d,m)=>d+m,0),[l]),[w,f]=ie("tab",Me),{setOptions:b}=z(),h=(q=l.find(d=>d.order===w))!=null?q:l[0];u.useLayoutEffect(()=>{b(G(h))},[h]);const{data:c,error:p,loading:x,refetch:L}=N.useGetCategoryMangas(h==null?void 0:h.id,{skip:!h,notifyOnNetworkStatusChange:!0}),v=(ee=c==null?void 0:c.mangas.nodes)!=null?ee:[],{visibleMangas:g,showFilteredOutMessage:W}=ot(v,h),H=u.useCallback(()=>L().catch(ae()),[L,h]),de=u.useMemo(()=>g.map(d=>d.id),[g]),[y,O]=u.useState(!1),{areNoItemsForKeySelected:V,areAllItemsForKeySelected:Y,selectedItemIds:S,handleSelectAll:E,handleSelection:he,clearSelection:pe}=ze(g.length,{itemIds:de,currentKey:h==null?void 0:h.id.toString()}),Q=(d,m,k)=>{O(!!(S.length+(m?1:-1))),he(d,m,k)},$=u.useMemo(()=>S.map(d=>Re.getFromCache(d,Se,"MANGA_CHAPTER_STAT_FIELDS")).filter(d=>!!d),[S.length,g]),J=u.useMemo(()=>y?t.jsx(ve,{selectedItemsCount:S.length,title:"manga.title",children:(d,m)=>t.jsx(Ue,{selectedMangas:$,onClose:()=>{d(),O(!1),pe()},setHideMenu:m})}):null,[y,$]),{setTitle:X,setAction:Z}=u.useContext(je);u.useEffect(()=>{const d=e("library.title");return X(t.jsxs(oe,{children:[d,s&&t.jsx(le,{sx:{color:"inherit"},label:C})]}),d),Z(t.jsxs(t.Fragment,{children:[!y&&t.jsxs(t.Fragment,{children:[t.jsx(Te,{}),t.jsx(Je,{category:h}),t.jsx(Pe,{categoryId:h==null?void 0:h.id})]}),t.jsx(Xe,{isActive:y,areAllItemsSelected:Y,areNoItemsSelected:V,onSelectAll:k=>E(k,[...new Set(g.map(A=>A.id))]),onModeChange:k=>{O(k),k?E(!0,[...new Set(g.map(A=>A.id))]):l.forEach(A=>E(!1,[],A.id.toString()))}})]})),()=>{X(""),Z(null)}},[e,C,o,y,V,Y,S.length,g.length,h,s]);const ue=d=>{f(d)};return a!=null?t.jsx(re,{message:e("category.error.label.request_failure"),messageExtra:a.message,retry:()=>n().catch(ae())}):o?t.jsx(ke,{}):l.length===0?t.jsx(re,{message:e("library.error.label.empty")}):l.length===1?t.jsxs(t.Fragment,{children:[t.jsx(se,{mangas:g,message:e(p?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:p==null?void 0:p.message,isLoading:x,selectedMangaIds:S,isSelectModeActive:y,handleSelection:Q,showFilteredOutMessage:!p&&W,retry:p&&H}),J]}):t.jsxs(We,{children:[t.jsx(He,{value:h.order,onChange:(d,m)=>ue(m),tabsCount:l.length,children:l.map(d=>t.jsx(Fe,{sx:{display:"flex"},label:t.jsxs(oe,{children:[d.name,s?t.jsx(le,{label:d.mangas.totalCount}):null]}),value:d.order},d.id))}),l.map(d=>t.jsx(we,{index:d.order,currentIndex:h.order,children:d===h&&t.jsx(se,{mangas:g,message:e(p?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:p==null?void 0:p.message,isLoading:x,selectedMangaIds:S,isSelectModeActive:y,handleSelection:Q,showFilteredOutMessage:!p&&W,retry:p&&H})},d.order)),J]})}export{Qt as Library};
