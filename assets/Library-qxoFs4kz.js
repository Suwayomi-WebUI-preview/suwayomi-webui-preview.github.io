import{F as ae,d as C,H as Se,J as xe,K as ye,i as O,u as B,r as D,N as je,b as N,j as s,O as ke,P as Te,Q as L,R as M,q as Me,m as se,h as re,C as ce,I as _e,U,V as Ae,W as Fe,X as ve,Y as Be,Z as Ie,f as Le}from"./index-D2_dCMBF.js";import{u as de,S as we,A as Re,N as Oe}from"./AppbarSearch-DMR87DYu.js";import{E as oe}from"./EmptyViewAbsoluteCentered-rO8MR0G-.js";import{T as De,a as Ne}from"./Tabs-RSlghRpX.js";import{F as Ee}from"./FilterList-BU23g8va.js";import{C as w}from"./CheckboxInput-BoA396dr.js";import{S as Ge,R as G}from"./SortRadioInput-YO9bzqjP.js";import{T as k}from"./ThreeStateCheckboxInput-B96qeOI4.js";import{O as Ue,S as Pe,a as ze}from"./SelectionFAB-BRe4J3zw.js";import{T as We}from"./Trackers-D4pSmk7a.js";import{F}from"./TextField-kswmo9A1.js";import{R as Ye}from"./ListPreference-06Jqv6Ct.js";import{M as Ve,a as Je}from"./MangaGrid-BelB44FL.js";import{C as Ke,U as He}from"./UpdateChecker-C4Os02Wg.js";import{u as Qe}from"./useManageMangaLibraryState-D9P1Mjfm.js";import{C as Xe}from"./Checkbox-ngyJ9_M3.js";import{T as Ze}from"./TabsMenu-B0jEY_7I.js";import{T as $e}from"./TabsWrapper-Cn8YlKvo.js";import{u as qe}from"./useAppTitle-_3PqlVnx.js";import{u as et}from"./useAppAction-D6rZfZp7.js";import{C as tt}from"./Chip-CkrZDxnY.js";import"./ChaptersDownloadActionMenuItems-C6JtAFD6.js";import"./Card-CKffCtS2.js";import"./ListCardContent-CUni8eKh.js";import"./Avatar-ZcbM6Q4Z.js";import"./InputAdornment-Dl9od6QX.js";import"./useFormControl-BBRgs61F.js";import"./CheckCircle-DOoI4f8f.js";import"./MUI.util-DDPpK_AC.js";import"./CardActionArea-4qMvHVwC.js";import"./Link-Bg3AmDhN.js";import"./NumberSetting-C3zHIwEn.js";import"./Slider-Ds2-YWnr.js";import"./useMobilePicker-DYjW38Nt.js";import"./SelectSetting-48LUn2iX.js";import"./Select-D8FEiwW7.js";import"./FormGroup-CF4jN-FP.js";import"./formControlState-Dq1zat_P.js";import"./StyledFab-BuSqQPX7.js";import"./SwitchBase-C-QbNHM0.js";import"./Delete-1cwdsCH_.js";import"./Download-Bd4eVTbT.js";import"./Sync-DYhDQMst.js";import"./use-merged-ref-Dg2Oxsao.js";import"./ListCardAvatar-BTl3PnGb.js";import"./PlayArrow-CRqdKdDE.js";import"./Progress-Bbddpk_s.js";const at={sortDesc:void 0,sortBy:void 0,hasDownloadedChapters:void 0,hasBookmarkedChapters:void 0,hasUnreadChapters:void 0,hasReadChapters:void 0,hasDuplicateChapters:void 0,hasTrackerBinding:{},hasStatus:{}},he=e=>({...e,hasTrackerBinding:e.hasTrackerBinding?JSON.stringify(e.hasTrackerBinding):void 0,hasStatus:e.hasStatus?JSON.stringify(e.hasStatus):void 0}),st=e=>{var a,r;return{...e,hasTrackerBinding:(a=ae(e.hasTrackerBinding))!=null?a:void 0,hasStatus:(r=ae(e.hasStatus))!=null?r:void 0}},rt=(e,a=at,r)=>st(xe("category",e,he(a),void 0,r)),pe=(e,a,r)=>rt({...e,meta:Se(e.meta)},a,r),ot=(e,a)=>pe(e,a),ge=(e,a)=>{const r=pe(e,a,C.useEffect);return C.useMemo(()=>r,[e,a])},lt=async(e,a,r)=>ye(e,[[a,he({[a]:r})[a]]]),nt=(e,a=O())=>(r,t)=>lt(e,r,t).catch(a),it={filter:"global.label.filter",sort:"global.label.sort",display:"global.label.display"},ct=[["unreadChapters","library.option.sort.label.by_unread_chapters"],["totalChapters","library.option.sort.label.by_total_chapters"],["alphabetically","library.option.sort.label.alphabetically"],["dateAdded","library.option.sort.label.by_date_added"],["lastRead","library.option.sort.label.by_last_read"],["latestFetchedChapter","library.option.sort.label.by_latest_fetched_chapter"],["latestUploadedChapter","library.option.sort.label.by_latest_uploaded_chapter"]],dt=({category:e,open:a,onClose:r})=>{var p,y;const{t}=B(),l=D.useGetTrackerList(je),n=We.getLoggedIn((y=(p=l.data)==null?void 0:p.trackers.nodes)!=null?y:[]),o=ge(e),i=nt(e,g=>se(t("global.error.label.failed_to_save_changes"),"error",re(g))),{settings:{showTabSize:b,showContinueReadingButton:f,showDownloadBadge:_,showUnreadBadge:S,gridLayout:d}}=N(),x=Me(g=>se(t("search.error.label.failed_to_save_settings"),"error",re(g)));return s.jsx(Ue,{open:a,onClose:r,tabs:["filter","sort","display"],tabTitle:g=>t(it[g]),tabContent:g=>g==="filter"?s.jsxs(s.Fragment,{children:[s.jsx(k,{label:t("global.filter.label.unread"),checked:o.hasUnreadChapters,onChange:h=>i("hasUnreadChapters",h)}),s.jsx(k,{label:t("global.filter.label.started"),checked:o.hasReadChapters,onChange:h=>i("hasReadChapters",h)}),s.jsx(k,{label:t("global.filter.label.downloaded"),checked:o.hasDownloadedChapters,onChange:h=>i("hasDownloadedChapters",h)}),s.jsx(k,{label:t("global.filter.label.bookmarked"),checked:o.hasBookmarkedChapters,onChange:h=>i("hasBookmarkedChapters",h)}),s.jsx(k,{label:t("global.filter.label.duplicate_chapters"),checked:o.hasDuplicateChapters,onChange:h=>i("hasDuplicateChapters",h)}),s.jsx(F,{sx:{mt:2},children:t("manga.label.status")}),Object.values(ke).map(h=>s.jsx(k,{label:t(Te[h]),checked:o.hasStatus[h],onChange:u=>i("hasStatus",{...o.hasStatus,[h]:u})},h)),s.jsx(F,{sx:{mt:2},children:t("global.filter.label.tracked")}),n.map(h=>s.jsx(k,{label:h.name,checked:o.hasTrackerBinding[h.id],onChange:u=>i("hasTrackerBinding",{...o.hasTrackerBinding,[h.id]:u})},h.id))]}):g==="sort"?ct.map(([h,u])=>s.jsx(Ge,{label:t(u),checked:o.sortBy===h,sortDescending:o.sortDesc,onClick:()=>h!==o.sortBy?i("sortBy",h):i("sortDesc",!o.sortDesc)},h)):g==="display"?s.jsxs(s.Fragment,{children:[s.jsx(F,{children:t("global.grid_layout.title")}),s.jsxs(Ye,{onChange:h=>L("gridLayout",Number(h.target.value)),value:d,children:[s.jsx(G,{label:t("global.grid_layout.label.compact_grid"),value:M.Compact,checked:d==null||d===M.Compact}),s.jsx(G,{label:t("global.grid_layout.label.comfortable_grid"),value:M.Comfortable,checked:d===M.Comfortable}),s.jsx(G,{label:t("global.grid_layout.label.list"),value:M.List,checked:d===M.List})]}),s.jsx(F,{sx:{mt:2},children:t("library.option.display.badge.title")}),s.jsx(w,{label:t("library.option.display.badge.label.unread_badges"),checked:S,onChange:()=>L("showUnreadBadge",!S)}),s.jsx(w,{label:t("library.option.display.badge.label.download_badges"),checked:_,onChange:()=>L("showDownloadBadge",!_)}),s.jsx(F,{sx:{mt:2},children:t("library.option.display.tab.title")}),s.jsx(w,{label:t("library.option.display.tab.label.show_number_of_items"),checked:b,onChange:()=>x("showTabSize",!b)}),s.jsx(F,{sx:{mt:2},children:t("global.label.other")}),s.jsx(w,{label:t("library.option.display.other.label.show_continue_reading_button"),checked:f,onChange:()=>L("showContinueReadingButton",!f)})]}):null})},ht=({category:e})=>{const{t:a}=B(),[r,t]=C.useState(!1),l=ot(e),n=l.hasDownloadedChapters!=null||l.hasUnreadChapters!=null||l.hasReadChapters!=null||l.hasBookmarkedChapters!=null||l.hasDuplicateChapters!=null||Object.values(l.hasStatus).some(o=>o!=null)||Object.values(l.hasTrackerBinding).some(o=>o!=null);return s.jsxs(s.Fragment,{children:[s.jsx(ce,{title:a("settings.title"),children:s.jsx(_e,{onClick:()=>t(!r),color:n?"warning":"inherit",children:s.jsx(Ee,{})})}),s.jsx(dt,{category:e,open:r,onClose:()=>t(!1)})]})},pt=()=>{},le=({showFilteredOutMessage:e,message:a,messageExtra:r,...t})=>{const{t:l}=B(),{settings:{gridLayout:n}}=N();return C.useLayoutEffect(()=>(document.body.style.overflowY=n===M.List?"auto":"scroll",()=>{document.body.style.overflowY="auto"}),[]),s.jsx(Ve,{gridWrapperProps:{sx:{p:1}},...t,hasNextPage:!1,loadMore:pt,message:e?l("library.error.label.no_matches"):a,messageExtra:e?void 0:r,gridLayout:n})},gt=({isActive:e,areAllItemsSelected:a,areNoItemsSelected:r,onSelectAll:t,onModeChange:l})=>{const{t:n}=B();return s.jsxs(s.Fragment,{children:[e&&s.jsx(Pe,{areAllItemsSelected:a,areNoItemsSelected:r,onChange:t}),s.jsx(ce,{title:n(e?"global.button.cancel":"global.button.select_all"),children:s.jsx(Xe,{checkedIcon:s.jsx(Ke,{}),sx:{padding:"8px",color:"inherit","&.Mui-checked":{color:"inherit"}},checked:e,onChange:(o,i)=>l(i)})})]})},P=(e,a,r)=>{switch(e){case!0:return a();case!1:return r();default:return!0}},R=(e,a)=>P(e,()=>!!a&&a>=1,()=>a===0),ue=(e,a)=>P(e,()=>!!a,()=>!a),T=(e,a)=>{const r=e==null?void 0:e.filter(o=>o!=null),t=a==null?void 0:a.filter(o=>o!=null);if(!(r!=null&&r.length))return!0;const l=r.map(U),n=t.map(U).join(", ");return l.every(o=>n.includes(o))},ut=(e,{title:a,genre:r,description:t,artist:l,author:n,source:o,sourceId:i})=>T([e],[a])||T(e==null?void 0:e.split(","),r.map(b=>U(b)))||T([e],[t])||T([e],[l])||T([e],[n])||T([e],[o==null?void 0:o.displayName])||T([e],[i]),bt=(e,a)=>Object.entries(e).map(([r,t])=>{const l=a.trackRecords.nodes.some(n=>n.trackerId===Number(r));return P(t,()=>l,()=>!l)}).every(Boolean),mt=(e,a)=>Object.entries(e).map(([r,t])=>ue(t,r===a.status)).every(Boolean),Ct=(e,{hasDownloadedChapters:a,hasUnreadChapters:r,hasReadChapters:t,hasBookmarkedChapters:l,hasDuplicateChapters:n,hasTrackerBinding:o,hasStatus:i})=>R(a,e.downloadCount)&&R(r,e.unreadCount)&&R(t,e.chapters.totalCount-e.unreadCount)&&R(l,e.bookmarkCount)&&ue(n,e.hasDuplicateChapters)&&bt(o,e)&&mt(i,e),ft=(e,a,r)=>{const t=r.ignoreFilters&&(a==null?void 0:a.length);return e.filter(l=>{const n=ut(a,l),o=t||Ct(l,r);return n&&o})},v=(e=0,a=0)=>Number(e)-Number(a),St=(e,a)=>e.localeCompare(a),xt=(e,a,r)=>{const t=[...e];switch(a){case"alphabetically":t.sort((l,n)=>St(l.title,n.title));break;case"dateAdded":t.sort((l,n)=>v(l.inLibraryAt,n.inLibraryAt));break;case"unreadChapters":t.sort((l,n)=>v(l.unreadCount,n.unreadCount));break;case"lastRead":t.sort((l,n)=>{var o,i;return v((o=l.lastReadChapter)==null?void 0:o.lastReadAt,(i=n.lastReadChapter)==null?void 0:i.lastReadAt)});break;case"latestUploadedChapter":t.sort((l,n)=>{var o,i;return v((o=l.latestUploadedChapter)==null?void 0:o.uploadDate,(i=n.latestUploadedChapter)==null?void 0:i.uploadDate)});break;case"latestFetchedChapter":t.sort((l,n)=>{var o,i;return v((o=l.latestFetchedChapter)==null?void 0:o.fetchedAt,(i=n.latestFetchedChapter)==null?void 0:i.fetchedAt)});break;case"totalChapters":t.sort((l,n)=>v(l.chapters.totalCount,n.chapters.totalCount));break}return r&&t.reverse(),t},yt={id:-1},jt=(e,a)=>{const[r]=de("query",we),t=ge(a!=null?a:yt),{hasUnreadChapters:l,hasReadChapters:n,hasDownloadedChapters:o,hasBookmarkedChapters:i,hasTrackerBinding:b,hasDuplicateChapters:f,hasStatus:_}=t,{settings:S}=N(),d=C.useMemo(()=>ft(e,r,{...t,ignoreFilters:S.ignoreFilters}),[e,r,l,n,o,i,b,f,_,S.ignoreFilters]),x=C.useMemo(()=>xt(d,t.sortBy,t.sortDesc),[d,t.sortBy,t.sortDesc]),p=Object.values(t.hasTrackerBinding).some(g=>g!=null),y=(l!=null||n!=null||o!=null||i!=null||!!r||p)&&d.length===0&&e.length>0;return{visibleMangas:x,showFilteredOutMessage:y}},ne=Ie("span")({display:"flex",alignItems:"center"}),ie=({sx:e,...a})=>s.jsx(tt,{...a,size:"small",sx:{...e,marginLeft:"5px"}});function ma(){var X,Z,$,q,ee,te;const{t:e}=B(),{settings:{showTabSize:a}}=N(),{data:r,error:t,loading:l,refetch:n}=D.useGetCategories(Ae,{notifyOnNetworkStatusChange:!0}),o=r==null?void 0:r.categories.nodes.filter(c=>c.id!==0||c.id===0&&c.mangas.totalCount),i=o!=null?o:[],b=D.useGetMangas(Fe,{}),f=(Z=(X=b.data)==null?void 0:X.mangas.totalCount)!=null?Z:0,[_,S]=de("tab",Oe),d=($=i.find(c=>c.id===_))!=null?$:i[0],{data:x,error:p,loading:y,refetch:g}=D.useGetCategoryMangas(d==null?void 0:d.id,{skip:!d,notifyOnNetworkStatusChange:!0}),h=(q=x==null?void 0:x.mangas.nodes)!=null?q:[],{visibleMangas:u,showFilteredOutMessage:z}=jt(h,d),W=C.useCallback(()=>g().catch(O()),[g,d]),be=C.useMemo(()=>u.map(c=>c.id),[u]),[j,I]=C.useState(!1),{areNoItemsForKeySelected:Y,areAllItemsForKeySelected:V,selectedItemIds:A,handleSelectAll:E,handleSelection:J,clearSelection:me}=Qe(u.length,{itemIds:be,currentKey:d==null?void 0:d.id.toString()}),K=C.useCallback((c,m,fe)=>{I(!!(A.length+(m?1:-1))),J(c,m,fe)},[I,J]),H=C.useMemo(()=>A.map(c=>ve.getFromCache(c,Be,"MANGA_CHAPTER_STAT_FIELDS")).filter(c=>!!c),[A.length,u]),Q=C.useMemo(()=>j?s.jsx(ze,{selectedItemsCount:A.length,title:"manga.title",children:(c,m)=>s.jsx(Je,{selectedMangas:H,onClose:()=>{c(),I(!1),me()},setHideMenu:m})}):null,[j,H]);qe(s.jsxs(ne,{children:[e("library.title"),a&&s.jsx(ie,{sx:{color:"inherit"},label:f})]}),e("library.title"),[e,a,f]),et(s.jsxs(s.Fragment,{children:[!j&&d&&s.jsxs(s.Fragment,{children:[s.jsx(Re,{}),s.jsx(ht,{category:d}),s.jsx(He,{categoryId:d==null?void 0:d.id})]}),s.jsx(gt,{isActive:j,areAllItemsSelected:V,areNoItemsSelected:Y,onSelectAll:c=>E(c,[...new Set(u.map(m=>m.id))]),onModeChange:c=>{I(c),c?E(!0,[...new Set(u.map(m=>m.id))]):i.forEach(m=>E(!1,[],m.id.toString()))}})]}),[j,Y,V,d]);const Ce=c=>{S(c)};return t!=null||b.error?s.jsx(oe,{message:e("global.error.label.failed_to_load_data"),messageExtra:(te=t==null?void 0:t.message)!=null?te:(ee=b.error)==null?void 0:ee.message,retry:()=>{t&&n().catch(O()),b.error&&b.refetch().catch(O())}}):l||b.loading?s.jsx(Le,{}):i.length===0?s.jsx(oe,{message:e("library.error.label.empty")}):i.length===1?s.jsxs(s.Fragment,{children:[s.jsx(le,{mangas:u,message:e(p?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:p==null?void 0:p.message,isLoading:y,selectedMangaIds:A,isSelectModeActive:j,handleSelection:K,showFilteredOutMessage:!p&&z,retry:p&&W}),Q]}):s.jsxs($e,{children:[s.jsx(Ze,{value:d.id,onChange:(c,m)=>Ce(m),children:i.map(c=>s.jsx(De,{sx:{flexGrow:1,maxWidth:"unset"},label:s.jsxs(ne,{children:[c.name,a?s.jsx(ie,{label:c.mangas.totalCount}):null]}),value:c.id},c.id))}),i.map(c=>s.jsx(Ne,{index:c.order,currentIndex:d.order,children:c===d&&s.jsx(le,{mangas:u,message:e(p?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:p==null?void 0:p.message,isLoading:y,selectedMangaIds:A,isSelectModeActive:j,handleSelection:K,showFilteredOutMessage:!p&&z,retry:p&&W})},c.order)),Q]})}export{ma as Library};
