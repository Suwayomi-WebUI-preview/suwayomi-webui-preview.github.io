import{bS as v,bT as _,bU as x,bV as N,bW as O,bX as k,bY as C,bZ as F,b_ as L,b$ as I,r as u,c0 as y,A as M,c1 as w,bN as P,aF as B,G as b,m as R,g as Q,c2 as A,c3 as S}from"./index-CwyaP88o.js";import{g as H,e as q}from"./DateHelper-DfKMMxnX.js";import{a as G}from"./Asserts-xItX73wb.js";function U(d){return v("useFragment",X,_(d.client))(d)}function X(d){var e=_(d.client),t=e.cache,a=d.from,r=x(d,["from"]),n=N.useMemo(function(){return typeof a=="string"?a:a===null?null:t.identify(a)},[t,a]),o=O(function(){return k(k({},r),{from:n})},[r,n]),i=N.useMemo(function(){var m=o.fragment,l=o.fragmentName,f=o.from,g=o.optimistic,p=g===void 0?!0:g;if(f===null)return{result:E({result:{},complete:!1})};var D=e.cache,h=D.diff(k(k({},o),{returnPartialData:!0,id:f,query:D.getFragmentDoc(m,l),optimistic:p}));return{result:E(k(k({},h),{result:e.queryManager.maskFragment({fragment:m,fragmentName:l,data:h.result})}))}},[e,o]),c=N.useCallback(function(){return i.result},[i]);return C(N.useCallback(function(m){var l=0,f=o.from===null?null:e.watchFragment(o).subscribe({next:function(g){F(g,i.result)||(i.result=g,clearTimeout(l),l=setTimeout(m))}});return function(){f==null||f.unsubscribe(),clearTimeout(l)}},[e,o,i]),c,c)}function E(d){var e={data:d.result,complete:!!d.complete};return d.missing&&(e.missing=L(d.missing.map(function(t){return t.missing}))),e}const z={id:-1,name:"",realUrl:"",isDownloaded:!1,isBookmarked:!1},Z={unread:void 0,downloaded:void 0,bookmarked:void 0,reverse:!0,sortBy:"source",showChapterNumber:!1,excludedScanlators:[]},J={source:{id:"b8Yvxe"},chapterNumber:{id:"o9D8Hq"},uploadedAt:{id:"WwJg/z"},fetchedAt:{id:"vN2re/"}},j={download:{always:!1,bulkAction:!1,bulkActionCountForce:300},delete:{always:!0,bulkAction:!0},bookmark:{always:!1,bulkAction:!1},unbookmark:{always:!1,bulkAction:!0},mark_as_read:{always:!1,bulkAction:!0},mark_as_unread:{always:!1,bulkAction:!0}},T={download:{action:{single:{id:"mzI/c+"},selected:{id:"yXQEP/"}},confirmation:{id:"b4+8Zj"},success:{id:"Pw2aAm"},error:{id:"2QbxfQ"}},delete:{action:{single:{id:"cnGeoo"},selected:{id:"QEazml"}},confirmation:{id:"copN8z"},success:{id:"lGdfBe"},error:{id:"bfr371"}},bookmark:{action:{single:{id:"E4VGdA"},selected:{id:"OIAlUV"}},success:{id:"oS+Ars"},error:{id:"JjZGNS"}},unbookmark:{action:{single:{id:"Rk2XFh"},selected:{id:"6e404l"}},confirmation:{id:"elkD2D"},success:{id:"IEf0sL"},error:{id:"dAIceg"}},mark_as_read:{action:{single:{id:"+s1J8k"},selected:{id:"6/1SYX"}},confirmation:{id:"bVVGAK"},success:{id:"Z/MnHr"},error:{id:"+YRP1q"}},mark_as_unread:{action:{single:{id:"5GPcf9"},selected:{id:"KCnt6P"}},confirmation:{id:"iQgME0"},success:{id:"DrEB25"},error:{id:"d5zV3g"}}};class s{static getIds(e){return e.map(t=>t.id)}static getFromCache(e,t=I,a="CHAPTER_LIST_FIELDS"){return u.graphQLClient.client.cache.readFragment({id:u.graphQLClient.client.cache.identify({__typename:"ChapterType",id:e}),fragment:t,fragmentName:a})}static getDownloadStatusFromCache(e,t=y,a="DOWNLOAD_TYPE_FIELDS"){return u.graphQLClient.client.cache.readFragment({id:u.graphQLClient.client.cache.identify({__typename:"DownloadType",chapter:{__ref:u.graphQLClient.client.cache.identify({__typename:"ChapterType",id:e})}}),fragment:t,fragmentName:a})}static useDownloadStatusFromCache(e,t=y,a="DOWNLOAD_TYPE_FIELDS"){var n;const r=U({from:{__typename:"DownloadType",chapter:{__ref:u.graphQLClient.client.cache.identify({__typename:"ChapterType",id:e})}},fragment:t,fragmentName:a,client:u.graphQLClient.client});return!r.complete||!Object.keys((n=r.data)!=null?n:{}).length?null:r.data}static getReaderUrl(e){return M.reader.path(e.mangaId,e.sourceOrder)}static isDownloading(e){const t=[w.Downloading,w.Queued],a=s.getDownloadStatusFromCache(e);return t.includes(a==null?void 0:a.state)}static isDownloaded({isDownloaded:e}){return e}static getDownloaded(e){return e.filter(s.isDownloaded)}static isDownloadable(e){const t=s.getDownloadStatusFromCache(e.id);return!s.isDownloaded(e)&&(!t||t.state===w.Error)}static getDownloadable(e){return e.filter(this.isDownloadable)}static isDeletable({isBookmarked:e,...t},a=!1){return s.isDownloaded(t)&&(!e||a)}static getDeletable(e,t){return e.filter(a=>s.isDeletable(a,t))}static isBookmarked({isBookmarked:e}){return e}static getBookmarked(e){return e.filter(s.isBookmarked)}static getNonBookmarked(e){return e.filter(t=>!s.isBookmarked(t))}static isRead({isRead:e}){return e}static getRead(e){return e.filter(s.isRead)}static getNonRead(e){return e.filter(t=>!s.isRead(t))}static getMatchingChapterNumberChapters(e,t){return e.map(a=>{const r=t.find(n=>a.chapterNumber===n.chapterNumber);return r?[a,r]:null}).filter(a=>a!==null)}static async download(e,t){return s.executeAction("download",e.length,()=>u.addChaptersToDownloadQueue(e).response,t)}static async delete(e,t){return s.executeAction("delete",e.length,()=>u.deleteDownloadedChapters(e).response,t)}static async markAsRead(e,t=!1,a,r){const{deleteChaptersManuallyMarkedRead:n,deleteChaptersWithBookmark:o,updateProgressManualMarkRead:i}=await P(),c=n&&t?s.getIds(s.getDeletable(e,o)):[];return s.executeAction("mark_as_read",e.length,()=>u.updateChapters(s.getIds(e),{isRead:!0,lastPageRead:0,chapterIdsToDelete:c,trackProgressMangaId:i&&t?a:void 0}).response,r)}static async markAsUnread(e,t){return s.executeAction("mark_as_unread",e.length,()=>u.updateChapters(e,{isRead:!1}).response,t)}static async bookmark(e){return s.executeAction("bookmark",e.length,()=>u.updateChapters(e,{isBookmarked:!0}).response)}static async unBookmark(e){return s.executeAction("unbookmark",e.length,()=>u.updateChapters(e,{isBookmarked:!1}).response)}static async executeAction(e,t,a,r){const{always:n,bulkAction:o,bulkActionCountForce:i}=j[e],c=!r&&(n||o&&t>1)||i&&t>=i,m=T[e].confirmation;try{if(c){G(m);try{await B.show({title:b._({id:"6foA8n"}),message:b.t({...m,values:{count:t}}),actions:{confirm:{title:b._({id:"aP3N/0"})}}})}catch(l){return}}await a(),R(b.t({...T[e].success,values:{count:t}}),"success")}catch(l){throw R(b.t({...T[e].error,values:{count:t}}),"error",Q(l)),l}}static async performAction(e,t,{wasManuallyMarkedAsRead:a,trackProgressMangaId:r,chapters:n}){switch(e){case"download":return s.download(t);case"delete":return s.delete(t);case"mark_as_read":return s.markAsRead(n,a,r);case"mark_as_unread":return s.markAsUnread(t);case"bookmark":return s.bookmark(t);case"unbookmark":return s.unBookmark(t);default:throw new Error('Chapters::performAction: unknown action "'.concat(e,'"'))}}static addDuplicates(e,t){const a=Object.groupBy(t,({chapterNumber:r})=>r);return e.map(r=>{var n;return(n=a[r.chapterNumber])!=null?n:[r]}).flat()}static removeDuplicates(e,t){const a=Object.groupBy(t,({chapterNumber:n})=>n),r=Object.values(a).map(n=>{var o,i;return(i=(o=n.find(c=>c.id===e.id))!=null?o:n.findLast(c=>c.scanlator===e.scanlator))!=null?i:n.slice(-1)[0]});return t.map(({id:n})=>r.find(o=>o.id===n)).filter(n=>!!n)}static getNextChapter(e,t,{offset:a=A.NEXT,...r}={}){const n=s.getNextChapters(e,t,{offset:a,...r}),o=a===A.NEXT,i=o?-1:0,c=o?void 0:1;return n.slice(i,c)[0]}static getNextChapters(e,t,{offset:a=A.NEXT,onlyUnread:r=!1,skipDupe:n=!1,skipDupeChapter:o=e}={}){const i=t.findIndex(D=>D.id===e.id),c=a===A.NEXT,m=c?0:i,l=c?i+1:void 0,f=t.slice(m,l),p=(n?s.removeDuplicates(o,f):f).toSpliced(c?-1:0,1);return r?s.getNonRead(p):p}static getReaderResumeMode(e){return e.isRead?S.START:S.LAST_READ}static getReaderOpenChapterLocationState(e,t){return{resumeMode:s.getReaderResumeMode(e),updateInitialChapter:t}}static groupByDate(e,t){return Object.groupBy(e,a=>H(q(Number(a[t]))))}static getMissingCount(e){const t=e.toSorted((a,r)=>a.chapterNumber-r.chapterNumber);return t.reduce((a,r,n)=>a+s.getGap(r,t[n-1]),0)}static getGap(e,t){if(!e||!t||e.chapterNumber===-1||t.chapterNumber===-1)return 0;const a=Math.max(e.chapterNumber,t.chapterNumber),r=Math.min(e.chapterNumber,t.chapterNumber);return Math.max(0,Math.floor(a)-Math.floor(r)-1)}static getScanlators(e){return[...new Set(e.map(t=>t.scanlator).filter(t=>typeof t=="string"))]}}export{T as C,Z as D,z as F,s as a,j as b,J as c};
