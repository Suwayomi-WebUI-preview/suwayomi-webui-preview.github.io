import{u as H,ak as N,c as r,N as U,a as u,j as e,E as v,k as D,T as y,h as O,L as I,B as k,g as $,I as q,y as V}from"./index-CcDVmPxM.js";import{D as z}from"./DownloadStateIndicator-B8t1Vrw8.js";import{U as Q}from"./UpdateChecker-B4l88Hxq.js";import{S as W,a as J,b as K}from"./StyledGroupItemWrapper-Cy42vUBj.js";import{M as X}from"./Mangas-B_Qkr_04.js";import{S as Y}from"./SpinnerImage-Dw80zr-T.js";import{d as Z,g as ee,e as te}from"./date-CjVlDrUZ.js";import{C as ae,a as se}from"./index-CUMljoAB.js";import{C as oe}from"./CardContent-IRmJfK6n.js";import{A as re}from"./Avatar-Cg7hML-Z.js";import"./Progress-5mbYU9Yc.js";import"./Chapters-CIqDBlOg.js";const ne=o=>{if(!o.length)return[];const l=new Map;return o.forEach(p=>{var s;const d=ee(te(Number(p.fetchedAt)));l.set(d,((s=l.get(d))!=null?s:0)+1)}),[...l.entries()]},ye=()=>{var w,S;const{t:o}=H(),l=N(),{setTitle:p,setAction:d}=r.useContext(U),{data:s,loading:C,error:b,fetchMore:E,refetch:L}=u.useGetRecentlyUpdatedChapters(void 0,{fetchPolicy:"cache-and-network",notifyOnNetworkStatusChange:!0}),T=!!(s!=null&&s.chapters.pageInfo.hasNextPage),M=s==null?void 0:s.chapters.pageInfo.endCursor,n=(w=s==null?void 0:s.chapters.nodes)!=null?w:[],g=r.useMemo(()=>ne(n),[n]),P=r.useMemo(()=>g.map(t=>t[1]),[g]),{data:h}=u.useGetDownloadStatus(),R=(S=h==null?void 0:h.downloadStatus.queue)!=null?S:[],f=r.useRef(null),[_,A]=r.useState(0);r.useLayoutEffect(()=>{var t,a;A((a=(t=f.current)==null?void 0:t.clientHeight)!=null?a:0)},[f.current]);const{data:x}=u.useGetLastGlobalUpdateTimestamp({fetchPolicy:"cache-only"}),j=x==null?void 0:x.lastUpdateTimestamp.timestamp;r.useEffect(()=>(p(o("updates.title")),d(e.jsx(Q,{})),()=>{p(""),d(null)}),[o,j]);const G=t=>{const{sourceOrder:a,manga:{id:c}}=t;return R.find(i=>a===i.chapter.sourceOrder&&c===i.chapter.manga.id)},B=t=>{u.addChapterToDownloadQueue(t.id)},F=r.useCallback(()=>{T&&E({variables:{offset:n.length}})},[T,M]);return b?e.jsx(v,{message:o("global.error.label.failed_to_load_data"),messageExtra:b.message,retry:()=>L().catch(D())}):!C&&n.length===0?e.jsx(v,{message:o("updates.error.label.no_updates_available")}):e.jsxs(e.Fragment,{children:[e.jsx(y,{ref:f,sx:{marginLeft:"10px",paddingTop:t=>({[t.breakpoints.up("sm")]:{paddingTop:"6px"}})},children:o("library.settings.global_update.label.last_update",{date:j?Z.format(+j):"-"})}),e.jsx(W,{heightToSubtract:_,style:{height:"undefined"},components:{Footer:()=>C?e.jsx(O,{usePadding:!0}):null},overscan:window.innerHeight*.5,endReached:F,groupCounts:P,groupContent:t=>e.jsx(J,{variant:"h5",isFirstItem:t===0,children:g[t][0]}),itemContent:t=>{const a=n[t],{manga:c}=a,i=G(a);return e.jsx(K,{isLastItem:t===n.length-1,children:e.jsx(ae,{children:e.jsx(se,{component:I,to:"/manga/".concat(a.manga.id,"/chapter/").concat(a.sourceOrder),state:l.state,sx:{color:m=>m.palette.text[a.isRead?"disabled":"primary"]},children:e.jsxs(oe,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:2},children:[e.jsxs(k,{sx:{display:"flex"},children:[e.jsx(I,{to:"/manga/".concat(a.manga.id),style:{textDecoration:"none"},children:e.jsx(re,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",marginRight:2,background:"transparent"},children:e.jsx(Y,{imgStyle:{objectFit:"cover",width:"100%",height:"100%",imageRendering:"pixelated"},spinnerStyle:{small:!0},alt:c.title,src:X.getThumbnailUrl(c)})})}),e.jsxs(k,{sx:{display:"flex",flexDirection:"column"},children:[e.jsx(y,{variant:"h5",component:"h2",children:c.title}),e.jsx(y,{variant:"caption",display:"block",gutterBottom:!0,children:a.name})]})]}),i&&e.jsx(z,{download:i}),i==null&&!a.isDownloaded&&e.jsx($,{title:o("chapter.action.download.add.label.action"),children:e.jsx(q,{onClick:m=>{m.stopPropagation(),m.preventDefault(),B(a)},size:"large",children:e.jsx(V,{})})})]})})})},t)}})]})};export{ye as Updates};
