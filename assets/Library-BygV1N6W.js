import{u as A,n as I,a as B,G as de,j as e,o as S,c as h,f as se,I as ue,p as me,s as he,q as pe,h as q,t as be,N as ge,E as ee,g as fe}from"./index-DrMaLApM.js";import{u as P,S as oe,A as xe,N as Ce}from"./AppbarSearch-Bo8t0XOw.js";import{T as ye,a as Se}from"./Tabs-CGh6Bm1r.js";import{d as je}from"./FilterList-ChpzFF7M.js";import{C as R}from"./CheckboxInput-B_SfADIl.js";import{S as ke,R as O}from"./SortRadioInput-CfTF-eQA.js";import{T as L}from"./ThreeStateCheckboxInput-BukVnseN.js";import{O as _e,S as Te,a as Me}from"./SelectionFAB-Cwbg0ouB.js";import{T as Le}from"./Trackers-D4pSmk7a.js";import{F as w}from"./TextField-aIlb05nB.js";import{R as we}from"./ListPreference-DOf-BlGP.js";import{M as Fe,a as Ae}from"./MangaGrid-DF15aEgH.js";import{d as Ie,U as Re}from"./UpdateChecker-Drjxdq6n.js";import{u as Ee}from"./useManageMangaLibraryState-Drg7IjS3.js";import{C as Ne}from"./Checkbox-EWU1jBqu.js";import{e as G}from"./Strings-CWt9sr6N.js";import{T as ve,a as Oe}from"./TabsMenu-ByxkMPmD.js";import{M as De}from"./Mangas-DrH5ig5G.js";import{C as Be}from"./Chip-Q-qxfKpG.js";import"./StyledFab-CoMuShYA.js";import"./SwitchBase-NTpreOjo.js";import"./index-BePNABZb.js";import"./Delete-ChLidWWe.js";import"./Sync-CTLPmO34.js";import"./SpinnerImage-BGVImmaP.js";import"./TypographyMaxLines-CLXIUzbB.js";import"./Link-BzZzh5QK.js";import"./Card-7woGM9TE.js";import"./CardActionArea-fvZ2Eb_P.js";import"./CardContent-BdJiGkZ7.js";import"./Avatar-CkuqTDLV.js";import"./PlayArrow-BbFLK04Z.js";import"./Progress-DnvjB4xc.js";import"./Info-BytbeKyX.js";import"./InputAdornment-B2WSPuJe.js";import"./CheckCircle-bCfQw2NS.js";import"./Collapse-DZyVCVdY.js";import"./NumberSetting-CMsxWZno.js";import"./useMobilePicker-B8NeLnvK.js";import"./SelectSetting-CnAuj9Yv.js";import"./Select-BPexeUAg.js";import"./Chapters-zQI3XOpW.js";const Ge={filter:"global.label.filter",sort:"global.label.sort",display:"global.label.display"},Pe=[["sortToRead","library.option.sort.label.by_unread_chapters"],["sortAlph","library.option.sort.label.alphabetically"],["sortDateAdded","library.option.sort.label.by_date_added"],["sortLastRead","library.option.sort.label.by_last_read"],["sortLatestFetchedChapter","library.option.sort.label.by_latest_fetched_chapter"],["sortLatestUploadedChapter","library.option.sort.label.by_latest_uploaded_chapter"]],Ue=({open:t,onClose:r})=>{var b,x;const{t:a}=A(),{options:s,setOptions:n}=I(),i=B.useGetTrackerList(de),c=Le.getLoggedIn((x=(b=i.data)==null?void 0:b.trackers.nodes)!=null?x:[]),l=(p,o)=>{n(m=>({...m,[p]:o}))};return e.jsx(_e,{open:t,onClose:r,tabs:["filter","sort","display"],tabTitle:p=>a(Ge[p]),tabContent:p=>{if(p==="filter")return e.jsxs(e.Fragment,{children:[e.jsx(L,{label:a("global.filter.label.unread"),checked:s.unread,onChange:o=>l("unread",o)}),e.jsx(L,{label:a("global.filter.label.downloaded"),checked:s.downloaded,onChange:o=>l("downloaded",o)}),e.jsx(L,{label:a("global.filter.label.bookmarked"),checked:s.bookmarked,onChange:o=>l("bookmarked",o)}),e.jsx(L,{label:a("global.filter.label.duplicate_chapters"),checked:s.hasDuplicateChapters,onChange:o=>l("hasDuplicateChapters",o)}),e.jsx(w,{sx:{mt:2},children:a("global.filter.label.tracked")}),c.map(o=>e.jsx(L,{label:o.name,checked:s.tracker[o.id],onChange:m=>l("tracker",{...s.tracker,[o.id]:m})},o.id))]});if(p==="sort")return Pe.map(([o,m])=>e.jsx(ke,{label:a(m),checked:s.sorts===o,sortDescending:s.sortDesc,onClick:()=>o!==s.sorts?l("sorts",o):l("sortDesc",!s.sortDesc)},o));if(p==="display"){const{gridLayout:o,showContinueReadingButton:m,showDownloadBadge:u,showUnreadBadge:_,showTabSize:T}=s;return e.jsxs(e.Fragment,{children:[e.jsx(w,{children:a("global.grid_layout.title")}),e.jsxs(we,{onChange:E=>l("gridLayout",Number(E.target.value)),value:o,children:[e.jsx(O,{label:a("global.grid_layout.label.compact_grid"),value:S.Compact,checked:o==null||o===S.Compact}),e.jsx(O,{label:a("global.grid_layout.label.comfortable_grid"),value:S.Comfortable,checked:o===S.Comfortable}),e.jsx(O,{label:a("global.grid_layout.label.list"),value:S.List,checked:o===S.List})]}),e.jsx(w,{sx:{mt:2},children:a("library.option.display.badge.title")}),e.jsx(R,{label:a("library.option.display.badge.label.unread_badges"),checked:_,onChange:()=>l("showUnreadBadge",!_)}),e.jsx(R,{label:a("library.option.display.badge.label.download_badges"),checked:u,onChange:()=>l("showDownloadBadge",!u)}),e.jsx(w,{sx:{mt:2},children:a("library.option.display.tab.title")}),e.jsx(R,{label:a("library.option.display.tab.label.show_number_of_items"),checked:T,onChange:()=>l("showTabSize",!T)}),e.jsx(w,{sx:{mt:2},children:a("global.label.other")}),e.jsx(R,{label:a("library.option.display.other.label.show_continue_reading_button"),checked:m,onChange:()=>l("showContinueReadingButton",!m)})]})}return null}})},ze=()=>{const{t}=A(),[r,a]=h.useState(!1),{options:s}=I(),n=s.downloaded!=null||s.unread!=null||Object.values(s.tracker).some(i=>i!=null);return e.jsxs(e.Fragment,{children:[e.jsx(se,{title:t("settings.title"),children:e.jsx(ue,{onClick:()=>a(!r),color:n?"warning":"default",children:e.jsx(je,{})})}),e.jsx(Ue,{open:r,onClose:()=>a(!1)})]})},te=({showFilteredOutMessage:t,message:r,messageExtra:a,...s})=>{const{t:n}=A(),[i]=P("query",oe),{options:c}=I(),{unread:l,downloaded:b}=c;return h.useEffect(()=>{window.scrollTo(0,0)},[i,l,b]),h.useLayoutEffect(()=>(document.body.style.overflowY=c.gridLayout===S.List?"auto":"scroll",()=>{document.body.style.overflowY="auto"}),[]),e.jsx(Fe,{...s,hasNextPage:!1,loadMore:()=>{},message:t?n("library.error.label.no_matches"):r,messageExtra:t?void 0:a,gridLayout:c.gridLayout})},Ke=({isActive:t,areAllItemsSelected:r,areNoItemsSelected:a,onSelectAll:s,onModeChange:n})=>{const{t:i}=A();return e.jsxs(e.Fragment,{children:[t&&e.jsx(Te,{areAllItemsSelected:r,areNoItemsSelected:a,onChange:s}),e.jsx(se,{title:i(t?"global.button.cancel":"global.button.select_all"),children:e.jsx(Ne,{checkedIcon:e.jsx(Ie,{}),sx:{padding:"8px"},checked:t,onChange:(c,l)=>n(l)})})]})},U=(t,r,a)=>{switch(t){case!0:return r();case!1:return a();default:return!0}},D=(t,r)=>U(t,()=>!!r&&r>=1,()=>r===0),He=(t,r)=>U(t,()=>!!r,()=>!r),k=(t,r)=>{const a=t==null?void 0:t.filter(c=>c!=null),s=r==null?void 0:r.filter(c=>c!=null);if(!(a!=null&&a.length))return!0;const n=a.map(G),i=s.map(G).join(", ");return n.every(c=>i.includes(c))},We=(t,{title:r,genre:a,description:s,artist:n,author:i,source:c})=>k([t],[r])||k(t==null?void 0:t.split(","),a.map(l=>G(l)))||k([t],[s])||k([t],[n])||k([t],[i])||k([t],[c==null?void 0:c.displayName]),Ye=(t,r)=>Object.entries(t).map(([a,s])=>{const n=r.trackRecords.nodes.some(i=>i.trackerId===Number(a));return U(s,()=>n,()=>!n)}).every(a=>a),Ve=(t,{unread:r,downloaded:a,bookmarked:s,hasDuplicateChapters:n,tracker:i})=>D(a,t.downloadCount)&&D(r,t.unreadCount)&&D(s,t.bookmarkCount)&&He(n,t.hasDuplicateChapters)&&Ye(i,t),Qe=(t,r,a)=>{const s=a.ignoreFilters&&(r==null?void 0:r.length);return t.filter(n=>{const i=We(r,n),c=s||Ve(n,a);return i&&c})},F=(t=0,r=0)=>Number(t)-Number(r),$e=(t,r)=>t.localeCompare(r),Je=(t,r,a)=>{const s=[...t];switch(r){case"sortAlph":s.sort((n,i)=>$e(n.title,i.title));break;case"sortDateAdded":s.sort((n,i)=>F(n.inLibraryAt,i.inLibraryAt));break;case"sortToRead":s.sort((n,i)=>F(n.unreadCount,i.unreadCount));break;case"sortLastRead":s.sort((n,i)=>{var c,l;return F((c=n.lastReadChapter)==null?void 0:c.lastReadAt,(l=i.lastReadChapter)==null?void 0:l.lastReadAt)});break;case"sortLatestUploadedChapter":s.sort((n,i)=>{var c,l;return F((c=n.latestUploadedChapter)==null?void 0:c.uploadDate,(l=i.latestUploadedChapter)==null?void 0:l.uploadDate)});break;case"sortLatestFetchedChapter":s.sort((n,i)=>{var c,l;return F((c=n.latestFetchedChapter)==null?void 0:c.fetchedAt,(l=i.latestFetchedChapter)==null?void 0:l.fetchedAt)});break}return a&&s.reverse(),s},Xe=t=>{const[r]=P("query",oe),{options:a}=I(),{unread:s,downloaded:n,bookmarked:i,tracker:c,hasDuplicateChapters:l}=a,{settings:b}=me(),x=h.useMemo(()=>Qe(t,r,{unread:s,downloaded:n,bookmarked:i,hasDuplicateChapters:l,tracker:c,ignoreFilters:b.ignoreFilters}),[t,r,s,n,i,l,c,b.ignoreFilters]),p=h.useMemo(()=>Je(x,a.sorts,a.sortDesc),[x,a.sorts,a.sortDesc]),o=Object.values(a.tracker).some(u=>u!=null),m=(s!=null||n!=null||i!=null||!!r||o)&&x.length===0&&t.length>0;return{visibleMangas:p,showFilteredOutMessage:m}},ae=he("span")({display:"flex",alignItems:"center"}),re=t=>e.jsx(Be,{...t,size:"small",sx:{marginLeft:"5px"}});function Pt(){var X,Z;const{t}=A(),{options:r}=I(),{data:a,error:s,loading:n,refetch:i}=B.useGetCategories(pe,{notifyOnNetworkStatusChange:!0}),c=a==null?void 0:a.categories.nodes.filter(d=>d.id!==0||d.id===0&&d.mangas.totalCount),l=c!=null?c:[],b=h.useMemo(()=>l.map(d=>d.mangas.totalCount).reduce((d,g)=>d+g,0),[l]),[x,p]=P("tab",Ce),o=(X=l.find(d=>d.order===x))!=null?X:l[0],{data:m,error:u,loading:_,refetch:T}=B.useGetCategoryMangas(o==null?void 0:o.id,{skip:!o,notifyOnNetworkStatusChange:!0}),E=(Z=m==null?void 0:m.mangas.nodes)!=null?Z:[],{visibleMangas:f,showFilteredOutMessage:z}=Xe(E),K=h.useCallback(()=>T().catch(q()),[T,o]),le=h.useMemo(()=>f.map(d=>d.id),[f]),[C,N]=h.useState(!1),{areNoItemsForKeySelected:H,areAllItemsForKeySelected:W,selectedItemIds:y,handleSelectAll:v,handleSelection:ne,clearSelection:ie}=Ee(f.length,{itemIds:le,currentKey:o==null?void 0:o.id.toString()}),Y=(d,g,j)=>{N(!!(y.length+(g?1:-1))),ne(d,g,j)},V=h.useMemo(()=>y.map(d=>De.getFromCache(d,be,"MANGA_CHAPTER_STAT_FIELDS")).filter(d=>!!d),[y.length,f]),Q=h.useMemo(()=>C?e.jsx(Me,{selectedItemsCount:y.length,title:"manga.title",children:(d,g)=>e.jsx(Ae,{selectedMangas:V,onClose:()=>{d(),N(!1),ie()},setHideMenu:g})}):null,[C,V]),{setTitle:$,setAction:J}=h.useContext(ge);h.useEffect(()=>{const d=t("library.title"),g=e.jsxs(ae,{children:[d,r.showTabSize&&e.jsx(re,{label:b})]});return $(g,d),J(e.jsxs(e.Fragment,{children:[!C&&e.jsxs(e.Fragment,{children:[e.jsx(xe,{}),e.jsx(ze,{}),e.jsx(Re,{categoryId:o==null?void 0:o.id})]}),e.jsx(Ke,{isActive:C,areAllItemsSelected:W,areNoItemsSelected:H,onSelectAll:j=>v(j,[...new Set(f.map(M=>M.id))]),onModeChange:j=>{N(j),j?v(!0,[...new Set(f.map(M=>M.id))]):l.forEach(M=>v(!1,[],M.id.toString()))}})]})),()=>{$(""),J(null)}},[t,b,n,r,C,H,W,y.length,f.length,o]);const ce=d=>{p(d)};return s!=null?e.jsx(ee,{message:t("category.error.label.request_failure"),messageExtra:s.message,retry:()=>i().catch(q())}):n?e.jsx(fe,{}):l.length===0?e.jsx(ee,{message:t("library.error.label.empty")}):l.length===1?e.jsxs(e.Fragment,{children:[e.jsx(te,{mangas:f,message:t(u?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:u==null?void 0:u.message,isLoading:_,selectedMangaIds:y,isSelectModeActive:C,handleSelection:Y,showFilteredOutMessage:!u&&z,retry:u&&K}),Q]}):e.jsxs(ve,{children:[e.jsx(Oe,{value:o.order,onChange:(d,g)=>ce(g),tabsCount:l.length,children:l.map(d=>e.jsx(ye,{sx:{display:"flex"},label:e.jsxs(ae,{children:[d.name,r.showTabSize?e.jsx(re,{label:d.mangas.totalCount}):null]}),value:d.order},d.id))}),l.map(d=>e.jsx(Se,{index:d.order,currentIndex:o.order,children:d===o&&e.jsx(te,{mangas:f,message:t(u?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:u==null?void 0:u.message,isLoading:_,selectedMangaIds:y,isSelectModeActive:C,handleSelection:Y,showFilteredOutMessage:!u&&z,retry:u&&K})},d.order)),Q]})}export{Pt as Library};
