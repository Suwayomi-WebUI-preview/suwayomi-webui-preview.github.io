import{c as P,j as e,e as c,u as z,E as m,r as s,m as A,h as v,i as _,o as q,A as F,L as U,I as f,C as b,a as N,g as G}from"./index-CYOaxZB1.js";import{P as W}from"./PlayArrow-JH9SAGqJ.js";import{M as L,K as J}from"./MUI.util-BIqMDmnP.js";import{D as X,a as Y,b as Z,c as $,S as ee,v as te,d as re,e as oe}from"./DragHandle-CO4wCoDJ.js";import{E as R}from"./EmptyViewAbsoluteCentered-BmMNAYoe.js";import{D as ae}from"./Delete-ChT_9CwD.js";import{C as se}from"./ChapterDownloadRetryButton-xtRX0P75.js";import{C as ne,D as ie}from"./ChapterCardMetadata-C_7VEOYI.js";import{L as le}from"./ListCardContent-C69EXtpD.js";import{C as de}from"./Card-8NKR3lrK.js";import{C as ce}from"./CardActionArea-Ber97Kga.js";import"./CardContent-B8Mv1t_q.js";const pe=P(e.jsx("path",{d:"M6 19h4V5H6zm8-14v14h4V5z"})),ue=P(e.jsx("path",{d:"M15 16h4v2h-4zm0-8h7v2h-7zm0 4h6v2h-6zM3 18c0 1.1.9 2 2 2h6c1.1 0 2-.9 2-2V8H3zM14 5h-3l-1-1H6L5 5H2v2h12z"})),M=c.memo(({item:r,status:x})=>{const{t:g}=z(),p=c.useCallback(async i=>{const u=x===m.Started;try{u&&await s.stopDownloads().response,await Promise.all([s.removeChapterFromDownloadQueue(i.id).response,s.deleteDownloadedChapter(i.id).response])}catch(C){A(g("download.queue.error.label.failed_to_remove"),"error",v(C))}u&&s.startDownloads().response.catch(_())},[x]);return e.jsx(q,{sx:{p:1,pb:0},children:e.jsx(de,{children:e.jsx(ce,{component:U,to:F.manga.path(r.manga.id),children:e.jsxs(le,{children:[e.jsx(f,{...L.preventRippleProp(),sx:{pointerEvents:"none"},children:e.jsx(X,{})}),e.jsx(ne,{title:r.manga.title,secondaryText:r.chapter.name}),e.jsx(ie,{chapterId:r.chapter.id}),e.jsx(se,{chapterId:r.chapter.id}),e.jsx(b,{title:g("chapter.action.download.delete.label.action"),children:e.jsx(f,{...L.preventRippleProp(),onClick:i=>{i.preventDefault(),i.stopPropagation(),p(r.chapter)},children:e.jsx(ae,{})})})]})})})})}),Se=()=>{var y,E;const{t:r}=z(),[x,{reset:g}]=s.useReorderChapterInDownloadQueue(),{data:p,loading:i,error:u,refetch:C}=s.useGetDownloadStatus({notifyOnNetworkStatusChange:!0}),l=p==null?void 0:p.downloadStatus,o=(y=l==null?void 0:l.queue)!=null?y:[],d=(E=l==null?void 0:l.state)!=null?E:m.Started,j=!o.length,{setTitle:I,setAction:S}=N(),k=c.useMemo(()=>o.map(t=>t.chapter),[o]),H=Y.useSensorsForDevice(),[h,w]=c.useState(null),Q=async()=>{try{await s.clearDownloads().response}catch(t){A(r("download.queue.error.label.failed_delete_all"),"error",v(t))}},T=()=>{d===m.Stopped?s.startDownloads():s.stopDownloads()},B=(t,a,n)=>{a!==n&&x({variables:{input:{chapterId:t[a].chapter.id,to:n}}}).catch(()=>{g()})},K=t=>{const{active:a,over:n}=t;if(w(null),!n||a.id===n.id)return;const O=o.findIndex(D=>D.chapter.id===a.id),V=o.findIndex(D=>D.chapter.id===n.id);B(o,O,V)};return c.useLayoutEffect(()=>(I(r("download.queue.title")),S(e.jsxs(e.Fragment,{children:[e.jsx(b,{title:r("download.queue.label.delete_all"),children:e.jsx(f,{onClick:Q,color:"inherit",children:e.jsx(ue,{})})}),e.jsx(b,{title:r(d===m.Started?"global.button.start":"global.button.stop"),disabled:j,children:e.jsx(f,{onClick:T,disabled:j,color:"inherit",children:d===m.Stopped?e.jsx(W,{}):e.jsx(pe,{})})})]})),()=>{I(""),S(null)}),[r,d,j]),c.useEffect(()=>{const t=a=>{(a.message==="ResizeObserver loop completed with undelivered notifications."||a.message==="ResizeObserver loop limit exceeded")&&a.stopImmediatePropagation()};return window.addEventListener("error",t),()=>window.removeEventListener("error",t)},[]),i?e.jsx(G,{}):u?e.jsx(R,{message:r("global.error.label.failed_to_load_data"),messageExtra:v(u),retry:()=>C().catch(_())}):j?e.jsx(R,{message:r("download.queue.label.no_downloads")}):e.jsx(q,{sx:{pb:1},children:e.jsxs(Z,{sensors:H,collisionDetection:$,onDragStart:t=>{var a;return w((a=o.find(n=>n.chapter.id===t.active.id))!=null?a:null)},onDragEnd:K,onDragCancel:()=>w(null),onDragAbort:()=>w(null),children:[e.jsx(ee,{items:k,strategy:te,children:e.jsx(J,{useWindowScroll:!0,overscan:window.innerHeight*.5,totalCount:o.length,computeItemKey:t=>o[t].chapter.id,itemContent:t=>e.jsx(re,{id:o[t].chapter.id,isDragging:o[t].chapter.id===(h==null?void 0:h.chapter.id),children:e.jsx(M,{item:o[t],status:d})})})}),e.jsx(oe,{isActive:!!h,children:e.jsx(M,{item:h,status:d})})]})})};export{Se as DownloadQueue};
