import{c as de,j as e,u as N,M as He,C as $,a as ke,A as O,L as F,b as Q,B as R,S as ue,r as f,T as m,d as he,e as G,f as Y,g as q,h,i as xe,k as U,I as D,l as J,E as H,m as T,n as M,o as Oe,p as k,D as Te,q as ze,s as Ve,t as We,v as Ke,w as qe,x as Xe,y as $e,z as Qe,F as Ye,G as Ne,H as Ie,J as Je,K as Ze,N as ae,O as ie}from"./index-DgNgvAHK.js";import{u as Me,S as Re,A as et}from"./AppbarSearch-DWUQw0Oo.js";import{s as Ae,l as Ue,D as X,a as tt,e as st}from"./Languages-B1KAv10-.js";import{SourceContentType as le}from"./SourceMangas-CHRup0IE.js";import{t as z,L as De,g as K,I as nt,a as ot,E as Pe,b as C,c as rt,d as at,e as Be,f as it,i as lt,h as ct}from"./LangSelect-Dq7iSr_p.js";import{A as pe}from"./Avatar-ADx4fg1_.js";import{f as dt}from"./file-selector-DlHkLoY8.js";import{S as ge,V as ut,a as ht,b as xt}from"./Virtuoso.util-B3GHqam2.js";import{T as pt}from"./TabsWrapper-VWLJoYQS.js";import{A as gt,a as mt}from"./SortRadioInput-BHSKlhfu.js";import{C as ft}from"./Chip-D67qly2s.js";import"./ChaptersDownloadActionMenuItems-tfUqP_uV.js";import"./Trackers-D4pSmk7a.js";import"./Info-xfE5nIs4.js";import"./CheckCircle-DkLzLStc.js";import"./ListPreference-BR8mMqVR.js";import"./NumberSetting-C-ulD1bo.js";import"./useMobilePicker-B6wSjIyA.js";import"./SelectSetting-C9BbYcHi.js";import"./FilterList-BaP4SVl9.js";import"./GridLayouts-BKCeY1T4.js";import"./ExpandMore-UnmLW321.js";import"./useDebounce-DX3bp9gK.js";import"./StyledFab-DL0c2a_S.js";import"./BaseMangaGrid-CqoqyObb.js";import"./MangaGrid-DSAPW3n5.js";import"./Sync-B46P5MBb.js";import"./PlayArrow-Hp41Wm6r.js";import"./cloneObject-DrOPTG0J.js";const jt=de(e.jsx("path",{d:"M19.3 16.9c.4-.7.7-1.5.7-2.4 0-2.5-2-4.5-4.5-4.5S11 12 11 14.5s2 4.5 4.5 4.5c.9 0 1.7-.3 2.4-.7l3.2 3.2 1.4-1.4zm-3.8.1c-1.4 0-2.5-1.1-2.5-2.5s1.1-2.5 2.5-2.5 2.5 1.1 2.5 2.5-1.1 2.5-2.5 2.5M12 20v2C6.48 22 2 17.52 2 12S6.48 2 12 2c4.84 0 8.87 3.44 9.8 8h-2.07c-.64-2.46-2.4-4.47-4.73-5.41V5c0 1.1-.9 2-2 2h-2v2c0 .55-.45 1-1 1H8v2h2v3H9l-4.79-4.79C4.08 10.79 4 11.38 4 12c0 4.41 3.59 8 8 8"}),"TravelExplore"),St=r=>{const{t}=N(),n=He.useIsMobileWidth(),{source:{id:c,name:i,lang:o,iconUrl:d,supportsLatest:a,isNsfw:x,extension:{repo:s}},showSourceRepo:E}=r,u=Number(c)===0?t("source.local_source.title"):i;return e.jsx($,{sx:{margin:1,marginTop:0},children:e.jsx(ke,{component:F,to:O.sources.childRoutes.browse.path(c),state:{contentType:le.POPULAR,clearCache:!0},children:e.jsxs(Q,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:1.5},children:[e.jsxs(R,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(pe,{variant:"rounded",alt:u,sx:{width:56,height:56,flex:"0 0 auto",mr:1,background:"transparent"},children:e.jsx(ue,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:u,src:f.getValidImgUrlFor(d)})}),e.jsxs(R,{sx:{display:"flex",flexDirection:"column",justifyContent:"center"},children:[e.jsx(m,{variant:"h6",component:"h3",children:u}),e.jsxs(m,{variant:"caption",sx:{display:"block"},children:[z(o),x&&e.jsx(m,{variant:"caption",color:"error",sx:{display:"inline"},children:" 18+"}),E&&e.jsx(m,{variant:"caption",sx:{display:"block"},children:s})]})]})]}),e.jsxs(he,{sx:{flexDirection:"row",gap:1},children:[a&&e.jsx(G,{variant:"outlined",component:F,to:O.sources.childRoutes.browse.path(c),state:{contentType:le.LATEST,clearCache:!0},children:t("global.button.latest")}),!n&&e.jsx(G,{variant:"outlined",component:F,to:O.sources.childRoutes.browse.path(c),state:{contentType:le.POPULAR,clearCache:!0},children:t("global.button.popular")})]})]})})})};function Et(r){const t=new Set;return r.forEach(n=>{const i=Number(n.id)===0?X.OTHER:n.lang;t.add(i)}),[...t].sort(Ue)}function bt(r){const t={};return r.forEach(n=>{var o;const i=Number(n.id)===0?X.OTHER:n.lang;(o=t[i])!=null||(t[i]=[]),t[i].push(n)}),Object.values(t).forEach(n=>n.sort((c,i)=>c.name.localeCompare(i.name))),t}function wt(){const{t:r}=N(),{setAction:t}=Y(),[n,c]=q("shownSourceLangs",tt()),[i]=q("showNsfw",!0),{data:o,loading:d,error:a,refetch:x}=f.useGetSourceList({notifyOnNetworkStatusChange:!0}),s=o==null?void 0:o.sources.nodes,E=h.useMemo(()=>{if(!s||s!=null&&s.length)return!1;const{repo:u}=s[0].extension;return s.some(j=>j.extension.repo!==u)},[s]),S=xe();return h.useEffect(()=>{Ae().forEach(u=>{let j=!1;n.forEach(g=>{g===u&&(j=!0)}),j||c(g=>(g.push(u),g))})},[]),h.useLayoutEffect(()=>(t(e.jsxs(e.Fragment,{children:[e.jsx(U,{title:r("search.title.global_search"),children:e.jsx(D,{onClick:()=>S(O.sources.childRoutes.searchAll.path),size:"large",color:"inherit",children:e.jsx(jt,{})})}),e.jsx(De,{shownLangs:n,setShownLangs:c,allLangs:Et(s!=null?s:[]),forcedLangs:Ae()})]})),()=>{t(null)}),[r,n,s]),d?e.jsx(J,{}):a?e.jsx(H,{message:r("global.error.label.failed_to_load_data"),messageExtra:T(a),retry:()=>x().catch(M())}):(s==null?void 0:s.length)===0?e.jsx(H,{message:r("source.error.label.no_sources_found")}):e.jsx(e.Fragment,{children:Object.entries(bt(s!=null?s:[])).sort((u,j)=>Ue(u[0],j[0])).map(([u,j])=>(u===X.OTHER||n.includes(u))&&e.jsxs(h.Fragment,{children:[e.jsx(m,{variant:"h5",component:"h2",sx:{paddingLeft:3,paddingTop:1,paddingBottom:2,fontWeight:"bold"},children:z(u)},u),j.filter(g=>{if(u===X.OTHER){const v=Number(g.id)===0;if(!(n.includes(u)||v))return!1}return i||!g.isNsfw}).map(g=>e.jsx(St,{source:g,showSourceRepo:E},g.id))]},u))})}function vt(r){const{t}=N(),{extension:{name:n,lang:c,versionName:i,isInstalled:o,hasUpdate:d,isObsolete:a,pkgName:x,iconUrl:s,isNsfw:E,repo:S},handleUpdate:u,showOptions:j,showSourceRepo:g,forcedState:b}=r,[v,I]=h.useState(K(o,a,d)),L=b!=null?b:v;h.useEffect(()=>{I(K(o,a,d))},[K(o,a,d)]);const P=c==="all"?t("extension.language.all"):c.toUpperCase(),V=async y=>{const B=at[y],ee=rt[y];try{switch(I(ee),y){case C.INSTALL:await f.updateExtension(x,{install:!0,isObsolete:a}).response;break;case C.UNINSTALL:await f.updateExtension(x,{uninstall:!0,isObsolete:a}).response;break;case C.UPDATE:await f.updateExtension(x,{update:!0,isObsolete:a}).response;break;default:throw new Error('Unexpected ExtensionAction "'.concat(y,'"'))}I(B),u()}catch(W){I(K(o,a,d)),k(t(Be[y],{count:1}),"error",T(W))}};function Z(){switch(L){case C.INSTALL:case C.UPDATE:case C.UNINSTALL:V(L).catch(M());break;case Pe.OBSOLETE:V(C.UNINSTALL).catch(M());break}}return e.jsx($,{children:e.jsxs(Q,{sx:{display:"flex",alignItems:"center",gap:1,p:1.5,"&:last-child":{paddingBottom:1.5}},children:[e.jsx(pe,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",background:"transparent"},alt:n,children:e.jsx(ue,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:n,src:f.getValidImgUrlFor(s)})}),e.jsxs(R,{sx:{display:"flex",flexDirection:"column",flexGrow:1,flexShrink:1,wordBreak:"break-word",justifyContent:"center"},children:[e.jsx(m,{variant:"h6",component:"h3",children:n}),e.jsxs(m,{variant:"caption",sx:{display:"block"},children:[P," ",i,E&&e.jsx(m,{variant:"caption",color:"error",sx:{display:"inline"},children:" 18+"})]}),g&&e.jsx(m,{variant:"caption",sx:{display:"block"},children:S})]}),o&&e.jsx(U,{title:t("settings.title"),children:e.jsx(D,{onClick:j,color:"inherit",children:e.jsx(Oe,{})})}),e.jsx(G,{variant:"outlined",sx:{color:L===ot.OBSOLETE?"red":"inherit",flexShrink:0},onClick:()=>Z(),children:t(nt[L])})]})})}function Lt({extensionId:r,closeDialog:t}){const{t:n}=N(),c=xe(),{data:i,loading:o,error:d,refetch:a}=f.useGetSourceList({notifyOnNetworkStatusChange:!0});if(d)return e.jsx(Te,{open:!!r,onClose:t});const x=h.useMemo(()=>r?i==null?void 0:i.sources.nodes.filter(s=>s.extension.pkgName===r):[],[i==null?void 0:i.sources.nodes,r]);return console.log("@asdf",r,x),e.jsxs(Te,{open:!!r,onClose:t,maxWidth:"md",fullWidth:!0,children:[e.jsx(ze,{children:n("extension.settings.dialog.title")}),e.jsxs(Ve,{children:[o&&e.jsx(J,{}),d&&e.jsx(H,{message:n("global.error.label.failed_to_load_data"),messageExtra:T(d),retry:()=>a().catch(M())}),!o&&!d&&e.jsx(R,{children:x==null?void 0:x.map(s=>e.jsx(ge,{sx:{px:0},children:e.jsx($,{children:e.jsxs(Q,{sx:{display:"flex",alignItems:"center",gap:1,p:1.5,"&:last-child":{paddingBottom:1.5}},children:[e.jsx(m,{variant:"h6",component:"h3",sx:{flexGrow:1},children:z(s.lang)}),s.isConfigurable&&e.jsx(U,{title:n("settings.title"),children:e.jsx(D,{onClick:()=>c(O.sources.childRoutes.configure.path(s.id)),color:"inherit",children:e.jsx(Oe,{})})})]})})},s.id))})]})]})}const ce=0,_e=1;function yt({tabsMenuHeight:r}){var Le,ye;const{t}=N(),{setAction:n}=Y(),c=xe(),{pathname:i,search:o,state:d}=We(),a=d==null?void 0:d.selectedExtensionPkg,x=l=>{c(i+o,{replace:!0,state:{selectedExtensionPkg:l}})},{data:s,loading:E,error:S,refetch:u}=f.useGetServerSettings({notifyOnNetworkStatusChange:!0}),j=!!(s!=null&&s.settings.extensionRepos.length),g=((Le=s==null?void 0:s.settings.extensionRepos.length)!=null?Le:0)>1,b=h.useRef(null),[v,I]=q("shownExtensionLangs",st()),[L]=q("showNsfw",!0),[P]=Me("query",Re),[V,Z]=h.useState({}),[y,{data:B,loading:ee,error:W}]=f.useExtensionListFetch(),A=(ye=B==null?void 0:B.fetchExtensions)==null?void 0:ye.extensions,[me,fe]=h.useState([]),te=h.useCallback(()=>Z({}),[]);h.useEffect(()=>{y()},[V]);const je=h.useMemo(()=>(A!=null?A:[]).filter(l=>{const p=L||!l.isNsfw;return P?p&&l.name.toLowerCase().includes(P.toLowerCase()):p}),[A,L,P]),{allLangs:Se,groupedExtensions:se}=h.useMemo(()=>it(je),[je]),_=h.useMemo(()=>se.filter(l=>l[_e].length>0).filter(l=>lt(l[ce])||v.includes(l[ce])),[v,se]),Ee=h.useMemo(()=>_.map(l=>l[_e].length),[_]),ne=h.useMemo(()=>_.map(([,l])=>l).flat(1),[_]),Fe=ut.useCreateGroupedComputeItemKey(Ee,h.useCallback(l=>_[l][ce],[_]),h.useCallback(l=>ne[l].pkgName,[ne])),be=l=>{l.name.toLowerCase().endsWith("apk")?(b.current&&(b.current.value=""),k(t("extension.label.installing_file"),"info"),f.installExternalExtension(l).response.then(()=>{te(),k(t("extension.label.installed_successfully"),"success")}).catch(p=>k(t("extension.label.installation_failed"),"error",T(p)))):k(t("global.error.label.invalid_file_type"),"error")};h.useLayoutEffect(()=>(n(e.jsxs(e.Fragment,{children:[e.jsx(et,{}),e.jsx(U,{title:t("extension.action.label.install_external"),children:e.jsx(D,{onClick:()=>{var l;return(l=b.current)==null?void 0:l.click()},size:"large",color:"inherit",children:e.jsx(Ke,{})})}),e.jsx(De,{shownLangs:v,setShownLangs:I,allLangs:Se})]})),()=>{n(null)}),[t,v,Se]),h.useEffect(()=>{const l=async w=>{w.preventDefault();const oe=await dt(w);be(oe[0])},p=w=>{w.preventDefault()};return document.addEventListener("drop",l),document.addEventListener("dragover",p),()=>{document.removeEventListener("drop",l),document.removeEventListener("dragover",p)}},[]);const we=h.useMemo(()=>e.jsx("input",{type:"file",style:{display:"none"},ref:b,onChange:l=>{var w;const p=(w=l.target.files)==null?void 0:w[0];p&&be(p)}}),[]),Ge=E||ee,ve=S!=null?S:W;return Ge?e.jsx(J,{}):ve?e.jsx(H,{message:t("global.error.label.failed_to_load_data"),messageExtra:T(ve),retry:()=>{S&&u().catch(M()),W&&y().catch(M())}}):!(A!=null&&A.length)&&!j?e.jsxs(e.Fragment,{children:[we,e.jsxs(he,{sx:{alignItems:"center",justifyContent:"center",rowGap:"10px",paddingTop:"20px"},children:[e.jsx(m,{children:t("extension.label.add_repository_info")}),e.jsx(G,{component:F,variant:"contained",to:O.browse.path,children:t("settings.title")})]})]}):e.jsxs(e.Fragment,{children:[we,e.jsx(ht,{heightToSubtract:r,overscan:window.innerHeight*.5,groupCounts:Ee,groupContent:l=>{const[p,w]=_[l],oe=p===ct.UPDATE_PENDING;return e.jsxs(xt,{isFirstItem:l===0,sx:{flexDirection:"row",justifyContent:"space-between",alignItems:"center",pr:1},children:[e.jsx(m,{variant:"h5",component:"h2",children:z(p)}),oe&&e.jsx(G,{disabled:!!me.length,variant:"contained",onClick:()=>{const Ce=w.map(re=>re.pkgName);fe(Ce),f.updateExtensions(Ce,{update:!0}).response.then(()=>te()).catch(re=>k(t(Be[C.UPDATE],{count:se.length}),"error",T(re))).finally(()=>fe([]))},children:t("extension.action.label.update_all")})]},p)},computeItemKey:Fe,itemContent:l=>{const p=ne[l];return e.jsx(ge,{children:e.jsx(vt,{extension:p,handleUpdate:te,showSourceRepo:g,forcedState:me.includes(p.pkgName)?Pe.UPDATING:void 0,showOptions:()=>x(p.pkgName)})})}}),e.jsx(Lt,{extensionId:a,closeDialog:()=>x(void 0)})]})}const Ct=de(e.jsx("path",{d:"M14.94 4.66h-4.72l2.36-2.36zm-4.69 14.71h4.66l-2.33 2.33zM6.1 6.27 1.6 17.73h1.84l.92-2.45h5.11l.92 2.45h1.84L7.74 6.27zm-1.13 7.37 1.94-5.18 1.94 5.18zm10.76 2.5h6.12v1.59h-8.53v-1.29l5.92-8.56h-5.88v-1.6h8.3v1.26z"}),"SortByAlpha"),Tt=de(e.jsx("path",{d:"M20 10V8h-4V4h-2v4h-4V4H8v4H4v2h4v4H4v2h4v4h2v-4h4v4h2v-4h4v-2h-4v-4zm-6 4h-4v-4h4z"}),"Tag"),Nt=({id:r,name:t,lang:n,iconUrl:c,mangaCount:i})=>{const{t:o}=N(),a=Number(r)===0?o("source.local_source.title"):t;return e.jsx($,{children:e.jsx(ke,{component:F,to:O.migrate.path(r),children:e.jsxs(Q,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",p:1.5},children:[e.jsxs(R,{sx:{display:"flex"},children:[e.jsx(pe,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",mr:1,background:"transparent"},children:e.jsx(ue,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:a,src:f.getValidImgUrlFor(c)})}),e.jsxs(R,{sx:{display:"flex",flexDirection:"column",justifyContent:"center"},children:[e.jsx(m,{variant:"h6",component:"h3",children:a}),e.jsx(m,{variant:"caption",sx:{display:"block"},children:z(n)})]})]}),e.jsx(ft,{sx:{borderRadius:1},size:"small",label:i})]})})})},It=(r,{sortBy:t,sortOrder:n})=>{if(!r)return[];const c={};r.forEach(({sourceId:o,source:d})=>{var x;const a=(x=c[o])!=null?x:{id:o,name:o,lang:"unknown",iconUrl:null,mangaCount:0,...d};c[o]={...a,mangaCount:a.mangaCount+1}});const i=Object.values(c).toSorted((o,d)=>{switch(t){case Ne.SOURCE_NAME:return o.name.localeCompare(d.name);case Ne.MANGA_COUNT:return o.mangaCount-d.mangaCount;default:throw new Error('Unexpected "sortBy" "'.concat(t,'"'))}});switch(n){case Ie.ASC:return i;case Ie.DESC:return i.toReversed();default:throw new Error('Unexpected "sortOrder" "'.concat(n,'"'))}},At=({tabsMenuHeight:r})=>{const{t}=N(),{appBarHeight:n}=Y(),{settings:{migrateSortSettings:c}}=qe(),i=Xe(u=>k(t("global.error.label.failed_to_save_changes"),"error",T(u))),{sortBy:o,sortOrder:d}=c,{data:a,loading:x,error:s,refetch:E}=f.useGetMigratableSources({notifyOnNetworkStatusChange:!0}),S=h.useMemo(()=>It(a==null?void 0:a.mangas.nodes,c),[a==null?void 0:a.mangas.nodes,c]);return x?e.jsx(J,{}):s?e.jsx(H,{message:t("global.error.label.failed_to_load_data"),messageExtra:T(s),retry:()=>E().catch(M())}):e.jsxs(e.Fragment,{children:[e.jsxs(he,{sx:{position:"sticky",top:"".concat(n+r,"px"),flexDirection:"row",justifyContent:"end",alignItems:"center",gap:1,p:1,backgroundColor:"background.default",zIndex:1},children:[e.jsx(U,{title:t($e[o]),children:e.jsx(D,{size:"large",color:"inherit",onClick:()=>i("migrateSortSettings",{sortBy:(o+1)%2,sortOrder:d}),children:o?e.jsx(Tt,{}):e.jsx(Ct,{})})}),e.jsx(U,{title:t(Qe[d]),children:e.jsx(D,{size:"large",color:"inherit",onClick:()=>i("migrateSortSettings",{sortBy:o,sortOrder:(d+1)%2}),children:d?e.jsx(gt,{}):e.jsx(mt,{})})})]}),e.jsx(Ye,{sx:{p:0},children:S.map(u=>e.jsx(ge,{children:e.jsx(Nt,{...u})},u.id))})]})};function is(){const{t:r}=N(),{setTitle:t}=Y();h.useLayoutEffect(()=>{t(r("global.label.browse"))},[r]);const n=h.useRef(null),[c,i]=h.useState(0);Je(n,h.useCallback(()=>i(n.current.offsetHeight),[n.current]));const[o,d]=Me("tab",Re,{}),a=o!=null?o:"source";return o||d(a,"replaceIn"),e.jsxs(pt,{children:[e.jsxs(Ze,{ref:n,variant:"fullWidth",value:a,onChange:(x,s)=>d(s,"replaceIn"),children:[e.jsx(ae,{value:"source",sx:{textTransform:"none"},label:r("source.title_one")}),e.jsx(ae,{value:"extensions",sx:{textTransform:"none"},label:r("extension.title_other")}),e.jsx(ae,{value:"migrate",sx:{textTransform:"none"},label:r("migrate.title")})]}),e.jsx(ie,{index:"source",currentIndex:a,children:e.jsx(wt,{})}),e.jsx(ie,{index:"extensions",currentIndex:a,children:e.jsx(yt,{tabsMenuHeight:c})}),e.jsx(ie,{index:"migrate",currentIndex:a,children:e.jsx(At,{tabsMenuHeight:c})})]})}export{is as Browse};
