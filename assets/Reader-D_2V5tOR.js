import{c as r,j as t,B as z,a as H,af as F,r as oe,i as ie,w as wt,a4 as Rt,ag as Et,a2 as we,ah as bt,ai as yt,aj as Ve,s as J,I as Q,u as at,e as st,ak as ot,al as Pt,am as Lt,f as re,T as St,an as Dt,V as jt,ao as Tt,Q as Xe,ap as kt,W as _t,aq as Ot,ar as Ke,p as Ue,N as At,m as Ge,h as X,Y as Nt,E as Ye,as as It,at as $t}from"./index-D56_pS91.js";import{b as K,C as O}from"./Chapters-CfoVZ7FV.js";import{P as ue,i as Wt,R as Mt,u as zt,g as Ze,c as Ft}from"./ReaderSettingsOptions-ZS8NRCKI.js";import{S as Qe}from"./SpinnerImage-DLNmpb9Y.js";import{S as Je}from"./Select-BJV3xZV3.js";import{C as Ht}from"./Collapse-DR-SUXX_.js";import{a as et}from"./TextField-BRxbzYTt.js";import{u as Bt}from"./useDebounce-AimVdpXL.js";import"./NumberSetting-IQhNJeTv.js";import"./Info-_ESknuaY.js";import"./InputAdornment-1xSlMNIW.js";import"./Switch-Dpsb1ojK.js";import"./SwitchBase-C3mDf01C.js";const qt=i=>{for(let n=0;n<i.children.length;n++){const o=i.children.item(n);if(o){const{left:p,right:l}=o.getBoundingClientRect();if(p<=window.innerWidth/2&&l>window.innerWidth/2)return n}}return-1},Vt=5,Xt=()=>window.innerWidth+window.scrollX>=document.body.scrollWidth-Vt,Kt=()=>window.scrollX<=0;function Ut(i){const{pages:n,curPage:o,initialPage:p,settings:l,setCurPage:s,prevChapter:d,nextChapter:x}=i,g=r.useRef(p),u=r.useRef(null),m=r.useRef([]);function L(){var f;o<n.length-1?((f=m.current[o+1])==null||f.scrollIntoView({inline:"center"}),s(e=>e+1)):l.loadNextOnEnding&&x()}function h(){var f;o>0?((f=m.current[o-1])==null||f.scrollIntoView({inline:"center"}),s(o-1)):o===0&&d()}function P(){l.readerType==="ContinuesHorizontalLTR"?h():L()}function S(){l.readerType==="ContinuesHorizontalLTR"?L():h()}const b=r.useRef(0);function c(f){window.scrollBy(b.current-f.pageX,0)}function a(f){var e;b.current=f.pageX,(e=u.current)==null||e.addEventListener("mousemove",c)}function E(){var f;(f=u.current)==null||f.removeEventListener("mousemove",c)}function T(f){f.clientX>=window.innerWidth*.85?S():f.clientX<=window.innerWidth*.15&&P()}const _=()=>{l.readerType==="ContinuesHorizontalLTR"?window.scrollX+window.innerWidth>=document.body.scrollWidth&&x():l.readerType==="ContinuesHorizontalRTL"&&window.scrollX<=window.innerWidth&&x()};return r.useLayoutEffect(()=>{const f=m.current[p];if(!f)return()=>{};const e=new ResizeObserver(()=>{f.offsetHeight&&(f.scrollIntoView({inline:"center"}),e.disconnect())});return e.observe(f),()=>e.disconnect()},[p]),r.useEffect(()=>{var f,e;return(f=u.current)==null||f.addEventListener("mousedown",a),(e=u.current)==null||e.addEventListener("mouseup",E),()=>{var v,I;(v=u.current)==null||v.removeEventListener("mousedown",a),(I=u.current)==null||I.removeEventListener("mouseup",E)}},[u]),r.useEffect(()=>(l.loadNextOnEnding&&document.addEventListener("scroll",_),()=>{document.removeEventListener("scroll",_)}),[u,o,d,x]),r.useEffect(()=>{const f=()=>{if(!u.current)return;const e=qt(u.current);e!==g.current&&(g.current=e,s(e)),(l.readerType==="ContinuesHorizontalLTR"?Xt():Kt())&&(g.current=n.length-1,s(g.current))};return window.addEventListener("scroll",f),()=>window.removeEventListener("scroll",f)},[l.readerType]),t.jsx(z,{ref:u,sx:{display:"flex",flexDirection:l.readerType==="ContinuesHorizontalLTR"?"row":"row-reverse",justifyContent:l.readerType==="ContinuesHorizontalLTR"?"flex-start":"flex-end",width:"auto",height:"auto",overflowX:"visible",userSelect:"none"},onClick:T,children:n.map(f=>t.jsx(ue,{index:f.index,src:f.src,onImageLoad:()=>{},settings:l,ref:e=>{m.current[f.index]=e}},f.index))})}function Gt(i){const{settings:n,curPage:o,pageCount:p}=i;return t.jsx(z,{sx:{display:n.showPageNumber?"block":"none",position:"fixed",bottom:"50px",padding:"2px",paddingLeft:"4px",paddingRight:"4px",textAlign:"center",backgroundColor:"rgba(0, 0, 0, 0.3)",borderRadius:"10px"},children:"".concat(o+1," / ").concat(p)})}function Yt(i){const{pages:n,settings:o,setCurPage:p,initialPage:l,curPage:s,nextChapter:d,prevChapter:x,chapter:g}=i,u=r.useRef(null);r.useEffect(()=>{const a=n.map(E=>{const T=H.requestImage(E.src);return T.response.catch(()=>{}),T});return()=>{a.forEach(E=>E.abortRequest(new Error("PagedPager::preload: chapter changed")))}},[g.id]);const m=a=>{p(a),window.scroll({top:0})};function L(){s<n.length-1?m(s+1):o.loadNextOnEnding&&d()}function h(){s>0?m(s-1):x()}function P(){o.readerType==="SingleLTR"?h():o.readerType==="SingleRTL"&&L()}function S(){o.readerType==="SingleLTR"?L():o.readerType==="SingleRTL"&&h()}function b(a){switch(a.key){case"Space":a.preventDefault(),L();break;case"ArrowRight":S();break;case"ArrowLeft":P();break}}function c(a){a.clientX>window.innerWidth/2?S():P()}return r.useEffect(()=>(document.addEventListener("keydown",b),()=>{document.removeEventListener("keydown",b)}),[u,s,o.readerType,x,d]),r.useEffect(()=>{setTimeout(()=>{m(l)},0)},[l]),t.jsx(z,{ref:u,sx:{display:"flex",flexDirection:"column",justifyContent:"center",width:"auto",height:"auto"},onClick:c,children:t.jsx(ue,{index:s,onImageLoad:()=>{},src:n[s].src,settings:o},s)})}const Zt=r.forwardRef((i,n)=>{const{image1src:o,image2src:p,index:l,onImageLoad:s,settings:d}=i,x=Wt(d),g={...x,width:d.fitPageToWindow?x.width:"calc(".concat(x.width," * 0.5)"),minWidth:d.fitPageToWindow&&d.scalePage?"calc(".concat(x.minWidth," * 0.5)"):x.minWidth,maxWidth:d.fitPageToWindow?"calc(".concat(x.maxWidth," * 0.5)"):x.maxWidth},u={...g,height:"100vh",width:"50%",backgroundColor:"#525252"};return t.jsxs(z,{ref:n,sx:{display:"flex",flexDirection:d.readerType==="DoubleLTR"?"row":"row-reverse",justifyContent:"center",width:"100%"},children:[t.jsx(Qe,{src:o,onImageLoad:s,alt:"Page #".concat(l),spinnerStyle:u,imgStyle:{...g,objectPosition:d.readerType==="DoubleLTR"?F("right","left"):F("left","right")}}),t.jsx(Qe,{src:p,onImageLoad:s,alt:"Page #".concat(l+1),spinnerStyle:{...u,width:"calc(50% - 5px)",marginLeft:"5px"},imgStyle:{...g,objectPosition:d.readerType==="DoubleLTR"?F("left","right"):F("right","left")}})]})}),Qt=i=>i.height/i.width<1,Re=(i,n,o)=>{if(n[i]||n[i+1]||i===n.length-1)return!0;const p=n.lastIndexOf(!0,i-1),l=i-(p+1);return o?l%2===0:l%2===1};function Jt(i){const{pages:n,settings:o,setCurPage:p,initialPage:l,curPage:s,chapter:d,nextChapter:x,prevChapter:g}=i,u=r.useRef(null),[m,L]=r.useState(Array(n.length).fill(!1)),[h,P]=r.useState(Array(n.length).fill(!1));function S(){let e=1;if(s<n.length&&h[s]&&(e=1,m[s]))return e;if(s+1<n.length&&h[s+1]){if(Re(s,m,o.offsetFirstPage))return e;e=2}return e}function b(){return Re(s-2,m,o.offsetFirstPage)?1:2}function c(){if(s<n.length-1){const e=s+S();p(e>=n.length?n.length-1:e)}else o.loadNextOnEnding&&x()}function a(){if(s>0){const e=s-b();p(e<0?0:e)}else g()}function E(){o.readerType==="DoubleLTR"?a():c()}function T(){o.readerType==="DoubleLTR"?c():a()}function _(e){switch(e.key){case"Space":e.preventDefault(),c();break;case"ArrowRight":T();break;case"ArrowLeft":E();break}}function f(e){e.clientX>window.innerWidth/2?T():E()}return r.useEffect(()=>(document.addEventListener("keydown",_),()=>{document.removeEventListener("keydown",_)}),[u,s,o.readerType,g,x,h,m]),r.useEffect(()=>{p(l)},[l]),r.useEffect(()=>{o.offsetFirstPage?S()===2&&p(s+1):s>0&&!Re(s-1,m,o.offsetFirstPage)&&p(s-1)},[o.offsetFirstPage]),r.useEffect(()=>{const e=n.map(v=>[v.index,H.requestImage(v.src)]);return e.forEach(async([v,I])=>{try{const N=await I.response,$=new Image;$.onload=()=>{URL.revokeObjectURL(N),P(A=>A.toSpliced(v,1,!0)),L(A=>A.toSpliced(v,1,Qt($)))},$.src=N}catch(N){}}),()=>{e.forEach(([v,I])=>I.abortRequest(new Error("DoublePagedPager::preload(".concat(v,"): chapter changed"))))}},[d.id]),t.jsx(z,{ref:u,onClick:f,children:t.jsx(z,{id:"display",sx:{display:"flex",flexDirection:o.readerType==="DoubleLTR"?"row":"row-reverse",justifyContent:"center",width:"auto",height:"auto"},children:S()===2?t.jsx(Zt,{index:s,image1src:n[s].src,image2src:n[s+1].src,settings:o},s):t.jsx(ue,{index:s,src:n[s].src,onImageLoad:()=>{},settings:o},s)})})}const er=i=>{for(let n=0;n<i.children.length;n++){const o=i.children.item(n);if(o){const{top:p,bottom:l}=o.getBoundingClientRect();if(p<=window.innerHeight&&l>1)return n}}return-1},tr=5,rr=.95,tt=.25,nr="smooth",rt=()=>window.innerHeight+window.scrollY>=document.body.offsetHeight-tr,ar=()=>window.scrollY<=0;function nt(i){const{pages:n,settings:o,setCurPage:p,initialPage:l,nextChapter:s,prevChapter:d}=i,x=r.useRef(l),g=r.useRef(null),u=r.useRef([]);r.useEffect(()=>{let c=!1;const a=()=>{if(g.current)if(rt()){if(c)return;c=!0,x.current=n.length-1,p(x.current),o.loadNextOnEnding&&s()}else{c=!1;const E=er(g.current);E!==x.current&&(x.current=E,p(E))}};return window.addEventListener("scroll",a),()=>{window.removeEventListener("scroll",a)}},[o.loadNextOnEnding,s]);const m=r.useRef(0),L=r.useRef(!1);function h(c){L.current=!0,window.scrollBy(0,m.current-c.pageY)}function P(c){var a;m.current=c.pageY,(a=g.current)==null||a.addEventListener("mousemove",h)}function S(){var c;(c=g.current)==null||c.removeEventListener("mousemove",h)}r.useEffect(()=>{var c,a;return(c=g.current)==null||c.addEventListener("mousedown",P),(a=g.current)==null||a.addEventListener("mouseup",S),()=>{var E,T;(E=g.current)==null||E.removeEventListener("mousedown",P),(T=g.current)==null||T.removeEventListener("mouseup",S)}},[g]);const b=r.useCallback((c,a=rr)=>{if(c==="down"&&rt()){s();return}if(c==="up"&&ar()){d();return}window.scroll({top:window.scrollY+window.innerHeight*a*(c==="up"?-1:1),behavior:nr})},[s,d]);return r.useEffect(()=>{const c=a=>{switch(a.key){case"Space":a.preventDefault(),b(a.shiftKey?"up":"down");break;case"ArrowDown":a.preventDefault(),b(a.shiftKey?"up":"down",tt);break;case"ArrowRight":a.preventDefault(),b(a.shiftKey?"up":"down");break;case"ArrowUp":a.preventDefault(),b(a.shiftKey?"down":"up",tt);break;case"ArrowLeft":a.preventDefault(),b(a.shiftKey?"down":"up");break}};return document.addEventListener("keydown",c,!1),()=>{document.removeEventListener("keydown",c)}},[b]),r.useLayoutEffect(()=>{const c=u.current[l];if(!c)return()=>{};const a=new ResizeObserver(()=>{c.offsetHeight&&(c.scrollIntoView(),a.disconnect())});return a.observe(c),()=>a.disconnect()},[l]),t.jsx(z,{ref:g,sx:{display:"flex",flexDirection:"column",justifyContent:"center",width:"auto",height:"auto",userSelect:"none"},onClick:c=>{if(L.current){L.current=!1;return}b(c.clientX>window.innerWidth/2?"down":"up")},children:n.map(c=>t.jsx(ue,{index:c.index,src:c.src,onImageLoad:()=>{},settings:o,ref:a=>{u.current[c.index]=a}},c.index))})}var Ee={},sr=ie;Object.defineProperty(Ee,"__esModule",{value:!0});var it=Ee.default=void 0,or=sr(oe()),ir=t;it=Ee.default=(0,or.default)((0,ir.jsx)("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Close");var be={},cr=ie;Object.defineProperty(be,"__esModule",{value:!0});var ae=be.default=void 0,lr=cr(oe()),dr=t;ae=be.default=(0,lr.default)((0,dr.jsx)("path",{d:"M15.41 16.59 10.83 12l4.58-4.59L14 6l-6 6 6 6z"}),"KeyboardArrowLeft");var ye={},ur=ie;Object.defineProperty(ye,"__esModule",{value:!0});var se=ye.default=void 0,fr=ur(oe()),pr=t;se=ye.default=(0,fr.default)((0,pr.jsx)("path",{d:"M8.59 16.59 13.17 12 8.59 7.41 10 6l6 6-6 6z"}),"KeyboardArrowRight");var Pe={},gr=ie;Object.defineProperty(Pe,"__esModule",{value:!0});var ct=Pe.default=void 0,hr=gr(oe()),xr=t;ct=Pe.default=(0,hr.default)((0,xr.jsx)("path",{d:"M7.41 8.59 12 13.17l4.59-4.58L18 10l-6 6-6-6z"}),"KeyboardArrowDown");var Le={},mr=ie;Object.defineProperty(Le,"__esModule",{value:!0});var lt=Le.default=void 0,vr=mr(oe()),Cr=t;lt=Le.default=(0,vr.default)((0,Cr.jsx)("path",{d:"M7.41 15.41 12 10.83l4.59 4.58L18 14l-6-6-6 6z"}),"KeyboardArrowUp");const wr=["addEndListener","appear","children","easing","in","onEnter","onEntered","onEntering","onExit","onExited","onExiting","style","timeout","TransitionComponent"],Rr={entering:{transform:"none"},entered:{transform:"none"}},Er=r.forwardRef(function(n,o){const p=wt(),l={enter:p.transitions.duration.enteringScreen,exit:p.transitions.duration.leavingScreen},{addEndListener:s,appear:d=!0,children:x,easing:g,in:u,onEnter:m,onEntered:L,onEntering:h,onExit:P,onExited:S,onExiting:b,style:c,timeout:a=l,TransitionComponent:E=bt}=n,T=Rt(n,wr),_=r.useRef(null),f=Et(_,x.ref,o),e=w=>D=>{if(w){const C=_.current;D===void 0?w(C):w(C,D)}},v=e(h),I=e((w,D)=>{yt(w);const C=Ve({style:c,timeout:a,easing:g},{mode:"enter"});w.style.webkitTransition=p.transitions.create("transform",C),w.style.transition=p.transitions.create("transform",C),m&&m(w,D)}),N=e(L),$=e(b),A=e(w=>{const D=Ve({style:c,timeout:a,easing:g},{mode:"exit"});w.style.webkitTransition=p.transitions.create("transform",D),w.style.transition=p.transitions.create("transform",D),P&&P(w)}),ee=e(S),B=w=>{s&&s(_.current,w)};return t.jsx(E,we({appear:d,in:u,nodeRef:_,onEnter:I,onEntered:N,onEntering:v,onExit:A,onExited:ee,onExiting:$,addEndListener:B,timeout:a},T,{children:(w,D)=>r.cloneElement(x,we({style:we({transform:"scale(0)",visibility:w==="exited"&&!u?"hidden":void 0},Rr[w],c,x.props.style),ref:f},D))}))}),br=Er,yr=J("div")({zIndex:10}),Pr=J("div")(({theme:i})=>({top:0,left:0,width:"300px",minWidth:"300px",height:"100vh",overflowY:"auto",backgroundColor:i.palette.background.default,"& header":{backgroundColor:i.palette.action.hover,display:"flex",alignItems:"center",minHeight:"64px",paddingLeft:"24px",paddingRight:"24px",transition:"left 2s ease","& button":{flexGrow:0,flexShrink:0},"& button:nth-child(1)":{marginRight:"16px"},"& h1":{fontSize:"1.25rem",flexGrow:1}}})),Lr=J("div")({margin:"0 16px","& > span:nth-child(1)":{textAlign:"center",display:"block",marginTop:"16px"}}),Sr=J("div")({display:"flex",flexWrap:"wrap",alignContent:"center",alignItems:"center",justifyContent:"center"}),Dr=J("div")({display:"grid",gridTemplateRows:"auto auto auto",gridTemplateColumns:"0fr 1fr 0fr",gridTemplateAreas:'"pre current next"',gridColumnGap:"5px",margin:"10px 0","& a":{textDecoration:"none",color:"inherit",display:"flex",flexWrap:"wrap",alignContent:"center"}}),jr=J(Q)(({theme:i})=>({position:"fixed",top:20,left:30,height:"40px",width:"40px",borderRadius:5,backgroundColor:i.palette.custom.main,"&:hover":{backgroundColor:i.palette.custom.light}}));function Tr(i){var D;const{t:n}=at(),o=st(),p=ot(),{prevDrawerOpen:l,prevSettingsCollapseOpen:s}=(D=p.state)!=null?D:{},{settings:d,setSettingValue:x,manga:g,chapter:u,chapters:m,curPage:L,scrollToPage:h,openNextChapter:P,retrievingNextChapter:S}=i,b=Pt(),c=r.useMemo(()=>new Set(m.map(({scanlator:C})=>C)).size>1,[m]),[a,E]=r.useState(d.staticNav||l),[T,_]=r.useState(!0),[f,e]=r.useState(d.staticNav||l),[v,I]=r.useState(0),[N,$]=r.useState(s!=null?s:!0),A=S,ee=(C,k,q)=>{_(C!=="staticNav"),x(C,k,q)},B=C=>{E(C),e(C)},w=()=>{const C=window.pageYOffset;Math.abs(C-v)>20&&(e(C>v),I(C))};return r.useEffect(()=>{T&&B(d.staticNav)},[d.staticNav]),r.useEffect(()=>{window.addEventListener("scroll",w);const C=document.querySelector("#root"),k=document.querySelector("#appMainContainer");return C.style.display="flex",C.style.flexDirection="column",k.style.display="none",()=>{C.style.display="block",k.style.display="block",window.removeEventListener("scroll",w)}},[w]),t.jsxs(yr,{children:[t.jsx(Lt,{direction:F("right","left"),in:a,timeout:200,appear:!1,mountOnEnter:!0,unmountOnExit:!0,children:t.jsxs(Pr,{sx:{position:"fixed"},children:[t.jsxs("header",{children:[!d.staticNav&&t.jsx(re,{title:n("reader.button.close_menu"),children:t.jsx(Q,{edge:"start",color:"inherit","aria-label":"menu",onClick:()=>B(!1),size:"large",children:F(t.jsx(ae,{}),t.jsx(se,{}))})}),t.jsx(St,{variant:"h1",textOverflow:"ellipsis",overflow:"hidden",sx:{py:1},children:u.name}),t.jsx(re,{title:n("reader.button.exit"),children:t.jsx(Q,{edge:"start",color:"inherit","aria-label":"menu",onClick:b,size:"large",sx:{mr:-1},children:t.jsx(it,{})})})]}),t.jsxs(Dt,{ContainerComponent:"div",sx:{"& span":{fontWeight:"bold"}},children:[t.jsx(jt,{primary:n("reader.settings.title.reader_settings")}),t.jsxs(Q,{edge:"start",color:"inherit","aria-label":"menu",disableRipple:!0,disableFocusRipple:!0,onClick:()=>$(!N),size:"large",children:[N&&t.jsx(lt,{}),!N&&t.jsx(ct,{})]})]}),t.jsx(Ht,{in:N,timeout:"auto",unmountOnExit:!0,children:t.jsx(Mt,{setSettingValue:ee,staticNav:d.staticNav,showPageNumber:d.showPageNumber,loadNextOnEnding:d.loadNextOnEnding,skipDupChapters:d.skipDupChapters,fitPageToWindow:d.fitPageToWindow,scalePage:d.scalePage,readerType:d.readerType,offsetFirstPage:d.offsetFirstPage,readerWidth:d.readerWidth})}),t.jsx(Tt,{sx:{my:1,mx:2}}),t.jsxs(Lr,{children:[t.jsxs(Sr,{children:[t.jsx("span",{children:n("reader.page_info.label.currently_on_page")}),t.jsx(et,{size:"small",sx:{margin:"0 5px"},disabled:A||u.pageCount===-1,children:t.jsx(Je,{value:u.pageCount>-1?"".concat(L):"",displayEmpty:!0,onChange:({target:{value:C}})=>{h(Number(C))},children:Array(Math.max(0,u.pageCount)).fill(1).map((C,k)=>t.jsx(Xe,{value:k,children:k+1},"Page#".concat(k)))})}),t.jsx("span",{children:n("reader.page_info.label.of_max_pages",{maxPages:u.pageCount})})]}),t.jsxs(Dr,{children:[t.jsx(re,{title:n("reader.button.previous_chapter"),children:t.jsx(Q,{sx:{gridArea:"pre"},disabled:A||u.sourceOrder<=1,onClick:()=>P(K.PREV),children:F(t.jsx(ae,{}),t.jsx(se,{}))})}),t.jsx(et,{sx:{gridArea:"current"},size:"small",disabled:A||u.sourceOrder<1,children:t.jsx(Je,{value:u.sourceOrder>=1?"".concat(u.sourceOrder):"",displayEmpty:!0,onChange:({target:{value:C}})=>{o("/manga/".concat(g.id,"/chapter/").concat(C),{replace:!0,state:{prevDrawerOpen:a,prevSettingsCollapseOpen:N}})},children:m.map(({id:C,sourceOrder:k,name:q,chapterNumber:fe,scanlator:te})=>t.jsx(Xe,{value:k,children:"#".concat(fe).concat(c&&te!=null?" (".concat(te,")"):""," | ").concat(q)},C))})}),t.jsx(re,{title:n("reader.button.next_chapter"),children:t.jsx(Q,{sx:{gridArea:"next"},disabled:A||u.sourceOrder<1||u.sourceOrder>=g.chapters.totalCount,onClick:()=>P(K.NEXT),children:F(t.jsx(se,{}),t.jsx(ae,{}))})})]})]})]})}),t.jsx(br,{in:!a,children:t.jsx(kt,{in:!f,children:t.jsx(re,{title:n("reader.button.open_menu"),children:t.jsx(jr,{edge:"start","aria-label":"menu",disableRipple:!0,disableFocusRipple:!0,onClick:()=>B(!0),size:"large",children:F(t.jsx(se,{}),t.jsx(ae,{}))})})})})]})}const ne=i=>O.getFromCache(i,It,"CHAPTER_READER_FIELDS"),kr=i=>{switch(i){case"ContinuesVertical":case"Webtoon":return nt;case"SingleVertical":case"SingleRTL":case"SingleLTR":return Yt;case"DoubleVertical":case"DoubleRTL":case"DoubleLTR":return Jt;case"ContinuesHorizontalLTR":case"ContinuesHorizontalRTL":return Ut;default:return nt}},_r=i=>Array.from({length:i},(n,o)=>o),Z={pageCount:-1,sourceOrder:-1,chapterCount:0,lastPageRead:0,name:"Loading...",manga:{id:-1}};function Kr(){var Ie,$e,We,Me,ze,Fe,He,Be;const{t:i}=at(),n=st(),o=ot(),{chapterIndex:p,mangaId:l}=_t(),s=r.useMemo(()=>({id:+l,title:"",thumbnailUrl:"",genre:[],inLibraryAt:0,lastReadAt:0,chapters:{totalCount:0},trackRecords:{totalCount:0}}),[l]),{data:d,loading:x,error:g,refetch:u}=H.useGetManga(Ot,l),m=r.useRef(null),L=Number(l)===((Ie=m.current)==null?void 0:Ie.mangaId)&&Number(p)===(($e=m.current)==null?void 0:$e.sourceOrder)&&((We=m.current)==null?void 0:We.pageCount)!==-1,h=(Me=d==null?void 0:d.manga)!=null?Me:s,{data:P,loading:S,error:b,refetch:c}=H.useGetChapters(Ke,{condition:{mangaId:Number(l),sourceOrder:Number(p)}},{notifyOnNetworkStatusChange:!0}),a=P==null?void 0:P.chapters.nodes[0],E=r.useRef(!1),{settings:{downloadAheadLimit:T}}=Ue(),_=!!T,f=()=>{var M;return m.current&&L?a&&((M=m.current)==null?void 0:M.pageCount)!==a.pageCount?a:m.current:(E.current=!1,a||null)};m.current=f();const e=(ze=m.current)!=null?ze:Z,v=r.useRef(Z);v.current===Z&&(v.current=e),e.mangaId!==((Fe=v.current)==null?void 0:Fe.mangaId)&&(v.current=Z);const[I,{loading:N,error:$}]=H.useGetChapterPagesFetch(e.id),A=()=>{!S&&!e.isDownloaded?I().then(()=>{E.current=!0}).catch(X()):E.current=!0};r.useEffect(()=>{A()},[e.id]);const[ee,B]=r.useState(!1),[w,D]=r.useState(0),C=w===e.pageCount-1,k=Bt(w,C?0:1e3),[q,fe]=r.useState(void 0),{setOverride:te,setTitle:Se}=r.useContext(At),[De,je]=r.useState(!1),{data:pe,loading:dt,error:Te,refetch:ut}=H.useGetMangaChapters(Ke,l,{nextFetchPolicy:"standby"}),R=pe==null?void 0:pe.chapters.nodes,ge=x||S||dt||N||!E.current&&!b&&!$,ke=(Be=(He=g!=null?g:b)!=null?He:Te)!=null?Be:$,{settings:he,loading:_e}=zt(),[y,Oe]=r.useState(Ze(h,he)),{settings:ce}=Ue(),Ae=r.useMemo(()=>y.skipDupChapters?O.removeDuplicates(v.current,R!=null?R:[]):R!=null?R:[],[v.current,R,y.skipDupChapters]),ft=r.useMemo(()=>O.getNextChapters(e,R!=null?R:[],{offset:K.PREV,skipDupe:y.skipDupChapters,skipDupeChapter:v.current}),[e,v.current,R,y.skipDupChapters]),pt=r.useMemo(()=>O.getNextChapters(e,R!=null?R:[],{skipDupe:y.skipDupChapters,skipDupeChapter:v.current}),[e,v.current,R,y.skipDupChapters]),le=r.useMemo(()=>O.getNextChapter(e,R!=null?R:[],{offset:K.PREV,skipDupe:y.skipDupChapters,skipDupeChapter:v.current}),[e,v.current,R,y.skipDupChapters]),U=r.useMemo(()=>O.getNextChapter(e,R!=null?R:[],{skipDupe:y.skipDupChapters,skipDupeChapter:v.current}),[e,v.current,R,y.skipDupChapters]),Ne=j=>{if(e===Z)return;const W=()=>{if(!(!!j.isRead&&!!ce.deleteChaptersWhileReading)||!R)return[];const Y=[e,...ft][ce.deleteChaptersWhileReading-1];if(!Y)return[];const me=ne(Y.id);return me.isRead&&O.isDeletable(me,ce.deleteChaptersWithBookmark)?y.skipDupChapters?O.getIds(O.addDuplicates([Y],R)):O.getIds([Y]):[]};(()=>{var ve;const de=ne(e.id),Y=((ve=j.lastPageRead)!=null?ve:0)/e.pageCount>.25;if(_&&h.inLibrary&&!!(de!=null&&de.isDownloaded)&&Y){const Ce=U?ne(U.id):null;if(!(Ce!=null&&Ce.isDownloaded))return;const qe=O.getNonRead(pt).map(V=>ne(V.id)).slice(-T).filter(V=>!V.isDownloaded).map(V=>V.id).filter(V=>!O.isDownloading(V));if(!qe.length)return;O.download(qe).catch(X())}})();const xe=y.skipDupChapters?O.getIds(O.addDuplicates([e],R!=null?R:[e])):[e.id];H.updateChapters(xe,{...j,chapterIdsToDelete:W(),trackProgressMangaId:ce.updateProgressAfterReading&&j.isRead&&h.trackRecords.totalCount?h.id:void 0},{errorPolicy:"all"}).response.catch(X())},gt=(j,W,M=!0)=>{Oe({...y,[j]:W}),M&&$t(h,[[j,W]]).catch(()=>Ge(i("reader.settings.error.label.failed_to_save_settings"),"warning"))},G=r.useCallback(j=>{const W=j===K.NEXT,M=W?U:le;if(!M){Ge(i(W?"reader.error.label.next_chapter_does_not_exist":"reader.error.label.prev_chapter_does_not_exist"),"error");return}je(!0),D(0),n("/manga/".concat(h.id,"/chapter/").concat(M.sourceOrder),{replace:!0,state:o.state}),je(!1)},[h.id,le==null?void 0:le.id,U==null?void 0:U.id]);r.useEffect(()=>{if(ge||!e){D(0);return}B(!0),e.lastPageRead===e.pageCount-1?D(0):D(e.lastPageRead)},[e,ge]),r.useEffect(()=>{!(h!=null&&h.title)||e.name===i("global.label.loading")?Se(i("reader.title")):Se("".concat(h.title,": ").concat(e.name))},[i,h,e]),r.useEffect(()=>{!_e&&!x&&(Ft(h,"manga",he).catch(X()),Oe(Ze(h,he)))},[_e,x]),r.useEffect(()=>(te({status:!0,value:t.jsx(Tr,{settings:y,setSettingValue:gt,manga:h,chapter:e,chapters:Ae,curPage:w,scrollToPage:fe,openNextChapter:G,retrievingNextChapter:De})}),()=>te({status:!1,value:t.jsx("div",{})})),[h,e,y,w,p,De,G,Ae]),r.useEffect(()=>{if(!ee||e===Z)return;const j=ne(e.id);if(k===(j==null?void 0:j.lastPageRead))return;const W=k!==-1,M=k===e.pageCount-1;(W||M)&&Ne({lastPageRead:W?k:void 0,isRead:M?!0:void 0})},[k,_]);const ht=r.useCallback(()=>{Ne({lastPageRead:e.pageCount-1,isRead:!0}),G(K.NEXT)},[e.pageCount,G,e,h]),xt=r.useCallback(()=>{G(K.PREV)},[G]);if(ge)return t.jsx(z,{sx:{height:"100vh",width:"100vw",display:"grid",placeItems:"center"},children:t.jsx(Nt,{thickness:5})});if(ke)return t.jsx(Ye,{message:i("global.error.label.failed_to_load_data"),messageExtra:ke.message,retry:()=>{g&&u().catch(X()),b&&c().catch(X()),Te&&ut().catch(X()),$&&A()}});if(!e.pageCount)return t.jsx(Ye,{message:i("reader.error.label.no_pages_found"),retry:A});const mt=_r(e.pageCount).map(j=>({index:j,src:H.getChapterPageUrl(l,p,j)})),vt=kr(y.readerType),Ct=q!=null?q:e.lastPageRead===e.pageCount-1?0:e.lastPageRead;return t.jsxs(z,{sx:{display:"flex",flexDirection:"column",alignContent:"center",alignItems:"center",justifyContent:"center",minWidth:y.staticNav?"calc((100vw - (100vw - 100%)) - 300px)":"calc(100vw - (100vw - 100%))",minHeight:"100vh",marginLeft:y.staticNav?"300px":"unset"},children:[t.jsx(Gt,{settings:y,curPage:w,pageCount:e.pageCount}),t.jsx(z,{sx:{alignSelf:"stretch"},children:t.jsx(vt,{pages:mt,pageCount:e.pageCount,setCurPage:D,initialPage:Ct,curPage:w,settings:y,manga:h,chapter:e,nextChapter:ht,prevChapter:xt},e.id)})]})}export{Kr as Reader};
