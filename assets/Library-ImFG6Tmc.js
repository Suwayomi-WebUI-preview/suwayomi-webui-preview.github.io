import{V as je,f as u,W as Te,X as _e,k as O,u as I,r as D,Y as Me,e as G,j as t,Z as B,_ as Ae,$ as w,a0 as A,F as Fe,m as ne,g as ie,C as ge,I as Be,y as P,z as ue,E as z,a1 as Le,a2 as Ie,a3 as ve,a4 as we,G as Re,B as Ee,A as Oe,L as De,a5 as Ge,i as Ne,a6 as Ue}from"./index-LuRfpAul.js";import{E as ce}from"./EmptyViewAbsoluteCentered-CG8OzJNr.js";import{T as Pe,a as ze}from"./Tabs-CiQfn4Rl.js";import{F as Ye}from"./FilterList-Cc5JqZGL.js";import{C as R}from"./CheckboxInput-DNi2D9mP.js";import{S as We,R as U}from"./SortRadioInput-Cu-UeZHB.js";import{T as _}from"./ThreeStateCheckboxInput-CCNOEL4t.js";import{O as Ve,S as Ke,a as Je}from"./SelectionFAB-DSJyISs-.js";import{T as Qe}from"./Trackers-Bgo8y--2.js";import{M as $e,a as He}from"./Mangas-3OGaa-Ji.js";import{R as Xe}from"./ListPreference-BaOoz4jP.js";import{M as Ze,a as qe}from"./MangaGrid-CdddHnpw.js";import{A as et}from"./AppbarSearch-DYSjGB7u.js";import{C as tt,U as at}from"./UpdateChecker-CTfJIriY.js";import{u as st}from"./useManageMangaLibraryState-KaKmbQNX.js";import{C as rt}from"./Checkbox-BZmjBZWi.js";import{e as Y}from"./Strings-CAV0u705.js";import{T as ot}from"./TabsMenu-B5czBOXz.js";import{T as lt}from"./TabsWrapper-DmERBDHl.js";import{u as nt}from"./useAppTitle-BLkwhwB5.js";import{u as it}from"./useAppAction-DDskQL_S.js";import{C as ct}from"./Chip-CpRZiERU.js";import"./StyledFab-Di1pyMCC.js";import"./Chapters-BRAm19f6.js";import"./DateHelper-BCdsAYO-.js";import"./Asserts-DNMCi6ar.js";import"./FormGroup-CXSbTVhE.js";import"./SwitchBase-8hP1GUdL.js";import"./Delete-C39Fxflk.js";import"./Download-BibP4BOt.js";import"./ContinueReadingTooltip-bdIHl0MF.js";import"./AvatarSpinner-Ba0ZbUec.js";import"./SpinnerImage-Bx512Ifd.js";import"./Refresh-D4vYYVyG.js";import"./Image-Bn5kOV6B.js";import"./Card-Cn142Txi.js";import"./ListCardContent-BNA9FzJm.js";import"./CheckCircle-DnxvzzEv.js";import"./Metadata-nlXIQKzQ.js";import"./MUI.util-CEodEA2f.js";import"./CardActionArea-CfK54VWb.js";import"./Link-EgZtWGSp.js";import"./NumberSetting-Bifm9KJA.js";import"./Slider--oKI9R4X.js";import"./useMobilePicker-DI2whiFT.js";import"./SelectSetting-F4IFr8hg.js";import"./Select-BydMHwoW.js";import"./Sync-D7PD4seM.js";import"./use-merged-ref-DTm_2N0b.js";import"./ListCardAvatar-C_wP0WZH.js";import"./PlayArrow-YllcmED0.js";import"./index-DSrzPTbQ.js";import"./Virtuoso.util-BNN2EJ6V.js";import"./Progress-D019vzkE.js";const dt={sortDesc:void 0,sortBy:void 0,hasDownloadedChapters:void 0,hasBookmarkedChapters:void 0,hasUnreadChapters:void 0,hasReadChapters:void 0,hasDuplicateChapters:void 0,hasTrackerBinding:{},hasStatus:{}},ht=e=>({...e,hasTrackerBinding:e.hasTrackerBinding?JSON.stringify(e.hasTrackerBinding):void 0,hasStatus:e.hasStatus?JSON.stringify(e.hasStatus):void 0}),pt=(e,s=dt,o)=>je("category",e,s,void 0,o),me=(e,s,o)=>pt({...e,meta:Te(e.meta)},s,o),gt=(e,s)=>me(e,s),be=(e,s)=>{const o=me(e,s,u.useEffect);return u.useMemo(()=>o,[e,s])},ut=async(e,s,o)=>_e(e,[[s,ht({[s]:o})[s]]]),mt=(e,s=O())=>(o,a)=>ut(e,o,a).catch(s),bt={filter:"global.label.filter",sort:"global.label.sort",display:"global.label.display"},Ct=[["unreadChapters","library.option.sort.label.by_unread_chapters"],["totalChapters","library.option.sort.label.by_total_chapters"],["alphabetically","library.option.sort.label.alphabetically"],["dateAdded","library.option.sort.label.by_date_added"],["lastRead","library.option.sort.label.by_last_read"],["latestFetchedChapter","library.option.sort.label.by_latest_fetched_chapter"],["latestUploadedChapter","library.option.sort.label.by_latest_uploaded_chapter"]],ft=({category:e,open:s,onClose:o})=>{var p,S;const{t:a}=I(),r=D.useGetTrackerList(Me),n=Qe.getLoggedIn((S=(p=r.data)==null?void 0:p.trackers.nodes)!=null?S:[]),l=be(e),c=mt(e,h=>ne(a("global.error.label.failed_to_save_changes"),"error",ie(h))),{settings:{showTabSize:g,showContinueReadingButton:b,showDownloadBadge:j,showUnreadBadge:x,gridLayout:C}}=G(),y=Fe(h=>ne(a("search.error.label.failed_to_save_settings"),"error",ie(h)));return t.jsx(Ve,{open:s,onClose:o,tabs:["filter","sort","display"],tabTitle:h=>a(bt[h]),tabContent:h=>h==="filter"?t.jsxs(t.Fragment,{children:[t.jsx(_,{label:a("global.filter.label.unread"),checked:l.hasUnreadChapters,onChange:d=>c("hasUnreadChapters",d)}),t.jsx(_,{label:a("global.filter.label.started"),checked:l.hasReadChapters,onChange:d=>c("hasReadChapters",d)}),t.jsx(_,{label:a("global.filter.label.downloaded"),checked:l.hasDownloadedChapters,onChange:d=>c("hasDownloadedChapters",d)}),t.jsx(_,{label:a("global.filter.label.bookmarked"),checked:l.hasBookmarkedChapters,onChange:d=>c("hasBookmarkedChapters",d)}),t.jsx(_,{label:a("global.filter.label.duplicate_chapters"),checked:l.hasDuplicateChapters,onChange:d=>c("hasDuplicateChapters",d)}),t.jsx(B,{sx:{mt:2},children:a("manga.label.status")}),Object.values(Ae).map(d=>t.jsx(_,{label:a($e[d]),checked:l.hasStatus[d],onChange:k=>c("hasStatus",{...l.hasStatus,[d]:k})},d)),t.jsx(B,{sx:{mt:2},children:a("global.filter.label.tracked")}),n.map(d=>t.jsx(_,{label:d.name,checked:l.hasTrackerBinding[d.id],onChange:k=>c("hasTrackerBinding",{...l.hasTrackerBinding,[d.id]:k})},d.id))]}):h==="sort"?Ct.map(([d,k])=>t.jsx(We,{label:a(k),checked:l.sortBy===d,sortDescending:l.sortDesc,onClick:()=>d!==l.sortBy?c("sortBy",d):c("sortDesc",!l.sortDesc)},d)):h==="display"?t.jsxs(t.Fragment,{children:[t.jsx(B,{children:a("global.grid_layout.title")}),t.jsxs(Xe,{onChange:d=>w("gridLayout",Number(d.target.value)),value:C,children:[t.jsx(U,{label:a("global.grid_layout.label.compact_grid"),value:A.Compact,checked:C==null||C===A.Compact}),t.jsx(U,{label:a("global.grid_layout.label.comfortable_grid"),value:A.Comfortable,checked:C===A.Comfortable}),t.jsx(U,{label:a("global.grid_layout.label.list"),value:A.List,checked:C===A.List})]}),t.jsx(B,{sx:{mt:2},children:a("library.option.display.badge.title")}),t.jsx(R,{label:a("library.option.display.badge.label.unread_badges"),checked:x,onChange:()=>w("showUnreadBadge",!x)}),t.jsx(R,{label:a("library.option.display.badge.label.download_badges"),checked:j,onChange:()=>w("showDownloadBadge",!j)}),t.jsx(B,{sx:{mt:2},children:a("library.option.display.tab.title")}),t.jsx(R,{label:a("library.option.display.tab.label.show_number_of_items"),checked:g,onChange:()=>y("showTabSize",!g)}),t.jsx(B,{sx:{mt:2},children:a("global.label.other")}),t.jsx(R,{label:a("library.option.display.other.label.show_continue_reading_button"),checked:b,onChange:()=>w("showContinueReadingButton",!b)})]}):null})},xt=({category:e})=>{const{t:s}=I(),[o,a]=u.useState(!1),r=gt(e),n=r.hasDownloadedChapters!=null||r.hasUnreadChapters!=null||r.hasReadChapters!=null||r.hasBookmarkedChapters!=null||r.hasDuplicateChapters!=null||Object.values(r.hasStatus).some(l=>l!=null)||Object.values(r.hasTrackerBinding).some(l=>l!=null);return t.jsxs(t.Fragment,{children:[t.jsx(ge,{title:s("settings.title"),children:t.jsx(Be,{onClick:()=>a(!o),color:n?"warning":"inherit",children:t.jsx(Ye,{})})}),t.jsx(ft,{category:e,open:o,onClose:()=>a(!1)})]})},yt=()=>{},de=({showFilteredOutMessage:e,message:s,messageExtra:o,...a})=>{const{t:r}=I(),{settings:{gridLayout:n}}=G();return u.useLayoutEffect(()=>(document.body.style.overflowY=n===A.List?"auto":"scroll",()=>{document.body.style.overflowY="auto"}),[]),t.jsx(Ze,{gridWrapperProps:{sx:{p:1}},...a,hasNextPage:!1,loadMore:yt,message:e?r("library.error.label.no_matches"):s,messageExtra:e?void 0:o,gridLayout:n})},St=({isActive:e,areAllItemsSelected:s,areNoItemsSelected:o,onSelectAll:a,onModeChange:r})=>{const{t:n}=I();return t.jsxs(t.Fragment,{children:[e&&t.jsx(Ke,{areAllItemsSelected:s,areNoItemsSelected:o,onChange:a}),t.jsx(ge,{title:n(e?"global.button.cancel":"global.button.select_all"),children:t.jsx(rt,{checkedIcon:t.jsx(tt,{}),sx:{padding:"8px",color:"inherit","&.Mui-checked":{color:"inherit"}},checked:e,onChange:(l,c)=>r(c)})})]})},W=(e,s,o)=>{switch(e){case!0:return s();case!1:return o();default:return!0}},E=(e,s)=>W(e,()=>!!s&&s>=1,()=>s===0),Ce=(e,s)=>W(e,()=>!!s,()=>!s),M=(e,s)=>{const o=e==null?void 0:e.filter(l=>l!=null),a=s==null?void 0:s.filter(l=>l!=null);if(!(o!=null&&o.length))return!0;const r=o.map(Y),n=a.map(Y).join(", ");return r.every(l=>n.includes(l))},kt=(e,{title:s,genre:o,description:a,artist:r,author:n,source:l,sourceId:c})=>M([e],[s])||M(e==null?void 0:e.split(","),o.map(g=>Y(g)))||M([e],[a])||M([e],[r])||M([e],[n])||M([e],[l==null?void 0:l.displayName])||M([e],[c]),jt=(e,s)=>Object.entries(e).map(([o,a])=>{const r=s.trackRecords.nodes.some(n=>n.trackerId===Number(o));return W(a,()=>r,()=>!r)}).every(Boolean),Tt=(e,s)=>Object.entries(e).map(([o,a])=>Ce(a,o===s.status)).every(Boolean),_t=(e,{hasDownloadedChapters:s,hasUnreadChapters:o,hasReadChapters:a,hasBookmarkedChapters:r,hasDuplicateChapters:n,hasTrackerBinding:l,hasStatus:c})=>E(s,e.downloadCount)&&E(o,e.unreadCount)&&E(a,e.chapters.totalCount-e.unreadCount)&&E(r,e.bookmarkCount)&&Ce(n,e.hasDuplicateChapters)&&jt(l,e)&&Tt(c,e),Mt=(e,s,o)=>{const a=o.ignoreFilters&&(s==null?void 0:s.length);return e.filter(r=>{const n=kt(s,r),l=a||_t(r,o);return n&&l})},L=(e=0,s=0)=>Number(e)-Number(s),At=(e,s)=>e.localeCompare(s),Ft=(e,s,o)=>{const a=[...e];switch(s){case"alphabetically":a.sort((r,n)=>At(r.title,n.title));break;case"dateAdded":a.sort((r,n)=>L(r.inLibraryAt,n.inLibraryAt));break;case"unreadChapters":a.sort((r,n)=>L(r.unreadCount,n.unreadCount));break;case"lastRead":a.sort((r,n)=>{var l,c;return L((l=r.lastReadChapter)==null?void 0:l.lastReadAt,(c=n.lastReadChapter)==null?void 0:c.lastReadAt)});break;case"latestUploadedChapter":a.sort((r,n)=>{var l,c;return L((l=r.latestUploadedChapter)==null?void 0:l.uploadDate,(c=n.latestUploadedChapter)==null?void 0:c.uploadDate)});break;case"latestFetchedChapter":a.sort((r,n)=>{var l,c;return L((l=r.latestFetchedChapter)==null?void 0:l.fetchedAt,(c=n.latestFetchedChapter)==null?void 0:c.fetchedAt)});break;case"totalChapters":a.sort((r,n)=>L(r.chapters.totalCount,n.chapters.totalCount));break}return o&&a.reverse(),a},Bt={id:-1},Lt=(e,s)=>{const[o]=P(z.QUERY,ue),a=be(s!=null?s:Bt),{hasUnreadChapters:r,hasReadChapters:n,hasDownloadedChapters:l,hasBookmarkedChapters:c,hasTrackerBinding:g,hasDuplicateChapters:b,hasStatus:j}=a,{settings:x}=G(),C=u.useMemo(()=>Mt(e,o,{...a,ignoreFilters:x.ignoreFilters}),[e,o,r,n,l,c,g,b,j,x.ignoreFilters]),y=u.useMemo(()=>Ft(C,a.sortBy,a.sortDesc),[C,a.sortBy,a.sortDesc]),p=Object.values(a.hasTrackerBinding).some(h=>h!=null),S=(r!=null||n!=null||l!=null||c!=null||!!o||p)&&C.length===0&&e.length>0;return{visibleMangas:y,showFilteredOutMessage:S,filterKey:"".concat(JSON.stringify(a)).concat(x.ignoreFilters)}},he=Ge("span")({display:"flex",alignItems:"center"}),pe=({sx:e,...s})=>t.jsx(ct,{...s,size:"small",sx:{...e,marginLeft:"5px"}});function Ia(){var te,ae,se,re,oe,le;const{t:e}=I(),s=Le(),{settings:{showTabSize:o}}=G(),{data:a,error:r,loading:n,refetch:l}=D.useGetCategories(Ie,{notifyOnNetworkStatusChange:!0}),c=a==null?void 0:a.categories.nodes.filter(i=>i.id!==0||i.id===0&&i.mangas.totalCount),g=c!=null?c:[],b=D.useGetMangas(ve,{}),j=(ae=(te=b.data)==null?void 0:te.mangas.totalCount)!=null?ae:0,[x,C]=P(z.TAB,Ue),[y]=P(z.QUERY,ue),p=(se=g.find(i=>i.id===x))!=null?se:g[0],{data:S,error:h,loading:d,refetch:k}=D.useGetCategoryMangas(p==null?void 0:p.id,{skip:!p,notifyOnNetworkStatusChange:!0}),fe=(re=S==null?void 0:S.mangas.nodes)!=null?re:[],{visibleMangas:f,showFilteredOutMessage:V,filterKey:K}=Lt(fe,p),J=u.useCallback(()=>k().catch(O()),[k,p]),xe=u.useMemo(()=>f.map(i=>i.id),[f]),[T,v]=u.useState(!1),{areNoItemsForKeySelected:Q,areAllItemsForKeySelected:$,selectedItemIds:F,handleSelectAll:N,handleSelection:H,clearSelection:ye}=st(f.length,{itemIds:xe,currentKey:p==null?void 0:p.id.toString()}),X=u.useCallback((i,m,ke)=>{v(!!(F.length+(m?1:-1))),H(i,m,ke)},[v,H]),Z=u.useMemo(()=>F.map(i=>He.getFromCache(i,we,"MANGA_CHAPTER_STAT_FIELDS")).filter(i=>!!i),[F.length,f]),q=u.useMemo(()=>T?t.jsx(Je,{selectedItemsCount:F.length,title:"manga.title",children:(i,m)=>t.jsx(qe,{selectedMangas:Z,onClose:()=>{i(),v(!1),ye()},setHideMenu:m})}):null,[T,Z]),ee=u.useMemo(()=>!!y&&t.jsx(Re,{sx:{p:2},children:t.jsx(Ee,{size:"large",component:De,to:Oe.sources.childRoutes.searchAll.path(y),sx:{textTransform:"none",width:"100%"},children:e("library.action.label.search_globally",{query:y})})}),[y]);nt(t.jsxs(he,{children:[e("library.title"),o&&t.jsx(pe,{sx:{...s.applyStyles("light",{backgroundColor:"background.paper"})},label:j})]}),e("library.title"),[e,o,j]),it(t.jsxs(t.Fragment,{children:[!T&&p&&t.jsxs(t.Fragment,{children:[t.jsx(et,{}),t.jsx(xt,{category:p}),t.jsx(at,{categoryId:p==null?void 0:p.id})]}),!!f.length&&t.jsx(St,{isActive:T,areAllItemsSelected:$,areNoItemsSelected:Q,onSelectAll:i=>N(i,[...new Set(f.map(m=>m.id))]),onModeChange:i=>{v(i),i?N(!0,[...new Set(f.map(m=>m.id))]):g.forEach(m=>N(!1,[],m.id.toString()))}})]}),[T,Q,$,p,f.length]);const Se=i=>{C(i)};return r!=null||b.error?t.jsx(ce,{message:e("global.error.label.failed_to_load_data"),messageExtra:(le=r==null?void 0:r.message)!=null?le:(oe=b.error)==null?void 0:oe.message,retry:()=>{r&&l().catch(O()),b.error&&b.refetch().catch(O())}}):n||b.loading?t.jsx(Ne,{}):g.length===0?t.jsx(ce,{message:e("library.error.label.empty")}):g.length===1?t.jsxs(t.Fragment,{children:[ee,t.jsx(de,{mangas:f,message:e(h?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:h==null?void 0:h.message,isLoading:d,selectedMangaIds:F,isSelectModeActive:T,handleSelection:X,showFilteredOutMessage:!h&&V,retry:h&&J},K),q]}):t.jsxs(lt,{children:[t.jsx(ot,{value:p.id,onChange:(i,m)=>Se(m),children:g.map(i=>t.jsx(Pe,{sx:{flexGrow:1,maxWidth:"unset"},label:t.jsxs(he,{children:[i.name,o?t.jsx(pe,{label:i.mangas.totalCount}):null]}),value:i.id},i.id))}),ee,g.map(i=>t.jsx(ze,{index:i.order,currentIndex:p.order,children:i===p&&t.jsx(de,{mangas:f,message:e(h?"manga.error.label.request_failure":"category.error.label.empty"),messageExtra:h==null?void 0:h.message,isLoading:d,selectedMangaIds:F,isSelectModeActive:T,handleSelection:X,showFilteredOutMessage:!h&&V,retry:h&&J},K)},i.order)),q]})}export{Ia as Library};
