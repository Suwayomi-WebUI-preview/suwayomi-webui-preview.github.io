import{c as U,j as a,u as _,M as J,h as u,r as c,n as C,ah as R,k as I,I as E,ai as G,R as P,d as L,bM as N,ak as S,al as w,aK as j,o as y,m as M}from"./index-lurey2IN.js";import{P as F}from"./Progress-BPl-uJNk.js";const H=U(a.jsx("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Clear"),q=s=>{if(!s)return 0;const r=s.failedJobs.mangas.totalCount+s.completeJobs.mangas.totalCount,t=r+s.pendingJobs.mangas.totalCount+s.runningJobs.mangas.totalCount,i=100*(r/t);return Number.isNaN(i)?0:i};let n=!1;function K({categoryId:s,handleFinishedUpdate:r}){const{t}=_(),i=J.useIsTouchDevice(),[b,g]=u.useState(!1),{data:p,refetch:h}=c.useGetLastGlobalUpdateTimestamp(),f=p==null?void 0:p.lastUpdateTimestamp.timestamp,{data:d}=c.useGetGlobalUpdateSummary(),e=d==null?void 0:d.updateStatus,l=!!(e!=null&&e.isRunning),x=u.useMemo(()=>q(e),[e==null?void 0:e.failedJobs.mangas.totalCount,e==null?void 0:e.completeJobs.mangas.totalCount,e==null?void 0:e.pendingJobs.mangas.totalCount,e==null?void 0:e.runningJobs.mangas.totalCount]);u.useEffect(()=>{!n&&(e!=null&&e.isRunning)&&(n=!0),n&&x===100&&(n=!1,r==null||r(),h().catch(C()))},[e==null?void 0:e.isRunning]);const v=async o=>{try{n=!0,await c.startGlobalUpdate(o!==void 0?[o]:void 0).response,h().catch(C("UpdateChecker::reFetchLastTimestamp"))}catch(k){n=!1,y(t("global.error.label.update_failed"),"error",M(k))}},T=async()=>{try{await c.resetGlobalUpdate()}catch(o){y(t("library.error.label.stop_global_update"),"error",M(o))}},m=async o=>{l?T():v(o)};return a.jsx(R,{variant:"popover",popupId:"library-update-checker-menu",children:o=>a.jsxs(a.Fragment,{children:[a.jsx(I,{title:l?t("library.action.label.stop_update"):t("library.settings.global_update.label.last_update_tooltip",{date:f?N.format(+f):"-"}),children:a.jsx(E,{sx:{position:"relative"},...s!==void 0&&!l?G(o):{onClick:()=>m()},onMouseEnter:()=>g(!0),onMouseLeave:()=>g(!1),color:"inherit",children:l?a.jsxs(a.Fragment,{children:[a.jsx(H,{sx:{opacity:Number(i||b)}}),a.jsx(L,{sx:{position:"absolute"},children:a.jsx(F,{progress:x,showText:!i&&!b,progressProps:{color:"inherit"}})})]}):a.jsx(P,{})})}),a.jsxs(S,{...w(o),children:[a.jsx(j,{onClick:()=>{o.close(),m()},children:t("library.action.label.update_library")}),a.jsx(j,{onClick:()=>{o.close(),m(s)},children:t("library.action.label.update_category")})]})]})})}export{H as C,K as U};
