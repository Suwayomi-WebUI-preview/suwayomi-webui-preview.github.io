import{a2 as H,u as T,c as a,a as q,j as r,L as I,T as B,h as F,N as O,aw as Q,d as v,g as V,B as A}from"./index-C4qwXpmq.js";import{u as W,A as z,S as J}from"./AppbarSearch-ExOSXWmn.js";import{s as _,l as K,a as U}from"./Languages-CInaH_Eq.js";import{t as X,L as Y}from"./LangSelect-BZ-1sIVo.js";import{u as P}from"./useDebounce-D4a1r6K7.js";import{a as Z,E as ee}from"./EmptyViewAbsoluteCentered-B72QzW5m.js";import{B as re}from"./BaseMangaGrid-BbkSJyGj.js";import{C as te}from"./Card-4tnuY9-5.js";import{C as se}from"./CardActionArea-BKl1iYLA.js";import"./useManageMangaLibraryState-DJYVmgZo.js";import"./Trackers-D4pSmk7a.js";import"./CardContent-DmdpfO1T.js";import"./Avatar-Bu6yq9mQ.js";import"./Info-B1nwnUwY.js";import"./TextField-BNsfONQP.js";import"./InputAdornment-CXJi4Hxk.js";import"./CheckCircle-pjc9U-3s.js";import"./SpinnerImage-CjUcgnVH.js";import"./Refresh-8ASZ8-V5.js";import"./TypographyMaxLines-CokQutrb.js";import"./Mangas-CsWXKpxZ.js";import"./Chapters-C1Oi359V.js";import"./Collapse-Bo46tBQs.js";import"./Link-CIe6iV5f.js";import"./ListPreference-B0OP4uDN.js";import"./Checkbox-OHPjDEGs.js";import"./SwitchBase-B0snjHZd.js";import"./NumberSetting-CJzMbVkK.js";import"./useMobilePicker-DOIHUetg.js";import"./Chip--5E8K8ZA.js";import"./SelectSetting-BnPHoBmD.js";import"./Select-DPwqeTtk.js";import"./CheckboxInput-CG0-TUfr.js";import"./ThreeStateCheckboxInput-C-n_AaUF.js";import"./FilterList-DrGSWTGP.js";import"./cloneObject-DrOPTG0J.js";import"./Switch-D4ja6VhN.js";import"./MangaGrid-BgpFfzCz.js";import"./index-DmPE5XcG.js";import"./Delete-WBPkCX_q.js";import"./Download-lgtQcg2y.js";import"./Sync-CYkPFPx0.js";import"./PlayArrow-CyLNGm8-.js";import"./StyledFab-Dik-Stx6.js";function oe(t){const s=[];return t.forEach(e=>{s.indexOf(e.lang)===-1&&s.push(e.lang)}),s.sort(K),s}const ae=(t,s)=>t.displayName<s.displayName?-1:t.displayName>s.displayName?1:0,ne=(t,s,e)=>{var p,S,n,u;const f=!((p=e.get(t.id))!=null&&p.isLoading),c=!((S=e.get(s.id))!=null&&S.isLoading);if(f&&!c)return-1;if(!f&&c)return 1;if(!f&&!c)return 0;const m=!((n=e.get(t.id))!=null&&n.hasResults),l=!((u=e.get(s.id))!=null&&u.hasResults);return m&&!l?1:l&&!m?-1:0},ie=1e3,ce=H.memo(({source:t,onSearchRequestFinished:s,searchString:e,emptyQuery:f,mode:c})=>{var E,b;const{t:m}=T(),{id:l,displayName:p,lang:S}=t,n=a.useRef(e),u=a.useRef(()=>{});n.current!==e&&(n.current=e,u.current(new Error("SourceSearchPreview(".concat(l,", ").concat(p,"): search string changed"))));const[d,R]=q.useSourceSearch(l,e!=null?e:"",void 0,1,{skipRequest:!e,addAbortSignal:!0}),{data:L,isLoading:h,error:i,abortRequest:C}=R[0];u.current=C;const w=(b=(E=L==null?void 0:L.fetchSourceManga)==null?void 0:E.mangas)!=null?b:[],y=!i&&!h&&!w.length;a.useEffect(()=>{s(t,h,!y,!e)},[h,y,e]);let g;return i?g=m("search.error.label.source_search_failed"):y&&(g=m("manga.error.label.no_mangas_found")),!h&&!e||f?null:r.jsxs(r.Fragment,{children:[r.jsx(te,{sx:{mb:1},children:r.jsxs(se,{component:I,to:"/sources/".concat(l,"?query=").concat(e),sx:{p:3},children:[r.jsx(B,{variant:"h5",children:p}),r.jsx(B,{variant:"caption",children:X(S)})]})}),g?r.jsx(Z,{sx:{alignItems:"start",height:void 0},noFaces:!0,message:g,messageExtra:i&&i.message,retry:i?()=>d(1).catch(F("SourceSearchPreview(".concat(t.id,")::refetch"))):void 0}):r.jsx(re,{gridWrapperProps:{sx:{px:0}},mangas:w,isLoading:h,hasNextPage:!1,loadMore:()=>{},horizontal:!0,noFaces:!0,message:g,inLibraryIndicator:!0,mode:c})]})}),Ze=()=>{const{t}=T(),{setTitle:s,setAction:e}=a.useContext(O),{pathname:f,state:c}=Q(),m=f.startsWith("/migrate/source"),l=c==null?void 0:c.mangaTitle,[p]=W("query",J),S=P(p,ie),[n,u]=v("shownSourceLangs",U()),[j]=v("showNsfw",!0),{data:d,loading:R,error:L,refetch:h}=q.useGetSourceList({notifyOnNetworkStatusChange:!0}),i=a.useMemo(()=>{var o;return(o=d==null?void 0:d.sources.nodes)!=null?o:[]},[d==null?void 0:d.sources.nodes]),[C,w]=a.useState(new Map),y=P(C,500),g=a.useMemo(()=>[...i].sort(ae),[i]),E=a.useMemo(()=>g.filter(o=>n.includes(o.lang)),[g,n]),b=a.useMemo(()=>E.filter(o=>j||!o.isNsfw),[E,j]),M=a.useMemo(()=>[...b].sort((o,x)=>ne(o,x,y)),[b,y]),D=a.useCallback(({id:o},x,$,k)=>{w(G=>{const N=new Map(G);return N.set(o,{isLoading:x,hasResults:$,emptySearch:k}),N})},[w]);return a.useLayoutEffect(()=>(s(t(m?"migrate.search.title":"search.title.global_search",{title:l})),e(r.jsxs(r.Fragment,{children:[r.jsx(z,{isClosable:!1}),r.jsx(Y,{shownLangs:n,setShownLangs:u,allLangs:oe(i),forcedLangs:_()})]})),()=>{s(""),e(null)}),[t,n,u,i]),a.useEffect(()=>{const o=_().filter(x=>!n.includes(x));u([...n,...o])},[]),R?r.jsx(V,{}):L?r.jsx(ee,{message:t("global.error.label.failed_to_load_data"),messageExtra:L.message,retry:()=>h().catch(F())}):r.jsx(A,{sx:{p:1},children:M.map((o,x)=>r.jsx(A,{sx:{pb:x+1!==M.length?2:0},children:r.jsx(ce,{source:o,onSearchRequestFinished:D,searchString:S,emptyQuery:!p,mode:m?"migrate.select":"source"})},o.id))})};export{Ze as SearchAll};
