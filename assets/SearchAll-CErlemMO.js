import{b as u,u as q,d as U,aB as Q,v as V,x as Y,a as J,r as H,j as e,e as K,g as I,f as N,z as P,S as z,B as C,y as X,av as Z,w as ee,A as te,L as re,T as B,C as oe,I as se,aF as ne,aG as ae,aH as ie,m as ce}from"./index-BxY--oUh.js";import{P as ue}from"./PushPin-BQo4UW_Q.js";import{D as le}from"./DoneAll-CkQQoMNF.js";import{F as me}from"./FilterList-CIC8eSAc.js";import{A as pe}from"./AppbarSearch-BpE2aXFv.js";import{u as T}from"./useDebounce-XIPVu8UE.js";import{B as de}from"./BaseMangaGrid-BBSGtHW-.js";import{E as he}from"./EmptyViewAbsoluteCentered-D6BQtVQo.js";import{t as ge}from"./Extensions.utils-0TtQe169.js";import{S as A,g as O}from"./Sources-CPBYNKGK.js";import{u as fe}from"./useAppTitleAndAction-BMJ_Q_5Q.js";import{M as Se}from"./MUI.util-CEodEA2f.js";import{S as xe}from"./SourceLanguageSelect-DO1r5j9v.js";import{C as ye}from"./Card-VV91nnDB.js";import{C as be}from"./CardActionArea-BnmYSDIk.js";import"./ContinueReadingTooltip-DQUk_Qg1.js";import"./Trackers-Bgo8y--2.js";import"./AvatarSpinner-hfgj0li9.js";import"./SpinnerImage-cYfbeNaT.js";import"./Refresh-DHbarCD7.js";import"./ListCardContent-B7kgvJcO.js";import"./CheckCircle-LIHInv7B.js";import"./Metadata-Ct3MP3h9.js";import"./Mangas-BDR4FcW-.js";import"./Chapters-CZPgsnrp.js";import"./DateHelper-t7R6x4uG.js";import"./Asserts-CT4yz8Rx.js";import"./Link-BT0uZnKF.js";import"./useManageMangaLibraryState-DMcTOe1n.js";import"./ThreeStateCheckboxInput-D1XP_srJ.js";import"./Checkbox-CMj7EKdF.js";import"./SwitchBase-BXymYdFv.js";import"./CheckboxInput-DErwrXZM.js";import"./FormGroup-DlKfo-If.js";import"./ListPreference-2cFAAHjq.js";import"./NumberSetting-BlMDb8q4.js";import"./Slider-C6nq4xsA.js";import"./useMobilePicker-C0DoWWC4.js";import"./Chip-ClSpYYNu.js";import"./SelectSetting-C13Cn0NW.js";import"./Select-B3uQi_fb.js";import"./MangaGrid-CK39-60i.js";import"./Delete-Be7vYmHz.js";import"./Download-7K2REnyI.js";import"./Sync-CbxdEouf.js";import"./use-merged-ref-C5D1_heY.js";import"./ListCardAvatar-B8KlnRJH.js";import"./PlayArrow-NUe27zwL.js";import"./StyledFab-uBa6R-Df.js";import"./index-CSVzqkn4.js";import"./Virtuoso.util-BT7BC7P5.js";import"./Strings-CAV0u705.js";import"./useAppTitle-DKL-DSkS.js";import"./useAppAction-C1aC_gr_.js";import"./Switch-DloX7nE2.js";import"./ListItemAvatar-TpzyGKew.js";const Re={x:0,y:0,width:0,height:0,top:0,left:0,bottom:0,right:0};function we(n){const i=u.useRef(0),t=u.useRef(null),[a,h]=u.useState(Re),r=u.useMemo(()=>typeof window<"u"?new ResizeObserver(o=>{const s=o[0];s&&(cancelAnimationFrame(i.current),i.current=requestAnimationFrame(()=>{var c,g;if(t.current){const l=((c=s.borderBoxSize)==null?void 0:c[0])||((g=s.contentBoxSize)==null?void 0:g[0]);if(l){const p=l.inlineSize,b=l.blockSize;h({width:p,height:b,x:s.contentRect.x,y:s.contentRect.y,top:s.contentRect.top,left:s.contentRect.left,bottom:s.contentRect.bottom,right:s.contentRect.right})}else h(s.contentRect)}}))}):null,[]);return u.useEffect(()=>(t.current&&(r==null||r.observe(t.current,n)),()=>{r==null||r.disconnect(),i.current&&cancelAnimationFrame(i.current)}),[t.current]),[t,a]}function je(n){const[i,{width:t,height:a}]=we(n);return{ref:i,width:t,height:a}}const Le=(n,i)=>n.displayName.localeCompare(i.displayName),Me=(n,i,t)=>{const a=O(n).isPinned,h=O(i).isPinned,r=t.get(n.id),o=t.get(i.id),s=!(r!=null&&r.isLoading),c=!!(r!=null&&r.error),g=!(r!=null&&r.hasResults)&&!c,l=!(o!=null&&o.isLoading),p=!!(o!=null&&o.error),b=!(o!=null&&o.hasResults)&&!p;return s&&!l?-1:!s&&l||g&&!b?1:b&&!g||!c&&p?-1:c&&!p?1:a&&!h?-1:!a&&h?1:0},Ee=ie(1).seconds.inWholeMilliseconds,Pe=Z.memo(({source:n,onSearchRequestFinished:i,searchString:t,emptyQuery:a,mode:h,shouldShowOnlySourcesWithResults:r})=>{var L,M;const{t:o}=q(),{id:s,name:c,lang:g}=n,l=u.useRef(t),p=u.useRef(()=>{});l.current!==t&&(l.current=t,p.current(new Error("SourceSearchPreview(".concat(s,", ").concat(c,"): search string changed"))));const[w,S]=H.useSourceSearch(s,t!=null?t:"",void 0,1,{skipRequest:!t,addAbortSignal:!0}),{data:j,isLoading:x,error:f,abortRequest:d}=S[0];p.current=d;const E=(M=(L=j==null?void 0:j.fetchSourceManga)==null?void 0:L.mangas)!=null?M:[],R=!f&&!x&&!E.length;u.useEffect(()=>{i(n,{isLoading:x,hasResults:!R,emptySearch:!t,error:f})},[x,R,t,f]);let y;return f?y=o("search.error.label.source_search_failed"):R&&(y=o("manga.error.label.no_mangas_found")),!x&&!t||a||r&&(R||f)?null:e.jsxs(P,{sx:{pb:2},children:[e.jsx(ye,{sx:{mb:1},children:e.jsxs(be,{component:re,to:te.sources.childRoutes.browse.path(s,t),sx:{p:1,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(P,{children:[e.jsx(B,{variant:"h5",children:c}),e.jsx(B,{variant:"caption",children:ge(g)})]}),e.jsx(oe,{title:o("global.button.show_more"),children:e.jsx(se,{...Se.preventRippleProp(),children:e.jsx(ne,{})})})]})}),y?e.jsx(ae,{sx:{alignItems:"start",height:void 0},noFaces:!0,message:y,messageExtra:I(f),retry:f?()=>w(1).catch(N("SourceSearchPreview(".concat(n.id,")::refetch"))):void 0}):e.jsx(de,{gridWrapperProps:{sx:{px:0}},mangas:E,isLoading:x,hasNextPage:!1,loadMore:()=>{},horizontal:!0,noFaces:!0,message:y,inLibraryIndicator:!0,mode:h},t)]})}),At=()=>{var k;const{t:n}=q(),i=U(),{pathname:t,state:a}=Q(),{ref:h,height:r}=je(),o=(k=a==null?void 0:a.shouldShowOnlyPinnedSources)!=null?k:!0,s=t.startsWith("/migrate/source"),[c]=V(Y.QUERY,ee),g=T(c,Ee),{languages:l,setLanguages:p}=A.useLanguages(),{settings:{showNsfw:b,shouldShowOnlySourcesWithResults:w}}=J(),{data:S,loading:j,error:x,refetch:f}=H.useGetSourceList({notifyOnNetworkStatusChange:!0}),d=u.useMemo(()=>{var m;return(m=S==null?void 0:S.sources.nodes)!=null?m:[]},[S==null?void 0:S.sources.nodes]),[E,R]=u.useState(new Map),y=T(E,500),L=u.useMemo(()=>A.getLanguages(d),[d]),M=u.useMemo(()=>A.filter(d,{showNsfw:b,languages:l,keepLocalSource:!0,pinned:o,enabled:!0}),[d,l,o]),_=u.useMemo(()=>[...M].toSorted(Le),[M]),D=u.useMemo(()=>[..._].sort((m,v)=>Me(m,v,y)),[_,y]),$=u.useCallback(({id:m},v)=>{R(W=>{const F=new Map(W);return F.set(m,v),F})},[R]),G=X(m=>ce(n("global.error.label.failed_to_save_changes"),"error",I(m)));return fe(n(s?"migrate.search.title":"search.title.global_search",{title:a==null?void 0:a.mangaTitle}),e.jsxs(e.Fragment,{children:[e.jsx(pe,{isClosable:!1}),e.jsx(xe,{selectedLanguages:l,setSelectedLanguages:p,languages:L,sources:d!=null?d:[]})]}),[l,p,L,d]),j?e.jsx(K,{}):x?e.jsx(he,{message:n("global.error.label.failed_to_load_data"),messageExtra:I(x),retry:()=>f().catch(N())}):e.jsxs(P,{sx:{position:"relative",px:1,pb:1},children:[e.jsxs(z,{ref:h,sx:{width:"100%",position:"fixed",zIndex:1,flexDirection:"row",gap:2,pt:1,pb:2,background:m=>m.palette.background.default},children:[e.jsxs(z,{sx:{flexDirection:"row",gap:1},children:[e.jsx(C,{startIcon:e.jsx(ue,{}),variant:o?"contained":"outlined",onClick:()=>i({pathname:"",search:c?"query=".concat(c):""},{replace:!0,state:{...a,shouldShowOnlyPinnedSources:!0}}),children:n("global.label.pinned")}),e.jsx(C,{startIcon:e.jsx(le,{}),variant:o?"outlined":"contained",onClick:()=>i({pathname:"",search:c?"query=".concat(c):""},{replace:!0,state:{...a,shouldShowOnlyPinnedSources:!1}}),children:n("extension.language.all")})]}),e.jsx(C,{startIcon:e.jsx(me,{}),variant:w?"contained":"outlined",onClick:()=>G("shouldShowOnlySourcesWithResults",!w),children:n("search.filter.has_results")})]}),e.jsx(P,{sx:{pt:"".concat(r,"px")},children:D.map(m=>e.jsx(Pe,{source:m,onSearchRequestFinished:$,searchString:g,emptyQuery:!c,mode:s?"migrate.select":"source",shouldShowOnlySourcesWithResults:w},m.id))})]})};export{At as SearchAll};
