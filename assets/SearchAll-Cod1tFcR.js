import{u as P,f as I,aQ as O,g as A,r as T,h as n,j as s,l as Q,E as V,m as q,n as D,B,aF as W,C as z,a as J,A as K,L as U,T as v,aR as X}from"./index-BKHCEc_C.js";import{u as Y,A as Z,S as ee}from"./AppbarSearch-CyZj6_BN.js";import{s as _,l as se,a as re}from"./Languages-BNJLM4IY.js";import{L as te,t as ae}from"./LangSelect-BDjnmqDE.js";import{u as F}from"./useDebounce-BtfEaem6.js";import{B as oe}from"./BaseMangaGrid-B8brc8ak.js";import"./ChaptersDownloadActionMenuItems-B24dkt_n.js";import"./Trackers-D4pSmk7a.js";import"./Avatar-CTaLFrXq.js";import"./Info-Ck-M2yCC.js";import"./CheckCircle-DaVyRjmR.js";import"./ListPreference-Ev99m7W4.js";import"./NumberSetting-TxBtqche.js";import"./useMobilePicker-BcBW50Dc.js";import"./Chip-0kfDpumZ.js";import"./SelectSetting-CTWbuEPD.js";import"./FilterList-oNHCaHcL.js";import"./cloneObject-DrOPTG0J.js";import"./Switch-BSyxNVq4.js";import"./MangaGrid-Bg4zpX8G.js";import"./Sync-D2EV-2TB.js";import"./PlayArrow-BgSVOZGS.js";import"./StyledFab-DxzONowe.js";function ne(r){const t=[];return r.forEach(e=>{t.indexOf(e.lang)===-1&&t.push(e.lang)}),t.sort(se),t}const ie=(r,t)=>r.displayName<t.displayName?-1:r.displayName>t.displayName?1:0,ce=(r,t,e)=>{var d,S,o,c;const f=!((d=e.get(r.id))!=null&&d.isLoading),i=!((S=e.get(t.id))!=null&&S.isLoading);if(f&&!i)return-1;if(!f&&i)return 1;if(!f&&!i)return 0;const l=!((o=e.get(r.id))!=null&&o.hasResults),m=!((c=e.get(t.id))!=null&&c.hasResults);return l&&!m?1:m&&!l?-1:0},ue=1e3,le=W.memo(({source:r,onSearchRequestFinished:t,searchString:e,emptyQuery:f,mode:i})=>{var R,w;const{t:l}=P(),{id:m,displayName:d,lang:S}=r,o=n.useRef(e),c=n.useRef(()=>{});o.current!==e&&(o.current=e,c.current(new Error("SourceSearchPreview(".concat(m,", ").concat(d,"): search string changed"))));const[g,j]=T.useSourceSearch(m,e!=null?e:"",void 0,1,{skipRequest:!e,addAbortSignal:!0}),{data:L,isLoading:h,error:u,abortRequest:M}=j[0];c.current=M;const E=(w=(R=L==null?void 0:L.fetchSourceManga)==null?void 0:R.mangas)!=null?w:[],y=!u&&!h&&!E.length;n.useEffect(()=>{t(r,h,!y,!e)},[h,y,e]);let p;return u?p=l("search.error.label.source_search_failed"):y&&(p=l("manga.error.label.no_mangas_found")),!h&&!e||f?null:s.jsxs(s.Fragment,{children:[s.jsx(z,{sx:{mb:1},children:s.jsxs(J,{component:U,to:"".concat(K.sources.childRoutes.browse.path(m),"?query=").concat(e),sx:{p:3},children:[s.jsx(v,{variant:"h5",children:d}),s.jsx(v,{variant:"caption",children:ae(S)})]})}),p?s.jsx(X,{sx:{alignItems:"start",height:void 0},noFaces:!0,message:p,messageExtra:q(u),retry:u?()=>g(1).catch(D("SourceSearchPreview(".concat(r.id,")::refetch"))):void 0}):s.jsx(oe,{gridWrapperProps:{sx:{px:0}},mangas:E,isLoading:h,hasNextPage:!1,loadMore:()=>{},horizontal:!0,noFaces:!0,message:p,inLibraryIndicator:!0,mode:i})]})}),Pe=()=>{const{t:r}=P(),{setTitle:t,setAction:e}=I(),{pathname:f,state:i}=O(),l=f.startsWith("/migrate/source"),m=i==null?void 0:i.mangaTitle,[d]=Y("query",ee),S=F(d,ue),[o,c]=A("shownSourceLangs",re()),[b]=A("showNsfw",!0),{data:g,loading:j,error:L,refetch:h}=T.useGetSourceList({notifyOnNetworkStatusChange:!0}),u=n.useMemo(()=>{var a;return(a=g==null?void 0:g.sources.nodes)!=null?a:[]},[g==null?void 0:g.sources.nodes]),[M,E]=n.useState(new Map),y=F(M,500),p=n.useMemo(()=>[...u].sort(ie),[u]),R=n.useMemo(()=>p.filter(a=>o.includes(a.lang)),[p,o]),w=n.useMemo(()=>R.filter(a=>b||!a.isNsfw),[R,b]),N=n.useMemo(()=>[...w].sort((a,x)=>ce(a,x,y)),[w,y]),$=n.useCallback(({id:a},x,k,G)=>{E(H=>{const C=new Map(H);return C.set(a,{isLoading:x,hasResults:k,emptySearch:G}),C})},[E]);return n.useLayoutEffect(()=>(t(r(l?"migrate.search.title":"search.title.global_search",{title:m})),e(s.jsxs(s.Fragment,{children:[s.jsx(Z,{isClosable:!1}),s.jsx(te,{shownLangs:o,setShownLangs:c,allLangs:ne(u),forcedLangs:_()})]})),()=>{t(""),e(null)}),[r,o,c,u]),n.useEffect(()=>{const a=_().filter(x=>!o.includes(x));c([...o,...a])},[]),j?s.jsx(Q,{}):L?s.jsx(V,{message:r("global.error.label.failed_to_load_data"),messageExtra:q(L),retry:()=>h().catch(D())}):s.jsx(B,{sx:{p:1},children:N.map((a,x)=>s.jsx(B,{sx:{pb:x+1!==N.length?2:0},children:s.jsx(le,{source:a,onSearchRequestFinished:$,searchString:S,emptyQuery:!d,mode:l?"migrate.select":"source"})},a.id))})};export{Pe as SearchAll};
