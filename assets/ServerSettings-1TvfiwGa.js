import{u as J,j as e,M as g,b2 as Q,v as o,bN as q,bO as Z,bP as V,b8 as ee,m as M,g as L,r as P,e as se,f as te,bQ as re,s as d,F as ae,i as ne,k as F,bR as K,b5 as i,bS as ie,bT as T,bU as I,aL as w,bV as H,bW as G,bX as B,av as W,bY as X}from"./index-B0UwsKMl.js";import{N as p}from"./NumberSetting-wGGGirZY.js";import{S as m}from"./SelectSetting-BRuxTpuo.js";import{E as le}from"./EmptyViewAbsoluteCentered-Bs5AD096.js";import{u as oe}from"./useAppTitle-DqHPF1XK.js";import{C as de}from"./LoginDialog-CNleQOm-.js";import{a as ce}from"./Asserts-BTvS50Ww.js";import{L as h}from"./ListSubheader-KAmnTgI9.js";import{S as c}from"./Switch-SWhSrS5Q.js";import{T as ge}from"./Trans-BdLE1JM7.js";import{L as he}from"./Link-Sj9lu0iN.js";import"./Slider-CKpmKyJR.js";import"./Select-DbZjlVpk.js";import"./SwitchBase-_t5Xifnm.js";const ue=({settings:{koreaderSyncPercentageTolerance:s,koreaderSyncStrategyBackward:N,koreaderSyncStrategyForward:A,koreaderSyncChecksumMethod:y},serverAddress:_,username:f,isLoggedIn:b,updateSetting:S})=>{const{t:n}=J(),R=async()=>{const{data:a}=await P.koSyncLogout().response;if(a!=null&&a.logoutKoSyncAccount.status.isLoggedIn)throw new Error(n("tracking.action.logout.label.failure",{name:n("settings.server.koreader.sync.title")}))},z=async(a,v,U)=>{var r;const{data:l}=await P.koSyncLogin(a,v,U).response;if(!(l!=null&&l.connectKoSyncAccount.status.isLoggedIn))throw new Error((r=l==null?void 0:l.connectKoSyncAccount.message)!=null?r:n("global.label.unknown"))},u=async(a="https://sync.koreader.rocks/",v,U)=>{const l=de.showControlled({title:n(b?"settings.server.koreader.sync.connection.disconnect":"settings.server.koreader.sync.connection.connect",{name:n("settings.server.koreader.sync.title")}),description:b?n("settings.server.koreader.sync.connection.connected",{username:v,serverAddress:a}):void 0,isLoading:!1,isLoggedIn:b,withServerAddress:!0,username:v,password:U,serverAddress:a,loginLogout:async(r,j,C)=>{if(l.update({isLoading:!0,loginLogout:ee}),b){try{await R(),l.submit()}catch(x){M(n("settings.server.koreader.sync.connection.message.disconnect_error"),"error",L(x))}return}try{ce(C),await z(C,r,j),l.submit()}catch(x){M(n("settings.server.koreader.sync.connection.message.connect_error"),"error",L(x));const E="__retry__";await Promise.race([l.promise,Promise.resolve(E)])===E&&u(C,r,j)}}},{id:"koreader-sync-login-logout"})};return e.jsxs(g,{subheader:e.jsx(h,{component:"div",id:"koreader-sync-settings",children:n("settings.server.koreader.sync.title")}),children:[e.jsx(Q,{onClick:()=>u(_!=null?_:void 0,f!=null?f:void 0),children:e.jsx(o,{primary:n("settings.server.koreader.sync.connection.status"),secondary:b?n("settings.server.koreader.sync.connection.connected",{username:f,serverAddress:_}):n("settings.server.koreader.sync.connection.disconnected")})}),e.jsx(m,{settingName:n("settings.server.koreader.sync.strategy.forward_title"),value:A,values:q,handleChange:a=>S("koreaderSyncStrategyForward",a)}),e.jsx(m,{settingName:n("settings.server.koreader.sync.strategy.backward_title"),value:N,values:q,handleChange:a=>S("koreaderSyncStrategyBackward",a)}),e.jsx(m,{settingName:n("settings.server.koreader.sync.check_sum_method.title"),value:y,values:Z,handleChange:a=>S("koreaderSyncChecksumMethod",a)}),e.jsx(p,{settingTitle:n("settings.server.koreader.sync.tolerance.title"),dialogDescription:n("settings.server.koreader.sync.tolerance.description"),settingValue:s.toString(),value:s,defaultValue:V.default,minValue:V.min,maxValue:V.max,stepSize:V.step,valueUnit:"",handleUpdate:a=>S("koreaderSyncPercentageTolerance",a)})]})},ve=s=>s===0?W("global.label.never"):W("settings.server.misc.log_files.file_cleanup.value",{days:s,count:s}),Le=()=>{var E,D,Y;const{t:s}=J();oe(s("settings.server.title.server"));const{settings:{serverInformAvailableUpdate:N},loading:A,request:{error:y,refetch:_}}=se(),f=ae(t=>M(s("global.error.label.failed_to_save_changes"),"error",L(t))),{data:b,loading:S,error:n,refetch:R}=P.useGetServerSettings({notifyOnNetworkStatusChange:!0}),[z]=P.useUpdateServerSettings(),u=P.useKoSyncStatus(),a=async(t,O,k)=>{try{await z({variables:{input:{settings:{[t]:O}}}}),k==null||k(!0)}catch($){M(s("global.error.label.failed_to_save_changes"),"error",L($)),k==null||k(!1)}},v=te.useMemo(()=>e.jsxs(g,{subheader:e.jsx(h,{component:"div",id:"server-settings-client",children:s("global.label.client")}),children:[e.jsx(re,{}),e.jsxs(d,{children:[e.jsx(o,{primary:s("global.update.settings.inform.label.title"),secondary:s("global.update.settings.inform.label.description")}),e.jsx(c,{edge:"end",checked:N,onChange:t=>f("serverInformAvailableUpdate",t.target.checked)})]})]}),[N]);if(A||S||u.loading)return e.jsxs(e.Fragment,{children:[v,e.jsx(ne,{})]});const l=(E=y!=null?y:n)!=null?E:u.error;if(l)return e.jsxs(e.Fragment,{children:[v,e.jsx(le,{message:s("global.error.label.failed_to_load_data"),messageExtra:L(l),retry:()=>{y&&_().catch(F()),n&&R().catch(F()),u.error&&u.refetch().catch(F())}})]});const r=b.settings,j=u.data.koSyncStatus,C=!((D=r.authUsername)!=null&&D.trim())||!((Y=r.authPassword)!=null&&Y.trim()),x=r.databaseType===K.H2;return e.jsxs(g,{sx:{pt:0},children:[v,e.jsxs(g,{subheader:e.jsx(h,{component:"div",id:"server-settings-server-address",children:s("settings.server.address.server.title")}),children:[e.jsx(i,{settingName:s("settings.server.address.server.label.ip"),handleChange:t=>a("ip",t),value:r.ip,placeholder:"0.0.0.0"}),e.jsx(p,{settingTitle:s("settings.server.address.server.label.port"),settingValue:r.port.toString(),handleUpdate:t=>a("port",t),value:r.port,defaultValue:4567,valueUnit:s("settings.server.address.server.label.port")})]}),e.jsxs(g,{subheader:e.jsx(h,{component:"div",id:"server-settings-socks-proxy",children:s("settings.server.socks_proxy.title")}),children:[e.jsxs(d,{children:[e.jsx(o,{primary:s("settings.server.socks_proxy.label.enable")}),e.jsx(c,{edge:"end",checked:r.socksProxyEnabled,onChange:t=>a("socksProxyEnabled",t.target.checked)})]}),e.jsx(m,{settingName:s("settings.server.socks_proxy.label.version"),value:r.socksProxyVersion,values:[[4,{text:"4"}],[5,{text:"5"}]],handleChange:t=>a("socksProxyVersion",t)}),e.jsx(i,{settingName:s("settings.server.socks_proxy.label.host"),value:r.socksProxyHost,handleChange:t=>a("socksProxyHost",t)}),e.jsx(i,{settingName:s("settings.server.socks_proxy.label.port"),value:r.socksProxyPort,handleChange:t=>a("socksProxyPort",t)}),e.jsx(i,{settingName:s("settings.server.socks_proxy.label.username"),value:r.socksProxyUsername,handleChange:t=>a("socksProxyUsername",t)}),e.jsx(i,{settingName:s("settings.server.socks_proxy.label.password"),value:r.socksProxyPassword,handleChange:t=>a("socksProxyPassword",t),isPassword:!0})]}),e.jsxs(g,{subheader:e.jsx(h,{component:"div",id:"server-settings-auth",children:s("settings.server.auth.title")}),children:[e.jsx(m,{settingName:s("settings.server.auth.label.title"),value:r.authMode,values:ie,handleChange:t=>{a("authMode",t,O=>{O&&(t!==T.UiLogin&&X.removeTokens(),X.setAuthRequired(t===T.UiLogin))})},disabled:C}),e.jsx(i,{settingName:s("settings.server.auth.label.username"),value:r.authUsername,validate:t=>r.authMode===T.None||!!t.trim(),handleChange:t=>a("authUsername",t)}),e.jsx(i,{settingName:s("settings.server.auth.label.password"),value:r.authPassword,isPassword:!0,validate:t=>r.authMode===T.None||!!t.trim(),handleChange:t=>a("authPassword",t)}),r.authMode===T.UiLogin&&e.jsxs(e.Fragment,{children:[e.jsx(i,{settingName:s("settings.server.auth.jwt.audience"),value:r.jwtAudience,handleChange:t=>a("jwtAudience",t)}),e.jsx(p,{settingTitle:s("settings.server.auth.jwt.access_token_expiry"),settingValue:w(r.jwtTokenExpiry).minutes.humanize(),value:w(r.jwtTokenExpiry).minutes.inWholeMinutes,valueUnit:s("global.time.minutes.minute_other"),defaultValue:I.default,minValue:I.min,maxValue:I.max,handleUpdate:t=>a("jwtTokenExpiry",w(t).minutes.toISOString()),showSlider:!0}),e.jsx(p,{settingTitle:s("settings.server.auth.jwt.refresh_token_expiry"),settingValue:w(r.jwtRefreshExpiry).days.humanize(),value:w(r.jwtRefreshExpiry).days.inWholeDays,valueUnit:s("global.time.days.day_other"),defaultValue:H.default,minValue:H.min,maxValue:H.max,handleUpdate:t=>a("jwtRefreshExpiry",w(t).days.toISOString()),showSlider:!0})]})]}),e.jsxs(g,{subheader:e.jsx(h,{component:"div",id:"server-settings-clouadflare-bypass",children:s("settings.server.cloudflare.title")}),children:[e.jsxs(d,{children:[e.jsx(o,{primary:s("settings.server.cloudflare.flaresolverr.enabled.label.title"),secondary:e.jsxs(ge,{i18nKey:"settings.server.cloudflare.flaresolverr.enabled.label.description",children:["See"," ",e.jsx(he,{href:"https://github.com/FlareSolverr/FlareSolverr?tab=readme-ov-file#installation",target:"_blank",rel:"noreferrer",children:"FlareSolverr"})," ","for information on how to set it up"]})}),e.jsx(c,{edge:"end",checked:r.flareSolverrEnabled,onChange:t=>a("flareSolverrEnabled",t.target.checked)})]}),e.jsx(i,{settingName:s("settings.server.cloudflare.flaresolverr.url.label.title"),dialogDescription:s("settings.server.cloudflare.flaresolverr.url.label.description"),value:r.flareSolverrUrl,handleChange:t=>a("flareSolverrUrl",t)}),e.jsx(p,{settingTitle:s("settings.server.cloudflare.flaresolverr.timeout.label.title"),settingValue:s("global.time.seconds.value",{count:r.flareSolverrTimeout}),dialogDescription:s("settings.server.cloudflare.flaresolverr.timeout.label.description"),value:r.flareSolverrTimeout,defaultValue:60,minValue:20,maxValue:60*5,stepSize:1,showSlider:!0,valueUnit:s("global.time.seconds.second_other"),handleUpdate:t=>a("flareSolverrTimeout",t)}),e.jsx(i,{settingName:s("settings.server.cloudflare.flaresolverr.session.name.label.title"),value:r.flareSolverrSessionName,handleChange:t=>a("flareSolverrSessionName",t)}),e.jsx(p,{settingTitle:s("settings.server.cloudflare.flaresolverr.session.ttl.label.title"),settingValue:s("global.time.minutes.value",{count:r.flareSolverrSessionTtl}),dialogDescription:s("settings.server.cloudflare.flaresolverr.session.ttl.label.description"),value:r.flareSolverrSessionTtl,defaultValue:15,minValue:1,maxValue:60,stepSize:1,showSlider:!0,valueUnit:s("global.time.minutes.minute_other"),handleUpdate:t=>a("flareSolverrSessionTtl",t)}),e.jsxs(d,{children:[e.jsx(o,{primary:s("settings.server.cloudflare.flaresolverr.response_fallback.label.title"),secondary:s("settings.server.cloudflare.flaresolverr.response_fallback.label.description")}),e.jsx(c,{edge:"end",checked:r.flareSolverrAsResponseFallback,onChange:t=>a("flareSolverrAsResponseFallback",t.target.checked)})]})]}),e.jsxs(g,{subheader:e.jsx(h,{component:"div",id:"server-settings-opds",children:s("settings.server.opds.title")}),children:[e.jsxs(d,{children:[e.jsx(o,{primary:s("settings.server.opds.binary_file_sizes.label.title"),secondary:s("settings.server.opds.binary_file_sizes.label.description")}),e.jsx(c,{edge:"end",checked:r.opdsUseBinaryFileSizes,onChange:t=>a("opdsUseBinaryFileSizes",t.target.checked)})]}),e.jsx(p,{settingTitle:s("settings.server.opds.items_per_page.label.title"),settingValue:r.opdsItemsPerPage.toString(),dialogDescription:s("settings.server.opds.items_per_page.label.description"),value:r.opdsItemsPerPage,defaultValue:50,minValue:10,maxValue:5e3,stepSize:10,showSlider:!0,valueUnit:s("settings.server.opds.items_per_page.label.unit_other"),handleUpdate:t=>a("opdsItemsPerPage",t)}),e.jsxs(d,{children:[e.jsx(o,{primary:s("settings.server.opds.enable_page_read_progress.label.title"),secondary:s("settings.server.opds.enable_page_read_progress.label.description")}),e.jsx(c,{edge:"end",checked:r.opdsEnablePageReadProgress,onChange:t=>a("opdsEnablePageReadProgress",t.target.checked)})]}),e.jsxs(d,{children:[e.jsx(o,{primary:s("settings.server.opds.mark_as_read_on_download.label.title"),secondary:s("settings.server.opds.mark_as_read_on_download.label.description")}),e.jsx(c,{edge:"end",checked:r.opdsMarkAsReadOnDownload,onChange:t=>a("opdsMarkAsReadOnDownload",t.target.checked)})]}),e.jsxs(d,{children:[e.jsx(o,{primary:s("settings.server.opds.show_only_unread_chapters.label.title"),secondary:s("settings.server.opds.show_only_unread_chapters.label.description")}),e.jsx(c,{edge:"end",checked:r.opdsShowOnlyUnreadChapters,onChange:t=>a("opdsShowOnlyUnreadChapters",t.target.checked)})]}),e.jsxs(d,{children:[e.jsx(o,{primary:s("settings.server.opds.show_only_downloaded_chapters.label.title"),secondary:s("settings.server.opds.show_only_downloaded_chapters.label.description")}),e.jsx(c,{edge:"end",checked:r.opdsShowOnlyDownloadedChapters,onChange:t=>a("opdsShowOnlyDownloadedChapters",t.target.checked)})]}),e.jsx(m,{settingName:s("settings.server.opds.chapter_sort_order.label.title"),dialogDescription:s("settings.server.opds.chapter_sort_order.label.description"),value:r.opdsChapterSortOrder,values:[[G.Asc,{text:s("global.sort.label.asc")}],[G.Desc,{text:s("global.sort.label.desc")}]],handleChange:t=>a("opdsChapterSortOrder",t)}),e.jsx(m,{settingName:s("settings.server.opds.cbz_mime_type.title"),dialogDescription:s("settings.server.opds.cbz_mime_type.description"),value:r.opdsCbzMimetype,values:[[B.Legacy,{text:s("settings.server.opds.cbz_mime_type.legacy")}],[B.Modern,{text:s("settings.server.opds.cbz_mime_type.modern")}],[B.Compatible,{text:s("settings.server.opds.cbz_mime_type.compatible")}]],handleChange:t=>a("opdsCbzMimetype",t)})]}),e.jsx(ue,{settings:r,serverAddress:j.serverAddress,username:j.username,isLoggedIn:j.isLoggedIn,updateSetting:a}),e.jsxs(g,{subheader:e.jsx(h,{component:"div",id:"server-settings-database",children:s("settings.server.database.title")}),children:[e.jsx(m,{settingName:s("settings.server.database.type.title"),value:r.databaseType,values:[[K.H2,{text:s("settings.server.database.type.h2")}],[K.Postgresql,{text:s("settings.server.database.type.postgresql")}]],handleChange:t=>a("databaseType",t)}),e.jsx(i,{settingName:s("settings.server.database.address"),handleChange:t=>a("databaseUrl",t),value:r.databaseUrl,placeholder:"postgresql://localhost:5432/suwayomi",disabled:x}),e.jsx(i,{settingName:s("settings.server.database.username"),value:r.databaseUsername,handleChange:t=>a("databaseUsername",t),disabled:x}),e.jsx(i,{settingName:s("settings.server.database.password"),value:r.databasePassword,handleChange:t=>a("databasePassword",t),disabled:x,isPassword:!0}),e.jsxs(d,{children:[e.jsx(o,{primary:s("settings.server.database.hikari_connection_pool.title"),secondary:s("settings.server.database.hikari_connection_pool.description")}),e.jsx(c,{edge:"end",checked:r.useHikariConnectionPool,onChange:t=>a("useHikariConnectionPool",t.target.checked)})]})]}),e.jsxs(g,{subheader:e.jsx(h,{component:"div",id:"server-settings-misc",children:s("settings.server.misc.title")}),children:[e.jsxs(d,{children:[e.jsx(o,{primary:s("settings.server.misc.log_level.label.server")}),e.jsx(c,{edge:"end",checked:r.debugLogsEnabled,onChange:t=>a("debugLogsEnabled",t.target.checked)})]}),e.jsxs(d,{children:[e.jsx(o,{primary:s("settings.server.misc.tray_icon.label.title"),secondary:s("settings.server.misc.tray_icon.label.description")}),e.jsx(c,{edge:"end",checked:r.systemTrayEnabled,onChange:t=>a("systemTrayEnabled",t.target.checked)})]}),e.jsx(p,{settingTitle:s("settings.server.misc.log_files.file_cleanup.title"),settingValue:ve(r.maxLogFiles),value:r.maxLogFiles,valueUnit:s("global.date.label.day_one"),handleUpdate:t=>a("maxLogFiles",t)}),e.jsx(i,{settingName:s("settings.server.misc.log_files.file_size.title"),value:r.maxLogFileSize,dialogDescription:s("settings.server.misc.log_files.file_size.description"),validate:t=>!!t.match(/^[0-9]+(|kb|KB|mb|MB|gb|GB)$/g),handleChange:t=>a("maxLogFileSize",t)}),e.jsx(i,{settingName:s("settings.server.misc.log_files.total_size.title"),value:r.maxLogFolderSize,dialogDescription:s("settings.server.misc.log_files.total_size.description"),validate:t=>!!t.match(/^[0-9]+(|kb|KB|mb|MB|gb|GB)$/g),handleChange:t=>a("maxLogFolderSize",t)})]})]})};export{Le as ServerSettings};
