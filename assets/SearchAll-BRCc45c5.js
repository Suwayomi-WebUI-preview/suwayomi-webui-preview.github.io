import{R as H,u as F,a as B,c as n,j as s,L as I,T,ap as O,k as P,N as Q,W as V,aj as W,d as _,f as v,h as z,E as J,l as K,m as U}from"./index-DoPHSvD2.js";import{u as X,A as Y,S as Z}from"./AppbarSearch-BnORLuPb.js";import{t as ee,L as te}from"./LangSelect-B92MVDdL.js";import{M as se}from"./MangaGrid-Bj2FkeOE.js";import{u as A}from"./useDebounce-DYEMI-51.js";import{C as re,a as ae}from"./index-OkDh7pBl.js";import"./useManageMangaLibraryState-DgpV7a14.js";import"./CardContent-CDJswldz.js";import"./Avatar-E9eZ4lsI.js";import"./TextField-DNgJoY7o.js";import"./InputAdornment-B_VOiAO2.js";import"./SpinnerImage-QWudGzLs.js";import"./Collapse-DPzaQk5m.js";import"./Link-C6jf0ICd.js";import"./ListPreference-CtJAtyXS.js";import"./Checkbox-C3acb9E7.js";import"./SwitchBase-BW4HniC2.js";import"./NumberSetting-CzvgGT8U.js";import"./Info-v3XTjq6g.js";import"./useMobilePicker-BZfUxbmW.js";import"./Chip-CoaUGrat.js";import"./SelectSetting-D6vWw_L-.js";import"./Select-DAJ_ySzf.js";import"./CheckboxInput-CCl6cmXH.js";import"./metadataServerSettings-BpNSfY5a.js";import"./metadata-pNRG_XKl.js";import"./Mangas-kV-ePVio.js";import"./Chapters-D1HEY9lE.js";import"./ThreeStateCheckboxInput-DdfX0Vu_.js";import"./FilterList-KQECrs5U.js";import"./cloneObject-DrOPTG0J.js";import"./Switch-D5pRLzor.js";import"./Delete-C-AxNQho.js";import"./Sync-qLKsivqz.js";import"./PlayArrow-Dcb9rQ3i.js";import"./StyledFab-C3OQw_ma.js";function oe(t){const r=[];return t.forEach(e=>{r.indexOf(e.lang)===-1&&r.push(e.lang)}),r.sort(K),r}const ne=(t,r)=>t.displayName<r.displayName?-1:t.displayName>r.displayName?1:0,ie=(t,r,e)=>{var g,h,o,m;const p=!((g=e.get(t.id))!=null&&g.isLoading),i=!((h=e.get(r.id))!=null&&h.isLoading);if(p&&!i)return-1;if(!p&&i)return 1;if(!p&&!i)return 0;const u=!((o=e.get(t.id))!=null&&o.hasResults),d=!((m=e.get(r.id))!=null&&m.hasResults);return u&&!d?1:d&&!u?-1:0},ce=1e3,ue=H.memo(({source:t,onSearchRequestFinished:r,searchString:e,emptyQuery:p,mode:i})=>{var y;const{t:u}=F(),{id:d,displayName:g,lang:h}=t,[o,m]=B.useSourceSearch(d,e!=null?e:"",void 0,1,{skipRequest:!e,addAbortSignal:!0}),{data:S,isLoading:c,error:x,abortRequest:E}=m[0],w=(y=S==null?void 0:S.fetchSourceManga.mangas)!=null?y:[],l=!c&&!w.length;n.useEffect(()=>{r(t,c,!l,!e)},[c,l,e]);let f;return x?f=u("search.error.label.source_search_failed"):l&&(f=u("manga.error.label.no_mangas_found")),n.useEffect(()=>()=>{E(new Error("SourceSearchPreview(".concat(t.id,", ").concat(t.displayName,"): search string changed")))},[e]),!c&&!e||p?null:s.jsxs(s.Fragment,{children:[s.jsx(re,{sx:{margin:"10px"},children:s.jsxs(ae,{component:I,to:"/sources/".concat(d,"?query=").concat(e),sx:{p:3},children:[s.jsx(T,{variant:"h5",children:g}),s.jsx(T,{variant:"caption",children:ee(h)})]})}),f?s.jsx(O,{sx:{alignItems:"start"},noFaces:!0,message:f,messageExtra:x&&x.message,retry:x?()=>o(1).catch(P("SourceSearchPreview(".concat(t.id,")::refetch"))):void 0}):s.jsx(se,{mangas:w,isLoading:c,hasNextPage:!1,loadMore:()=>{},horizontal:!0,noFaces:!0,message:f,inLibraryIndicator:!0,mode:i})]})}),We=()=>{var R;const{t}=F(),{setTitle:r,setAction:e}=n.useContext(Q);V("browse");const{pathname:p,state:i}=W(),u=p.startsWith("/migrate/source"),d=i==null?void 0:i.mangaTitle,[g]=X("query",Z),h=A(g,ce),[o,m]=_("shownSourceLangs",U()),[S]=_("showNsfw",!0),{data:c,loading:x,error:E,refetch:w}=B.useGetSourceList({notifyOnNetworkStatusChange:!0}),l=(R=c==null?void 0:c.sources.nodes)!=null?R:[],[f,y]=n.useState(new Map),j=A(f,500),N=n.useMemo(()=>[...l].sort(ne),[l]),b=n.useMemo(()=>N.filter(a=>o.includes(a.lang)),[N,o]),M=n.useMemo(()=>b.filter(a=>S||!a.isNsfw),[b,S]),q=n.useMemo(()=>[...M].sort((a,L)=>ie(a,L,j)),[M,j]),k=n.useCallback(({id:a},L,D,$)=>{y(G=>{const C=new Map(G);return C.set(a,{isLoading:L,hasResults:D,emptySearch:$}),C})},[y]);return n.useEffect(()=>(r(t(u?"migrate.search.title":"search.title.global_search",{title:d})),e(s.jsxs(s.Fragment,{children:[s.jsx(Y,{isClosable:!1}),s.jsx(te,{shownLangs:o,setShownLangs:m,allLangs:oe(l),forcedLangs:v()})]})),()=>{r(""),e(null)}),[t,o,m,l]),n.useEffect(()=>{const a=v().filter(L=>!o.includes(L));m([...o,...a])},[]),x?s.jsx(z,{}):E?s.jsx(J,{message:t("global.error.label.failed_to_load_data"),messageExtra:E.message,retry:()=>w().catch(P())}):s.jsx(s.Fragment,{children:q.map(a=>s.jsx(ue,{source:a,onSearchRequestFinished:k,searchString:h,emptyQuery:!g,mode:u?"migrate.select":"source"},a.id))})};export{We as SearchAll};
