import{R as D,u as v,a as A,c as n,j as r,L as $,T as j,ae as k,h as G,N as H,A as I,a7 as O,d as b}from"./index-Zl59rTnr.js";import{u as Q,A as z,S as V}from"./AppbarSearch-CsotfqTa.js";import{s as C,l as W,a as J}from"./language-CcP_OM1B.js";import{t as K,L as U}from"./LangSelect-BsBZffmq.js";import{M as X}from"./MangaGrid-sXgrtb3t.js";import{u as T}from"./useDebounce-jELv4YlT.js";import{C as Y,a as Z}from"./index-DQrhUqKj.js";import"./useManageMangaLibraryState-CawoFeDt.js";import"./MenuItem-DWrnvo_k.js";import"./CardContent-RtU3w6b_.js";import"./Avatar-922Wk_ln.js";import"./TextField-lew-bJf8.js";import"./InputAdornment-C6brfzM8.js";import"./SpinnerImage-DiQGN4Ou.js";import"./Collapse-NT65VyrV.js";import"./Link-DNDUF647.js";import"./index-D03_UwGI.js";import"./Chip-DIc23AWH.js";import"./ListPreference-B4Yqea6O.js";import"./Checkbox-STjbDH5e.js";import"./SwitchBase-B5dQFXOZ.js";import"./NumberSetting-D95Za2Yx.js";import"./Info-CBdRtVcr.js";import"./dayjs.min-ByUHsGI2.js";import"./useMobilePicker-BrirqG1O.js";import"./SelectSetting-DVozOvvZ.js";import"./Select-BndaAxxl.js";import"./CheckboxInput-DqA77Hjg.js";import"./metadataServerSettings-Bu9SBxLq.js";import"./metadata-3dsaWhfv.js";import"./Mangas-D6kqk8_N.js";import"./Chapters-BDtuZBKt.js";import"./ThreeStateCheckboxInput-wO9QFGNa.js";import"./FilterList-Cm7vK8WS.js";import"./cloneObject-DrOPTG0J.js";import"./Switch-Dz039eWF.js";import"./Delete-BgE5pKr0.js";import"./Sync-B5XFkS26.js";import"./PlayArrow-CEADbSL0.js";import"./StyledFab--ltFOeG8.js";function ee(t){const s=[];return t.forEach(e=>{s.indexOf(e.lang)===-1&&s.push(e.lang)}),s.sort(W),s}const te=(t,s)=>t.displayName<s.displayName?-1:t.displayName>s.displayName?1:0,se=(t,s,e)=>{var f,h,a,l;const d=!((f=e.get(t.id))!=null&&f.isLoading),i=!((h=e.get(s.id))!=null&&h.isLoading);if(d&&!i)return-1;if(!d&&i)return 1;if(!d&&!i)return 0;const u=!((a=e.get(t.id))!=null&&a.hasResults),g=!((l=e.get(s.id))!=null&&l.hasResults);return u&&!g?1:g&&!u?-1:0},re=1e3,oe=D.memo(({source:t,onSearchRequestFinished:s,searchString:e,emptyQuery:d,mode:i})=>{var y;const{t:u}=v(),{id:g,displayName:f,lang:h}=t,[a,l]=A.useSourceSearch(g,e!=null?e:"",void 0,1,{skipRequest:!e,addAbortSignal:!0}),{data:S,isLoading:c,error:m,abortRequest:E}=l[0],x=(y=S==null?void 0:S.fetchSourceManga.mangas)!=null?y:[],L=!c&&!x.length;n.useEffect(()=>{s(t,c,!L,!e)},[c,L,e]);let p;return m?p=u("search.error.label.source_search_failed"):L&&(p=u("manga.error.label.no_mangas_found")),n.useEffect(()=>()=>{E(new Error("SourceSearchPreview(".concat(t.id,", ").concat(t.displayName,"): search string changed")))},[e]),!c&&!e||d?null:r.jsxs(r.Fragment,{children:[r.jsx(Y,{sx:{margin:"10px"},children:r.jsxs(Z,{component:$,to:"/sources/".concat(g,"?query=").concat(e),sx:{p:3},children:[r.jsx(j,{variant:"h5",children:f}),r.jsx(j,{variant:"caption",children:K(h)})]})}),p?r.jsx(k,{sx:{alignItems:"start"},noFaces:!0,message:p,messageExtra:m&&m.message,retry:m?()=>a(1).catch(G("SourceSearchPreview(".concat(t.id,")::refetch"))):void 0}):r.jsx(X,{mangas:x,isLoading:c,hasNextPage:!1,loadMore:()=>{},horizontal:!0,noFaces:!0,message:p,inLibraryIndicator:!0,mode:i})]})}),ze=()=>{var N;const{t}=v(),{setTitle:s,setAction:e}=n.useContext(H);I("browse");const{pathname:d,state:i}=O(),u=d.startsWith("/migrate/source"),g=i==null?void 0:i.mangaTitle,[f]=Q("query",V),h=T(f,re),[a,l]=b("shownSourceLangs",J()),[S]=b("showNsfw",!0),{data:c}=A.useGetSourceList(),m=(N=c==null?void 0:c.sources.nodes)!=null?N:[],[E,x]=n.useState(new Map),L=T(E,500),p=n.useMemo(()=>[...m].sort(te),[m]),y=n.useMemo(()=>p.filter(o=>a.includes(o.lang)),[p,a]),M=n.useMemo(()=>y.filter(o=>S||!o.isNsfw),[y,S]),F=n.useMemo(()=>[...M].sort((o,w)=>se(o,w,L)),[M,L]),B=n.useCallback(({id:o},w,q,P)=>{x(_=>{const R=new Map(_);return R.set(o,{isLoading:w,hasResults:q,emptySearch:P}),R})},[x]);return n.useEffect(()=>(s(t(u?"migrate.search.title":"search.title.global_search",{title:g})),e(r.jsxs(r.Fragment,{children:[r.jsx(z,{isClosable:!1}),r.jsx(U,{shownLangs:a,setShownLangs:l,allLangs:ee(m),forcedLangs:C()})]})),()=>{s(""),e(null)}),[t,a,l,m]),n.useEffect(()=>{const o=C().filter(w=>!a.includes(w));l([...a,...o])},[]),r.jsx(r.Fragment,{children:F.map(o=>r.jsx(oe,{source:o,onSearchRequestFinished:B,searchString:h,emptyQuery:!f,mode:u?"migrate.select":"source"},o.id))})};export{ze as SearchAll};
