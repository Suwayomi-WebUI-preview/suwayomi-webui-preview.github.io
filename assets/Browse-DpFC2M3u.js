import{c as Z,j as e,u as y,A as N,L as R,r as T,S as V,T as v,l as Se,B as P,C as M,I as U,m as I,g as w,a as ee,b as l,D as Ae,d as ke,e as te,f as B,t as H,h as pe,i as Ne,k as Me,n as Ue,o as Oe,p as Re,q as Pe,s as Be,v as je,w as me,x as De,y as Ge,z as Fe,E as He,F as he,G as ge,H as ze,J as Ke}from"./index-C0ZqUDx8.js";import{u as Ce,S as be,A as Ve}from"./AppbarSearch-DschGkNr.js";import{P as qe}from"./PushPin-D3iEMalJ.js";import{P as We}from"./PushPinOutlined-PngOvKSk.js";import{SourceContentType as xe}from"./SourceMangas-D-iMHXVJ.js";import{M as Q}from"./MUI.util-CYBuX_Wz.js";import{u as $e,S as k,c as Xe}from"./Sources-CYqaWpZb.js";import{L as se}from"./ListCardAvatar-CWSGHb8q.js";import{L as ne}from"./ListCardContent-CUkm220P.js";import{C as oe}from"./Card-oXl8mL2L.js";import{C as re}from"./CardActionArea-CuRksLjd.js";import{E as K}from"./EmptyViewAbsoluteCentered-JpSY28n0.js";import{i as Ye,t as q,g as z,I as Je,a as Qe,E as ve,b as G,c as Ze,u as et,d as tt,e as st,f as nt,h as ot,j as rt,k as at}from"./Extensions.utils-CLMjzkCT.js";import{u as Ee}from"./useAppAction-BSgC9hYu.js";import{S as Le,a as Te}from"./StyledGroupHeader-C2r3bNQB.js";import{V as ye}from"./Virtuoso.util-CzWcZcaM.js";import{S as ae}from"./StyledGroupItemWrapper-1u_E4PWF.js";import{S as it}from"./SourceLanguageSelect-Blne0tfU.js";import{f as ct}from"./file-selector-DlHkLoY8.js";import{A as lt}from"./Add-W_dqWCPy.js";import{F as ut}from"./FilterList-Cd7D8yu_.js";import{K as dt}from"./index-CxP8dToc.js";import{S as pt}from"./Switch-daGblwPp.js";import{u as fe}from"./use-window-event-Bwn7WWg4.js";import{T as Y,a as J}from"./Tabs-DbfMS3x9.js";import{T as mt}from"./TabsWrapper-CcnLssme.js";import{T as ht}from"./TabsMenu-DwYYK4eD.js";import{A as gt,a as xt}from"./SortRadioInput-OUh4spjT.js";import{C as ft}from"./Chip-IGqqGD9E.js";import{u as St}from"./useAppTitle-CNMNdZZs.js";import"./ChaptersDownloadActionMenuItems-0u6EfeL6.js";import"./Trackers-COtG7wmP.js";import"./Avatar-DprMOFwE.js";import"./TextField-C6nKfsRp.js";import"./useFormControl-DCccktlq.js";import"./formControlState-Dq1zat_P.js";import"./InputAdornment-D23zkx-9.js";import"./CheckCircle-Dvmfbsw0.js";import"./Metadata-Cp_CXSY6.js";import"./Link-Csr5AtxJ.js";import"./useManageMangaLibraryState-BOug-YWK.js";import"./ThreeStateCheckboxInput-DBWMjHks.js";import"./Checkbox-C4OqfELq.js";import"./SwitchBase-0IJaNJs2.js";import"./CheckboxInput-CYPDCUne.js";import"./FormGroup-vQZEx7Pp.js";import"./ListPreference-p9JbreVH.js";import"./NumberSetting-CmA5nQSe.js";import"./Slider-DlSGQcoW.js";import"./useMobilePicker-D7TIDcpN.js";import"./SelectSetting-CUOPirzr.js";import"./Select-BpkSiirO.js";import"./Favorite-D9BjhVde.js";import"./GridLayouts-CNskTyli.js";import"./Delete-DSz7DgtZ.js";import"./ExpandMore-D7c8Ljcn.js";import"./useDebounce-DcLr46kR.js";import"./StyledFab-BssC8p5H.js";import"./BaseMangaGrid-D5DZEHSu.js";import"./MangaGrid-D5mudlYL.js";import"./Download-D2H1NUZZ.js";import"./Sync-CJWa6u5N.js";import"./use-merged-ref-BHEugcGW.js";import"./PlayArrow-aMleKoqV.js";import"./useAppTitleAndAction-THJl2_-q.js";import"./ListItemAvatar-C3ptjerG.js";const jt=Z(e.jsx("path",{d:"M19.3 16.9c.4-.7.7-1.5.7-2.4 0-2.5-2-4.5-4.5-4.5S11 12 11 14.5s2 4.5 4.5 4.5c.9 0 1.7-.3 2.4-.7l3.2 3.2 1.4-1.4zm-3.8.1c-1.4 0-2.5-1.1-2.5-2.5s1.1-2.5 2.5-2.5 2.5 1.1 2.5 2.5-1.1 2.5-2.5 2.5M12 20v2C6.48 22 2 17.52 2 12S6.48 2 12 2c4.84 0 8.87 3.44 9.8 8h-2.07c-.64-2.46-2.4-4.47-4.73-5.41V5c0 1.1-.9 2-2 2h-2v2c0 .55-.45 1-1 1H8v2h2v3H9l-4.79-4.79C4.08 10.79 4 11.38 4 12c0 4.41 3.59 8 8 8"})),Ct=u=>{const{t}=y(),{source:n,showSourceRepo:p,showLanguage:c}=u,{id:s,name:o,lang:r,iconUrl:m,supportsLatest:S,isNsfw:i,extension:{repo:g}}=n,{isPinned:d}=$e(n),x=k.isLocalSource(n)?t("source.local_source.title"):o,f=Xe(n,b=>I(t("global.error.label.failed_to_save_changes"),"error",w(b)));return e.jsx(oe,{children:e.jsx(re,{component:R,to:N.sources.childRoutes.browse.path(s),state:{contentType:xe.POPULAR,clearCache:!0},children:e.jsxs(ne,{children:[e.jsx(se,{iconUrl:T.getValidImgUrlFor(m),alt:x}),e.jsxs(V,{sx:{justifyContent:"center",flexGrow:1,flexShrink:1,wordBreak:"break-word"},children:[e.jsx(v,{variant:"h6",component:"h3",children:x}),e.jsxs(v,{variant:"caption",children:[c&&Se(r),i&&e.jsx(v,{variant:"caption",color:"error",children:" 18+"})]}),p&&e.jsx(v,{variant:"caption",children:g})]}),S&&e.jsx(P,{...Q.preventRippleProp(),variant:"outlined",component:R,to:N.sources.childRoutes.browse.path(s),state:{contentType:xe.LATEST,clearCache:!0},children:t("global.button.latest")}),e.jsx(M,{title:t(d?"source.pin.remove":"source.pin.add"),children:e.jsx(U,{...Q.preventRippleProp(),onClick:b=>{b.preventDefault(),f("isPinned",!d)},color:d?"primary":"inherit",children:d?e.jsx(qe,{}):e.jsx(We,{})})})]})})})};function bt({tabsMenuHeight:u}){const{t}=y(),{languages:n,setLanguages:p}=k.useLanguages(),{settings:{showNsfw:c,lastUsedSourceId:s}}=ee(),{data:o,loading:r,error:m,refetch:S}=T.useGetSourceList({notifyOnNetworkStatusChange:!0}),i=o==null?void 0:o.sources.nodes,g=l.useMemo(()=>k.filter(i!=null?i:[],{showNsfw:c,languages:n,keepLocalSource:!0,enabled:!0}),[i,n]),d=l.useMemo(()=>{const h=k.getLastUsedSource(s,g),C=Object.entries(k.groupByLanguage(g));return h?[[Ae.LAST_USED_SOURCE,[h]],...C]:C},[g]),x=l.useMemo(()=>k.getLanguages(i!=null?i:[]),[i]),f=l.useMemo(()=>k.areFromMultipleRepos(g),[g]),b=l.useMemo(()=>d.map(([,h])=>h).flat(1),[d]),L=l.useMemo(()=>d.map(h=>h[1].length),[d]),_=ye.useCreateGroupedComputeItemKey(L,l.useCallback(h=>d[h][0],[d]),l.useCallback((h,C)=>"".concat(d[C][0],"_").concat(b[h].id),[b])),O=ke();return Ee(e.jsxs(e.Fragment,{children:[e.jsx(M,{title:t("search.title.global_search"),children:e.jsx(U,{onClick:()=>O(N.sources.childRoutes.searchAll.path()),color:"inherit",children:e.jsx(jt,{})})}),e.jsx(it,{selectedLanguages:n,setSelectedLanguages:p,languages:x,sources:i!=null?i:[]})]}),[t,n,x,i]),r?e.jsx(te,{}):m?e.jsx(K,{message:t("global.error.label.failed_to_load_data"),messageExtra:w(m),retry:()=>S().catch(B())}):(i==null?void 0:i.length)===0?e.jsx(K,{message:t("source.error.label.no_sources_found")}):e.jsx(Le,{persistKey:"sources",heightToSubtract:u,overscan:window.innerHeight*.5,groupCounts:L,computeItemKey:_,groupContent:h=>{const[C]=d[h];return e.jsx(Te,{isFirstItem:!h,children:e.jsx(v,{variant:"h5",component:"h2",children:q(C)})})},itemContent:(h,C)=>{const D=d[C][0],j=b[h];return e.jsx(ae,{children:e.jsx(Ct,{source:j,showSourceRepo:f,showLanguage:Ye(D)})})}})}function vt(u){const{t}=y(),{selectedLanguages:n,setSelectedLanguages:p,languages:c}=u,[s,o]=l.useState(H(n)),[r,m]=l.useState(!1),S=l.useMemo(()=>H([...s.toSorted(pe),...c.toSorted(pe)]),[c,s]),i=()=>{m(!1),o(H(n))},g=()=>{m(!1),p(H(s))},d=(x,f)=>{o(f?[...s,x]:s.toSpliced(s.indexOf(x),1))};return e.jsxs(e.Fragment,{children:[e.jsx(M,{title:t("settings.title"),children:e.jsx(U,{onClick:()=>m(!0),"aria-label":"display more actions",edge:"end",color:"inherit",children:e.jsx(ut,{})})}),e.jsxs(Ne,{fullWidth:!0,maxWidth:"xs",open:r,onClose:i,children:[e.jsx(Me,{children:t("global.language.title.enabled_languages")}),e.jsx(Ue,{dividers:!0,sx:{padding:0},children:e.jsx(dt,{style:{height:S.length*54,minHeight:"25vh",maxHeight:"50vh"},data:S,increaseViewportBy:400,computeItemKey:x=>S[x],itemContent:(x,f)=>e.jsxs(Oe,{children:[e.jsx(Re,{primary:q(f)}),e.jsx(pt,{checked:s.includes(f),onChange:b=>d(f,b.target.checked)})]})})}),e.jsxs(Pe,{children:[e.jsx(P,{autoFocus:!0,onClick:i,color:"primary",children:t("global.button.cancel")}),e.jsx(P,{onClick:g,color:"primary",children:t("global.button.ok")})]})]})]})}const Et=({disabled:u,children:t,...n})=>u?t:e.jsx(re,{component:R,...n,children:t});function Lt(u){const{t}=y(),{extension:{name:n,lang:p,versionName:c,isInstalled:s,hasUpdate:o,isObsolete:r,pkgName:m,iconUrl:S,isNsfw:i,repo:g},handleUpdate:d,showSourceRepo:x,forcedState:f}=u,[b,L]=l.useState(z(s,r,o)),_=f!=null?f:b;l.useEffect(()=>{L(z(s,r,o))},[z(s,r,o)]);const O=async C=>{const D=tt[C],j=Ze[C];try{L(j),await et(m,r,C),L(D),d()}catch(W){L(z(s,r,o))}};function h(){switch(_){case G.INSTALL:case G.UPDATE:case G.UNINSTALL:O(_).catch(B());break;case ve.OBSOLETE:O(G.UNINSTALL).catch(B());break}}return e.jsx(oe,{children:e.jsx(Et,{disabled:!s,to:N.extension.childRoutes.info.path(m),children:e.jsxs(ne,{children:[e.jsx(se,{iconUrl:T.getValidImgUrlFor(S),alt:n}),e.jsxs(V,{sx:{justifyContent:"center",flexGrow:1,flexShrink:1,wordBreak:"break-word"},children:[e.jsx(v,{variant:"h6",component:"h3",children:n}),e.jsxs(v,{variant:"caption",children:[s?"".concat(Se(p)," "):"",c,i&&e.jsx(v,{variant:"caption",color:"error",children:" 18+"})]}),x&&e.jsx(v,{variant:"caption",children:g})]}),s&&e.jsx(M,{title:t("settings.title"),children:e.jsx(U,{component:R,to:N.extension.childRoutes.info.path(m),color:"inherit",...Q.preventRippleProp(),children:e.jsx(Be,{})})}),e.jsx(P,{variant:"outlined",sx:{color:_===Qe.OBSOLETE?"red":"inherit",flexShrink:0},onClick:()=>h(),children:t(Je[_])})]})})})}const Tt=0,yt=1,_t=({groupName:u,isFirstItem:t,groupExtensionIds:n,isUpdateGroup:p,updatingExtensionIds:c,setUpdatingExtensionIds:s,handleExtensionUpdate:o})=>{const{t:r}=y();return e.jsxs(Te,{isFirstItem:t,sx:{flexDirection:"row",justifyContent:"space-between",alignItems:"center",pr:1},children:[e.jsx(v,{variant:"h5",component:"h2",children:q(u)}),p&&e.jsx(P,{disabled:!!c.length,variant:"contained",onClick:()=>{s(n),T.updateExtensions(n,{update:!0}).response.then(()=>o()).catch(m=>I(r(at[G.UPDATE],{count:n.length}),"error",w(m))).finally(()=>s([]))},children:r("extension.action.label.update_all")})]},u)};function It({tabsMenuHeight:u}){var ue,de;const{t}=y(),{data:n,loading:p,error:c,refetch:s}=T.useGetServerSettings({notifyOnNetworkStatusChange:!0}),[o,{data:r,loading:m,error:S}]=T.useExtensionListFetch(),{settings:{extensionLanguages:i,showNsfw:g}}=ee(),d=je(a=>I(t("global.error.label.failed_to_save_changes"),"error",w(a))),[x]=Ce("query",be),[f,b]=l.useState([]),[L,_]=l.useState({}),O=p||m,h=c!=null?c:S,C=!!(n!=null&&n.settings.extensionRepos.length),D=((ue=n==null?void 0:n.settings.extensionRepos.length)!=null?ue:0)>1,j=(de=r==null?void 0:r.fetchExtensions)==null?void 0:de.extensions,W=l.useMemo(()=>st(j!=null?j:[]),[j]),ie=l.useMemo(()=>nt(j!=null?j:[],{selectedLanguages:i,showNsfw:g,query:x}),[j,i,g,x]),A=l.useMemo(()=>ot(ie),[ie]),ce=l.useMemo(()=>A.map(a=>a[yt].length),[A]),$=l.useMemo(()=>A.map(([,a])=>a).flat(1),[A]),_e=ye.useCreateGroupedComputeItemKey(ce,l.useCallback(a=>A[a][Tt],[A]),l.useCallback(a=>$[a].pkgName,[$])),X=l.useCallback(()=>_({}),[]),le=a=>{if(!a.name.toLowerCase().endsWith("apk")){I(t("global.error.label.invalid_file_type"),"error");return}I(t("extension.label.installing_file"),"info"),T.installExternalExtension(a).response.then(()=>{X(),I(t("extension.label.installed_successfully"),"success")}).catch(E=>I(t("extension.label.installation_failed"),"error",w(E)))};return l.useEffect(()=>{o()},[L]),Ee(e.jsxs(e.Fragment,{children:[e.jsx(Ve,{}),e.jsx(M,{title:t("extension.action.label.install_external"),children:e.jsx(U,{onClick:()=>{const a=document.createElement("input");a.style.display="none",a.type="file",a.onchange=()=>{var F;const E=(F=a.files)==null?void 0:F[0];E&&le(E)},document.documentElement.appendChild(a),a.click(),document.documentElement.removeChild(a)},color:"inherit",children:e.jsx(lt,{})})}),e.jsx(vt,{selectedLanguages:i,setSelectedLanguages:a=>d("extensionLanguages",a),languages:W})]}),[t,i,W]),fe("drop",async a=>{a.preventDefault();const E=await ct(a);le(E[0])}),fe("dragover",a=>{a.preventDefault()}),O?e.jsx(te,{}):h?e.jsx(K,{message:t("global.error.label.failed_to_load_data"),messageExtra:w(h),retry:()=>{c&&s().catch(B()),S&&o().catch(B())}}):!(j!=null&&j.length)&&!C?e.jsxs(V,{sx:{alignItems:"center",justifyContent:"center",rowGap:"10px",paddingTop:"20px"},children:[e.jsx(v,{children:t("extension.label.add_repository_info")}),e.jsx(P,{component:R,variant:"contained",to:N.settings.childRoutes.browse.path,children:t("settings.title")})]}):e.jsx(Le,{persistKey:"extensions",heightToSubtract:u,overscan:window.innerHeight*.5,groupCounts:ce,groupContent:a=>{const[E,F]=A[a],Ie=E===rt.UPDATE_PENDING;return e.jsx(_t,{groupName:E,isFirstItem:a===0,groupExtensionIds:F.map(we=>we.pkgName),isUpdateGroup:Ie,updatingExtensionIds:f,setUpdatingExtensionIds:b,handleExtensionUpdate:X})},computeItemKey:_e,itemContent:a=>{const E=$[a];return e.jsx(ae,{children:e.jsx(Lt,{extension:E,handleUpdate:X,showSourceRepo:D,forcedState:f.includes(E.pkgName)?ve.UPDATING:void 0})})}})}const wt=Z(e.jsx("path",{d:"M14.94 4.66h-4.72l2.36-2.36zm-4.69 14.71h4.66l-2.33 2.33zM6.1 6.27 1.6 17.73h1.84l.92-2.45h5.11l.92 2.45h1.84L7.74 6.27zm-1.13 7.37 1.94-5.18 1.94 5.18zm10.76 2.5h6.12v1.59h-8.53v-1.29l5.92-8.56h-5.88v-1.6h8.3v1.26z"})),At=Z(e.jsx("path",{d:"M20 10V8h-4V4h-2v4h-4V4H8v4H4v2h4v4H4v2h4v4h2v-4h4v4h2v-4h4v-2h-4v-4zm-6 4h-4v-4h4z"})),kt=({id:u,name:t,lang:n,iconUrl:p,mangaCount:c})=>{const{t:s}=y(),r=Number(u)===0?s("source.local_source.title"):t;return e.jsx(oe,{children:e.jsx(re,{component:R,to:N.migrate.path(u),children:e.jsxs(ne,{sx:{justifyContent:"space-between"},children:[e.jsxs(me,{sx:{display:"flex",gap:1},children:[e.jsx(se,{iconUrl:T.getValidImgUrlFor(p),alt:r}),e.jsxs(me,{sx:{display:"flex",flexDirection:"column",justifyContent:"center"},children:[e.jsx(v,{variant:"h6",component:"h3",children:r}),e.jsx(v,{variant:"caption",sx:{display:"block"},children:q(n)})]})]}),e.jsx(ft,{sx:{borderRadius:1},size:"small",label:c})]})})})},Nt=(u,{sortBy:t,sortOrder:n})=>{if(!u)return[];const p={};u.forEach(({sourceId:s,source:o})=>{var m;const r=(m=p[s])!=null?m:{id:s,name:s,lang:"unknown",iconUrl:null,mangaCount:0,...o};p[s]={...r,mangaCount:r.mangaCount+1}});const c=Object.values(p).toSorted((s,o)=>{switch(t){case he.SOURCE_NAME:return s.name.localeCompare(o.name);case he.MANGA_COUNT:return s.mangaCount-o.mangaCount;default:throw new Error('Unexpected "sortBy" "'.concat(t,'"'))}});switch(n){case ge.ASC:return c;case ge.DESC:return c.toReversed();default:throw new Error('Unexpected "sortOrder" "'.concat(n,'"'))}},Mt=({tabsMenuHeight:u})=>{const{t}=y(),{appBarHeight:n}=De(),{settings:{migrateSortSettings:p}}=ee(),c=je(d=>I(t("global.error.label.failed_to_save_changes"),"error",w(d))),{sortBy:s,sortOrder:o}=p,{data:r,loading:m,error:S,refetch:i}=T.useGetMigratableSources({notifyOnNetworkStatusChange:!0}),g=l.useMemo(()=>Nt(r==null?void 0:r.mangas.nodes,p),[r==null?void 0:r.mangas.nodes,p]);return m?e.jsx(te,{}):S?e.jsx(K,{message:t("global.error.label.failed_to_load_data"),messageExtra:w(S),retry:()=>i().catch(B())}):e.jsxs(e.Fragment,{children:[e.jsxs(V,{sx:{position:"sticky",top:"".concat(n+u,"px"),flexDirection:"row",justifyContent:"end",alignItems:"center",gap:1,p:1,backgroundColor:"background.default",zIndex:1},children:[e.jsx(M,{title:t(Ge[s]),children:e.jsx(U,{color:"inherit",onClick:()=>c("migrateSortSettings",{sortBy:(s+1)%2,sortOrder:o}),children:s?e.jsx(At,{}):e.jsx(wt,{})})}),e.jsx(M,{title:t(Fe[o]),children:e.jsx(U,{color:"inherit",onClick:()=>c("migrateSortSettings",{sortBy:s,sortOrder:(o+1)%2}),children:o?e.jsx(gt,{}):e.jsx(xt,{})})})]}),e.jsx(He,{sx:{p:0},children:g.map(d=>e.jsx(ae,{children:e.jsx(kt,{...d})},d.id))})]})};function Ws(){const{t:u}=y();St(u("global.label.browse"));const t=l.useRef(null),[n,p]=l.useState(0);ze(t,l.useCallback(()=>p(t.current.offsetHeight),[t.current]));const[c,s]=Ce("tab",be,{}),o=c!=null?c:"source";return c||s(o,"replaceIn"),e.jsxs(mt,{children:[e.jsxs(ht,{ref:t,sx:{zIndex:Ke},variant:"fullWidth",value:o,onChange:(r,m)=>s(m,"replaceIn"),children:[e.jsx(Y,{value:"source",sx:{textTransform:"none"},label:u("source.title_one")}),e.jsx(Y,{value:"extensions",sx:{textTransform:"none"},label:u("extension.title_other")}),e.jsx(Y,{value:"migrate",sx:{textTransform:"none"},label:u("migrate.title")})]}),e.jsx(J,{index:"source",currentIndex:o,children:e.jsx(bt,{tabsMenuHeight:n})}),e.jsx(J,{index:"extensions",currentIndex:o,children:e.jsx(It,{tabsMenuHeight:n})}),e.jsx(J,{index:"migrate",currentIndex:o,children:e.jsx(Mt,{tabsMenuHeight:n})})]})}export{Ws as Browse};
