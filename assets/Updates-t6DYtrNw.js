import{u as z,aI as Q,f as n,N as W,c as h,j as e,E as v,m as y,n as $,T as I,bB as J,l as X,C as Y,a as Z,L as _,A as E,b as ee,B as L,S as te,bC as M,K as ae,O as se,k as P,I as R,P as oe,ah as re,bD as ne,bE as ie,o as A}from"./index-CdMcb195.js";import{U as le}from"./UpdateChecker-C8hZH_H1.js";import{V as de,S as ce,a as pe,b as ue}from"./Virtuoso.util-X2kl8SCm.js";import{M as he}from"./Mangas-CzvEKOUW.js";import{A as me}from"./Avatar-Ct8d5o_D.js";import"./Progress-R_1Q6t8z.js";const ge=s=>{if(!s.length)return[];const d=new Map;return s.forEach(m=>{var o;const c=ne(ie(Number(m.fetchedAt)));d.set(c,((o=d.get(c))!=null?o:0)+1)}),[...d.entries()]},we=()=>{var k,S;const{t:s}=z(),d=Q(),{setTitle:m,setAction:c}=n.useContext(W),{data:o,loading:C,error:j,fetchMore:G,refetch:B}=h.useGetRecentlyUpdatedChapters(void 0,{fetchPolicy:"cache-and-network",notifyOnNetworkStatusChange:!0}),w=!!(o!=null&&o.chapters.pageInfo.hasNextPage),D=o==null?void 0:o.chapters.pageInfo.endCursor,i=(k=o==null?void 0:o.chapters.nodes)!=null?k:[],p=n.useMemo(()=>ge(i),[i]),T=n.useMemo(()=>p.map(t=>t[1]),[p]),{data:g}=h.useGetDownloadStatus(),U=(S=g==null?void 0:g.downloadStatus.queue)!=null?S:[],F=de.useCreateGroupedComputeItemKey(T,n.useCallback(t=>p[t][0],[p]),n.useCallback(t=>i[t].id,[i])),x=n.useRef(null),[H,N]=n.useState(0);n.useLayoutEffect(()=>{var t,a;N((a=(t=x.current)==null?void 0:t.clientHeight)!=null?a:0)},[x.current]);const{data:f}=h.useGetLastGlobalUpdateTimestamp({fetchPolicy:"cache-only"}),b=f==null?void 0:f.lastUpdateTimestamp.timestamp;n.useLayoutEffect(()=>(m(s("updates.title")),c(e.jsx(le,{})),()=>{m(""),c(null)}),[s,b]);const O=t=>{const{sourceOrder:a,mangaId:u}=t;return U.find(r=>a===r.chapter.sourceOrder&&u===r.manga.id)},V=async t=>{try{await h.addChapterToDownloadQueue(t.id).response}catch(a){A(s("download.queue.error.label.failed_to_remove"),"error",y(a))}},q=t=>{h.addChapterToDownloadQueue(t.id).response.catch(a=>A(s("global.error.label.failed_to_save_changes"),"error",y(a)))},K=n.useCallback(()=>{w&&G({variables:{offset:i.length}})},[w,D]);return j?e.jsx(v,{message:s("global.error.label.failed_to_load_data"),messageExtra:y(j),retry:()=>B().catch($())}):!C&&i.length===0?e.jsx(v,{message:s("updates.error.label.no_updates_available")}):e.jsxs(e.Fragment,{children:[e.jsx(I,{ref:x,sx:{marginLeft:"10px",paddingTop:t=>({[t.breakpoints.up("sm")]:{paddingTop:"6px"}})},children:s("library.settings.global_update.label.last_update",{date:b?J.format(+b):"-"})}),e.jsx(ce,{heightToSubtract:H,style:{height:"undefined"},components:{Footer:()=>C?e.jsx(X,{usePadding:!0}):null},overscan:window.innerHeight*.5,endReached:K,groupCounts:T,groupContent:t=>e.jsx(pe,{sx:{pt:t===0?void 0:0,pb:0},isFirstItem:t===0,children:e.jsx(I,{variant:"h5",component:"h2",children:p[t][0]})}),computeItemKey:F,itemContent:t=>{const a=i[t],{manga:u}=a,r=O(a);return e.jsx(ue,{children:e.jsx(Y,{children:e.jsx(Z,{component:_,to:E.reader.path(a.manga.id,a.sourceOrder),state:d.state,sx:{color:l=>l.palette.text[a.isRead?"disabled":"primary"]},children:e.jsxs(ee,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:1.5},children:[e.jsxs(L,{sx:{display:"flex"},children:[e.jsx(_,{to:E.manga.path(a.manga.id),style:{textDecoration:"none"},children:e.jsx(me,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",marginRight:1,background:"transparent"},children:e.jsx(te,{imgStyle:{objectFit:"cover",width:"100%",height:"100%",imageRendering:"pixelated"},spinnerStyle:{small:!0},alt:u.title,src:he.getThumbnailUrl(u)})})}),e.jsxs(L,{sx:{display:"flex",flexDirection:"column",justifyContent:"center",flexGrow:1,flexShrink:1,wordBreak:"break-word"},children:[e.jsx(M,{variant:"h6",component:"h3",children:u.title}),e.jsx(M,{variant:"caption",display:"block",lines:1,children:a.name})]})]}),r&&e.jsx(ae,{download:r}),(r==null?void 0:r.state)===se.Error&&e.jsx(P,{title:s("global.button.retry"),children:e.jsx(R,{onClick:l=>{l.preventDefault(),l.stopPropagation(),V(r.chapter)},size:"large",children:e.jsx(oe,{})})}),r==null&&!a.isDownloaded&&e.jsx(P,{title:s("chapter.action.download.add.label.action"),children:e.jsx(R,{onClick:l=>{l.stopPropagation(),l.preventDefault(),q(a)},size:"large",children:e.jsx(re,{})})})]})})})})}})]})};export{we as Updates};
