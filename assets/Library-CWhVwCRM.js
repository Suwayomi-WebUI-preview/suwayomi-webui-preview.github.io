import{u as B,r as O,P as Se,Q as ue,q as z,j as t,U as L,W as je,X as ke,Y as T,Z as R,_ as N,$ as _e,y as Te,n as oe,l as ne,f as g,a0 as W,i as ge,I as Me,a1 as Fe,a2 as P,a3 as Le,a4 as Ae,a5 as Ie,a6 as we,m as G,a7 as Be,a8 as Re,N as ve,E as ie,k as Oe,D as Ee,F as De,G as Ne}from"./index-k8Ll42aL.js";import{u as pe,S as Ge,A as Ue,N as Pe}from"./AppbarSearch-BUzCCwHN.js";import{F as ze}from"./FilterList-Lq3adYWS.js";import{S as We,R as U}from"./SortRadioInput-DSEy5DqS.js";import{T as _}from"./ThreeStateCheckboxInput-BbGOAZut.js";import{O as Ye,S as Ke,a as He}from"./SelectionFAB-B7dc1Vc5.js";import{T as Ve}from"./Trackers-D4pSmk7a.js";import{R as Qe}from"./ListPreference-BV-LwjqL.js";import{M as Xe,a as Ze}from"./MangaGrid-DTPRjDXt.js";import{C as $e,U as Je}from"./UpdateChecker-wKrk0xNv.js";import{u as qe}from"./useManageMangaLibraryState-DsZVpyA6.js";import{T as ea}from"./TabsWrapper-BeuE-oNS.js";import{C as aa}from"./Chip-Cl5fKrgx.js";import"./StyledFab-DVt1VR-T.js";import"./Sync-Bxls77wo.js";import"./Avatar-B0ZaJCI0.js";import"./PlayArrow-Cx-6RJzS.js";import"./Progress-C4xtYrCg.js";import"./Info-D3AoacSY.js";import"./CheckCircle-wUb210J8.js";import"./NumberSetting-3yO3coFj.js";import"./useMobilePicker-D5GzEMin.js";import"./SelectSetting-BRXE-W_6.js";const ta={filter:"global.label.filter",sort:"global.label.sort",display:"global.label.display"},sa=[["unreadChapters","library.option.sort.label.by_unread_chapters"],["totalChapters","library.option.sort.label.by_total_chapters"],["alphabetically","library.option.sort.label.alphabetically"],["dateAdded","library.option.sort.label.by_date_added"],["lastRead","library.option.sort.label.by_last_read"],["latestFetchedChapter","library.option.sort.label.by_latest_fetched_chapter"],["latestUploadedChapter","library.option.sort.label.by_latest_uploaded_chapter"]],ra=({category:e,open:s,onClose:n})=>{var h,C;const{t:a}=B(),l=O.useGetTrackerList(Se),o=Ve.getLoggedIn((C=(h=l.data)==null?void 0:h.trackers.nodes)!=null?C:[]),r=ue(e),i=_e(e,u=>oe(a("global.error.label.failed_to_save_changes"),"error",ne(u))),{settings:{showTabSize:p,showContinueReadingButton:x,showDownloadBadge:M,showUnreadBadge:f}}=z(),y=Te(u=>oe(a("search.error.label.failed_to_save_settings"),"error",ne(u)));return t.jsx(Ye,{open:s,onClose:n,tabs:["filter","sort","display"],tabTitle:u=>a(ta[u]),tabContent:u=>{if(u==="filter")return t.jsxs(t.Fragment,{children:[t.jsx(_,{label:a("global.filter.label.unread"),checked:r.hasUnreadChapters,onChange:c=>i("hasUnreadChapters",c)}),t.jsx(_,{label:a("global.filter.label.started"),checked:r.hasReadChapters,onChange:c=>i("hasReadChapters",c)}),t.jsx(_,{label:a("global.filter.label.downloaded"),checked:r.hasDownloadedChapters,onChange:c=>i("hasDownloadedChapters",c)}),t.jsx(_,{label:a("global.filter.label.bookmarked"),checked:r.hasBookmarkedChapters,onChange:c=>i("hasBookmarkedChapters",c)}),t.jsx(_,{label:a("global.filter.label.duplicate_chapters"),checked:r.hasDuplicateChapters,onChange:c=>i("hasDuplicateChapters",c)}),t.jsx(L,{sx:{mt:2},children:a("manga.label.status")}),Object.values(je).map(c=>t.jsx(_,{label:a(ke[c]),checked:r.hasStatus[c],onChange:b=>i("hasStatus",{...r.hasStatus,[c]:b})},c)),t.jsx(L,{sx:{mt:2},children:a("global.filter.label.tracked")}),o.map(c=>t.jsx(_,{label:c.name,checked:r.hasTrackerBinding[c.id],onChange:b=>i("hasTrackerBinding",{...r.hasTrackerBinding,[c.id]:b})},c.id))]});if(u==="sort")return sa.map(([c,b])=>t.jsx(We,{label:a(b),checked:r.sortBy===c,sortDescending:r.sortDesc,onClick:()=>c!==r.sortBy?i("sortBy",c):i("sortDesc",!r.sortDesc)},c));if(u==="display"){const{gridLayout:c}=r;return t.jsxs(t.Fragment,{children:[t.jsx(L,{children:a("global.grid_layout.title")}),t.jsxs(Qe,{onChange:b=>i("gridLayout",Number(b.target.value)),value:c,children:[t.jsx(U,{label:a("global.grid_layout.label.compact_grid"),value:T.Compact,checked:c==null||c===T.Compact}),t.jsx(U,{label:a("global.grid_layout.label.comfortable_grid"),value:T.Comfortable,checked:c===T.Comfortable}),t.jsx(U,{label:a("global.grid_layout.label.list"),value:T.List,checked:c===T.List})]}),t.jsx(L,{sx:{mt:2},children:a("library.option.display.badge.title")}),t.jsx(R,{label:a("library.option.display.badge.label.unread_badges"),checked:f,onChange:()=>N("showUnreadBadge",!f)}),t.jsx(R,{label:a("library.option.display.badge.label.download_badges"),checked:M,onChange:()=>N("showDownloadBadge",!M)}),t.jsx(L,{sx:{mt:2},children:a("library.option.display.tab.title")}),t.jsx(R,{label:a("library.option.display.tab.label.show_number_of_items"),checked:p,onChange:()=>y("showTabSize",!p)}),t.jsx(L,{sx:{mt:2},children:a("global.label.other")}),t.jsx(R,{label:a("library.option.display.other.label.show_continue_reading_button"),checked:x,onChange:()=>N("showContinueReadingButton",!x)})]})}return null}})},la=({category:e})=>{const{t:s}=B(),[n,a]=g.useState(!1),{options:l}=W(),o=l.hasDownloadedChapters!=null||l.hasUnreadChapters!=null||l.hasReadChapters!=null||l.hasBookmarkedChapters!=null||l.hasDuplicateChapters!=null||Object.values(l.hasStatus).some(r=>r!=null)||Object.values(l.hasTrackerBinding).some(r=>r!=null);return t.jsxs(t.Fragment,{children:[t.jsx(ge,{title:s("settings.title"),children:t.jsx(Me,{onClick:()=>a(!n),color:o?"warning":"inherit",children:t.jsx(ze,{})})}),t.jsx(ra,{category:e,open:n,onClose:()=>a(!1)})]})},ce=({showFilteredOutMessage:e,message:s,messageExtra:n,...a})=>{const{t:l}=B(),{options:o}=W();return g.useLayoutEffect(()=>(document.body.style.overflowY=o.gridLayout===T.List?"auto":"scroll",()=>{document.body.style.overflowY="auto"}),[]),t.jsx(Xe,{gridWrapperProps:{sx:{p:1}},...a,hasNextPage:!1,loadMore:()=>{},message:e?l("library.error.label.no_matches"):s,messageExtra:e?void 0:n,gridLayout:o.gridLayout})},oa=({isActive:e,areAllItemsSelected:s,areNoItemsSelected:n,onSelectAll:a,onModeChange:l})=>{const{t:o}=B();return t.jsxs(t.Fragment,{children:[e&&t.jsx(Ke,{areAllItemsSelected:s,areNoItemsSelected:n,onChange:a}),t.jsx(ge,{title:o(e?"global.button.cancel":"global.button.select_all"),children:t.jsx(Fe,{checkedIcon:t.jsx($e,{}),sx:{padding:"8px",color:"inherit","&.Mui-checked":{color:"inherit"}},checked:e,onChange:(r,i)=>l(i)})})]})},Y=(e,s,n)=>{switch(e){case!0:return s();case!1:return n();default:return!0}},v=(e,s)=>Y(e,()=>!!s&&s>=1,()=>s===0),be=(e,s)=>Y(e,()=>!!s,()=>!s),A=(e,s)=>{const n=e==null?void 0:e.filter(r=>r!=null),a=s==null?void 0:s.filter(r=>r!=null);if(!(n!=null&&n.length))return!0;const l=n.map(P),o=a.map(P).join(", ");return l.every(r=>o.includes(r))},na=(e,{title:s,genre:n,description:a,artist:l,author:o,source:r})=>A([e],[s])||A(e==null?void 0:e.split(","),n.map(i=>P(i)))||A([e],[a])||A([e],[l])||A([e],[o])||A([e],[r==null?void 0:r.displayName]),ia=(e,s)=>Object.entries(e).map(([n,a])=>{const l=s.trackRecords.nodes.some(o=>o.trackerId===Number(n));return Y(a,()=>l,()=>!l)}).every(Boolean),ca=(e,s)=>Object.entries(e).map(([n,a])=>be(a,n===s.status)).every(Boolean),da=(e,{hasDownloadedChapters:s,hasUnreadChapters:n,hasReadChapters:a,hasBookmarkedChapters:l,hasDuplicateChapters:o,hasTrackerBinding:r,hasStatus:i})=>v(s,e.downloadCount)&&v(n,e.unreadCount)&&v(a,e.chapters.totalCount-e.unreadCount)&&v(l,e.bookmarkCount)&&be(o,e.hasDuplicateChapters)&&ia(r,e)&&ca(i,e),ha=(e,s,n)=>{const a=n.ignoreFilters&&(s==null?void 0:s.length);return e.filter(l=>{const o=na(s,l),r=a||da(l,n);return o&&r})},I=(e=0,s=0)=>Number(e)-Number(s),ua=(e,s)=>e.localeCompare(s),ga=(e,s,n)=>{const a=[...e];switch(s){case"alphabetically":a.sort((l,o)=>ua(l.title,o.title));break;case"dateAdded":a.sort((l,o)=>I(l.inLibraryAt,o.inLibraryAt));break;case"unreadChapters":a.sort((l,o)=>I(l.unreadCount,o.unreadCount));break;case"lastRead":a.sort((l,o)=>{var r,i;return I((r=l.lastReadChapter)==null?void 0:r.lastReadAt,(i=o.lastReadChapter)==null?void 0:i.lastReadAt)});break;case"latestUploadedChapter":a.sort((l,o)=>{var r,i;return I((r=l.latestUploadedChapter)==null?void 0:r.uploadDate,(i=o.latestUploadedChapter)==null?void 0:i.uploadDate)});break;case"latestFetchedChapter":a.sort((l,o)=>{var r,i;return I((r=l.latestFetchedChapter)==null?void 0:r.fetchedAt,(i=o.latestFetchedChapter)==null?void 0:i.fetchedAt)});break;case"totalChapters":a.sort((l,o)=>I(l.chapters.totalCount,o.chapters.totalCount));break}return n&&a.reverse(),a},pa={id:-1},ba=(e,s)=>{const[n]=pe("query",Ge),a=ue(s!=null?s:pa),{hasUnreadChapters:l,hasReadChapters:o,hasDownloadedChapters:r,hasBookmarkedChapters:i,hasTrackerBinding:p,hasDuplicateChapters:x,hasStatus:M}=a,{settings:f}=z(),y=g.useMemo(()=>ha(e,n,{...a,ignoreFilters:f.ignoreFilters}),[e,n,l,o,r,i,p,x,M,f.ignoreFilters]),h=g.useMemo(()=>ga(y,a.sortBy,a.sortDesc),[y,a.sortBy,a.sortDesc]),C=Object.values(a.hasTrackerBinding).some(c=>c!=null),u=(l!=null||o!=null||r!=null||i!=null||!!n||C)&&y.length===0&&e.length>0;return{visibleMangas:h,showFilteredOutMessage:u}},de=Le("span")({display:"flex",alignItems:"center"}),he=({sx:e,...s})=>t.jsx(aa,{...s,size:"small",sx:{...e,marginLeft:"5px"}});function Ga(){var ee,ae,te,se,re,le;const{t:e}=B(),{settings:{showTabSize:s}}=z(),{data:n,error:a,loading:l,refetch:o}=O.useGetCategories(Ae,{notifyOnNetworkStatusChange:!0}),r=n==null?void 0:n.categories.nodes.filter(d=>d.id!==0||d.id===0&&d.mangas.totalCount),i=r!=null?r:[],p=O.useGetMangas(Ie,{}),x=(ae=(ee=p.data)==null?void 0:ee.mangas.totalCount)!=null?ae:0,[M,f]=pe("tab",Pe),{setOptions:y}=W(),h=(te=i.find(d=>d.order===M))!=null?te:i[0];g.useLayoutEffect(()=>{y(we(h!=null?h:{id:-1}))},[h]);const{data:C,error:u,loading:c,refetch:b}=O.useGetCategoryMangas(h==null?void 0:h.id,{skip:!h,notifyOnNetworkStatusChange:!0}),me=(se=C==null?void 0:C.mangas.nodes)!=null?se:[],{visibleMangas:m,showFilteredOutMessage:K}=ba(me,h),H=g.useCallback(()=>b().catch(G()),[b,h]),Ce=g.useMemo(()=>m.map(d=>d.id),[m]),[S,E]=g.useState(!1),{areNoItemsForKeySelected:V,areAllItemsForKeySelected:Q,selectedItemIds:j,handleSelectAll:D,handleSelection:xe,clearSelection:fe}=qe(m.length,{itemIds:Ce,currentKey:h==null?void 0:h.id.toString()}),X=(d,k,F)=>{E(!!(j.length+(k?1:-1))),xe(d,k,F)},Z=g.useMemo(()=>j.map(d=>Be.getFromCache(d,Re,"MANGA_CHAPTER_STAT_FIELDS")).filter(d=>!!d),[j.length,m]),$=g.useMemo(()=>S?t.jsx(He,{selectedItemsCount:j.length,title:"manga.title",children:(d,k)=>t.jsx(Ze,{selectedMangas:Z,onClose:()=>{d(),E(!1),fe()},setHideMenu:k})}):null,[S,Z]),{setTitle:J,setAction:q}=g.useContext(ve);g.useLayoutEffect(()=>{const d=e("library.title");return J(t.jsxs(de,{children:[d,s&&t.jsx(he,{sx:{color:"inherit"},label:x})]}),d),q(t.jsxs(t.Fragment,{children:[!S&&h&&t.jsxs(t.Fragment,{children:[t.jsx(Ue,{}),t.jsx(la,{category:h}),t.jsx(Je,{categoryId:h==null?void 0:h.id})]}),t.jsx(oa,{isActive:S,areAllItemsSelected:Q,areNoItemsSelected:V,onSelectAll:F=>D(F,[...new Set(m.map(w=>w.id))]),onModeChange:F=>{E(F),F?D(!0,[...new Set(m.map(w=>w.id))]):i.forEach(w=>D(!1,[],w.id.toString()))}})]})),()=>{J(""),q(null)}},[e,x,l,S,V,Q,j.length,m.length,h,s]);const ye=d=>{f(d)};return a!=null||p.error?t.jsx(ie,{message:e("global.error.label.failed_to_load_data"),messageExtra:(le=a==null?void 0:a.message)!=null?le:(re=p.error)==null?void 0:re.message,retry:()=>{a&&o().catch(G()),p.error&&p.refetch().catch(G())}}):l||p.loading?t.jsx(Oe,{}):i.length===0?t.jsx(ie,{message:e("library.error.label.empty")}):i.length===1?t.jsxs(t.Fragment,{children:[t.jsx(ce,{mangas:m,message:e(u?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:u==null?void 0:u.message,isLoading:c,selectedMangaIds:j,isSelectModeActive:S,handleSelection:X,showFilteredOutMessage:!u&&K,retry:u&&H}),$]}):t.jsxs(ea,{children:[t.jsx(Ee,{value:h.order,onChange:(d,k)=>ye(k),children:i.map(d=>t.jsx(De,{sx:{flexGrow:1,maxWidth:"unset"},label:t.jsxs(de,{children:[d.name,s?t.jsx(he,{label:d.mangas.totalCount}):null]}),value:d.order},d.id))}),i.map(d=>t.jsx(Ne,{index:d.order,currentIndex:h.order,children:d===h&&t.jsx(ce,{mangas:m,message:e(u?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:u==null?void 0:u.message,isLoading:c,selectedMangaIds:j,isSelectModeActive:S,handleSelection:X,showFilteredOutMessage:!u&&K,retry:u&&H})},d.order)),$]})}export{Ga as Library};
