import{d as ce,s as ue,j as e,r as we,i as Ae,a0 as T,T as de,a1 as Ge,B as I,aL as pe,a3 as me,S as q,c as x,b9 as E,ay as De,u as ge,b as P,P as Re,f as Q,I as he,J as qe,W as Ne,X as Be,aF as Ue,aG as He,aH as We,h as fe,b6 as ze,b5 as Ve,ba as Je,bb as Qe,x as Y,N as Ye,a4 as Ke,e as Xe,at as le,p as Ze,bc as R,bd as et,a as O,be as tt,bf as st,bg as at,bh as rt,m as nt}from"./index-DRMCCeoY.js";import{d as ot,u as it,A as lt,S as ct}from"./AppbarSearch-Ce__3riU.js";import{b as xe,a as Se,d as ut}from"./ExpandMore-QplK46dO.js";import{d as je}from"./FilterList-5v4hIn6l.js";import{G as dt}from"./GridLayouts-CWd7RQzj.js";import{d as pt}from"./Delete-BtWnLVeH.js";import{S as mt,O as gt}from"./SortRadioInput-BgM23Ese.js";import{C as ht}from"./CheckboxInput-D829lXhS.js";import{a as be,I as ve,S as ft,b as xt,T as St}from"./TextField-C00KWYJ7.js";import{C as Ce}from"./Collapse-jkk2DTox.js";import{u as jt}from"./useDebounce-BlxkxYf5.js";import{I as bt}from"./InputAdornment-D6sgKKlS.js";import{T as vt}from"./ThreeStateCheckboxInput-DTjRsgBN.js";import{S as Ct}from"./StyledFab-Crz1U05q.js";import{o as yt}from"./useManageMangaLibraryState-DM4sho3U.js";import{C as Tt}from"./Chip-qKIGWUps.js";import{B as Ft}from"./BaseMangaGrid-b40rSVYW.js";import{g as Lt}from"./MangaGrid-lY3nQPJJ.js";import{L as _t}from"./Link-DvjkoWZT.js";import"./Checkbox-gvOt2H0O.js";import"./SwitchBase-DbWKMhI0.js";import"./ListPreference-kmeufX_L.js";import"./Trackers-D4pSmk7a.js";import"./Card-CCf5T706.js";import"./CardContent-CNzIonSZ.js";import"./Avatar-r5qM97wM.js";import"./Info-DM8VcukM.js";import"./CheckCircle-ClksiFnT.js";import"./SpinnerImage-Bb6iXLNY.js";import"./TypographyMaxLines-wGPcB80f.js";import"./CardActionArea-CB7LF26E.js";import"./NumberSetting-7ZnPu6vC.js";import"./useMobilePicker-BaWvgUqA.js";import"./SelectSetting-CAITyFpf.js";import"./Select-yKstr75i.js";import"./Mangas-DI1iOcH5.js";import"./Chapters-BF9azHJT.js";import"./index-0tMPKyK_.js";import"./Sync-CblqHmnO.js";import"./PlayArrow-Cg3tH5aL.js";function kt(){const[t,a]=ce("source-grid-layout",ue.Compact);return e.jsx(dt,{gridLayout:t,onChange:a})}var K={},It=Ae;Object.defineProperty(K,"__esModule",{value:!0});var ye=K.default=void 0,Et=It(we()),Mt=e;ye=K.default=(0,Et.default)((0,Mt.jsx)("path",{d:"M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3m3-10H5V5h10z"}),"Save");const $t=t=>{const{state:a,name:n,position:o,group:s,updateFilterValue:c,update:r}=t,[u,i]=T.useState(a),h=d=>{i(d.target.checked);const m=r.filter(S=>!(o===S.position&&s===S.group));c([...m,{type:"checkBoxState",position:o,state:d.target.checked,group:s}])};return a!==void 0?e.jsx(ht,{label:n,checked:u,onChange:h}):null},Pt=({name:t})=>e.jsx(de,{sx:{mt:2},variant:"subtitle2",children:t},t);function Ot(t,a,n,o,s,c,r){const[u,i]=T.useState(n);if(t){const h=m=>{const S=t.indexOf("".concat(m.target.value));i(S);const b=c.filter(g=>!(o===g.position&&r===g.group));s([...b,{type:"selectState",position:o,state:S,group:r}])},d=t.map(m=>e.jsx(Ge,{value:m,children:m},"".concat(a," ").concat(m)));return e.jsxs(be,{sx:{my:1},variant:"standard",children:[e.jsx(ve,{children:a}),e.jsx(ft,{name:a,value:t[u],label:a,onChange:h,children:d})]})}return null}const wt=({values:t,name:a,state:n,position:o,updateFilterValue:s,update:c,group:r})=>Ot(t,a,n,o,s,c,r),At=t=>{const{values:a,name:n,state:o,position:s,group:c,updateFilterValue:r,update:u}=t,[i,h]=T.useState(o),[d,m]=T.useState(!1),S=()=>{m(!d)};if(a){const b=g=>{const l=i;l.index===g?l.ascending=!l.ascending:l.ascending=!0,l.index=g,h(l);const v=u.filter(f=>!(s===f.position&&c===f.group));r([...v,{type:"sortState",position:s,state:l,group:c}])};return e.jsxs(I,{sx:{mx:-2},children:[e.jsxs(pe,{onClick:S,children:[e.jsx(me,{primary:n}),d?e.jsx(xe,{}):e.jsx(Se,{})]}),e.jsx(Ce,{in:d,children:e.jsx(q,{sx:{mx:4},children:a.map((g,l)=>e.jsx(mt,{label:g,checked:i.index===l,sortDescending:!i.ascending,onClick:()=>b(l)},"".concat(n," ").concat(g)))})})]})}return null},Gt=t=>{const{state:a,name:n,position:o,group:s,updateFilterValue:c,update:r}=t,[u,i]=T.useState(a||""),h=jt(u,500);return x.useEffect(()=>{const d=r.filter(m=>!(o===m.position&&s===m.group));c([...d,{type:"textState",position:o,state:h,group:s}])},[h]),a!==void 0?e.jsxs(be,{sx:{my:1},variant:"standard",children:[e.jsx(ve,{children:n}),e.jsx(xt,{name:n,value:u,onChange:({target:{value:d}})=>i(d),endAdornment:e.jsx(bt,{position:"end",children:e.jsx(ot,{})})})]}):null},Dt=t=>{switch(t){case E.Ignore:return 0;case E.Include:return 1;case E.Exclude:return 2;default:throw new Error("Unexpected TriState ".concat(t))}},Rt=t=>{switch(t){case 0:return E.Ignore;case 1:return E.Include;case 2:return E.Exclude;default:throw new Error("Unexpected state number ".concat(t))}},qt=t=>{const{state:a,name:n,position:o,group:s,updateFilterValue:c,update:r}=t,[u,i]=T.useState(Dt(a)),h=d=>{const m=d===void 0?0:d?1:2;i(m);const S=r.filter(b=>!(o===b.position&&s===b.group));c([...S,{type:"triState",position:o,state:Rt(m),group:s}])};return a!==void 0?e.jsx(vt,{label:n,checked:[void 0,!0,!1][u],onChange:d=>h(d)}):null},Nt=t=>{const{state:a,name:n,position:o,updateFilterValue:s,update:c}=t,[r,u]=T.useState(!1);return e.jsxs(I,{sx:{mx:-2},children:[e.jsxs(pe,{onClick:()=>u(!r),children:[e.jsx(me,{primary:n}),r?e.jsx(xe,{}):e.jsx(Se,{})]}),e.jsx(Ce,{in:r,children:e.jsx(q,{sx:{mx:4},children:e.jsx(Te,{sourceFilter:a,group:o,updateFilterValue:s,update:c})})})]})},Bt=({name:t})=>e.jsx(De,{sx:{my:1},textAlign:"center",children:t},t);function Te({sourceFilter:t,group:a,updateFilterValue:n,update:o}){return e.jsx(q,{children:t.map((s,c)=>{var u,i;let r=o.find(h=>h.group===a&&h.position===c);switch(r=r&&r.state,s.type){case"CheckBoxFilter":return e.jsx($t,{name:s.name,state:r!=null?r:s.CheckBoxFilterDefault,position:c,group:a,updateFilterValue:n,update:o},"filters ".concat(s.name));case"GroupFilter":return e.jsx(Nt,{name:s.name,state:s.filters,position:c,updateFilterValue:n,update:o},"filters ".concat(s.name));case"HeaderFilter":return e.jsx(Pt,{name:s.name},"filters ".concat(s.name));case"SelectFilter":return e.jsx(wt,{name:s.name,values:s.values,state:r!=null?parseInt(r,10):s.SelectFilterDefault,position:c,group:a,updateFilterValue:n,update:o},"filters ".concat(s.name));case"SeparatorFilter":return e.jsx(Bt,{name:s.name},"filters ".concat(s.name));case"SortFilter":return e.jsx(At,{name:s.name,values:s.values,state:r!=null?r:{ascending:(u=s.SortFilterDefault)==null?void 0:u.ascending,index:(i=s.SortFilterDefault)==null?void 0:i.index},position:c,group:a,updateFilterValue:n,update:o},"filters ".concat(s.name));case"TextFilter":return e.jsx(Gt,{name:s.name,state:r!=null?r:s.TextFilterDefault,position:c,group:a,updateFilterValue:n,update:o},"filters ".concat(s.name));case"TriStateFilter":return e.jsx(qt,{name:s.name,state:r!=null?r:s.TriStateFilterDefault,position:c,group:a,updateFilterValue:n,update:o},"filters ".concat(s.name));default:throw new Error('Unknown source filter "'.concat(s,'"'))}})},"filters ".concat(a))}function Ut({savedSearches:t={},selectSavedSearch:a,updateSavedSearches:n,sourceFilter:o,updateFilterValue:s,resetFilterValue:c,setTriggerUpdate:r,update:u}){const{t:i}=ge(),[h,d]=x.useState(!1),[m,S]=x.useState(""),b=Object.keys(t),g=!!b.length;function l(){c(0),d(!1)}function v(){r(0),d(!1)}return e.jsxs(e.Fragment,{children:[e.jsxs(Ct,{onClick:()=>d(!h),variant:"extended",color:"primary",children:[e.jsx(je,{}),i("global.button.filter")]}),e.jsxs(gt,{open:h,onClose:()=>d(!1),children:[e.jsxs(I,{sx:{p:2,pb:g?void 0:0},children:[e.jsxs(I,{sx:{display:"flex",pb:1},children:[e.jsx(P,{onClick:l,children:i("global.button.reset")}),e.jsx(Re,{variant:"dialog",popupId:"source-browse-save-search",children:f=>e.jsxs(e.Fragment,{children:[e.jsx(Q,{title:i("source.filter.save_search.label.save"),children:e.jsx(he,{sx:{marginLeft:"auto"},...qe(f),children:e.jsx(ye,{})})}),e.jsxs(Ne,{...Be(f),maxWidth:"xs",fullWidth:!0,children:[e.jsx(Ue,{children:i("source.filter.save_search.dialog.label.title")}),e.jsx(He,{children:e.jsx(St,{sx:{width:"100%"},value:m,onChange:y=>S(y.target.value),slotProps:{htmlInput:{maxLength:50}}})}),e.jsxs(We,{children:[e.jsx(P,{onClick:()=>{S(""),f.close()},children:i("global.button.cancel")}),e.jsx(P,{onClick:()=>{n(m,"create"),S(""),f.close()},children:i("global.button.ok")})]})]})]})}),e.jsx(P,{variant:"contained",onClick:v,children:i("global.button.submit")})]}),g&&e.jsxs(e.Fragment,{children:[e.jsx(de,{sx:{pb:1},children:"Saved searches"}),e.jsx(q,{sx:{flexDirection:"row"},children:b.map(f=>e.jsx(Tt,{label:f,onClick:()=>{d(!1),a(f)},onDelete:()=>{yt({title:i("global.label.are_you_sure"),message:i("source.filter.save_search.dialog.label.delete",{name:f}),actions:{confirm:{title:i("global.button.delete")}}}).then(()=>n(f,"delete")).catch(fe())},deleteIcon:e.jsx(Q,{title:i("source.filter.save_search.label.delete"),children:e.jsx(pt,{})}),variant:"outlined"}))})]})]}),e.jsx(I,{sx:{pb:2,mx:2},children:e.jsx(Te,{sourceFilter:o,updateFilterValue:s,group:void 0,update:u})})]})]})}const Ht=t=>({...t,savedSearches:t.savedSearches?JSON.stringify(t.savedSearches):void 0}),Wt=t=>{var a;return{...t,savedSearches:(a=Je(t.savedSearches))!=null?a:void 0}},zt=({meta:t}={},a)=>Wt(ze({meta:Ve(t)},{savedSearches:void 0},a)),Vt=async(t,a,n)=>Qe(t,[[a,Ht({[a]:n})[a]]]),Jt=(t,a=fe())=>(n,o)=>Vt(t,n,o).catch(a),Qt=Y("div")(({theme:t})=>({display:"flex",position:"sticky",width:"100%",zIndex:1,padding:t.spacing(1),gap:t.spacing(1),backgroundColor:t.palette.background.default})),J=Y(P)(()=>({})),Yt=Y(I)(()=>({minHeight:"100%",position:"relative"}));var Kt=(t=>(t[t.POPULAR=0]="POPULAR",t[t.LATEST=1]="LATEST",t[t.SEARCH=2]="SEARCH",t))(Kt||{});const Xt={0:"manga.error.label.no_mangas_found",1:"manga.error.label.no_mangas_found",2:"manga.error.label.no_matches"},Zt=t=>{const a={},n=[];return t.forEach(o=>{!!a[o.id]||(a[o.id]=o,n.push(o))}),n},es=(t,a,n,o,s,c)=>{var b;let r;switch(a){case 0:r=O.useGetSourcePopularMangas(t,s);break;case 1:r=O.useGetSourceLatestMangas(t,s);break;case 2:r=O.useSourceSearch(t,n!=null?n:"",o.map(g=>{const{position:l,state:v,group:f}=g;return f!==void 0?{position:f,groupChange:{position:l,[g.type]:v}}:{position:l,[g.type]:v}}),s);break;default:throw new Error('Unknown ContentType "'.concat(a,'"'))}const u=r[1],i=u.findLastIndex(g=>{var l;return!!((l=g.data)!=null&&l.fetchSourceManga)}),h=u[i],d=u.slice(-1)[0].isLoading;let m=!d;const S=x.useMemo(()=>{let g=[];return u.forEach((l,v)=>{var F,w,M;const f=(M=(w=(F=l.data)==null?void 0:F.fetchSourceManga)==null?void 0:w.mangas)!=null?M:[],y=f.filter(C=>!c||!C.inLibrary),N=Zt([...g,...y]);m=!d&&u.length===v+1&&!y.length&&!!f.length,g=N}),g},[u,c]);return i===-1?[r[0],{...r[1][r[1].length-1],filteredOutAllItemsOfFetchedPage:m}]:[r[0],{...u[u.length-1],data:{...h.data,fetchSourceManga:{...h.data.fetchSourceManga,hasNextPage:u.length>i+1?!1:!!((b=h.data.fetchSourceManga)!=null&&b.hasNextPage),mangas:S}},filteredOutAllItemsOfFetchedPage:m}]};function Us(){var se,ae,re,ne,oe;const{t}=ge(),{setTitle:a,setAction:n,appBarHeight:o}=x.useContext(Ye),{sourceId:s}=Ke(),c=Xe(),r=le(),{key:u,state:i}=r,{contentType:h=0,clearCache:d=!1}=(se=le().state)!=null?se:{},[m,S]=x.useState(!0);x.useEffect(()=>{S(!1)},[]);const{settings:{hideLibraryEntries:b}}=Ze(),[g]=ce("source-grid-layout",ue.Compact),[l]=it("query",ct),[v,f]=R("source-mangas-".concat(s,"-filters"),[]),[y,N]=R("source-mangas-location-".concat(u,"-").concat(s,"-filters"),v!=null?v:[]),[B,F]=x.useState(y),[w,M]=R("source-mangas-".concat(s,"-content-type"),h),[C,Fe]=R("source-mangas-location-".concat(u,"-").concat(s,"-content-type"),l?2:w);x.useEffect(()=>()=>{f(void 0),M(void 0)},[s]);const A=x.useCallback(()=>{et.session.setItem(Lt(r),void 0,!1),window.scrollTo(0,0)},[u]),U=j=>{f(j),N(j),A()},X=j=>{M(j),Fe(j)},[Z,{data:L,isLoading:H,size:W,abortRequest:Le,filteredOutAllItemsOfFetchedPage:z}]=es(s,C,l,y,1,b),ee=H||z,_e=(re=(ae=L==null?void 0:L.fetchSourceManga)==null?void 0:ae.mangas)!=null?re:[],G=!!((ne=L==null?void 0:L.fetchSourceManga)!=null&&ne.hasNextPage),{data:V}=O.useGetSource(tt,s),p=V==null?void 0:V.source,ke=(oe=p==null?void 0:p.filters)!=null?oe:[],{savedSearches:_={}}=x.useMemo(()=>zt(p),[p,p==null?void 0:p.meta]),te=Jt(p!=null?p:{id:s},()=>nt(t("global.error.label.failed_to_save_changes"),"error")),Ie=x.useCallback(j=>{const{query:k,filters:$}=_[j];$&&(F($),U($)),c({pathname:"",search:k?"query=".concat(k):void 0},{state:{...i,contentType:2}})},[_,i]),Ee=x.useCallback((j,k)=>{if(k==="delete"){const ie={..._};delete ie[j],te("savedSearches",ie);return}const $={..._,[j]:{query:l!=null?l:void 0,filters:y}};te("savedSearches",$)},[_,l,y]),Me=ee?void 0:t(Xt[C]),$e=s==="0"?e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:[t("source.local_source.label.checkout")," "]}),e.jsx(_t,{href:"https://github.com/Suwayomi/Suwayomi-Server/wiki/Local-Source",target:"_blank",rel:"noreferrer",children:t("source.local_source.label.guide")})]}):void 0,D=x.useCallback((j,k)=>{X(j),A(),l&&!k&&c({pathname:""},{state:{...i,contentType:j}})},[X,l,A]);!!l&&C!==2&&D(2,l);const Pe=x.useCallback(()=>{G&&Z(W+1)},[W,G,C]),Oe=()=>{F([]),U([])};return x.useEffect(()=>{z&&G&&!H&&Z(W+1)},[z,H]),x.useEffect(()=>{!d||!rt.REVALIDATION.includes(s)||O.clearBrowseCacheFor(s)},[d]),x.useEffect(()=>()=>{C!==2||m||(Le(new Error("SourceMangas(".concat(s,"): search string changed"))),A())},[l]),x.useLayoutEffect(()=>{var j;return a((j=p==null?void 0:p.displayName)!=null?j:t("source.title_one")),n(e.jsxs(e.Fragment,{children:[e.jsx(lt,{}),e.jsx(kt,{}),(p==null?void 0:p.isConfigurable)&&e.jsx(Q,{title:t("settings.title"),children:e.jsx(he,{onClick:()=>c("/sources/".concat(s,"/configure/")),"aria-label":"display more actions",edge:"end",color:"inherit",size:"large",children:e.jsx(st,{})})})]})),()=>{a(""),n(null)}},[t,p]),e.jsxs(Yt,{children:[e.jsxs(Qt,{sx:{top:"".concat(o,"px")},children:[e.jsx(J,{variant:C===0?"contained":"outlined",startIcon:e.jsx(ut,{}),onClick:()=>D(0),children:t("global.button.popular")}),(p==null?void 0:p.supportsLatest)===void 0||p.supportsLatest?e.jsx(J,{disabled:!(p!=null&&p.supportsLatest),variant:C===1?"contained":"outlined",startIcon:e.jsx(at,{}),onClick:()=>D(1),children:t("global.button.latest")}):null,e.jsx(J,{variant:C===2?"contained":"outlined",startIcon:e.jsx(je,{}),onClick:()=>D(2,l),children:t("global.button.filter")})]}),e.jsx(Ft,{gridWrapperProps:{sx:{px:1,pb:1}},mangas:_e,hasNextPage:G,loadMore:Pe,message:Me,messageExtra:$e,isLoading:ee,gridLayout:g,mode:"source",inLibraryIndicator:!0},C),C===2&&e.jsx(Ut,{savedSearches:_,selectSavedSearch:Ie,updateSavedSearches:Ee,sourceFilter:ke,updateFilterValue:F,setTriggerUpdate:()=>{U(B)},resetFilterValue:Oe,update:B})]})}export{Kt as SourceContentType,Us as SourceMangas};
