import{e as i,u as q,q as $,a as U,b as Q,ax as V,d as J,r as O,j as e,h as K,g as v,i as D,p as P,S as k,B as A,s as X,an as Y,A as Z,L as ee,T as F,C as te,I as re,ay as oe,az as se,m as ne}from"./index-N2KlV0av.js";import{u as ae,S as ie,A as ce}from"./AppbarSearch-iS7ScGEK.js";import{P as ue}from"./PushPin-BJbO6NHk.js";import{D as le}from"./DoneAll-D3XCteUQ.js";import{F as me}from"./FilterList-wQqFr0Lm.js";import{t as de,L as pe}from"./LanguageSelect-NxD3nIGq.js";import{u as z}from"./useDebounce-CjJH9VH1.js";import{B as he}from"./BaseMangaGrid-lkPTnPOe.js";import{E as ge}from"./EmptyViewAbsoluteCentered-C-ieOCBn.js";import{S as T,g as B}from"./Sources-TFJwJ8A4.js";import{u as fe}from"./useAppTitleAndAction-Qhrh_BkB.js";import{M as Se}from"./index-vvcQFnCy.js";import{C as xe}from"./Card-ClSl2UAy.js";import{C as be}from"./CardActionArea-DNWiv-Nz.js";import"./ChaptersDownloadActionMenuItems-tuKcoALG.js";import"./Trackers-D4pSmk7a.js";import"./ListCardContent-CoynPlVh.js";import"./Avatar-C3J2UaiB.js";import"./TextField-CTksBse0.js";import"./useFormControl-Duzwmpsm.js";import"./formControlState-Dq1zat_P.js";import"./InputAdornment-Cv5HSwPc.js";import"./CheckCircle-D5F9cyCZ.js";import"./Link-D22D_gCx.js";import"./useManageMangaLibraryState-Di9m2aVX.js";import"./ThreeStateCheckboxInput-DKpappyc.js";import"./Checkbox-DYjBAZGb.js";import"./SwitchBase-UsGD7FS6.js";import"./CheckboxInput-CONW3GzG.js";import"./FormGroup-DT_NyV1j.js";import"./ListPreference-DDue1aKx.js";import"./NumberSetting-6185Izzy.js";import"./Slider-C6GgYjGn.js";import"./useMobilePicker-C-osmVmg.js";import"./Chip-D7nNR2Nq.js";import"./SelectSetting-BbYpK0sr.js";import"./Select-D8q08aMn.js";import"./Switch-BzFGPcZX.js";import"./MangaGrid-Fnd2c4C-.js";import"./Delete-D1V5RDTd.js";import"./Download-DDYAj0A0.js";import"./Sync-Dr_-rxOu.js";import"./use-merged-ref-DQQPRP4g.js";import"./ListCardAvatar-DpP0EdrR.js";import"./PlayArrow-DiLfKCRZ.js";import"./StyledFab-B6oU9v4L.js";import"./Virtuoso.util-yZ1KuQeE.js";import"./useAppTitle-ZPuGx_MD.js";import"./useAppAction-V9q1xf-c.js";const ye={x:0,y:0,width:0,height:0,top:0,left:0,bottom:0,right:0};function Re(o){const a=i.useRef(0),t=i.useRef(null),[d,h]=i.useState(ye),r=i.useMemo(()=>typeof window<"u"?new ResizeObserver(n=>{const s=n[0];s&&(cancelAnimationFrame(a.current),a.current=requestAnimationFrame(()=>{var c,p;if(t.current){const u=((c=s.borderBoxSize)==null?void 0:c[0])||((p=s.contentBoxSize)==null?void 0:p[0]);if(u){const m=u.inlineSize,b=u.blockSize;h({width:m,height:b,x:s.contentRect.x,y:s.contentRect.y,top:s.contentRect.top,left:s.contentRect.left,bottom:s.contentRect.bottom,right:s.contentRect.right})}else h(s.contentRect)}}))}):null,[]);return i.useEffect(()=>(t.current&&(r==null||r.observe(t.current,o)),()=>{r==null||r.disconnect(),a.current&&cancelAnimationFrame(a.current)}),[t.current]),[t,d]}function we(o){const[a,{width:t,height:d}]=Re(o);return{ref:a,width:t,height:d}}const je=(o,a)=>o.displayName.localeCompare(a.displayName),Le=(o,a,t)=>{const d=B(o).isPinned,h=B(a).isPinned,r=t.get(o.id),n=t.get(a.id),s=!(r!=null&&r.isLoading),c=!!(r!=null&&r.error),p=!(r!=null&&r.hasResults)&&!c,u=!(n!=null&&n.isLoading),m=!!(n!=null&&n.error),b=!(n!=null&&n.hasResults)&&!m;return s&&!u?-1:!s&&u||p&&!b?1:b&&!p||!c&&m?-1:c&&!m?1:d&&!h?-1:!d&&h?1:0},Me=1e3,Ee=Y.memo(({source:o,onSearchRequestFinished:a,searchString:t,emptyQuery:d,mode:h,shouldShowOnlySourcesWithResults:r})=>{var L,M;const{t:n}=q(),{id:s,name:c,lang:p}=o,u=i.useRef(t),m=i.useRef(()=>{});u.current!==t&&(u.current=t,m.current(new Error("SourceSearchPreview(".concat(s,", ").concat(c,"): search string changed"))));const[w,f]=O.useSourceSearch(s,t!=null?t:"",void 0,1,{skipRequest:!t,addAbortSignal:!0}),{data:j,isLoading:S,error:g,abortRequest:R}=f[0];m.current=R;const E=(M=(L=j==null?void 0:j.fetchSourceManga)==null?void 0:L.mangas)!=null?M:[],y=!g&&!S&&!E.length;i.useEffect(()=>{a(o,{isLoading:S,hasResults:!y,emptySearch:!t,error:g})},[S,y,t,g]);let x;return g?x=n("search.error.label.source_search_failed"):y&&(x=n("manga.error.label.no_mangas_found")),!S&&!t||d||r&&(y||g)?null:e.jsxs(P,{sx:{pb:2},children:[e.jsx(xe,{sx:{mb:1},children:e.jsxs(be,{component:ee,to:Z.sources.childRoutes.browse.path(s,t),sx:{p:1,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(P,{children:[e.jsx(F,{variant:"h5",children:c}),e.jsx(F,{variant:"caption",children:de(p)})]}),e.jsx(te,{title:n("global.button.show_more"),children:e.jsx(re,{...Se.preventRippleProp(),children:e.jsx(oe,{})})})]})}),x?e.jsx(se,{sx:{alignItems:"start",height:void 0},noFaces:!0,message:x,messageExtra:v(g),retry:g?()=>w(1).catch(D("SourceSearchPreview(".concat(o.id,")::refetch"))):void 0}):e.jsx(he,{gridWrapperProps:{sx:{px:0}},mangas:E,isLoading:S,hasNextPage:!1,loadMore:()=>{},horizontal:!0,noFaces:!0,message:x,inLibraryIndicator:!0,mode:h},t)]})}),wt=()=>{const{t:o}=q(),{pathname:a,state:t}=$(),{ref:d,height:h}=we(),r=a.startsWith("/migrate/source"),[n]=ae("query",ie),s=z(n,Me),[c,p]=U("shownSourceLangs",Q()),[u,m]=V("SearchAll::shouldShowOnlyPinnedSources",!0),{settings:{showNsfw:b,shouldShowOnlySourcesWithResults:w}}=J(),{data:f,loading:j,error:S,refetch:g}=O.useGetSourceList({notifyOnNetworkStatusChange:!0}),R=i.useMemo(()=>{var l;return(l=f==null?void 0:f.sources.nodes)!=null?l:[]},[f==null?void 0:f.sources.nodes]),[E,y]=i.useState(new Map),x=z(E,500),L=i.useMemo(()=>T.getLanguages(R),[R]),M=i.useMemo(()=>T.filter(R,{showNsfw:b,languages:c,keepLocalSource:!0,pinned:u}),[R,c,u]),I=i.useMemo(()=>[...M].toSorted(je),[M]),H=i.useMemo(()=>[...I].sort((l,C)=>Le(l,C,x)),[I,x]),N=i.useCallback(({id:l},C)=>{y(W=>{const _=new Map(W);return _.set(l,C),_})},[y]),G=X(l=>ne(o("global.error.label.failed_to_save_changes"),"error",v(l)));return fe(o(r?"migrate.search.title":"search.title.global_search",{title:t==null?void 0:t.mangaTitle}),e.jsxs(e.Fragment,{children:[e.jsx(ce,{isClosable:!1}),e.jsx(pe,{selectedLanguages:c,setSelectedLanguages:p,languages:L})]}),[c,p,L]),j?e.jsx(K,{}):S?e.jsx(ge,{message:o("global.error.label.failed_to_load_data"),messageExtra:v(S),retry:()=>g().catch(D())}):e.jsxs(P,{sx:{position:"relative",px:1,pb:1},children:[e.jsxs(k,{ref:d,sx:{width:"100%",position:"fixed",zIndex:1,flexDirection:"row",gap:2,pt:1,pb:2,background:l=>l.palette.background.default},children:[e.jsxs(k,{sx:{flexDirection:"row",gap:1},children:[e.jsx(A,{startIcon:e.jsx(ue,{}),variant:u?"contained":"outlined",onClick:()=>m(!0),children:o("global.label.pinned")}),e.jsx(A,{startIcon:e.jsx(le,{}),variant:u?"outlined":"contained",onClick:()=>m(!1),children:o("extension.language.all")})]}),e.jsx(A,{startIcon:e.jsx(me,{}),variant:w?"contained":"outlined",onClick:()=>G("shouldShowOnlySourcesWithResults",!w),children:o("search.filter.has_results")})]}),e.jsx(P,{sx:{pt:"".concat(h,"px")},children:H.map(l=>e.jsx(Ee,{source:l,onSearchRequestFinished:N,searchString:s,emptyQuery:!n,mode:r?"migrate.select":"source",shouldShowOnlySourcesWithResults:w},l.id))})]})};export{wt as SearchAll};
