import{f as r,j as e,A as w,L as E,G as S,u as P,H as _,r as x,g as A,k as O,T as b,i as H}from"./index-DTQcHRNq.js";import{E as j}from"./EmptyViewAbsoluteCentered-bTeHgt0_.js";import{U as M}from"./UpdateChecker-DCae4Clz.js";import{S as v,a as B}from"./StyledGroupHeader-Df8I-XWU.js";import{S as F}from"./StyledGroupItemWrapper-CIcBAj30.js";import{d as N}from"./DateHelper-iUssApVy.js";import{V as d}from"./Virtuoso.util-BEq39dM3.js";import{C as V,D}from"./ChapterCardMetadata-C9hXZaWH.js";import{C as K,a as q}from"./ChapterDownloadButton-COImfQoI.js";import{C as z}from"./ChapterDownloadRetryButton-DuaaOcNe.js";import{C as y}from"./Chapters-NZHwVf0F.js";import{L as W}from"./ListCardContent-CDZPf7Om.js";import{C as X}from"./Card-DwjPYwc9.js";import{C as Z}from"./CardActionArea-QLjppFZ6.js";import{u as J}from"./useAppTitleAndAction-dMdeYZxD.js";import{G as Q}from"./Virtuoso.constants-DKNufsdf.js";import"./Refresh-DJeMd5z5.js";import"./Progress-SdEscz0O.js";import"./index-CSVPA2Gg.js";import"./use-merged-ref-WRV_-IPF.js";import"./Mangas-CMkGJwB6.js";import"./Asserts-BUjBqOFB.js";import"./ListCardAvatar-DjhgmQ7E.js";import"./AvatarSpinner-BSVFqSDK.js";import"./SpinnerImage-BInWHnIa.js";import"./Image-DYGjRLrg.js";import"./Download-Bd-0fWtb.js";import"./MUI.util-CEodEA2f.js";import"./useAppTitle-DrTt0Oib.js";import"./useAppAction-BB-HUXnS.js";const Y=r.memo(({chapter:t})=>{const{manga:s}=t;return e.jsx(X,{children:e.jsx(Z,{component:E,to:w.reader.path(t.manga.id,t.sourceOrder),state:y.getReaderOpenChapterLocationState(t),sx:{color:a=>a.palette.text[t.isRead?"disabled":"primary"]},children:e.jsxs(W,{sx:{justifyContent:"space-between"},children:[e.jsxs(S,{sx:{display:"flex",flexGrow:1,gap:1},children:[e.jsx(K,{mangaId:s.id,sourceId:s.sourceId,mangaTitle:s.title,thumbnailUrl:s.thumbnailUrl,thumbnailUrlLastFetched:s.thumbnailUrlLastFetched}),e.jsx(V,{title:s.title,secondaryText:t.name})]}),e.jsx(D,{chapterId:t.id}),e.jsx(z,{chapterId:t.id}),e.jsx(q,{chapterId:t.id,isDownloaded:t.isDownloaded})]})})})}),we=()=>{var f;const{t}=P(),{appBarHeight:s}=_(),{data:a,loading:l,error:u,fetchMore:T,refetch:I}=x.useGetRecentlyUpdatedChapters(void 0,{fetchPolicy:"cache-and-network",notifyOnNetworkStatusChange:!0}),c=!!(a!=null&&a.chapters.pageInfo.hasNextPage),U=a==null?void 0:a.chapters.pageInfo.endCursor,i=(f=a==null?void 0:a.chapters.nodes)!=null?f:[],n=r.useMemo(()=>Object.entries(y.groupByDate(i,"fetchedAt")),[i]),g=r.useMemo(()=>n.map(o=>o[d.ITEMS].length),[n]),G=d.useCreateGroupedComputeItemKey(g,r.useCallback(o=>n[o][d.GROUP],[n]),r.useCallback(o=>i[o].id,[i])),p=r.useRef(null),[L,R]=r.useState(0);r.useLayoutEffect(()=>{var o,C;R((C=(o=p.current)==null?void 0:o.clientHeight)!=null?C:0)},[p.current]);const{data:m}=x.useGetLastGlobalUpdateTimestamp({fetchPolicy:"cache-only"}),h=m==null?void 0:m.lastUpdateTimestamp.timestamp;J(t("updates.title"),e.jsx(M,{}));const k=r.useCallback(()=>{c&&T({variables:{offset:i.length}})},[c,U]);return u?e.jsx(j,{message:t("global.error.label.failed_to_load_data"),messageExtra:A(u),retry:()=>I().catch(O())}):!l&&i.length===0?e.jsx(j,{message:t("updates.error.label.no_updates_available")}):e.jsxs(e.Fragment,{children:[e.jsx(b,{ref:p,sx:{position:"sticky",top:s,zIndex:Q,backgroundColor:"background.default",marginLeft:"10px",paddingTop:o=>({[o.breakpoints.up("sm")]:{paddingTop:"6px"}})},children:t("library.settings.global_update.label.last_update",{date:h?N.format(+h):"-"})}),e.jsx(v,{persistKey:"updates",heightToSubtract:L,components:{Footer:()=>l?e.jsx(H,{usePadding:!0}):null},overscan:window.innerHeight*.5,endReached:k,groupCounts:g,groupContent:o=>e.jsx(B,{isFirstItem:o===0,children:e.jsx(b,{variant:"h5",component:"h2",children:n[o][d.GROUP]})}),computeItemKey:G,itemContent:o=>e.jsx(F,{children:e.jsx(Y,{chapter:i[o]})})})]})};export{we as Updates};
