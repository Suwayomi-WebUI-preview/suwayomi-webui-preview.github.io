import{u as A,o as I,a as O,G as de,j as e,p as j,c as g,f as se,I as ue,q as be,s as he,t as pe,h as Z,M as ge,N as me,E as ee,g as fe}from"./index-oRIRLdTc.js";import{u as B,S as oe,A as Ce,N as xe}from"./AppbarSearch-C1YQ0CB4.js";import{T as ye,a as je}from"./Tabs-D6fIrhbX.js";import{d as Se}from"./FilterList-DGjncu9R.js";import{C as R}from"./CheckboxInput-DMbgtOSw.js";import{S as ke,R as D}from"./SortRadioInput-rRGQkf2n.js";import{T as L}from"./ThreeStateCheckboxInput-B-CbCuTI.js";import{O as _e,S as Te,a as Me}from"./SelectionFAB-C8UH1pjR.js";import{T as Le}from"./Trackers-D4pSmk7a.js";import{F as w}from"./TextField-DMTi1w9F.js";import{R as we}from"./ListPreference-CXUgdAnc.js";import{M as Fe,a as Ae}from"./MangaGrid-BL_K3BuO.js";import{d as Ie,U as Re}from"./UpdateChecker-Dnex-b0A.js";import{u as Ee}from"./useManageMangaLibraryState-CDblByhM.js";import{C as ve}from"./Checkbox-BdS23FYY.js";import{b as k,e as P}from"./Strings-CWt9sr6N.js";import{T as Ne,a as De}from"./TabsMenu-Dq9xWiDD.js";import{M as Ge}from"./Mangas-kvZcDncw.js";import{C as Oe}from"./Chip-JPf_ZSz1.js";import"./StyledFab-Cb3Wf9hh.js";import"./SwitchBase-BlBfNF3c.js";import"./index-GvSbNFLs.js";import"./Delete-BVPdRoPh.js";import"./Sync-B3l4Ax5K.js";import"./SpinnerImage-DW9OsWzH.js";import"./TypographyMaxLines-BNHg7A0t.js";import"./Link-C1gu1KUN.js";import"./Avatar-CcDXsjIp.js";import"./PlayArrow-DZuT6F0m.js";import"./Progress-B6BP4XgX.js";import"./Info-9sXqn82X.js";import"./InputAdornment-D_9Ms7n1.js";import"./Collapse-B8XrT4qm.js";import"./NumberSetting-Bj_AJdfH.js";import"./useMobilePicker-DtWyLc-8.js";import"./SelectSetting-R9bHNOf-.js";import"./Select-5E6XA32z.js";import"./Chapters-hIKX2fci.js";const Be={filter:"global.label.filter",sort:"global.label.sort",display:"global.label.display"},Pe=[["sortToRead","library.option.sort.label.by_unread_chapters"],["sortAlph","library.option.sort.label.alphabetically"],["sortDateAdded","library.option.sort.label.by_date_added"],["sortLastRead","library.option.sort.label.by_last_read"],["sortLatestFetchedChapter","library.option.sort.label.by_latest_fetched_chapter"],["sortLatestUploadedChapter","library.option.sort.label.by_latest_uploaded_chapter"]],Ue=({open:a,onClose:r})=>{var u,m;const{t}=A(),{options:o,setOptions:n}=I(),c=O.useGetTrackerList(de),d=Le.getLoggedIn((m=(u=c.data)==null?void 0:u.trackers.nodes)!=null?m:[]),l=(p,s)=>{n(h=>({...h,[p]:s}))};return e.jsx(_e,{open:a,onClose:r,tabs:["filter","sort","display"],tabTitle:p=>t(Be[p]),tabContent:p=>{if(p==="filter")return e.jsxs(e.Fragment,{children:[e.jsx(L,{label:t("global.filter.label.unread"),checked:o.unread,onChange:s=>l("unread",s)}),e.jsx(L,{label:t("global.filter.label.downloaded"),checked:o.downloaded,onChange:s=>l("downloaded",s)}),e.jsx(L,{label:t("global.filter.label.bookmarked"),checked:o.bookmarked,onChange:s=>l("bookmarked",s)}),e.jsx(L,{label:t("global.filter.label.duplicate_chapters"),checked:o.hasDuplicateChapters,onChange:s=>l("hasDuplicateChapters",s)}),e.jsx(w,{sx:{mt:2},children:t("global.filter.label.tracked")}),d.map(s=>e.jsx(L,{label:s.name,checked:o.tracker[s.id],onChange:h=>l("tracker",{...o.tracker,[s.id]:h})},s.id))]});if(p==="sort")return Pe.map(([s,h])=>e.jsx(ke,{label:t(h),checked:o.sorts===s,sortDescending:o.sortDesc,onClick:()=>s!==o.sorts?l("sorts",s):l("sortDesc",!o.sortDesc)},s));if(p==="display"){const{gridLayout:s,showContinueReadingButton:h,showDownloadBadge:b,showUnreadBadge:_,showTabSize:T}=o;return e.jsxs(e.Fragment,{children:[e.jsx(w,{children:t("global.grid_layout.title")}),e.jsxs(we,{onChange:E=>l("gridLayout",Number(E.target.value)),value:s,children:[e.jsx(D,{label:t("global.grid_layout.label.compact_grid"),value:j.Compact,checked:s==null||s===j.Compact}),e.jsx(D,{label:t("global.grid_layout.label.comfortable_grid"),value:j.Comfortable,checked:s===j.Comfortable}),e.jsx(D,{label:t("global.grid_layout.label.list"),value:j.List,checked:s===j.List})]}),e.jsx(w,{sx:{mt:2},children:t("library.option.display.badge.title")}),e.jsx(R,{label:t("library.option.display.badge.label.unread_badges"),checked:_,onChange:()=>l("showUnreadBadge",!_)}),e.jsx(R,{label:t("library.option.display.badge.label.download_badges"),checked:b,onChange:()=>l("showDownloadBadge",!b)}),e.jsx(w,{sx:{mt:2},children:t("library.option.display.tab.title")}),e.jsx(R,{label:t("library.option.display.tab.label.show_number_of_items"),checked:T,onChange:()=>l("showTabSize",!T)}),e.jsx(w,{sx:{mt:2},children:t("global.label.other")}),e.jsx(R,{label:t("library.option.display.other.label.show_continue_reading_button"),checked:h,onChange:()=>l("showContinueReadingButton",!h)})]})}return null}})},ze=()=>{const{t:a}=A(),[r,t]=g.useState(!1),{options:o}=I(),n=o.downloaded!=null||o.unread!=null||Object.values(o.tracker).some(c=>c!=null);return e.jsxs(e.Fragment,{children:[e.jsx(se,{title:a("settings.title"),children:e.jsx(ue,{onClick:()=>t(!r),color:n?"warning":"default",children:e.jsx(Se,{})})}),e.jsx(Ue,{open:r,onClose:()=>t(!1)})]})},te=({showFilteredOutMessage:a,message:r,messageExtra:t,...o})=>{const{t:n}=A(),[c]=B("query",oe),{options:d}=I(),{unread:l,downloaded:u}=d;return g.useEffect(()=>{window.scrollTo(0,0)},[c,l,u]),g.useLayoutEffect(()=>(document.body.style.overflowY=d.gridLayout===j.List?"auto":"scroll",()=>{document.body.style.overflowY="auto"}),[]),e.jsx(Fe,{...o,hasNextPage:!1,loadMore:()=>{},message:a?n("library.error.label.no_matches"):r,messageExtra:a?void 0:t,gridLayout:d.gridLayout})},Ke=({isActive:a,areAllItemsSelected:r,areNoItemsSelected:t,onSelectAll:o,onModeChange:n})=>{const{t:c}=A();return e.jsxs(e.Fragment,{children:[a&&e.jsx(Te,{areAllItemsSelected:r,areNoItemsSelected:t,onChange:o}),e.jsx(se,{title:c(a?"global.button.cancel":"global.button.select_all"),children:e.jsx(ve,{checkedIcon:e.jsx(Ie,{}),sx:{padding:"8px"},checked:a,onChange:(d,l)=>n(l)})})]})},U=(a,r,t)=>{switch(a){case!0:return r();case!1:return t();default:return!0}},G=(a,r)=>U(a,()=>!!r&&r>=1,()=>r===0),Qe=(a,r)=>U(a,()=>!!r,()=>!r),He=(a,{title:r})=>{if(!a)return!0;const t=k(a);return k(r).includes(t)||P(r).includes(t)},We=(a,{genre:r})=>{if(!a)return!0;const t=a.split(",").map(k),o=r.map(n=>{const c=k(n),d=P(c);return"".concat(c,", ").concat(d)}).join(", ");return t.every(n=>o.includes(n))},Ye=(a,{description:r})=>{if(!a)return!0;if(!r)return!1;const t=k(a);return k(r).includes(t)||P(r).includes(t)},$e=(a,r)=>Object.entries(a).map(([t,o])=>{const n=r.trackRecords.nodes.some(c=>c.trackerId===Number(t));return U(o,()=>n,()=>!n)}).every(t=>t),qe=(a,r,t,o,n,c,d,l)=>a.filter(u=>{const m=l&&(r==null?void 0:r.length),p=He(r,u)||We(r,u)||Ye(r,u),s=m||G(o,u.downloadCount)&&G(t,u.unreadCount)&&G(n,u.bookmarkCount)&&Qe(c,u.hasDuplicateChapters)&&$e(d,u);return p&&s}),F=(a=0,r=0)=>Number(a)-Number(r),Ve=(a,r)=>a.localeCompare(r),Je=(a,r,t)=>{const o=[...a];switch(r){case"sortAlph":o.sort((n,c)=>Ve(n.title,c.title));break;case"sortDateAdded":o.sort((n,c)=>F(n.inLibraryAt,c.inLibraryAt));break;case"sortToRead":o.sort((n,c)=>F(n.unreadCount,c.unreadCount));break;case"sortLastRead":o.sort((n,c)=>{var d,l;return F((d=n.lastReadChapter)==null?void 0:d.lastReadAt,(l=c.lastReadChapter)==null?void 0:l.lastReadAt)});break;case"sortLatestUploadedChapter":o.sort((n,c)=>{var d,l;return F((d=n.latestUploadedChapter)==null?void 0:d.uploadDate,(l=c.latestUploadedChapter)==null?void 0:l.uploadDate)});break;case"sortLatestFetchedChapter":o.sort((n,c)=>{var d,l;return F((d=n.latestFetchedChapter)==null?void 0:d.fetchedAt,(l=c.latestFetchedChapter)==null?void 0:l.fetchedAt)});break}return t&&o.reverse(),o},Xe=a=>{const[r]=B("query",oe),{options:t}=I(),{unread:o,downloaded:n,bookmarked:c,tracker:d,hasDuplicateChapters:l}=t,{settings:u}=be(),m=g.useMemo(()=>qe(a,r,o,n,c,l,d,u.ignoreFilters),[a,r,o,n,c,l,d,u.ignoreFilters]),p=g.useMemo(()=>Je(m,t.sorts,t.sortDesc),[m,t.sorts,t.sortDesc]),s=Object.values(t.tracker).some(b=>b!=null),h=(o!=null||n!=null||c!=null||!!r||s)&&m.length===0&&a.length>0;return{visibleMangas:p,showFilteredOutMessage:h}},ae=he("span")({display:"flex",alignItems:"center"}),re=a=>e.jsx(Oe,{...a,size:"small",sx:{marginLeft:"5px"}});function Gt(){var J,X;const{t:a}=A(),{options:r}=I(),{data:t,error:o,loading:n,refetch:c}=O.useGetCategories(pe,{notifyOnNetworkStatusChange:!0}),d=t==null?void 0:t.categories.nodes.filter(i=>i.id!==0||i.id===0&&i.mangas.totalCount),l=d!=null?d:[],u=g.useMemo(()=>l.map(i=>i.mangas.totalCount).reduce((i,f)=>i+f,0),[l]),[m,p]=B("tab",xe),s=(J=l.find(i=>i.order===m))!=null?J:l[0],{data:h,error:b,loading:_,refetch:T}=O.useGetCategoryMangas(s==null?void 0:s.id,{skip:!s,notifyOnNetworkStatusChange:!0}),E=(X=h==null?void 0:h.mangas.nodes)!=null?X:[],{visibleMangas:C,showFilteredOutMessage:z}=Xe(E),K=g.useCallback(()=>T().catch(Z()),[T,s]),le=g.useMemo(()=>C.map(i=>i.id),[C]),[x,v]=g.useState(!1),{areNoItemsForKeySelected:Q,areAllItemsForKeySelected:H,selectedItemIds:y,handleSelectAll:N,handleSelection:ne,clearSelection:ie}=Ee(C.length,{itemIds:le,currentKey:s==null?void 0:s.id.toString()}),W=(i,f,S)=>{v(!!(y.length+(f?1:-1))),ne(i,f,S)},Y=g.useMemo(()=>y.map(i=>Ge.getFromCache(i,ge,"MANGA_CHAPTER_STAT_FIELDS")).filter(i=>!!i),[y.length,C]),$=g.useMemo(()=>x?e.jsx(Me,{selectedItemsCount:y.length,title:"manga.title",children:(i,f)=>e.jsx(Ae,{selectedMangas:Y,onClose:()=>{i(),v(!1),ie()},setHideMenu:f})}):null,[x,Y]),{setTitle:q,setAction:V}=g.useContext(me);g.useEffect(()=>{const i=a("library.title"),f=e.jsxs(ae,{children:[i,r.showTabSize&&e.jsx(re,{label:u})]});return q(f,i),V(e.jsxs(e.Fragment,{children:[!x&&e.jsxs(e.Fragment,{children:[e.jsx(Ce,{}),e.jsx(ze,{}),e.jsx(Re,{categoryId:s==null?void 0:s.id})]}),e.jsx(Ke,{isActive:x,areAllItemsSelected:H,areNoItemsSelected:Q,onSelectAll:S=>N(S,[...new Set(C.map(M=>M.id))]),onModeChange:S=>{v(S),S?N(!0,[...new Set(C.map(M=>M.id))]):l.forEach(M=>N(!1,[],M.id.toString()))}})]})),()=>{q(""),V(null)}},[a,u,n,r,x,Q,H,y.length,C.length,s]);const ce=i=>{p(i)};return o!=null?e.jsx(ee,{message:a("category.error.label.request_failure"),messageExtra:o.message,retry:()=>c().catch(Z())}):n?e.jsx(fe,{}):l.length===0?e.jsx(ee,{message:a("library.error.label.empty")}):l.length===1?e.jsxs(e.Fragment,{children:[e.jsx(te,{mangas:C,message:a(b?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:b==null?void 0:b.message,isLoading:_,selectedMangaIds:y,isSelectModeActive:x,handleSelection:W,showFilteredOutMessage:!b&&z,retry:b&&K}),$]}):e.jsxs(Ne,{children:[e.jsx(De,{value:s.order,onChange:(i,f)=>ce(f),tabsCount:l.length,children:l.map(i=>e.jsx(ye,{sx:{display:"flex"},label:e.jsxs(ae,{children:[i.name,r.showTabSize?e.jsx(re,{label:i.mangas.totalCount}):null]}),value:i.order},i.id))}),l.map(i=>e.jsx(je,{index:i.order,currentIndex:s.order,children:i===s&&e.jsx(te,{mangas:C,message:a(b?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:b==null?void 0:b.message,isLoading:_,selectedMangaIds:y,isSelectModeActive:x,handleSelection:W,showFilteredOutMessage:!b&&z,retry:b&&K})},i.order)),$]})}export{Gt as Library};
