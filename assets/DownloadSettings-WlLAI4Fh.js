import{u as j,j as t,H as T,o as b,p as m,bz as D,Z as X,m as V,g as E,b as L,aS as K,i as Z,k as J,n as Q,b8 as ee,S as v,q as te,B as N,bA as ae,b3 as $,bB as F,C as oe,I as se,be as ne,r as M,b5 as le,a as ie,e as de,f as U,b2 as re,y as ce}from"./index-kzF4ix3O.js";import{N as B}from"./NumberSetting-BP4rBdsu.js";import{u as he,g as ue}from"./usePersistedValue-CH1Sa-ft.js";import{S as _}from"./Switch-4PG44UyK.js";import{S as pe}from"./SelectSetting-BZu8gpfF.js";import{a as ge}from"./CategoriesInclusionSetting-6lmKTcfv.js";import{E as me}from"./EmptyViewAbsoluteCentered-BOST1byO.js";import{u as xe}from"./useAppTitle-DWjdhXdc.js";import{D as we}from"./Delete-CtsLVJFF.js";import{L as P}from"./ListSubheader-Cmi7i_KO.js";import"./Slider-DPC_-aE5.js";import"./SwitchBase-BmJzQQty.js";import"./Select-DU1e2Vsq.js";import"./ThreeStateCheckboxInput-D3LxevZj.js";import"./Checkbox-DmsS11H5.js";const be=({downloadAheadLimit:e})=>{const{t:a}=j(),s=!!e,[n,h]=he("lastDownloadAheadLimit",D.default,e,ue),i=d=>{h(d===0?n:d),X("downloadAheadLimit",d).catch(p=>V(a("global.error.label.failed_to_save_changes"),"error",E(p)))},r=d=>{i(d?n:0)};return t.jsxs(T,{children:[t.jsxs(b,{children:[t.jsx(m,{primary:a("download.settings.download_ahead.label.while_reading")}),t.jsx(_,{edge:"end",checked:s,onChange:d=>r(d.target.checked)})]}),t.jsx(B,{settingTitle:a("download.settings.download_ahead.label.unread_chapters_to_download"),settingValue:a("download.settings.download_ahead.label.value",{chapters:n,count:n}),value:n,minValue:D.min,maxValue:D.max,defaultValue:D.default,stepSize:D.step,showSlider:!0,dialogDescription:a("download.settings.download_ahead.label.description"),dialogDisclaimer:a("download.settings.download_ahead.label.disclaimer"),valueUnit:a("chapter.title_one"),handleUpdate:i,disabled:!s})]})},_e=[0,1,2,3,4,5],Ce={0:{text:"global.label.disabled"},1:{text:"download.settings.delete_chapters.while_reading.option.label.first"},2:{text:"download.settings.delete_chapters.while_reading.option.label.second"},3:{text:"download.settings.delete_chapters.while_reading.option.label.third"},4:{text:"download.settings.delete_chapters.while_reading.option.label.fourth"},5:{text:"download.settings.delete_chapters.while_reading.option.label.fifth"}},je=_e.map(e=>[e,Ce[e]]),fe=e=>typeof e=="boolean"?Number(e):e,De=({chapterToDelete:e,handleChange:a})=>{const{t:s}=j(),n=fe(e);return t.jsx(pe,{settingName:s("download.settings.delete_chapters.while_reading.label.title"),value:n,values:je,handleChange:a})},H="default",k="image/",R=-1,y=e=>e.replace(k,""),G=e=>y(e.toLowerCase().trim())===H,q=(e,a,s)=>s.slice(0,a).some(n=>n.mimeType===e),Y=e=>e==null||e>=F.min&&e<=F.max,Te=e=>e.some(({mimeType:a,compressionLevel:s},n)=>!Y(s)||q(a,n,e)),O=e=>e.map(a=>({...a,mimeType:y(a.mimeType),target:y(a.target)})),W=e=>e.filter(({mimeType:a,target:s})=>!!a&&!!s).map(a=>({...a,mimeType:"".concat(k).concat(a.mimeType),target:"".concat(k).concat(a.target)})),S=e=>[...e.some(({mimeType:s})=>G(s))?[]:[{mimeType:H,target:"",compressionLevel:null}],...e],ve=(e,a)=>e.length!==a.length?!0:e.some(({mimeType:s,target:n,compressionLevel:h},i)=>{const r=a[i];return y(s)!==r.mimeType||y(n)!==r.target||h!==r.compressionLevel}),z=({shouldAutoFocus:e,isDefault:a,isDuplicate:s,label:n,value:h,onUpdate:i})=>{const{t:r}=j();return t.jsx($,{sx:{maxWidth:150},autoFocus:e,label:n,value:h,disabled:a,error:s,helperText:s&&r("global.error.label.invalid_input"),slotProps:{input:{startAdornment:t.jsx(ne,{position:"start",children:k})}},onChange:d=>i(d.target.value.trim())})},ye=({shouldAutoFocusMimeTypeTextField:e,conversion:{mimeType:a,target:s,compressionLevel:n},setFocusMimeTypeTextField:h,onChange:i,isDuplicate:r})=>{const{t:d}=j(),p=Y(n),x=G(a)&&!r,o=x&&!s&&n==null;return t.jsxs(v,{sx:{gap:1,flexDirection:"row",flexWrap:"nowrap",alignItems:"center",pt:1},children:[t.jsxs(v,{sx:{gap:1,flexDirection:"row",alignItems:"baseline",flexWrap:"wrap"},children:[t.jsx(z,{shouldAutoFocus:e,isDefault:x,isDuplicate:r,label:d("download.settings.conversion.mime_type"),value:a,onUpdate:c=>{h(!0),i({mimeType:c,target:s,compressionLevel:n})}}),t.jsx(ae,{sx:{mx:1},children:"→"}),t.jsx(z,{shouldAutoFocus:!1,isDefault:!1,isDuplicate:!1,label:d("download.settings.conversion.target"),value:s,onUpdate:c=>i({mimeType:a,target:c,compressionLevel:n})}),t.jsx($,{label:d("download.settings.conversion.compression_level"),value:n!=null?n:"",type:"number",error:!p,helperText:p?"":d("global.error.label.invalid_input"),slotProps:{input:{inputProps:F}},onChange:c=>{i({mimeType:a,target:s,compressionLevel:c.target.value?Number(c.target.value):void 0})}})]}),t.jsx(oe,{disabled:o,title:d("chapter.action.download.delete.label.action"),children:t.jsx(se,{disabled:o,onClick:()=>{h(!1),i(null)},children:t.jsx(we,{})})})]})},Se=({conversions:e,updateSetting:a})=>{const{t:s}=j(),[n,h]=L.useState(!1),[i,r]=L.useState(O(S(e))),[d,p]=L.useState(R),x=Te(i),o=ve(O(S(e)),i),c=(u=e)=>{r(O(S(u))),h(!1)},C=()=>{c(e)};return t.jsxs(t.Fragment,{children:[t.jsx(K,{disabled:!1,onClick:()=>h(!0),children:t.jsx(m,{primary:s("download.settings.conversion.title"),secondary:e.map(u=>"".concat(u.mimeType," → ").concat(u.target)).join("; "),secondaryTypographyProps:{style:{display:"flex",flexDirection:"column"}}})}),t.jsxs(Z,{open:n,onClose:C,children:[t.jsx(J,{children:s("download.settings.conversion.title")}),t.jsxs(Q,{children:[t.jsx(ee,{sx:{mb:2,whiteSpace:"pre-line"},children:s("download.settings.conversion.description",{value:"none"})}),t.jsx(v,{sx:{flexDirection:"column",gap:3},children:i.map((u,g)=>{const{mimeType:f}=u,l=q(f,g,i),A=g===d;return t.jsx(ye,{conversion:u,isDuplicate:l,setFocusMimeTypeTextField:w=>p(w?g:R),shouldAutoFocusMimeTypeTextField:A,onChange:w=>{r(I=>S(I.toSpliced(g,1,...w?[w]:[])))}},"".concat(f,"-").concat(g))})})]}),t.jsx(te,{children:t.jsxs(v,{direction:"row",sx:{justifyContent:"space-between",width:"100%"},children:[t.jsx(N,{variant:"outlined",onClick:()=>{r(u=>[...u,{mimeType:"",target:"",compressionLevel:null}])},children:s("global.button.add")}),t.jsxs(v,{direction:"row",children:[t.jsx(N,{onClick:C,children:s("global.button.cancel")}),t.jsx(N,{disabled:x||!o,onClick:()=>a(W(i)).then(()=>c(W(i))),children:s("global.button.ok")})]})]})})]})]})},$e=()=>{var u,g,f;const{t:e}=j();xe(e("download.title.download"));const a=M.useGetCategories(le),s=M.useGetServerSettings({notifyOnNetworkStatusChange:!0}),[n]=M.useUpdateServerSettings(),{settings:h,loading:i,request:{error:r,refetch:d}}=ie();if(s.loading||i||a.loading)return t.jsx(de,{});const x=(g=(u=s.error)!=null?u:r)!=null?g:a.error;if(x)return t.jsx(me,{message:e("global.error.label.failed_to_load_data"),messageExtra:E(x),retry:()=>{s.error&&s.refetch().catch(U()),r&&d().catch(U()),a.error&&a.refetch().catch(U())}});const o=s.data.settings,c=(l,A)=>{const w=n({variables:{input:{settings:{[l]:A}}}});return w.catch(I=>V(e("global.error.label.failed_to_save_changes"),"error",E(I))),w},C=ce(l=>V(e("global.error.label.failed_to_save_changes"),"error",E(l)));return t.jsxs(T,{sx:{pt:0},children:[t.jsx(re,{settingName:e("download.settings.download_path.label.title"),dialogDescription:e("download.settings.download_path.label.description"),value:o==null?void 0:o.downloadsPath,settingDescription:o!=null&&o.downloadsPath.length?o.downloadsPath:e("global.label.default"),handleChange:l=>c("downloadsPath",l)}),t.jsxs(b,{children:[t.jsx(m,{primary:e("download.settings.file_type.label.cbz")}),t.jsx(_,{edge:"end",checked:!!(o!=null&&o.downloadAsCbz),onChange:l=>c("downloadAsCbz",l.target.checked)})]}),t.jsx(Se,{conversions:o==null?void 0:o.downloadConversions,updateSetting:l=>c("downloadConversions",l)}),t.jsxs(T,{subheader:t.jsx(P,{component:"div",id:"download-settings-auto-delete-downloads",children:e("download.settings.delete_chapters.title")}),children:[t.jsxs(b,{children:[t.jsx(m,{primary:e("download.settings.delete_chapters.label.manually_marked_as_read")}),t.jsx(_,{edge:"end",checked:h.deleteChaptersManuallyMarkedRead,onChange:l=>C("deleteChaptersManuallyMarkedRead",l.target.checked)})]}),t.jsx(De,{chapterToDelete:h.deleteChaptersWhileReading,handleChange:l=>C("deleteChaptersWhileReading",l)}),t.jsxs(b,{children:[t.jsx(m,{primary:e("download.settings.delete_chapters.label.allow_deletion_of_bookmarked")}),t.jsx(_,{edge:"end",checked:h.deleteChaptersWithBookmark,onChange:l=>C("deleteChaptersWithBookmark",l.target.checked)})]})]}),t.jsxs(T,{subheader:t.jsx(P,{component:"div",id:"download-settings-auto-download",children:e("download.settings.auto_download.title")}),children:[t.jsxs(b,{children:[t.jsx(m,{primary:e("download.settings.auto_download.label.new_chapters")}),t.jsx(_,{edge:"end",checked:!!(o!=null&&o.autoDownloadNewChapters),onChange:l=>c("autoDownloadNewChapters",l.target.checked)})]}),t.jsx(B,{disabled:!(o!=null&&o.autoDownloadNewChapters),settingTitle:e("download.settings.auto_download.download_limit.label.title"),dialogDescription:e("download.settings.auto_download.download_limit.label.description"),value:(f=o==null?void 0:o.autoDownloadNewChaptersLimit)!=null?f:0,settingValue:o.autoDownloadNewChaptersLimit?e("download.settings.download_ahead.label.value",{chapters:o.autoDownloadNewChaptersLimit,count:o.autoDownloadNewChaptersLimit}):e("global.label.none"),defaultValue:0,minValue:0,maxValue:20,showSlider:!0,valueUnit:e("chapter.title_one"),handleUpdate:l=>c("autoDownloadNewChaptersLimit",l)}),t.jsxs(b,{children:[t.jsx(m,{primary:e("download.settings.auto_download.label.ignore_with_unread_chapters")}),t.jsx(_,{edge:"end",checked:!!(o!=null&&o.excludeEntryWithUnreadChapters),onChange:l=>c("excludeEntryWithUnreadChapters",l.target.checked),disabled:!(o!=null&&o.autoDownloadNewChapters)})]}),t.jsxs(b,{children:[t.jsx(m,{primary:e("download.settings.auto_download.label.ignore_re_uploads")}),t.jsx(_,{edge:"end",checked:!!(o!=null&&o.autoDownloadIgnoreReUploads),onChange:l=>c("autoDownloadIgnoreReUploads",l.target.checked),disabled:!(o!=null&&o.autoDownloadNewChapters)})]}),t.jsx(ge,{categories:a.data.categories.nodes,includeField:"includeInDownload",dialogText:e("download.settings.auto_download.categories.label.include_in_download")})]}),t.jsx(T,{subheader:t.jsx(P,{component:"div",id:"download-settings-download-ahead",children:e("download.settings.download_ahead.title")}),children:t.jsx(be,{downloadAheadLimit:h.downloadAheadLimit})})]})};export{$e as DownloadSettings};
