import{b as o,j as e,a2 as j,A as E,L as G,x as S,u as P,y as _,r as C,g as A,f as O,T as b,bk as M,e as H}from"./index-Bunimexy.js";import{E as y}from"./EmptyViewAbsoluteCentered-BJsAF0H0.js";import{U as v}from"./UpdateChecker-BCyLZd1E.js";import{S as B,a as F}from"./StyledGroupHeader-V_er7K-A.js";import{S as N}from"./StyledGroupItemWrapper-mkooXqrb.js";import{V as d}from"./Virtuoso.util-CLNNImZf.js";import{C as V,D}from"./ChapterCardMetadata-cV3R48Zj.js";import{C as K,a as q}from"./ChapterDownloadButton-C0KrF0rk.js";import{C as z}from"./ChapterDownloadRetryButton-CBADGZBT.js";import{L as W}from"./ListCardContent-CrfXOvm5.js";import{C as X}from"./Card-snMIdYR7.js";import{C as Z}from"./CardActionArea-BIYJ7ZG1.js";import{u as J}from"./useAppTitleAndAction-DxtwbGpc.js";import{G as Q}from"./Virtuoso.constants-DKNufsdf.js";import"./Progress-C5KqgTv5.js";import"./index-Dmc7Cla6.js";import"./use-merged-ref-CG4vRDNJ.js";import"./ListCardAvatar-BMmFcGxR.js";import"./Avatar-y36Vrebj.js";import"./Download-7lmiuZAY.js";import"./MUI.util-CEodEA2f.js";import"./useAppTitle-Cv6DabpI.js";import"./useAppAction-DWKXbAJ_.js";const Y=o.memo(({chapter:t})=>{const{manga:r}=t;return e.jsx(X,{children:e.jsx(Z,{component:G,to:E.reader.path(t.manga.id,t.sourceOrder),state:j.getReaderOpenChapterLocationState(t),sx:{color:s=>s.palette.text[t.isRead?"disabled":"primary"]},children:e.jsxs(W,{sx:{justifyContent:"space-between"},children:[e.jsxs(S,{sx:{display:"flex",flexGrow:1,gap:1},children:[e.jsx(K,{mangaId:r.id,mangaTitle:r.title,thumbnailUrl:r.thumbnailUrl,thumbnailUrlLastFetched:r.thumbnailUrlLastFetched}),e.jsx(V,{title:r.title,secondaryText:t.name})]}),e.jsx(D,{chapterId:t.id}),e.jsx(z,{chapterId:t.id}),e.jsx(q,{chapterId:t.id,isDownloaded:t.isDownloaded})]})})})}),Te=()=>{var f;const{t}=P(),{appBarHeight:r}=_(),{data:s,loading:l,error:u,fetchMore:T,refetch:I}=C.useGetRecentlyUpdatedChapters(void 0,{fetchPolicy:"cache-and-network",notifyOnNetworkStatusChange:!0}),c=!!(s!=null&&s.chapters.pageInfo.hasNextPage),U=s==null?void 0:s.chapters.pageInfo.endCursor,n=(f=s==null?void 0:s.chapters.nodes)!=null?f:[],i=o.useMemo(()=>Object.entries(j.groupByDate(n,"fetchedAt")),[n]),g=o.useMemo(()=>i.map(a=>a[d.ITEMS].length),[i]),L=d.useCreateGroupedComputeItemKey(g,o.useCallback(a=>i[a][d.GROUP],[i]),o.useCallback(a=>n[a].id,[n])),p=o.useRef(null),[R,k]=o.useState(0);o.useLayoutEffect(()=>{var a,x;k((x=(a=p.current)==null?void 0:a.clientHeight)!=null?x:0)},[p.current]);const{data:m}=C.useGetLastGlobalUpdateTimestamp({fetchPolicy:"cache-only"}),h=m==null?void 0:m.lastUpdateTimestamp.timestamp;J(t("updates.title"),e.jsx(v,{}));const w=o.useCallback(()=>{c&&T({variables:{offset:n.length}})},[c,U]);return u?e.jsx(y,{message:t("global.error.label.failed_to_load_data"),messageExtra:A(u),retry:()=>I().catch(O())}):!l&&n.length===0?e.jsx(y,{message:t("updates.error.label.no_updates_available")}):e.jsxs(e.Fragment,{children:[e.jsx(b,{ref:p,sx:{position:"sticky",top:r,zIndex:Q,backgroundColor:"background.default",marginLeft:"10px",paddingTop:a=>({[a.breakpoints.up("sm")]:{paddingTop:"6px"}})},children:t("library.settings.global_update.label.last_update",{date:h?M.format(+h):"-"})}),e.jsx(B,{persistKey:"updates",heightToSubtract:R,components:{Footer:()=>l?e.jsx(H,{usePadding:!0}):null},overscan:window.innerHeight*.5,endReached:w,groupCounts:g,groupContent:a=>e.jsx(F,{isFirstItem:a===0,children:e.jsx(b,{variant:"h5",component:"h2",children:i[a][d.GROUP]})}),computeItemKey:L,itemContent:a=>e.jsx(N,{children:e.jsx(Y,{chapter:n[a]})})})]})};export{Te as Updates};
