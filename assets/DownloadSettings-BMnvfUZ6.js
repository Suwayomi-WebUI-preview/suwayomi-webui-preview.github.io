import{u as j,j as t,H as D,o as w,p as m,bm as f,Y as J,m as O,g as k,b as L,aJ as K,i as Z,k as Q,n as ee,aZ as te,S as T,q as ae,B as M,bn as oe,aV as H,bo as F,C as se,I as ne,b3 as le,r as N,aW as ie,a as re,e as de,f as U,aU as ce,y as he}from"./index-CeCBjXeT.js";import{N as G}from"./NumberSetting-DHQbhW63.js";import{u as ue,g as pe}from"./usePersistedValue-C69W2UYT.js";import{S as _}from"./Switch-C9Sb21l-.js";import{S as ge}from"./SelectSetting-C6s_kRVI.js";import{a as me}from"./CategoriesInclusionSetting-Cnh_Emiz.js";import{E as xe}from"./EmptyViewAbsoluteCentered-UfbEthVP.js";import{u as we}from"./useAppTitle-I3e5bSgI.js";import{D as _e}from"./Delete-CAPdu8QE.js";import{L as P}from"./ListSubheader-8OEgymNj.js";import"./Slider-CISLKei5.js";import"./SwitchBase-irjrQwZj.js";import"./Select-DFkwrDej.js";import"./ThreeStateCheckboxInput-CUGAEFRm.js";import"./Checkbox-D5qWUVxh.js";const be=({downloadAheadLimit:e})=>{const{t:a}=j(),s=!!e,[n,h]=ue("lastDownloadAheadLimit",f.default,e,pe),i=r=>{h(r===0?n:r),J("downloadAheadLimit",r).catch(p=>O(a("global.error.label.failed_to_save_changes"),"error",k(p)))},d=r=>{i(r?n:0)};return t.jsxs(D,{children:[t.jsxs(w,{children:[t.jsx(m,{primary:a("download.settings.download_ahead.label.while_reading")}),t.jsx(_,{edge:"end",checked:s,onChange:r=>d(r.target.checked)})]}),t.jsx(G,{settingTitle:a("download.settings.download_ahead.label.unread_chapters_to_download"),settingValue:a("download.settings.download_ahead.label.value",{chapters:n,count:n}),value:n,minValue:f.min,maxValue:f.max,defaultValue:f.default,stepSize:f.step,showSlider:!0,dialogDescription:a("download.settings.download_ahead.label.description"),dialogDisclaimer:a("download.settings.download_ahead.label.disclaimer"),valueUnit:a("chapter.title_one"),handleUpdate:i,disabled:!s})]})},Ce=[0,1,2,3,4,5],je={0:{text:"global.label.disabled"},1:{text:"download.settings.delete_chapters.while_reading.option.label.first"},2:{text:"download.settings.delete_chapters.while_reading.option.label.second"},3:{text:"download.settings.delete_chapters.while_reading.option.label.third"},4:{text:"download.settings.delete_chapters.while_reading.option.label.fourth"},5:{text:"download.settings.delete_chapters.while_reading.option.label.fifth"}},fe=Ce.map(e=>[e,je[e]]),De=e=>typeof e=="boolean"?Number(e):e,Te=({chapterToDelete:e,handleChange:a})=>{const{t:s}=j(),n=De(e);return t.jsx(ge,{settingName:s("download.settings.delete_chapters.while_reading.label.title"),value:n,values:fe,handleChange:a})},R="default",A="image/",z=-1,y=e=>e.replace(A,""),W=e=>y(e.toLowerCase().trim())===R,Y=(e,a,s)=>s.slice(0,a).some(n=>n.mimeType===e),q=e=>e==null||e>=F.min&&e<=F.max,ye=e=>e.some(({mimeType:a,compressionLevel:s},n)=>!q(s)||Y(a,n,e)),V=e=>e.map(a=>({...a,mimeType:y(a.mimeType),target:y(a.target)})),ve=e=>W(e)?R:"".concat(A).concat(e),$=e=>e.filter(({mimeType:a,target:s})=>!!a&&!!s).map(a=>({...a,mimeType:ve(a.mimeType),target:"".concat(A).concat(a.target)})),E=e=>[...e.some(({mimeType:s})=>W(s))?[]:[{mimeType:R,target:"",compressionLevel:null}],...e],Se=(e,a)=>e.length!==a.length?!0:e.some(({mimeType:s,target:n,compressionLevel:h},i)=>{const d=a[i];return y(s)!==d.mimeType||y(n)!==d.target||h!==d.compressionLevel}),B=({shouldAutoFocus:e,isDefault:a,isDuplicate:s,label:n,value:h,onUpdate:i})=>{const{t:d}=j();return t.jsx(H,{sx:{maxWidth:150},autoFocus:e,label:n,value:h,disabled:a,error:s,helperText:s&&d("global.error.label.invalid_input"),slotProps:{input:{startAdornment:t.jsx(le,{position:"start",children:A})}},onChange:r=>i(r.target.value.trim())})},Ee=({shouldAutoFocusMimeTypeTextField:e,conversion:{mimeType:a,target:s,compressionLevel:n},setFocusMimeTypeTextField:h,onChange:i,isDuplicate:d})=>{const{t:r}=j(),p=q(n),x=W(a)&&!d,o=x&&!s&&n==null;return t.jsxs(T,{sx:{gap:1,flexDirection:"row",flexWrap:"nowrap",alignItems:"center",pt:1},children:[t.jsxs(T,{sx:{gap:1,flexDirection:"row",alignItems:"baseline",flexWrap:"wrap"},children:[t.jsx(B,{shouldAutoFocus:e,isDefault:x,isDuplicate:d,label:r("download.settings.conversion.mime_type"),value:a,onUpdate:c=>{h(!0),i({mimeType:c,target:s,compressionLevel:n})}}),t.jsx(oe,{sx:{mx:1},children:"→"}),t.jsx(B,{shouldAutoFocus:!1,isDefault:!1,isDuplicate:!1,label:r("download.settings.conversion.target"),value:s,onUpdate:c=>i({mimeType:a,target:c,compressionLevel:n})}),t.jsx(H,{label:r("download.settings.conversion.compression_level"),value:n!=null?n:"",type:"number",error:!p,helperText:p?"":r("global.error.label.invalid_input"),slotProps:{input:{inputProps:F}},onChange:c=>{i({mimeType:a,target:s,compressionLevel:c.target.value?Number(c.target.value):void 0})}})]}),t.jsx(se,{disabled:o,title:r("chapter.action.download.delete.label.action"),children:t.jsx(ne,{disabled:o,onClick:()=>{h(!1),i(null)},children:t.jsx(_e,{})})})]})},ke=({conversions:e,updateSetting:a})=>{const{t:s}=j(),[n,h]=L.useState(!1),[i,d]=L.useState(V(E(e))),[r,p]=L.useState(z),x=ye(i),o=Se(V(E(e)),i),c=(u=e)=>{d(V(E(u))),h(!1)},b=()=>{c(e)},v=async()=>{try{await a($(i)),c($(i))}catch(u){}};return t.jsxs(t.Fragment,{children:[t.jsx(K,{disabled:!1,onClick:()=>h(!0),children:t.jsx(m,{primary:s("download.settings.conversion.title"),secondary:e.map(u=>"".concat(u.mimeType," → ").concat(u.target)).join("; "),secondaryTypographyProps:{style:{display:"flex",flexDirection:"column"}}})}),t.jsxs(Z,{open:n,onClose:b,children:[t.jsx(Q,{children:s("download.settings.conversion.title")}),t.jsxs(ee,{children:[t.jsx(te,{sx:{mb:2,whiteSpace:"pre-line"},children:s("download.settings.conversion.description",{value:"none"})}),t.jsx(T,{sx:{flexDirection:"column",gap:3},children:i.map((u,g)=>{const{mimeType:l}=u,I=Y(l,g,i),S=g===r;return t.jsx(Ee,{conversion:u,isDuplicate:I,setFocusMimeTypeTextField:C=>p(C?g:z),shouldAutoFocusMimeTypeTextField:S,onChange:C=>{d(X=>E(X.toSpliced(g,1,...C?[C]:[])))}},"".concat(l,"-").concat(g))})})]}),t.jsx(ae,{children:t.jsxs(T,{direction:"row",sx:{justifyContent:"space-between",width:"100%"},children:[t.jsx(M,{variant:"outlined",onClick:()=>{d(u=>[...u,{mimeType:"",target:"",compressionLevel:null}])},children:s("global.button.add")}),t.jsxs(T,{direction:"row",children:[t.jsx(M,{onClick:b,children:s("global.button.cancel")}),t.jsx(M,{disabled:x||!o,onClick:v,children:s("global.button.ok")})]})]})})]})]})},He=()=>{var v,u,g;const{t:e}=j();we(e("download.title.download"));const a=N.useGetCategories(ie),s=N.useGetServerSettings({notifyOnNetworkStatusChange:!0}),[n]=N.useUpdateServerSettings(),{settings:h,loading:i,request:{error:d,refetch:r}}=re();if(s.loading||i||a.loading)return t.jsx(de,{});const x=(u=(v=s.error)!=null?v:d)!=null?u:a.error;if(x)return t.jsx(xe,{message:e("global.error.label.failed_to_load_data"),messageExtra:k(x),retry:()=>{s.error&&s.refetch().catch(U()),d&&r().catch(U()),a.error&&a.refetch().catch(U())}});const o=s.data.settings,c=(l,I)=>{const S=n({variables:{input:{settings:{[l]:I}}}});return S.catch(C=>O(e("global.error.label.failed_to_save_changes"),"error",k(C))),S},b=he(l=>O(e("global.error.label.failed_to_save_changes"),"error",k(l)));return t.jsxs(D,{sx:{pt:0},children:[t.jsx(ce,{settingName:e("download.settings.download_path.label.title"),dialogDescription:e("download.settings.download_path.label.description"),value:o==null?void 0:o.downloadsPath,settingDescription:o!=null&&o.downloadsPath.length?o.downloadsPath:e("global.label.default"),handleChange:l=>c("downloadsPath",l)}),t.jsxs(w,{children:[t.jsx(m,{primary:e("download.settings.file_type.label.cbz")}),t.jsx(_,{edge:"end",checked:!!(o!=null&&o.downloadAsCbz),onChange:l=>c("downloadAsCbz",l.target.checked)})]}),t.jsx(ke,{conversions:o==null?void 0:o.downloadConversions,updateSetting:l=>c("downloadConversions",l)}),t.jsxs(D,{subheader:t.jsx(P,{component:"div",id:"download-settings-auto-delete-downloads",children:e("download.settings.delete_chapters.title")}),children:[t.jsxs(w,{children:[t.jsx(m,{primary:e("download.settings.delete_chapters.label.manually_marked_as_read")}),t.jsx(_,{edge:"end",checked:h.deleteChaptersManuallyMarkedRead,onChange:l=>b("deleteChaptersManuallyMarkedRead",l.target.checked)})]}),t.jsx(Te,{chapterToDelete:h.deleteChaptersWhileReading,handleChange:l=>b("deleteChaptersWhileReading",l)}),t.jsxs(w,{children:[t.jsx(m,{primary:e("download.settings.delete_chapters.label.allow_deletion_of_bookmarked")}),t.jsx(_,{edge:"end",checked:h.deleteChaptersWithBookmark,onChange:l=>b("deleteChaptersWithBookmark",l.target.checked)})]})]}),t.jsxs(D,{subheader:t.jsx(P,{component:"div",id:"download-settings-auto-download",children:e("download.settings.auto_download.title")}),children:[t.jsxs(w,{children:[t.jsx(m,{primary:e("download.settings.auto_download.label.new_chapters")}),t.jsx(_,{edge:"end",checked:!!(o!=null&&o.autoDownloadNewChapters),onChange:l=>c("autoDownloadNewChapters",l.target.checked)})]}),t.jsx(G,{disabled:!(o!=null&&o.autoDownloadNewChapters),settingTitle:e("download.settings.auto_download.download_limit.label.title"),dialogDescription:e("download.settings.auto_download.download_limit.label.description"),value:(g=o==null?void 0:o.autoDownloadNewChaptersLimit)!=null?g:0,settingValue:o.autoDownloadNewChaptersLimit?e("download.settings.download_ahead.label.value",{chapters:o.autoDownloadNewChaptersLimit,count:o.autoDownloadNewChaptersLimit}):e("global.label.none"),defaultValue:0,minValue:0,maxValue:20,showSlider:!0,valueUnit:e("chapter.title_one"),handleUpdate:l=>c("autoDownloadNewChaptersLimit",l)}),t.jsxs(w,{children:[t.jsx(m,{primary:e("download.settings.auto_download.label.ignore_with_unread_chapters")}),t.jsx(_,{edge:"end",checked:!!(o!=null&&o.excludeEntryWithUnreadChapters),onChange:l=>c("excludeEntryWithUnreadChapters",l.target.checked),disabled:!(o!=null&&o.autoDownloadNewChapters)})]}),t.jsxs(w,{children:[t.jsx(m,{primary:e("download.settings.auto_download.label.ignore_re_uploads")}),t.jsx(_,{edge:"end",checked:!!(o!=null&&o.autoDownloadIgnoreReUploads),onChange:l=>c("autoDownloadIgnoreReUploads",l.target.checked),disabled:!(o!=null&&o.autoDownloadNewChapters)})]}),t.jsx(me,{categories:a.data.categories.nodes,includeField:"includeInDownload",dialogText:e("download.settings.auto_download.categories.label.include_in_download")})]}),t.jsx(D,{subheader:t.jsx(P,{component:"div",id:"download-settings-download-ahead",children:e("download.settings.download_ahead.title")}),children:t.jsx(be,{downloadAheadLimit:h.downloadAheadLimit})})]})};export{He as DownloadSettings};
