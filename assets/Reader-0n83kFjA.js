import{c as r,j as t,B,a as q,af as H,r as ie,i as ce,o as xt,a4 as mt,ag as vt,a2 as be,ah as Ct,ai as wt,aj as He,s as te,I as ee,u as et,e as tt,ak as rt,al as Rt,X as bt,am as yt,g as ae,T as Et,an as Pt,V as Lt,ao as St,Q as qe,ap as Dt,W as jt,x as Ve,N as kt,n as Xe,k as X,Y as Tt,E as _t,aq as Ot}from"./index-CLdSZUX5.js";import{b as K,C as L}from"./Chapters-Bh9Bygal.js";import{P as fe,i as Nt,R as At,u as It,g as Ke,c as $t}from"./ReaderSettingsOptions-Bku2o8f7.js";import{S as Ue}from"./SpinnerImage-M7lFAgJo.js";import{S as Ge}from"./Select-Y_QbyLZd.js";import{C as Wt}from"./Collapse-_DTuXeS2.js";import{a as Ye}from"./TextField-Bjdo3IW5.js";import{u as Mt}from"./useDebounce-Bu2mzT9H.js";import"./NumberSetting-Dj_U6OJQ.js";import"./Info-DXIyrmAz.js";import"./InputAdornment-CtBb24GO.js";import"./Switch-Do54duH_.js";import"./SwitchBase-gUHxC20S.js";const Ft=l=>{for(let a=0;a<l.children.length;a++){const i=l.children.item(a);if(i){const{left:f,right:d}=i.getBoundingClientRect();if(f<=window.innerWidth/2&&d>window.innerWidth/2)return a}}return-1},zt=5,Bt=()=>window.innerWidth+window.scrollX>=document.body.scrollWidth-zt,Ht=()=>window.scrollX<=0;function qt(l){const{pages:a,curPage:i,initialPage:f,settings:d,setCurPage:s,prevChapter:u,nextChapter:x}=l,g=r.useRef(f),p=r.useRef(null),m=r.useRef([]);function S(){var e;i<a.length-1?((e=m.current[i+1])==null||e.scrollIntoView({inline:"center"}),s(n=>n+1)):d.loadNextOnEnding&&x()}function h(){var e;i>0?((e=m.current[i-1])==null||e.scrollIntoView({inline:"center"}),s(i-1)):i===0&&u()}function C(){d.readerType==="ContinuesHorizontalLTR"?h():S()}function D(){d.readerType==="ContinuesHorizontalLTR"?S():h()}const b=r.useRef(0);function c(e){window.scrollBy(b.current-e.pageX,0)}function o(e){var n;b.current=e.pageX,(n=p.current)==null||n.addEventListener("mousemove",c)}function y(){var e;(e=p.current)==null||e.removeEventListener("mousemove",c)}function P(e){e.clientX>=window.innerWidth*.85?D():e.clientX<=window.innerWidth*.15&&C()}const O=()=>{d.readerType==="ContinuesHorizontalLTR"?window.scrollX+window.innerWidth>=document.body.scrollWidth&&x():d.readerType==="ContinuesHorizontalRTL"&&window.scrollX<=window.innerWidth&&x()};return r.useLayoutEffect(()=>{const e=m.current[f];if(!e)return()=>{};const n=new ResizeObserver(()=>{e.offsetHeight&&(e.scrollIntoView({inline:"center"}),n.disconnect())});return n.observe(e),()=>n.disconnect()},[f]),r.useEffect(()=>{var e,n;return(e=p.current)==null||e.addEventListener("mousedown",o),(n=p.current)==null||n.addEventListener("mouseup",y),()=>{var k,N;(k=p.current)==null||k.removeEventListener("mousedown",o),(N=p.current)==null||N.removeEventListener("mouseup",y)}},[p]),r.useEffect(()=>(d.loadNextOnEnding&&document.addEventListener("scroll",O),()=>{document.removeEventListener("scroll",O)}),[p,i,u,x]),r.useEffect(()=>{const e=()=>{if(!p.current)return;const n=Ft(p.current);n!==g.current&&(g.current=n,s(n)),(d.readerType==="ContinuesHorizontalLTR"?Bt():Ht())&&(g.current=a.length-1,s(g.current))};return window.addEventListener("scroll",e),()=>window.removeEventListener("scroll",e)},[d.readerType]),t.jsx(B,{ref:p,sx:{display:"flex",flexDirection:d.readerType==="ContinuesHorizontalLTR"?"row":"row-reverse",justifyContent:d.readerType==="ContinuesHorizontalLTR"?"flex-start":"flex-end",width:"auto",height:"auto",overflowX:"visible",userSelect:"none"},onClick:P,children:a.map(e=>t.jsx(fe,{index:e.index,src:e.src,onImageLoad:()=>{},settings:d,ref:n=>{m.current[e.index]=n}},e.index))})}function Vt(l){const{settings:a,curPage:i,pageCount:f}=l;return t.jsx(B,{sx:{display:a.showPageNumber?"block":"none",position:"fixed",bottom:"50px",padding:"2px",paddingLeft:"4px",paddingRight:"4px",textAlign:"center",backgroundColor:"rgba(0, 0, 0, 0.3)",borderRadius:"10px"},children:"".concat(i+1," / ").concat(f)})}function Xt(l){const{pages:a,settings:i,setCurPage:f,initialPage:d,curPage:s,nextChapter:u,prevChapter:x,chapter:g}=l,p=r.useRef(null);r.useEffect(()=>{const o=a.map(y=>{const P=q.requestImage(y.src);return P.response.catch(()=>{}),P});return()=>{o.forEach(y=>y.abortRequest(new Error("PagedPager::preload: chapter changed")))}},[g.id]);const m=o=>{f(o),window.scroll({top:0})};function S(){s<a.length-1?m(s+1):i.loadNextOnEnding&&u()}function h(){s>0?m(s-1):x()}function C(){i.readerType==="SingleLTR"?h():i.readerType==="SingleRTL"&&S()}function D(){i.readerType==="SingleLTR"?S():i.readerType==="SingleRTL"&&h()}function b(o){switch(o.key){case"Space":o.preventDefault(),S();break;case"ArrowRight":D();break;case"ArrowLeft":C();break}}function c(o){o.clientX>window.innerWidth/2?D():C()}return r.useEffect(()=>(document.addEventListener("keydown",b),()=>{document.removeEventListener("keydown",b)}),[p,s,i.readerType,x,u]),r.useEffect(()=>{setTimeout(()=>{m(d)},0)},[d]),t.jsx(B,{ref:p,sx:{display:"flex",flexDirection:"column",justifyContent:"center",width:"auto",height:"auto"},onClick:c,children:t.jsx(fe,{index:s,onImageLoad:()=>{},src:a[s].src,settings:i},s)})}const Kt=r.forwardRef((l,a)=>{const{image1src:i,image2src:f,index:d,onImageLoad:s,settings:u}=l,x=Nt(u),g={...x,width:u.fitPageToWindow?x.width:"calc(".concat(x.width," * 0.5)"),minWidth:u.fitPageToWindow&&u.scalePage?"calc(".concat(x.minWidth," * 0.5)"):x.minWidth,maxWidth:u.fitPageToWindow?"calc(".concat(x.maxWidth," * 0.5)"):x.maxWidth},p={...g,height:"100vh",width:"50%",backgroundColor:"#525252"};return t.jsxs(B,{ref:a,sx:{display:"flex",flexDirection:u.readerType==="DoubleLTR"?"row":"row-reverse",justifyContent:"center",width:"100%"},children:[t.jsx(Ue,{src:i,onImageLoad:s,alt:"Page #".concat(d),spinnerStyle:p,imgStyle:{...g,objectPosition:u.readerType==="DoubleLTR"?H("right","left"):H("left","right")}}),t.jsx(Ue,{src:f,onImageLoad:s,alt:"Page #".concat(d+1),spinnerStyle:{...p,width:"calc(50% - 5px)",marginLeft:"5px"},imgStyle:{...g,objectPosition:u.readerType==="DoubleLTR"?H("left","right"):H("right","left")}})]})}),Ut=l=>l.height/l.width<1,ye=(l,a,i)=>{if(a[l]||a[l+1]||l===a.length-1)return!0;const f=a.lastIndexOf(!0,l-1),d=l-(f+1);return i?d%2===0:d%2===1};function Gt(l){const{pages:a,settings:i,setCurPage:f,initialPage:d,curPage:s,chapter:u,nextChapter:x,prevChapter:g}=l,p=r.useRef(null),[m,S]=r.useState(Array(a.length).fill(!1)),[h,C]=r.useState(Array(a.length).fill(!1));function D(){let n=1;if(s<a.length&&h[s]&&(n=1,m[s]))return n;if(s+1<a.length&&h[s+1]){if(ye(s,m,i.offsetFirstPage))return n;n=2}return n}function b(){return ye(s-2,m,i.offsetFirstPage)?1:2}function c(){if(s<a.length-1){const n=s+D();f(n>=a.length?a.length-1:n)}else i.loadNextOnEnding&&x()}function o(){if(s>0){const n=s-b();f(n<0?0:n)}else g()}function y(){i.readerType==="DoubleLTR"?o():c()}function P(){i.readerType==="DoubleLTR"?c():o()}function O(n){switch(n.key){case"Space":n.preventDefault(),c();break;case"ArrowRight":P();break;case"ArrowLeft":y();break}}function e(n){n.clientX>window.innerWidth/2?P():y()}return r.useEffect(()=>(document.addEventListener("keydown",O),()=>{document.removeEventListener("keydown",O)}),[p,s,i.readerType,g,x,h,m]),r.useEffect(()=>{f(d)},[d]),r.useEffect(()=>{i.offsetFirstPage?D()===2&&f(s+1):s>0&&!ye(s-1,m,i.offsetFirstPage)&&f(s-1)},[i.offsetFirstPage]),r.useEffect(()=>{const n=a.map(k=>[k.index,q.requestImage(k.src)]);return n.forEach(async([k,N])=>{try{const W=await N.response,z=new Image;z.onload=()=>{URL.revokeObjectURL(W),C(A=>A.toSpliced(k,1,!0)),S(A=>A.toSpliced(k,1,Ut(z)))},z.src=W}catch(W){}}),()=>{n.forEach(([k,N])=>N.abortRequest(new Error("DoublePagedPager::preload(".concat(k,"): chapter changed"))))}},[u.id]),t.jsx(B,{ref:p,onClick:e,children:t.jsx(B,{id:"display",sx:{display:"flex",flexDirection:i.readerType==="DoubleLTR"?"row":"row-reverse",justifyContent:"center",width:"auto",height:"auto"},children:D()===2?t.jsx(Kt,{index:s,image1src:a[s].src,image2src:a[s+1].src,settings:i},s):t.jsx(fe,{index:s,src:a[s].src,onImageLoad:()=>{},settings:i},s)})})}const Yt=l=>{for(let a=0;a<l.children.length;a++){const i=l.children.item(a);if(i){const{top:f,bottom:d}=i.getBoundingClientRect();if(f<=window.innerHeight&&d>1)return a}}return-1},Zt=5,Qt=.95,Ze=.25,Jt="smooth",Qe=()=>window.innerHeight+window.scrollY>=document.body.offsetHeight-Zt,er=()=>window.scrollY<=0;function Je(l){const{pages:a,settings:i,setCurPage:f,initialPage:d,nextChapter:s,prevChapter:u}=l,x=r.useRef(d),g=r.useRef(null),p=r.useRef([]);r.useEffect(()=>{let c=!1;const o=()=>{if(g.current)if(Qe()){if(c)return;c=!0,x.current=a.length-1,f(x.current),i.loadNextOnEnding&&s()}else{c=!1;const y=Yt(g.current);y!==x.current&&(x.current=y,f(y))}};return window.addEventListener("scroll",o),()=>{window.removeEventListener("scroll",o)}},[i.loadNextOnEnding,s]);const m=r.useRef(0),S=r.useRef(!1);function h(c){S.current=!0,window.scrollBy(0,m.current-c.pageY)}function C(c){var o;m.current=c.pageY,(o=g.current)==null||o.addEventListener("mousemove",h)}function D(){var c;(c=g.current)==null||c.removeEventListener("mousemove",h)}r.useEffect(()=>{var c,o;return(c=g.current)==null||c.addEventListener("mousedown",C),(o=g.current)==null||o.addEventListener("mouseup",D),()=>{var y,P;(y=g.current)==null||y.removeEventListener("mousedown",C),(P=g.current)==null||P.removeEventListener("mouseup",D)}},[g]);const b=r.useCallback((c,o=Qt)=>{if(c==="down"&&Qe()){s();return}if(c==="up"&&er()){u();return}window.scroll({top:window.scrollY+window.innerHeight*o*(c==="up"?-1:1),behavior:Jt})},[s,u]);return r.useEffect(()=>{const c=o=>{switch(o.key){case"Space":o.preventDefault(),b(o.shiftKey?"up":"down");break;case"ArrowDown":o.preventDefault(),b(o.shiftKey?"up":"down",Ze);break;case"ArrowRight":o.preventDefault(),b(o.shiftKey?"up":"down");break;case"ArrowUp":o.preventDefault(),b(o.shiftKey?"down":"up",Ze);break;case"ArrowLeft":o.preventDefault(),b(o.shiftKey?"down":"up");break}};return document.addEventListener("keydown",c,!1),()=>{document.removeEventListener("keydown",c)}},[b]),r.useLayoutEffect(()=>{const c=p.current[d];if(!c)return()=>{};const o=new ResizeObserver(()=>{c.offsetHeight&&(c.scrollIntoView(),o.disconnect())});return o.observe(c),()=>o.disconnect()},[d]),t.jsx(B,{ref:g,sx:{display:"flex",flexDirection:"column",justifyContent:"center",width:"auto",height:"auto",userSelect:"none"},onClick:c=>{if(S.current){S.current=!1;return}b(c.clientX>window.innerWidth/2?"down":"up")},children:a.map(c=>t.jsx(fe,{index:c.index,src:c.src,onImageLoad:()=>{},settings:i,ref:o=>{p.current[c.index]=o}},c.index))})}var Ee={},tr=ce;Object.defineProperty(Ee,"__esModule",{value:!0});var nt=Ee.default=void 0,rr=tr(ie()),nr=t;nt=Ee.default=(0,rr.default)((0,nr.jsx)("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Close");var Pe={},ar=ce;Object.defineProperty(Pe,"__esModule",{value:!0});var se=Pe.default=void 0,sr=ar(ie()),or=t;se=Pe.default=(0,sr.default)((0,or.jsx)("path",{d:"M15.41 16.59 10.83 12l4.58-4.59L14 6l-6 6 6 6z"}),"KeyboardArrowLeft");var Le={},ir=ce;Object.defineProperty(Le,"__esModule",{value:!0});var oe=Le.default=void 0,cr=ir(ie()),lr=t;oe=Le.default=(0,cr.default)((0,lr.jsx)("path",{d:"M8.59 16.59 13.17 12 8.59 7.41 10 6l6 6-6 6z"}),"KeyboardArrowRight");var Se={},dr=ce;Object.defineProperty(Se,"__esModule",{value:!0});var at=Se.default=void 0,ur=dr(ie()),pr=t;at=Se.default=(0,ur.default)((0,pr.jsx)("path",{d:"M7.41 8.59 12 13.17l4.59-4.58L18 10l-6 6-6-6z"}),"KeyboardArrowDown");var De={},fr=ce;Object.defineProperty(De,"__esModule",{value:!0});var st=De.default=void 0,gr=fr(ie()),hr=t;st=De.default=(0,gr.default)((0,hr.jsx)("path",{d:"M7.41 15.41 12 10.83l4.59 4.58L18 14l-6-6-6 6z"}),"KeyboardArrowUp");const xr=["addEndListener","appear","children","easing","in","onEnter","onEntered","onEntering","onExit","onExited","onExiting","style","timeout","TransitionComponent"],mr={entering:{transform:"none"},entered:{transform:"none"}},vr=r.forwardRef(function(a,i){const f=xt(),d={enter:f.transitions.duration.enteringScreen,exit:f.transitions.duration.leavingScreen},{addEndListener:s,appear:u=!0,children:x,easing:g,in:p,onEnter:m,onEntered:S,onEntering:h,onExit:C,onExited:D,onExiting:b,style:c,timeout:o=d,TransitionComponent:y=Ct}=a,P=mt(a,xr),O=r.useRef(null),e=vt(O,x.ref,i),n=w=>T=>{if(w){const _=O.current;T===void 0?w(_):w(_,T)}},k=n(h),N=n((w,T)=>{wt(w);const _=He({style:c,timeout:o,easing:g},{mode:"enter"});w.style.webkitTransition=f.transitions.create("transform",_),w.style.transition=f.transitions.create("transform",_),m&&m(w,T)}),W=n(S),z=n(b),A=n(w=>{const T=He({style:c,timeout:o,easing:g},{mode:"exit"});w.style.webkitTransition=f.transitions.create("transform",T),w.style.transition=f.transitions.create("transform",T),C&&C(w)}),re=n(D),I=w=>{s&&s(O.current,w)};return t.jsx(y,be({appear:u,in:p,nodeRef:O,onEnter:N,onEntered:W,onEntering:k,onExit:A,onExited:re,onExiting:z,addEndListener:I,timeout:o},P,{children:(w,T)=>r.cloneElement(x,be({style:be({transform:"scale(0)",visibility:w==="exited"&&!p?"hidden":void 0},mr[w],c,x.props.style),ref:e},T))}))}),Cr=vr,wr=te("div")({zIndex:10}),Rr=te("div")(({theme:l})=>({top:0,left:0,width:"300px",minWidth:"300px",height:"100vh",overflowY:"auto",backgroundColor:l.palette.background.default,"& header":{backgroundColor:l.palette.action.hover,display:"flex",alignItems:"center",minHeight:"64px",paddingLeft:"24px",paddingRight:"24px",transition:"left 2s ease","& button":{flexGrow:0,flexShrink:0},"& button:nth-child(1)":{marginRight:"16px"},"& h1":{fontSize:"1.25rem",flexGrow:1}}})),br=te("div")({margin:"0 16px","& > span:nth-child(1)":{textAlign:"center",display:"block",marginTop:"16px"}}),yr=te("div")({display:"flex",flexWrap:"wrap",alignContent:"center",alignItems:"center",justifyContent:"center"}),Er=te("div")({display:"grid",gridTemplateRows:"auto auto auto",gridTemplateColumns:"0fr 1fr 0fr",gridTemplateAreas:'"pre current next"',gridColumnGap:"5px",margin:"10px 0","& a":{textDecoration:"none",color:"inherit",display:"flex",flexWrap:"wrap",alignContent:"center"}}),Pr=te(ee)(({theme:l})=>({position:"fixed",top:20,left:30,height:"40px",width:"40px",borderRadius:5,backgroundColor:l.palette.custom.main,"&:hover":{backgroundColor:l.palette.custom.light}}));function Lr(l){var U;const{t:a}=et(),i=tt(),f=rt(),{prevDrawerOpen:d,prevSettingsCollapseOpen:s}=(U=f.state)!=null?U:{},{settings:u,setSettingValue:x,manga:g,chapter:p,chapters:m,curPage:S,scrollToPage:h,openNextChapter:C,retrievingNextChapter:D,hasDuplicatedChapters:b}=l,c=Rt();bt("/manga/".concat(g.id));const o=r.useMemo(()=>!!new Set(m.map(({scanlator:R})=>R)).size,[m]),y=!b&&o,[P,O]=r.useState(u.staticNav||d),[e,n]=r.useState(!0),[k,N]=r.useState(u.staticNav||d),[W,z]=r.useState(0),[A,re]=r.useState(s!=null?s:!0),I=D,w=(R,$,G)=>{n(R!=="staticNav"),x(R,$,G)},T=R=>{O(R),N(R)},_=()=>{const R=window.pageYOffset;Math.abs(R-W)>20&&(N(R>W),z(R))};return r.useEffect(()=>{e&&T(u.staticNav)},[u.staticNav]),r.useEffect(()=>{window.addEventListener("scroll",_);const R=document.querySelector("#root"),$=document.querySelector("#appMainContainer");return R.style.display="flex",R.style.flexDirection="column",$.style.display="none",()=>{R.style.display="block",$.style.display="block",window.removeEventListener("scroll",_)}},[_]),t.jsxs(wr,{children:[t.jsx(yt,{direction:H("right","left"),in:P,timeout:200,appear:!1,mountOnEnter:!0,unmountOnExit:!0,children:t.jsxs(Rr,{sx:{position:"fixed"},children:[t.jsxs("header",{children:[!u.staticNav&&t.jsx(ae,{title:a("reader.button.close_menu"),children:t.jsx(ee,{edge:"start",color:"inherit","aria-label":"menu",disableRipple:!0,onClick:()=>T(!1),size:"large",children:H(t.jsx(se,{}),t.jsx(oe,{}))})}),t.jsx(Et,{variant:"h1",textOverflow:"ellipsis",overflow:"hidden",sx:{py:1},children:p.name}),t.jsx(ae,{title:a("reader.button.exit"),children:t.jsx(ee,{edge:"start",color:"inherit","aria-label":"menu",disableRipple:!0,onClick:c,size:"large",sx:{mr:-1},children:t.jsx(nt,{})})})]}),t.jsxs(Pt,{ContainerComponent:"div",sx:{"& span":{fontWeight:"bold"}},children:[t.jsx(Lt,{primary:a("reader.settings.title.reader_settings")}),t.jsxs(ee,{edge:"start",color:"inherit","aria-label":"menu",disableRipple:!0,disableFocusRipple:!0,onClick:()=>re(!A),size:"large",children:[A&&t.jsx(st,{}),!A&&t.jsx(at,{})]})]}),t.jsx(Wt,{in:A,timeout:"auto",unmountOnExit:!0,children:t.jsx(At,{setSettingValue:w,staticNav:u.staticNav,showPageNumber:u.showPageNumber,loadNextOnEnding:u.loadNextOnEnding,skipDupChapters:u.skipDupChapters,fitPageToWindow:u.fitPageToWindow,scalePage:u.scalePage,readerType:u.readerType,offsetFirstPage:u.offsetFirstPage,readerWidth:u.readerWidth})}),t.jsx(St,{sx:{my:1,mx:2}}),t.jsxs(br,{children:[t.jsxs(yr,{children:[t.jsx("span",{children:a("reader.page_info.label.currently_on_page")}),t.jsx(Ye,{size:"small",sx:{margin:"0 5px"},disabled:I||p.pageCount===-1,children:t.jsx(Ge,{value:p.pageCount>-1?"".concat(S):"",displayEmpty:!0,onChange:({target:{value:R}})=>{h(Number(R))},children:Array(Math.max(0,p.pageCount)).fill(1).map((R,$)=>t.jsx(qe,{value:$,children:$+1},"Page#".concat($)))})}),t.jsx("span",{children:a("reader.page_info.label.of_max_pages",{maxPages:p.pageCount})})]}),t.jsxs(Er,{children:[t.jsx(ae,{title:a("reader.button.previous_chapter"),children:t.jsx(ee,{sx:{gridArea:"pre"},disabled:I||p.sourceOrder<=1,onClick:()=>C(K.PREV),children:H(t.jsx(se,{}),t.jsx(oe,{}))})}),t.jsx(Ye,{sx:{gridArea:"current"},size:"small",disabled:I||p.sourceOrder<1,children:t.jsx(Ge,{value:p.sourceOrder>=1?"".concat(p.sourceOrder):"",displayEmpty:!0,onChange:({target:{value:R}})=>{i("/manga/".concat(g.id,"/chapter/").concat(R),{replace:!0,state:{prevDrawerOpen:P,prevSettingsCollapseOpen:A}})},children:m.map(({id:R,sourceOrder:$,name:G,chapterNumber:le,scanlator:ne})=>t.jsx(qe,{value:$,children:"#".concat(le).concat(y&&ne!=null?" (".concat(ne,")"):""," | ").concat(G)},R))})}),t.jsx(ae,{title:a("reader.button.next_chapter"),children:t.jsx(ee,{sx:{gridArea:"next"},disabled:I||p.sourceOrder<1||p.sourceOrder>=g.chapters.totalCount,onClick:()=>C(K.NEXT),children:H(t.jsx(oe,{}),t.jsx(se,{}))})})]})]})]})}),t.jsx(Cr,{in:!P,children:t.jsx(Dt,{in:!k,children:t.jsx(ae,{title:a("reader.button.open_menu"),children:t.jsx(Pr,{edge:"start","aria-label":"menu",disableRipple:!0,disableFocusRipple:!0,onClick:()=>T(!0),size:"large",children:H(t.jsx(oe,{}),t.jsx(se,{}))})})})})]})}const Sr=l=>{switch(l){case"ContinuesVertical":case"Webtoon":return Je;case"SingleVertical":case"SingleRTL":case"SingleLTR":return Xt;case"DoubleVertical":case"DoubleRTL":case"DoubleLTR":return Gt;case"ContinuesHorizontalLTR":case"ContinuesHorizontalRTL":return qt;default:return Je}},Dr=l=>Array.from({length:l},(a,i)=>i),J={pageCount:-1,sourceOrder:-1,chapterCount:0,lastPageRead:0,name:"Loading...",manga:{id:-1}};function Hr(){var Ne,Ae,Ie,$e,We,Me,Fe,ze;const{t:l}=et(),a=tt(),i=rt(),{chapterIndex:f,mangaId:d}=jt(),s=r.useMemo(()=>({id:+d,title:"",thumbnailUrl:"",genre:[],inLibraryAt:0,lastReadAt:0,chapters:{totalCount:0},trackRecords:{totalCount:0}}),[d]),{data:u,loading:x,error:g,refetch:p}=q.useGetManga(d),m=r.useRef(null),S=Number(d)===((Ne=m.current)==null?void 0:Ne.manga.id)&&Number(f)===((Ae=m.current)==null?void 0:Ae.sourceOrder)&&((Ie=m.current)==null?void 0:Ie.pageCount)!==-1,h=($e=u==null?void 0:u.manga)!=null?$e:s,{data:C,loading:D,error:b,refetch:c}=q.useGetMangaChapter(d,f,{notifyOnNetworkStatusChange:!0}),o=r.useRef(!1),{settings:{downloadAheadLimit:y}}=Ve(),P=!!y,O=()=>{var F;return m.current&&S?(C==null?void 0:C.chapter)&&((F=m.current)==null?void 0:F.pageCount)!==C.chapter.pageCount?C.chapter:m.current:(o.current=!1,C!=null&&C.chapter?C.chapter:null)};m.current=O();const e=(We=m.current)!=null?We:J,n=r.useRef(J);n.current===J&&(n.current=e),e.manga.id!==((Me=n.current)==null?void 0:Me.manga.id)&&(n.current=J);const[k,{loading:N,error:W}]=q.useGetChapterPagesFetch(e.id),z=()=>{!D&&!e.isDownloaded?k().then(()=>{o.current=!0}).catch(X()):o.current=!0};r.useEffect(()=>{z()},[e.id]);const[A,re]=r.useState(!1),[I,w]=r.useState(0),T=I===e.pageCount-1,_=Mt(I,T?0:1e3),[U,R]=r.useState(void 0),{setOverride:$,setTitle:G}=r.useContext(kt),[le,ne]=r.useState(!1),{data:ge,loading:ot,error:je,refetch:it}=q.useGetMangaChapters(d,{nextFetchPolicy:"standby"}),v=ge==null?void 0:ge.chapters.nodes,he=x||D||ot||N||!o.current&&!b&&!W,ke=(ze=(Fe=g!=null?g:b)!=null?Fe:je)!=null?ze:W,{settings:xe,loading:Te}=It(),[E,_e]=r.useState(Ke(h,xe)),{settings:de}=Ve(),me=r.useMemo(()=>E.skipDupChapters?L.removeDuplicates(n.current,v!=null?v:[]):v!=null?v:[],[n.current,v,E.skipDupChapters]),ct=r.useMemo(()=>L.getNextChapters(e,v!=null?v:[],{offset:K.PREV,skipDupe:E.skipDupChapters,skipDupeChapter:n.current}),[e,n.current,v,E.skipDupChapters]),lt=r.useMemo(()=>L.getNextChapters(e,v!=null?v:[],{skipDupe:E.skipDupChapters,skipDupeChapter:n.current}),[e,n.current,v,E.skipDupChapters]),ue=r.useMemo(()=>L.getNextChapter(e,v!=null?v:[],{offset:K.PREV,skipDupe:E.skipDupChapters,skipDupeChapter:n.current}),[e,n.current,v,E.skipDupChapters]),Y=r.useMemo(()=>L.getNextChapter(e,v!=null?v:[],{skipDupe:E.skipDupChapters,skipDupeChapter:n.current}),[e,n.current,v,E.skipDupChapters]),Oe=j=>{if(e===J)return;const M=()=>{if(!(!!j.isRead&&!!de.deleteChaptersWhileReading)||!v)return[];const Q=[e,...ct][de.deleteChaptersWhileReading-1];if(!Q)return[];const Ce=L.getFromCache(Q.id);return Ce.isRead&&L.isDeletable(Ce,de.deleteChaptersWithBookmark)?E.skipDupChapters?L.getIds(L.addDuplicates([Q],v)):L.getIds([Q]):[]};(()=>{var we;const pe=L.getFromCache(e.id),Q=((we=j.lastPageRead)!=null?we:0)/e.pageCount>.25;if(P&&e.manga.inLibrary&&!!(pe!=null&&pe.isDownloaded)&&Q){const Re=Y?L.getFromCache(Y.id):null;if(!(Re!=null&&Re.isDownloaded))return;const Be=L.getNonRead(lt).map(V=>L.getFromCache(V.id)).slice(-y).filter(V=>!V.isDownloaded).map(V=>V.id).filter(V=>!L.isDownloading(V));if(!Be.length)return;L.download(Be).catch(X())}})();const ve=E.skipDupChapters?L.getIds(L.addDuplicates([e],v!=null?v:[e])):[e.id];q.updateChapters(ve,{...j,chapterIdsToDelete:M(),trackProgressMangaId:de.updateProgressAfterReading&&j.isRead&&h.trackRecords.totalCount?h.id:void 0}).response.catch(X())},dt=(j,M,F=!0)=>{_e({...E,[j]:M}),F&&Ot(h,[[j,M]]).catch(()=>Xe(l("reader.settings.error.label.failed_to_save_settings"),"warning"))},Z=r.useCallback(j=>{const M=j===K.NEXT,F=M?Y:ue;if(!F){Xe(l(M?"reader.error.label.next_chapter_does_not_exist":"reader.error.label.prev_chapter_does_not_exist"),"error");return}ne(!0),w(0),a("/manga/".concat(h.id,"/chapter/").concat(F.sourceOrder),{replace:!0,state:i.state}),ne(!1)},[h.id,ue==null?void 0:ue.id,Y==null?void 0:Y.id]);r.useEffect(()=>{if(he||!e){w(0);return}re(!0),e.lastPageRead===e.pageCount-1?w(0):w(e.lastPageRead)},[e,he]),r.useEffect(()=>{!(h!=null&&h.title)||e.name===l("global.label.loading")?G(l("reader.title")):G("".concat(h.title,": ").concat(e.name))},[l,h,e]),r.useEffect(()=>{!Te&&!x&&($t(h,"manga",xe).catch(X()),_e(Ke(h,xe)))},[Te,x]),r.useEffect(()=>($({status:!0,value:t.jsx(Lr,{settings:E,setSettingValue:dt,manga:h,chapter:e,chapters:me,curPage:I,scrollToPage:R,openNextChapter:Z,retrievingNextChapter:le,hasDuplicatedChapters:E.skipDupChapters&&(v==null?void 0:v.length)!==me.length})}),()=>$({status:!1,value:t.jsx("div",{})})),[h,e,E,I,f,le,Z,me]),r.useEffect(()=>{if(!A||e===J)return;const j=L.getFromCache(e.id);if(_===(j==null?void 0:j.lastPageRead))return;const M=_!==-1,F=_===e.pageCount-1;(M||F)&&Oe({lastPageRead:M?_:void 0,isRead:F?!0:void 0})},[_,P]);const ut=r.useCallback(()=>{Oe({lastPageRead:e.pageCount-1,isRead:!0}),Z(K.NEXT)},[e.pageCount,Z,e,h]),pt=r.useCallback(()=>{Z(K.PREV)},[Z]);if(he)return t.jsx(B,{sx:{height:"100vh",width:"100vw",display:"grid",placeItems:"center"},children:t.jsx(Tt,{thickness:5})});if(ke)return t.jsx(_t,{message:l("global.error.label.failed_to_load_data"),messageExtra:ke.message,retry:()=>{g&&p().catch(X()),b&&c().catch(X()),je&&it().catch(X()),W&&z()}});const ft=Dr(e.pageCount).map(j=>({index:j,src:q.getChapterPageUrl(d,f,j)})),gt=Sr(E.readerType),ht=U!=null?U:e.lastPageRead===e.pageCount-1?0:e.lastPageRead;return t.jsxs(B,{sx:{display:"flex",flexDirection:"column",alignContent:"center",alignItems:"center",justifyContent:"center",minWidth:E.staticNav?"calc((100vw - (100vw - 100%)) - 300px)":"calc(100vw - (100vw - 100%))",minHeight:"100vh",marginLeft:E.staticNav?"300px":"unset"},children:[t.jsx(Vt,{settings:E,curPage:I,pageCount:e.pageCount}),t.jsx(B,{sx:{alignSelf:"stretch"},children:t.jsx(gt,{pages:ft,pageCount:e.pageCount,setCurPage:w,initialPage:ht,curPage:I,settings:E,manga:h,chapter:e,nextChapter:ut,prevChapter:pt},e.id)})]})}export{Hr as Reader};
