import{ap as fe,aq as Se,j as e,c as Be,am as F,T as je,ar as He,as as Ce,at as ye,au as Ve,H as T,av as ve,v as be,aw as Ee,b as V,f as S,ax as qe,ay as ze,az as k,aA as Ke,u as Fe,B as R,aB as We,C as H,I as ee,aC as Je,o as Qe,aD as Ye,p as Xe,q as Ze,aE as et,w as tt,aF as st,k as te,J as at,aG as rt,aH as nt,h as ot,ah as he,e as it,y as ct,ai as B,r as P,aI as lt,a as dt,E as xe,d as ut,aJ as pt,x as mt,A as ht,ac as xt,_ as se,aK as gt,g as ge,z as ft,S as St,aL as jt,m as Ct}from"./index-BQW0TzWK.js";import{I as yt,F as vt}from"./IconWebView-DRtMMair.js";import{F as Le}from"./FilterList-B7TwfGsR.js";import{G as bt}from"./GridLayouts-Da6vSoo8.js";import{S as Et,A as Ft}from"./AppbarSearch-zdh0bsfa.js";import{D as Lt}from"./Delete-B2Kc8dY0.js";import{S as It,O as _t}from"./SortRadioInput-BQjsMMXU.js";import{C as Tt}from"./CheckboxInput-DOoskXsZ.js";import{E as Ie,a as _e}from"./ExpandMore-BE_EwE4X.js";import{u as kt}from"./useDebounce-DozzNR-m.js";import{T as Pt}from"./ThreeStateCheckboxInput-CimdqLW4.js";import{S as At}from"./StyledFab-B_XszLvR.js";import{C as wt}from"./Chip-Cv29V1T6.js";import{B as Mt}from"./BaseMangaGrid-CV9DUdi6.js";import{M as Rt}from"./MangaGrid-oCqZloUI.js";import{E as Ot}from"./EmptyViewAbsoluteCentered-Dk3QeqWD.js";import{u as $t}from"./useAppTitleAndAction-HujxXgPd.js";import{V as Ut}from"./Virtuoso.util-BDze1weF.js";import{L as Dt}from"./Link--9PPHFoo.js";import"./Checkbox-uX-PoMED.js";import"./SwitchBase-BOPh2Mpu.js";import"./ListPreference-upGzBxRb.js";import"./FormGroup-C9DxpIIA.js";import"./ContinueReadingTooltip-gTRVauCN.js";import"./Trackers-BQ19KlF0.js";import"./AvatarSpinner-k9g67RlI.js";import"./SpinnerImage-D3d2hGHy.js";import"./Refresh-NwQ0ej0q.js";import"./Image-3Cz5YOS1.js";import"./Card-CNPclRqF.js";import"./ListCardContent-Z0HLyAR8.js";import"./CheckCircle-C2LCpjXm.js";import"./Metadata-DMEU2MYt.js";import"./Mangas-Bfum19Tf.js";import"./Chapters-SFxc1uEP.js";import"./DateHelper-D9GZv1H6.js";import"./Asserts-xItX73wb.js";import"./MUI.util-CEodEA2f.js";import"./CardActionArea-CHpA8MjR.js";import"./useManageMangaLibraryState-C-whaC9r.js";import"./NumberSetting-C7MoIRFk.js";import"./Slider-DsZpeDts.js";import"./useMobilePicker-DQEOweiD.js";import"./SelectSetting-S0YmXF8X.js";import"./Select-BNsIqvjs.js";import"./Download-DP47XE-U.js";import"./Sync-CYo6XpqE.js";import"./use-merged-ref-fU8eyfMF.js";import"./ListCardAvatar-US-QVOiW.js";import"./PlayArrow-CEIi_Djh.js";import"./index-BV07AeYI.js";import"./useAppTitle-HbysqsGA.js";import"./useAppAction-fGk5pTiP.js";function Gt(){const[t,n]=fe("source-grid-layout",Se.Compact);return e.jsx(bt,{gridLayout:t,onChange:n})}const Nt=Be(e.jsx("path",{d:"M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3m3-10H5V5h10z"})),Bt=t=>{const{state:n,name:c,position:a,group:s,updateFilterValue:d,update:r}=t,[u,l]=F.useState(n),x=m=>{l(m.target.checked);const p=r.filter(g=>!(a===g.position&&s===g.group));d([...p,{type:"checkBoxState",position:a,state:m.target.checked,group:s}])};return n!==void 0?e.jsx(Tt,{label:c,checked:u,onChange:x}):null},Ht=({name:t})=>e.jsx(je,{sx:{mt:2},variant:"subtitle2",children:t},t);function Vt(t,n,c,a,s,d,r){const[u,l]=F.useState(c);if(t){const x=p=>{const g=t.indexOf("".concat(p.target.value));l(g);const j=d.filter(o=>!(a===o.position&&r===o.group));s([...j,{type:"selectState",position:a,state:g,group:r}])},m=t.map(p=>e.jsx(He,{value:p,children:p},"".concat(n," ").concat(p)));return e.jsxs(Ce,{sx:{my:1},variant:"standard",children:[e.jsx(ye,{children:n}),e.jsx(Ve,{name:n,value:t[u],label:n,onChange:x,children:m})]})}return null}const qt=({values:t,name:n,state:c,position:a,updateFilterValue:s,update:d,group:r})=>Vt(t,n,c,a,s,d,r),zt=t=>{const{values:n,name:c,state:a,position:s,group:d,updateFilterValue:r,update:u}=t,[l,x]=F.useState(a),[m,p]=F.useState(!1),g=()=>{p(!m)};if(n){const j=o=>{const h=l;h.index===o?h.ascending=!h.ascending:h.ascending=!0,h.index=o,x(h);const b=u.filter(y=>!(s===y.position&&d===y.group));r([...b,{type:"sortState",position:s,state:h,group:d}])};return e.jsxs(T,{sx:{mx:-2},children:[e.jsxs(ve,{onClick:g,children:[e.jsx(be,{primary:c}),m?e.jsx(Ie,{}):e.jsx(_e,{})]}),e.jsx(Ee,{in:m,children:e.jsx(V,{sx:{mx:4},children:n.map((o,h)=>e.jsx(It,{label:o,checked:l.index===h,sortDescending:!l.ascending,onClick:()=>j(h)},"".concat(c," ").concat(o)))})})]})}return null},Kt=t=>{const{state:n,name:c,position:a,group:s,updateFilterValue:d,update:r}=t,[u,l]=F.useState(n||""),x=kt(u,500);return S.useEffect(()=>{const m=r.filter(p=>!(a===p.position&&s===p.group));d([...m,{type:"textState",position:a,state:x,group:s}])},[x]),n!==void 0?e.jsxs(Ce,{sx:{my:1},variant:"standard",children:[e.jsx(ye,{children:c}),e.jsx(qe,{name:c,value:u,onChange:({target:{value:m}})=>l(m),endAdornment:e.jsx(ze,{position:"end",children:e.jsx(Et,{})})})]}):null},Wt=t=>{switch(t){case k.Ignore:return 0;case k.Include:return 1;case k.Exclude:return 2;default:throw new Error("Unexpected TriState ".concat(t))}},Jt=t=>{switch(t){case 0:return k.Ignore;case 1:return k.Include;case 2:return k.Exclude;default:throw new Error("Unexpected state number ".concat(t))}},Qt=t=>{const{state:n,name:c,position:a,group:s,updateFilterValue:d,update:r}=t,[u,l]=F.useState(Wt(n)),x=m=>{const p=m===void 0?0:m?1:2;l(p);const g=r.filter(j=>!(a===j.position&&s===j.group));d([...g,{type:"triState",position:a,state:Jt(p),group:s}])};return n!==void 0?e.jsx(Pt,{label:c,checked:[void 0,!0,!1][u],onChange:m=>x(m)}):null},Yt=t=>{const{state:n,name:c,position:a,updateFilterValue:s,update:d}=t,[r,u]=F.useState(!1);return e.jsxs(T,{sx:{mx:-2},children:[e.jsxs(ve,{onClick:()=>u(!r),children:[e.jsx(be,{primary:c}),r?e.jsx(Ie,{}):e.jsx(_e,{})]}),e.jsx(Ee,{in:r,children:e.jsx(V,{sx:{mx:4},children:e.jsx(Te,{sourceFilter:n,group:a,updateFilterValue:s,update:d})})})]})},Xt=({name:t})=>e.jsx(Ke,{sx:{my:1},textAlign:"center",children:t},t);function Te({sourceFilter:t,group:n,updateFilterValue:c,update:a}){return e.jsx(V,{children:t.map((s,d)=>{var u,l;let r=a.find(x=>x.group===n&&x.position===d);switch(r=r&&r.state,s.type){case"CheckBoxFilter":return e.jsx(Bt,{name:s.name,state:r!=null?r:s.CheckBoxFilterDefault,position:d,group:n,updateFilterValue:c,update:a},"filters ".concat(s.name));case"GroupFilter":return e.jsx(Yt,{name:s.name,state:s.filters,position:d,updateFilterValue:c,update:a},"filters ".concat(s.name));case"HeaderFilter":return e.jsx(Ht,{name:s.name},"filters ".concat(s.name));case"SelectFilter":return e.jsx(qt,{name:s.name,values:s.values,state:r!=null?parseInt(r,10):s.SelectFilterDefault,position:d,group:n,updateFilterValue:c,update:a},"filters ".concat(s.name));case"SeparatorFilter":return e.jsx(Xt,{name:s.name},"filters ".concat(s.name));case"SortFilter":return e.jsx(zt,{name:s.name,values:s.values,state:r!=null?r:{ascending:(u=s.SortFilterDefault)==null?void 0:u.ascending,index:(l=s.SortFilterDefault)==null?void 0:l.index},position:d,group:n,updateFilterValue:c,update:a},"filters ".concat(s.name));case"TextFilter":return e.jsx(Kt,{name:s.name,state:r!=null?r:s.TextFilterDefault,position:d,group:n,updateFilterValue:c,update:a},"filters ".concat(s.name));case"TriStateFilter":return e.jsx(Qt,{name:s.name,state:r!=null?r:s.TriStateFilterDefault,position:d,group:n,updateFilterValue:c,update:a},"filters ".concat(s.name));default:throw new Error('Unknown source filter "'.concat(s,'"'))}})},"filters ".concat(n))}function Zt({savedSearches:t={},selectSavedSearch:n,updateSavedSearches:c,sourceFilter:a,updateFilterValue:s,resetFilterValue:d,setTriggerUpdate:r,update:u}){const{i18n:l,_:x}=Fe(),[m,p]=S.useState(!1),[g,j]=S.useState(""),o=Object.keys(t),h=!!o.length;function b(){d(0),p(!1)}function y(){r(0),p(!1)}return e.jsxs(e.Fragment,{children:[e.jsxs(At,{onClick:()=>p(!m),variant:"extended",color:"primary",children:[e.jsx(Le,{}),l._({id:"o7J4JM"})]}),e.jsxs(_t,{open:m,onClose:()=>p(!1),children:[e.jsxs(T,{sx:{p:2,pb:h?void 0:0},children:[e.jsxs(T,{sx:{display:"flex",pb:1},children:[e.jsx(R,{onClick:b,children:l._({id:"OfhWJH"})}),e.jsx(We,{variant:"dialog",popupId:"source-browse-save-search",children:C=>e.jsxs(e.Fragment,{children:[e.jsx(H,{title:l._({id:"koG8+T"}),children:e.jsx(ee,{sx:{marginLeft:"auto"},...Je(C),children:e.jsx(Nt,{})})}),e.jsxs(Qe,{...Ye(C),maxWidth:"xs",fullWidth:!0,children:[e.jsx(Xe,{children:l._({id:"MK3iRa"})}),e.jsx(Ze,{children:e.jsx(et,{sx:{width:"100%"},value:g,onChange:E=>j(E.target.value),slotProps:{htmlInput:{maxLength:50}}})}),e.jsxs(tt,{children:[e.jsx(R,{onClick:()=>{j(""),C.close()},children:l._({id:"dEgA5A"})}),e.jsx(R,{onClick:()=>{c(g,"create"),j(""),C.close()},children:l._({id:"aP3N/0"})})]})]})]})}),e.jsx(R,{variant:"contained",onClick:y,children:l._({id:"hQRttt"})})]}),h&&e.jsxs(e.Fragment,{children:[e.jsx(je,{sx:{pb:1},children:"Saved searches"}),e.jsx(V,{sx:{flexDirection:"row"},children:o.map(C=>e.jsx(wt,{label:C,onClick:()=>{p(!1),n(C)},onDelete:()=>{st.show({title:l._({id:"6foA8n"}),message:l._({id:"QWekyf",values:{savedSearch:C}}),actions:{confirm:{title:l._({id:"cnGeoo"})}}}).then(()=>c(C,"delete")).catch(te("SourceOptions::deleteSavedSearch"))},deleteIcon:e.jsx(H,{title:l._({id:"cnVy+N"}),children:e.jsx(Lt,{})}),variant:"outlined"}))})]})]}),e.jsx(T,{sx:{pb:2,mx:2},children:e.jsx(Te,{sourceFilter:a,updateFilterValue:s,group:void 0,update:u})})]})]})}const es={id:"-1"},ts=se("div")(({theme:t})=>({display:"flex",position:"sticky",width:"100%",zIndex:1,padding:t.spacing(1),gap:t.spacing(1),backgroundColor:t.palette.background.default})),Z=se(R)(()=>({})),ss=se(T)(()=>({minHeight:"100%",position:"relative"}));var ca=function(t){return t[t.POPULAR=0]="POPULAR",t[t.LATEST=1]="LATEST",t[t.SEARCH=2]="SEARCH",t}({});const as={0:{id:"RbPhRX"},1:{id:"RbPhRX"},2:{id:"X0ERkx"}},rs=t=>{const n={},c=[];return t.forEach(a=>{!!n[a.id]||(n[a.id]=a,c.push(a))}),c},ns=(t,n,c,a,s,d)=>{var j;let r;switch(n){case 0:r=P.useGetSourcePopularMangas(t,s);break;case 1:r=P.useGetSourceLatestMangas(t,s);break;case 2:r=P.useSourceSearch(t,c!=null?c:"",a.map(o=>{const{position:h,state:b,group:y}=o;return y!==void 0?{position:y,groupChange:{position:h,[o.type]:b}}:{position:h,[o.type]:b}}),s);break;default:throw new Error('Unknown ContentType "'.concat(n,'"'))}const u=r[1],l=u.findLastIndex(o=>{var h;return!!((h=o.data)!=null&&h.fetchSourceManga)}),x=u[l],m=u.slice(-1)[0].isLoading;let p=!m;const g=S.useMemo(()=>{let o=[];return u.forEach((h,b)=>{var $,A,v;const y=(v=(A=($=h.data)==null?void 0:$.fetchSourceManga)==null?void 0:A.mangas)!=null?v:[],C=y.filter(q=>!d||!q.inLibrary),E=rs([...o,...C]);p=!m&&u.length===b+1&&!C.length&&!!y.length,o=E}),o},[u,d]);return l===-1?[r[0],{...r[1][r[1].length-1],filteredOutAllItemsOfFetchedPage:p}]:[r[0],{...u[u.length-1],data:{...x.data,fetchSourceManga:{...x.data.fetchSourceManga,hasNextPage:u.length>l+1?!1:!!((j=x.data.fetchSourceManga)!=null&&j.hasNextPage),mangas:g}},filteredOutAllItemsOfFetchedPage:p}]};function la(){var ie,ce,le,de,ue,pe;const{i18n:t,_:n}=Fe(),{appBarHeight:c}=at(),{sourceId:a}=rt(),[s,d]=nt(),r=ot(),u=he(),{key:l,state:x}=u,{contentType:m=0,clearCache:p=!1}=(ie=he().state)!=null?ie:{},{settings:{hideLibraryEntries:g}}=it(),[j]=fe("source-grid-layout",Se.Compact),[o]=ct(xe.QUERY,ft),[h,b]=B("source-mangas-".concat(a,"-filters"),[]),[y,C]=B("source-mangas-location-".concat(l,"-").concat(a,"-filters"),h!=null?h:[]),[E,O]=S.useState(y),[$,A]=B("source-mangas-".concat(a,"-content-type"),m),[v,q]=B("source-mangas-location-".concat(l,"-").concat(a,"-content-type"),o?2:$),{key:ke,deleteState:Pe}=Ut.usePersistState(Rt),U=S.useCallback(()=>{Pe(),window.scrollTo(0,0)},[ke]),ae=S.useRef(o),re=S.useRef(()=>{});ae.current!==o&&v===2&&(ae.current=o,re.current(new Error("SourceMangas(".concat(a,"): search string changed"))),U()),S.useEffect(()=>()=>{b(void 0),A(void 0)},[a]);const z=f=>{b(f),C(f),U()},ne=f=>{A(f),q(f)},Ae="".concat(v).concat(JSON.stringify(y)).concat(o),[K,{data:L,error:D,isLoading:W,size:G,abortRequest:we,filteredOutAllItemsOfFetchedPage:J}]=ns(a,v,o,y,1,g);re.current=we;const Q=(le=(ce=L==null?void 0:L.fetchSourceManga)==null?void 0:ce.mangas)!=null?le:[],w=!!((de=L==null?void 0:L.fetchSourceManga)!=null&&de.hasNextPage),Y=W||J&&w,{data:X}=P.useGetSource(lt,a),i=X==null?void 0:X.source,Me=(ue=i==null?void 0:i.filters)!=null?ue:[],{savedSearches:I={}}=dt(i!=null?i:es),oe=ut(i!=null?i:{id:"-1"},f=>Ct(t._({id:"cBoXe4"}),"error",ge(f))),Re=S.useCallback(f=>{const{query:_,filters:M}=I[f];M&&(O(M),z(M)),_&&(s.set(xe.QUERY,_),d(s))},[I,x]),Oe=S.useCallback((f,_)=>{if(_==="delete"){const me={...I};delete me[f],oe("savedSearches",me);return}const M={...I,[f]:{query:o!=null?o:void 0,filters:E}};oe("savedSearches",M)},[I,o,E]),$e=Y?void 0:t._(as[v]),Ue=a===St.LOCAL_SOURCE_ID?e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:[t._({id:"6uFFoY"})," "]}),e.jsx(Dt,{href:"https://github.com/Suwayomi/Suwayomi-Server/wiki/Local-Source",target:"_blank",rel:"noreferrer",children:t._({id:"kFYEcz"})})]}):void 0,N=S.useCallback((f,_)=>{ne(f),U(),o&&!_&&r({pathname:""},{state:{...x,contentType:f}})},[ne,o,U]);!!o&&v!==2&&N(2,o);const De=S.useCallback(()=>{w&&K(G+1)},[G,w,v]),Ge=()=>{O([]),z([])};S.useEffect(()=>{pt("lastUsedSourceId",a).catch(te("SourceMangas::setLastUsedSourceId"))},[a]),S.useEffect(()=>{J&&w&&!W&&K(G+1)},[J,W]),S.useEffect(()=>{!p||!jt.REVALIDATION_UNSUPPORTED.includes(a)||P.clearBrowseCacheFor(a)},[p]),$t((pe=i==null?void 0:i.displayName)!=null?pe:t._({id:"wdxz7K"}),e.jsxs(e.Fragment,{children:[e.jsx(Ft,{}),e.jsx(Gt,{}),e.jsx(H,{title:t._({id:"Xrk3+q"}),disabled:!(i!=null&&i.baseUrl),children:e.jsx(ee,{disabled:!(i!=null&&i.baseUrl),href:i!=null&&i.baseUrl?P.getWebviewUrl(i==null?void 0:i.baseUrl):"",rel:"noreferrer",target:"_blank",color:"inherit",children:e.jsx(yt,{})})}),(i==null?void 0:i.isConfigurable)&&e.jsx(H,{title:t._({id:"Tz0i8g"}),children:e.jsx(ee,{onClick:()=>r(ht.sources.childRoutes.configure.path(a)),"aria-label":"display more actions",edge:"end",color:"inherit",children:e.jsx(mt,{})})})]}),[i]);const Ne=Q.length?xt:Ot;return e.jsxs(ss,{children:[e.jsxs(ts,{sx:{top:"".concat(c,"px")},children:[e.jsx(Z,{variant:v===0?"contained":"outlined",startIcon:e.jsx(vt,{}),onClick:()=>N(0),children:t._({id:"gL/sdV"})}),(i==null?void 0:i.supportsLatest)===void 0||i.supportsLatest?e.jsx(Z,{disabled:!(i!=null&&i.supportsLatest),variant:v===1?"contained":"outlined",startIcon:e.jsx(gt,{}),onClick:()=>N(1),children:t._({id:"wL3cK8"})}):null,e.jsx(Z,{variant:v===2?"contained":"outlined",startIcon:e.jsx(Le,{}),onClick:()=>N(2,o),children:t._({id:"o7J4JM"})})]}),(Y||!D||!!D&&!!Q.length)&&e.jsx(Mt,{gridWrapperProps:{sx:{px:1,pb:1}},mangas:Q,hasNextPage:w,loadMore:De,message:$e,messageExtra:Ue,isLoading:Y,gridLayout:j,mode:"source",inLibraryIndicator:!0},Ae),D&&e.jsx(Ne,{message:t._({id:"6m5aox"}),messageExtra:ge(D),retry:()=>K(G).catch(te("SourceMangas::refetch"))}),v===2&&e.jsx(Zt,{savedSearches:I,selectSavedSearch:Re,updateSavedSearches:Oe,sourceFilter:Me,updateFilterValue:O,setTriggerUpdate:()=>{z(E)},resetFilterValue:Ge,update:E})]})}export{ca as SourceContentType,la as SourceMangas};
