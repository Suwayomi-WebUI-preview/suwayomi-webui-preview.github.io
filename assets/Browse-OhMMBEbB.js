import{r as se,i as ne,j as e,u as I,M as Fe,C as re,a as Ce,L as M,A as O,b as oe,B as U,S as ae,c as v,T as S,d as ie,e as D,f as i,N as le,g as z,h as Ge,k as H,I as $,l as ce,E as q,m as k,n as N,o as V,p as ze,q as He,s as $e,t as qe,v as Ve,w as We,x as be,y as ye,z as Ke,D as Xe,F as Qe,G as Z,H as ee}from"./index-C-NRbn2J.js";import{u as _e,S as Ne,A as Ye}from"./AppbarSearch-XMK7xCaS.js";import{s as Le,l as Ie,D as W,a as Je,e as Ze}from"./Languages-D1pzpYSw.js";import{SourceContentType as te}from"./SourceMangas-Bv57VfDa.js";import{t as K,L as Ae,g as G,I as et,a as tt,E as Oe,b as C,c as ke,d as st,e as nt,f as rt,i as ot,h as at}from"./LangSelect-DHmN2wMW.js";import{A as ue}from"./Avatar-CYWTEGlm.js";import{f as it}from"./file-selector-V_QzIWaV.js";import{V as lt,S as ct,a as ut,b as Re}from"./Virtuoso.util-C-BH93VB.js";import{T as dt}from"./TabsWrapper-CY8T-3o0.js";import{d as ht,a as pt}from"./SortRadioInput-BTQxd8x0.js";import{C as xt}from"./Chip-DwgYzjwM.js";import"./useManageMangaLibraryState-Bu52EvVG.js";import"./Trackers-D4pSmk7a.js";import"./Info-s1022MQE.js";import"./TextField-DbGGHPPy.js";import"./InputAdornment-Ba1B_yfN.js";import"./CheckCircle-Di2xQ0qU.js";import"./Mangas-BPXmRPR1.js";import"./ListPreference-h7iT6dUa.js";import"./NumberSetting-CWXMAhoj.js";import"./useMobilePicker-Bc_5vyUD.js";import"./SelectSetting-2MSXG0Ui.js";import"./ThreeStateCheckboxInput-DU2px-ZJ.js";import"./ExpandMore-BEFouOIJ.js";import"./FilterList-D8TvEhcA.js";import"./GridLayouts--siKAgtq.js";import"./useDebounce-DnwxG5aR.js";import"./StyledFab-CZM_ncxT.js";import"./BaseMangaGrid-Bv2x7axm.js";import"./MangaGrid-BSwC3wE7.js";import"./Sync-D6ciS1Ub.js";import"./PlayArrow-B7NCVHVC.js";import"./cloneObject-DrOPTG0J.js";import"./Switch-Cx6nj76p.js";var de={},ft=ne;Object.defineProperty(de,"__esModule",{value:!0});var Me=de.default=void 0,mt=ft(se()),gt=e;Me=de.default=(0,mt.default)((0,gt.jsx)("path",{d:"M19.3 16.9c.4-.7.7-1.5.7-2.4 0-2.5-2-4.5-4.5-4.5S11 12 11 14.5s2 4.5 4.5 4.5c.9 0 1.7-.3 2.4-.7l3.2 3.2 1.4-1.4zm-3.8.1c-1.4 0-2.5-1.1-2.5-2.5s1.1-2.5 2.5-2.5 2.5 1.1 2.5 2.5-1.1 2.5-2.5 2.5M12 20v2C6.48 22 2 17.52 2 12S6.48 2 12 2c4.84 0 8.87 3.44 9.8 8h-2.07c-.64-2.46-2.4-4.47-4.73-5.41V5c0 1.1-.9 2-2 2h-2v2c0 .55-.45 1-1 1H8v2h2v3H9l-4.79-4.79C4.08 10.79 4 11.38 4 12c0 4.41 3.59 8 8 8"}),"TravelExplore");const jt=l=>{const{t}=I(),r=Fe.useIsMobileWidth(),{source:{id:s,name:u,lang:n,iconUrl:d,supportsLatest:o,isNsfw:x,extension:{repo:f}},showSourceRepo:c}=l,m=Number(s)===0?t("source.local_source.title"):u;return e.jsx(re,{sx:{margin:1,marginTop:0},children:e.jsx(Ce,{component:M,to:O.sources.childRoutes.browse.path(s),state:{contentType:te.POPULAR,clearCache:!0},children:e.jsxs(oe,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:1.5},children:[e.jsxs(U,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(ue,{variant:"rounded",alt:m,sx:{width:56,height:56,flex:"0 0 auto",mr:1,background:"transparent"},children:e.jsx(ae,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:m,src:v.getValidImgUrlFor(d)})}),e.jsxs(U,{sx:{display:"flex",flexDirection:"column",justifyContent:"center"},children:[e.jsx(S,{variant:"h6",component:"h3",children:m}),e.jsxs(S,{variant:"caption",sx:{display:"block"},children:[K(n),x&&e.jsx(S,{variant:"caption",color:"error",sx:{display:"inline"},children:" 18+"}),c&&e.jsx(S,{variant:"caption",sx:{display:"block"},children:f})]})]})]}),e.jsxs(ie,{sx:{flexDirection:"row",gap:1},children:[o&&e.jsx(D,{variant:"outlined",component:M,to:O.sources.childRoutes.browse.path(s),state:{contentType:te.LATEST,clearCache:!0},children:t("global.button.latest")}),!r&&e.jsx(D,{variant:"outlined",component:M,to:O.sources.childRoutes.browse.path(s),state:{contentType:te.POPULAR,clearCache:!0},children:t("global.button.popular")})]})]})})})};function St(l){const t=new Set;return l.forEach(r=>{const u=Number(r.id)===0?W.OTHER:r.lang;t.add(u)}),[...t].sort(Ie)}function vt(l){const t={};return l.forEach(r=>{var n;const u=Number(r.id)===0?W.OTHER:r.lang;(n=t[u])!=null||(t[u]=[]),t[u].push(r)}),Object.values(t).forEach(r=>r.sort((s,u)=>s.name.localeCompare(u.name))),t}function Et({tabsMenuHeight:l}){const{t}=I(),{setAction:r}=i.useContext(le),[s,u]=z("shownSourceLangs",Je()),[n]=z("showNsfw",!0),{data:d,loading:o,error:x,refetch:f}=v.useGetSourceList({notifyOnNetworkStatusChange:!0}),c=d==null?void 0:d.sources.nodes,L=i.useMemo(()=>{if(!c||c!=null&&c.length)return!1;const{repo:h}=c[0].extension;return c.some(g=>g.extension.repo!==h)},[c]),m=Ge();return i.useEffect(()=>{Le().forEach(h=>{let g=!1;s.forEach(j=>{j===h&&(g=!0)}),g||u(j=>(j.push(h),j))})},[]),i.useLayoutEffect(()=>(r(e.jsxs(e.Fragment,{children:[e.jsx(H,{title:t("search.title.global_search"),children:e.jsx($,{onClick:()=>m(O.sources.childRoutes.searchAll.path),size:"large",color:"inherit",children:e.jsx(Me,{})})}),e.jsx(Ae,{shownLangs:s,setShownLangs:u,allLangs:St(c!=null?c:[]),forcedLangs:Le()})]})),()=>{r(null)}),[t,s,c]),o?e.jsx(ce,{}):x?e.jsx(q,{message:t("global.error.label.failed_to_load_data"),messageExtra:x.message,retry:()=>f().catch(k()),topOffset:l}):(c==null?void 0:c.length)===0?e.jsx(q,{message:t("source.error.label.no_sources_found"),topOffset:l}):e.jsx(e.Fragment,{children:Object.entries(vt(c!=null?c:[])).sort((h,g)=>Ie(h[0],g[0])).map(([h,g])=>(h===W.OTHER||s.includes(h))&&e.jsxs(i.Fragment,{children:[e.jsx(S,{variant:"h5",component:"h2",sx:{paddingLeft:3,paddingTop:1,paddingBottom:2,fontWeight:"bold"},children:K(h)},h),g.filter(j=>{if(h===W.OTHER){const E=Number(j.id)===0;if(!(s.includes(h)||E))return!1}return n||!j.isNsfw}).map(j=>e.jsx(jt,{source:j,showSourceRepo:L},j.id))]},h))})}function bt(l){const{t}=I(),{extension:{name:r,lang:s,versionName:u,isInstalled:n,hasUpdate:d,isObsolete:o,pkgName:x,iconUrl:f,isNsfw:c,repo:L},handleUpdate:m,showSourceRepo:h,forcedState:g}=l,[j,w]=i.useState(G(n,o,d)),E=g!=null?g:j;i.useEffect(()=>{w(G(n,o,d))},[G(n,o,d)]);const B=s==="all"?t("extension.language.all"):s.toUpperCase(),A=async T=>{const P=st[T],R=nt[T];try{switch(w(R),T){case C.INSTALL:await v.updateExtension(x,{install:!0,isObsolete:o}).response;break;case C.UNINSTALL:await v.updateExtension(x,{uninstall:!0,isObsolete:o}).response;break;case C.UPDATE:await v.updateExtension(x,{update:!0,isObsolete:o}).response;break;default:throw new Error('Unexpected ExtensionAction "'.concat(T,'"'))}w(P),m()}catch(F){w(G(n,o,d)),N(t(ke[T],{count:1}),"error",V(F))}};function b(){switch(E){case C.INSTALL:case C.UPDATE:case C.UNINSTALL:A(E).catch(k());break;case Oe.OBSOLETE:A(C.UNINSTALL).catch(k());break}}return e.jsx(re,{children:e.jsxs(oe,{sx:{display:"flex",alignItems:"center",gap:1,p:1.5,"&:last-child":{paddingBottom:1.5}},children:[e.jsx(ue,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",background:"transparent"},alt:r,children:e.jsx(ae,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:r,src:v.getValidImgUrlFor(f)})}),e.jsxs(U,{sx:{display:"flex",flexDirection:"column",flexGrow:1,flexShrink:1,wordBreak:"break-word",justifyContent:"center"},children:[e.jsx(S,{variant:"h6",component:"h3",children:r}),e.jsxs(S,{variant:"caption",sx:{display:"block"},children:[B," ",u,c&&e.jsx(S,{variant:"caption",color:"error",sx:{display:"inline"},children:" 18+"})]}),h&&e.jsx(S,{variant:"caption",sx:{display:"block"},children:L})]}),e.jsx(D,{variant:"outlined",sx:{color:E===et.OBSOLETE?"red":"inherit",flexShrink:0},onClick:()=>b(),children:t(tt[E])})]})})}const we=0,Te=1;function yt({tabsMenuHeight:l}){var Se,ve;const{t}=I(),{setAction:r}=i.useContext(le),{data:s,loading:u,error:n,refetch:d}=v.useGetServerSettings({notifyOnNetworkStatusChange:!0}),o=!!(s!=null&&s.settings.extensionRepos.length),x=((Se=s==null?void 0:s.settings.extensionRepos.length)!=null?Se:0)>1,f=i.useRef(null),[c,L]=z("shownExtensionLangs",Ze()),[m]=z("showNsfw",!0),[h]=_e("query",Ne),[g,j]=i.useState({}),[w,{data:E,loading:B,error:A}]=v.useExtensionListFetch(),b=(ve=E==null?void 0:E.fetchExtensions)==null?void 0:ve.extensions,[T,P]=i.useState([]),R=i.useCallback(()=>j({}),[]);i.useEffect(()=>{w()},[g]);const F=i.useMemo(()=>(b!=null?b:[]).filter(a=>{const p=m||!a.isNsfw;return h?p&&a.name.toLowerCase().includes(h.toLowerCase()):p}),[b,m,h]),{allLangs:xe,groupedExtensions:X}=i.useMemo(()=>rt(F),[F]),_=i.useMemo(()=>X.filter(a=>a[Te].length>0).filter(a=>ot(a[we])||c.includes(a[we])),[c,X]),fe=i.useMemo(()=>_.map(a=>a[Te].length),[_]),Q=i.useMemo(()=>_.map(([,a])=>a).flat(1),[_]),Be=lt.useCreateGroupedComputeItemKey(fe,i.useCallback(a=>_[a][0],[_]),i.useCallback(a=>Q[a].pkgName,[Q])),me=a=>{a.name.toLowerCase().endsWith("apk")?(f.current&&(f.current.value=""),N(t("extension.label.installing_file"),"info"),v.installExternalExtension(a).response.then(()=>{R(),N(t("extension.label.installed_successfully"),"success")}).catch(p=>N(t("extension.label.installation_failed"),"error",V(p)))):N(t("global.error.label.invalid_file_type"),"error")};i.useLayoutEffect(()=>(r(e.jsxs(e.Fragment,{children:[e.jsx(Ye,{}),e.jsx(H,{title:t("extension.action.label.install_external"),children:e.jsx($,{onClick:()=>{var a;return(a=f.current)==null?void 0:a.click()},size:"large",color:"inherit",children:e.jsx(ze,{})})}),e.jsx(Ae,{shownLangs:c,setShownLangs:L,allLangs:xe})]})),()=>{r(null)}),[t,c,xe]),i.useEffect(()=>{const a=async y=>{y.preventDefault();const Y=await it(y);me(Y[0])},p=y=>{y.preventDefault()};return document.addEventListener("drop",a),document.addEventListener("dragover",p),()=>{document.removeEventListener("drop",a),document.removeEventListener("dragover",p)}},[]);const ge=i.useMemo(()=>e.jsx("input",{type:"file",style:{display:"none"},ref:f,onChange:a=>{var y;const p=(y=a.target.files)==null?void 0:y[0];p&&me(p)}}),[]),Pe=u||B,je=n!=null?n:A;return Pe?e.jsx(ce,{}):je?e.jsx(q,{message:t("global.error.label.failed_to_load_data"),messageExtra:je.message,retry:()=>{n&&d().catch(k()),A&&w().catch(k())},topOffset:l}):!(b!=null&&b.length)&&!o?e.jsxs(e.Fragment,{children:[ge,e.jsxs(ie,{sx:{alignItems:"center",justifyContent:"center",rowGap:"10px",paddingTop:"20px"},children:[e.jsx(S,{children:t("extension.label.add_repository_info")}),e.jsx(D,{component:M,variant:"contained",to:O.browse.path,children:t("settings.title")})]})]}):e.jsxs(e.Fragment,{children:[ge,e.jsx(ct,{heightToSubtract:l,overscan:window.innerHeight*.5,groupCounts:fe,groupContent:a=>{const[p,y]=_[a],Y=p===at.UPDATE_PENDING;return e.jsxs(ut,{isFirstItem:a===0,sx:{flexDirection:"row",justifyContent:"space-between",alignItems:"center",pr:1},children:[e.jsx(S,{variant:"h5",component:"h2",children:K(p)}),Y&&e.jsx(D,{disabled:!!T.length,variant:"contained",onClick:()=>{const Ee=y.map(J=>J.pkgName);P(Ee),v.updateExtensions(Ee,{update:!0}).response.then(()=>R()).catch(J=>N(t(ke[C.UPDATE],{count:X.length}),"error",V(J))).finally(()=>P([]))},children:t("extension.action.label.update_all")})]},p)},computeItemKey:Be,itemContent:a=>{const p=Q[a];return e.jsx(Re,{children:e.jsx(bt,{extension:p,handleUpdate:R,showSourceRepo:x,forcedState:T.includes(p.pkgName)?Oe.UPDATING:void 0})})}})]})}var he={},Lt=ne;Object.defineProperty(he,"__esModule",{value:!0});var Ue=he.default=void 0,wt=Lt(se()),Tt=e;Ue=he.default=(0,wt.default)((0,Tt.jsx)("path",{d:"M14.94 4.66h-4.72l2.36-2.36zm-4.69 14.71h4.66l-2.33 2.33zM6.1 6.27 1.6 17.73h1.84l.92-2.45h5.11l.92 2.45h1.84L7.74 6.27zm-1.13 7.37 1.94-5.18 1.94 5.18zm10.76 2.5h6.12v1.59h-8.53v-1.29l5.92-8.56h-5.88v-1.6h8.3v1.26z"}),"SortByAlpha");var pe={},Ct=ne;Object.defineProperty(pe,"__esModule",{value:!0});var De=pe.default=void 0,_t=Ct(se()),Nt=e;De=pe.default=(0,_t.default)((0,Nt.jsx)("path",{d:"M20 10V8h-4V4h-2v4h-4V4H8v4H4v2h4v4H4v2h4v4h2v-4h4v4h2v-4h4v-2h-4v-4zm-6 4h-4v-4h4z"}),"Tag");const It=({id:l,name:t,lang:r,iconUrl:s,mangaCount:u})=>{const{t:n}=I(),o=Number(l)===0?n("source.local_source.title"):t;return e.jsx(re,{children:e.jsx(Ce,{component:M,to:O.migrate.path(l),children:e.jsxs(oe,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",p:1.5},children:[e.jsxs(U,{sx:{display:"flex"},children:[e.jsx(ue,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",mr:1,background:"transparent"},children:e.jsx(ae,{spinnerStyle:{small:!0},imgStyle:{objectFit:"cover",width:"100%",height:"100%"},alt:o,src:v.getValidImgUrlFor(s)})}),e.jsxs(U,{sx:{display:"flex",flexDirection:"column",justifyContent:"center"},children:[e.jsx(S,{variant:"h6",component:"h3",children:o}),e.jsx(S,{variant:"caption",sx:{display:"block"},children:K(r)})]})]}),e.jsx(xt,{sx:{borderRadius:1},size:"small",label:u})]})})})},At=(l,{sortBy:t,sortOrder:r})=>{if(!l)return[];const s={};l.forEach(({sourceId:n,source:d})=>{var x;const o=(x=s[n])!=null?x:{id:n,name:n,lang:"unknown",iconUrl:null,mangaCount:0,...d};s[n]={...o,mangaCount:o.mangaCount+1}});const u=Object.values(s).toSorted((n,d)=>{switch(t){case be.SOURCE_NAME:return n.name.localeCompare(d.name);case be.MANGA_COUNT:return n.mangaCount-d.mangaCount;default:throw new Error('Unexpected "sortBy" "'.concat(t,'"'))}});switch(r){case ye.ASC:return u;case ye.DESC:return u.toReversed();default:throw new Error('Unexpected "sortOrder" "'.concat(r,'"'))}},Ot=({tabsMenuHeight:l})=>{const{t}=I(),{appBarHeight:r}=He(),{settings:{migrateSortSettings:s}}=$e(),u=Ke(m=>N(t("global.error.label.failed_to_save_changes"),"error",V(m))),{sortBy:n,sortOrder:d}=s,{data:o,loading:x,error:f,refetch:c}=v.useGetMigratableSources({notifyOnNetworkStatusChange:!0}),L=i.useMemo(()=>At(o==null?void 0:o.mangas.nodes,s),[o==null?void 0:o.mangas.nodes,s]);return x?e.jsx(ce,{}):f?e.jsx(q,{message:t("global.error.label.failed_to_load_data"),messageExtra:f.message,retry:()=>c().catch(k()),topOffset:l}):e.jsxs(e.Fragment,{children:[e.jsxs(ie,{sx:{position:"sticky",top:"".concat(r+l,"px"),flexDirection:"row",justifyContent:"end",alignItems:"center",gap:1,p:1,backgroundColor:"background.default",zIndex:1},children:[e.jsx(H,{title:t(qe[n]),children:e.jsx($,{size:"large",color:"inherit",onClick:()=>u("migrateSortSettings",{sortBy:(n+1)%2,sortOrder:d}),children:n?e.jsx(De,{}):e.jsx(Ue,{})})}),e.jsx(H,{title:t(Ve[d]),children:e.jsx($,{size:"large",color:"inherit",onClick:()=>u("migrateSortSettings",{sortBy:n,sortOrder:(d+1)%2}),children:d?e.jsx(ht,{}):e.jsx(pt,{})})})]}),e.jsx(We,{sx:{p:0},children:L.map(m=>e.jsx(Re,{children:e.jsx(It,{...m})},m.id))})]})};function xs(){const{t:l}=I(),{setTitle:t}=i.useContext(le);i.useLayoutEffect(()=>{t(l("global.label.browse"))},[l]);const r=i.useRef(null),[s,u]=i.useState(0);Xe(r,i.useCallback(()=>u(r.current.offsetHeight),[r.current]));const[n,d]=_e("tab",Ne,{}),o=n!=null?n:"source";return n||d(o,"replaceIn"),e.jsxs(dt,{children:[e.jsxs(Qe,{ref:r,variant:"fullWidth",value:o,onChange:(x,f)=>d(f,"replaceIn"),children:[e.jsx(Z,{value:"source",sx:{textTransform:"none"},label:l("source.title_one")}),e.jsx(Z,{value:"extensions",sx:{textTransform:"none"},label:l("extension.title_other")}),e.jsx(Z,{value:"migrate",sx:{textTransform:"none"},label:l("migrate.title")})]}),e.jsx(ee,{index:"source",currentIndex:o,children:e.jsx(Et,{tabsMenuHeight:s})}),e.jsx(ee,{index:"extensions",currentIndex:o,children:e.jsx(yt,{tabsMenuHeight:s})}),e.jsx(ee,{index:"migrate",currentIndex:o,children:e.jsx(Ot,{tabsMenuHeight:s})})]})}export{xs as Browse};
