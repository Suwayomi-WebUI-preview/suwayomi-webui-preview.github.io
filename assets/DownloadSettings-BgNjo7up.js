import{u as C,j as t,E as D,o as x,p as m,bv as j,V as q,m as P,g as E,b as k,aO as Y,i as X,k as K,n as J,b6 as Q,S as T,q as Z,B as I,bw as ee,bx as O,C as te,I as ae,r as N,b3 as oe,a as se,e as ne,f as L,v as le}from"./index-DfKtWX_m.js";import{T as de}from"./TextSetting-B3BTNEk6.js";import{N as W}from"./NumberSetting-bfcbDfto.js";import{u as re,g as ie}from"./usePersistedValue-DTX6ehrf.js";import{S as b}from"./Switch-BtfbqINo.js";import{S as ce}from"./SelectSetting-DAnmVseq.js";import{a as he}from"./CategoriesInclusionSetting-CQwu9VPP.js";import{E as pe}from"./EmptyViewAbsoluteCentered-Cl5kUZOM.js";import{u as ue}from"./useAppTitle-DQpLsU8G.js";import{D as ge}from"./Delete-BkmNeQWe.js";import{T as z}from"./TextField-BTuSLyVR.js";import{I as me}from"./InputAdornment-BxrSEztd.js";import{L as M}from"./ListSubheader-CYOvqbW5.js";import"./PasswordTextField-999fDDtg.js";import"./VisibilityOff-BCvM3Owa.js";import"./Slider-DXBo4YDc.js";import"./SwitchBase-BXye88Mu.js";import"./useFormControl-XGWtFnFC.js";import"./Select-BCF1SMTQ.js";import"./ThreeStateCheckboxInput-DwMZGVTH.js";import"./Checkbox-X0XiF4fh.js";import"./formControlState-Dq1zat_P.js";const we=({downloadAheadLimit:e})=>{const{t:o}=C(),s=!!e,[l,d]=re("lastDownloadAheadLimit",j.default,e,ie),c=h=>{d(h===0?l:h),q("downloadAheadLimit",h).catch(u=>P(o("global.error.label.failed_to_save_changes"),"error",E(u)))},r=h=>{c(h?l:0)};return t.jsxs(D,{children:[t.jsxs(x,{children:[t.jsx(m,{primary:o("download.settings.download_ahead.label.while_reading")}),t.jsx(b,{edge:"end",checked:s,onChange:h=>r(h.target.checked)})]}),t.jsx(W,{settingTitle:o("download.settings.download_ahead.label.unread_chapters_to_download"),settingValue:o("download.settings.download_ahead.label.value",{chapters:l,count:l}),value:l,minValue:j.min,maxValue:j.max,defaultValue:j.default,stepSize:j.step,showSlider:!0,dialogDescription:o("download.settings.download_ahead.label.description"),dialogDisclaimer:o("download.settings.download_ahead.label.disclaimer"),valueUnit:o("chapter.title_one"),handleUpdate:c,disabled:!s})]})},xe=[0,1,2,3,4,5],be={0:{text:"global.label.disabled"},1:{text:"download.settings.delete_chapters.while_reading.option.label.first"},2:{text:"download.settings.delete_chapters.while_reading.option.label.second"},3:{text:"download.settings.delete_chapters.while_reading.option.label.third"},4:{text:"download.settings.delete_chapters.while_reading.option.label.fourth"},5:{text:"download.settings.delete_chapters.while_reading.option.label.fifth"}},_e=xe.map(e=>[e,be[e]]),Ce=e=>typeof e=="boolean"?Number(e):e,fe=({chapterToDelete:e,handleChange:o})=>{const{t:s}=C(),l=Ce(e);return t.jsx(ce,{settingName:s("download.settings.delete_chapters.while_reading.label.title"),value:l,values:_e,handleChange:o})},$="default",S="image/",R=-1,v=e=>e.replace(S,""),B=e=>v(e.toLowerCase().trim())===$,G=(e,o,s)=>s.slice(0,o).some(l=>l.mimeType===e),H=e=>e==null||e>=O.min&&e<=O.max,je=e=>e.some(({mimeType:o,compressionLevel:s},l)=>!H(s)||G(o,l,e)),V=e=>e.map(o=>({...o,mimeType:v(o.mimeType),target:v(o.target)})),De=e=>e.filter(({mimeType:o,target:s})=>!!o&&!!s).map(o=>({...o,mimeType:"".concat(S).concat(o.mimeType),target:"".concat(S).concat(o.target)})),U=e=>[...e.some(({mimeType:s})=>B(s))?[]:[{mimeType:$,target:""}],...e],Te=(e,o)=>e.length!==o.length?!0:e.some(({mimeType:s,target:l,compressionLevel:d},c)=>{const r=o[c];return v(s)!==r.mimeType||v(l)!==r.target||d!==r.compressionLevel}),F=({shouldAutoFocus:e,isDefault:o,isDuplicate:s,label:l,value:d,onUpdate:c})=>{const{t:r}=C();return t.jsx(z,{sx:{maxWidth:150},autoFocus:e,label:l,value:d,disabled:o,error:s,helperText:s&&r("global.error.label.invalid_input"),slotProps:{input:{startAdornment:t.jsx(me,{position:"start",children:S})}},onChange:h=>c(h.target.value.trim())})},ve=({index:e,shouldAutoFocusMimeTypeTextField:o,conversion:{mimeType:s,target:l,compressionLevel:d},setFocusMimeTypeTextField:c,onChange:r,isDuplicate:h})=>{const{t:u}=C(),w=H(d),a=B(s)&&!h,p=a&&!l&&d==null;return t.jsxs(T,{sx:{gap:1,flexDirection:"row",flexWrap:"nowrap",alignItems:"center",pt:1},children:[t.jsxs(T,{sx:{gap:1,flexDirection:"row",alignItems:"baseline",flexWrap:"wrap"},children:[t.jsx(F,{shouldAutoFocus:o,isDefault:a,isDuplicate:h,label:u(a?"global.label.default":"download.settings.conversion.mime_type"),value:s,onUpdate:i=>{c(!0),r({mimeType:i,target:l,compressionLevel:d})}}),t.jsx(ee,{sx:{mx:1},children:"→"}),t.jsx(F,{shouldAutoFocus:!1,isDefault:!1,isDuplicate:!1,label:u("download.settings.conversion.compression_level"),value:l,onUpdate:i=>r({mimeType:s,target:i,compressionLevel:d})}),t.jsx(z,{label:"Compression",value:d!=null?d:"",type:"number",error:!w,helperText:w?"":u("global.error.label.invalid_input"),slotProps:{input:{inputProps:O}},onChange:i=>{r({mimeType:s,target:l,compressionLevel:i.target.value?Number(i.target.value):void 0})}})]}),t.jsx(te,{disabled:p,title:u("chapter.action.download.delete.label.action"),children:t.jsx(ae,{disabled:p,onClick:()=>{c(!1),r(null)},children:t.jsx(ge,{})})})]},"".concat(s,"-").concat(e))},ye=({conversions:e,updateSetting:o})=>{const{t:s}=C(),[l,d]=k.useState(!1),[c,r]=k.useState(V(U(e))),[h,u]=k.useState(R),w=je(c),a=Te(e,c),p=()=>{r(V(U(e))),d(!1)};return t.jsxs(t.Fragment,{children:[t.jsx(Y,{disabled:!1,onClick:()=>d(!0),children:t.jsx(m,{primary:s("download.settings.conversion.title"),secondary:e.map(i=>"".concat(i.mimeType," → ").concat(i.target)).join("; "),secondaryTypographyProps:{style:{display:"flex",flexDirection:"column"}}})}),t.jsxs(X,{open:l,onClose:p,children:[t.jsx(K,{children:s("download.settings.conversion.title")}),t.jsxs(J,{children:[t.jsx(Q,{sx:{mb:2},children:s("download.settings.conversion.description")}),t.jsx(T,{sx:{flexDirection:"column",gap:3},children:c.map((i,g)=>{const{mimeType:f}=i,y=G(f,g,c),n=g===h;return t.jsx(ve,{conversion:i,isDuplicate:y,index:g,setFocusMimeTypeTextField:_=>u(_?g:R),shouldAutoFocusMimeTypeTextField:n,onChange:_=>{r(A=>U(A.toSpliced(g,1,..._?[_]:[])))}},"".concat(f,"-").concat(g))})})]}),t.jsx(Z,{children:t.jsxs(T,{direction:"row",sx:{justifyContent:"space-between",width:"100%"},children:[t.jsx(I,{variant:"outlined",onClick:()=>{r(i=>[...i,{mimeType:"",target:""}])},children:s("global.button.add")}),t.jsxs(T,{direction:"row",children:[t.jsx(I,{onClick:p,children:s("global.button.cancel")}),t.jsx(I,{disabled:w||!a,onClick:()=>o(De(c)),children:s("global.button.ok")})]})]})})]})]})},Ee=e=>({downloadAsCbz:e.downloadAsCbz,downloadsPath:e.downloadsPath,autoDownloadNewChapters:e.autoDownloadNewChapters,autoDownloadNewChaptersLimit:e.autoDownloadNewChaptersLimit,excludeEntryWithUnreadChapters:e.excludeEntryWithUnreadChapters,autoDownloadIgnoreReUploads:e.autoDownloadIgnoreReUploads,downloadConversions:e.downloadConversions}),Ke=()=>{var g,f,y;const{t:e}=C();ue(e("download.title.download"));const o=N.useGetCategories(oe),s=N.useGetServerSettings({notifyOnNetworkStatusChange:!0}),[l]=N.useUpdateServerSettings(),{settings:d,loading:c,request:{error:r,refetch:h}}=se();if(s.loading||c||o.loading)return t.jsx(ne,{});const w=(f=(g=s.error)!=null?g:r)!=null?f:o.error;if(w)return t.jsx(pe,{message:e("global.error.label.failed_to_load_data"),messageExtra:E(w),retry:()=>{s.error&&s.refetch().catch(L()),r&&h().catch(L()),o.error&&o.refetch().catch(L())}});const a=Ee(s.data.settings),p=(n,_)=>{l({variables:{input:{settings:{[n]:_}}}}).catch(A=>P(e("global.error.label.failed_to_save_changes"),"error",E(A)))},i=le(n=>P(e("global.error.label.failed_to_save_changes"),"error",E(n)));return t.jsxs(D,{sx:{pt:0},children:[t.jsx(de,{settingName:e("download.settings.download_path.label.title"),dialogDescription:e("download.settings.download_path.label.description"),value:a==null?void 0:a.downloadsPath,settingDescription:a!=null&&a.downloadsPath.length?a.downloadsPath:e("global.label.default"),handleChange:n=>p("downloadsPath",n)}),t.jsxs(x,{children:[t.jsx(m,{primary:e("download.settings.file_type.label.cbz")}),t.jsx(b,{edge:"end",checked:!!(a!=null&&a.downloadAsCbz),onChange:n=>p("downloadAsCbz",n.target.checked)})]}),t.jsx(ye,{conversions:a==null?void 0:a.downloadConversions,updateSetting:n=>p("downloadConversions",n)}),t.jsxs(D,{subheader:t.jsx(M,{component:"div",id:"download-settings-auto-delete-downloads",children:e("download.settings.delete_chapters.title")}),children:[t.jsxs(x,{children:[t.jsx(m,{primary:e("download.settings.delete_chapters.label.manually_marked_as_read")}),t.jsx(b,{edge:"end",checked:d.deleteChaptersManuallyMarkedRead,onChange:n=>i("deleteChaptersManuallyMarkedRead",n.target.checked)})]}),t.jsx(fe,{chapterToDelete:d.deleteChaptersWhileReading,handleChange:n=>i("deleteChaptersWhileReading",n)}),t.jsxs(x,{children:[t.jsx(m,{primary:e("download.settings.delete_chapters.label.allow_deletion_of_bookmarked")}),t.jsx(b,{edge:"end",checked:d.deleteChaptersWithBookmark,onChange:n=>i("deleteChaptersWithBookmark",n.target.checked)})]})]}),t.jsxs(D,{subheader:t.jsx(M,{component:"div",id:"download-settings-auto-download",children:e("download.settings.auto_download.title")}),children:[t.jsxs(x,{children:[t.jsx(m,{primary:e("download.settings.auto_download.label.new_chapters")}),t.jsx(b,{edge:"end",checked:!!(a!=null&&a.autoDownloadNewChapters),onChange:n=>p("autoDownloadNewChapters",n.target.checked)})]}),t.jsx(W,{disabled:!(a!=null&&a.autoDownloadNewChapters),settingTitle:e("download.settings.auto_download.download_limit.label.title"),dialogDescription:e("download.settings.auto_download.download_limit.label.description"),value:(y=a==null?void 0:a.autoDownloadNewChaptersLimit)!=null?y:0,settingValue:a.autoDownloadNewChaptersLimit?e("download.settings.download_ahead.label.value",{chapters:a.autoDownloadNewChaptersLimit,count:a.autoDownloadNewChaptersLimit}):e("global.label.none"),defaultValue:0,minValue:0,maxValue:20,showSlider:!0,valueUnit:e("chapter.title_one"),handleUpdate:n=>p("autoDownloadNewChaptersLimit",n)}),t.jsxs(x,{children:[t.jsx(m,{primary:e("download.settings.auto_download.label.ignore_with_unread_chapters")}),t.jsx(b,{edge:"end",checked:!!(a!=null&&a.excludeEntryWithUnreadChapters),onChange:n=>p("excludeEntryWithUnreadChapters",n.target.checked),disabled:!(a!=null&&a.autoDownloadNewChapters)})]}),t.jsxs(x,{children:[t.jsx(m,{primary:e("download.settings.auto_download.label.ignore_re_uploads")}),t.jsx(b,{edge:"end",checked:!!(a!=null&&a.autoDownloadIgnoreReUploads),onChange:n=>p("autoDownloadIgnoreReUploads",n.target.checked),disabled:!(a!=null&&a.autoDownloadNewChapters)})]}),t.jsx(he,{categories:o.data.categories.nodes,includeField:"includeInDownload",dialogText:e("download.settings.auto_download.categories.label.include_in_download")})]}),t.jsx(D,{subheader:t.jsx(M,{component:"div",id:"download-settings-download-ahead",children:e("download.settings.download_ahead.title")}),children:t.jsx(we,{downloadAheadLimit:d.downloadAheadLimit})})]})};export{Ke as DownloadSettings};
