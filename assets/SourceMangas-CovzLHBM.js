import{g as ge,Y as he,j as e,c as De,az as F,Z as Re,T as xe,aA as Ge,bp as me,bq as fe,br as qe,B as k,aS as Se,aC as be,d as U,f as b,bs as Ne,bt as Ue,bu as M,aZ as Be,u as je,e as O,ag as Ve,i as K,I as ve,ah as ze,ap as He,aq as We,aL as Qe,aM as Ye,a_ as Je,aO as Ke,bv as Ze,m as Z,O as Xe,bw as et,bx as tt,by as st,bz as at,a2 as X,N as nt,aD as rt,h as ot,aK as de,q as it,bA as N,bB as ct,r as P,bC as lt,ar as ut,A as dt,bD as pt,aJ as gt,E as ht,bE as xt,l as pe,bF as mt,n as ft}from"./index-kfrPXZL3.js";import{a as St,u as bt,A as jt,S as vt}from"./AppbarSearch-B-y2VGCH.js";import{a as Ce,E as ye,F as Ct}from"./ExpandMore-CYdCSQN3.js";import{F as Fe}from"./FilterList-DtjWxf-W.js";import{G as yt}from"./GridLayouts-EyVvgjFS.js";import{S as Ft,O as Tt}from"./SortRadioInput-D-po21Jr.js";import{b as Te}from"./useManageMangaLibraryState-C8lNiMs1.js";import{u as Et}from"./useDebounce-DaohEBqS.js";import{T as Lt}from"./ThreeStateCheckboxInput-DY_pz5R-.js";import{S as It}from"./StyledFab-CEa_kNCE.js";import{C as kt}from"./Chip-CsTKp8vm.js";import{B as Mt}from"./BaseMangaGrid-DYSmknUy.js";import{g as At}from"./MangaGrid-BQZvQYo3.js";import"./ListPreference-3zaD3SMw.js";import"./Trackers-D4pSmk7a.js";import"./Avatar-BepZ1bcv.js";import"./Info-Qf55dZfB.js";import"./CheckCircle-CgN_jdMK.js";import"./NumberSetting-Bcfu4XbM.js";import"./useMobilePicker-BCQdUnAT.js";import"./SelectSetting-CxOeHTWZ.js";import"./Sync-o_QCIz8l.js";import"./PlayArrow-BSGyaSHi.js";function _t(){const[t,a]=ge("source-grid-layout",he.Compact);return e.jsx(yt,{gridLayout:t,onChange:a})}const wt=De(e.jsx("path",{d:"M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3m3-10H5V5h10z"}),"Save"),Ot=t=>{const{state:a,name:r,position:o,group:s,updateFilterValue:c,update:n}=t,[l,i]=F.useState(a),m=u=>{i(u.target.checked);const g=n.filter(j=>!(o===j.position&&s===j.group));c([...g,{type:"checkBoxState",position:o,state:u.target.checked,group:s}])};return a!==void 0?e.jsx(Re,{label:r,checked:l,onChange:m}):null},Pt=({name:t})=>e.jsx(xe,{sx:{mt:2},variant:"subtitle2",children:t},t);function $t(t,a,r,o,s,c,n){const[l,i]=F.useState(r);if(t){const m=g=>{const j=t.indexOf("".concat(g.target.value));i(j);const d=c.filter(p=>!(o===p.position&&n===p.group));s([...d,{type:"selectState",position:o,state:j,group:n}])},u=t.map(g=>e.jsx(Ge,{value:g,children:g},"".concat(a," ").concat(g)));return e.jsxs(me,{sx:{my:1},variant:"standard",children:[e.jsx(fe,{children:a}),e.jsx(qe,{name:a,value:t[l],label:a,onChange:m,children:u})]})}return null}const Dt=({values:t,name:a,state:r,position:o,updateFilterValue:s,update:c,group:n})=>$t(t,a,r,o,s,c,n),Rt=t=>{const{values:a,name:r,state:o,position:s,group:c,updateFilterValue:n,update:l}=t,[i,m]=F.useState(o),[u,g]=F.useState(!1),j=()=>{g(!u)};if(a){const d=p=>{const h=i;h.index===p?h.ascending=!h.ascending:h.ascending=!0,h.index=p,m(h);const C=l.filter(f=>!(s===f.position&&c===f.group));n([...C,{type:"sortState",position:s,state:h,group:c}])};return e.jsxs(k,{sx:{mx:-2},children:[e.jsxs(Se,{onClick:j,children:[e.jsx(be,{primary:r}),u?e.jsx(Ce,{}):e.jsx(ye,{})]}),e.jsx(Te,{in:u,children:e.jsx(U,{sx:{mx:4},children:a.map((p,h)=>e.jsx(Ft,{label:p,checked:i.index===h,sortDescending:!i.ascending,onClick:()=>d(h)},"".concat(r," ").concat(p)))})})]})}return null},Gt=t=>{const{state:a,name:r,position:o,group:s,updateFilterValue:c,update:n}=t,[l,i]=F.useState(a||""),m=Et(l,500);return b.useEffect(()=>{const u=n.filter(g=>!(o===g.position&&s===g.group));c([...u,{type:"textState",position:o,state:m,group:s}])},[m]),a!==void 0?e.jsxs(me,{sx:{my:1},variant:"standard",children:[e.jsx(fe,{children:r}),e.jsx(Ne,{name:r,value:l,onChange:({target:{value:u}})=>i(u),endAdornment:e.jsx(Ue,{position:"end",children:e.jsx(St,{})})})]}):null},qt=t=>{switch(t){case M.Ignore:return 0;case M.Include:return 1;case M.Exclude:return 2;default:throw new Error("Unexpected TriState ".concat(t))}},Nt=t=>{switch(t){case 0:return M.Ignore;case 1:return M.Include;case 2:return M.Exclude;default:throw new Error("Unexpected state number ".concat(t))}},Ut=t=>{const{state:a,name:r,position:o,group:s,updateFilterValue:c,update:n}=t,[l,i]=F.useState(qt(a)),m=u=>{const g=u===void 0?0:u?1:2;i(g);const j=n.filter(d=>!(o===d.position&&s===d.group));c([...j,{type:"triState",position:o,state:Nt(g),group:s}])};return a!==void 0?e.jsx(Lt,{label:r,checked:[void 0,!0,!1][l],onChange:u=>m(u)}):null},Bt=t=>{const{state:a,name:r,position:o,updateFilterValue:s,update:c}=t,[n,l]=F.useState(!1);return e.jsxs(k,{sx:{mx:-2},children:[e.jsxs(Se,{onClick:()=>l(!n),children:[e.jsx(be,{primary:r}),n?e.jsx(Ce,{}):e.jsx(ye,{})]}),e.jsx(Te,{in:n,children:e.jsx(U,{sx:{mx:4},children:e.jsx(Ee,{sourceFilter:a,group:o,updateFilterValue:s,update:c})})})]})},Vt=({name:t})=>e.jsx(Be,{sx:{my:1},textAlign:"center",children:t},t);function Ee({sourceFilter:t,group:a,updateFilterValue:r,update:o}){return e.jsx(U,{children:t.map((s,c)=>{var l,i;let n=o.find(m=>m.group===a&&m.position===c);switch(n=n&&n.state,s.type){case"CheckBoxFilter":return e.jsx(Ot,{name:s.name,state:n!=null?n:s.CheckBoxFilterDefault,position:c,group:a,updateFilterValue:r,update:o},"filters ".concat(s.name));case"GroupFilter":return e.jsx(Bt,{name:s.name,state:s.filters,position:c,updateFilterValue:r,update:o},"filters ".concat(s.name));case"HeaderFilter":return e.jsx(Pt,{name:s.name},"filters ".concat(s.name));case"SelectFilter":return e.jsx(Dt,{name:s.name,values:s.values,state:n!=null?parseInt(n,10):s.SelectFilterDefault,position:c,group:a,updateFilterValue:r,update:o},"filters ".concat(s.name));case"SeparatorFilter":return e.jsx(Vt,{name:s.name},"filters ".concat(s.name));case"SortFilter":return e.jsx(Rt,{name:s.name,values:s.values,state:n!=null?n:{ascending:(l=s.SortFilterDefault)==null?void 0:l.ascending,index:(i=s.SortFilterDefault)==null?void 0:i.index},position:c,group:a,updateFilterValue:r,update:o},"filters ".concat(s.name));case"TextFilter":return e.jsx(Gt,{name:s.name,state:n!=null?n:s.TextFilterDefault,position:c,group:a,updateFilterValue:r,update:o},"filters ".concat(s.name));case"TriStateFilter":return e.jsx(Ut,{name:s.name,state:n!=null?n:s.TriStateFilterDefault,position:c,group:a,updateFilterValue:r,update:o},"filters ".concat(s.name));default:throw new Error('Unknown source filter "'.concat(s,'"'))}})},"filters ".concat(a))}function zt({savedSearches:t={},selectSavedSearch:a,updateSavedSearches:r,sourceFilter:o,updateFilterValue:s,resetFilterValue:c,setTriggerUpdate:n,update:l}){const{t:i}=je(),[m,u]=b.useState(!1),[g,j]=b.useState(""),d=Object.keys(t),p=!!d.length;function h(){c(0),u(!1)}function C(){n(0),u(!1)}return e.jsxs(e.Fragment,{children:[e.jsxs(It,{onClick:()=>u(!m),variant:"extended",color:"primary",children:[e.jsx(Fe,{}),i("global.button.filter")]}),e.jsxs(Tt,{open:m,onClose:()=>u(!1),children:[e.jsxs(k,{sx:{p:2,pb:p?void 0:0},children:[e.jsxs(k,{sx:{display:"flex",pb:1},children:[e.jsx(O,{onClick:h,children:i("global.button.reset")}),e.jsx(Ve,{variant:"dialog",popupId:"source-browse-save-search",children:f=>e.jsxs(e.Fragment,{children:[e.jsx(K,{title:i("source.filter.save_search.label.save"),children:e.jsx(ve,{sx:{marginLeft:"auto"},...ze(f),children:e.jsx(wt,{})})}),e.jsxs(He,{...We(f),maxWidth:"xs",fullWidth:!0,children:[e.jsx(Qe,{children:i("source.filter.save_search.dialog.label.title")}),e.jsx(Ye,{children:e.jsx(Je,{sx:{width:"100%"},value:g,onChange:y=>j(y.target.value),slotProps:{htmlInput:{maxLength:50}}})}),e.jsxs(Ke,{children:[e.jsx(O,{onClick:()=>{j(""),f.close()},children:i("global.button.cancel")}),e.jsx(O,{onClick:()=>{r(g,"create"),j(""),f.close()},children:i("global.button.ok")})]})]})]})}),e.jsx(O,{variant:"contained",onClick:C,children:i("global.button.submit")})]}),p&&e.jsxs(e.Fragment,{children:[e.jsx(xe,{sx:{pb:1},children:"Saved searches"}),e.jsx(U,{sx:{flexDirection:"row"},children:d.map(f=>e.jsx(kt,{label:f,onClick:()=>{u(!1),a(f)},onDelete:()=>{Ze({title:i("global.label.are_you_sure"),message:i("source.filter.save_search.dialog.label.delete",{name:f}),actions:{confirm:{title:i("global.button.delete")}}}).then(()=>r(f,"delete")).catch(Z())},deleteIcon:e.jsx(K,{title:i("source.filter.save_search.label.delete"),children:e.jsx(Xe,{})}),variant:"outlined"}))})]})]}),e.jsx(k,{sx:{pb:2,mx:2},children:e.jsx(Ee,{sourceFilter:o,updateFilterValue:s,group:void 0,update:l})})]})]})}const Ht={savedSearches:void 0},Le=t=>({...t,savedSearches:t.savedSearches?JSON.stringify(t.savedSearches):void 0}),Wt=t=>{var a;return{...t,savedSearches:(a=st(t.savedSearches))!=null?a:void 0}},Qt=(t,a)=>Wt(et("source",{...t,meta:tt(t.meta)},Le(Ht),void 0,!0,a)),Yt=t=>{const a=Qt(t,b.useEffect);return b.useMemo(()=>a,[t])},Jt=async(t,a,r)=>at(t,[[a,Le({[a]:r})[a]]]),Kt=(t,a=Z())=>(r,o)=>Jt(t,r,o).catch(a),Zt={id:"-1"},Xt=X("div")(({theme:t})=>({display:"flex",position:"sticky",width:"100%",zIndex:1,padding:t.spacing(1),gap:t.spacing(1),backgroundColor:t.palette.background.default})),J=X(O)(()=>({})),es=X(k)(()=>({minHeight:"100%",position:"relative"}));var ts=(t=>(t[t.POPULAR=0]="POPULAR",t[t.LATEST=1]="LATEST",t[t.SEARCH=2]="SEARCH",t))(ts||{});const ss={0:"manga.error.label.no_mangas_found",1:"manga.error.label.no_mangas_found",2:"manga.error.label.no_matches"},as=t=>{const a={},r=[];return t.forEach(o=>{!!a[o.id]||(a[o.id]=o,r.push(o))}),r},ns=(t,a,r,o,s,c)=>{var d;let n;switch(a){case 0:n=P.useGetSourcePopularMangas(t,s);break;case 1:n=P.useGetSourceLatestMangas(t,s);break;case 2:n=P.useSourceSearch(t,r!=null?r:"",o.map(p=>{const{position:h,state:C,group:f}=p;return f!==void 0?{position:f,groupChange:{position:h,[p.type]:C}}:{position:h,[p.type]:C}}),s);break;default:throw new Error('Unknown ContentType "'.concat(a,'"'))}const l=n[1],i=l.findLastIndex(p=>{var h;return!!((h=p.data)!=null&&h.fetchSourceManga)}),m=l[i],u=l.slice(-1)[0].isLoading;let g=!u;const j=b.useMemo(()=>{let p=[];return l.forEach((h,C)=>{var _,v,$;const f=($=(v=(_=h.data)==null?void 0:_.fetchSourceManga)==null?void 0:v.mangas)!=null?$:[],y=f.filter(T=>!c||!T.inLibrary),A=as([...p,...y]);g=!u&&l.length===C+1&&!y.length&&!!f.length,p=A}),p},[l,c]);return i===-1?[n[0],{...n[1][n[1].length-1],filteredOutAllItemsOfFetchedPage:g}]:[n[0],{...l[l.length-1],data:{...m.data,fetchSourceManga:{...m.data.fetchSourceManga,hasNextPage:l.length>i+1?!1:!!((d=m.data.fetchSourceManga)!=null&&d.hasNextPage),mangas:j}},filteredOutAllItemsOfFetchedPage:g}]};function As(){var re,oe,ie,ce,le;const{t}=je(),{setTitle:a,setAction:r,appBarHeight:o}=b.useContext(nt),{sourceId:s}=rt(),c=ot(),n=de(),{key:l,state:i}=n,{contentType:m=0,clearCache:u=!1}=(re=de().state)!=null?re:{},{settings:{hideLibraryEntries:g}}=it(),[j]=ge("source-grid-layout",he.Compact),[d]=bt("query",vt),[p,h]=N("source-mangas-".concat(s,"-filters"),[]),[C,f]=N("source-mangas-location-".concat(l,"-").concat(s,"-filters"),p!=null?p:[]),[y,A]=b.useState(C),[ee,_]=N("source-mangas-".concat(s,"-content-type"),m),[v,$]=N("source-mangas-location-".concat(l,"-").concat(s,"-content-type"),d?2:ee),T=b.useCallback(()=>{ct.session.setItem(At(n),void 0,!1),window.scrollTo(0,0)},[l]),te=b.useRef(d),se=b.useRef(()=>{});te.current!==d&&v===2&&(te.current=d,se.current(new Error("SourceMangas(".concat(s,"): search string changed"))),T()),b.useEffect(()=>()=>{h(void 0),_(void 0)},[s]);const B=S=>{h(S),f(S),T()},ae=S=>{_(S),$(S)},[V,{data:E,error:D,isLoading:z,size:R,abortRequest:Ie,filteredOutAllItemsOfFetchedPage:H}]=ns(s,v,d,C,1,g);se.current=Ie;const W=z||H,Q=(ie=(oe=E==null?void 0:E.fetchSourceManga)==null?void 0:oe.mangas)!=null?ie:[],G=!!((ce=E==null?void 0:E.fetchSourceManga)!=null&&ce.hasNextPage),{data:Y}=P.useGetSource(lt,s),x=Y==null?void 0:Y.source,ke=(le=x==null?void 0:x.filters)!=null?le:[],{savedSearches:L={}}=Yt(x!=null?x:Zt),ne=Kt(x!=null?x:{id:"-1"},S=>ft(t("global.error.label.failed_to_save_changes"),"error",pe(S))),Me=b.useCallback(S=>{const{query:I,filters:w}=L[S];w&&(A(w),B(w)),c({pathname:"",search:I?"query=".concat(I):void 0},{state:{...i,contentType:2}})},[L,i]),Ae=b.useCallback((S,I)=>{if(I==="delete"){const ue={...L};delete ue[S],ne("savedSearches",ue);return}const w={...L,[S]:{query:d!=null?d:void 0,filters:y}};ne("savedSearches",w)},[L,d,y]),_e=W?void 0:t(ss[v]),we=s==="0"?e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:[t("source.local_source.label.checkout")," "]}),e.jsx(ut,{href:"https://github.com/Suwayomi/Suwayomi-Server/wiki/Local-Source",target:"_blank",rel:"noreferrer",children:t("source.local_source.label.guide")})]}):void 0,q=b.useCallback((S,I)=>{ae(S),T(),d&&!I&&c({pathname:""},{state:{...i,contentType:S}})},[ae,d,T]);!!d&&v!==2&&q(2,d);const Oe=b.useCallback(()=>{G&&V(R+1)},[R,G,v]),Pe=()=>{A([]),B([])};b.useEffect(()=>{H&&G&&!z&&V(R+1)},[H,z]),b.useEffect(()=>{!u||!mt.REVALIDATION.includes(s)||P.clearBrowseCacheFor(s)},[u]),b.useLayoutEffect(()=>{var S;return a((S=x==null?void 0:x.displayName)!=null?S:t("source.title_one")),r(e.jsxs(e.Fragment,{children:[e.jsx(jt,{}),e.jsx(_t,{}),(x==null?void 0:x.isConfigurable)&&e.jsx(K,{title:t("settings.title"),children:e.jsx(ve,{onClick:()=>c(dt.sources.childRoutes.configure.path(s)),"aria-label":"display more actions",edge:"end",color:"inherit",size:"large",children:e.jsx(pt,{})})})]})),()=>{a(""),r(null)}},[t,x]);const $e=Q.length?gt:ht;return e.jsxs(es,{children:[e.jsxs(Xt,{sx:{top:"".concat(o,"px")},children:[e.jsx(J,{variant:v===0?"contained":"outlined",startIcon:e.jsx(Ct,{}),onClick:()=>q(0),children:t("global.button.popular")}),(x==null?void 0:x.supportsLatest)===void 0||x.supportsLatest?e.jsx(J,{disabled:!(x!=null&&x.supportsLatest),variant:v===1?"contained":"outlined",startIcon:e.jsx(xt,{}),onClick:()=>q(1),children:t("global.button.latest")}):null,e.jsx(J,{variant:v===2?"contained":"outlined",startIcon:e.jsx(Fe,{}),onClick:()=>q(2,d),children:t("global.button.filter")})]}),(W||!D||!!D&&!!Q.length)&&e.jsx(Mt,{gridWrapperProps:{sx:{px:1,pb:1}},mangas:Q,hasNextPage:G,loadMore:Oe,message:_e,messageExtra:we,isLoading:W,gridLayout:j,mode:"source",inLibraryIndicator:!0},v),D&&e.jsx($e,{message:t("global.error.label.failed_to_load_data"),messageExtra:pe(D),retry:()=>V(R).catch(Z())}),v===2&&e.jsx(zt,{savedSearches:L,selectSavedSearch:Me,updateSavedSearches:Ae,sourceFilter:ke,updateFilterValue:A,setTriggerUpdate:()=>{B(y)},resetFilterValue:Pe,update:y})]})}export{ts as SourceContentType,As as SourceMangas};
