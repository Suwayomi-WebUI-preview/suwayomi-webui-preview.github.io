import{e as u,u as O,f as U,q as Q,a as V,b as J,d as K,r as D,j as e,h as X,g as A,i as N,p as P,S as F,B as C,s as Y,ao as Z,A as ee,L as te,T as q,C as re,I as oe,ay as se,az as ne,m as ae}from"./index-jpRqaJdL.js";import{u as ie,S as ce,A as ue}from"./AppbarSearch-C8wOnA0a.js";import{P as le}from"./PushPin-CcPUYl4g.js";import{D as me}from"./DoneAll-pSRpjbug.js";import{F as de}from"./FilterList-66AL4OR2.js";import{t as pe,L as he}from"./LanguageSelect-CSaMl7Ms.js";import{u as z}from"./useDebounce-Dmf_-y0L.js";import{B as ge}from"./BaseMangaGrid-C0AwpSuX.js";import{E as fe}from"./EmptyViewAbsoluteCentered-C-7sbkK6.js";import{S as T,g as B}from"./Sources-BrUYXrFT.js";import{u as Se}from"./useAppTitleAndAction-D-Xp6oPI.js";import{M as xe}from"./index-DHze8ium.js";import{C as ye}from"./Card-C45OZXtx.js";import{C as be}from"./CardActionArea-d2BkuZJ9.js";import"./ChaptersDownloadActionMenuItems-BYGeQIGz.js";import"./Trackers-COtG7wmP.js";import"./ListCardContent-BrdW3xcj.js";import"./Avatar-upS8hVPj.js";import"./TextField-CNy3WpG7.js";import"./useFormControl-sU0b3O3b.js";import"./formControlState-Dq1zat_P.js";import"./InputAdornment-CRZ913uN.js";import"./CheckCircle-DBwO1KtS.js";import"./Link-B6bjEzKf.js";import"./useManageMangaLibraryState-DfFRBk_K.js";import"./ThreeStateCheckboxInput-CpN9YVFB.js";import"./Checkbox-GRJhWekL.js";import"./SwitchBase-DkVks5Ks.js";import"./CheckboxInput-Dj1I4yu9.js";import"./FormGroup-C7o60W_A.js";import"./ListPreference-DOTgCPjQ.js";import"./NumberSetting-C25m618W.js";import"./Slider-CKl5C-Dq.js";import"./useMobilePicker-Cxptup1f.js";import"./Chip-DwiARDve.js";import"./SelectSetting-BzcG1Uv_.js";import"./Select-BmqWUUyG.js";import"./Switch-DquRehAV.js";import"./MangaGrid-DBba8Fn2.js";import"./Delete-CIlY3Ijo.js";import"./Download-lgveXpET.js";import"./Sync-B9wC0K5J.js";import"./use-merged-ref-CgNQndhF.js";import"./ListCardAvatar-3QxNEozj.js";import"./PlayArrow-B5XYabMV.js";import"./StyledFab-CxdPyFs5.js";import"./Virtuoso.util-B2UVSzsy.js";import"./useAppTitle-CQKoRnyJ.js";import"./useAppAction-BEA8zopP.js";const Re={x:0,y:0,width:0,height:0,top:0,left:0,bottom:0,right:0};function we(n){const i=u.useRef(0),t=u.useRef(null),[a,p]=u.useState(Re),r=u.useMemo(()=>typeof window<"u"?new ResizeObserver(o=>{const s=o[0];s&&(cancelAnimationFrame(i.current),i.current=requestAnimationFrame(()=>{var c,h;if(t.current){const l=((c=s.borderBoxSize)==null?void 0:c[0])||((h=s.contentBoxSize)==null?void 0:h[0]);if(l){const d=l.inlineSize,y=l.blockSize;p({width:d,height:y,x:s.contentRect.x,y:s.contentRect.y,top:s.contentRect.top,left:s.contentRect.left,bottom:s.contentRect.bottom,right:s.contentRect.right})}else p(s.contentRect)}}))}):null,[]);return u.useEffect(()=>(t.current&&(r==null||r.observe(t.current,n)),()=>{r==null||r.disconnect(),i.current&&cancelAnimationFrame(i.current)}),[t.current]),[t,a]}function je(n){const[i,{width:t,height:a}]=we(n);return{ref:i,width:t,height:a}}const Le=(n,i)=>n.displayName.localeCompare(i.displayName),Me=(n,i,t)=>{const a=B(n).isPinned,p=B(i).isPinned,r=t.get(n.id),o=t.get(i.id),s=!(r!=null&&r.isLoading),c=!!(r!=null&&r.error),h=!(r!=null&&r.hasResults)&&!c,l=!(o!=null&&o.isLoading),d=!!(o!=null&&o.error),y=!(o!=null&&o.hasResults)&&!d;return s&&!l?-1:!s&&l||h&&!y?1:y&&!h||!c&&d?-1:c&&!d?1:a&&!p?-1:!a&&p?1:0},Ee=1e3,Pe=Z.memo(({source:n,onSearchRequestFinished:i,searchString:t,emptyQuery:a,mode:p,shouldShowOnlySourcesWithResults:r})=>{var L,M;const{t:o}=O(),{id:s,name:c,lang:h}=n,l=u.useRef(t),d=u.useRef(()=>{});l.current!==t&&(l.current=t,d.current(new Error("SourceSearchPreview(".concat(s,", ").concat(c,"): search string changed"))));const[w,f]=D.useSourceSearch(s,t!=null?t:"",void 0,1,{skipRequest:!t,addAbortSignal:!0}),{data:j,isLoading:S,error:g,abortRequest:R}=f[0];d.current=R;const E=(M=(L=j==null?void 0:j.fetchSourceManga)==null?void 0:L.mangas)!=null?M:[],b=!g&&!S&&!E.length;u.useEffect(()=>{i(n,{isLoading:S,hasResults:!b,emptySearch:!t,error:g})},[S,b,t,g]);let x;return g?x=o("search.error.label.source_search_failed"):b&&(x=o("manga.error.label.no_mangas_found")),!S&&!t||a||r&&(b||g)?null:e.jsxs(P,{sx:{pb:2},children:[e.jsx(ye,{sx:{mb:1},children:e.jsxs(be,{component:te,to:ee.sources.childRoutes.browse.path(s,t),sx:{p:1,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(P,{children:[e.jsx(q,{variant:"h5",children:c}),e.jsx(q,{variant:"caption",children:pe(h)})]}),e.jsx(re,{title:o("global.button.show_more"),children:e.jsx(oe,{...xe.preventRippleProp(),children:e.jsx(se,{})})})]})}),x?e.jsx(ne,{sx:{alignItems:"start",height:void 0},noFaces:!0,message:x,messageExtra:A(g),retry:g?()=>w(1).catch(N("SourceSearchPreview(".concat(n.id,")::refetch"))):void 0}):e.jsx(ge,{gridWrapperProps:{sx:{px:0}},mangas:E,isLoading:S,hasNextPage:!1,loadMore:()=>{},horizontal:!0,noFaces:!0,message:x,inLibraryIndicator:!0,mode:p},t)]})}),jt=()=>{var _;const{t:n}=O(),i=U(),{pathname:t,state:a}=Q(),{ref:p,height:r}=je(),o=(_=a==null?void 0:a.shouldShowOnlyPinnedSources)!=null?_:!0,s=t.startsWith("/migrate/source"),[c]=ie("query",ce),h=z(c,Ee),[l,d]=V("shownSourceLangs",J()),{settings:{showNsfw:y,shouldShowOnlySourcesWithResults:w}}=K(),{data:f,loading:j,error:S,refetch:g}=D.useGetSourceList({notifyOnNetworkStatusChange:!0}),R=u.useMemo(()=>{var m;return(m=f==null?void 0:f.sources.nodes)!=null?m:[]},[f==null?void 0:f.sources.nodes]),[E,b]=u.useState(new Map),x=z(E,500),L=u.useMemo(()=>T.getLanguages(R),[R]),M=u.useMemo(()=>T.filter(R,{showNsfw:y,languages:l,keepLocalSource:!0,pinned:o}),[R,l,o]),I=u.useMemo(()=>[...M].toSorted(Le),[M]),H=u.useMemo(()=>[...I].sort((m,v)=>Me(m,v,x)),[I,x]),$=u.useCallback(({id:m},v)=>{b(W=>{const k=new Map(W);return k.set(m,v),k})},[b]),G=Y(m=>ae(n("global.error.label.failed_to_save_changes"),"error",A(m)));return Se(n(s?"migrate.search.title":"search.title.global_search",{title:a==null?void 0:a.mangaTitle}),e.jsxs(e.Fragment,{children:[e.jsx(ue,{isClosable:!1}),e.jsx(he,{selectedLanguages:l,setSelectedLanguages:d,languages:L})]}),[l,d,L]),j?e.jsx(X,{}):S?e.jsx(fe,{message:n("global.error.label.failed_to_load_data"),messageExtra:A(S),retry:()=>g().catch(N())}):e.jsxs(P,{sx:{position:"relative",px:1,pb:1},children:[e.jsxs(F,{ref:p,sx:{width:"100%",position:"fixed",zIndex:1,flexDirection:"row",gap:2,pt:1,pb:2,background:m=>m.palette.background.default},children:[e.jsxs(F,{sx:{flexDirection:"row",gap:1},children:[e.jsx(C,{startIcon:e.jsx(le,{}),variant:o?"contained":"outlined",onClick:()=>i({pathname:"",search:c?"query=".concat(c):""},{replace:!0,state:{...a,shouldShowOnlyPinnedSources:!0}}),children:n("global.label.pinned")}),e.jsx(C,{startIcon:e.jsx(me,{}),variant:o?"outlined":"contained",onClick:()=>i({pathname:"",search:c?"query=".concat(c):""},{replace:!0,state:{...a,shouldShowOnlyPinnedSources:!1}}),children:n("extension.language.all")})]}),e.jsx(C,{startIcon:e.jsx(de,{}),variant:w?"contained":"outlined",onClick:()=>G("shouldShowOnlySourcesWithResults",!w),children:n("search.filter.has_results")})]}),e.jsx(P,{sx:{pt:"".concat(r,"px")},children:H.map(m=>e.jsx(Pe,{source:m,onSearchRequestFinished:$,searchString:h,emptyQuery:!c,mode:s?"migrate.select":"source",shouldShowOnlySourcesWithResults:w},m.id))})]})};export{jt as SearchAll};
