import{c as r,l as ye,j as t,B as V,a as K,r as le,i as de,F as at,ao as Pt,ap as yt,aq as Et,ar as bt,as as Xe,x as ue,u as st,A as Lt,e as ot,at as it,au as St,av as Dt,aw as ne,f as ae,I as se,T as kt,ax as jt,a3 as Tt,ay as _t,a1 as Ke,az as Nt,a4 as At,aA as Ot,aB as Ue,p as Ge,N as It,m as Ye,h as Y,M as $t,a6 as Mt,E as Ze,aC as Wt,aD as zt}from"./index-CcCQevVR.js";import{b as Z,C as A}from"./Chapters-DdxNJrI9.js";import{P as he,R as Bt,u as Ft,g as Qe,c as Ht}from"./ReaderSettingsOptions-CA63Xqay.js";import{S as Je}from"./Select-BKCPXu5E.js";import{C as qt}from"./CustomIconButton-Bw_R1CY6.js";import{C as Vt}from"./Collapse-C4h6KI5S.js";import{a as et}from"./TextField-DlsyrlB4.js";import{u as Xt}from"./useDebounce-Bjain5Om.js";import"./NumberSetting-CON6kMdW.js";import"./Info-CkxmG1sK.js";import"./InputAdornment-BLbDYZqi.js";import"./SpinnerImage-Bxy4Mp8Z.js";import"./Switch-CmQZzvyj.js";import"./SwitchBase-BQJu54st.js";const Kt=a=>{for(let o=0;o<a.children.length;o++){const l=a.children.item(o);if(l){const{left:g,right:u}=l.getBoundingClientRect();if(g<=window.innerWidth/2&&u>window.innerWidth/2)return o}}return-1},Ut=5,Gt=()=>window.innerWidth+window.scrollX>=document.body.scrollWidth-Ut,Yt=()=>window.scrollX<=0;function Zt(a){const{pages:o,curPage:l,initialPage:g,settings:u,setCurPage:p,prevChapter:L,nextChapter:w}=a,f=r.useRef(g),d=r.useRef(null),h=r.useRef([]);function E(){var e;l<o.length-1?((e=h.current[l+1])==null||e.scrollIntoView({inline:"center"}),p(s=>s+1)):u.loadNextOnEnding&&w()}function i(){var e;l>0?((e=h.current[l-1])==null||e.scrollIntoView({inline:"center"}),p(l-1)):l===0&&L()}function b(){u.readerType==="ContinuesHorizontalLTR"?i():E()}function k(){u.readerType==="ContinuesHorizontalLTR"?E():i()}const P=r.useRef(0);function c(e){window.scrollBy(P.current-e.pageX,0)}function n(e){var s;P.current=e.pageX,(s=d.current)==null||s.addEventListener("mousemove",c)}function x(){var e;(e=d.current)==null||e.removeEventListener("mousemove",c)}function j(e){e.clientX>=window.innerWidth*.85?k():e.clientX<=window.innerWidth*.15&&b()}function _(e){window.scrollBy({left:u.readerType==="ContinuesHorizontalLTR"?e.deltaY:e.deltaY*-1})}const B=()=>{u.readerType==="ContinuesHorizontalLTR"?window.scrollX+window.innerWidth>=document.body.scrollWidth&&w():u.readerType==="ContinuesHorizontalRTL"&&window.scrollX<=window.innerWidth&&w()};return ye(h.current[g],r.useCallback((e,s)=>{const y=h.current[g];y!=null&&y.offsetHeight&&(y.scrollIntoView({inline:"center"}),s.disconnect())},[h.current[g],g])),r.useEffect(()=>{var e,s;return(e=d.current)==null||e.addEventListener("mousedown",n),(s=d.current)==null||s.addEventListener("mouseup",x),()=>{var y,R;(y=d.current)==null||y.removeEventListener("mousedown",n),(R=d.current)==null||R.removeEventListener("mouseup",x)}},[d]),r.useEffect(()=>(u.loadNextOnEnding&&document.addEventListener("scroll",B),()=>{document.removeEventListener("scroll",B)}),[d,l,L,w]),r.useEffect(()=>{const e=()=>{if(!d.current)return;const s=Kt(d.current);s!==f.current&&(f.current=s,p(s)),(u.readerType==="ContinuesHorizontalLTR"?Gt():Yt())&&(f.current=o.length-1,p(f.current))};return window.addEventListener("scroll",e),()=>window.removeEventListener("scroll",e)},[u.readerType]),t.jsx(V,{ref:d,sx:{display:"flex",flexDirection:u.readerType==="ContinuesHorizontalLTR"?"row":"row-reverse",justifyContent:u.readerType==="ContinuesHorizontalLTR"?"flex-start":"flex-end",width:"auto",height:"auto",overflowX:"visible",userSelect:"none"},onClick:j,onWheel:_,children:o.map(e=>t.jsx(he,{index:e.index,src:e.src,onImageLoad:()=>{},settings:u,ref:s=>{h.current[e.index]=s}},e.index))})}function Qt(a){const{settings:o,curPage:l,pageCount:g}=a;return t.jsx(V,{sx:{display:o.showPageNumber?"block":"none",position:"fixed",bottom:"50px",padding:"2px",paddingLeft:"4px",paddingRight:"4px",textAlign:"center",backgroundColor:"rgba(0, 0, 0, 0.3)",borderRadius:"10px"},children:"".concat(l+1," / ").concat(g)})}function Jt(a){const{pages:o,settings:l,setCurPage:g,initialPage:u,curPage:p,nextChapter:L,prevChapter:w,chapter:f}=a,d=r.useRef(null);r.useEffect(()=>{const n=o.map(x=>{const j=K.requestImage(x.src);return j.response.catch(()=>{}),j});return()=>{n.forEach(x=>x.abortRequest(new Error("PagedPager::preload: chapter changed")))}},[f.id]);const h=n=>{g(n),window.scroll({top:0})};function E(){p<o.length-1?h(p+1):l.loadNextOnEnding&&L()}function i(){p>0?h(p-1):w()}function b(){l.readerType==="SingleLTR"?i():l.readerType==="SingleRTL"&&E()}function k(){l.readerType==="SingleLTR"?E():l.readerType==="SingleRTL"&&i()}function P(n){switch(n.key){case"Space":n.preventDefault(),E();break;case"ArrowRight":k();break;case"ArrowLeft":b();break}}function c(n){n.clientX>window.innerWidth/2?k():b()}return r.useEffect(()=>(document.addEventListener("keydown",P),()=>{document.removeEventListener("keydown",P)}),[d,p,l.readerType,w,L]),r.useEffect(()=>{setTimeout(()=>{h(u)},0)},[u]),t.jsx(V,{ref:d,sx:{display:"flex",flexDirection:"column",justifyContent:"center",width:"auto",height:"auto"},onClick:c,children:o.map(({index:n,src:x})=>t.jsx(he,{index:n,onImageLoad:()=>{},src:x,settings:l,display:n===p},x))})}const er=a=>a.height/a.width<1;function tr(a){const{pages:o,settings:l,setCurPage:g,initialPage:u,curPage:p,chapter:L,nextChapter:w,prevChapter:f}=a,d=r.useRef(null),h=r.useRef([]),E=r.useRef([]),[i,b]=r.useState(Array(o.length).fill(!1)),[k,P]=r.useState(Array(o.length).fill(!1));function c(){const e=R=>g(R===-1?o.length-1:R);if(h.current[o.length-1]&&l.loadNextOnEnding){p===o.length-1||e(o.length-1),w();return}const y=h.current.findIndex((R,N)=>!R&&N>p);e(y)}function n(){const e=R=>g(Math.max(R,0));if(h.current[0]){!p||e(0),f();return}const y=[...h.current].slice(0,p).findLastIndex(R=>!R);e(y)}function x(){l.readerType==="DoubleLTR"?n():c()}function j(){l.readerType==="DoubleLTR"?c():n()}function _(e){switch(e.key){case"Space":e.preventDefault(),c();break;case"ArrowRight":j();break;case"ArrowLeft":x();break}}function B(e){e.clientX>window.innerWidth/2?j():x()}return r.useEffect(()=>(document.addEventListener("keydown",_),()=>{document.removeEventListener("keydown",_)}),[d,p,l.readerType,f,w,k,i]),r.useEffect(()=>{g(u)},[u]),r.useEffect(()=>{const e=o.map(s=>[s.index,K.requestImage(s.src)]);return e.forEach(async([s,y])=>{try{const R=await y.response,N=new Image;N.onload=()=>{URL.revokeObjectURL(R),P(I=>I.toSpliced(s,1,!0)),b(I=>I.toSpliced(s,1,er(N)))},N.src=R}catch(R){}}),()=>{e.forEach(([s,y])=>y.abortRequest(new Error("DoublePagedPager::preload(".concat(s,"): chapter changed"))))}},[L.id]),t.jsx(V,{ref:d,onClick:B,children:t.jsx(V,{id:"display",sx:{display:"flex",flexDirection:l.readerType==="DoubleLTR"?"row":"row-reverse",justifyContent:"center",width:"auto",height:"auto"},children:o.map(({index:e,src:s})=>{const y=(()=>{let H=E.current[p];return H===void 0&&(H=Math.max(i.lastIndexOf(!0,p),0),k.slice(0,p).every(Boolean)&&(E.current[p]=H)),H>0?H+1:H})(),R=p-y,N=p===0,I=Number(l.offsetFirstPage)+Number(l.offsetFirstPage&&!R&&!N),U=!((R-I)%2),m=p+(U?1:-1),S=e===p,$=e===m,M=i[p],X=i[m],q=S||$&&!(M||X);return h.current[e]=q,t.jsx(he,{index:e,src:s,onImageLoad:()=>{},settings:l,display:q},s)})})})}const rr=a=>{for(let o=0;o<a.children.length;o++){const l=a.children.item(o);if(l){const{top:g,bottom:u}=l.getBoundingClientRect();if(g<=window.innerHeight&&u>1)return o}}return-1},nr=5,ar=.95,tt=.25,sr="smooth",rt=()=>window.innerHeight+window.scrollY>=document.body.offsetHeight-nr,or=()=>window.scrollY<=0;function nt(a){const{pages:o,settings:l,setCurPage:g,initialPage:u,nextChapter:p,prevChapter:L}=a,w=r.useRef(u),f=r.useRef(null),d=r.useRef([]);r.useEffect(()=>{let c=!1;const n=()=>{if(f.current)if(rt()){if(c)return;c=!0,w.current=o.length-1,g(w.current),l.loadNextOnEnding&&p()}else{c=!1;const x=rr(f.current);x!==w.current&&(w.current=x,g(x))}};return window.addEventListener("scroll",n),()=>{window.removeEventListener("scroll",n)}},[l.loadNextOnEnding,p]);const h=r.useRef(0),E=r.useRef(!1);function i(c){E.current=!0,window.scrollBy(0,h.current-c.pageY)}function b(c){var n;h.current=c.pageY,(n=f.current)==null||n.addEventListener("mousemove",i)}function k(){var c;(c=f.current)==null||c.removeEventListener("mousemove",i)}r.useEffect(()=>{var c,n;return(c=f.current)==null||c.addEventListener("mousedown",b),(n=f.current)==null||n.addEventListener("mouseup",k),()=>{var x,j;(x=f.current)==null||x.removeEventListener("mousedown",b),(j=f.current)==null||j.removeEventListener("mouseup",k)}},[f]);const P=r.useCallback((c,n=ar)=>{if(c==="down"&&rt()){p();return}if(c==="up"&&or()){L();return}window.scroll({top:window.scrollY+window.innerHeight*n*(c==="up"?-1:1),behavior:sr})},[p,L]);return r.useEffect(()=>{const c=n=>{switch(n.key){case"Space":n.preventDefault(),P(n.shiftKey?"up":"down");break;case"ArrowDown":n.preventDefault(),P(n.shiftKey?"up":"down",tt);break;case"ArrowRight":n.preventDefault(),P(n.shiftKey?"up":"down");break;case"ArrowUp":n.preventDefault(),P(n.shiftKey?"down":"up",tt);break;case"ArrowLeft":n.preventDefault(),P(n.shiftKey?"down":"up");break}};return document.addEventListener("keydown",c,!1),()=>{document.removeEventListener("keydown",c)}},[P]),ye(d.current[u],r.useCallback((c,n)=>{const x=d.current[u];x!=null&&x.offsetHeight&&(x.scrollIntoView(),n.disconnect())},[d.current[u],u])),t.jsx(V,{ref:f,sx:{display:"flex",flexDirection:"column",justifyContent:"center",width:"auto",height:"auto",userSelect:"none"},onClick:c=>{if(E.current){E.current=!1;return}P(c.clientX>window.innerWidth/2?"down":"up")},children:o.map(c=>t.jsx(he,{index:c.index,src:c.src,onImageLoad:()=>{},settings:l,ref:n=>{d.current[c.index]=n}},c.index))})}var Ee={},ir=de;Object.defineProperty(Ee,"__esModule",{value:!0});var ct=Ee.default=void 0,cr=ir(le()),lr=t;ct=Ee.default=(0,cr.default)((0,lr.jsx)("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Close");var be={},dr=de;Object.defineProperty(be,"__esModule",{value:!0});var ie=be.default=void 0,ur=dr(le()),pr=t;ie=be.default=(0,ur.default)((0,pr.jsx)("path",{d:"M15.41 16.59 10.83 12l4.58-4.59L14 6l-6 6 6 6z"}),"KeyboardArrowLeft");var Le={},fr=de;Object.defineProperty(Le,"__esModule",{value:!0});var ce=Le.default=void 0,gr=fr(le()),hr=t;ce=Le.default=(0,gr.default)((0,hr.jsx)("path",{d:"M8.59 16.59 13.17 12 8.59 7.41 10 6l6 6-6 6z"}),"KeyboardArrowRight");var Se={},xr=de;Object.defineProperty(Se,"__esModule",{value:!0});var lt=Se.default=void 0,mr=xr(le()),vr=t;lt=Se.default=(0,mr.default)((0,vr.jsx)("path",{d:"M7.41 8.59 12 13.17l4.59-4.58L18 10l-6 6-6-6z"}),"KeyboardArrowDown");var De={},Cr=de;Object.defineProperty(De,"__esModule",{value:!0});var dt=De.default=void 0,wr=Cr(le()),Rr=t;dt=De.default=(0,wr.default)((0,Rr.jsx)("path",{d:"M7.41 15.41 12 10.83l4.59 4.58L18 14l-6-6-6 6z"}),"KeyboardArrowUp");const Pr={entering:{transform:"none"},entered:{transform:"none"}},yr=r.forwardRef(function(o,l){const g=at(),u={enter:g.transitions.duration.enteringScreen,exit:g.transitions.duration.leavingScreen},{addEndListener:p,appear:L=!0,children:w,easing:f,in:d,onEnter:h,onEntered:E,onEntering:i,onExit:b,onExited:k,onExiting:P,style:c,timeout:n=u,TransitionComponent:x=Et,...j}=o,_=r.useRef(null),B=Pt(_,yt(w),l),e=m=>S=>{if(m){const $=_.current;S===void 0?m($):m($,S)}},s=e(i),y=e((m,S)=>{bt(m);const $=Xe({style:c,timeout:n,easing:f},{mode:"enter"});m.style.webkitTransition=g.transitions.create("transform",$),m.style.transition=g.transitions.create("transform",$),h&&h(m,S)}),R=e(E),N=e(P),I=e(m=>{const S=Xe({style:c,timeout:n,easing:f},{mode:"exit"});m.style.webkitTransition=g.transitions.create("transform",S),m.style.transition=g.transitions.create("transform",S),b&&b(m)}),F=e(k),U=m=>{p&&p(_.current,m)};return t.jsx(x,{appear:L,in:d,nodeRef:_,onEnter:y,onEntered:R,onEntering:s,onExit:I,onExited:F,onExiting:N,addEndListener:U,timeout:n,...j,children:(m,S)=>r.cloneElement(w,{style:{transform:"scale(0)",visibility:m==="exited"&&!d?"hidden":void 0,...Pr[m],...c,...w.props.style},ref:B,...S})})}),Er=ue("div")({zIndex:10}),br=ue("div")(({theme:a})=>({position:"fixed",top:0,left:0,minWidth:"240px",maxWidth:"400px",height:"100vh",overflowY:"auto",backgroundColor:a.palette.background.default,"& header":{backgroundColor:a.palette.action.hover,display:"flex",alignItems:"center",padding:"".concat(a.spacing(1)," ").concat(a.spacing(3)),transition:"left 2s ease"}})),Lr=ue("div")(({theme:a})=>({margin:"0 ".concat(a.spacing(2))})),Sr=ue("div")({display:"flex",flexWrap:"wrap",alignContent:"center",alignItems:"center",justifyContent:"center"}),Dr=ue("div")(({theme:a})=>({display:"grid",gridTemplateRows:"auto auto auto",gridTemplateColumns:"0fr 1fr 0fr",gridTemplateAreas:'"pre current next"',gridColumnGap:a.spacing(.5),margin:"".concat(a.spacing(1)," 0"),"& a":{textDecoration:"none",color:"inherit",display:"flex",flexWrap:"wrap",alignContent:"center"}}));function kr(a){var X;const{t:o}=st(),{setReaderNavBarWidth:l}=Lt(),g=at(),u=ot(),p=it(),{prevDrawerOpen:L,prevSettingsCollapseOpen:w}=(X=p.state)!=null?X:{},f=r.useRef(null);ye(f,r.useCallback(()=>{var v;((v=f.current)==null?void 0:v.offsetWidth)!==void 0&&l(f.current.offsetWidth)},[f.current])),r.useLayoutEffect(()=>()=>l(0),[f]);const{settings:d,setSettingValue:h,manga:E,chapter:i,chapters:b,curPage:k,scrollToPage:P,openNextChapter:c,retrievingNextChapter:n}=a,x=St(),j=r.useMemo(()=>new Set(b.map(({scanlator:v})=>v)).size>1,[b]),[_,B]=r.useState(d.staticNav||L),[e,s]=r.useState(!0),[y,R]=r.useState(d.staticNav||L),[N,I]=r.useState(0),[F,U]=r.useState(w!=null?w:!0),m=n,S=(v,O,q)=>{s(v!=="staticNav"),h(v,O,q)},$=v=>{B(v),R(v)},M=()=>{const v=window.pageYOffset;Math.abs(v-N)>20&&(R(v>N),I(v))};return r.useEffect(()=>{e&&$(d.staticNav)},[d.staticNav]),r.useEffect(()=>{window.addEventListener("scroll",M);const v=document.querySelector("#root"),O=document.querySelector("#appMainContainer");return v.style.display="flex",v.style.flexDirection="column",O.style.display="none",()=>{v.style.display="block",O.style.display="block",window.removeEventListener("scroll",M)}},[M]),t.jsxs(Er,{children:[t.jsx(Dt,{direction:ne("right","left"),in:_,timeout:200,appear:!1,mountOnEnter:!0,unmountOnExit:!0,children:t.jsxs(br,{ref:f,children:[t.jsxs("header",{children:[!d.staticNav&&t.jsx(ae,{title:o("reader.button.close_menu"),children:t.jsx(se,{edge:"start",color:"inherit","aria-label":"menu",onClick:()=>$(!1),size:"large",children:ne(t.jsx(ie,{}),t.jsx(ce,{}))})}),t.jsx(kt,{variant:"h6",component:"h1",sx:{textOverflow:"ellipsis",overflow:"hidden",py:1,flexGrow:1},children:i.name}),t.jsx(ae,{title:o("reader.button.exit"),children:t.jsx(se,{edge:"start",color:"inherit","aria-label":"menu",onClick:x,size:"large",sx:{mr:-1},children:t.jsx(ct,{})})})]}),t.jsxs(jt,{ContainerComponent:"div",sx:{"& span":{fontWeight:"bold"}},children:[t.jsx(Tt,{primary:o("reader.settings.title.reader_settings")}),t.jsxs(se,{edge:"start",color:"inherit","aria-label":"menu",disableRipple:!0,disableFocusRipple:!0,onClick:()=>U(!F),size:"large",children:[F&&t.jsx(dt,{}),!F&&t.jsx(lt,{})]})]}),t.jsx(Vt,{in:F,timeout:"auto",unmountOnExit:!0,children:t.jsx(Bt,{setSettingValue:S,staticNav:d.staticNav,showPageNumber:d.showPageNumber,loadNextOnEnding:d.loadNextOnEnding,skipDupChapters:d.skipDupChapters,fitPageToWindow:d.fitPageToWindow,scalePage:d.scalePage,readerType:d.readerType,offsetFirstPage:d.offsetFirstPage,readerWidth:d.readerWidth})}),t.jsx(_t,{sx:{my:1,mx:2}}),t.jsxs(Lr,{children:[t.jsxs(Sr,{children:[t.jsx("span",{children:o("reader.page_info.label.currently_on_page")}),t.jsx(et,{size:"small",sx:{mx:.5},disabled:m||i.pageCount===-1,children:t.jsx(Je,{value:i.pageCount>-1?"".concat(k):"",displayEmpty:!0,onChange:({target:{value:v}})=>{P(Number(v))},children:Array(Math.max(0,i.pageCount)).fill(1).map((v,O)=>t.jsx(Ke,{value:O,children:O+1},"Page#".concat(O)))})}),t.jsx("span",{children:o("reader.page_info.label.of_max_pages",{maxPages:i.pageCount})})]}),t.jsxs(Dr,{children:[t.jsx(ae,{title:o("reader.button.previous_chapter"),children:t.jsx(se,{sx:{gridArea:"pre"},disabled:m||i.sourceOrder<=1,onClick:()=>c(Z.PREV),children:ne(t.jsx(ie,{}),t.jsx(ce,{}))})}),t.jsx(et,{sx:{gridArea:"current"},size:"small",disabled:m||i.sourceOrder<1,children:t.jsx(Je,{value:i.sourceOrder>=1?"".concat(i.sourceOrder):"",displayEmpty:!0,onChange:({target:{value:v}})=>{u("/manga/".concat(E.id,"/chapter/").concat(v),{replace:!0,state:{prevDrawerOpen:_,prevSettingsCollapseOpen:F}})},children:b.map(({id:v,sourceOrder:O,name:q,chapterNumber:H,scanlator:Q})=>t.jsx(Ke,{value:O,children:"#".concat(H).concat(j&&Q!=null?" (".concat(Q,")"):""," | ").concat(q)},v))})}),t.jsx(ae,{title:o("reader.button.next_chapter"),children:t.jsx(se,{sx:{gridArea:"next"},disabled:m||i.sourceOrder<1||i.sourceOrder>=E.chapters.totalCount,onClick:()=>c(Z.NEXT),children:ne(t.jsx(ce,{}),t.jsx(ie,{}))})})]})]})]})}),t.jsx(yr,{in:!_,children:t.jsx(Nt,{in:!y,children:t.jsx(ae,{title:o("reader.button.open_menu"),children:t.jsx(qt,{sx:{position:"fixed",top:20,left:20,backgroundColor:"rgba(255, 255, 255, 0.75);",color:"black",...g.applyStyles("dark",{backgroundColor:"rgba(0, 0, 0, 0.75);",color:"white"})},size:"large",variant:"contained",onClick:()=>$(!0),children:ne(t.jsx(ce,{}),t.jsx(ie,{}))})})})})]})}const oe=a=>A.getFromCache(a,Wt,"CHAPTER_READER_FIELDS"),jr=a=>{switch(a){case"ContinuesVertical":case"Webtoon":return nt;case"SingleVertical":case"SingleRTL":case"SingleLTR":return Jt;case"DoubleVertical":case"DoubleRTL":case"DoubleLTR":return tr;case"ContinuesHorizontalLTR":case"ContinuesHorizontalRTL":return Zt;default:return nt}},Tr=a=>Array.from({length:a},(o,l)=>l),re={pageCount:-1,sourceOrder:-1,chapterCount:0,lastPageRead:0,name:"Loading...",manga:{id:-1}};function Kr(){var $e,Me,We,ze,Be,Fe,He,qe;const{t:a}=st(),o=ot(),l=it(),{chapterIndex:g,mangaId:u}=At(),p=r.useMemo(()=>({id:+u,title:"",thumbnailUrl:"",genre:[],inLibraryAt:0,lastReadAt:0,chapters:{totalCount:0},trackRecords:{totalCount:0}}),[u]),{data:L,loading:w,error:f,refetch:d}=K.useGetManga(Ot,u),h=r.useRef(null),E=Number(u)===(($e=h.current)==null?void 0:$e.mangaId)&&Number(g)===((Me=h.current)==null?void 0:Me.sourceOrder)&&((We=h.current)==null?void 0:We.pageCount)!==-1,i=(ze=L==null?void 0:L.manga)!=null?ze:p,{data:b,loading:k,error:P,refetch:c}=K.useGetChapters(Ue,{condition:{mangaId:Number(u),sourceOrder:Number(g)}},{notifyOnNetworkStatusChange:!0}),n=b==null?void 0:b.chapters.nodes[0],x=r.useRef(!1),{settings:{downloadAheadLimit:j}}=Ge(),_=!!j,B=()=>{var z;return h.current&&E?n&&((z=h.current)==null?void 0:z.pageCount)!==n.pageCount?n:h.current:(x.current=!1,n||null)};h.current=B();const e=(Be=h.current)!=null?Be:re,s=r.useRef(re);s.current===re&&(s.current=e),e.mangaId!==((Fe=s.current)==null?void 0:Fe.mangaId)&&(s.current=re);const[y,{loading:R,error:N}]=K.useGetChapterPagesFetch(e.id),I=()=>{k||y().then(()=>{x.current=!0}).catch(Y())};r.useEffect(()=>{I()},[e.id]);const[F,U]=r.useState(!1),[m,S]=r.useState(0),$=m===e.pageCount-1,M=Xt(m,$?0:1e3),[X,v]=r.useState(void 0),{setOverride:O,setTitle:q,readerNavBarWidth:H}=r.useContext(It),[Q,ke]=r.useState(!1),{data:xe,loading:ut,error:je,refetch:pt}=K.useGetMangaChapters(Ue,u,{nextFetchPolicy:"standby"}),C=xe==null?void 0:xe.chapters.nodes,me=w||k||ut||R||!x.current&&!P&&!N,Te=(qe=(He=f!=null?f:P)!=null?He:je)!=null?qe:N,{settings:ve,loading:_e}=Ft(),[D,Ne]=r.useState(Qe(i,ve)),{settings:pe}=Ge(),Ae=r.useMemo(()=>D.skipDupChapters?A.removeDuplicates(s.current,C!=null?C:[]):C!=null?C:[],[s.current,C,D.skipDupChapters]),ft=r.useMemo(()=>A.getNextChapters(e,C!=null?C:[],{offset:Z.PREV,skipDupe:D.skipDupChapters,skipDupeChapter:s.current}),[e,s.current,C,D.skipDupChapters]),gt=r.useMemo(()=>A.getNextChapters(e,C!=null?C:[],{skipDupe:D.skipDupChapters,skipDupeChapter:s.current}),[e,s.current,C,D.skipDupChapters]),fe=r.useMemo(()=>A.getNextChapter(e,C!=null?C:[],{offset:Z.PREV,skipDupe:D.skipDupChapters,skipDupeChapter:s.current}),[e,s.current,C,D.skipDupChapters]),J=r.useMemo(()=>A.getNextChapter(e,C!=null?C:[],{skipDupe:D.skipDupChapters,skipDupeChapter:s.current}),[e,s.current,C,D.skipDupChapters]),Oe=T=>{if(e===re)return;const W=()=>{if(!(!!T.isRead&&!!pe.deleteChaptersWhileReading)||!C)return[];const te=[e,...ft][pe.deleteChaptersWhileReading-1];if(!te)return[];const we=oe(te.id);return we.isRead&&A.isDeletable(we,pe.deleteChaptersWithBookmark)?D.skipDupChapters?A.getIds(A.addDuplicates([te],C)):A.getIds([te]):[]};(()=>{var Re;const ge=oe(e.id),te=((Re=T.lastPageRead)!=null?Re:0)/e.pageCount>.25;if(_&&i.inLibrary&&!!(ge!=null&&ge.isDownloaded)&&te){const Pe=J?oe(J.id):null;if(!(Pe!=null&&Pe.isDownloaded))return;const Ve=A.getNonRead(gt).map(G=>oe(G.id)).slice(-j).filter(G=>!G.isDownloaded).map(G=>G.id).filter(G=>!A.isDownloading(G));if(!Ve.length)return;A.download(Ve).catch(Y())}})();const Ce=D.skipDupChapters?A.getIds(A.addDuplicates([e],C!=null?C:[e])):[e.id];K.updateChapters(Ce,{...T,chapterIdsToDelete:W(),trackProgressMangaId:pe.updateProgressAfterReading&&T.isRead&&i.trackRecords.totalCount?i.id:void 0},{errorPolicy:"all"}).response.catch(Y())},ht=(T,W,z=!0)=>{Ne({...D,[T]:W}),z&&zt(i,[[T,W]]).catch(()=>Ye(a("reader.settings.error.label.failed_to_save_settings"),"warning"))},ee=r.useCallback(T=>{const W=T===Z.NEXT,z=W?J:fe;if(!z){Ye(a(W?"reader.error.label.next_chapter_does_not_exist":"reader.error.label.prev_chapter_does_not_exist"),"error");return}ke(!0),S(0),o("/manga/".concat(i.id,"/chapter/").concat(z.sourceOrder),{replace:!0,state:l.state}),ke(!1)},[i.id,fe==null?void 0:fe.id,J==null?void 0:J.id]);r.useEffect(()=>{if(me||!e){S(0);return}U(!0),e.lastPageRead===e.pageCount-1?S(0):S(e.lastPageRead)},[e,me]),r.useEffect(()=>{!(i!=null&&i.title)||e.name===a("global.label.loading")?q(a("reader.title")):q("".concat(i.title,": ").concat(e.name))},[a,i,e]),r.useEffect(()=>{!_e&&!w&&(Ht(i,"manga",ve).catch(Y()),Ne(Qe(i,ve)))},[_e,w]),r.useEffect(()=>(O({status:!0,value:t.jsx(kr,{settings:D,setSettingValue:ht,manga:i,chapter:e,chapters:Ae,curPage:m,scrollToPage:v,openNextChapter:ee,retrievingNextChapter:Q})}),()=>O({status:!1,value:t.jsx("div",{})})),[i,e,D,m,g,Q,ee,Ae]),r.useEffect(()=>{if(!F||e===re)return;const T=oe(e.id);if(M===(T==null?void 0:T.lastPageRead))return;const W=M!==-1,z=M===e.pageCount-1;(W||z)&&Oe({lastPageRead:W?M:void 0,isRead:z?!0:void 0})},[M,_]);const xt=r.useCallback(()=>{Oe({lastPageRead:e.pageCount-1,isRead:!0}),ee(Z.NEXT)},[e.pageCount,ee,e,i]),mt=r.useCallback(()=>{ee(Z.PREV)},[ee]),vt=$t.useGetScrollbarSize("height");if(me)return t.jsx(V,{sx:{height:"100vh",width:"100vw",display:"grid",placeItems:"center"},children:t.jsx(Mt,{thickness:5})});if(Te)return t.jsx(Ze,{message:a("global.error.label.failed_to_load_data"),messageExtra:Te.message,retry:()=>{f&&d().catch(Y()),P&&c().catch(Y()),je&&pt().catch(Y()),N&&I()}});if(!e.pageCount)return t.jsx(Ze,{message:a("reader.error.label.no_pages_found"),retry:I});const Ct=Tr(e.pageCount).map(T=>({index:T,src:K.getChapterPageUrl(u,g,T)})),wt=jr(D.readerType),Rt=X!=null?X:e.lastPageRead===e.pageCount-1?0:e.lastPageRead,Ie=D.staticNav?H:0;return t.jsxs(V,{sx:{display:"flex",flexDirection:"column",alignContent:"center",alignItems:"center",justifyContent:"center",minWidth:"calc((100vw - (100vw - 100%)) - ".concat(Ie,"px)"),minHeight:"calc(100vh - ".concat(vt,"px)"),marginLeft:"".concat(Ie,"px")},children:[t.jsx(Qt,{settings:D,curPage:m,pageCount:e.pageCount}),t.jsx(V,{sx:{alignSelf:"stretch"},children:t.jsx(wt,{pages:Ct,pageCount:e.pageCount,setCurPage:S,initialPage:Rt,curPage:m,settings:D,manga:i,chapter:e,nextChapter:xt,prevChapter:mt},e.id)})]})}export{Kr as Reader};
