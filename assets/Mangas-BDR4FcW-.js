import{X as N,e9 as M,r as u,bm as _,dA as S,az as v,as as T,m as D,g as G,c_ as U}from"./index-BxY--oUh.js";import{c as L,b as B,C as p}from"./Chapters-CZPgsnrp.js";import{a as W}from"./Asserts-CT4yz8Rx.js";var n=(A=>(A[A.MANGA=0]="MANGA",A[A.COMIC=1]="COMIC",A[A.WEBTOON=2]="WEBTOON",A[A.MANHWA=3]="MANHWA",A[A.MANHUA=4]="MANHUA",A))(n||{});const Q={id:-1},Y={id:-2},$="1 / 1.5",z={[N.Cancelled]:"manga.status.cancelled",[N.Completed]:"manga.status.completed",[N.Licensed]:"manga.status.licensed",[N.Ongoing]:"manga.status.ongoing",[N.OnHiatus]:"manga.status.hiatus",[N.PublishingFinished]:"manga.status.publishing_finished",[N.Unknown]:"manga.status.unknown"},F={...L,remove_from_library:{always:!0,bulkAction:!0},change_categories:{always:!1,bulkAction:!1},migrate:{always:!1,bulkAction:!1},track:{always:!1,bulkAction:!1}},R={...B,remove_from_library:{action:{single:"manga.action.library.remove.label.action",selected:"manga.action.library.remove.button.selected"},confirmation:"manga.action.library.remove.label.confirmation",success:"manga.action.library.remove.label.success",error:"manga.action.library.remove.label.error"},change_categories:{action:{single:"manga.action.category.label.action",selected:"manga.action.category.button.selected"},confirmation:"manga.action.category.label.confirmation",success:"manga.action.category.label.success",error:"manga.action.category.label.error"},migrate:{action:{single:"global.button.migrate",selected:"global.button.migrate"},success:"manga.action.migrate.label.success",error:"manga.action.migrate.label.error"},track:{action:{single:"manga.action.track.add.label.action",selected:"manga.action.track.add.label.action"},success:"manga.action.track.add.label.success",error:"manga.action.track.add.label.error"}},P={[n.MANGA]:[],[n.COMIC]:["8muses","allporncomic","ciayo comics","comicextra","comicpunch","cyanide","dilbert","eggporncomics","existential comics","hiveworks comics","milftoon","myhentaicomics","myhentaigallery","gunnerkrigg","oglaf","patch friday","porncomix","questionable content","readcomiconline","read comics online","swords comic","teabeer comics","xkcd"],[n.WEBTOON]:["mangatoon","manmanga","toomics","webcomics","webtoons","webtoon"],[n.MANHWA]:["hiperdex","hmanhwa","instamanhwa","manhwa18","manhwa68","manhwa365","manhwahentaime","manhwamanga","manhwatop","manhwa","manytoon","manwha","readmanhwa","skymanga","toonily","webtoonxyz"],[n.MANHUA]:["1st kiss manhua","hero manhua","manhuabox","manhuaus","manhuas","manhuas","readmanhua","wuxiaworld","manhua"]},H={[n.MANGA]:["manga.type.manga"],[n.COMIC]:["manga.type.comic"],[n.WEBTOON]:["manga.type.webtoon","manga.type.long_strip"],[n.MANHWA]:["manga.type.manhwa","manga.type.long_strip"],[n.MANHUA]:["manga.type.manhua","manga.type.long_strip"]},I=/\s*[,|、]\s*/;class a{static getIds(e){return e.map(t=>t.id)}static getFromCache(e,t=M,r="MANGA_BASE_FIELDS"){return u.graphQLClient.client.cache.readFragment({id:u.graphQLClient.client.cache.identify({__typename:"MangaType",id:e}),fragment:t,fragmentName:r})}static isNotDownloaded({downloadCount:e}){return e===0}static getNotDownloaded(e){return e.filter(a.isNotDownloaded)}static isFullyDownloaded({downloadCount:e,chapters:{totalCount:t}}){return e===t}static getFullyDownloaded(e){return e.filter(a.isFullyDownloaded)}static isPartiallyDownloaded(e){return!a.isNotDownloaded(e)&&!a.isFullyDownloaded(e)}static getPartiallyDownloaded(e){return e.filter(a.isPartiallyDownloaded)}static isUnread({unreadCount:e,chapters:{totalCount:t}}){return e===t}static getUnread(e){return e.filter(a.isUnread)}static isFullyRead({unreadCount:e}){return e===0}static getFullyRead(e){return e.filter(a.isFullyRead)}static isPartiallyRead(e){return!a.isUnread(e)&&!a.isFullyRead(e)}static getPartiallyRead(e){return e.filter(a.isPartiallyRead)}static getThumbnailUrl(e){const t=e.thumbnailUrl?"".concat(e.thumbnailUrl,"?fetchedAt=").concat(e.thumbnailUrlLastFetched):"";return u.getValidImgUrlFor(t)}static getDuplicateLibraryMangas(e){return u.getMangas(_,{condition:{inLibrary:!0},filter:{title:{likeInsensitive:e}}})}static async getChapterIdsWithState(e,t){const{data:r}=await u.getMangasChapterIdsWithState(e,t).response;return r.chapters.nodes}static async downloadChapters(e,{size:t,onlyUnread:r,downloadAhead:i=!1}={},o){const[c,l]=await Promise.all([a.getChapterIdsWithState(e,{isRead:r?!1:void 0,isDownloaded:!1}),i?a.getChapterIdsWithState(e,{isRead:!1,isDownloaded:!0}):[]]),m=e.map(h=>[String(h),t]),d=Object.groupBy(c,({mangaId:h})=>h),s=Object.groupBy(l,({mangaId:h})=>h),b=Object.entries(s).map(([h,f=[]])=>{const w=Math.max(0,(t!=null?t:f.length)-f.length);return[h,i?w:t]}),y=Object.entries(Object.fromEntries([...m,...b])).map(([h,f])=>{var E;const w=(E=d[Number(h)])!=null?E:[];if(!w.length)return[];if(f===void 0)return w;const C=p.removeDuplicates(w[0],w).slice(0,f);return p.addDuplicates(C,w)}).flat();return y.length?p.download(p.getIds(y),o):Promise.resolve()}static async deleteChapters(e,t){const r=await a.getChapterIdsWithState(e,{isDownloaded:!0});return p.delete(p.getIds(r),t)}static async markAsRead(e,t=!1,r){const i=await a.getChapterIdsWithState(e,{isRead:!1});return p.markAsRead(i,t,e.length===1?e[0]:void 0,r)}static async markAsUnread(e,t){const r=await a.getChapterIdsWithState(e,{isRead:!0});return p.markAsUnread(p.getIds(r),t)}static async removeFromLibrary(e,t){const{removeMangaFromCategories:r}=await S();return a.executeAction("remove_from_library",e.length,()=>u.updateMangas(e,{updateMangas:{inLibrary:!1},updateMangasCategories:r?{clearCategories:!0}:void 0}).response,t)}static async changeCategories(e,t,r){return a.executeAction("change_categories",e.length,()=>u.updateMangasCategories(e,t).response,r)}static migrateChapters(e,t,r,i){var s,b;if(!t.chapters||!((s=r.fetchChapters)!=null&&s.chapters))throw new Error("Chapters are missing");const o=t.chapters.nodes,c=(b=r.fetchChapters)==null?void 0:b.chapters,l=p.getMatchingChapterNumberChapters(o,c),m=[],d=[];return l.forEach(([g,y])=>{const{isRead:h,isBookmarked:f}=g;h&&m.push(y.id),f&&d.push(y.id)}),{copy:()=>[m.length&&u.updateChapters(m,{isRead:!0}).response,d.length&&u.updateChapters(d,{isBookmarked:!0}).response].filter(g=>!!g),cleanup:()=>{var g,y;return e==="migrate"?[i?u.deleteDownloadedChapters(p.getIds(p.getDownloaded((y=(g=t.chapters)==null?void 0:g.nodes)!=null?y:[]))).response:Promise.resolve()]:[]}}}static migrateTracking(e,t,r){if(!t.trackRecords)throw new Error("TrackRecords of manga to migrate are missing");if(!r.trackRecords)throw new Error("TrackRecords of manga to migrate to are missing");const i=t.trackRecords.nodes.filter(o=>{var c;return(c=r.trackRecords)==null?void 0:c.nodes.every(l=>o.remoteId!==l.remoteId)});return{copy:()=>i.map(o=>u.bindTracker(r.id,o.trackerId,o.remoteId,o.private).response),cleanup:()=>{var o,c;return e==="migrate"?(c=(o=t.trackRecords)==null?void 0:o.nodes.map(l=>u.unbindTracker(l.id).response))!=null?c:[]:[]}}}static migrateManga(e,t,r,i,o){if(i&&!(t!=null&&t.categories))throw new Error("Categories are missing");return{copy:()=>{var c;return[u.updateManga(r.id,{updateManga:{inLibrary:!0},updateMangaCategories:i?{addToCategories:(c=t.categories)==null?void 0:c.nodes.map(l=>l.id)}:void 0}).response]},cleanup:()=>e==="migrate"?[u.updateManga(t.id,{updateManga:{inLibrary:!1},updateMangaCategories:o?{clearCategories:!0}:void 0}).response]:[]}}static async migrate(e,t,{mode:r,migrateChapters:i,migrateCategories:o,migrateTracking:c,deleteChapters:l},m){return a.executeAction("migrate",1,async()=>{var h,f;const[{data:d},{data:s},{removeMangaFromCategories:b}]=await Promise.all([u.getMangaToMigrate(e,{migrateChapters:i,migrateCategories:o,migrateTracking:c,deleteChapters:l}).response,u.getMangaToMigrateToFetch(t,{migrateChapters:i,migrateCategories:o,migrateTracking:c,apolloOptions:{errorPolicy:"all"}}).response,S()]);if(!d.manga||!((h=s==null?void 0:s.fetchManga)!=null&&h.manga))throw new Error("Mangas::migrate: missing manga data");if(i&&!d.manga.chapters)throw new Error("Mangas::migrate: missing chapters data");(f=s.fetchChapters)!=null&&f.chapters||(s.fetchChapters={chapters:[]});const g=async(w,...O)=>Promise.all(O.map(k=>k[w]()).flat());await(async(...w)=>{const O=["copy","cleanup"],k=w.filter(([C])=>C).map(([,C])=>C());for(const C of O)await g(C,...k)})([i,()=>a.migrateChapters(r,d.manga,s,!!l)],[c,()=>a.migrateTracking(r,d.manga,s.fetchManga.manga)],[!0,()=>a.migrateManga(r,d.manga,s.fetchManga.manga,!!o,b)])},m)}static async executeAction(e,t,r,i){const{always:o,bulkAction:c,bulkActionCountForce:l}=F[e],m=!i&&(o||c&&t>1||l&&t>=l),d=R[e].confirmation;try{if(m){W(d);try{await v.confirm({title:T("global.label.are_you_sure"),message:T(d,{count:t}),actions:{confirm:{title:T("global.button.ok")}}})}catch(s){return}}await r(),D(T(R[e].success,{count:t}),"success")}catch(s){throw D(T(R[e].error,{count:t}),"error",G(s)),s}}static async performAction(e,t,{wasManuallyMarkedAsRead:r,changeCategoriesPatch:i,mangaIdToMigrateTo:o,downloadAhead:c,onlyUnread:l,size:m,...d},s){switch(e){case"download":return a.downloadChapters(t,{downloadAhead:c,onlyUnread:l,size:m},s);case"delete":return a.deleteChapters(t,s);case"mark_as_read":return a.markAsRead(t,r,s);case"mark_as_unread":return a.markAsUnread(t,s);case"remove_from_library":return a.removeFromLibrary(t,s);case"change_categories":return a.changeCategories(t,i,s);case"migrate":return a.migrate(t[0],o,d,s);default:throw new Error('Mangas::performAction: unknown action "'.concat(e,'"'))}}static getType(e){return a.isType(e,n.MANGA)?n.MANGA:a.isType(e,n.COMIC)?n.COMIC:a.isType(e,n.WEBTOON)?n.WEBTOON:a.isType(e,n.MANHWA)?n.MANHWA:a.isType(e,n.MANHUA)?n.MANHUA:n.MANGA}static isType(e,t){var l,m;const r=Object.entries(H).map(([d,s])=>{var b;return[d,["en",U.language,(b=e.source)==null?void 0:b.lang].filter(g=>!!g).flatMap(g=>s.flatMap(y=>T(y,{lng:g})))]}),i=Object.fromEntries(r),o=e.genre.some(d=>i[t].some(s=>d.toLowerCase().includes(s.toLowerCase()))),c=P[t].includes((m=(l=e.source)==null?void 0:l.name.toLowerCase())!=null?m:"");return o||c}static isLongStripType(e){return a.isType(e,n.WEBTOON)||a.isType(e,n.MANHWA)||a.isType(e,n.MANHUA)}static getArtists(e){var t;return(t=e.artist)==null?void 0:t.split(I)}static getAuthors(e){var t;return(t=e.author)==null?void 0:t.split(I)}static createLocationState(e,t){return{mangaTitle:e.title,mode:t}}}export{Q as F,Y as G,z as M,a,$ as b,R as c};
