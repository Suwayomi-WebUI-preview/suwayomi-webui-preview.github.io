import{u as R,r as D,Z as Se,_ as ue,x as G,j as t,$ as _,a0 as je,a1 as I,a2 as ke,a3 as _e,a4 as v,a5 as T,a6 as E,y as Me,q as ne,n as ie,i as b,a7 as pe,l as be,I as Te,a8 as Ae,a9 as K,aa as Fe,ab as Le,ac as Ie,o as P,ad as we,ae as Be,af as Re,g as Oe,E as ce,m as ve,N as Ee,O as Ne,ag as De,P as Ge}from"./index-BgT5c6fp.js";import{u as me,S as Ue,A as Pe,N as ze}from"./AppbarSearch-3QfVF9Mf.js";import{F as Ke}from"./FilterList-EUHrNUJL.js";import{S as We,R as z}from"./SortRadioInput-C6YDY4vp.js";import{O as Ye,S as He,a as Ve}from"./SelectionFAB-C4oTXdKo.js";import{T as Qe}from"./Trackers-D4pSmk7a.js";import{R as Ze}from"./ListPreference-CemQQtnj.js";import{M as $e,a as Je}from"./MangaGrid-BIhuc94T.js";import{C as Xe,U as qe}from"./UpdateChecker-DLg_o79C.js";import{T as ea}from"./TabsWrapper-CrM28big.js";import{C as aa}from"./Chip-BONGXZ4-.js";import"./ChaptersDownloadActionMenuItems-Dafbe8ug.js";import"./Avatar-C20SlF-x.js";import"./CheckCircle-CdlpPTgz.js";import"./NumberSetting-fmLnA9A6.js";import"./useMobilePicker-DUBn37KM.js";import"./SelectSetting-CQOQRaDP.js";import"./StyledFab-B97dIPRR.js";import"./Sync-BBPTzzXO.js";import"./PlayArrow-C67GgLrn.js";import"./Progress-CDvD-rRL.js";const ta={filter:"global.label.filter",sort:"global.label.sort",display:"global.label.display"},sa=[["unreadChapters","library.option.sort.label.by_unread_chapters"],["totalChapters","library.option.sort.label.by_total_chapters"],["alphabetically","library.option.sort.label.alphabetically"],["dateAdded","library.option.sort.label.by_date_added"],["lastRead","library.option.sort.label.by_last_read"],["latestFetchedChapter","library.option.sort.label.by_latest_fetched_chapter"],["latestUploadedChapter","library.option.sort.label.by_latest_uploaded_chapter"]],ra=({category:e,open:s,onClose:n})=>{var x,g;const{t:a}=R(),l=D.useGetTrackerList(Se),o=Qe.getLoggedIn((g=(x=l.data)==null?void 0:x.trackers.nodes)!=null?g:[]),r=ue(e),i=je(e,u=>ne(a("global.error.label.failed_to_save_changes"),"error",ie(u))),{settings:{showTabSize:p,showContinueReadingButton:f,showDownloadBadge:A,showUnreadBadge:y,gridLayout:m}}=G(),h=Me(u=>ne(a("search.error.label.failed_to_save_settings"),"error",ie(u)));return t.jsx(Ye,{open:s,onClose:n,tabs:["filter","sort","display"],tabTitle:u=>a(ta[u]),tabContent:u=>u==="filter"?t.jsxs(t.Fragment,{children:[t.jsx(_,{label:a("global.filter.label.unread"),checked:r.hasUnreadChapters,onChange:d=>i("hasUnreadChapters",d)}),t.jsx(_,{label:a("global.filter.label.started"),checked:r.hasReadChapters,onChange:d=>i("hasReadChapters",d)}),t.jsx(_,{label:a("global.filter.label.downloaded"),checked:r.hasDownloadedChapters,onChange:d=>i("hasDownloadedChapters",d)}),t.jsx(_,{label:a("global.filter.label.bookmarked"),checked:r.hasBookmarkedChapters,onChange:d=>i("hasBookmarkedChapters",d)}),t.jsx(_,{label:a("global.filter.label.duplicate_chapters"),checked:r.hasDuplicateChapters,onChange:d=>i("hasDuplicateChapters",d)}),t.jsx(I,{sx:{mt:2},children:a("manga.label.status")}),Object.values(ke).map(d=>t.jsx(_,{label:a(_e[d]),checked:r.hasStatus[d],onChange:S=>i("hasStatus",{...r.hasStatus,[d]:S})},d)),t.jsx(I,{sx:{mt:2},children:a("global.filter.label.tracked")}),o.map(d=>t.jsx(_,{label:d.name,checked:r.hasTrackerBinding[d.id],onChange:S=>i("hasTrackerBinding",{...r.hasTrackerBinding,[d.id]:S})},d.id))]}):u==="sort"?sa.map(([d,S])=>t.jsx(We,{label:a(S),checked:r.sortBy===d,sortDescending:r.sortDesc,onClick:()=>d!==r.sortBy?i("sortBy",d):i("sortDesc",!r.sortDesc)},d)):u==="display"?t.jsxs(t.Fragment,{children:[t.jsx(I,{children:a("global.grid_layout.title")}),t.jsxs(Ze,{onChange:d=>v("gridLayout",Number(d.target.value)),value:m,children:[t.jsx(z,{label:a("global.grid_layout.label.compact_grid"),value:T.Compact,checked:m==null||m===T.Compact}),t.jsx(z,{label:a("global.grid_layout.label.comfortable_grid"),value:T.Comfortable,checked:m===T.Comfortable}),t.jsx(z,{label:a("global.grid_layout.label.list"),value:T.List,checked:m===T.List})]}),t.jsx(I,{sx:{mt:2},children:a("library.option.display.badge.title")}),t.jsx(E,{label:a("library.option.display.badge.label.unread_badges"),checked:y,onChange:()=>v("showUnreadBadge",!y)}),t.jsx(E,{label:a("library.option.display.badge.label.download_badges"),checked:A,onChange:()=>v("showDownloadBadge",!A)}),t.jsx(I,{sx:{mt:2},children:a("library.option.display.tab.title")}),t.jsx(E,{label:a("library.option.display.tab.label.show_number_of_items"),checked:p,onChange:()=>h("showTabSize",!p)}),t.jsx(I,{sx:{mt:2},children:a("global.label.other")}),t.jsx(E,{label:a("library.option.display.other.label.show_continue_reading_button"),checked:f,onChange:()=>v("showContinueReadingButton",!f)})]}):null})},la=({category:e})=>{const{t:s}=R(),[n,a]=b.useState(!1),{options:l}=pe(),o=l.hasDownloadedChapters!=null||l.hasUnreadChapters!=null||l.hasReadChapters!=null||l.hasBookmarkedChapters!=null||l.hasDuplicateChapters!=null||Object.values(l.hasStatus).some(r=>r!=null)||Object.values(l.hasTrackerBinding).some(r=>r!=null);return t.jsxs(t.Fragment,{children:[t.jsx(be,{title:s("settings.title"),children:t.jsx(Te,{onClick:()=>a(!n),color:o?"warning":"inherit",children:t.jsx(Ke,{})})}),t.jsx(ra,{category:e,open:n,onClose:()=>a(!1)})]})},oa=()=>{},de=({showFilteredOutMessage:e,message:s,messageExtra:n,...a})=>{const{t:l}=R(),{settings:{gridLayout:o}}=G();return b.useLayoutEffect(()=>(document.body.style.overflowY=o===T.List?"auto":"scroll",()=>{document.body.style.overflowY="auto"}),[]),t.jsx($e,{gridWrapperProps:{sx:{p:1}},...a,hasNextPage:!1,loadMore:oa,message:e?l("library.error.label.no_matches"):s,messageExtra:e?void 0:n,gridLayout:o})},na=({isActive:e,areAllItemsSelected:s,areNoItemsSelected:n,onSelectAll:a,onModeChange:l})=>{const{t:o}=R();return t.jsxs(t.Fragment,{children:[e&&t.jsx(He,{areAllItemsSelected:s,areNoItemsSelected:n,onChange:a}),t.jsx(be,{title:o(e?"global.button.cancel":"global.button.select_all"),children:t.jsx(Ae,{checkedIcon:t.jsx(Xe,{}),sx:{padding:"8px",color:"inherit","&.Mui-checked":{color:"inherit"}},checked:e,onChange:(r,i)=>l(i)})})]})},W=(e,s,n)=>{switch(e){case!0:return s();case!1:return n();default:return!0}},N=(e,s)=>W(e,()=>!!s&&s>=1,()=>s===0),Ce=(e,s)=>W(e,()=>!!s,()=>!s),M=(e,s)=>{const n=e==null?void 0:e.filter(r=>r!=null),a=s==null?void 0:s.filter(r=>r!=null);if(!(n!=null&&n.length))return!0;const l=n.map(K),o=a.map(K).join(", ");return l.every(r=>o.includes(r))},ia=(e,{title:s,genre:n,description:a,artist:l,author:o,source:r,sourceId:i})=>M([e],[s])||M(e==null?void 0:e.split(","),n.map(p=>K(p)))||M([e],[a])||M([e],[l])||M([e],[o])||M([e],[r==null?void 0:r.displayName])||M([e],[i]),ca=(e,s)=>Object.entries(e).map(([n,a])=>{const l=s.trackRecords.nodes.some(o=>o.trackerId===Number(n));return W(a,()=>l,()=>!l)}).every(Boolean),da=(e,s)=>Object.entries(e).map(([n,a])=>Ce(a,n===s.status)).every(Boolean),ha=(e,{hasDownloadedChapters:s,hasUnreadChapters:n,hasReadChapters:a,hasBookmarkedChapters:l,hasDuplicateChapters:o,hasTrackerBinding:r,hasStatus:i})=>N(s,e.downloadCount)&&N(n,e.unreadCount)&&N(a,e.chapters.totalCount-e.unreadCount)&&N(l,e.bookmarkCount)&&Ce(o,e.hasDuplicateChapters)&&ca(r,e)&&da(i,e),ga=(e,s,n)=>{const a=n.ignoreFilters&&(s==null?void 0:s.length);return e.filter(l=>{const o=ia(s,l),r=a||ha(l,n);return o&&r})},w=(e=0,s=0)=>Number(e)-Number(s),ua=(e,s)=>e.localeCompare(s),pa=(e,s,n)=>{const a=[...e];switch(s){case"alphabetically":a.sort((l,o)=>ua(l.title,o.title));break;case"dateAdded":a.sort((l,o)=>w(l.inLibraryAt,o.inLibraryAt));break;case"unreadChapters":a.sort((l,o)=>w(l.unreadCount,o.unreadCount));break;case"lastRead":a.sort((l,o)=>{var r,i;return w((r=l.lastReadChapter)==null?void 0:r.lastReadAt,(i=o.lastReadChapter)==null?void 0:i.lastReadAt)});break;case"latestUploadedChapter":a.sort((l,o)=>{var r,i;return w((r=l.latestUploadedChapter)==null?void 0:r.uploadDate,(i=o.latestUploadedChapter)==null?void 0:i.uploadDate)});break;case"latestFetchedChapter":a.sort((l,o)=>{var r,i;return w((r=l.latestFetchedChapter)==null?void 0:r.fetchedAt,(i=o.latestFetchedChapter)==null?void 0:i.fetchedAt)});break;case"totalChapters":a.sort((l,o)=>w(l.chapters.totalCount,o.chapters.totalCount));break}return n&&a.reverse(),a},ba={id:-1},ma=(e,s)=>{const[n]=me("query",Ue),a=ue(s!=null?s:ba),{hasUnreadChapters:l,hasReadChapters:o,hasDownloadedChapters:r,hasBookmarkedChapters:i,hasTrackerBinding:p,hasDuplicateChapters:f,hasStatus:A}=a,{settings:y}=G(),m=b.useMemo(()=>ga(e,n,{...a,ignoreFilters:y.ignoreFilters}),[e,n,l,o,r,i,p,f,A,y.ignoreFilters]),h=b.useMemo(()=>pa(m,a.sortBy,a.sortDesc),[m,a.sortBy,a.sortDesc]),x=Object.values(a.hasTrackerBinding).some(u=>u!=null),g=(l!=null||o!=null||r!=null||i!=null||!!n||x)&&m.length===0&&e.length>0;return{visibleMangas:h,showFilteredOutMessage:g}},he=De("span")({display:"flex",alignItems:"center"}),ge=({sx:e,...s})=>t.jsx(aa,{...s,size:"small",sx:{...e,marginLeft:"5px"}});function Da(){var ae,te,se,re,le,oe;const{t:e}=R(),{settings:{showTabSize:s}}=G(),{data:n,error:a,loading:l,refetch:o}=D.useGetCategories(Fe,{notifyOnNetworkStatusChange:!0}),r=n==null?void 0:n.categories.nodes.filter(c=>c.id!==0||c.id===0&&c.mangas.totalCount),i=r!=null?r:[],p=D.useGetMangas(Le,{}),f=(te=(ae=p.data)==null?void 0:ae.mangas.totalCount)!=null?te:0,[A,y]=me("tab",ze),{setOptions:m}=pe(),h=(se=i.find(c=>c.id===A))!=null?se:i[0];b.useLayoutEffect(()=>{m(Ie(h!=null?h:{id:-1}))},[h]);const{data:x,error:g,loading:u,refetch:d}=D.useGetCategoryMangas(h==null?void 0:h.id,{skip:!h,notifyOnNetworkStatusChange:!0}),S=(re=x==null?void 0:x.mangas.nodes)!=null?re:[],{visibleMangas:C,showFilteredOutMessage:Y}=ma(S,h),H=b.useCallback(()=>d().catch(P()),[d,h]),xe=b.useMemo(()=>C.map(c=>c.id),[C]),[j,O]=b.useState(!1),{areNoItemsForKeySelected:V,areAllItemsForKeySelected:Q,selectedItemIds:F,handleSelectAll:U,handleSelection:Z,clearSelection:fe}=we(C.length,{itemIds:xe,currentKey:h==null?void 0:h.id.toString()}),$=b.useCallback((c,k,L)=>{O(!!(F.length+(k?1:-1))),Z(c,k,L)},[O,Z]),J=b.useMemo(()=>F.map(c=>Be.getFromCache(c,Re,"MANGA_CHAPTER_STAT_FIELDS")).filter(c=>!!c),[F.length,C]),X=b.useMemo(()=>j?t.jsx(Ve,{selectedItemsCount:F.length,title:"manga.title",children:(c,k)=>t.jsx(Je,{selectedMangas:J,onClose:()=>{c(),O(!1),fe()},setHideMenu:k})}):null,[j,J]),{setTitle:q,setAction:ee}=Oe();b.useLayoutEffect(()=>{const c=e("library.title");return q(t.jsxs(he,{children:[c,s&&t.jsx(ge,{sx:{color:"inherit"},label:f})]}),c),ee(t.jsxs(t.Fragment,{children:[!j&&h&&t.jsxs(t.Fragment,{children:[t.jsx(Pe,{}),t.jsx(la,{category:h}),t.jsx(qe,{categoryId:h==null?void 0:h.id})]}),t.jsx(na,{isActive:j,areAllItemsSelected:Q,areNoItemsSelected:V,onSelectAll:L=>U(L,[...new Set(C.map(B=>B.id))]),onModeChange:L=>{O(L),L?U(!0,[...new Set(C.map(B=>B.id))]):i.forEach(B=>U(!1,[],B.id.toString()))}})]})),()=>{q(""),ee(null)}},[e,f,l,j,V,Q,C.length,h,s]);const ye=c=>{y(c)};return a!=null||p.error?t.jsx(ce,{message:e("global.error.label.failed_to_load_data"),messageExtra:(oe=a==null?void 0:a.message)!=null?oe:(le=p.error)==null?void 0:le.message,retry:()=>{a&&o().catch(P()),p.error&&p.refetch().catch(P())}}):l||p.loading?t.jsx(ve,{}):i.length===0?t.jsx(ce,{message:e("library.error.label.empty")}):i.length===1?t.jsxs(t.Fragment,{children:[t.jsx(de,{mangas:C,message:e(g?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:g==null?void 0:g.message,isLoading:u,selectedMangaIds:F,isSelectModeActive:j,handleSelection:$,showFilteredOutMessage:!g&&Y,retry:g&&H}),X]}):t.jsxs(ea,{children:[t.jsx(Ee,{value:h.id,onChange:(c,k)=>ye(k),children:i.map(c=>t.jsx(Ne,{sx:{flexGrow:1,maxWidth:"unset"},label:t.jsxs(he,{children:[c.name,s?t.jsx(ge,{label:c.mangas.totalCount}):null]}),value:c.id},c.id))}),i.map(c=>t.jsx(Ge,{index:c.order,currentIndex:h.order,children:c===h&&t.jsx(de,{mangas:C,message:e(g?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:g==null?void 0:g.message,isLoading:u,selectedMangaIds:F,isSelectModeActive:j,handleSelection:$,showFilteredOutMessage:!g&&Y,retry:g&&H})},c.order)),X]})}export{Da as Library};
