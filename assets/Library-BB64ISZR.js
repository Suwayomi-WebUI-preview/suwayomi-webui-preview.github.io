import{z as le,e as b,E as ke,F as Te,H as Me,i as N,u as L,r as D,J as _e,d as E,j as a,M as Ae,K as Fe,N as w,O as _,n as Be,m as ne,g as ie,C as ge,I as ve,P,Q as Le,R as Ie,U as we,V as Re,o as Oe,B as Ne,A as De,L as Ee,W as Ge,h as Ue}from"./index-B9sXdsff.js";import{u as z,S as ue,A as Pe,N as ze}from"./AppbarSearch-C8NH9atv.js";import{E as ce}from"./EmptyViewAbsoluteCentered-Bt5j7wSo.js";import{T as We,a as Ye}from"./Tabs-C7Ejmrhi.js";import{F as Ke}from"./FilterList-Cj2XPyls.js";import{C as R}from"./CheckboxInput-nGAGiIlk.js";import{S as Ve,R as U}from"./SortRadioInput-MzWhSjrJ.js";import{T}from"./ThreeStateCheckboxInput-kT5QDhvg.js";import{O as Je,S as He,a as Qe}from"./SelectionFAB-TbfUs51M.js";import{T as $e}from"./Trackers-COtG7wmP.js";import{F as B}from"./TextField-syre69i-.js";import{R as Xe}from"./ListPreference-DTyvDrL5.js";import{M as Ze,a as qe}from"./MangaGrid-B5cUxDaX.js";import{C as et,U as tt}from"./UpdateChecker-C0z0gicD.js";import{u as at}from"./useManageMangaLibraryState-DThiVL2r.js";import{C as st}from"./Checkbox-CplIld-b.js";import{T as rt}from"./TabsMenu-DXjvUJs1.js";import{T as ot}from"./TabsWrapper-CaK9XGPi.js";import{u as lt}from"./useAppTitle-DSyYosGS.js";import{u as nt}from"./useAppAction-DLir27iw.js";import{C as it}from"./Chip-B3wcQm6N.js";import"./ChaptersDownloadActionMenuItems-Cf_rb7pK.js";import"./Card-DbJySDoj.js";import"./ListCardContent-B7hvkgHx.js";import"./Avatar-BQ4KlAHq.js";import"./InputAdornment-DtSjeSvy.js";import"./useFormControl-DktQh-yB.js";import"./CheckCircle-U6zAnUBW.js";import"./Metadata-CHXI9Ipx.js";import"./MUI.util-CYBuX_Wz.js";import"./CardActionArea-DMEvphnQ.js";import"./Link-B5ijOrpF.js";import"./NumberSetting-NzOj-zwR.js";import"./Slider-Dw34jcFb.js";import"./useMobilePicker-Dw1ct5r-.js";import"./SelectSetting-s95c1gQI.js";import"./Select-mBzvVLN6.js";import"./FormGroup-CfHB8UxR.js";import"./formControlState-Dq1zat_P.js";import"./StyledFab-tSHcntjY.js";import"./SwitchBase-CNV_Zt6H.js";import"./Delete-CcMybldr.js";import"./Download-B2ss5cI2.js";import"./Sync-CYvcIWmb.js";import"./use-merged-ref-CyP4J_9T.js";import"./ListCardAvatar-CjrqL715.js";import"./PlayArrow-DIerWG-6.js";import"./index-DPIX3ULs.js";import"./Virtuoso.util-BKiqqNun.js";import"./Progress-KlAi91gj.js";const ct={sortDesc:void 0,sortBy:void 0,hasDownloadedChapters:void 0,hasBookmarkedChapters:void 0,hasUnreadChapters:void 0,hasReadChapters:void 0,hasDuplicateChapters:void 0,hasTrackerBinding:{},hasStatus:{}},me=e=>({...e,hasTrackerBinding:e.hasTrackerBinding?JSON.stringify(e.hasTrackerBinding):void 0,hasStatus:e.hasStatus?JSON.stringify(e.hasStatus):void 0}),dt=e=>{var s,r;return{...e,hasTrackerBinding:(s=le(e.hasTrackerBinding))!=null?s:void 0,hasStatus:(r=le(e.hasStatus))!=null?r:void 0}},ht=(e,s=ct,r)=>dt(Te("category",e,me(s),void 0,r)),be=(e,s,r)=>ht({...e,meta:ke(e.meta)},s,r),pt=(e,s)=>be(e,s),Ce=(e,s)=>{const r=be(e,s,b.useEffect);return b.useMemo(()=>r,[e,s])},gt=async(e,s,r)=>Me(e,[[s,me({[s]:r})[s]]]),ut=(e,s=N())=>(r,t)=>gt(e,r,t).catch(s),mt={filter:"global.label.filter",sort:"global.label.sort",display:"global.label.display"},bt=[["unreadChapters","library.option.sort.label.by_unread_chapters"],["totalChapters","library.option.sort.label.by_total_chapters"],["alphabetically","library.option.sort.label.alphabetically"],["dateAdded","library.option.sort.label.by_date_added"],["lastRead","library.option.sort.label.by_last_read"],["latestFetchedChapter","library.option.sort.label.by_latest_fetched_chapter"],["latestUploadedChapter","library.option.sort.label.by_latest_uploaded_chapter"]],Ct=({category:e,open:s,onClose:r})=>{var S,p;const{t}=L(),l=D.useGetTrackerList(_e),n=$e.getLoggedIn((p=(S=l.data)==null?void 0:S.trackers.nodes)!=null?p:[]),o=Ce(e),i=ut(e,u=>ne(t("global.error.label.failed_to_save_changes"),"error",ie(u))),{settings:{showTabSize:m,showContinueReadingButton:y,showDownloadBadge:A,showUnreadBadge:x,gridLayout:g}}=E(),h=Be(u=>ne(t("search.error.label.failed_to_save_settings"),"error",ie(u)));return a.jsx(Je,{open:s,onClose:r,tabs:["filter","sort","display"],tabTitle:u=>t(mt[u]),tabContent:u=>u==="filter"?a.jsxs(a.Fragment,{children:[a.jsx(T,{label:t("global.filter.label.unread"),checked:o.hasUnreadChapters,onChange:d=>i("hasUnreadChapters",d)}),a.jsx(T,{label:t("global.filter.label.started"),checked:o.hasReadChapters,onChange:d=>i("hasReadChapters",d)}),a.jsx(T,{label:t("global.filter.label.downloaded"),checked:o.hasDownloadedChapters,onChange:d=>i("hasDownloadedChapters",d)}),a.jsx(T,{label:t("global.filter.label.bookmarked"),checked:o.hasBookmarkedChapters,onChange:d=>i("hasBookmarkedChapters",d)}),a.jsx(T,{label:t("global.filter.label.duplicate_chapters"),checked:o.hasDuplicateChapters,onChange:d=>i("hasDuplicateChapters",d)}),a.jsx(B,{sx:{mt:2},children:t("manga.label.status")}),Object.values(Ae).map(d=>a.jsx(T,{label:t(Fe[d]),checked:o.hasStatus[d],onChange:j=>i("hasStatus",{...o.hasStatus,[d]:j})},d)),a.jsx(B,{sx:{mt:2},children:t("global.filter.label.tracked")}),n.map(d=>a.jsx(T,{label:d.name,checked:o.hasTrackerBinding[d.id],onChange:j=>i("hasTrackerBinding",{...o.hasTrackerBinding,[d.id]:j})},d.id))]}):u==="sort"?bt.map(([d,j])=>a.jsx(Ve,{label:t(j),checked:o.sortBy===d,sortDescending:o.sortDesc,onClick:()=>d!==o.sortBy?i("sortBy",d):i("sortDesc",!o.sortDesc)},d)):u==="display"?a.jsxs(a.Fragment,{children:[a.jsx(B,{children:t("global.grid_layout.title")}),a.jsxs(Xe,{onChange:d=>w("gridLayout",Number(d.target.value)),value:g,children:[a.jsx(U,{label:t("global.grid_layout.label.compact_grid"),value:_.Compact,checked:g==null||g===_.Compact}),a.jsx(U,{label:t("global.grid_layout.label.comfortable_grid"),value:_.Comfortable,checked:g===_.Comfortable}),a.jsx(U,{label:t("global.grid_layout.label.list"),value:_.List,checked:g===_.List})]}),a.jsx(B,{sx:{mt:2},children:t("library.option.display.badge.title")}),a.jsx(R,{label:t("library.option.display.badge.label.unread_badges"),checked:x,onChange:()=>w("showUnreadBadge",!x)}),a.jsx(R,{label:t("library.option.display.badge.label.download_badges"),checked:A,onChange:()=>w("showDownloadBadge",!A)}),a.jsx(B,{sx:{mt:2},children:t("library.option.display.tab.title")}),a.jsx(R,{label:t("library.option.display.tab.label.show_number_of_items"),checked:m,onChange:()=>h("showTabSize",!m)}),a.jsx(B,{sx:{mt:2},children:t("global.label.other")}),a.jsx(R,{label:t("library.option.display.other.label.show_continue_reading_button"),checked:y,onChange:()=>w("showContinueReadingButton",!y)})]}):null})},ft=({category:e})=>{const{t:s}=L(),[r,t]=b.useState(!1),l=pt(e),n=l.hasDownloadedChapters!=null||l.hasUnreadChapters!=null||l.hasReadChapters!=null||l.hasBookmarkedChapters!=null||l.hasDuplicateChapters!=null||Object.values(l.hasStatus).some(o=>o!=null)||Object.values(l.hasTrackerBinding).some(o=>o!=null);return a.jsxs(a.Fragment,{children:[a.jsx(ge,{title:s("settings.title"),children:a.jsx(ve,{onClick:()=>t(!r),color:n?"warning":"inherit",children:a.jsx(Ke,{})})}),a.jsx(Ct,{category:e,open:r,onClose:()=>t(!1)})]})},xt=()=>{},de=({showFilteredOutMessage:e,message:s,messageExtra:r,...t})=>{const{t:l}=L(),{settings:{gridLayout:n}}=E();return b.useLayoutEffect(()=>(document.body.style.overflowY=n===_.List?"auto":"scroll",()=>{document.body.style.overflowY="auto"}),[]),a.jsx(Ze,{gridWrapperProps:{sx:{p:1}},...t,hasNextPage:!1,loadMore:xt,message:e?l("library.error.label.no_matches"):s,messageExtra:e?void 0:r,gridLayout:n})},St=({isActive:e,areAllItemsSelected:s,areNoItemsSelected:r,onSelectAll:t,onModeChange:l})=>{const{t:n}=L();return a.jsxs(a.Fragment,{children:[e&&a.jsx(He,{areAllItemsSelected:s,areNoItemsSelected:r,onChange:t}),a.jsx(ge,{title:n(e?"global.button.cancel":"global.button.select_all"),children:a.jsx(st,{checkedIcon:a.jsx(et,{}),sx:{padding:"8px",color:"inherit","&.Mui-checked":{color:"inherit"}},checked:e,onChange:(o,i)=>l(i)})})]})},W=(e,s,r)=>{switch(e){case!0:return s();case!1:return r();default:return!0}},O=(e,s)=>W(e,()=>!!s&&s>=1,()=>s===0),fe=(e,s)=>W(e,()=>!!s,()=>!s),M=(e,s)=>{const r=e==null?void 0:e.filter(o=>o!=null),t=s==null?void 0:s.filter(o=>o!=null);if(!(r!=null&&r.length))return!0;const l=r.map(P),n=t.map(P).join(", ");return l.every(o=>n.includes(o))},yt=(e,{title:s,genre:r,description:t,artist:l,author:n,source:o,sourceId:i})=>M([e],[s])||M(e==null?void 0:e.split(","),r.map(m=>P(m)))||M([e],[t])||M([e],[l])||M([e],[n])||M([e],[o==null?void 0:o.displayName])||M([e],[i]),jt=(e,s)=>Object.entries(e).map(([r,t])=>{const l=s.trackRecords.nodes.some(n=>n.trackerId===Number(r));return W(t,()=>l,()=>!l)}).every(Boolean),kt=(e,s)=>Object.entries(e).map(([r,t])=>fe(t,r===s.status)).every(Boolean),Tt=(e,{hasDownloadedChapters:s,hasUnreadChapters:r,hasReadChapters:t,hasBookmarkedChapters:l,hasDuplicateChapters:n,hasTrackerBinding:o,hasStatus:i})=>O(s,e.downloadCount)&&O(r,e.unreadCount)&&O(t,e.chapters.totalCount-e.unreadCount)&&O(l,e.bookmarkCount)&&fe(n,e.hasDuplicateChapters)&&jt(o,e)&&kt(i,e),Mt=(e,s,r)=>{const t=r.ignoreFilters&&(s==null?void 0:s.length);return e.filter(l=>{const n=yt(s,l),o=t||Tt(l,r);return n&&o})},v=(e=0,s=0)=>Number(e)-Number(s),_t=(e,s)=>e.localeCompare(s),At=(e,s,r)=>{const t=[...e];switch(s){case"alphabetically":t.sort((l,n)=>_t(l.title,n.title));break;case"dateAdded":t.sort((l,n)=>v(l.inLibraryAt,n.inLibraryAt));break;case"unreadChapters":t.sort((l,n)=>v(l.unreadCount,n.unreadCount));break;case"lastRead":t.sort((l,n)=>{var o,i;return v((o=l.lastReadChapter)==null?void 0:o.lastReadAt,(i=n.lastReadChapter)==null?void 0:i.lastReadAt)});break;case"latestUploadedChapter":t.sort((l,n)=>{var o,i;return v((o=l.latestUploadedChapter)==null?void 0:o.uploadDate,(i=n.latestUploadedChapter)==null?void 0:i.uploadDate)});break;case"latestFetchedChapter":t.sort((l,n)=>{var o,i;return v((o=l.latestFetchedChapter)==null?void 0:o.fetchedAt,(i=n.latestFetchedChapter)==null?void 0:i.fetchedAt)});break;case"totalChapters":t.sort((l,n)=>v(l.chapters.totalCount,n.chapters.totalCount));break}return r&&t.reverse(),t},Ft={id:-1},Bt=(e,s)=>{const[r]=z("query",ue),t=Ce(s!=null?s:Ft),{hasUnreadChapters:l,hasReadChapters:n,hasDownloadedChapters:o,hasBookmarkedChapters:i,hasTrackerBinding:m,hasDuplicateChapters:y,hasStatus:A}=t,{settings:x}=E(),g=b.useMemo(()=>Mt(e,r,{...t,ignoreFilters:x.ignoreFilters}),[e,r,l,n,o,i,m,y,A,x.ignoreFilters]),h=b.useMemo(()=>At(g,t.sortBy,t.sortDesc),[g,t.sortBy,t.sortDesc]),S=Object.values(t.hasTrackerBinding).some(u=>u!=null),p=(l!=null||n!=null||o!=null||i!=null||!!r||S)&&g.length===0&&e.length>0;return{visibleMangas:h,showFilteredOutMessage:p,filterKey:"".concat(JSON.stringify(t)).concat(x.ignoreFilters)}},he=Ge("span")({display:"flex",alignItems:"center"}),pe=({sx:e,...s})=>a.jsx(it,{...s,size:"small",sx:{...e,marginLeft:"5px"}});function _a(){var ee,te,ae,se,re,oe;const{t:e}=L(),{settings:{showTabSize:s}}=E(),{data:r,error:t,loading:l,refetch:n}=D.useGetCategories(Le,{notifyOnNetworkStatusChange:!0}),o=r==null?void 0:r.categories.nodes.filter(c=>c.id!==0||c.id===0&&c.mangas.totalCount),i=o!=null?o:[],m=D.useGetMangas(Ie,{}),y=(te=(ee=m.data)==null?void 0:ee.mangas.totalCount)!=null?te:0,[A,x]=z("tab",ze),[g]=z("query",ue),h=(ae=i.find(c=>c.id===A))!=null?ae:i[0],{data:S,error:p,loading:u,refetch:d}=D.useGetCategoryMangas(h==null?void 0:h.id,{skip:!h,notifyOnNetworkStatusChange:!0}),j=(se=S==null?void 0:S.mangas.nodes)!=null?se:[],{visibleMangas:f,showFilteredOutMessage:Y,filterKey:K}=Bt(j,h),V=b.useCallback(()=>d().catch(N()),[d,h]),xe=b.useMemo(()=>f.map(c=>c.id),[f]),[k,I]=b.useState(!1),{areNoItemsForKeySelected:J,areAllItemsForKeySelected:H,selectedItemIds:F,handleSelectAll:G,handleSelection:Q,clearSelection:Se}=at(f.length,{itemIds:xe,currentKey:h==null?void 0:h.id.toString()}),$=b.useCallback((c,C,je)=>{I(!!(F.length+(C?1:-1))),Q(c,C,je)},[I,Q]),X=b.useMemo(()=>F.map(c=>we.getFromCache(c,Re,"MANGA_CHAPTER_STAT_FIELDS")).filter(c=>!!c),[F.length,f]),Z=b.useMemo(()=>k?a.jsx(Qe,{selectedItemsCount:F.length,title:"manga.title",children:(c,C)=>a.jsx(qe,{selectedMangas:X,onClose:()=>{c(),I(!1),Se()},setHideMenu:C})}):null,[k,X]),q=b.useMemo(()=>!!g&&a.jsx(Oe,{sx:{p:2},children:a.jsx(Ne,{size:"large",component:Ee,to:De.sources.childRoutes.searchAll.path(g),sx:{textTransform:"none",width:"100%"},children:e("library.action.label.search_globally",{query:g})})}),[g]);lt(a.jsxs(he,{children:[e("library.title"),s&&a.jsx(pe,{sx:{color:"inherit"},label:y})]}),e("library.title"),[e,s,y]),nt(a.jsxs(a.Fragment,{children:[!k&&h&&a.jsxs(a.Fragment,{children:[a.jsx(Pe,{}),a.jsx(ft,{category:h}),a.jsx(tt,{categoryId:h==null?void 0:h.id})]}),!!f.length&&a.jsx(St,{isActive:k,areAllItemsSelected:H,areNoItemsSelected:J,onSelectAll:c=>G(c,[...new Set(f.map(C=>C.id))]),onModeChange:c=>{I(c),c?G(!0,[...new Set(f.map(C=>C.id))]):i.forEach(C=>G(!1,[],C.id.toString()))}})]}),[k,J,H,h,f.length]);const ye=c=>{x(c)};return t!=null||m.error?a.jsx(ce,{message:e("global.error.label.failed_to_load_data"),messageExtra:(oe=t==null?void 0:t.message)!=null?oe:(re=m.error)==null?void 0:re.message,retry:()=>{t&&n().catch(N()),m.error&&m.refetch().catch(N())}}):l||m.loading?a.jsx(Ue,{}):i.length===0?a.jsx(ce,{message:e("library.error.label.empty")}):i.length===1?a.jsxs(a.Fragment,{children:[q,a.jsx(de,{mangas:f,message:e(p?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:p==null?void 0:p.message,isLoading:u,selectedMangaIds:F,isSelectModeActive:k,handleSelection:$,showFilteredOutMessage:!p&&Y,retry:p&&V},K),Z]}):a.jsxs(ot,{children:[a.jsx(rt,{value:h.id,onChange:(c,C)=>ye(C),children:i.map(c=>a.jsx(We,{sx:{flexGrow:1,maxWidth:"unset"},label:a.jsxs(he,{children:[c.name,s?a.jsx(pe,{label:c.mangas.totalCount}):null]}),value:c.id},c.id))}),q,i.map(c=>a.jsx(Ye,{index:c.order,currentIndex:h.order,children:c===h&&a.jsx(de,{mangas:f,message:e(p?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:p==null?void 0:p.message,isLoading:u,selectedMangaIds:F,isSelectModeActive:k,handleSelection:$,showFilteredOutMessage:!p&&Y,retry:p&&V},K)},c.order)),Z]})}export{_a as Library};
