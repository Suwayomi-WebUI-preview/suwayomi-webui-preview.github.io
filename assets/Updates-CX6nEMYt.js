import{f as r,a9 as U,u as _,aK as H,j as e,C as N,a as B,L as w,A as T,b as F,B as k,S as K,a7 as V,bK as S,H as q,J as z,i as v,I,R as O,ah as Q,r as p,n as E,l as f,N as J,E as L,m as W,T as R,bL as X,k as Y,bM as Z,bN as $}from"./index-B7Sl-1yA.js";import{U as ee}from"./UpdateChecker-Mz0Eb7uT.js";import{V as te,S as ae,a as se,b as oe}from"./Virtuoso.util-xiGcbClX.js";import{A as re}from"./Avatar-CAj2m8aG.js";import"./Progress-aUMRVuGh.js";const ne=r.memo(({chapter:t})=>{const{manga:n}=t,i=U.useDownloadStatusFromCache(t.id),{t:a}=_(),l=H(),u=async()=>{try{await p.addChapterToDownloadQueue(t.id).response}catch(o){E(a("download.queue.error.label.failed_to_remove"),"error",f(o))}},m=()=>{p.addChapterToDownloadQueue(t.id).response.catch(o=>E(a("global.error.label.failed_to_save_changes"),"error",f(o)))};return e.jsx(N,{children:e.jsx(B,{component:w,to:T.reader.path(t.manga.id,t.sourceOrder),state:l.state,sx:{color:o=>o.palette.text[t.isRead?"disabled":"primary"]},children:e.jsxs(F,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:1.5},children:[e.jsxs(k,{sx:{display:"flex",flexGrow:1},children:[e.jsx(w,{to:T.manga.path(t.manga.id),style:{textDecoration:"none"},children:e.jsx(re,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",marginRight:1,background:"transparent"},children:e.jsx(K,{imgStyle:{objectFit:"cover",width:"100%",height:"100%",imageRendering:"pixelated"},spinnerStyle:{small:!0},alt:n.title,src:V.getThumbnailUrl(n)})})}),e.jsxs(k,{sx:{display:"flex",flexDirection:"column",justifyContent:"center",flexGrow:1,flexShrink:1,wordBreak:"break-word"},children:[e.jsx(S,{variant:"h6",component:"h3",children:n.title}),e.jsx(S,{variant:"caption",display:"block",lines:1,children:t.name})]})]}),e.jsx(q,{chapterId:t.id}),(i==null?void 0:i.state)===z.Error&&e.jsx(v,{title:a("global.button.retry"),children:e.jsx(I,{onClick:o=>{o.preventDefault(),o.stopPropagation(),u()},size:"large",children:e.jsx(O,{})})}),i==null&&!t.isDownloaded&&e.jsx(v,{title:a("chapter.action.download.add.label.action"),children:e.jsx(I,{onClick:o=>{o.stopPropagation(),o.preventDefault(),m()},size:"large",children:e.jsx(Q,{})})})]})})})}),ie=t=>{if(!t.length)return[];const n=new Map;return t.forEach(i=>{var l;const a=Z($(Number(i.fetchedAt)));n.set(a,((l=n.get(a))!=null?l:0)+1)}),[...n.entries()]},me=()=>{var C;const{t}=_(),{setTitle:n,setAction:i}=r.useContext(J),{data:a,loading:l,error:u,fetchMore:m,refetch:o}=p.useGetRecentlyUpdatedChapters(void 0,{fetchPolicy:"cache-and-network",notifyOnNetworkStatusChange:!0}),b=!!(a!=null&&a.chapters.pageInfo.hasNextPage),M=a==null?void 0:a.chapters.pageInfo.endCursor,d=(C=a==null?void 0:a.chapters.nodes)!=null?C:[],c=r.useMemo(()=>ie(d),[d]),y=r.useMemo(()=>c.map(s=>s[1]),[c]),A=te.useCreateGroupedComputeItemKey(y,r.useCallback(s=>c[s][0],[c]),r.useCallback(s=>d[s].id,[d])),h=r.useRef(null),[G,P]=r.useState(0);r.useLayoutEffect(()=>{var s,j;P((j=(s=h.current)==null?void 0:s.clientHeight)!=null?j:0)},[h.current]);const{data:g}=p.useGetLastGlobalUpdateTimestamp({fetchPolicy:"cache-only"}),x=g==null?void 0:g.lastUpdateTimestamp.timestamp;r.useLayoutEffect(()=>(n(t("updates.title")),i(e.jsx(ee,{})),()=>{n(""),i(null)}),[t,x]);const D=r.useCallback(()=>{b&&m({variables:{offset:d.length}})},[b,M]);return u?e.jsx(L,{message:t("global.error.label.failed_to_load_data"),messageExtra:f(u),retry:()=>o().catch(W())}):!l&&d.length===0?e.jsx(L,{message:t("updates.error.label.no_updates_available")}):e.jsxs(e.Fragment,{children:[e.jsx(R,{ref:h,sx:{marginLeft:"10px",paddingTop:s=>({[s.breakpoints.up("sm")]:{paddingTop:"6px"}})},children:t("library.settings.global_update.label.last_update",{date:x?X.format(+x):"-"})}),e.jsx(ae,{heightToSubtract:G,style:{height:"undefined"},components:{Footer:()=>l?e.jsx(Y,{usePadding:!0}):null},overscan:window.innerHeight*.5,endReached:D,groupCounts:y,groupContent:s=>e.jsx(se,{isFirstItem:s===0,children:e.jsx(R,{variant:"h5",component:"h2",children:c[s][0]})}),computeItemKey:A,itemContent:s=>e.jsx(oe,{children:e.jsx(ne,{chapter:d[s]})})})]})};export{me as Updates};
