import{u as F,o as A,a as D,G as de,j as e,p as j,c as g,f as re,I as ue,q as be,s as he,t as pe,h as X,M as ge,N as me,E as Z,g as fe}from"./index-BHxGywp1.js";import{u as B,S as se,A as Ce,N as xe}from"./AppbarSearch-DmilI1r2.js";import{T as ye,a as je}from"./Tabs-B9Xlt7r0.js";import{d as Se}from"./FilterList-BFlA_mkg.js";import{C as I}from"./CheckboxInput-CdzpSRhf.js";import{S as ke,R as G}from"./SortRadioInput-BV0UoEcE.js";import{T as M}from"./ThreeStateCheckboxInput-CO8b6F-8.js";import{O as _e,S as Te,a as Me}from"./SelectionFAB-D4PSUWKV.js";import{T as Le}from"./Trackers-D4pSmk7a.js";import{F as L}from"./TextField-mJEqqPMl.js";import{R as we}from"./ListPreference-CTDeUGK_.js";import{M as Fe,a as Ae}from"./MangaGrid-B0g6TLCF.js";import{d as Ie,U as Re}from"./UpdateChecker-cXYFrv2z.js";import{u as Ee}from"./useManageMangaLibraryState-CzNtcTaF.js";import{C as ve}from"./Checkbox-DIXMHCSq.js";import{b as R,e as oe}from"./Strings-BJMeIqh2.js";import{T as Ne,a as Ge}from"./TabsMenu-C2u2mtia.js";import{M as Oe}from"./Mangas-CmPGDowQ.js";import{C as De}from"./Chip-CkNDbkR0.js";import"./StyledFab-CKnEHU2m.js";import"./SwitchBase-73P-LJRE.js";import"./index-BshHnq1R.js";import"./Delete-DdDQXtBd.js";import"./Sync-C8ilnAYZ.js";import"./SpinnerImage-DFxkgqHh.js";import"./TypographyMaxLines-C2jX6Rir.js";import"./Link-aAzRANTp.js";import"./Avatar-A4nyfANs.js";import"./PlayArrow-DMJS40LS.js";import"./Progress-DKUZLHc7.js";import"./Info-BH0XP9L7.js";import"./InputAdornment-DZlsCN_s.js";import"./Collapse-B708u_Zv.js";import"./NumberSetting-DwVwFwcG.js";import"./useMobilePicker-C4TV3sVT.js";import"./SelectSetting-CwGAtSGz.js";import"./Select-CDWBktYy.js";import"./Chapters-CGjUAvLG.js";const Be={filter:"global.label.filter",sort:"global.label.sort",display:"global.label.display"},Pe=[["sortToRead","library.option.sort.label.by_unread_chapters"],["sortAlph","library.option.sort.label.alphabetically"],["sortDateAdded","library.option.sort.label.by_date_added"],["sortLastRead","library.option.sort.label.by_last_read"],["sortLatestFetchedChapter","library.option.sort.label.by_latest_fetched_chapter"],["sortLatestUploadedChapter","library.option.sort.label.by_latest_uploaded_chapter"]],Ue=({open:a,onClose:s})=>{var u,m;const{t}=F(),{options:o,setOptions:n}=A(),c=D.useGetTrackerList(de),d=Le.getLoggedIn((m=(u=c.data)==null?void 0:u.trackers.nodes)!=null?m:[]),l=(p,r)=>{n(h=>({...h,[p]:r}))};return e.jsx(_e,{open:a,onClose:s,tabs:["filter","sort","display"],tabTitle:p=>t(Be[p]),tabContent:p=>{if(p==="filter")return e.jsxs(e.Fragment,{children:[e.jsx(M,{label:t("global.filter.label.unread"),checked:o.unread,onChange:r=>l("unread",r)}),e.jsx(M,{label:t("global.filter.label.downloaded"),checked:o.downloaded,onChange:r=>l("downloaded",r)}),e.jsx(M,{label:t("global.filter.label.bookmarked"),checked:o.bookmarked,onChange:r=>l("bookmarked",r)}),e.jsx(M,{label:t("global.filter.label.duplicate_chapters"),checked:o.hasDuplicateChapters,onChange:r=>l("hasDuplicateChapters",r)}),e.jsx(L,{sx:{mt:2},children:t("global.filter.label.tracked")}),d.map(r=>e.jsx(M,{label:r.name,checked:o.tracker[r.id],onChange:h=>l("tracker",{...o.tracker,[r.id]:h})},r.id))]});if(p==="sort")return Pe.map(([r,h])=>e.jsx(ke,{label:t(h),checked:o.sorts===r,sortDescending:o.sortDesc,onClick:()=>r!==o.sorts?l("sorts",r):l("sortDesc",!o.sortDesc)},r));if(p==="display"){const{gridLayout:r,showContinueReadingButton:h,showDownloadBadge:b,showUnreadBadge:k,showTabSize:_}=o;return e.jsxs(e.Fragment,{children:[e.jsx(L,{children:t("global.grid_layout.title")}),e.jsxs(we,{onChange:E=>l("gridLayout",Number(E.target.value)),value:r,children:[e.jsx(G,{label:t("global.grid_layout.label.compact_grid"),value:j.Compact,checked:r==null||r===j.Compact}),e.jsx(G,{label:t("global.grid_layout.label.comfortable_grid"),value:j.Comfortable,checked:r===j.Comfortable}),e.jsx(G,{label:t("global.grid_layout.label.list"),value:j.List,checked:r===j.List})]}),e.jsx(L,{sx:{mt:2},children:t("library.option.display.badge.title")}),e.jsx(I,{label:t("library.option.display.badge.label.unread_badges"),checked:k,onChange:()=>l("showUnreadBadge",!k)}),e.jsx(I,{label:t("library.option.display.badge.label.download_badges"),checked:b,onChange:()=>l("showDownloadBadge",!b)}),e.jsx(L,{sx:{mt:2},children:t("library.option.display.tab.title")}),e.jsx(I,{label:t("library.option.display.tab.label.show_number_of_items"),checked:_,onChange:()=>l("showTabSize",!_)}),e.jsx(L,{sx:{mt:2},children:t("global.label.other")}),e.jsx(I,{label:t("library.option.display.other.label.show_continue_reading_button"),checked:h,onChange:()=>l("showContinueReadingButton",!h)})]})}return null}})},ze=()=>{const{t:a}=F(),[s,t]=g.useState(!1),{options:o}=A(),n=o.downloaded!=null||o.unread!=null||Object.values(o.tracker).some(c=>c!=null);return e.jsxs(e.Fragment,{children:[e.jsx(re,{title:a("settings.title"),children:e.jsx(ue,{onClick:()=>t(!s),color:n?"warning":"default",children:e.jsx(Se,{})})}),e.jsx(Ue,{open:s,onClose:()=>t(!1)})]})},ee=({showFilteredOutMessage:a,message:s,messageExtra:t,...o})=>{const{t:n}=F(),[c]=B("query",se),{options:d}=A(),{unread:l,downloaded:u}=d;return g.useEffect(()=>{window.scrollTo(0,0)},[c,l,u]),g.useLayoutEffect(()=>(document.body.style.overflowY=d.gridLayout===j.List?"auto":"scroll",()=>{document.body.style.overflowY="auto"}),[]),e.jsx(Fe,{...o,hasNextPage:!1,loadMore:()=>{},message:a?n("library.error.label.no_matches"):s,messageExtra:a?void 0:t,gridLayout:d.gridLayout})},Ke=({isActive:a,areAllItemsSelected:s,areNoItemsSelected:t,onSelectAll:o,onModeChange:n})=>{const{t:c}=F();return e.jsxs(e.Fragment,{children:[a&&e.jsx(Te,{areAllItemsSelected:s,areNoItemsSelected:t,onChange:o}),e.jsx(re,{title:c(a?"global.button.cancel":"global.button.select_all"),children:e.jsx(ve,{checkedIcon:e.jsx(Ie,{}),sx:{padding:"8px"},checked:a,onChange:(d,l)=>n(l)})})]})},P=(a,s,t)=>{switch(a){case!0:return s();case!1:return t();default:return!0}},O=(a,s)=>P(a,()=>!!s&&s>=1,()=>s===0),qe=(a,s)=>P(a,()=>!!s,()=>!s),He=(a,{title:s})=>{if(!a)return!0;const t=R(a);return R(s).includes(t)||oe(s).includes(t)},Qe=(a,{genre:s})=>{if(!a)return!0;const t=a.split(",").map(R),o=s.map(n=>{const c=R(n),d=oe(c);return"".concat(c,", ").concat(d)}).join(", ");return t.every(n=>o.includes(n))},We=(a,s)=>Object.entries(a).map(([t,o])=>{const n=s.trackRecords.nodes.some(c=>c.trackerId===Number(t));return P(o,()=>n,()=>!n)}).every(t=>t),Ye=(a,s,t,o,n,c,d,l)=>a.filter(u=>{const m=l&&(s==null?void 0:s.length),p=He(s,u)||Qe(s,u),r=m||O(o,u.downloadCount)&&O(t,u.unreadCount)&&O(n,u.bookmarkCount)&&qe(c,u.hasDuplicateChapters)&&We(d,u);return p&&r}),w=(a=0,s=0)=>Number(a)-Number(s),$e=(a,s)=>a.localeCompare(s),Ve=(a,s,t)=>{const o=[...a];switch(s){case"sortAlph":o.sort((n,c)=>$e(n.title,c.title));break;case"sortDateAdded":o.sort((n,c)=>w(n.inLibraryAt,c.inLibraryAt));break;case"sortToRead":o.sort((n,c)=>w(n.unreadCount,c.unreadCount));break;case"sortLastRead":o.sort((n,c)=>{var d,l;return w((d=n.lastReadChapter)==null?void 0:d.lastReadAt,(l=c.lastReadChapter)==null?void 0:l.lastReadAt)});break;case"sortLatestUploadedChapter":o.sort((n,c)=>{var d,l;return w((d=n.latestUploadedChapter)==null?void 0:d.uploadDate,(l=c.latestUploadedChapter)==null?void 0:l.uploadDate)});break;case"sortLatestFetchedChapter":o.sort((n,c)=>{var d,l;return w((d=n.latestFetchedChapter)==null?void 0:d.fetchedAt,(l=c.latestFetchedChapter)==null?void 0:l.fetchedAt)});break}return t&&o.reverse(),o},Je=a=>{const[s]=B("query",se),{options:t}=A(),{unread:o,downloaded:n,bookmarked:c,tracker:d,hasDuplicateChapters:l}=t,{settings:u}=be(),m=g.useMemo(()=>Ye(a,s,o,n,c,l,d,u.ignoreFilters),[a,s,o,n,c,l,d,u.ignoreFilters]),p=g.useMemo(()=>Ve(m,t.sorts,t.sortDesc),[m,t.sorts,t.sortDesc]),r=Object.values(t.tracker).some(b=>b!=null),h=(o!=null||n!=null||c!=null||!!s||r)&&m.length===0&&a.length>0;return{visibleMangas:p,showFilteredOutMessage:h}},te=he("span")({display:"flex",alignItems:"center"}),ae=a=>e.jsx(De,{...a,size:"small",sx:{marginLeft:"5px"}});function Gt(){var V,J;const{t:a}=F(),{options:s}=A(),{data:t,error:o,loading:n,refetch:c}=D.useGetCategories(pe,{notifyOnNetworkStatusChange:!0}),d=t==null?void 0:t.categories.nodes.filter(i=>i.id!==0||i.id===0&&i.mangas.totalCount),l=d!=null?d:[],u=g.useMemo(()=>l.map(i=>i.mangas.totalCount).reduce((i,f)=>i+f,0),[l]),[m,p]=B("tab",xe),r=(V=l.find(i=>i.order===m))!=null?V:l[0],{data:h,error:b,loading:k,refetch:_}=D.useGetCategoryMangas(r==null?void 0:r.id,{skip:!r,notifyOnNetworkStatusChange:!0}),E=(J=h==null?void 0:h.mangas.nodes)!=null?J:[],{visibleMangas:C,showFilteredOutMessage:U}=Je(E),z=g.useCallback(()=>_().catch(X()),[_,r]),le=g.useMemo(()=>C.map(i=>i.id),[C]),[x,v]=g.useState(!1),{areNoItemsForKeySelected:K,areAllItemsForKeySelected:q,selectedItemIds:y,handleSelectAll:N,handleSelection:ne,clearSelection:ie}=Ee(C.length,{itemIds:le,currentKey:r==null?void 0:r.id.toString()}),H=(i,f,S)=>{v(!!(y.length+(f?1:-1))),ne(i,f,S)},Q=g.useMemo(()=>y.map(i=>Oe.getFromCache(i,ge,"MANGA_CHAPTER_STAT_FIELDS")).filter(i=>!!i),[y.length,C]),W=g.useMemo(()=>x?e.jsx(Me,{selectedItemsCount:y.length,title:"manga.title",children:(i,f)=>e.jsx(Ae,{selectedMangas:Q,onClose:()=>{i(),v(!1),ie()},setHideMenu:f})}):null,[x,Q]),{setTitle:Y,setAction:$}=g.useContext(me);g.useEffect(()=>{const i=a("library.title"),f=e.jsxs(te,{children:[i,s.showTabSize&&e.jsx(ae,{label:u})]});return Y(f,i),$(e.jsxs(e.Fragment,{children:[!x&&e.jsxs(e.Fragment,{children:[e.jsx(Ce,{}),e.jsx(ze,{}),e.jsx(Re,{categoryId:r==null?void 0:r.id})]}),e.jsx(Ke,{isActive:x,areAllItemsSelected:q,areNoItemsSelected:K,onSelectAll:S=>N(S,[...new Set(C.map(T=>T.id))]),onModeChange:S=>{v(S),S?N(!0,[...new Set(C.map(T=>T.id))]):l.forEach(T=>N(!1,[],T.id.toString()))}})]})),()=>{Y(""),$(null)}},[a,u,n,s,x,K,q,y.length,C.length,r]);const ce=i=>{p(i)};return o!=null?e.jsx(Z,{message:a("category.error.label.request_failure"),messageExtra:o.message,retry:()=>c().catch(X())}):n?e.jsx(fe,{}):l.length===0?e.jsx(Z,{message:a("library.error.label.empty")}):l.length===1?e.jsxs(e.Fragment,{children:[e.jsx(ee,{mangas:C,message:a(b?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:b==null?void 0:b.message,isLoading:k,selectedMangaIds:y,isSelectModeActive:x,handleSelection:H,showFilteredOutMessage:!b&&U,retry:b&&z}),W]}):e.jsxs(Ne,{children:[e.jsx(Ge,{value:r.order,onChange:(i,f)=>ce(f),tabsCount:l.length,children:l.map(i=>e.jsx(ye,{sx:{display:"flex"},label:e.jsxs(te,{children:[i.name,s.showTabSize?e.jsx(ae,{label:i.mangas.totalCount}):null]}),value:i.order},i.id))}),l.map(i=>e.jsx(je,{index:i.order,currentIndex:r.order,children:i===r&&e.jsx(ee,{mangas:C,message:a(b?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:b==null?void 0:b.message,isLoading:k,selectedMangaIds:y,isSelectModeActive:x,handleSelection:H,showFilteredOutMessage:!b&&U,retry:b&&z})},i.order)),W]})}export{Gt as Library};
