import{bE as Y,bF as x,bG as R,bH as $,bI as q,bJ as Ee,bK as F,bL as W,aN as D,bM as B,u as P,a1 as de,j as s,b as S,b9 as M,bN as A,C as ce,I as ue,au as je,T as me,B as y,bj as K,f as z,bO as _e,bf as Ce,bg as ve,bP as we,aA as De,bQ as Me,r as ne,i as Ae,g as se,k as ye,bR as Pe,m as Ge}from"./index-LuRfpAul.js";import{E as Ue}from"./EmptyViewAbsoluteCentered-CG8OzJNr.js";import{a as Ne}from"./Asserts-DNMCi6ar.js";import{u as Oe}from"./useAppTitle-BLkwhwB5.js";import{D as pe}from"./Delete-C39Fxflk.js";import{S as Re}from"./Select-BydMHwoW.js";import{u as Le}from"./use-resize-observer-BCZV6m6x.js";let ge=0;const _=e=>e.replace(R,""),L=e=>_(e.toLowerCase().trim())===Y,xe=(e,t,n)=>{var o;return(o=n==null?void 0:n.slice(0,t).some(({name:l})=>l===e))!=null?o:!1},le=e=>{var t;return(t=e==null?void 0:e.some((n,o)=>xe(n.name,o,e)))!=null?t:!1},be=(e,t,n)=>n.slice(0,t).some(o=>o.mimeType===e),G=e=>e!==""&&!!e.match(/^https?:\/\/.+/),J=(e,t,n)=>e==null||e>=t&&e<=n,he=e=>J(e?D(e).seconds.inWholeSeconds:null,W.min,W.max),Se=e=>J(e?D(e).seconds.inWholeSeconds:null,B.min,B.max),Te=e=>J(e,F.min,F.max),Ve=(e,t)=>e===""&&t==="",ke=(e,t,n)=>L(n)&&!e?!1:t===x.URL&&!G(e),Fe=e=>e.some(({mimeType:t,compressionLevel:n,target:o,callTimeout:l,connectTimeout:i,headers:d,searchParams:c,mode:u},r)=>Ve(t,o)||ke(o,u,t)||!Te(n)||!he(l)||!Se(i)||be(t,r,e)||le(d)||le(c)),We=e=>{const t=_(e);return t===$?x.DISABLED:G(t)?x.URL:x.IMAGE},Be=e=>{var n;const t=q.asUrl(e);return[...((n=t==null?void 0:t.searchParams)!=null?n:[]).entries()].map(([o,l])=>{var i;return{name:String(o),value:(i=Ee(l))!=null?i:l}})},O=e=>e.map(t=>{var n;return{id:(n=t.id)!=null?n:ge++,...t}}),V=e=>e.map(t=>{var n;return{id:(n=t.id)!=null?n:ge++,...t,mode:We(_(t.target)),headers:t.headers?O(t.headers):null,searchParams:O(Be(t.target))}}),Ke=(e,t)=>{var i,d;const n=q.asUrl(e),l=[...(d=(i=n==null?void 0:n.searchParams)==null?void 0:i.entries())!=null?d:[]].map(([c,u])=>({name:c,value:u})).map(c=>{const u=t==null?void 0:t.find(({name:r})=>r===c.name);return{id:u==null?void 0:u.id,...c}});return O(l)},oe=e=>e.map(t=>({...t,mimeType:_(t.mimeType),target:_(t.target)})),ze=e=>L(e)?Y:"".concat(R).concat(e),Ye=e=>e.filter(({mimeType:t,target:n})=>!!t&&!!n).map(({id:t,mode:n,searchParams:o,...l})=>{var i,d;return{...l,mimeType:ze(l.mimeType),target:G(l.target)?l.target:"".concat(R).concat(l.target),headers:(d=(i=l.headers)==null?void 0:i.map(({id:c,...u})=>u))!=null?d:null}}),k=e=>[...e.some(({mimeType:n})=>L(n))?[]:[{id:-1,mode:x.IMAGE,mimeType:Y,target:"",compressionLevel:null,headers:null,callTimeout:null,connectTimeout:null}],...e],ae=e=>e==null?void 0:e.filter(({name:t})=>t!==""),$e=(e,t)=>e.length!==t.length?!0:e.some(({mimeType:n,target:o,compressionLevel:l,callTimeout:i,connectTimeout:d,headers:c},u)=>{var E,C;const r=t[u],p=ae(c),a=ae(r.headers);return _(n)!==r.mimeType||_(o)!==r.target||l!==r.compressionLevel||i!==r.callTimeout||d!==r.connectTimeout||((E=p==null?void 0:p.length)!=null?E:0)!==((C=a==null?void 0:a.length)!=null?C:0)||!!(p!=null&&p.some((j,h)=>{var T,g;return j.name!==((T=a==null?void 0:a[h])==null?void 0:T.name)||j.value!==((g=a==null?void 0:a[h])==null?void 0:g.value)}))}),qe=({id:e,name:t,value:n,onChange:o,isDuplicate:l})=>{const{t:i}=P(),d=de();return s.jsxs(S,{sx:{gap:1,flexDirection:"row",flexWrap:"nowrap",alignItems:"center"},children:[s.jsxs(S,{sx:{flexDirection:"row",gap:2,[d.breakpoints.down("md")]:{flexDirection:"column",width:"100%"}},children:[s.jsx(M,{autoFocus:!0,sx:{width:A},label:i("download.settings.conversion.headers.name"),value:t,error:l,helperText:l&&i("global.error.label.invalid_input"),onChange:c=>o({id:e,name:c.target.value,value:n})}),s.jsx(M,{sx:{width:A},label:i("download.settings.conversion.headers.value"),value:n,onChange:c=>o({id:e,name:t,value:c.target.value})})]}),s.jsx(ce,{disabled:!1,title:i("chapter.action.download.delete.label.action"),children:s.jsx(ue,{onClick:()=>{o(null)},children:s.jsx(pe,{})})})]})},ie=({title:e,open:t,items:n,onChange:o})=>{const{t:l}=P();return s.jsx(je,{in:t,children:s.jsxs(S,{sx:{justifyContent:"start",gap:2,pt:2},children:[s.jsx(me,{children:e}),n==null?void 0:n.map((i,d)=>s.jsx(qe,{...i,isDuplicate:xe(i.name,d,n),onChange:c=>{if(c==null){o(n==null?void 0:n.toSpliced(d,1));return}o((n!=null?n:[]).toSpliced(d,1,c))}},i.id)),s.jsx(y,{onClick:()=>o([...n!=null?n:[],...O([{name:"",value:""}])]),variant:"contained",sx:{width:"fit-content"},children:l("global.button.add")})]})})},re=({shouldAutoFocus:e,isDefault:t,isDuplicate:n,label:o,value:l,onUpdate:i,mode:d})=>{const{t:c}=P(),u=d===x.IMAGE,r=!l.length||G(l),p=!n&&(u||r);return s.jsx(M,{sx:{width:A},autoFocus:e,label:o,value:l,disabled:t,error:!p,helperText:!p&&c("global.error.label.invalid_input"),slotProps:{input:{startAdornment:s.jsx(K,{position:"start",children:u?R:null})}},onChange:a=>i(a.target.value.trim())})},Je=({conversion:e,conversion:{mode:t,mimeType:n,target:o,compressionLevel:l,headers:i,searchParams:d,callTimeout:c,connectTimeout:u},onChange:r,isDuplicate:p})=>{const{t:a}=P(),E=de(),{ref:C,height:j}=Le(),[h,T]=z.useState(!0),[g,I]=z.useState(!0),v=t===x.DISABLED,U=t===x.IMAGE,f=t===x.URL,N=he(c),Q=Se(u),X=Te(l),Z=L(n)&&!p,H=Z&&!o&&l==null;return s.jsxs(S,{children:[s.jsxs(S,{sx:{gap:1,flexDirection:"row",flexWrap:"nowrap",alignItems:"center",pt:1},children:[s.jsxs(S,{sx:{gap:1,flexDirection:"row",alignItems:"baseline",flexWrap:"wrap",[E.breakpoints.down("md")]:{flexDirection:"column",width:"100%"}},children:[s.jsx(re,{mode:x.IMAGE,shouldAutoFocus:!0,isDefault:Z,isDuplicate:p,label:a("download.settings.conversion.mime_type"),value:n,onUpdate:m=>{r({...e,mimeType:m})}}),s.jsx(_e,{sx:{[E.breakpoints.up("md")]:{mx:1}},children:"â†’"}),s.jsxs(Ce,{sx:{minWidth:"100px"},children:[s.jsx(ve,{id:"image-conversion-target-mode-label",children:a("download.settings.conversion.target_modes.title")}),s.jsx(Re,{ref:C,id:"image-conversion-target-mode",labelId:"image-conversion-target-mode-label",label:a("download.settings.conversion.target_modes.title"),value:t,onChange:m=>{f||(T(!0),I(!0)),r({...e,mode:m.target.value,target:m.target.value===x.DISABLED?$:"",headers:f?i:null,searchParams:f?d:null})},children:we.map(([m,{text:w}])=>s.jsx(De,{value:m,children:a(w)},m))})]}),!v&&s.jsx(re,{mode:t,shouldAutoFocus:!1,isDefault:!1,isDuplicate:!1,label:a("download.settings.conversion.target"),value:o,onUpdate:m=>{r({...e,target:m,searchParams:U?null:Ke(m,d)})}}),(()=>{var m,w;return v?null:U?s.jsx(M,{sx:{width:A},label:a("download.settings.conversion.compression_level"),value:l!=null?l:"",type:"number",error:!X,helperText:X?"":a("global.error.label.invalid_input"),slotProps:{input:{inputProps:F}},onChange:b=>{r({...e,compressionLevel:b.target.value?Number(b.target.value):null})}}):s.jsxs(s.Fragment,{children:[s.jsx(M,{sx:{width:A},label:a("download.settings.conversion.call_timeout"),value:c?D(c).seconds.inWholeSeconds:"",type:"number",error:!N,helperText:N?"":a("global.error.label.invalid_input"),slotProps:{input:{inputProps:W,endAdornment:s.jsx(K,{position:"end",children:a("global.date.label.second_other")})}},onChange:b=>{r({...e,callTimeout:b.target.value?D(Number(b.target.value)).seconds.toISOString():null})}}),s.jsx(M,{sx:{width:A},label:a("download.settings.conversion.connect_timeout"),value:u?D(u).seconds.inWholeSeconds:"",type:"number",error:!Q,helperText:Q?"":a("global.error.label.invalid_input"),slotProps:{input:{inputProps:B,endAdornment:s.jsx(K,{position:"end",children:a("global.date.label.second_other")})}},onChange:b=>{r({...e,connectTimeout:b.target.value?D(Number(b.target.value)).seconds.toISOString():null})}}),s.jsx(y,{disabled:!G(o),onClick:()=>T(!h),variant:h?"outlined":"contained",sx:{height:j},children:a("download.settings.conversion.search_params.button",{count:(m=d==null?void 0:d.length)!=null?m:0})}),s.jsx(y,{onClick:()=>I(!g),variant:g?"outlined":"contained",sx:{height:j},children:a("download.settings.conversion.headers.button",{count:(w=i==null?void 0:i.length)!=null?w:0})})]})})()]}),s.jsx(ce,{disabled:H,title:a("chapter.action.download.delete.label.action"),children:s.jsx(ue,{disabled:H,onClick:()=>{r(null)},children:s.jsx(pe,{})})})]}),s.jsx(ie,{title:a("download.settings.conversion.search_params.title"),open:f&&!h,items:d,onChange:m=>{var ee,te;const w=(ee=o==null?void 0:o.split("?")[0])!=null?ee:"",b=Object.fromEntries((te=m==null?void 0:m.map(({name:Ie,value:fe})=>[Ie,fe]))!=null?te:[]);r({...e,target:q.addParams(w,b),searchParams:m})}}),s.jsx(ie,{title:a("download.settings.conversion.headers.title"),open:f&&!g,items:i,onChange:m=>r({...e,headers:m})})]})},st=({type:e})=>{var h,T;const{t}=P();Oe(t(Me[e]));const{data:n,loading:o,error:l,refetch:i}=ne.useGetServerSettings({notifyOnNetworkStatusChange:!0}),[d]=ne.useUpdateServerSettings();if(o)return s.jsx(Ae,{});if(l)return s.jsx(Ue,{message:t("global.error.label.failed_to_load_data"),messageExtra:se(l),retry:()=>i().catch(ye())});const c=Pe[e];Ne((h=n==null?void 0:n.settings)==null?void 0:h[c]);const u=(T=n==null?void 0:n.settings)==null?void 0:T[c],[r,p]=z.useState(oe(k(V(u)))),a=Fe(r),E=$e(oe(k(V(u))),r),C=g=>{const I=d({variables:{input:{settings:{[c]:g}}}});return I.catch(v=>Ge(t("global.error.label.failed_to_save_changes"),"error",se(v))),I},j=async()=>{try{await C(Ye(r))}catch(g){}};return s.jsxs(S,{sx:{p:2,gap:5},children:[s.jsx(me,{children:t("download.settings.conversion.description",{value:$})}),s.jsx(S,{sx:{flexDirection:"column",gap:5},children:r.map((g,I)=>{const{mimeType:v}=g,U=be(v,I,r);return s.jsx(Je,{conversion:g,isDuplicate:U,onChange:f=>{p(N=>k(N.toSpliced(I,1,...f?[f]:[])))}},g.id)})}),s.jsxs(S,{direction:"row",sx:{gap:1},children:[s.jsx(y,{variant:"outlined",onClick:()=>{p(g=>[...g,...V([{mimeType:"",target:"",compressionLevel:null,headers:null,callTimeout:null,connectTimeout:null}])])},children:t("global.button.add")}),s.jsx(y,{variant:"contained",disabled:a||!E,onClick:j,children:t("global.button.save")})]})]})};export{st as ImageProcessingSetting};
