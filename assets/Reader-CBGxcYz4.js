import{c as r,n as ye,j as t,B,a as V,ag as z,r as ie,i as ce,x as bt,a5 as yt,ah as Pt,a3 as Ee,ai as Lt,aj as St,ak as Ke,s as te,I as ee,u as it,v as Dt,e as ct,al as lt,am as jt,an as Tt,f as ne,T as kt,ao as _t,W as Ot,ap as At,U as Ge,aq as Nt,X as It,ar as Wt,as as Ye,q as Ze,N as $t,m as Je,h as U,Z as Mt,E as Qe,at as Ft,au as Bt}from"./index-DUxXg8iH.js";import{b as K,C as O}from"./Chapters-BKg1NJBL.js";import{P as ge,i as zt,R as Ht,u as qt,g as et,c as Vt}from"./ReaderSettingsOptions-CHqXwsoq.js";import{S as tt}from"./SpinnerImage-oB-g1LcI.js";import{S as rt}from"./Select-BKigGwKA.js";import{C as Xt}from"./Collapse-CDjcuur7.js";import{a as nt}from"./TextField-C9O1SlXj.js";import{u as Ut}from"./useDebounce-DFQYJVtc.js";import"./NumberSetting-3AAEww5u.js";import"./Info-CdsGsehq.js";import"./InputAdornment-CyyA-vkU.js";import"./Switch-CgbLCr72.js";import"./SwitchBase-DmwV1WlT.js";const Kt=i=>{for(let n=0;n<i.children.length;n++){const a=i.children.item(n);if(a){const{left:u,right:l}=a.getBoundingClientRect();if(u<=window.innerWidth/2&&l>window.innerWidth/2)return n}}return-1},Gt=5,Yt=()=>window.innerWidth+window.scrollX>=document.body.scrollWidth-Gt,Zt=()=>window.scrollX<=0;function Jt(i){const{pages:n,curPage:a,initialPage:u,settings:l,setCurPage:s,prevChapter:v,nextChapter:f}=i,c=r.useRef(u),m=r.useRef(null),h=r.useRef([]);function R(){var g;a<n.length-1?((g=h.current[a+1])==null||g.scrollIntoView({inline:"center"}),s(e=>e+1)):l.loadNextOnEnding&&f()}function p(){var g;a>0?((g=h.current[a-1])==null||g.scrollIntoView({inline:"center"}),s(a-1)):a===0&&v()}function D(){l.readerType==="ContinuesHorizontalLTR"?p():R()}function j(){l.readerType==="ContinuesHorizontalLTR"?R():p()}const y=r.useRef(0);function d(g){window.scrollBy(y.current-g.pageX,0)}function o(g){var e;y.current=g.pageX,(e=m.current)==null||e.addEventListener("mousemove",d)}function C(){var g;(g=m.current)==null||g.removeEventListener("mousemove",d)}function P(g){g.clientX>=window.innerWidth*.85?j():g.clientX<=window.innerWidth*.15&&D()}const k=()=>{l.readerType==="ContinuesHorizontalLTR"?window.scrollX+window.innerWidth>=document.body.scrollWidth&&f():l.readerType==="ContinuesHorizontalRTL"&&window.scrollX<=window.innerWidth&&f()};return ye(h.current[u],r.useCallback((g,e)=>{const x=h.current[u];x!=null&&x.offsetHeight&&(x.scrollIntoView({inline:"center"}),e.disconnect())},[h.current[u],u])),r.useEffect(()=>{var g,e;return(g=m.current)==null||g.addEventListener("mousedown",o),(e=m.current)==null||e.addEventListener("mouseup",C),()=>{var x,A;(x=m.current)==null||x.removeEventListener("mousedown",o),(A=m.current)==null||A.removeEventListener("mouseup",C)}},[m]),r.useEffect(()=>(l.loadNextOnEnding&&document.addEventListener("scroll",k),()=>{document.removeEventListener("scroll",k)}),[m,a,v,f]),r.useEffect(()=>{const g=()=>{if(!m.current)return;const e=Kt(m.current);e!==c.current&&(c.current=e,s(e)),(l.readerType==="ContinuesHorizontalLTR"?Yt():Zt())&&(c.current=n.length-1,s(c.current))};return window.addEventListener("scroll",g),()=>window.removeEventListener("scroll",g)},[l.readerType]),t.jsx(B,{ref:m,sx:{display:"flex",flexDirection:l.readerType==="ContinuesHorizontalLTR"?"row":"row-reverse",justifyContent:l.readerType==="ContinuesHorizontalLTR"?"flex-start":"flex-end",width:"auto",height:"auto",overflowX:"visible",userSelect:"none"},onClick:P,children:n.map(g=>t.jsx(ge,{index:g.index,src:g.src,onImageLoad:()=>{},settings:l,ref:e=>{h.current[g.index]=e}},g.index))})}function Qt(i){const{settings:n,curPage:a,pageCount:u}=i;return t.jsx(B,{sx:{display:n.showPageNumber?"block":"none",position:"fixed",bottom:"50px",padding:"2px",paddingLeft:"4px",paddingRight:"4px",textAlign:"center",backgroundColor:"rgba(0, 0, 0, 0.3)",borderRadius:"10px"},children:"".concat(a+1," / ").concat(u)})}function er(i){const{pages:n,settings:a,setCurPage:u,initialPage:l,curPage:s,nextChapter:v,prevChapter:f,chapter:c}=i,m=r.useRef(null);r.useEffect(()=>{const o=n.map(C=>{const P=V.requestImage(C.src);return P.response.catch(()=>{}),P});return()=>{o.forEach(C=>C.abortRequest(new Error("PagedPager::preload: chapter changed")))}},[c.id]);const h=o=>{u(o),window.scroll({top:0})};function R(){s<n.length-1?h(s+1):a.loadNextOnEnding&&v()}function p(){s>0?h(s-1):f()}function D(){a.readerType==="SingleLTR"?p():a.readerType==="SingleRTL"&&R()}function j(){a.readerType==="SingleLTR"?R():a.readerType==="SingleRTL"&&p()}function y(o){switch(o.key){case"Space":o.preventDefault(),R();break;case"ArrowRight":j();break;case"ArrowLeft":D();break}}function d(o){o.clientX>window.innerWidth/2?j():D()}return r.useEffect(()=>(document.addEventListener("keydown",y),()=>{document.removeEventListener("keydown",y)}),[m,s,a.readerType,f,v]),r.useEffect(()=>{setTimeout(()=>{h(l)},0)},[l]),t.jsx(B,{ref:m,sx:{display:"flex",flexDirection:"column",justifyContent:"center",width:"auto",height:"auto"},onClick:d,children:t.jsx(ge,{index:s,onImageLoad:()=>{},src:n[s].src,settings:a},s)})}const tr=r.forwardRef((i,n)=>{const{image1src:a,image2src:u,index:l,onImageLoad:s,settings:v}=i,f=zt(v),c={...f,width:v.fitPageToWindow?f.width:"calc(".concat(f.width," * 0.5)"),minWidth:v.fitPageToWindow&&v.scalePage?"calc(".concat(f.minWidth," * 0.5)"):f.minWidth,maxWidth:v.fitPageToWindow?"calc(".concat(f.maxWidth," * 0.5)"):f.maxWidth},m={...c,height:"100vh",width:"50%",backgroundColor:"#525252"};return t.jsxs(B,{ref:n,sx:{display:"flex",flexDirection:v.readerType==="DoubleLTR"?"row":"row-reverse",justifyContent:"center",width:"100%"},children:[t.jsx(tt,{src:a,onImageLoad:s,alt:"Page #".concat(l),spinnerStyle:m,imgStyle:{...c,objectPosition:v.readerType==="DoubleLTR"?z("right","left"):z("left","right")}}),t.jsx(tt,{src:u,onImageLoad:s,alt:"Page #".concat(l+1),spinnerStyle:{...m,width:"calc(50% - 5px)",marginLeft:"5px"},imgStyle:{...c,objectPosition:v.readerType==="DoubleLTR"?z("left","right"):z("right","left")}})]})}),rr=i=>i.height/i.width<1,be=(i,n,a)=>{if(n[i]||n[i+1]||i===n.length-1)return!0;const u=n.lastIndexOf(!0,i-1),l=i-(u+1);return a?l%2===0:l%2===1};function nr(i){const{pages:n,settings:a,setCurPage:u,initialPage:l,curPage:s,chapter:v,nextChapter:f,prevChapter:c}=i,m=r.useRef(null),[h,R]=r.useState(Array(n.length).fill(!1)),[p,D]=r.useState(Array(n.length).fill(!1));function j(){let e=1;if(s<n.length&&p[s]&&(e=1,h[s]))return e;if(s+1<n.length&&p[s+1]){if(be(s,h,a.offsetFirstPage))return e;e=2}return e}function y(){return be(s-2,h,a.offsetFirstPage)?1:2}function d(){if(s<n.length-1){const e=s+j();u(e>=n.length?n.length-1:e)}else a.loadNextOnEnding&&f()}function o(){if(s>0){const e=s-y();u(e<0?0:e)}else c()}function C(){a.readerType==="DoubleLTR"?o():d()}function P(){a.readerType==="DoubleLTR"?d():o()}function k(e){switch(e.key){case"Space":e.preventDefault(),d();break;case"ArrowRight":P();break;case"ArrowLeft":C();break}}function g(e){e.clientX>window.innerWidth/2?P():C()}return r.useEffect(()=>(document.addEventListener("keydown",k),()=>{document.removeEventListener("keydown",k)}),[m,s,a.readerType,c,f,p,h]),r.useEffect(()=>{u(l)},[l]),r.useEffect(()=>{a.offsetFirstPage?j()===2&&u(s+1):s>0&&!be(s-1,h,a.offsetFirstPage)&&u(s-1)},[a.offsetFirstPage]),r.useEffect(()=>{const e=n.map(x=>[x.index,V.requestImage(x.src)]);return e.forEach(async([x,A])=>{try{const F=await A.response,I=new Image;I.onload=()=>{URL.revokeObjectURL(F),D(_=>_.toSpliced(x,1,!0)),R(_=>_.toSpliced(x,1,rr(I)))},I.src=F}catch(F){}}),()=>{e.forEach(([x,A])=>A.abortRequest(new Error("DoublePagedPager::preload(".concat(x,"): chapter changed"))))}},[v.id]),t.jsx(B,{ref:m,onClick:g,children:t.jsx(B,{id:"display",sx:{display:"flex",flexDirection:a.readerType==="DoubleLTR"?"row":"row-reverse",justifyContent:"center",width:"auto",height:"auto"},children:j()===2?t.jsx(tr,{index:s,image1src:n[s].src,image2src:n[s+1].src,settings:a},s):t.jsx(ge,{index:s,src:n[s].src,onImageLoad:()=>{},settings:a},s)})})}const ar=i=>{for(let n=0;n<i.children.length;n++){const a=i.children.item(n);if(a){const{top:u,bottom:l}=a.getBoundingClientRect();if(u<=window.innerHeight&&l>1)return n}}return-1},sr=5,or=.95,at=.25,ir="smooth",st=()=>window.innerHeight+window.scrollY>=document.body.offsetHeight-sr,cr=()=>window.scrollY<=0;function ot(i){const{pages:n,settings:a,setCurPage:u,initialPage:l,nextChapter:s,prevChapter:v}=i,f=r.useRef(l),c=r.useRef(null),m=r.useRef([]);r.useEffect(()=>{let d=!1;const o=()=>{if(c.current)if(st()){if(d)return;d=!0,f.current=n.length-1,u(f.current),a.loadNextOnEnding&&s()}else{d=!1;const C=ar(c.current);C!==f.current&&(f.current=C,u(C))}};return window.addEventListener("scroll",o),()=>{window.removeEventListener("scroll",o)}},[a.loadNextOnEnding,s]);const h=r.useRef(0),R=r.useRef(!1);function p(d){R.current=!0,window.scrollBy(0,h.current-d.pageY)}function D(d){var o;h.current=d.pageY,(o=c.current)==null||o.addEventListener("mousemove",p)}function j(){var d;(d=c.current)==null||d.removeEventListener("mousemove",p)}r.useEffect(()=>{var d,o;return(d=c.current)==null||d.addEventListener("mousedown",D),(o=c.current)==null||o.addEventListener("mouseup",j),()=>{var C,P;(C=c.current)==null||C.removeEventListener("mousedown",D),(P=c.current)==null||P.removeEventListener("mouseup",j)}},[c]);const y=r.useCallback((d,o=or)=>{if(d==="down"&&st()){s();return}if(d==="up"&&cr()){v();return}window.scroll({top:window.scrollY+window.innerHeight*o*(d==="up"?-1:1),behavior:ir})},[s,v]);return r.useEffect(()=>{const d=o=>{switch(o.key){case"Space":o.preventDefault(),y(o.shiftKey?"up":"down");break;case"ArrowDown":o.preventDefault(),y(o.shiftKey?"up":"down",at);break;case"ArrowRight":o.preventDefault(),y(o.shiftKey?"up":"down");break;case"ArrowUp":o.preventDefault(),y(o.shiftKey?"down":"up",at);break;case"ArrowLeft":o.preventDefault(),y(o.shiftKey?"down":"up");break}};return document.addEventListener("keydown",d,!1),()=>{document.removeEventListener("keydown",d)}},[y]),ye(m.current[l],r.useCallback((d,o)=>{const C=m.current[l];C!=null&&C.offsetHeight&&(C.scrollIntoView(),o.disconnect())},[m.current[l],l])),t.jsx(B,{ref:c,sx:{display:"flex",flexDirection:"column",justifyContent:"center",width:"auto",height:"auto",userSelect:"none"},onClick:d=>{if(R.current){R.current=!1;return}y(d.clientX>window.innerWidth/2?"down":"up")},children:n.map(d=>t.jsx(ge,{index:d.index,src:d.src,onImageLoad:()=>{},settings:a,ref:o=>{m.current[d.index]=o}},d.index))})}var Pe={},lr=ce;Object.defineProperty(Pe,"__esModule",{value:!0});var dt=Pe.default=void 0,dr=lr(ie()),ur=t;dt=Pe.default=(0,dr.default)((0,ur.jsx)("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Close");var Le={},fr=ce;Object.defineProperty(Le,"__esModule",{value:!0});var se=Le.default=void 0,pr=fr(ie()),gr=t;se=Le.default=(0,pr.default)((0,gr.jsx)("path",{d:"M15.41 16.59 10.83 12l4.58-4.59L14 6l-6 6 6 6z"}),"KeyboardArrowLeft");var Se={},hr=ce;Object.defineProperty(Se,"__esModule",{value:!0});var oe=Se.default=void 0,xr=hr(ie()),mr=t;oe=Se.default=(0,xr.default)((0,mr.jsx)("path",{d:"M8.59 16.59 13.17 12 8.59 7.41 10 6l6 6-6 6z"}),"KeyboardArrowRight");var De={},Cr=ce;Object.defineProperty(De,"__esModule",{value:!0});var ut=De.default=void 0,vr=Cr(ie()),wr=t;ut=De.default=(0,vr.default)((0,wr.jsx)("path",{d:"M7.41 8.59 12 13.17l4.59-4.58L18 10l-6 6-6-6z"}),"KeyboardArrowDown");var je={},Rr=ce;Object.defineProperty(je,"__esModule",{value:!0});var ft=je.default=void 0,Er=Rr(ie()),br=t;ft=je.default=(0,Er.default)((0,br.jsx)("path",{d:"M7.41 15.41 12 10.83l4.59 4.58L18 14l-6-6-6 6z"}),"KeyboardArrowUp");const yr=["addEndListener","appear","children","easing","in","onEnter","onEntered","onEntering","onExit","onExited","onExiting","style","timeout","TransitionComponent"],Pr={entering:{transform:"none"},entered:{transform:"none"}},Lr=r.forwardRef(function(n,a){const u=bt(),l={enter:u.transitions.duration.enteringScreen,exit:u.transitions.duration.leavingScreen},{addEndListener:s,appear:v=!0,children:f,easing:c,in:m,onEnter:h,onEntered:R,onEntering:p,onExit:D,onExited:j,onExiting:y,style:d,timeout:o=l,TransitionComponent:C=Lt}=n,P=yt(n,yr),k=r.useRef(null),g=Pt(k,f.ref,a),e=b=>L=>{if(b){const W=k.current;L===void 0?b(W):b(W,L)}},x=e(p),A=e((b,L)=>{St(b);const W=Ke({style:d,timeout:o,easing:c},{mode:"enter"});b.style.webkitTransition=u.transitions.create("transform",W),b.style.transition=u.transitions.create("transform",W),h&&h(b,L)}),F=e(R),I=e(y),_=e(b=>{const L=Ke({style:d,timeout:o,easing:c},{mode:"exit"});b.style.webkitTransition=u.transitions.create("transform",L),b.style.transition=u.transitions.create("transform",L),D&&D(b)}),re=e(j),H=b=>{s&&s(k.current,b)};return t.jsx(C,Ee({appear:v,in:m,nodeRef:k,onEnter:A,onEntered:F,onEntering:x,onExit:_,onExited:re,onExiting:I,addEndListener:H,timeout:o},P,{children:(b,L)=>r.cloneElement(f,Ee({style:Ee({transform:"scale(0)",visibility:b==="exited"&&!m?"hidden":void 0},Pr[b],d,f.props.style),ref:g},L))}))}),Sr=Lr,Dr=te("div")({zIndex:10}),jr=te("div")(({theme:i})=>({position:"fixed",top:0,left:0,minWidth:"240px",maxWidth:"400px",height:"100vh",overflowY:"auto",backgroundColor:i.palette.background.default,"& header":{backgroundColor:i.palette.action.hover,display:"flex",alignItems:"center",minHeight:"64px",paddingLeft:"24px",paddingRight:"24px",transition:"left 2s ease","& button":{flexGrow:0,flexShrink:0},"& button:nth-child(1)":{marginRight:"16px"},"& h1":{fontSize:"1.25rem",flexGrow:1}}})),Tr=te("div")({margin:"0 16px","& > span:nth-child(1)":{textAlign:"center",display:"block",marginTop:"16px"}}),kr=te("div")({display:"flex",flexWrap:"wrap",alignContent:"center",alignItems:"center",justifyContent:"center"}),_r=te("div")({display:"grid",gridTemplateRows:"auto auto auto",gridTemplateColumns:"0fr 1fr 0fr",gridTemplateAreas:'"pre current next"',gridColumnGap:"5px",margin:"10px 0","& a":{textDecoration:"none",color:"inherit",display:"flex",flexWrap:"wrap",alignContent:"center"}}),Or=te(ee)(({theme:i})=>({position:"fixed",top:20,left:30,height:"40px",width:"40px",borderRadius:5,backgroundColor:i.palette.custom.main,"&:hover":{backgroundColor:i.palette.custom.light}}));function Ar(i){var q;const{t:n}=it(),{setNavBarWidth:a}=Dt(),u=ct(),l=lt(),{prevDrawerOpen:s,prevSettingsCollapseOpen:v}=(q=l.state)!=null?q:{},f=r.useRef(null);ye(f,r.useCallback(()=>{var w;((w=f.current)==null?void 0:w.offsetWidth)!==void 0&&a(f.current.offsetWidth)},[f.current])),r.useEffect(()=>()=>a(0),[f]);const{settings:c,setSettingValue:m,manga:h,chapter:R,chapters:p,curPage:D,scrollToPage:j,openNextChapter:y,retrievingNextChapter:d}=i,o=jt(),C=r.useMemo(()=>new Set(p.map(({scanlator:w})=>w)).size>1,[p]),[P,k]=r.useState(c.staticNav||s),[g,e]=r.useState(!0),[x,A]=r.useState(c.staticNav||s),[F,I]=r.useState(0),[_,re]=r.useState(v!=null?v:!0),H=d,b=(w,N,G)=>{e(w!=="staticNav"),m(w,N,G)},L=w=>{k(w),A(w)},W=()=>{const w=window.pageYOffset;Math.abs(w-F)>20&&(A(w>F),I(w))};return r.useEffect(()=>{g&&L(c.staticNav)},[c.staticNav]),r.useEffect(()=>{window.addEventListener("scroll",W);const w=document.querySelector("#root"),N=document.querySelector("#appMainContainer");return w.style.display="flex",w.style.flexDirection="column",N.style.display="none",()=>{w.style.display="block",N.style.display="block",window.removeEventListener("scroll",W)}},[W]),t.jsxs(Dr,{children:[t.jsx(Tt,{direction:z("right","left"),in:P,timeout:200,appear:!1,mountOnEnter:!0,unmountOnExit:!0,children:t.jsxs(jr,{ref:f,children:[t.jsxs("header",{children:[!c.staticNav&&t.jsx(ne,{title:n("reader.button.close_menu"),children:t.jsx(ee,{edge:"start",color:"inherit","aria-label":"menu",onClick:()=>L(!1),size:"large",children:z(t.jsx(se,{}),t.jsx(oe,{}))})}),t.jsx(kt,{variant:"h1",textOverflow:"ellipsis",overflow:"hidden",sx:{py:1},children:R.name}),t.jsx(ne,{title:n("reader.button.exit"),children:t.jsx(ee,{edge:"start",color:"inherit","aria-label":"menu",onClick:o,size:"large",sx:{mr:-1},children:t.jsx(dt,{})})})]}),t.jsxs(_t,{ContainerComponent:"div",sx:{"& span":{fontWeight:"bold"}},children:[t.jsx(Ot,{primary:n("reader.settings.title.reader_settings")}),t.jsxs(ee,{edge:"start",color:"inherit","aria-label":"menu",disableRipple:!0,disableFocusRipple:!0,onClick:()=>re(!_),size:"large",children:[_&&t.jsx(ft,{}),!_&&t.jsx(ut,{})]})]}),t.jsx(Xt,{in:_,timeout:"auto",unmountOnExit:!0,children:t.jsx(Ht,{setSettingValue:b,staticNav:c.staticNav,showPageNumber:c.showPageNumber,loadNextOnEnding:c.loadNextOnEnding,skipDupChapters:c.skipDupChapters,fitPageToWindow:c.fitPageToWindow,scalePage:c.scalePage,readerType:c.readerType,offsetFirstPage:c.offsetFirstPage,readerWidth:c.readerWidth})}),t.jsx(At,{sx:{my:1,mx:2}}),t.jsxs(Tr,{children:[t.jsxs(kr,{children:[t.jsx("span",{children:n("reader.page_info.label.currently_on_page")}),t.jsx(nt,{size:"small",sx:{margin:"0 5px"},disabled:H||R.pageCount===-1,children:t.jsx(rt,{value:R.pageCount>-1?"".concat(D):"",displayEmpty:!0,onChange:({target:{value:w}})=>{j(Number(w))},children:Array(Math.max(0,R.pageCount)).fill(1).map((w,N)=>t.jsx(Ge,{value:N,children:N+1},"Page#".concat(N)))})}),t.jsx("span",{children:n("reader.page_info.label.of_max_pages",{maxPages:R.pageCount})})]}),t.jsxs(_r,{children:[t.jsx(ne,{title:n("reader.button.previous_chapter"),children:t.jsx(ee,{sx:{gridArea:"pre"},disabled:H||R.sourceOrder<=1,onClick:()=>y(K.PREV),children:z(t.jsx(se,{}),t.jsx(oe,{}))})}),t.jsx(nt,{sx:{gridArea:"current"},size:"small",disabled:H||R.sourceOrder<1,children:t.jsx(rt,{value:R.sourceOrder>=1?"".concat(R.sourceOrder):"",displayEmpty:!0,onChange:({target:{value:w}})=>{u("/manga/".concat(h.id,"/chapter/").concat(w),{replace:!0,state:{prevDrawerOpen:P,prevSettingsCollapseOpen:_}})},children:p.map(({id:w,sourceOrder:N,name:G,chapterNumber:le,scanlator:de})=>t.jsx(Ge,{value:N,children:"#".concat(le).concat(C&&de!=null?" (".concat(de,")"):""," | ").concat(G)},w))})}),t.jsx(ne,{title:n("reader.button.next_chapter"),children:t.jsx(ee,{sx:{gridArea:"next"},disabled:H||R.sourceOrder<1||R.sourceOrder>=h.chapters.totalCount,onClick:()=>y(K.NEXT),children:z(t.jsx(oe,{}),t.jsx(se,{}))})})]})]})]})}),t.jsx(Sr,{in:!P,children:t.jsx(Nt,{in:!x,children:t.jsx(ne,{title:n("reader.button.open_menu"),children:t.jsx(Or,{edge:"start","aria-label":"menu",disableRipple:!0,disableFocusRipple:!0,onClick:()=>L(!0),size:"large",children:z(t.jsx(oe,{}),t.jsx(se,{}))})})})})]})}const ae=i=>O.getFromCache(i,Ft,"CHAPTER_READER_FIELDS"),Nr=i=>{switch(i){case"ContinuesVertical":case"Webtoon":return ot;case"SingleVertical":case"SingleRTL":case"SingleLTR":return er;case"DoubleVertical":case"DoubleRTL":case"DoubleLTR":return nr;case"ContinuesHorizontalLTR":case"ContinuesHorizontalRTL":return Jt;default:return ot}},Ir=i=>Array.from({length:i},(n,a)=>a),Q={pageCount:-1,sourceOrder:-1,chapterCount:0,lastPageRead:0,name:"Loading...",manga:{id:-1}};function Zr(){var Me,Fe,Be,ze,He,qe,Ve,Xe;const{t:i}=it(),n=ct(),a=lt(),{chapterIndex:u,mangaId:l}=It(),s=r.useMemo(()=>({id:+l,title:"",thumbnailUrl:"",genre:[],inLibraryAt:0,lastReadAt:0,chapters:{totalCount:0},trackRecords:{totalCount:0}}),[l]),{data:v,loading:f,error:c,refetch:m}=V.useGetManga(Wt,l),h=r.useRef(null),R=Number(l)===((Me=h.current)==null?void 0:Me.mangaId)&&Number(u)===((Fe=h.current)==null?void 0:Fe.sourceOrder)&&((Be=h.current)==null?void 0:Be.pageCount)!==-1,p=(ze=v==null?void 0:v.manga)!=null?ze:s,{data:D,loading:j,error:y,refetch:d}=V.useGetChapters(Ye,{condition:{mangaId:Number(l),sourceOrder:Number(u)}},{notifyOnNetworkStatusChange:!0}),o=D==null?void 0:D.chapters.nodes[0],C=r.useRef(!1),{settings:{downloadAheadLimit:P}}=Ze(),k=!!P,g=()=>{var M;return h.current&&R?o&&((M=h.current)==null?void 0:M.pageCount)!==o.pageCount?o:h.current:(C.current=!1,o||null)};h.current=g();const e=(He=h.current)!=null?He:Q,x=r.useRef(Q);x.current===Q&&(x.current=e),e.mangaId!==((qe=x.current)==null?void 0:qe.mangaId)&&(x.current=Q);const[A,{loading:F,error:I}]=V.useGetChapterPagesFetch(e.id),_=()=>{!j&&!e.isDownloaded?A().then(()=>{C.current=!0}).catch(U()):C.current=!0};r.useEffect(()=>{_()},[e.id]);const[re,H]=r.useState(!1),[b,L]=r.useState(0),W=b===e.pageCount-1,q=Ut(b,W?0:1e3),[w,N]=r.useState(void 0),{setOverride:G,setTitle:le,navBarWidth:de}=r.useContext($t),[Te,ke]=r.useState(!1),{data:he,loading:pt,error:_e,refetch:gt}=V.useGetMangaChapters(Ye,l,{nextFetchPolicy:"standby"}),E=he==null?void 0:he.chapters.nodes,xe=f||j||pt||F||!C.current&&!y&&!I,Oe=(Xe=(Ve=c!=null?c:y)!=null?Ve:_e)!=null?Xe:I,{settings:me,loading:Ae}=qt(),[S,Ne]=r.useState(et(p,me)),{settings:ue}=Ze(),Ie=r.useMemo(()=>S.skipDupChapters?O.removeDuplicates(x.current,E!=null?E:[]):E!=null?E:[],[x.current,E,S.skipDupChapters]),ht=r.useMemo(()=>O.getNextChapters(e,E!=null?E:[],{offset:K.PREV,skipDupe:S.skipDupChapters,skipDupeChapter:x.current}),[e,x.current,E,S.skipDupChapters]),xt=r.useMemo(()=>O.getNextChapters(e,E!=null?E:[],{skipDupe:S.skipDupChapters,skipDupeChapter:x.current}),[e,x.current,E,S.skipDupChapters]),fe=r.useMemo(()=>O.getNextChapter(e,E!=null?E:[],{offset:K.PREV,skipDupe:S.skipDupChapters,skipDupeChapter:x.current}),[e,x.current,E,S.skipDupChapters]),Y=r.useMemo(()=>O.getNextChapter(e,E!=null?E:[],{skipDupe:S.skipDupChapters,skipDupeChapter:x.current}),[e,x.current,E,S.skipDupChapters]),We=T=>{if(e===Q)return;const $=()=>{if(!(!!T.isRead&&!!ue.deleteChaptersWhileReading)||!E)return[];const J=[e,...ht][ue.deleteChaptersWhileReading-1];if(!J)return[];const ve=ae(J.id);return ve.isRead&&O.isDeletable(ve,ue.deleteChaptersWithBookmark)?S.skipDupChapters?O.getIds(O.addDuplicates([J],E)):O.getIds([J]):[]};(()=>{var we;const pe=ae(e.id),J=((we=T.lastPageRead)!=null?we:0)/e.pageCount>.25;if(k&&p.inLibrary&&!!(pe!=null&&pe.isDownloaded)&&J){const Re=Y?ae(Y.id):null;if(!(Re!=null&&Re.isDownloaded))return;const Ue=O.getNonRead(xt).map(X=>ae(X.id)).slice(-P).filter(X=>!X.isDownloaded).map(X=>X.id).filter(X=>!O.isDownloading(X));if(!Ue.length)return;O.download(Ue).catch(U())}})();const Ce=S.skipDupChapters?O.getIds(O.addDuplicates([e],E!=null?E:[e])):[e.id];V.updateChapters(Ce,{...T,chapterIdsToDelete:$(),trackProgressMangaId:ue.updateProgressAfterReading&&T.isRead&&p.trackRecords.totalCount?p.id:void 0},{errorPolicy:"all"}).response.catch(U())},mt=(T,$,M=!0)=>{Ne({...S,[T]:$}),M&&Bt(p,[[T,$]]).catch(()=>Je(i("reader.settings.error.label.failed_to_save_settings"),"warning"))},Z=r.useCallback(T=>{const $=T===K.NEXT,M=$?Y:fe;if(!M){Je(i($?"reader.error.label.next_chapter_does_not_exist":"reader.error.label.prev_chapter_does_not_exist"),"error");return}ke(!0),L(0),n("/manga/".concat(p.id,"/chapter/").concat(M.sourceOrder),{replace:!0,state:a.state}),ke(!1)},[p.id,fe==null?void 0:fe.id,Y==null?void 0:Y.id]);r.useEffect(()=>{if(xe||!e){L(0);return}H(!0),e.lastPageRead===e.pageCount-1?L(0):L(e.lastPageRead)},[e,xe]),r.useEffect(()=>{!(p!=null&&p.title)||e.name===i("global.label.loading")?le(i("reader.title")):le("".concat(p.title,": ").concat(e.name))},[i,p,e]),r.useEffect(()=>{!Ae&&!f&&(Vt(p,"manga",me).catch(U()),Ne(et(p,me)))},[Ae,f]),r.useEffect(()=>(G({status:!0,value:t.jsx(Ar,{settings:S,setSettingValue:mt,manga:p,chapter:e,chapters:Ie,curPage:b,scrollToPage:N,openNextChapter:Z,retrievingNextChapter:Te})}),()=>G({status:!1,value:t.jsx("div",{})})),[p,e,S,b,u,Te,Z,Ie]),r.useEffect(()=>{if(!re||e===Q)return;const T=ae(e.id);if(q===(T==null?void 0:T.lastPageRead))return;const $=q!==-1,M=q===e.pageCount-1;($||M)&&We({lastPageRead:$?q:void 0,isRead:M?!0:void 0})},[q,k]);const Ct=r.useCallback(()=>{We({lastPageRead:e.pageCount-1,isRead:!0}),Z(K.NEXT)},[e.pageCount,Z,e,p]),vt=r.useCallback(()=>{Z(K.PREV)},[Z]);if(xe)return t.jsx(B,{sx:{height:"100vh",width:"100vw",display:"grid",placeItems:"center"},children:t.jsx(Mt,{thickness:5})});if(Oe)return t.jsx(Qe,{message:i("global.error.label.failed_to_load_data"),messageExtra:Oe.message,retry:()=>{c&&m().catch(U()),y&&d().catch(U()),_e&&gt().catch(U()),I&&_()}});if(!e.pageCount)return t.jsx(Qe,{message:i("reader.error.label.no_pages_found"),retry:_});const wt=Ir(e.pageCount).map(T=>({index:T,src:V.getChapterPageUrl(l,u,T)})),Rt=Nr(S.readerType),Et=w!=null?w:e.lastPageRead===e.pageCount-1?0:e.lastPageRead,$e=S.staticNav?de:0;return t.jsxs(B,{sx:{display:"flex",flexDirection:"column",alignContent:"center",alignItems:"center",justifyContent:"center",minWidth:"calc((100vw - (100vw - 100%)) - ".concat($e,"px)"),minHeight:"100vh",marginLeft:"".concat($e,"px")},children:[t.jsx(Qt,{settings:S,curPage:b,pageCount:e.pageCount}),t.jsx(B,{sx:{alignSelf:"stretch"},children:t.jsx(Rt,{pages:wt,pageCount:e.pageCount,setCurPage:L,initialPage:Et,curPage:b,settings:S,manga:p,chapter:e,nextChapter:Ct,prevChapter:vt},e.id)})]})}export{Zr as Reader};
