import{c as r,v as ye,j as t,B as V,r as ce,i as le,O as nt,as as Rt,at as Pt,au as yt,av as Et,aw as Xe,F as de,u as at,k as bt,ax as Lt,e as st,ay as ot,az as St,aA as Dt,f as ne,I as ae,T as kt,aB as jt,a7 as Tt,aC as _t,a5 as Ke,aD as Nt,a8 as Ot,a as J,aE as At,aF as Ge,l as qe,N as It,m as Ue,h as q,M as Mt,aa as $t,E as Ye,aG as Wt,aH as zt}from"./index-CKBxMd_h.js";import{b as U,C as _}from"./Chapters-C94eQhhe.js";import{P as he,R as Ft,u as Bt,g as Ze,c as Ht}from"./ReaderSettingsOptions-5Kl4FVmP.js";import{S as Qe}from"./Select-CummqEgG.js";import{C as Vt}from"./CustomIconButton-8xEvZSID.js";import{C as Xt}from"./Collapse-C7pJTB29.js";import{a as Je}from"./TextField-DKEWl0kG.js";import{u as Kt}from"./useDebounce-D1FpcHTB.js";import"./NumberSetting-Cyy9C5Bb.js";import"./Info-2xKqwcLI.js";import"./InputAdornment-0ZrWWhgd.js";import"./SpinnerImage-0JZOfick.js";import"./Switch-QjdxAlZw.js";import"./SwitchBase-CSUbfhgD.js";const Gt=s=>{for(let i=0;i<s.children.length;i++){const o=s.children.item(i);if(o){const{left:f,right:c}=o.getBoundingClientRect();if(f<=window.innerWidth/2&&c>window.innerWidth/2)return i}}return-1},qt=5,Ut=()=>window.innerWidth+window.scrollX>=document.body.scrollWidth-qt,Yt=()=>window.scrollX<=0;function Zt(s){const{pages:i,curPage:o,initialPage:f,settings:c,setCurPage:u,prevChapter:D,nextChapter:P}=s,h=r.useRef(f),p=r.useRef(null),l=r.useRef([]);function S(){var e;o<i.length-1?((e=l.current[o+1])==null||e.scrollIntoView({inline:"center"}),u(d=>d+1)):c.loadNextOnEnding&&P()}function g(){var e;o>0?((e=l.current[o-1])==null||e.scrollIntoView({inline:"center"}),u(o-1)):o===0&&D()}function m(){c.readerType==="ContinuesHorizontalLTR"?g():S()}function j(){c.readerType==="ContinuesHorizontalLTR"?S():g()}const E=r.useRef(0);function n(e){window.scrollBy(E.current-e.pageX,0)}function a(e){var d;E.current=e.pageX,(d=p.current)==null||d.addEventListener("mousemove",n)}function y(){var e;(e=p.current)==null||e.removeEventListener("mousemove",n)}function N(e){e.clientX>=window.innerWidth*.85?j():e.clientX<=window.innerWidth*.15&&m()}function O(e){window.scrollBy({left:c.readerType==="ContinuesHorizontalLTR"?e.deltaY:e.deltaY*-1})}const v=()=>{c.readerType==="ContinuesHorizontalLTR"?window.scrollX+window.innerWidth>=document.body.scrollWidth&&P():c.readerType==="ContinuesHorizontalRTL"&&window.scrollX<=window.innerWidth&&P()};return ye(l.current[f],r.useCallback((e,d)=>{const R=l.current[f];R!=null&&R.offsetHeight&&(R.scrollIntoView({inline:"center"}),d.disconnect())},[l.current[f],f])),r.useEffect(()=>{var e,d;return(e=p.current)==null||e.addEventListener("mousedown",a),(d=p.current)==null||d.addEventListener("mouseup",y),()=>{var R,A;(R=p.current)==null||R.removeEventListener("mousedown",a),(A=p.current)==null||A.removeEventListener("mouseup",y)}},[p]),r.useEffect(()=>(c.loadNextOnEnding&&document.addEventListener("scroll",v),()=>{document.removeEventListener("scroll",v)}),[p,o,D,P]),r.useEffect(()=>{const e=()=>{if(!p.current)return;const d=Gt(p.current);d!==h.current&&(h.current=d,u(d)),(c.readerType==="ContinuesHorizontalLTR"?Ut():Yt())&&(h.current=i.length-1,u(h.current))};return window.addEventListener("scroll",e),()=>window.removeEventListener("scroll",e)},[c.readerType]),t.jsx(V,{ref:p,sx:{display:"flex",flexDirection:c.readerType==="ContinuesHorizontalLTR"?"row":"row-reverse",justifyContent:c.readerType==="ContinuesHorizontalLTR"?"flex-start":"flex-end",width:"auto",height:"auto",overflowX:"visible",userSelect:"none"},onClick:N,onWheel:O,children:i.map(e=>t.jsx(he,{index:e.index,src:e.src,onImageLoad:()=>{},settings:c,ref:d=>{l.current[e.index]=d}},e.index))})}function Qt(s){const{settings:i,curPage:o,pageCount:f}=s;return t.jsx(V,{sx:{display:i.showPageNumber?"block":"none",position:"fixed",bottom:"50px",padding:"2px",paddingLeft:"4px",paddingRight:"4px",textAlign:"center",backgroundColor:"rgba(0, 0, 0, 0.3)",borderRadius:"10px"},children:"".concat(o+1," / ").concat(f)})}function Jt(s){const{pages:i,settings:o,setCurPage:f,initialPage:c,curPage:u,nextChapter:D,prevChapter:P}=s,h=r.useRef(null),p=n=>{f(n),window.scroll({top:0})};function l(){u<i.length-1?p(u+1):o.loadNextOnEnding&&D()}function S(){u>0?p(u-1):P()}function g(){o.readerType==="SingleLTR"?S():o.readerType==="SingleRTL"&&l()}function m(){o.readerType==="SingleLTR"?l():o.readerType==="SingleRTL"&&S()}function j(n){switch(n.key){case"Space":n.preventDefault(),l();break;case"ArrowRight":m();break;case"ArrowLeft":g();break}}function E(n){n.clientX>window.innerWidth/2?m():g()}return r.useEffect(()=>(document.addEventListener("keydown",j),()=>{document.removeEventListener("keydown",j)}),[h,u,o.readerType,P,D]),r.useEffect(()=>{setTimeout(()=>{p(c)},0)},[c]),t.jsx(V,{ref:h,sx:{display:"flex",flexDirection:"column",justifyContent:"center",width:"auto",height:"auto"},onClick:E,children:i.map(({index:n,src:a})=>t.jsx(he,{index:n,onImageLoad:()=>{},src:a,settings:o,display:n===u},a))})}const er=s=>s.height/s.width<1;function tr(s){const{pages:i,settings:o,setCurPage:f,initialPage:c,curPage:u,nextChapter:D,prevChapter:P}=s,h=r.useRef(null),p=r.useRef([]),l=r.useRef([]),[S,g]=r.useState(Array(i.length).fill(!1)),[m,j]=r.useState(Array(i.length).fill(!1));function E(){const v=R=>f(R===-1?i.length-1:R);if(p.current[i.length-1]&&o.loadNextOnEnding){u===i.length-1||v(i.length-1),D();return}const d=p.current.findIndex((R,A)=>!R&&A>u);v(d)}function n(){const v=R=>f(Math.max(R,0));if(p.current[0]){!u||v(0),P();return}const d=[...p.current].slice(0,u).findLastIndex(R=>!R);v(d)}function a(){o.readerType==="DoubleLTR"?n():E()}function y(){o.readerType==="DoubleLTR"?E():n()}function N(v){switch(v.key){case"Space":v.preventDefault(),E();break;case"ArrowRight":y();break;case"ArrowLeft":a();break}}function O(v){v.clientX>window.innerWidth/2?y():a()}return r.useEffect(()=>(document.addEventListener("keydown",N),()=>{document.removeEventListener("keydown",N)}),[h,u,o.readerType,P,D,m,S]),r.useEffect(()=>{f(c)},[c]),t.jsx(V,{ref:h,onClick:O,children:t.jsx(V,{id:"display",sx:{display:"flex",flexDirection:o.readerType==="DoubleLTR"?"row":"row-reverse",justifyContent:"center",width:"auto",height:"auto"},children:i.map(({index:v,src:e})=>{const d=(()=>{let b=l.current[u];return b===void 0&&(b=Math.max(S.lastIndexOf(!0,u),0),m.slice(0,u).every(Boolean)&&(l.current[u]=b)),b>0?b+1:b})(),R=u-d,A=u===0,F=Number(o.offsetFirstPage)+Number(o.offsetFirstPage&&!R&&!A),K=!((R-F)%2),I=u+(K?1:-1),C=v===u,L=v===I,M=S[u],$=S[I],x=C||L&&!(M||$);return p.current[v]=x,t.jsx(he,{index:v,src:e,onImageLoad:()=>{const b=new Image;b.onload=()=>{j(B=>B.toSpliced(v,1,!0)),g(B=>B.toSpliced(v,1,er(b)))},b.src=e},settings:o,display:x},e)})})})}const rr=s=>{for(let i=0;i<s.children.length;i++){const o=s.children.item(i);if(o){const{top:f,bottom:c}=o.getBoundingClientRect();if(f<=window.innerHeight&&c>1)return i}}return-1},nr=5,ar=.95,et=.25,sr="smooth",tt=()=>window.innerHeight+window.scrollY>=document.body.offsetHeight-nr,or=()=>window.scrollY<=0;function rt(s){const{pages:i,settings:o,setCurPage:f,initialPage:c,nextChapter:u,prevChapter:D}=s,P=r.useRef(c),h=r.useRef(null),p=r.useRef([]);r.useEffect(()=>{let n=!1;const a=()=>{if(h.current)if(tt()){if(n)return;n=!0,P.current=i.length-1,f(P.current),o.loadNextOnEnding&&u()}else{n=!1;const y=rr(h.current);y!==P.current&&(P.current=y,f(y))}};return window.addEventListener("scroll",a),()=>{window.removeEventListener("scroll",a)}},[o.loadNextOnEnding,u]);const l=r.useRef(0),S=r.useRef(!1);function g(n){S.current=!0,window.scrollBy(0,l.current-n.pageY)}function m(n){var a;l.current=n.pageY,(a=h.current)==null||a.addEventListener("mousemove",g)}function j(){var n;(n=h.current)==null||n.removeEventListener("mousemove",g)}r.useEffect(()=>{var n,a;return(n=h.current)==null||n.addEventListener("mousedown",m),(a=h.current)==null||a.addEventListener("mouseup",j),()=>{var y,N;(y=h.current)==null||y.removeEventListener("mousedown",m),(N=h.current)==null||N.removeEventListener("mouseup",j)}},[h]);const E=r.useCallback((n,a=ar)=>{if(n==="down"&&tt()){u();return}if(n==="up"&&or()){D();return}window.scroll({top:window.scrollY+window.innerHeight*a*(n==="up"?-1:1),behavior:sr})},[u,D]);return r.useEffect(()=>{const n=a=>{switch(a.key){case"Space":a.preventDefault(),E(a.shiftKey?"up":"down");break;case"ArrowDown":a.preventDefault(),E(a.shiftKey?"up":"down",et);break;case"ArrowRight":a.preventDefault(),E(a.shiftKey?"up":"down");break;case"ArrowUp":a.preventDefault(),E(a.shiftKey?"down":"up",et);break;case"ArrowLeft":a.preventDefault(),E(a.shiftKey?"down":"up");break}};return document.addEventListener("keydown",n,!1),()=>{document.removeEventListener("keydown",n)}},[E]),ye(p.current[c],r.useCallback((n,a)=>{const y=p.current[c];y!=null&&y.offsetHeight&&(y.scrollIntoView(),a.disconnect())},[p.current[c],c])),t.jsx(V,{ref:h,sx:{display:"flex",flexDirection:"column",justifyContent:"center",width:"auto",height:"auto",userSelect:"none"},onClick:n=>{if(S.current){S.current=!1;return}E(n.clientX>window.innerWidth/2?"down":"up")},children:i.map(n=>t.jsx(he,{index:n.index,src:n.src,onImageLoad:()=>{},settings:o,ref:a=>{p.current[n.index]=a}},n.index))})}var Ee={},ir=le;Object.defineProperty(Ee,"__esModule",{value:!0});var it=Ee.default=void 0,cr=ir(ce()),lr=t;it=Ee.default=(0,cr.default)((0,lr.jsx)("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Close");var be={},dr=le;Object.defineProperty(be,"__esModule",{value:!0});var oe=be.default=void 0,ur=dr(ce()),pr=t;oe=be.default=(0,ur.default)((0,pr.jsx)("path",{d:"M15.41 16.59 10.83 12l4.58-4.59L14 6l-6 6 6 6z"}),"KeyboardArrowLeft");var Le={},fr=le;Object.defineProperty(Le,"__esModule",{value:!0});var ie=Le.default=void 0,gr=fr(ce()),hr=t;ie=Le.default=(0,gr.default)((0,hr.jsx)("path",{d:"M8.59 16.59 13.17 12 8.59 7.41 10 6l6 6-6 6z"}),"KeyboardArrowRight");var Se={},xr=le;Object.defineProperty(Se,"__esModule",{value:!0});var ct=Se.default=void 0,mr=xr(ce()),vr=t;ct=Se.default=(0,mr.default)((0,vr.jsx)("path",{d:"M7.41 8.59 12 13.17l4.59-4.58L18 10l-6 6-6-6z"}),"KeyboardArrowDown");var De={},Cr=le;Object.defineProperty(De,"__esModule",{value:!0});var lt=De.default=void 0,wr=Cr(ce()),Rr=t;lt=De.default=(0,wr.default)((0,Rr.jsx)("path",{d:"M7.41 15.41 12 10.83l4.59 4.58L18 14l-6-6-6 6z"}),"KeyboardArrowUp");const Pr={entering:{transform:"none"},entered:{transform:"none"}},yr=r.forwardRef(function(i,o){const f=nt(),c={enter:f.transitions.duration.enteringScreen,exit:f.transitions.duration.leavingScreen},{addEndListener:u,appear:D=!0,children:P,easing:h,in:p,onEnter:l,onEntered:S,onEntering:g,onExit:m,onExited:j,onExiting:E,style:n,timeout:a=c,TransitionComponent:y=yt,...N}=i,O=r.useRef(null),v=Rt(O,Pt(P),o),e=C=>L=>{if(C){const M=O.current;L===void 0?C(M):C(M,L)}},d=e(g),R=e((C,L)=>{Et(C);const M=Xe({style:n,timeout:a,easing:h},{mode:"enter"});C.style.webkitTransition=f.transitions.create("transform",M),C.style.transition=f.transitions.create("transform",M),l&&l(C,L)}),A=e(S),F=e(E),H=e(C=>{const L=Xe({style:n,timeout:a,easing:h},{mode:"exit"});C.style.webkitTransition=f.transitions.create("transform",L),C.style.transition=f.transitions.create("transform",L),m&&m(C)}),K=e(j),I=C=>{u&&u(O.current,C)};return t.jsx(y,{appear:D,in:p,nodeRef:O,onEnter:R,onEntered:A,onEntering:d,onExit:H,onExited:K,onExiting:F,addEndListener:I,timeout:a,...N,children:(C,L)=>r.cloneElement(P,{style:{transform:"scale(0)",visibility:C==="exited"&&!p?"hidden":void 0,...Pr[C],...n,...P.props.style},ref:v,...L})})}),Er=de("div")({zIndex:10}),br=de("div")(({theme:s})=>({position:"fixed",top:0,left:0,minWidth:"240px",maxWidth:"400px",height:"100vh",overflowY:"auto",backgroundColor:s.palette.background.default,"& header":{backgroundColor:s.palette.action.hover,display:"flex",alignItems:"center",padding:"".concat(s.spacing(1)," ").concat(s.spacing(3)),transition:"left 2s ease"}})),Lr=de("div")(({theme:s})=>({margin:"0 ".concat(s.spacing(2))})),Sr=de("div")({display:"flex",flexWrap:"wrap",alignContent:"center",alignItems:"center",justifyContent:"center"}),Dr=de("div")(({theme:s})=>({display:"grid",gridTemplateRows:"auto auto auto",gridTemplateColumns:"0fr 1fr 0fr",gridTemplateAreas:'"pre current next"',gridColumnGap:s.spacing(.5),margin:"".concat(s.spacing(1)," 0"),"& a":{textDecoration:"none",color:"inherit",display:"flex",flexWrap:"wrap",alignContent:"center"}}));function kr(s){var te;const{t:i}=at(),{setReaderNavBarWidth:o}=bt(),f=nt(),c=Lt(),u=st(),D=ot(),{prevDrawerOpen:P,prevSettingsCollapseOpen:h}=(te=D.state)!=null?te:{},p=r.useRef(null);ye(p,r.useCallback(()=>{var x;((x=p.current)==null?void 0:x.offsetWidth)!==void 0&&o(p.current.offsetWidth)},[p.current])),r.useLayoutEffect(()=>()=>o(0),[p]);const{settings:l,setSettingValue:S,manga:g,chapter:m,chapters:j,curPage:E,scrollToPage:n,openNextChapter:a,retrievingNextChapter:y}=s,N=St(),O=r.useMemo(()=>new Set(j.map(({scanlator:x})=>x)).size>1,[j]),[v,e]=r.useState(l.staticNav||P),[d,R]=r.useState(!0),[A,F]=r.useState(l.staticNav||P),[H,K]=r.useState(0),[I,C]=r.useState(h!=null?h:!0),L=y,M=(x,b,B)=>{R(x!=="staticNav"),S(x,b,B)},$=x=>{e(x),F(x)},X=()=>{const x=window.pageYOffset;Math.abs(x-H)>20&&(F(x>H),K(x))};return r.useEffect(()=>{d&&$(l.staticNav)},[l.staticNav]),r.useEffect(()=>{window.addEventListener("scroll",X);const x=document.querySelector("#root"),b=document.querySelector("#appMainContainer");return x.style.display="flex",x.style.flexDirection="column",b.style.display="none",()=>{x.style.display="block",b.style.display="block",window.removeEventListener("scroll",X)}},[X]),t.jsxs(Er,{children:[t.jsx(Dt,{direction:c("right","left"),in:v,timeout:200,appear:!1,mountOnEnter:!0,unmountOnExit:!0,children:t.jsxs(br,{ref:p,children:[t.jsxs("header",{children:[!l.staticNav&&t.jsx(ne,{title:i("reader.button.close_menu"),children:t.jsx(ae,{edge:"start",color:"inherit","aria-label":"menu",onClick:()=>$(!1),size:"large",children:c(t.jsx(oe,{}),t.jsx(ie,{}))})}),t.jsx(kt,{variant:"h6",component:"h1",sx:{textOverflow:"ellipsis",overflow:"hidden",py:1,flexGrow:1},children:m.name}),t.jsx(ne,{title:i("reader.button.exit"),children:t.jsx(ae,{edge:"start",color:"inherit","aria-label":"menu",onClick:N,size:"large",sx:{mr:-1},children:t.jsx(it,{})})})]}),t.jsxs(jt,{ContainerComponent:"div",sx:{"& span":{fontWeight:"bold"}},children:[t.jsx(Tt,{primary:i("reader.settings.title.reader_settings")}),t.jsxs(ae,{edge:"start",color:"inherit","aria-label":"menu",disableRipple:!0,disableFocusRipple:!0,onClick:()=>C(!I),size:"large",children:[I&&t.jsx(lt,{}),!I&&t.jsx(ct,{})]})]}),t.jsx(Xt,{in:I,timeout:"auto",unmountOnExit:!0,children:t.jsx(Ft,{setSettingValue:M,staticNav:l.staticNav,showPageNumber:l.showPageNumber,loadNextOnEnding:l.loadNextOnEnding,skipDupChapters:l.skipDupChapters,fitPageToWindow:l.fitPageToWindow,scalePage:l.scalePage,readerType:l.readerType,offsetFirstPage:l.offsetFirstPage,readerWidth:l.readerWidth})}),t.jsx(_t,{sx:{my:1,mx:2}}),t.jsxs(Lr,{children:[t.jsxs(Sr,{children:[t.jsx("span",{children:i("reader.page_info.label.currently_on_page")}),t.jsx(Je,{size:"small",sx:{mx:.5},disabled:L||m.pageCount===-1,children:t.jsx(Qe,{value:m.pageCount>-1?"".concat(E):"",displayEmpty:!0,onChange:({target:{value:x}})=>{n(Number(x))},children:Array(Math.max(0,m.pageCount)).fill(1).map((x,b)=>t.jsx(Ke,{value:b,children:b+1},"Page#".concat(b)))})}),t.jsx("span",{children:i("reader.page_info.label.of_max_pages",{maxPages:m.pageCount})})]}),t.jsxs(Dr,{children:[t.jsx(ne,{title:i("reader.button.previous_chapter"),children:t.jsx(ae,{sx:{gridArea:"pre"},disabled:L||m.sourceOrder<=1,onClick:()=>a(U.PREV),children:c(t.jsx(oe,{}),t.jsx(ie,{}))})}),t.jsx(Je,{sx:{gridArea:"current"},size:"small",disabled:L||m.sourceOrder<1,children:t.jsx(Qe,{value:m.sourceOrder>=1?"".concat(m.sourceOrder):"",displayEmpty:!0,onChange:({target:{value:x}})=>{u("/manga/".concat(g.id,"/chapter/").concat(x),{replace:!0,state:{prevDrawerOpen:v,prevSettingsCollapseOpen:I}})},children:j.map(({id:x,sourceOrder:b,name:B,chapterNumber:ue,scanlator:re})=>t.jsx(Ke,{value:b,children:"#".concat(ue).concat(O&&re!=null?" (".concat(re,")"):""," | ").concat(B)},x))})}),t.jsx(ne,{title:i("reader.button.next_chapter"),children:t.jsx(ae,{sx:{gridArea:"next"},disabled:L||m.sourceOrder<1||m.sourceOrder>=g.chapters.totalCount,onClick:()=>a(U.NEXT),children:c(t.jsx(ie,{}),t.jsx(oe,{}))})})]})]})]})}),t.jsx(yr,{in:!v,children:t.jsx(Nt,{in:!A,children:t.jsx(ne,{title:i("reader.button.open_menu"),children:t.jsx(Vt,{sx:{position:"fixed",top:20,left:20,backgroundColor:"rgba(255, 255, 255, 0.75);",color:"black",...f.applyStyles("dark",{backgroundColor:"rgba(0, 0, 0, 0.75);",color:"white"})},size:"large",variant:"contained",onClick:()=>$(!0),children:c(t.jsx(ie,{}),t.jsx(oe,{}))})})})})]})}const se=s=>_.getFromCache(s,Wt,"CHAPTER_READER_FIELDS"),jr=s=>{switch(s){case"ContinuesVertical":case"Webtoon":return rt;case"SingleVertical":case"SingleRTL":case"SingleLTR":return Jt;case"DoubleVertical":case"DoubleRTL":case"DoubleLTR":return tr;case"ContinuesHorizontalLTR":case"ContinuesHorizontalRTL":return Zt;default:return rt}},Tr=s=>Array.from({length:s},(i,o)=>o),ee={pageCount:-1,sourceOrder:-1,chapterCount:0,lastPageRead:0,name:"Loading...",manga:{id:-1}};function Gr(){var Ie,Me,$e,We,ze,Fe,Be,He;const{t:s}=at(),i=st(),o=ot(),{chapterIndex:f,mangaId:c}=Ot(),u=r.useMemo(()=>({id:+c,title:"",thumbnailUrl:"",genre:[],inLibraryAt:0,lastReadAt:0,chapters:{totalCount:0},trackRecords:{totalCount:0}}),[c]),{data:D,loading:P,error:h,refetch:p}=J.useGetManga(At,c),l=r.useRef(null),S=Number(c)===((Ie=l.current)==null?void 0:Ie.mangaId)&&Number(f)===((Me=l.current)==null?void 0:Me.sourceOrder)&&(($e=l.current)==null?void 0:$e.pageCount)!==-1,g=(We=D==null?void 0:D.manga)!=null?We:u,{data:m,loading:j,error:E,refetch:n}=J.useGetChapters(Ge,{condition:{mangaId:Number(c),sourceOrder:Number(f)}},{notifyOnNetworkStatusChange:!0}),a=m==null?void 0:m.chapters.nodes[0],y=r.useRef(!1),{settings:{downloadAheadLimit:N}}=qe(),O=!!N,v=()=>{var z;return l.current&&S?a&&((z=l.current)==null?void 0:z.pageCount)!==a.pageCount?a:l.current:(y.current=!1,a||null)};l.current=v();const e=(ze=l.current)!=null?ze:ee,d=r.useRef(ee);d.current===ee&&(d.current=e),e.mangaId!==((Fe=d.current)==null?void 0:Fe.mangaId)&&(d.current=ee);const[R,{loading:A,error:F}]=J.useGetChapterPagesFetch(e.id),H=()=>{j||R().then(()=>{y.current=!0}).catch(q())};r.useEffect(()=>{H()},[e.id]);const[K,I]=r.useState(!1),[C,L]=r.useState(0),M=C===e.pageCount-1,$=Kt(C,M?0:1e3),[X,te]=r.useState(void 0),{setOverride:x,setTitle:b,readerNavBarWidth:B}=r.useContext(It),[ue,re]=r.useState(!1),{data:xe,loading:dt,error:ke,refetch:ut}=J.useGetMangaChapters(Ge,c,{nextFetchPolicy:"standby"}),w=xe==null?void 0:xe.chapters.nodes,me=P||j||dt||A||!y.current&&!E&&!F,je=(He=(Be=h!=null?h:E)!=null?Be:ke)!=null?He:F,{settings:ve,loading:Te}=Bt(),[k,_e]=r.useState(Ze(g,ve)),{settings:pe}=qe(),Ne=r.useMemo(()=>k.skipDupChapters?_.removeDuplicates(d.current,w!=null?w:[]):w!=null?w:[],[d.current,w,k.skipDupChapters]),pt=r.useMemo(()=>_.getNextChapters(e,w!=null?w:[],{offset:U.PREV,skipDupe:k.skipDupChapters,skipDupeChapter:d.current}),[e,d.current,w,k.skipDupChapters]),ft=r.useMemo(()=>_.getNextChapters(e,w!=null?w:[],{skipDupe:k.skipDupChapters,skipDupeChapter:d.current}),[e,d.current,w,k.skipDupChapters]),fe=r.useMemo(()=>_.getNextChapter(e,w!=null?w:[],{offset:U.PREV,skipDupe:k.skipDupChapters,skipDupeChapter:d.current}),[e,d.current,w,k.skipDupChapters]),Y=r.useMemo(()=>_.getNextChapter(e,w!=null?w:[],{skipDupe:k.skipDupChapters,skipDupeChapter:d.current}),[e,d.current,w,k.skipDupChapters]),Oe=T=>{if(e===ee)return;const W=()=>{if(!(!!T.isRead&&!!pe.deleteChaptersWhileReading)||!w)return[];const Q=[e,...pt][pe.deleteChaptersWhileReading-1];if(!Q)return[];const we=se(Q.id);return we.isRead&&_.isDeletable(we,pe.deleteChaptersWithBookmark)?k.skipDupChapters?_.getIds(_.addDuplicates([Q],w)):_.getIds([Q]):[]};(()=>{var Re;const ge=se(e.id),Q=((Re=T.lastPageRead)!=null?Re:0)/e.pageCount>.25;if(O&&g.inLibrary&&!!(ge!=null&&ge.isDownloaded)&&Q){const Pe=Y?se(Y.id):null;if(!(Pe!=null&&Pe.isDownloaded))return;const Ve=_.getNonRead(ft).map(G=>se(G.id)).slice(-N).filter(G=>!G.isDownloaded).map(G=>G.id).filter(G=>!_.isDownloading(G));if(!Ve.length)return;_.download(Ve).catch(q())}})();const Ce=k.skipDupChapters?_.getIds(_.addDuplicates([e],w!=null?w:[e])):[e.id];J.updateChapters(Ce,{...T,chapterIdsToDelete:W(),trackProgressMangaId:pe.updateProgressAfterReading&&T.isRead&&g.trackRecords.totalCount?g.id:void 0},{errorPolicy:"all"}).response.catch(q())},gt=(T,W,z=!0)=>{_e({...k,[T]:W}),z&&zt(g,[[T,W]]).catch(()=>Ue(s("reader.settings.error.label.failed_to_save_settings"),"warning"))},Z=r.useCallback(T=>{const W=T===U.NEXT,z=W?Y:fe;if(!z){Ue(s(W?"reader.error.label.next_chapter_does_not_exist":"reader.error.label.prev_chapter_does_not_exist"),"error");return}re(!0),L(0),i("/manga/".concat(g.id,"/chapter/").concat(z.sourceOrder),{replace:!0,state:o.state}),re(!1)},[g.id,fe==null?void 0:fe.id,Y==null?void 0:Y.id]);r.useEffect(()=>{if(me||!e){L(0);return}I(!0),e.lastPageRead===e.pageCount-1?L(0):L(e.lastPageRead)},[e,me]),r.useLayoutEffect(()=>{!(g!=null&&g.title)||e.name===s("global.label.loading")?b(s("reader.title")):b("".concat(g.title,": ").concat(e.name))},[s,g,e]),r.useEffect(()=>{!Te&&!P&&(Ht(g,"manga",ve).catch(q()),_e(Ze(g,ve)))},[Te,P]),r.useLayoutEffect(()=>(x({status:!0,value:t.jsx(kr,{settings:k,setSettingValue:gt,manga:g,chapter:e,chapters:Ne,curPage:C,scrollToPage:te,openNextChapter:Z,retrievingNextChapter:ue})}),()=>x({status:!1,value:t.jsx("div",{})})),[g,e,k,C,f,ue,Z,Ne]),r.useEffect(()=>{if(!K||e===ee)return;const T=se(e.id);if($===(T==null?void 0:T.lastPageRead))return;const W=$!==-1,z=$===e.pageCount-1;(W||z)&&Oe({lastPageRead:W?$:void 0,isRead:z?!0:void 0})},[$,O]);const ht=r.useCallback(()=>{Oe({lastPageRead:e.pageCount-1,isRead:!0}),Z(U.NEXT)},[e.pageCount,Z,e,g]),xt=r.useCallback(()=>{Z(U.PREV)},[Z]),mt=Mt.useGetScrollbarSize("height");if(me)return t.jsx(V,{sx:{height:"100vh",width:"100vw",display:"grid",placeItems:"center"},children:t.jsx($t,{thickness:5})});if(je)return t.jsx(Ye,{message:s("global.error.label.failed_to_load_data"),messageExtra:je.message,retry:()=>{h&&p().catch(q()),E&&n().catch(q()),ke&&ut().catch(q()),F&&H()}});if(!e.pageCount)return t.jsx(Ye,{message:s("reader.error.label.no_pages_found"),retry:H});const vt=Tr(e.pageCount).map(T=>({index:T,src:J.getChapterPageUrl(c,f,T)})),Ct=jr(k.readerType),wt=X!=null?X:e.lastPageRead===e.pageCount-1?0:e.lastPageRead,Ae=k.staticNav?B:0;return t.jsxs(V,{sx:{display:"flex",flexDirection:"column",alignContent:"center",alignItems:"center",justifyContent:"center",minWidth:"calc((100vw - (100vw - 100%)) - ".concat(Ae,"px)"),minHeight:"calc(100vh - ".concat(mt,"px)"),marginLeft:"".concat(Ae,"px")},children:[t.jsx(Qt,{settings:k,curPage:C,pageCount:e.pageCount}),t.jsx(V,{sx:{alignSelf:"stretch"},children:t.jsx(Ct,{pages:vt,pageCount:e.pageCount,setCurPage:L,initialPage:wt,curPage:C,settings:k,manga:g,chapter:e,nextChapter:ht,prevChapter:xt},e.id)})]})}export{Gr as Reader};
