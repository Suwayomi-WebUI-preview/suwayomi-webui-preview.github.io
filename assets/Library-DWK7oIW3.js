import{u as B,r as E,P as Se,Q as ge,q as z,j as t,U as A,W as je,X as ke,Y as T,Z as v,_ as D,$ as _e,y as Te,n as ne,l as ie,f as p,a0 as W,i as pe,I as Me,a1 as Fe,a2 as P,a3 as Le,a4 as Ae,a5 as Ie,a6 as we,m as G,a7 as Be,a8 as Re,N as ve,E as ce,k as Oe,D as Ee,F as Ne,G as De}from"./index-B7Sl-1yA.js";import{u as be,S as Ge,A as Ue,N as Pe}from"./AppbarSearch-DlxyWuXq.js";import{F as ze}from"./FilterList-BqSe7cTw.js";import{S as We,R as U}from"./SortRadioInput-DXDbzdBt.js";import{T as k}from"./ThreeStateCheckboxInput-BYNud1Jn.js";import{O as Ye,S as Ke,a as He}from"./SelectionFAB-B2bD2pIe.js";import{T as Ve}from"./Trackers-D4pSmk7a.js";import{R as Qe}from"./ListPreference-stsgP_s6.js";import{M as Xe,a as Ze}from"./MangaGrid-CDj7apsA.js";import{C as $e,U as Je}from"./UpdateChecker-Mz0Eb7uT.js";import{u as qe}from"./useManageMangaLibraryState-CA8crvIC.js";import{T as ea}from"./TabsWrapper-D0xxTxFB.js";import{C as aa}from"./Chip-CmUI1ex7.js";import"./StyledFab-CymjjoNB.js";import"./Sync-DCL_s_vM.js";import"./Avatar-CAj2m8aG.js";import"./PlayArrow-DXDZVn8q.js";import"./Progress-aUMRVuGh.js";import"./Info-CPimqJs6.js";import"./CheckCircle-DEiml39V.js";import"./NumberSetting-C-xZtrwI.js";import"./useMobilePicker-D1JgBFFL.js";import"./SelectSetting-CxpYBwVY.js";const ta={filter:"global.label.filter",sort:"global.label.sort",display:"global.label.display"},sa=[["unreadChapters","library.option.sort.label.by_unread_chapters"],["totalChapters","library.option.sort.label.by_total_chapters"],["alphabetically","library.option.sort.label.alphabetically"],["dateAdded","library.option.sort.label.by_date_added"],["lastRead","library.option.sort.label.by_last_read"],["latestFetchedChapter","library.option.sort.label.by_latest_fetched_chapter"],["latestUploadedChapter","library.option.sort.label.by_latest_uploaded_chapter"]],ra=({category:e,open:s,onClose:n})=>{var h,C;const{t:a}=B(),l=E.useGetTrackerList(Se),o=Ve.getLoggedIn((C=(h=l.data)==null?void 0:h.trackers.nodes)!=null?C:[]),r=ge(e),i=_e(e,u=>ne(a("global.error.label.failed_to_save_changes"),"error",ie(u))),{settings:{showTabSize:g,showContinueReadingButton:x,showDownloadBadge:M,showUnreadBadge:f}}=z(),y=Te(u=>ne(a("search.error.label.failed_to_save_settings"),"error",ie(u)));return t.jsx(Ye,{open:s,onClose:n,tabs:["filter","sort","display"],tabTitle:u=>a(ta[u]),tabContent:u=>{if(u==="filter")return t.jsxs(t.Fragment,{children:[t.jsx(k,{label:a("global.filter.label.unread"),checked:r.hasUnreadChapters,onChange:c=>i("hasUnreadChapters",c)}),t.jsx(k,{label:a("global.filter.label.started"),checked:r.hasReadChapters,onChange:c=>i("hasReadChapters",c)}),t.jsx(k,{label:a("global.filter.label.downloaded"),checked:r.hasDownloadedChapters,onChange:c=>i("hasDownloadedChapters",c)}),t.jsx(k,{label:a("global.filter.label.bookmarked"),checked:r.hasBookmarkedChapters,onChange:c=>i("hasBookmarkedChapters",c)}),t.jsx(k,{label:a("global.filter.label.duplicate_chapters"),checked:r.hasDuplicateChapters,onChange:c=>i("hasDuplicateChapters",c)}),t.jsx(A,{sx:{mt:2},children:a("manga.label.status")}),Object.values(je).map(c=>t.jsx(k,{label:a(ke[c]),checked:r.hasStatus[c],onChange:b=>i("hasStatus",{...r.hasStatus,[c]:b})},c)),t.jsx(A,{sx:{mt:2},children:a("global.filter.label.tracked")}),o.map(c=>t.jsx(k,{label:c.name,checked:r.hasTrackerBinding[c.id],onChange:b=>i("hasTrackerBinding",{...r.hasTrackerBinding,[c.id]:b})},c.id))]});if(u==="sort")return sa.map(([c,b])=>t.jsx(We,{label:a(b),checked:r.sortBy===c,sortDescending:r.sortDesc,onClick:()=>c!==r.sortBy?i("sortBy",c):i("sortDesc",!r.sortDesc)},c));if(u==="display"){const{gridLayout:c}=r;return t.jsxs(t.Fragment,{children:[t.jsx(A,{children:a("global.grid_layout.title")}),t.jsxs(Qe,{onChange:b=>i("gridLayout",Number(b.target.value)),value:c,children:[t.jsx(U,{label:a("global.grid_layout.label.compact_grid"),value:T.Compact,checked:c==null||c===T.Compact}),t.jsx(U,{label:a("global.grid_layout.label.comfortable_grid"),value:T.Comfortable,checked:c===T.Comfortable}),t.jsx(U,{label:a("global.grid_layout.label.list"),value:T.List,checked:c===T.List})]}),t.jsx(A,{sx:{mt:2},children:a("library.option.display.badge.title")}),t.jsx(v,{label:a("library.option.display.badge.label.unread_badges"),checked:f,onChange:()=>D("showUnreadBadge",!f)}),t.jsx(v,{label:a("library.option.display.badge.label.download_badges"),checked:M,onChange:()=>D("showDownloadBadge",!M)}),t.jsx(A,{sx:{mt:2},children:a("library.option.display.tab.title")}),t.jsx(v,{label:a("library.option.display.tab.label.show_number_of_items"),checked:g,onChange:()=>y("showTabSize",!g)}),t.jsx(A,{sx:{mt:2},children:a("global.label.other")}),t.jsx(v,{label:a("library.option.display.other.label.show_continue_reading_button"),checked:x,onChange:()=>D("showContinueReadingButton",!x)})]})}return null}})},la=({category:e})=>{const{t:s}=B(),[n,a]=p.useState(!1),{options:l}=W(),o=l.hasDownloadedChapters!=null||l.hasUnreadChapters!=null||l.hasReadChapters!=null||l.hasBookmarkedChapters!=null||l.hasDuplicateChapters!=null||Object.values(l.hasStatus).some(r=>r!=null)||Object.values(l.hasTrackerBinding).some(r=>r!=null);return t.jsxs(t.Fragment,{children:[t.jsx(pe,{title:s("settings.title"),children:t.jsx(Me,{onClick:()=>a(!n),color:o?"warning":"inherit",children:t.jsx(ze,{})})}),t.jsx(ra,{category:e,open:n,onClose:()=>a(!1)})]})},oa=()=>{},de=({showFilteredOutMessage:e,message:s,messageExtra:n,...a})=>{const{t:l}=B(),{options:o}=W();return p.useLayoutEffect(()=>(document.body.style.overflowY=o.gridLayout===T.List?"auto":"scroll",()=>{document.body.style.overflowY="auto"}),[]),t.jsx(Xe,{gridWrapperProps:{sx:{p:1}},...a,hasNextPage:!1,loadMore:oa,message:e?l("library.error.label.no_matches"):s,messageExtra:e?void 0:n,gridLayout:o.gridLayout})},na=({isActive:e,areAllItemsSelected:s,areNoItemsSelected:n,onSelectAll:a,onModeChange:l})=>{const{t:o}=B();return t.jsxs(t.Fragment,{children:[e&&t.jsx(Ke,{areAllItemsSelected:s,areNoItemsSelected:n,onChange:a}),t.jsx(pe,{title:o(e?"global.button.cancel":"global.button.select_all"),children:t.jsx(Fe,{checkedIcon:t.jsx($e,{}),sx:{padding:"8px",color:"inherit","&.Mui-checked":{color:"inherit"}},checked:e,onChange:(r,i)=>l(i)})})]})},Y=(e,s,n)=>{switch(e){case!0:return s();case!1:return n();default:return!0}},O=(e,s)=>Y(e,()=>!!s&&s>=1,()=>s===0),me=(e,s)=>Y(e,()=>!!s,()=>!s),_=(e,s)=>{const n=e==null?void 0:e.filter(r=>r!=null),a=s==null?void 0:s.filter(r=>r!=null);if(!(n!=null&&n.length))return!0;const l=n.map(P),o=a.map(P).join(", ");return l.every(r=>o.includes(r))},ia=(e,{title:s,genre:n,description:a,artist:l,author:o,source:r,sourceId:i})=>_([e],[s])||_(e==null?void 0:e.split(","),n.map(g=>P(g)))||_([e],[a])||_([e],[l])||_([e],[o])||_([e],[r==null?void 0:r.displayName])||_([e],[i]),ca=(e,s)=>Object.entries(e).map(([n,a])=>{const l=s.trackRecords.nodes.some(o=>o.trackerId===Number(n));return Y(a,()=>l,()=>!l)}).every(Boolean),da=(e,s)=>Object.entries(e).map(([n,a])=>me(a,n===s.status)).every(Boolean),ha=(e,{hasDownloadedChapters:s,hasUnreadChapters:n,hasReadChapters:a,hasBookmarkedChapters:l,hasDuplicateChapters:o,hasTrackerBinding:r,hasStatus:i})=>O(s,e.downloadCount)&&O(n,e.unreadCount)&&O(a,e.chapters.totalCount-e.unreadCount)&&O(l,e.bookmarkCount)&&me(o,e.hasDuplicateChapters)&&ca(r,e)&&da(i,e),ua=(e,s,n)=>{const a=n.ignoreFilters&&(s==null?void 0:s.length);return e.filter(l=>{const o=ia(s,l),r=a||ha(l,n);return o&&r})},I=(e=0,s=0)=>Number(e)-Number(s),ga=(e,s)=>e.localeCompare(s),pa=(e,s,n)=>{const a=[...e];switch(s){case"alphabetically":a.sort((l,o)=>ga(l.title,o.title));break;case"dateAdded":a.sort((l,o)=>I(l.inLibraryAt,o.inLibraryAt));break;case"unreadChapters":a.sort((l,o)=>I(l.unreadCount,o.unreadCount));break;case"lastRead":a.sort((l,o)=>{var r,i;return I((r=l.lastReadChapter)==null?void 0:r.lastReadAt,(i=o.lastReadChapter)==null?void 0:i.lastReadAt)});break;case"latestUploadedChapter":a.sort((l,o)=>{var r,i;return I((r=l.latestUploadedChapter)==null?void 0:r.uploadDate,(i=o.latestUploadedChapter)==null?void 0:i.uploadDate)});break;case"latestFetchedChapter":a.sort((l,o)=>{var r,i;return I((r=l.latestFetchedChapter)==null?void 0:r.fetchedAt,(i=o.latestFetchedChapter)==null?void 0:i.fetchedAt)});break;case"totalChapters":a.sort((l,o)=>I(l.chapters.totalCount,o.chapters.totalCount));break}return n&&a.reverse(),a},ba={id:-1},ma=(e,s)=>{const[n]=be("query",Ge),a=ge(s!=null?s:ba),{hasUnreadChapters:l,hasReadChapters:o,hasDownloadedChapters:r,hasBookmarkedChapters:i,hasTrackerBinding:g,hasDuplicateChapters:x,hasStatus:M}=a,{settings:f}=z(),y=p.useMemo(()=>ua(e,n,{...a,ignoreFilters:f.ignoreFilters}),[e,n,l,o,r,i,g,x,M,f.ignoreFilters]),h=p.useMemo(()=>pa(y,a.sortBy,a.sortDesc),[y,a.sortBy,a.sortDesc]),C=Object.values(a.hasTrackerBinding).some(c=>c!=null),u=(l!=null||o!=null||r!=null||i!=null||!!n||C)&&y.length===0&&e.length>0;return{visibleMangas:h,showFilteredOutMessage:u}},he=Le("span")({display:"flex",alignItems:"center"}),ue=({sx:e,...s})=>t.jsx(aa,{...s,size:"small",sx:{...e,marginLeft:"5px"}});function Ua(){var ae,te,se,re,le,oe;const{t:e}=B(),{settings:{showTabSize:s}}=z(),{data:n,error:a,loading:l,refetch:o}=E.useGetCategories(Ae,{notifyOnNetworkStatusChange:!0}),r=n==null?void 0:n.categories.nodes.filter(d=>d.id!==0||d.id===0&&d.mangas.totalCount),i=r!=null?r:[],g=E.useGetMangas(Ie,{}),x=(te=(ae=g.data)==null?void 0:ae.mangas.totalCount)!=null?te:0,[M,f]=be("tab",Pe),{setOptions:y}=W(),h=(se=i.find(d=>d.order===M))!=null?se:i[0];p.useLayoutEffect(()=>{y(we(h!=null?h:{id:-1}))},[h]);const{data:C,error:u,loading:c,refetch:b}=E.useGetCategoryMangas(h==null?void 0:h.id,{skip:!h,notifyOnNetworkStatusChange:!0}),Ce=(re=C==null?void 0:C.mangas.nodes)!=null?re:[],{visibleMangas:m,showFilteredOutMessage:K}=ma(Ce,h),H=p.useCallback(()=>b().catch(G()),[b,h]),xe=p.useMemo(()=>m.map(d=>d.id),[m]),[S,R]=p.useState(!1),{areNoItemsForKeySelected:V,areAllItemsForKeySelected:Q,selectedItemIds:F,handleSelectAll:N,handleSelection:X,clearSelection:fe}=qe(m.length,{itemIds:xe,currentKey:h==null?void 0:h.id.toString()}),Z=p.useCallback((d,j,L)=>{R(!!(F.length+(j?1:-1))),X(d,j,L)},[R,X]),$=p.useMemo(()=>F.map(d=>Be.getFromCache(d,Re,"MANGA_CHAPTER_STAT_FIELDS")).filter(d=>!!d),[F.length,m]),J=p.useMemo(()=>S?t.jsx(He,{selectedItemsCount:F.length,title:"manga.title",children:(d,j)=>t.jsx(Ze,{selectedMangas:$,onClose:()=>{d(),R(!1),fe()},setHideMenu:j})}):null,[S,$]),{setTitle:q,setAction:ee}=p.useContext(ve);p.useLayoutEffect(()=>{const d=e("library.title");return q(t.jsxs(he,{children:[d,s&&t.jsx(ue,{sx:{color:"inherit"},label:x})]}),d),ee(t.jsxs(t.Fragment,{children:[!S&&h&&t.jsxs(t.Fragment,{children:[t.jsx(Ue,{}),t.jsx(la,{category:h}),t.jsx(Je,{categoryId:h==null?void 0:h.id})]}),t.jsx(na,{isActive:S,areAllItemsSelected:Q,areNoItemsSelected:V,onSelectAll:L=>N(L,[...new Set(m.map(w=>w.id))]),onModeChange:L=>{R(L),L?N(!0,[...new Set(m.map(w=>w.id))]):i.forEach(w=>N(!1,[],w.id.toString()))}})]})),()=>{q(""),ee(null)}},[e,x,l,S,V,Q,m.length,h,s]);const ye=d=>{f(d)};return a!=null||g.error?t.jsx(ce,{message:e("global.error.label.failed_to_load_data"),messageExtra:(oe=a==null?void 0:a.message)!=null?oe:(le=g.error)==null?void 0:le.message,retry:()=>{a&&o().catch(G()),g.error&&g.refetch().catch(G())}}):l||g.loading?t.jsx(Oe,{}):i.length===0?t.jsx(ce,{message:e("library.error.label.empty")}):i.length===1?t.jsxs(t.Fragment,{children:[t.jsx(de,{mangas:m,message:e(u?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:u==null?void 0:u.message,isLoading:c,selectedMangaIds:F,isSelectModeActive:S,handleSelection:Z,showFilteredOutMessage:!u&&K,retry:u&&H}),J]}):t.jsxs(ea,{children:[t.jsx(Ee,{value:h.order,onChange:(d,j)=>ye(j),children:i.map(d=>t.jsx(Ne,{sx:{flexGrow:1,maxWidth:"unset"},label:t.jsxs(he,{children:[d.name,s?t.jsx(ue,{label:d.mangas.totalCount}):null]}),value:d.order},d.id))}),i.map(d=>t.jsx(De,{index:d.order,currentIndex:h.order,children:d===h&&t.jsx(de,{mangas:m,message:e(u?"manga.error.label.request_failure":"library.error.label.empty"),messageExtra:u==null?void 0:u.message,isLoading:c,selectedMangaIds:F,isSelectModeActive:S,handleSelection:Z,showFilteredOutMessage:!u&&K,retry:u&&H})},d.order)),J]})}export{Ua as Library};
