import{u as U,a7 as B,c as r,N,a as m,j as e,E as H,T as C,g as _,L as T,B as D,f as O,I as q,q as $,t as v}from"./index-Zl59rTnr.js";import{D as V}from"./DownloadStateIndicator-CWfwJuYC.js";import{U as Y}from"./UpdateChecker-DMfFaOn7.js";import{S as z,a as Q,b as W}from"./StyledGroupItemWrapper-DXpnFUAg.js";import{M as J}from"./Mangas-D6kqk8_N.js";import{S as K}from"./SpinnerImage-DiQGN4Ou.js";import{C as X,a as Z}from"./index-DQrhUqKj.js";import{C as ee}from"./CardContent-RtU3w6b_.js";import{A as te}from"./Avatar-922Wk_ln.js";import"./Progress-BgVdFcJg.js";import"./Chapters-BDtuZBKt.js";import"./metadataServerSettings-Bu9SBxLq.js";import"./metadata-3dsaWhfv.js";function ae(t){const n=new Date(0);return n.setUTCSeconds(t),n}function I(t,n){return t.getDate()===n.getDate()&&t.getMonth()===n.getMonth()&&t.getFullYear()===n.getFullYear()}function ne(t){const n=new Date;if(I(n,t))return v("global.date.label.today");const i=new Date;return i.setDate(n.getDate()-1),I(i,t)?v("global.date.label.yesterday"):t.toLocaleDateString()}const oe=t=>{if(!t.length)return[];const n=new Map;return t.forEach(i=>{var s;const c=ne(ae(Number(i.fetchedAt)));n.set(c,((s=n.get(c))!=null?s:0)+1)}),[...n.entries()]},ye=()=>{var w,S;const{t}=U(),n=B(),{setTitle:i,setAction:c}=r.useContext(N),{data:s,loading:j,fetchMore:L}=m.useGetRecentlyUpdatedChapters(void 0,{fetchPolicy:"cache-and-network",notifyOnNetworkStatusChange:!0}),b=!!(s!=null&&s.chapters.pageInfo.hasNextPage),M=s==null?void 0:s.chapters.pageInfo.endCursor,l=(w=s==null?void 0:s.chapters.nodes)!=null?w:[],g=r.useMemo(()=>oe(l),[l]),k=r.useMemo(()=>g.map(a=>a[1]),[g]),{data:h}=m.useGetDownloadStatus(),E=(S=h==null?void 0:h.downloadStatus.queue)!=null?S:[],f=r.useRef(null),[R,A]=r.useState(0);r.useLayoutEffect(()=>{var a,o;A((o=(a=f.current)==null?void 0:a.clientHeight)!=null?o:0)},[f.current]);const{data:x}=m.useGetLastGlobalUpdateTimestamp({fetchPolicy:"cache-only"}),y=x==null?void 0:x.lastUpdateTimestamp.timestamp;r.useEffect(()=>(i(t("updates.title")),c(e.jsx(Y,{})),()=>{i(""),c(null)}),[t,y]);const F=a=>{const{sourceOrder:o,manga:{id:u}}=a;return E.find(d=>o===d.chapter.sourceOrder&&u===d.chapter.manga.id)},G=a=>{m.addChapterToDownloadQueue(a.id)},P=r.useCallback(()=>{b&&L({variables:{offset:l.length}})},[b,M]);return!j&&l.length===0?e.jsx(H,{message:t("updates.error.label.no_updates_available")}):e.jsxs(e.Fragment,{children:[e.jsx(C,{ref:f,sx:{marginLeft:"10px",paddingTop:a=>({[a.breakpoints.up("sm")]:{paddingTop:"6px"}})},children:t("library.settings.global_update.label.last_update",{date:y?new Date(+y).toLocaleString():"-"})}),e.jsx(z,{heightToSubtract:R,style:{height:"undefined"},components:{Footer:()=>j?e.jsx(_,{usePadding:!0}):null},overscan:window.innerHeight*.5,endReached:P,groupCounts:k,groupContent:a=>e.jsx(Q,{variant:"h5",isFirstItem:a===0,children:g[a][0]}),itemContent:a=>{const o=l[a],{manga:u}=o,d=F(o);return e.jsx(W,{isLastItem:a===l.length-1,children:e.jsx(X,{children:e.jsx(Z,{component:T,to:"/manga/".concat(o.manga.id,"/chapter/").concat(o.sourceOrder),state:n.state,sx:{color:p=>p.palette.text[o.isRead?"disabled":"primary"]},children:e.jsxs(ee,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:2},children:[e.jsxs(D,{sx:{display:"flex"},children:[e.jsx(T,{to:"/manga/".concat(o.manga.id),style:{textDecoration:"none"},children:e.jsx(te,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",marginRight:2,background:"transparent"},children:e.jsx(K,{imgStyle:{objectFit:"cover",width:"100%",height:"100%",imageRendering:"pixelated"},spinnerStyle:{small:!0},alt:u.title,src:J.getThumbnailUrl(u)})})}),e.jsxs(D,{sx:{display:"flex",flexDirection:"column"},children:[e.jsx(C,{variant:"h5",component:"h2",children:u.title}),e.jsx(C,{variant:"caption",display:"block",gutterBottom:!0,children:o.name})]})]}),d&&e.jsx(V,{download:d}),d==null&&!o.isDownloaded&&e.jsx(O,{title:t("chapter.action.download.add.label.action"),children:e.jsx(q,{onClick:p=>{p.stopPropagation(),p.preventDefault(),G(o)},size:"large",children:e.jsx($,{})})})]})})})},a)}})]})};export{ye as Updates};
