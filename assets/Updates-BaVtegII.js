import{h as n,aa as U,u as _,aQ as B,j as e,C as F,a as H,A as w,L as T,b as N,B as k,S as K,a7 as V,bI as S,J as Q,K as q,k as v,I,R as z,ah as J,r as p,o as E,m as f,f as O,E as L,n as W,T as R,bJ as X,l as Y,bK as Z,bL as $}from"./index-BKHCEc_C.js";import{U as ee}from"./UpdateChecker-DLGFVXMU.js";import{V as te,S as ae,a as se,b as oe}from"./Virtuoso.util-DG2PDgMR.js";import{A as re}from"./Avatar-CTaLFrXq.js";import"./Progress-nE-cTEGs.js";const ne=n.memo(({chapter:t})=>{const{manga:r}=t,i=U.useDownloadStatusFromCache(t.id),{t:a}=_(),l=B(),u=async()=>{try{await p.addChapterToDownloadQueue(t.id).response}catch(o){E(a("download.queue.error.label.failed_to_remove"),"error",f(o))}},m=()=>{p.addChapterToDownloadQueue(t.id).response.catch(o=>E(a("global.error.label.failed_to_save_changes"),"error",f(o)))};return e.jsx(F,{children:e.jsx(H,{component:T,to:w.reader.path(t.manga.id,t.sourceOrder),state:l.state,sx:{color:o=>o.palette.text[t.isRead?"disabled":"primary"]},children:e.jsxs(N,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:1.5},children:[e.jsxs(k,{sx:{display:"flex",flexGrow:1},children:[e.jsx(T,{to:w.manga.path(t.manga.id),style:{textDecoration:"none"},children:e.jsx(re,{variant:"rounded",sx:{width:56,height:56,flex:"0 0 auto",marginRight:1,background:"transparent"},children:e.jsx(K,{imgStyle:{objectFit:"cover",width:"100%",height:"100%",imageRendering:"pixelated"},spinnerStyle:{small:!0},alt:r.title,src:V.getThumbnailUrl(r)})})}),e.jsxs(k,{sx:{display:"flex",flexDirection:"column",justifyContent:"center",flexGrow:1,flexShrink:1,wordBreak:"break-word"},children:[e.jsx(S,{variant:"h6",component:"h3",children:r.title}),e.jsx(S,{variant:"caption",display:"block",lines:1,children:t.name})]})]}),e.jsx(Q,{chapterId:t.id}),(i==null?void 0:i.state)===q.Error&&e.jsx(v,{title:a("global.button.retry"),children:e.jsx(I,{onClick:o=>{o.preventDefault(),o.stopPropagation(),u()},size:"large",children:e.jsx(z,{})})}),i==null&&!t.isDownloaded&&e.jsx(v,{title:a("chapter.action.download.add.label.action"),children:e.jsx(I,{onClick:o=>{o.stopPropagation(),o.preventDefault(),m()},size:"large",children:e.jsx(J,{})})})]})})})}),ie=t=>{if(!t.length)return[];const r=new Map;return t.forEach(i=>{var l;const a=Z($(Number(i.fetchedAt)));r.set(a,((l=r.get(a))!=null?l:0)+1)}),[...r.entries()]},me=()=>{var C;const{t}=_(),{setTitle:r,setAction:i}=O(),{data:a,loading:l,error:u,fetchMore:m,refetch:o}=p.useGetRecentlyUpdatedChapters(void 0,{fetchPolicy:"cache-and-network",notifyOnNetworkStatusChange:!0}),b=!!(a!=null&&a.chapters.pageInfo.hasNextPage),M=a==null?void 0:a.chapters.pageInfo.endCursor,d=(C=a==null?void 0:a.chapters.nodes)!=null?C:[],c=n.useMemo(()=>ie(d),[d]),y=n.useMemo(()=>c.map(s=>s[1]),[c]),A=te.useCreateGroupedComputeItemKey(y,n.useCallback(s=>c[s][0],[c]),n.useCallback(s=>d[s].id,[d])),h=n.useRef(null),[G,P]=n.useState(0);n.useLayoutEffect(()=>{var s,j;P((j=(s=h.current)==null?void 0:s.clientHeight)!=null?j:0)},[h.current]);const{data:g}=p.useGetLastGlobalUpdateTimestamp({fetchPolicy:"cache-only"}),x=g==null?void 0:g.lastUpdateTimestamp.timestamp;n.useLayoutEffect(()=>(r(t("updates.title")),i(e.jsx(ee,{})),()=>{r(""),i(null)}),[t,x]);const D=n.useCallback(()=>{b&&m({variables:{offset:d.length}})},[b,M]);return u?e.jsx(L,{message:t("global.error.label.failed_to_load_data"),messageExtra:f(u),retry:()=>o().catch(W())}):!l&&d.length===0?e.jsx(L,{message:t("updates.error.label.no_updates_available")}):e.jsxs(e.Fragment,{children:[e.jsx(R,{ref:h,sx:{marginLeft:"10px",paddingTop:s=>({[s.breakpoints.up("sm")]:{paddingTop:"6px"}})},children:t("library.settings.global_update.label.last_update",{date:x?X.format(+x):"-"})}),e.jsx(ae,{heightToSubtract:G,style:{height:"undefined"},components:{Footer:()=>l?e.jsx(Y,{usePadding:!0}):null},overscan:window.innerHeight*.5,endReached:D,groupCounts:y,groupContent:s=>e.jsx(oe,{isFirstItem:s===0,children:e.jsx(R,{variant:"h5",component:"h2",children:c[s][0]})}),computeItemKey:A,itemContent:s=>e.jsx(se,{children:e.jsx(ne,{chapter:d[s]})})})]})};export{me as Updates};
