import{c as Q,j as i,u as A,a0 as P,L as rt,a1 as ne,f as _t,M as se,a2 as ie,b as C,N as ae,i as Pt,k as oe,n as le,q as ce,S as M,B as tt,a3 as Nt,a4 as ot,a5 as ue,C as O,I as E,a6 as zt,a7 as Wt,a8 as he,x as de,a9 as Mt,H as Bt,r as U,aa as ge,Z as V,e as Gt,g as nt,$ as W,T as st,w as qt,ab as Ut,m as it,ac as fe,ad as me,d as pe,P as be,ae as xe,A as z,af as $t,ag as ve,ah as Ce,ai as pt,aj as _e,ak as we,al as je,am as Me,a as ke,an as bt,R as Se,ao as ye,ap as Le,aq as Ie,ar as kt,as as Te,at as ct,au as ut,p as ht,av as De,aw as Ee,ax as Ae,ay as Fe,az as Re}from"./index-zNRCc0xl.js";import{P as Oe}from"./PlayArrow-CKBjqbX5.js";import{S as Ve,D as He}from"./StyledFab-3dMNJ_GR.js";import{E as et}from"./EmptyViewAbsoluteCentered-DJ7_Wkqy.js";import{F as Pe}from"./FilterList-B691Wo_6.js";import{D as Ne}from"./Download-BvKRsJtp.js";import{D as ze}from"./DoneAll-DObwsJXo.js";import{S as We,R as St}from"./SortRadioInput-BCiyL-qA.js";import{T as dt}from"./ThreeStateCheckboxInput-DNjUZniP.js";import{O as Be,S as Ge,a as qe}from"./SelectionFAB-DSyi74Qg.js";import{C as Qt}from"./CheckboxInput-Ba8hOwz-.js";import{u as Yt,a as Ue,F as $e,b as Qe}from"./useManageMangaLibraryState-s517Xhay.js";import{F as Ye}from"./FormGroup-N8qz-jHH.js";import{R as Je}from"./ListPreference-5aLj12fe.js";import{C as Ke,T as Xe,p as Ze,s as tr,S as yt,L as Lt}from"./ChaptersDownloadActionMenuItems-BTXei6dP.js";import{C as er,a as rr,b as nr,L as sr}from"./CustomButtonIcon-05WKt0mS.js";import{V as ir}from"./VirtuosoPersisted-DkZVMOS3.js";import{F as ar}from"./Favorite-BfGCPyh_.js";import{S as or}from"./Sync-_VkCcDZa.js";import{T as gt}from"./Trackers-COtG7wmP.js";import{M as lr}from"./Metadata-DjWjlZ6J.js";import{S as cr}from"./Sources-Djcnz5SD.js";import{E as ur,a as hr}from"./ExpandMore-BKsL_9KB.js";import{L as Jt}from"./Link-CO_IkJ-0.js";import{C as dr}from"./Chip-CrTOErjI.js";import{u as gr}from"./useAppTitleAndAction-B3Bw143F.js";import"./Checkbox-VfDE7o2W.js";import"./formControlState-Dq1zat_P.js";import"./useFormControl-DIx_WD_z.js";import"./SwitchBase-D2UiMFY_.js";import"./Tabs-CRNXhwne.js";import"./Card-CFCtZ_A-.js";import"./ListCardContent-BkkqqaDH.js";import"./Avatar-BaHwAQTM.js";import"./TextField-BxeZv6lv.js";import"./InputAdornment-Bo8P-nKT.js";import"./CheckCircle-LoxbX8Mr.js";import"./MUI.util-CYBuX_Wz.js";import"./CardActionArea-DJvxKEv6.js";import"./NumberSetting-DXUrsUUA.js";import"./Slider-epIRD2fq.js";import"./useMobilePicker-B2sbC3t_.js";import"./SelectSetting-CeyMXxLt.js";import"./Select-C5dRg0hj.js";import"./ChapterCardMetadata-H88JnkdW.js";import"./Delete-CYlPcPJY.js";import"./index-BchxF0G_.js";import"./Virtuoso.util-DWCLK1yX.js";import"./use-merged-ref-DbEjnfoO.js";import"./useAppTitle-J75y9BxW.js";import"./useAppAction-r7n17ptw.js";const fr=Q(i.jsx("path",{d:"M1 21h22L12 2zm12-3h-2v-2h2zm0-4h-2v-4h2z"}));function mr({chapter:e}){const{t}=A(),{sourceOrder:r}=e;return i.jsxs(Ve,{component:rt,variant:"extended",color:"primary",to:P.getReaderUrl(e),state:P.getReaderOpenChapterLocationState(e),children:[i.jsx(Oe,{}),t(r===1?"global.button.start":"global.button.resume")]})}const pr={...ie},br=e=>({...e,excludedScanlators:JSON.stringify(e.excludedScanlators)}),xr=(e,t=pr,r)=>se("manga",e,t,void 0,r),vr=(e,t,r)=>xr({...e,meta:ae(e.meta)},t,r),Cr=(e,t)=>{const r=vr(e,t,C.useEffect);return C.useMemo(()=>r,[e,t])},_r=async(e,t,r)=>ne(e,[[t,br({[t]:r})[t]]]),wr=(e,t=_t())=>(r,n)=>_r(e,r,n).catch(t);function jr(e,{isRead:t}){switch(e){case!0:return!t;case!1:return t;default:return!0}}function Mr(e,{isDownloaded:t}){switch(e){case!0:return t;case!1:return!t;default:return!0}}function kr(e,{isBookmarked:t}){switch(e){case!0:return t;case!1:return!t;default:return!0}}function Sr(e,{scanlator:t}){return!t||!e.includes(t)}const yr=(e,{sortBy:t,reverse:r})=>{const n=[...e];switch(t){case"source":n.sort((s,a)=>s.sourceOrder-a.sourceOrder);break;case"fetchedAt":n.sort((s,a)=>{var o,l;return Number((o=s.fetchedAt)!=null?o:0)-Number((l=a.fetchedAt)!=null?l:0)});break;case"chapterNumber":n.sort((s,a)=>s.chapterNumber-a.chapterNumber);break;case"uploadedAt":n.sort((s,a)=>{var o,l;return Number((o=s.uploadDate)!=null?o:0)-Number((l=a.uploadDate)!=null?l:0)});break}return r&&n.reverse(),n};function Lr(e,t){const r=e.filter(n=>jr(t.unread,n)&&Mr(t.downloaded,n)&&kr(t.bookmarked,n)&&Sr(t.excludedScanlators,n));return yr(r,t)}const Ir=e=>{const{unread:t,downloaded:r,bookmarked:n,excludedScanlators:s}=e;return t!=null||r!=null||n!=null||!!s.length},Tr=e=>{const{unread:t,downloaded:r,bookmarked:n,reverse:s,sortBy:a,showChapterNumber:o,excludedScanlators:l}=Cr(e);return C.useMemo(()=>({unread:t,downloaded:r,bookmarked:n,reverse:s,sortBy:a,showChapterNumber:o,excludedScanlators:l}),[t,r,n,s,a,o,l])},Dr=(e,t=_t())=>wr(e,t),It=Q(i.jsx("path",{d:"M16.67 13.13C18.04 14.06 19 15.32 19 17v3h4v-3c0-2.18-3.57-3.47-6.33-3.87M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4c-.47 0-.91.1-1.33.24C14.5 5.27 15 6.58 15 8s-.5 2.73-1.33 3.76c.42.14.86.24 1.33.24m-6 0c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4m0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2m0 7c-2.67 0-8 1.34-8 4v3h16v-3c0-2.66-5.33-4-8-4m6 5H3v-.99C3.2 16.29 6.3 15 9 15s5.8 1.29 6 2z"}));function Er({title:e,emptyMessage:t,items:r,getId:n,getLabel:s,isChecked:a,open:o,onClose:l}){const{t:c}=A(),h=C.useMemo(()=>r.map(n),[r]),u=C.useMemo(()=>r.filter(a).map(n),[r]),{selectedItemIds:g,handleSelection:d,handleSelectAll:m,reset:f}=Yt(r.length,{currentKey:"default",itemIds:h,initialState:{default:u}}),p=()=>{l(),f()},b=C.useCallback(()=>{const x=g.length!==u.length||g.some(L=>!u.includes(L)),_=r.filter(L=>g.includes(n(L)));l(x?_:void 0)},[g]);return i.jsxs(Pt,{sx:{".MuiDialog-paper":{maxHeight:435,width:"80%"}},maxWidth:"xs",open:o,onClose:p,children:[i.jsx(oe,{children:e}),i.jsx(le,{dividers:!0,children:i.jsxs(Ye,{children:[r.length===0&&i.jsx("span",{children:t}),r.map(x=>i.jsx(Qt,{checked:g.includes(n(x)),onChange:(_,L)=>d(n(x),L),label:s(x)},n(x)))]})}),i.jsx(ce,{children:i.jsx(M,{sx:{width:"100%"},children:i.jsxs(M,{direction:"row",sx:{justifyContent:"space-between",alignItems:"end",width:"100%"},children:[i.jsx(tt,{onClick:()=>m(!g.length,r.map(n)),children:c(g.length?"global.button.reset":"global.button.select_all")}),i.jsxs(M,{direction:"row",children:[i.jsx(tt,{autoFocus:!0,onClick:p,color:"primary",children:c("global.button.cancel")}),!!r.length&&i.jsx(tt,{onClick:b,color:"primary",children:c("global.button.ok")})]})]})})})]})}const Ar=({updateOption:e,scanlators:t,excludedScanlators:r})=>{const{t:n}=A(),s=Nt({variant:"dialog",popupId:"chapter-list-options-scanlator-filter-dialog"});return t.length?i.jsxs(i.Fragment,{children:[i.jsx(Qt,{...ot(s),label:n("global.label.scanlator"),icon:i.jsx(It,{}),checkedIcon:i.jsx(It,{color:"warning"}),checked:!!r.length}),i.jsx(Er,{title:n("chapter.option.exclude_scanlators"),open:s.isOpen,onClose:a=>{a&&e("excludedScanlators",a),s.close()},items:t,getId:a=>a,getLabel:a=>a,isChecked:a=>r.includes(a)})]}):null},Fr={filter:"global.label.filter",sort:"global.label.sort",display:"global.label.display"},Rr=({open:e,onClose:t,options:r,updateOption:n,scanlators:s,excludedScanlators:a})=>{const{t:o}=A();return i.jsx(Be,{open:e,onClose:t,minHeight:150,tabs:["filter","sort","display"],tabTitle:l=>o(Fr[l]),tabContent:l=>l==="filter"?i.jsxs(i.Fragment,{children:[i.jsx(dt,{label:o("global.filter.label.unread"),checked:r.unread,onChange:c=>n("unread",c)}),i.jsx(dt,{label:o("global.filter.label.downloaded"),checked:r.downloaded,onChange:c=>n("downloaded",c)}),i.jsx(dt,{label:o("global.filter.label.bookmarked"),checked:r.bookmarked,onChange:c=>n("bookmarked",c)}),i.jsx(Ar,{scanlators:s,excludedScanlators:a,updateOption:n})]}):l==="sort"?Object.entries(ue).map(([c,h])=>i.jsx(We,{label:o(h),checked:r.sortBy===c,sortDescending:r.reverse,onClick:()=>c!==r.sortBy?n("sortBy",c):n("reverse",!r.reverse)},c)):l==="display"?i.jsxs(Je,{onChange:()=>n("showChapterNumber",!r.showChapterNumber),value:r.showChapterNumber,children:[i.jsx(St,{label:o("chapter.option.display.label.source_title"),value:!1}),i.jsx(St,{label:o("chapter.option.display.label.chapter_number"),value:!0})]}):null})},Or=({mangaId:e,areAllChaptersRead:t,areAllChaptersDownloaded:r,options:n,updateOption:s,unreadChapters:a,scanlators:o,excludeScanlators:l})=>{const{t:c}=A(),[h,u]=C.useState(!1),g=Ir(n);return i.jsxs(i.Fragment,{children:[i.jsx(O,{title:c("chapter.action.mark_as_read.add.label.action.current"),disabled:t,children:i.jsx(E,{disabled:t,onClick:()=>P.markAsRead(a,!0,e),color:"inherit",children:i.jsx(ze,{})})}),i.jsx(zt,{variant:"popover",popupId:"chapterlist-download-button",children:d=>i.jsxs(i.Fragment,{children:[i.jsx(O,{title:c("chapter.action.download.add.label.action"),disabled:t,children:i.jsx(E,{disabled:r,...ot(d),color:"inherit",children:i.jsx(Ne,{})})}),d.isOpen&&i.jsx(Wt,{...he(d),children:i.jsx(Ke,{mangaIds:[e],closeMenu:d.close})})]})}),i.jsx(O,{title:c("settings.title"),children:i.jsx(E,{onClick:()=>u(!0),color:"inherit",children:i.jsx(Pe,{color:g?"warning":void 0})})}),i.jsx(Rr,{open:h,onClose:()=>u(!1),options:n,updateOption:s,scanlators:o,excludedScanlators:l})]})},Vr=W(M,{shouldForwardProp:Ut(["scrollbarWidth"])})(({theme:e,scrollbarWidth:t})=>({padding:e.spacing(1),paddingRight:"calc(".concat(t,"px + ").concat(e.spacing(1),")"),paddingBottom:0,[e.breakpoints.down("md")]:{paddingRight:e.spacing(1)}})),Hr=W(ir,{shouldForwardProp:Ut(["topOffset"])})(({theme:e,topOffset:t})=>({listStyle:"none",padding:0,[e.breakpoints.up("md")]:{height:"calc(100vh - ".concat(t,"px)"),margin:0}})),Pr=({selectedChapters:e,firstUnreadChapter:t,onFABMenuClose:r})=>e.length?i.jsx(qe,{selectedItemsCount:e.length,title:"chapter.title_one",children:n=>i.jsx(rr,{selectedChapters:e,onClose:()=>{r==null||r(),n()}})}):t?i.jsx(mr,{chapter:t}):null,Nr=({manga:e,isRefreshing:t})=>{const{t:r}=A(),{appBarHeight:n}=de(),s=Mt.useIsBelowWidth("md"),[a,o]=C.useState(50),[l,c]=C.useState(null);Bt(l,C.useCallback(()=>{var w;return o((w=l==null?void 0:l.offsetHeight)!=null?w:0)},[l]));const h=Mt.useGetScrollbarSize("width"),u=Tr(e),g=Dr(e,w=>it(r("global.error.label.failed_to_save_changes"),"error",nt(w))),{data:d,loading:m,error:f,refetch:p}=U.useGetMangaChapters(ge,e.id,{notifyOnNetworkStatusChange:!0}),b=C.useMemo(()=>{var w;return(w=d==null?void 0:d.chapters.nodes)!=null?w:[]},[d==null?void 0:d.chapters.nodes]),x=C.useMemo(()=>Lr(b,u),[b,u]),_=C.useMemo(()=>P.getIds(x),[x]),L=V.isFullyRead(e),y=V.isFullyDownloaded(e),T=C.useMemo(()=>P.getMissingCount(x),[x]),v=b.length===0,j=!v&&x.length===0,{areNoItemsSelected:k,areAllItemsSelected:I,selectedItemIds:S,handleSelectAll:Y,handleSelection:B,clearSelection:J}=Yt(_.length,{itemIds:_,currentKey:"default"}),K=C.useCallback((w,lt,re)=>B(w,lt,{selectRange:re}),[B]);return m||v&&t?i.jsx(M,{sx:{justifyContent:"center",alignItems:"center",position:"relative",flexGrow:1},children:i.jsx(Gt,{})}):f?i.jsx(M,{sx:{justifyContent:"center",position:"relative",flexGrow:1},children:i.jsx(et,{message:r("global.error.label.failed_to_load_data"),messageExtra:nt(f),retry:()=>p().catch(_t())})}):i.jsxs(i.Fragment,{children:[i.jsxs(M,{direction:"column",sx:{position:"relative",flexBasis:"60%"},children:[i.jsxs(Vr,{ref:c,direction:"row",alignItems:"center",justifyContent:"space-between",scrollbarWidth:h,children:[i.jsxs(M,{children:[i.jsx(st,{variant:"h5",component:"h3",children:r("chapter.value",{count:x.length})}),!!T&&i.jsx(st,{variant:"body2",color:"warning",children:"".concat(r("chapter.missing",{count:T}))})]}),i.jsxs(M,{direction:"row",children:[k&&i.jsx(Or,{mangaId:e.id,areAllChaptersDownloaded:y,areAllChaptersRead:L,options:u,updateOption:g,unreadChapters:P.getNonRead(b),scanlators:P.getScanlators(b),excludeScanlators:u.excludedScanlators}),!!_.length&&i.jsx(Ge,{areAllItemsSelected:I,areNoItemsSelected:k,onChange:w=>Y(w,w?_:[])})]})]}),v&&i.jsx(et,{message:r("chapter.error.label.no_chapter_found")}),j&&i.jsx(et,{message:r("chapter.error.label.no_matches")}),i.jsx(Hr,{persistKey:"manga-".concat(e.id,"-chapter-list"),topOffset:n+a,style:{height:"undefined"},components:{Footer:()=>i.jsx(qt,{sx:{paddingBottom:He}})},totalCount:x.length,computeItemKey:w=>x[w].id,itemContent:w=>i.jsx(er,{index:w,isSortDesc:u.reverse,chapters:x,selected:k?null:S.includes(x[w].id),showChapterNumber:u.showChapterNumber,onSelect:K}),useWindowScroll:s,overscan:window.innerHeight*.5})]}),i.jsx(Pr,{selectedChapters:S.map(w=>b.find(lt=>lt.id===w)).filter(w=>w!=null),firstUnreadChapter:e.firstUnreadChapter,onFABMenuClose:J})]})},zr=e=>{const[t,r]=C.useState(!1),[n,s]=C.useState(null);return[C.useCallback(async()=>{r(!0),s(null),await Promise.all([U.getMangaFetch(e,{awaitRefetchQueries:!0}).response,U.getMangaChaptersFetch(e,{awaitRefetchQueries:!0}).response]).catch(o=>{o instanceof fe&&me(o.message)==="no chapters found"||s(o)}).finally(()=>r(!1))},[e]),{loading:t,error:n}]},Wr=Q(i.jsx("path",{d:"M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"})),Kt=C.forwardRef(({children:e,...t},r)=>i.jsx(tt,{ref:r,...t,children:i.jsx(M,{direction:"row",sx:{alignItems:"center",justifyContent:"center",gap:1,flexWrap:"wrap"},children:e})})),Br=Q(i.jsx("path",{d:"M9 16.17 4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"})),Gr=({manga:e})=>{var h,u;const{t}=A(),r=pe(),n=U.useGetTrackerList(be),s=(u=(h=n.data)==null?void 0:h.trackers.nodes)!=null?u:[],a=e.trackRecords.nodes,o=gt.getLoggedIn(s),l=gt.getLoggedIn(gt.getTrackers(a,s)),c=g=>{var d;if(n.error){it(t("tracking.error.label.could_not_load_track_info"),"error",(d=n.error)==null?void 0:d.toString());return}if(!o.length){r(z.tracker.path);return}g()};return i.jsx(zt,{variant:"dialog",popupId:"manga-track-modal",children:g=>i.jsxs(i.Fragment,{children:[i.jsxs(Kt,{...ot(g),size:"medium",disabled:n.loading||!!n.error,onClick:()=>c(g.open),variant:l.length?"contained":"outlined",children:[l.length?i.jsx(Br,{}):i.jsx(or,{}),l.length?t("manga.button.track.active",{count:l.length}):t("manga.button.track.start")]}),g.isOpen&&i.jsx(Pt,{...xe(g),maxWidth:"md",fullWidth:!0,scroll:"paper",children:i.jsx(Xe,{manga:e})})]})})},qr=Q(i.jsx("path",{d:"M21 11V3h-8l3.29 3.29-10 10L3 13v8h8l-3.29-3.29 10-10z"}));class Ur{constructor(t,r){this.pixels=t,this.opts=r;const{sigBits:n}=r,s=(y,T,v)=>(y<<2*n)+(T<<n)+v;this.getColorIndex=s;const a=8-n,o=1<<3*n,l=new Uint32Array(o);let c,h,u,g,d,m,f,p,b,x;c=u=d=0,h=g=m=Number.MAX_VALUE;const _=t.length/4;let L=0;for(;L<_;){const y=L*4;if(L++,f=t[y+0],p=t[y+1],b=t[y+2],x=t[y+3],x===0)continue;f=f>>a,p=p>>a,b=b>>a;const T=s(f,p,b);l[T]===void 0&&(l[T]=0),l[T]+=1,f>c&&(c=f),f<h&&(h=f),p>u&&(u=p),p<g&&(g=p),b>d&&(d=b),b<m&&(m=b)}this._colorCount=l.reduce((y,T)=>T>0?y+1:y,0),this.hist=l,this.rmax=c,this.rmin=h,this.gmax=u,this.gmin=g,this.bmax=d,this.bmin=m}get colorCount(){return this._colorCount}}class $r{scaleDown(t){const r=this.getWidth(),n=this.getHeight();let s=1;if(t.maxDimension>0){const a=Math.max(r,n);a>t.maxDimension&&(s=t.maxDimension/a)}else s=1/t.quality;s<1&&this.resize(r*s,n*s,s)}}function Qr(e,t){var r;if(t.length>0){const n=e.data,s=n.length/4;let a,o,l,c,h;for(let u=0;u<s;u++){a=u*4,o=n[a+0],l=n[a+1],c=n[a+2],h=n[a+3];for(let g=0;g<t.length;g++)if(!((r=t[g])!=null&&r.call(t,o,l,c,h))){n[a+3]=0;break}}}return e}function Yr(e){const t=new URL(e,location.href);return t.protocol===location.protocol&&t.host===location.host&&t.port===location.port}function Jr(e,t){const r=new URL(e),n=new URL(t);return r.protocol===n.protocol&&r.hostname===n.hostname&&r.port===n.port}class Kr extends $r{_getCanvas(){if(!this._canvas)throw new Error("Canvas is not initialized");return this._canvas}_getContext(){if(!this._context)throw new Error("Context is not initialized");return this._context}_getWidth(){if(!this._width)throw new Error("Width is not initialized");return this._width}_getHeight(){if(!this._height)throw new Error("Height is not initialized");return this._height}_initCanvas(){const t=this.image;if(!t)throw new Error("Image is not initialized");const r=this._canvas=document.createElement("canvas"),n=r.getContext("2d");if(!n)throw new ReferenceError("Failed to create canvas context");this._context=n,r.className="@vibrant/canvas",r.style.display="none",this._width=r.width=t.width,this._height=r.height=t.height,n.drawImage(t,0,0),document.body.appendChild(r)}load(t){let r,n;if(typeof t=="string")r=document.createElement("img"),n=t,!Yr(n)&&!Jr(window.location.href,n)&&(r.crossOrigin="anonymous"),r.src=n;else if(t instanceof HTMLImageElement)r=t,n=t.src;else return Promise.reject(new Error("Cannot load buffer as an image in browser"));return this.image=r,new Promise((s,a)=>{const o=()=>{this._initCanvas(),s(this)};r.complete?o():(r.onload=o,r.onerror=l=>a(new Error("Fail to load image: ".concat(n))))})}clear(){this._getContext().clearRect(0,0,this._getWidth(),this._getHeight())}update(t){this._getContext().putImageData(t,0,0)}getWidth(){return this._getWidth()}getHeight(){return this._getHeight()}resize(t,r,n){if(!this.image)throw new Error("Image is not initialized");this._width=this._getCanvas().width=t,this._height=this._getCanvas().height=r,this._getContext().scale(n,n),this._getContext().drawImage(this.image,0,0)}getPixelCount(){return this._getWidth()*this._getHeight()}getImageData(){return this._getContext().getImageData(0,0,this._getWidth(),this._getHeight())}remove(){this._canvas&&this._canvas.parentNode&&this._canvas.parentNode.removeChild(this._canvas)}}function $(e,...t){return t.forEach(r=>{if(r){for(const n in r)if(r.hasOwnProperty(n)){const s=r[n];Array.isArray(s)?e[n]=s.slice(0):typeof s=="object"?(e[n]||(e[n]={}),$(e[n],s)):e[n]=s}}}),e}function Xr(e,t){const{colorCount:r,quantizer:n,generators:s,filters:a}=e,o={colorCount:r},l=typeof n=="string"?{name:n,options:{}}:n;return l.options=$({},o,l.options),$({},{quantizer:l,generators:s,filters:a},t)}class Zr{constructor(t,r={}){this._src=t,this._opts=$({},H.DefaultOpts,r)}maxColorCount(t){return this._opts.colorCount=t,this}maxDimension(t){return this._opts.maxDimension=t,this}addFilter(t){return this._opts.filters?this._opts.filters.push(t):this._opts.filters=[t],this}removeFilter(t){if(this._opts.filters){const r=this._opts.filters.indexOf(t);r>0&&this._opts.filters.splice(r)}return this}clearFilters(){return this._opts.filters=[],this}quality(t){return this._opts.quality=t,this}useImageClass(t){return this._opts.ImageClass=t,this}useGenerator(t,r){return this._opts.generators||(this._opts.generators=[]),this._opts.generators.push(r?{name:t,options:r}:t),this}useQuantizer(t,r){return this._opts.quantizer=r?{name:t,options:r}:t,this}build(){return new H(this._src,this._opts)}getPalette(){return this.build().getPalette()}}class ft{constructor(t){this.pipeline=t,this._map={}}names(){return Object.keys(this._map)}has(t){return!!this._map[t]}get(t){return this._map[t]}register(t,r){return this._map[t]=r,this.pipeline}}class tn{constructor(){this.filter=new ft(this),this.quantizer=new ft(this),this.generator=new ft(this)}_buildProcessTasks({filters:t,quantizer:r,generators:n}){return n.length===1&&n[0]==="*"&&(n=this.generator.names()),{filters:t.map(a=>s(this.filter,a)),quantizer:s(this.quantizer,r),generators:n.map(a=>s(this.generator,a))};function s(a,o){let l,c;return typeof o=="string"?l=o:(l=o.name,c=o.options),{name:l,fn:a.get(l),options:c}}}async process(t,r){const{filters:n,quantizer:s,generators:a}=this._buildProcessTasks(r),o=await this._filterColors(n,t),l=await this._generateColors(s,o),c=await this._generatePalettes(a,l);return{colors:l,palettes:c}}_filterColors(t,r){return Promise.resolve(Qr(r,t.map(({fn:n})=>n)))}_generateColors(t,r){return Promise.resolve(t.fn(r.data,t.options))}async _generatePalettes(t,r){const n=await Promise.all(t.map(({fn:s,options:a})=>Promise.resolve(s(r,a))));return Promise.resolve(n.reduce((s,a,o)=>(s[t[o].name]=a,s),{}))}}function en(e,t,r){return"#"+((1<<24)+(e<<16)+(t<<8)+r).toString(16).slice(1,7)}function rn(e,t,r){e/=255,t/=255,r/=255;const n=Math.max(e,t,r),s=Math.min(e,t,r);let a=0,o=0;const l=(n+s)/2;if(n!==s){const c=n-s;switch(o=l>.5?c/(2-n-s):c/(n+s),n){case e:a=(t-r)/c+(t<r?6:0);break;case t:a=(r-e)/c+2;break;case r:a=(e-t)/c+4;break}a/=6}return[a,o,l]}function R(e,t,r){let n,s,a;function o(l,c,h){return h<0&&(h+=1),h>1&&(h-=1),h<1/6?l+(c-l)*6*h:h<1/2?c:h<2/3?l+(c-l)*(2/3-h)*6:l}if(t===0)n=s=a=r;else{const l=r<.5?r*(1+t):r+t-r*t,c=2*r-l;n=o(c,l,e+1/3),s=o(c,l,e),a=o(c,l,e-1/3)}return[n*255,s*255,a*255]}class D{static applyFilters(t,r){return r.length>0?t.filter(({r:n,g:s,b:a})=>{var o;for(let l=0;l<r.length;l++)if(!((o=r[l])!=null&&o.call(r,n,s,a,255)))return!1;return!0}):t}static clone(t){return new D(t._rgb,t._population)}get r(){return this._rgb[0]}get g(){return this._rgb[1]}get b(){return this._rgb[2]}get rgb(){return this._rgb}get hsl(){if(!this._hsl){const[t,r,n]=this._rgb;this._hsl=rn(t,r,n)}return this._hsl}get hex(){if(!this._hex){const[t,r,n]=this._rgb;this._hex=en(t,r,n)}return this._hex}get population(){return this._population}toJSON(){return{rgb:this.rgb,population:this.population}}getYiq(){if(!this._yiq){const t=this._rgb;this._yiq=(t[0]*299+t[1]*587+t[2]*114)/1e3}return this._yiq}get titleTextColor(){return this._titleTextColor||(this._titleTextColor=this.getYiq()<200?"#fff":"#000"),this._titleTextColor}get bodyTextColor(){return this._bodyTextColor||(this._bodyTextColor=this.getYiq()<150?"#fff":"#000"),this._bodyTextColor}constructor(t,r){this._rgb=t,this._population=r}}const Xt=class xt{constructor(t,r){this._src=t,this.opts=$({},xt.DefaultOpts,r)}static use(t){this._pipeline=t}static from(t){return new Zr(t)}get result(){return this._result}_process(t,r){t.scaleDown(this.opts);const n=Xr(this.opts,r);return xt._pipeline.process(t.getImageData(),n)}async getPalette(){const t=new this.opts.ImageClass;try{const r=await t.load(this._src),n=await this._process(r,{generators:["default"]});this._result=n;const s=n.palettes.default;if(!s)throw new Error("Something went wrong and a palette was not found, please file a bug against our GitHub repo: https://github.com/vibrant-Colors/node-vibrant/");return t.remove(),s}catch(r){return t.remove(),Promise.reject(r)}}async getPalettes(){const t=new this.opts.ImageClass;try{const r=await t.load(this._src),n=await this._process(r,{generators:["*"]});this._result=n;const s=n.palettes;return t.remove(),s}catch(r){return t.remove(),Promise.reject(r)}}};Xt.DefaultOpts={colorCount:64,quality:5,filters:[]};let H=Xt;H.DefaultOpts.quantizer="mmcq";H.DefaultOpts.generators=["default"];H.DefaultOpts.filters=["default"];H.DefaultOpts.ImageClass=Kr;const vt=5,mt=8-vt;class at{constructor(t,r,n,s,a,o,l){this.histogram=l,this._volume=-1,this._avg=null,this._count=-1,this.dimension={r1:t,r2:r,g1:n,g2:s,b1:a,b2:o}}static build(t){const r=new Ur(t,{sigBits:vt}),{rmin:n,rmax:s,gmin:a,gmax:o,bmin:l,bmax:c}=r;return new at(n,s,a,o,l,c,r)}invalidate(){this._volume=this._count=-1,this._avg=null}volume(){if(this._volume<0){const{r1:t,r2:r,g1:n,g2:s,b1:a,b2:o}=this.dimension;this._volume=(r-t+1)*(s-n+1)*(o-a+1)}return this._volume}count(){if(this._count<0){const{hist:t,getColorIndex:r}=this.histogram,{r1:n,r2:s,g1:a,g2:o,b1:l,b2:c}=this.dimension;let h=0;for(let u=n;u<=s;u++)for(let g=a;g<=o;g++)for(let d=l;d<=c;d++){const m=r(u,g,d);t[m]&&(h+=t[m])}this._count=h}return this._count}clone(){const{histogram:t}=this,{r1:r,r2:n,g1:s,g2:a,b1:o,b2:l}=this.dimension;return new at(r,n,s,a,o,l,t)}avg(){if(!this._avg){const{hist:t,getColorIndex:r}=this.histogram,{r1:n,r2:s,g1:a,g2:o,b1:l,b2:c}=this.dimension;let h=0;const u=1<<8-vt;let g,d,m;g=d=m=0;for(let f=n;f<=s;f++)for(let p=a;p<=o;p++)for(let b=l;b<=c;b++){const x=r(f,p,b),_=t[x];_&&(h+=_,g+=_*(f+.5)*u,d+=_*(p+.5)*u,m+=_*(b+.5)*u)}h?this._avg=[~~(g/h),~~(d/h),~~(m/h)]:this._avg=[~~(u*(n+s+1)/2),~~(u*(a+o+1)/2),~~(u*(l+c+1)/2)]}return this._avg}contains(t){let[r,n,s]=t;const{r1:a,r2:o,g1:l,g2:c,b1:h,b2:u}=this.dimension;return r>>=mt,n>>=mt,s>>=mt,r>=a&&r<=o&&n>=l&&n<=c&&s>=h&&s<=u}split(){const{hist:t,getColorIndex:r}=this.histogram,{r1:n,r2:s,g1:a,g2:o,b1:l,b2:c}=this.dimension,h=this.count();if(!h)return[];if(h===1)return[this.clone()];const u=s-n+1,g=o-a+1,d=c-l+1,m=Math.max(u,g,d);let f=null,p,b;p=b=0;let x=null;if(m===u){x="r",f=new Uint32Array(s+1);for(let v=n;v<=s;v++){p=0;for(let j=a;j<=o;j++)for(let k=l;k<=c;k++){const I=r(v,j,k);t[I]&&(p+=t[I])}b+=p,f[v]=b}}else if(m===g){x="g",f=new Uint32Array(o+1);for(let v=a;v<=o;v++){p=0;for(let j=n;j<=s;j++)for(let k=l;k<=c;k++){const I=r(j,v,k);t[I]&&(p+=t[I])}b+=p,f[v]=b}}else{x="b",f=new Uint32Array(c+1);for(let v=l;v<=c;v++){p=0;for(let j=n;j<=s;j++)for(let k=a;k<=o;k++){const I=r(j,k,v);t[I]&&(p+=t[I])}b+=p,f[v]=b}}let _=-1;const L=new Uint32Array(f.length);for(let v=0;v<f.length;v++){const j=f[v];j&&(_<0&&j>b/2&&(_=v),L[v]=b-j)}const y=this;function T(v){const j=v+"1",k=v+"2",I=y.dimension[j];let S=y.dimension[k];const Y=y.clone(),B=y.clone(),J=_-I,K=S-_;for(J<=K?(S=Math.min(S-1,~~(_+K/2)),S=Math.max(0,S)):(S=Math.max(I,~~(_-1-J/2)),S=Math.min(y.dimension[k],S));!f[S];)S++;let w=L[S];for(;!w&&f[S-1];)w=L[--S];return Y.dimension[k]=S,B.dimension[j]=S+1,[Y,B]}return T(x)}}class Tt{_sort(){this._sorted||(this.contents.sort(this._comparator),this._sorted=!0)}constructor(t){this._comparator=t,this.contents=[],this._sorted=!1}push(t){this.contents.push(t),this._sorted=!1}peek(t){return this._sort(),t=typeof t=="number"?t:this.contents.length-1,this.contents[t]}pop(){return this._sort(),this.contents.pop()}size(){return this.contents.length}map(t){return this._sort(),this.contents.map(t)}}const nn=.75;function Dt(e,t){let r=e.size();for(;e.size()<t;){const n=e.pop();if(n&&n.count()>0){const[s,a]=n.split();if(!s||(e.push(s),a&&a.count()>0&&e.push(a),e.size()===r))break;r=e.size()}else break}}const sn=(e,t)=>{if(e.length===0||t.colorCount<2||t.colorCount>256)throw new Error("Wrong MMCQ parameters");const r=at.build(e);r.histogram.colorCount;const n=new Tt((a,o)=>a.count()-o.count());n.push(r),Dt(n,nn*t.colorCount);const s=new Tt((a,o)=>a.count()*a.volume()-o.count()*o.volume());return s.contents=n.contents,Dt(s,t.colorCount-s.size()),an(s)};function an(e){const t=[];for(;e.size();){const r=e.pop(),n=r.avg();t.push(new D(n,r.count()))}return t}const on={targetDarkLuma:.26,maxDarkLuma:.45,minLightLuma:.55,targetLightLuma:.74,minNormalLuma:.3,targetNormalLuma:.5,maxNormalLuma:.7,targetMutesSaturation:.3,maxMutesSaturation:.4,targetVibrantSaturation:1,minVibrantSaturation:.35,weightSaturation:3,weightLuma:6.5,weightPopulation:.5};function ln(e){let t=0;return e.forEach(r=>{t=Math.max(t,r.population)}),t}function cn(e,t){return e.Vibrant===t||e.DarkVibrant===t||e.LightVibrant===t||e.Muted===t||e.DarkMuted===t||e.LightMuted===t}function un(e,t,r,n,s,a,o){function l(...h){let u=0,g=0;for(let d=0;d<h.length;d+=2){const m=h[d],f=h[d+1];!m||!f||(u+=m*f,g+=f)}return u/g}function c(h,u){return 1-Math.abs(h-u)}return l(c(e,t),o.weightSaturation,c(r,n),o.weightLuma,s/a,o.weightPopulation)}function N(e,t,r,n,s,a,o,l,c,h){let u=null,g=0;return t.forEach(d=>{const[,m,f]=d.hsl;if(m>=l&&m<=c&&f>=s&&f<=a&&!cn(e,d)){const p=un(m,o,f,n,d.population,r,h);(u===null||p>g)&&(u=d,g=p)}}),u}function hn(e,t,r){const n={Vibrant:null,DarkVibrant:null,LightVibrant:null,Muted:null,DarkMuted:null,LightMuted:null};return n.Vibrant=N(n,e,t,r.targetNormalLuma,r.minNormalLuma,r.maxNormalLuma,r.targetVibrantSaturation,r.minVibrantSaturation,1,r),n.LightVibrant=N(n,e,t,r.targetLightLuma,r.minLightLuma,1,r.targetVibrantSaturation,r.minVibrantSaturation,1,r),n.DarkVibrant=N(n,e,t,r.targetDarkLuma,0,r.maxDarkLuma,r.targetVibrantSaturation,r.minVibrantSaturation,1,r),n.Muted=N(n,e,t,r.targetNormalLuma,r.minNormalLuma,r.maxNormalLuma,r.targetMutesSaturation,0,r.maxMutesSaturation,r),n.LightMuted=N(n,e,t,r.targetLightLuma,r.minLightLuma,1,r.targetMutesSaturation,0,r.maxMutesSaturation,r),n.DarkMuted=N(n,e,t,r.targetDarkLuma,0,r.maxDarkLuma,r.targetMutesSaturation,0,r.maxMutesSaturation,r),n}function dn(e,t,r){if(!e.Vibrant&&!e.DarkVibrant&&!e.LightVibrant){if(!e.DarkVibrant&&e.DarkMuted){let[n,s,a]=e.DarkMuted.hsl;a=r.targetDarkLuma,e.DarkVibrant=new D(R(n,s,a),0)}if(!e.LightVibrant&&e.LightMuted){let[n,s,a]=e.LightMuted.hsl;a=r.targetDarkLuma,e.DarkVibrant=new D(R(n,s,a),0)}}if(!e.Vibrant&&e.DarkVibrant){let[n,s,a]=e.DarkVibrant.hsl;a=r.targetNormalLuma,e.Vibrant=new D(R(n,s,a),0)}else if(!e.Vibrant&&e.LightVibrant){let[n,s,a]=e.LightVibrant.hsl;a=r.targetNormalLuma,e.Vibrant=new D(R(n,s,a),0)}if(!e.DarkVibrant&&e.Vibrant){let[n,s,a]=e.Vibrant.hsl;a=r.targetDarkLuma,e.DarkVibrant=new D(R(n,s,a),0)}if(!e.LightVibrant&&e.Vibrant){let[n,s,a]=e.Vibrant.hsl;a=r.targetLightLuma,e.LightVibrant=new D(R(n,s,a),0)}if(!e.Muted&&e.Vibrant){let[n,s,a]=e.Vibrant.hsl;a=r.targetMutesSaturation,e.Muted=new D(R(n,s,a),0)}if(!e.DarkMuted&&e.DarkVibrant){let[n,s,a]=e.DarkVibrant.hsl;a=r.targetMutesSaturation,e.DarkMuted=new D(R(n,s,a),0)}if(!e.LightMuted&&e.LightVibrant){let[n,s,a]=e.LightVibrant.hsl;a=r.targetMutesSaturation,e.LightMuted=new D(R(n,s,a),0)}}const gn=(e,t)=>{t=Object.assign({},on,t);const r=ln(e),n=hn(e,r,t);return dn(n,r,t),n},fn=new tn().filter.register("default",(e,t,r,n)=>n>=125&&!(e>250&&t>250&&r>250)).quantizer.register("mmcq",sn).generator.register("default",gn);H.use(fn);/*! Fast Average Color | © 2025 Denis Seleznev | MIT License | https://github.com/fast-average-color/fast-average-color */function mn(e){var t=e.toString(16);return t.length===1?"0"+t:t}function Et(e){return"#"+e.map(mn).join("")}function pn(e){var t=(e[0]*299+e[1]*587+e[2]*114)/1e3;return t<128}function bn(e){return e?xn(e)?e:[e]:[]}function xn(e){return Array.isArray(e[0])}function wt(e,t,r){for(var n=0;n<r.length;n++)if(vn(e,t,r[n]))return!0;return!1}function vn(e,t,r){switch(r.length){case 3:if(Cn(e,t,r))return!0;break;case 4:if(_n(e,t,r))return!0;break;case 5:if(wn(e,t,r))return!0;break;default:return!1}}function Cn(e,t,r){return e[t+3]!==255||e[t]===r[0]&&e[t+1]===r[1]&&e[t+2]===r[2]}function _n(e,t,r){return e[t+3]&&r[3]?e[t]===r[0]&&e[t+1]===r[1]&&e[t+2]===r[2]&&e[t+3]===r[3]:e[t+3]===r[3]}function X(e,t,r){return e>=t-r&&e<=t+r}function wn(e,t,r){var n=r[0],s=r[1],a=r[2],o=r[3],l=r[4],c=e[t+3],h=X(c,o,l);return o?!!(!c&&h||X(e[t],n,l)&&X(e[t+1],s,l)&&X(e[t+2],a,l)&&h):h}var jn=24;function Mn(e,t,r){for(var n={},s=r.dominantDivider||jn,a=r.ignoredColor,o=r.step,l=[0,0,0,0,0],c=0;c<t;c+=o){var h=e[c],u=e[c+1],g=e[c+2],d=e[c+3];if(!(a&&wt(e,c,a))){var m=Math.round(h/s)+","+Math.round(u/s)+","+Math.round(g/s);n[m]?n[m]=[n[m][0]+h*d,n[m][1]+u*d,n[m][2]+g*d,n[m][3]+d,n[m][4]+1]:n[m]=[h*d,u*d,g*d,d,1],l[4]<n[m][4]&&(l=n[m])}}var f=l[0],p=l[1],b=l[2],x=l[3],_=l[4];return x?[Math.round(f/x),Math.round(p/x),Math.round(b/x),Math.round(x/_)]:r.defaultColor}function kn(e,t,r){for(var n=0,s=0,a=0,o=0,l=0,c=r.ignoredColor,h=r.step,u=0;u<t;u+=h){var g=e[u+3],d=e[u]*g,m=e[u+1]*g,f=e[u+2]*g;c&&wt(e,u,c)||(n+=d,s+=m,a+=f,o+=g,l++)}return o?[Math.round(n/o),Math.round(s/o),Math.round(a/o),Math.round(o/l)]:r.defaultColor}function Sn(e,t,r){for(var n=0,s=0,a=0,o=0,l=0,c=r.ignoredColor,h=r.step,u=0;u<t;u+=h){var g=e[u],d=e[u+1],m=e[u+2],f=e[u+3];c&&wt(e,u,c)||(n+=g*g*f,s+=d*d*f,a+=m*m*f,o+=f,l++)}return o?[Math.round(Math.sqrt(n/o)),Math.round(Math.sqrt(s/o)),Math.round(Math.sqrt(a/o)),Math.round(o/l)]:r.defaultColor}function At(e){return q(e,"defaultColor",[0,0,0,0])}function q(e,t,r){return e[t]===void 0?r:e[t]}var Ft=10,Ct=100;function yn(e){return e.search(/\.svg(\?|$)/i)!==-1}function Ln(e){if(Zt(e)){var t=e.naturalWidth,r=e.naturalHeight;return!e.naturalWidth&&yn(e.src)&&(t=r=Ct),{width:t,height:r}}return Tn(e)?{width:e.videoWidth,height:e.videoHeight}:ee(e)?{width:e.codedWidth,height:e.codedHeight}:{width:e.width,height:e.height}}function Rt(e){return Dn(e)?"canvas":In(e)?"offscreencanvas":ee(e)?"videoframe":En(e)?"imagebitmap":e.src}function Zt(e){return typeof HTMLImageElement<"u"&&e instanceof HTMLImageElement}var te=typeof OffscreenCanvas<"u";function In(e){return te&&e instanceof OffscreenCanvas}function Tn(e){return typeof HTMLVideoElement<"u"&&e instanceof HTMLVideoElement}function ee(e){return typeof VideoFrame<"u"&&e instanceof VideoFrame}function Dn(e){return typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement}function En(e){return typeof ImageBitmap<"u"&&e instanceof ImageBitmap}function An(e,t){var r=q(t,"left",0),n=q(t,"top",0),s=q(t,"width",e.width),a=q(t,"height",e.height),o=s,l=a;if(t.mode==="precision")return{srcLeft:r,srcTop:n,srcWidth:s,srcHeight:a,destWidth:o,destHeight:l};var c;return s>a?(c=s/a,o=Ct,l=Math.round(o/c)):(c=a/s,l=Ct,o=Math.round(l/c)),(o>s||l>a||o<Ft||l<Ft)&&(o=s,l=a),{srcLeft:r,srcTop:n,srcWidth:s,srcHeight:a,destWidth:o,destHeight:l}}var Fn=typeof window>"u";function Rn(){return Fn?te?new OffscreenCanvas(1,1):null:document.createElement("canvas")}var On="FastAverageColor: ";function F(e){return Error(On+e)}function G(e,t){t||console.error(e)}var Vn=function(){function e(){this.canvas=null,this.ctx=null}return e.prototype.getColorAsync=function(t,r){if(!t)return Promise.reject(F("call .getColorAsync() without resource"));if(typeof t=="string"){if(typeof Image>"u")return Promise.reject(F("resource as string is not supported in this environment"));var n=new Image;return n.crossOrigin=r&&r.crossOrigin||"",n.src=t,this.bindImageEvents(n,r)}else{if(Zt(t)&&!t.complete)return this.bindImageEvents(t,r);var s=this.getColor(t,r);return s.error?Promise.reject(s.error):Promise.resolve(s)}},e.prototype.getColor=function(t,r){r=r||{};var n=At(r);if(!t){var s=F("call .getColor() without resource");return G(s,r.silent),this.prepareResult(n,s)}var a=Ln(t),o=An(a,r);if(!o.srcWidth||!o.srcHeight||!o.destWidth||!o.destHeight){var s=F('incorrect sizes for resource "'.concat(Rt(t),'"'));return G(s,r.silent),this.prepareResult(n,s)}if(!this.canvas&&(this.canvas=Rn(),!this.canvas)){var s=F("OffscreenCanvas is not supported in this browser");return G(s,r.silent),this.prepareResult(n,s)}if(!this.ctx){if(this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0}),!this.ctx){var s=F("Canvas Context 2D is not supported in this browser");return G(s,r.silent),this.prepareResult(n)}this.ctx.imageSmoothingEnabled=!1}this.canvas.width=o.destWidth,this.canvas.height=o.destHeight;try{this.ctx.clearRect(0,0,o.destWidth,o.destHeight),this.ctx.drawImage(t,o.srcLeft,o.srcTop,o.srcWidth,o.srcHeight,0,0,o.destWidth,o.destHeight);var l=this.ctx.getImageData(0,0,o.destWidth,o.destHeight).data;return this.prepareResult(this.getColorFromArray4(l,r))}catch(c){var s=F("security error (CORS) for resource ".concat(Rt(t),".\nDetails: https://developer.mozilla.org/en/docs/Web/HTML/CORS_enabled_image"));return G(s,r.silent),r.silent||console.error(c),this.prepareResult(n,s)}},e.prototype.getColorFromArray4=function(t,r){r=r||{};var n=4,s=t.length,a=At(r);if(s<n)return a;var o=s-s%n,l=(r.step||1)*n,c;switch(r.algorithm||"sqrt"){case"simple":c=kn;break;case"sqrt":c=Sn;break;case"dominant":c=Mn;break;default:throw F("".concat(r.algorithm," is unknown algorithm"))}return c(t,o,{defaultColor:a,ignoredColor:bn(r.ignoredColor),step:l,dominantDivider:r.dominantDivider})},e.prototype.prepareResult=function(t,r){var n=t.slice(0,3),s=[t[0],t[1],t[2],t[3]/255],a=pn(t);return{value:[t[0],t[1],t[2],t[3]],rgb:"rgb("+n.join(",")+")",rgba:"rgba("+s.join(",")+")",hex:Et(n),hexa:Et(t),isDark:a,isLight:!a,error:r}},e.prototype.destroy=function(){this.canvas&&(this.canvas.width=1,this.canvas.height=1,this.canvas=null),this.ctx=null},e.prototype.bindImageEvents=function(t,r){var n=this;return new Promise(function(s,a){var o=function(){h();var u=n.getColor(t,r);u.error?a(u.error):s(u)},l=function(){h(),a(F('Error loading image "'.concat(t.src,'"')))},c=function(){h(),a(F('Image "'.concat(t.src,'" loading aborted')))},h=function(){t.removeEventListener("load",o),t.removeEventListener("error",l),t.removeEventListener("abort",c)};t.addEventListener("load",o),t.addEventListener("error",l),t.addEventListener("abort",c)})},e}();const Hn=({manga:e,mangaDynamicColorSchemes:t})=>{const r=$t(),{setDynamicColor:n}=ve(),s=Nt({variant:"popover",popupId:"manga-thumbnail-fullscreen"}),[a,o]=C.useState(!1);return C.useLayoutEffect(()=>{if(!t)return()=>{};const l=new Image;return l.crossOrigin="anonymous",l.src=V.getThumbnailUrl(e),l.onload=()=>{const c=l.width>600&&l.height>600;Promise.all([H.from(l).getPalette(),new Vn().getColor(l,{algorithm:"dominant",mode:c?"speed":"precision",ignoredColor:[[255,255,255,255,75],[0,0,0,255,75]]})]).then(([h,u])=>{!h.Vibrant||!h.DarkVibrant||!h.LightVibrant||!h.LightMuted||!h.Muted||!h.DarkMuted||n({...h,average:u})})},()=>{n(null)}},[]),i.jsxs(i.Fragment,{children:[i.jsxs(M,{sx:{position:"relative",borderRadius:1,overflow:"hidden",backgroundColor:"background.paper",width:"150px",maxHeight:"fit-content",aspectRatio:Ce,flexShrink:0,flexGrow:0,[r.breakpoints.up("lg")]:{width:"200px"},[r.breakpoints.up("xl")]:{width:"300px"}},children:[i.jsx(pt,{src:V.getThumbnailUrl(e),alt:"Manga Thumbnail",onLoad:()=>o(!0),imgStyle:{width:"100%",height:"100%",objectFit:"cover"}}),a&&i.jsx(M,{...ot(s),sx:{position:"absolute",top:0,bottom:0,width:"100%",justifyContent:"center",alignItems:"center",opacity:0,"&:hover":{background:"rgba(0, 0, 0, 0.4)",cursor:"pointer",opacity:1}},children:i.jsx(qr,{fontSize:"large",color:"primary"})})]}),i.jsx(_e,{...we(s),sx:{outline:0},children:i.jsx(M,{onClick:()=>s.close(),sx:{height:"100vh",p:2,outline:0,justifyContent:"center",alignItems:"center"},children:i.jsx(pt,{src:V.getThumbnailUrl(e),alt:"Manga Thumbnail",imgStyle:{height:"100%",width:"100%",objectFit:"contain"}})})})]})},jt=({query:e,sourceId:t,mode:r,children:n})=>{const s=r==="source"&&t!==void 0?z.sources.childRoutes.browse.path(t,e):r==="source.global-search"?z.sources.childRoutes.searchAll.path(e):z.library.path(void 0,e);return i.jsx(Jt,{component:rt,to:s,sx:{textDecoration:"none",color:"inherit"},children:n!=null?n:e})},Ot="35px",Vt=75,Pn=({manga:{description:e,genre:t,sourceId:r},mode:n})=>{const[s,a]=C.useState(null),[o,l]=C.useState();Bt(s,C.useCallback(()=>l(s==null?void 0:s.clientHeight),[s]));const[c,h]=je("isDescriptionGenreCollapsed",!0),u=e?Math.min(Vt,o!=null?o:Vt):0,g=C.useMemo(()=>t.filter(Boolean),[t]);return i.jsxs(i.Fragment,{children:[e&&i.jsxs(M,{sx:{position:"relative"},children:[i.jsx(Me,{collapsedSize:u,in:!c,children:i.jsx(st,{ref:a,sx:{whiteSpace:"pre-line",textAlign:"justify",textJustify:"inter-word",mb:Ot},children:Ze(tr(e,{disallowedTagsMode:"escape"}))})}),i.jsx(M,{onClick:()=>h(!c),sx:{justifyContent:"flex-start",alignItems:"center",cursor:"pointer",position:"absolute",width:"100%",height:Ot,bottom:0,background:d=>"linear-gradient(transparent -15px, ".concat(d.palette.background.default,")")},children:i.jsx(E,{sx:{color:d=>d.palette.mode==="light"?"black":"text"},children:c?i.jsx(ur,{}):i.jsx(hr,{})})})]}),i.jsx(M,{sx:{flexDirection:"row",flexWrap:c?"no-wrap":"wrap",gap:1,overflowX:c?"auto":null},children:g.map(d=>i.jsx(jt,{query:d,sourceId:r,mode:n,children:i.jsx(dr,{label:d,variant:"outlined",onClick:()=>{}})},d))})]})},Nn=W("div")(({theme:e})=>({display:"flex",flexDirection:"column",gap:e.spacing(2),padding:e.spacing(1),[e.breakpoints.up("md")]:{flexBasis:"40%",height:"calc(100vh - 64px)",overflowY:"auto"}})),zn=({url:e,mangaThumbnailBackdrop:t,children:r})=>i.jsxs(M,{sx:{position:"relative"},children:[t&&i.jsxs(i.Fragment,{children:[i.jsx(pt,{spinnerStyle:{display:"none"},imgStyle:{position:"absolute",top:0,left:0,width:"100%",height:"100%",objectFit:"cover"},src:e,alt:"Manga Thumbnail"}),i.jsx(M,{sx:{"&::before":n=>ye(t,{position:"absolute",display:"inline-block",content:'""',top:0,left:0,width:"100%",height:"100%",background:"linear-gradient(to top, ".concat(n.palette.background.default,", transparent 100%, transparent 1px),linear-gradient(to right, ").concat(n.palette.background.default,", transparent 50%, transparent 1px),linear-gradient(to bottom, ").concat(n.palette.background.default,", transparent 50%, transparent 1px),linear-gradient(to left, ").concat(n.palette.background.default,", transparent 50%, transparent 1px)"),backdropFilter:"blur(4.5px) brightness(0.75)"})}})]}),r]}),Wn=W("div")(({theme:e})=>({display:"flex",paddingBottom:e.spacing(1)})),Bn=W("div")(({theme:e})=>({zIndex:1,marginLeft:e.spacing(1)})),Z=e=>i.jsx(lr,{...e}),Gn=W("div")(({theme:e})=>({display:"flex",gap:e.spacing(1)})),qn=({url:e})=>{const{t}=A();return i.jsx(O,{title:t("global.button.open_site"),disabled:!e,children:i.jsx(nr,{size:"medium",disabled:!e,component:Jt,href:e!=null?e:void 0,target:"_blank",rel:"noreferrer",variant:"outlined",children:i.jsx(sr,{})})})};function Un(e){var t;return e?cr.isLocalSource(e)?bt("source.local_source.title"):(t=e.displayName)!=null?t:e.id:bt("global.label.unknown")}const Ht=(e,t,r)=>e==null?void 0:e.map(n=>i.jsx(jt,{query:n,sourceId:t,mode:r},n)).reduce((n,s)=>i.jsxs(i.Fragment,{children:[n,", ",s]})),$n=({manga:e,mode:t})=>{var c,h;const{t:r}=A(),{settings:{mangaThumbnailBackdrop:n,mangaDynamicColorSchemes:s}}=ke();C.useEffect(()=>{e.source||it(bt("source.error.label.source_not_found"),"error")},[e.source]);const{CategorySelectComponent:a,updateLibraryState:o}=Ue(e),l=async()=>{try{await navigator.clipboard.writeText(e.title),it(r("global.label.copied_clipboard"),"info")}catch(u){}};return i.jsxs(i.Fragment,{children:[i.jsxs(Nn,{children:[i.jsxs(zn,{url:V.getThumbnailUrl(e),mangaThumbnailBackdrop:n,children:[i.jsxs(Wn,{children:[i.jsx(Hn,{manga:e,mangaDynamicColorSchemes:s}),i.jsxs(Bn,{children:[i.jsxs(M,{sx:{flexDirection:"row",gap:1,alignItems:"flex-start",mb:1},children:[i.jsx(jt,{query:e.title,sourceId:e.sourceId,mode:"source.global-search",children:i.jsx(st,{variant:"h5",component:"h2",sx:{wordBreak:"break-word"},children:e.title})}),i.jsx(O,{title:r("global.button.copy"),children:i.jsx(E,{onClick:l,color:"inherit",children:i.jsx(Wr,{fontSize:"small"})})})]}),e.author&&i.jsx(Z,{title:r("manga.label.author"),value:Ht(V.getAuthors(e),(c=e.source)==null?void 0:c.id,t)}),e.artist&&i.jsx(Z,{title:r("manga.label.artist"),value:Ht(V.getArtists(e),(h=e.source)==null?void 0:h.id,t)}),i.jsx(Z,{title:r("manga.label.status"),value:r(Se[e.status])}),i.jsx(Z,{title:r("source.title_one"),value:Un(e.source)})]})]}),i.jsxs(Gn,{children:[i.jsxs(Kt,{size:"medium",onClick:o,variant:e.inLibrary?"contained":"outlined",children:[e.inLibrary?i.jsx(ar,{}):i.jsx($e,{}),e.inLibrary?r("manga.button.in_library"):r("manga.button.add_to_library")]}),i.jsx(Gr,{manga:e}),i.jsx(qn,{url:e.realUrl})]})]}),i.jsx(Pn,{manga:e,mode:t})]}),a]})},Qn=({manga:e,onRefresh:t,refreshing:r})=>{const{t:n}=A(),s=$t(),a=Le(s.breakpoints.up("sm")),[o,l]=Ie.useState(null),c=!!o,h=()=>{l(null)},{openCategorySelect:u,CategorySelectComponent:g}=Qe({mangaId:e.id});return i.jsxs(i.Fragment,{children:[a&&i.jsxs(i.Fragment,{children:[i.jsx(O,{title:n("manga.label.reload_from_source"),disabled:r,children:i.jsx(E,{onClick:()=>{t()},disabled:r,color:"inherit",children:i.jsx(kt,{})})}),e.inLibrary&&i.jsxs(i.Fragment,{children:[i.jsx(O,{title:n("global.button.migrate"),children:i.jsx(rt,{to:z.migrate.childRoutes.search.path(e.sourceId,e.id,e.title),state:{mangaTitle:e.title},style:{textDecoration:"none",color:"inherit"},children:i.jsx(E,{color:"inherit",children:i.jsx(yt,{})})})}),i.jsx(O,{title:n("manga.label.edit_categories"),children:i.jsx(E,{onClick:()=>{u(!0)},color:"inherit",children:i.jsx(Lt,{})})})]})]}),!a&&i.jsxs(i.Fragment,{children:[i.jsx(E,{id:"chaptersMenuButton","aria-controls":c?"chaptersMenu":void 0,"aria-haspopup":"true","aria-expanded":c?"true":void 0,onClick:d=>l(d.currentTarget),color:"inherit",children:i.jsx(Te,{})}),i.jsxs(Wt,{id:"chaptersMenu",anchorEl:o,open:c,onClose:h,MenuListProps:{"aria-labelledby":"chaptersMenuButton"},children:[i.jsxs(ct,{onClick:()=>{t(),h()},disabled:r,children:[i.jsx(ut,{children:i.jsx(kt,{fontSize:"small"})}),i.jsx(ht,{children:n("manga.label.reload_from_source")})]}),e.inLibrary&&[i.jsxs(ct,{component:rt,to:z.migrate.childRoutes.search.path(e.sourceId,e.id,e.title),state:{mangaTitle:e.title},style:{textDecoration:"none",color:"inherit"},children:[i.jsx(ut,{children:i.jsx(yt,{fontSize:"small"})}),i.jsx(ht,{children:n("migrate.title")})]},"migrate"),i.jsxs(ct,{onClick:()=>{u(!0),h()},children:[i.jsx(ut,{children:i.jsx(Lt,{fontSize:"small"})}),i.jsx(ht,{children:n("manga.label.edit_categories")})]},"categories")]]})]}),g]})},Us=()=>{var p,b;const{t:e}=A(),{id:t}=De(),{mode:r}=(p=Ee().state)!=null?p:{},n=C.useRef(!1),{data:s,error:a,loading:o,networkStatus:l,refetch:c}=U.useGetManga(Ae,t),h=Fe(l),u=s==null?void 0:s.manga,[g,{loading:d,error:m}]=zr(t),f=a!=null?a:m;return C.useEffect(()=>{if(u==null)return;!n.current&&!u.initialized&&(n.current=!0,g())},[u]),gr((b=u==null?void 0:u.title)!=null?b:e("manga.title_one"),i.jsxs(M,{direction:"row",sx:{alignItems:"center"},children:[f&&!h&&!d&&i.jsx(O,{title:i.jsxs(i.Fragment,{children:[e("manga.error.label.request_failure"),i.jsx("br",{}),nt(f)]}),children:i.jsx(E,{onClick:()=>c(),children:i.jsx(fr,{color:"error"})})}),u&&(d||h)&&i.jsx(E,{disabled:!0,children:i.jsx(Re,{size:16})}),u&&i.jsx(Qn,{manga:u,onRefresh:g,refreshing:d})]}),[e,f,h,d,u,g]),f&&!u?i.jsx(et,{message:e("manga.error.label.request_failure"),messageExtra:nt(f)}):i.jsxs(qt,{sx:{display:{md:"flex"},overflow:"hidden"},children:[o&&i.jsx(Gt,{}),u&&i.jsx($n,{manga:u,mode:r}),u&&i.jsx(Nr,{manga:u,isRefreshing:d})]})};export{Us as Manga};
